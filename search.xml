<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Untitled</title>
      <link href="/untitled/"/>
      <url>/untitled/</url>
      
        <content type="html"><![CDATA[<h2 id="Kebeadm-安装"><a href="#Kebeadm-安装" class="headerlink" title="Kebeadm 安装"></a>Kebeadm 安装</h2><pre><code>export KUBECONFIG=/etc/kubernetes/admin.confkubeadm join 172.16.21.75:6443 --token c19ozz.fes3zyf06ugr4sj4 \    --discovery-token-ca-cert-hash sha256:6e712a7fd41a09d3480bfd443221a4e23969367e37dba44944f0aad200e84a13</code></pre><ol start="0"><li><p>基础环境设置</p><pre><code>sudo sed -e 's|^mirrorlist=|#mirrorlist=|g' \         -e 's|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.ustc.edu.cn/centos|g' \         -i.bak \         /etc/yum.repos.d/CentOS-Linux-AppStream.repo \         /etc/yum.repos.d/CentOS-Linux-BaseOS.repo \         /etc/yum.repos.d/CentOS-Linux-Extras.repo \         /etc/yum.repos.d/CentOS-Linux-PowerTools.repo \         /etc/yum.repos.d/CentOS-Linux-Plus.repo dnf clean all &amp;&amp; dnf makecache</code></pre></li></ol><p>   172.16.21.75 master<br>   172.16.21.76 low<br>   172.16.21.77 high </p><h1 id="swapoff"><a href="#swapoff" class="headerlink" title="swapoff"></a>swapoff</h1><p>   swapoff -a </p><p>   cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF<br>   #!/bin/bash<br>   modprobe – ip_vs<br>   modprobe – ip_vs_rr<br>   modprobe – ip_vs_wrr<br>   modprobe – ip_vs_sh<br>   modprobe – nf_conntrack_ipv4<br>   EOF</p><p>   chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4</p><p>   dnf -y install ipset ipvsadm</p><pre><code>1. 设置 `br_netfilter`   ```shell   cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf   br_netfilter   EOF   cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf   net.bridge.bridge-nf-call-ip6tables = 1   net.bridge.bridge-nf-call-iptables = 1   EOF   sudo sysctl --system</code></pre><ol start="2"><li><p>安装 docker</p><pre class=" language-shell"><code class="language-shell">dnf config-manager --add-repo=http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo && dnf install -y https://mirrors.aliyun.com/docker-ce/linux/centos/8/x86_64/stable/Packages/docker-ce-20.10.5-3.el8.x86_64.rpm</code></pre><p>​    </p></li><li><p>设置 docker cgroup and storage</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/docker<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json<span class="token punctuation">{</span>  <span class="token string">"exec-opts"</span><span class="token keyword">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span>,  <span class="token string">"log-driver"</span><span class="token keyword">:</span> <span class="token string">"json-file"</span>,  <span class="token string">"log-opts"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>    <span class="token string">"max-size"</span><span class="token keyword">:</span> <span class="token string">"100m"</span>  <span class="token punctuation">}</span>,  <span class="token string">"storage-driver"</span><span class="token keyword">:</span> <span class="token string">"overlay2"</span>,  <span class="token string">"registry-mirrors"</span><span class="token keyword">:</span> <span class="token punctuation">[</span><span class="token string">"https://kkw5ad1d.mirror.aliyuncs.com"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>EOF</code></pre></li></ol><h2 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h2><p>   systemctl enable docker<br>   systemctl daemon-reload<br>   systemctl restart docker</p><pre><code>4. 配置中科大源</code></pre><p>   cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo<br>   [kubernetes]<br>   name=Kubernetes</p><h1 id="baseurl-https-mirrors-aliyun-com-kubernetes-yum-repos-kubernetes-el7-x86-64"><a href="#baseurl-https-mirrors-aliyun-com-kubernetes-yum-repos-kubernetes-el7-x86-64" class="headerlink" title="baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/"></a>baseurl=<a href="https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/" target="_blank" rel="noopener">https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</a></h1><p>   baseurl=<a href="http://mirrors.ustc.edu.cn/kubernetes/yum/repos/kubernetes-el7-x86_64/" target="_blank" rel="noopener">http://mirrors.ustc.edu.cn/kubernetes/yum/repos/kubernetes-el7-x86_64/</a><br>   enabled=1<br>   gpgcheck=0<br>   EOF</p><h1 id="将-SELinux-设置为-permissive-模式（相当于将其禁用）"><a href="#将-SELinux-设置为-permissive-模式（相当于将其禁用）" class="headerlink" title="将 SELinux 设置为 permissive 模式（相当于将其禁用）"></a>将 SELinux 设置为 permissive 模式（相当于将其禁用）</h1><p>   setenforce 0<br>   sed -i ‘s/^SELINUX=enforcing$/SELINUX=permissive/‘ /etc/selinux/config</p><p>   dnf install -y kubelet kubeadm kubectl –disableexcludes=kubernetes</p><p>   systemctl enable –now kubelet</p><pre><code>5. 拉取镜像   ```bash   export ALI=registry.cn-hangzhou.aliyuncs.com/google_containers/   export K8S=k8s.gcr.io/   export VER=v1.20.5   export ETCDVER=3.4.13-0   export PAUSEVER=3.2   export DNSVER=1.7.0   apiserver=kube-apiserver:$VER;docker pull $ALI$apiserver &amp;&amp; docker tag $ALI$apiserver $K8S$apiserver   controller=kube-controller-manager:$VER;docker pull $ALI$controller &amp;&amp; docker tag $ALI$controller $K8S$controller   schedule=kube-scheduler:$VER;docker pull $ALI$schedule &amp;&amp; docker tag $ALI$schedule $K8S$schedule   proxy=kube-proxy:$VER;docker pull $ALI$proxy &amp;&amp; docker tag $ALI$proxy $K8S$proxy   etcd=etcd:$ETCDVER;docker pull $ALI$etcd &amp;&amp; docker tag $ALI$etcd $K8S$etcd   pause=pause:$PAUSEVER;docker pull $ALI$pause &amp;&amp; docker tag $ALI$pause $K8S$pause   coredns=coredns:$DNSVER;docker pull $ALI$coredns &amp;&amp; docker tag $ALI$coredns $K8S$coredns</code></pre><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><ol><li>failed to acquire lease:  cidr not assigned</li></ol><blockquote><p>kubeadm init 时，未指定 cidr  ==&gt;  <code>--pod-network-cidr=10.244.0.0/16</code></p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>synchronized 关键字</title>
      <link href="/java/synchronized/"/>
      <url>/java/synchronized/</url>
      
        <content type="html"><![CDATA[<blockquote><p>$ java -version<br>java version “13.0.2” 2020-01-14<br>Java(TM) SE Runtime Environment (build 13.0.2+8)<br>Java HotSpot(TM) 64-Bit Server VM (build 13.0.2+8, mixed mode, sharing)</p></blockquote><h1 id="Java-中的-synchronized-关键字浅析"><a href="#Java-中的-synchronized-关键字浅析" class="headerlink" title="Java 中的 synchronized 关键字浅析"></a>Java 中的 synchronized 关键字浅析</h1><h2 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2><p>我们常说， 要避免多线程的上下文切换。</p><p>这里我想问两个问题：</p><ul><li>什么是上下文切换？</li><li>为什么要避免上下文切换？</li></ul><hr><p>在回答上面的问题之前， 我们先大致了解下 CPU 的内部结构(只列出关键部分， 图示为一个包含两个核心的 CPU)</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20210417191556.png-growing" alt="image-20210417191455636"></p><p>如图所示， 一个 CPU 包含多个核心， 每个核心除了包含逻辑计算单元(ALU)、寄存器、程序计数器等外， 还会囊括 L1、L2 两级缓存。</p><p><strong>L3 缓存为 CPU 级别的缓存， 主存则是所有 CPU 共享。</strong></p><p>CPU 执行速度非常快，快到主存的读写速度跟不上，于是出现了 L1、L2、L3 三级缓存的设置。至于为什么是 3 级缓存，以及各级缓存是不是越大越好，作者作为一只菜鸡，就不得而知了。</p><hr><p>好了， 在了解了 CPU 的基本架构后， 我们来说说第一个问题：</p><ul><li>什么是上下文切换？</li></ul><p>在我之前的文章有提到:</p><blockquote><p>CPU 通过时间片分配算法来循环执行任务， 一个时间片一般为几十毫秒，而时间片是用来给各个线程运行指令的时间。</p><p>当线程 A 消耗完时间片后， CPU 需要保存当前线程的状态，这样，当时间片再次分配给线程 A 时，可以知道它之前的执行状态。</p><p>这里，从保存到在加载的过程，就是一次上下文切换。</p></blockquote><p>参考上图， 有一个线程 t1 在 core1 执行， 时间片结束后， 轮到 t2 执行，在 t2 执行前， 需要先把 t1 的上下文保存起来，等到 t1 再次轮到时，先把之前保存起来的上下文恢复，再开始执行 t1。 这样的一个过程，就是上下文切换。</p><p>知道上下文切换的含义后， 第二个问题自然而然就明白了，避免上下文切换，就可以避免保存和重新加载上下文，避免对 CPU 的浪费。</p><h2 id="用户态和内核态"><a href="#用户态和内核态" class="headerlink" title="用户态和内核态"></a>用户态和内核态</h2><p>计算机硬件资源是有限的，如果所有的应用程序都能任意申请和使用有限的硬件资源，那 server 很快就会被玩坏。</p><p>于是 Linux 操作系统针对不同的操作，赋予不同的权限，而不同的两级权限，对应的就是我们的<strong>用户态</strong> 和 <strong>内核态</strong>。</p><p>用户态如果想申请硬件资源如内存分配，需要通过系统调用，由内核态来分配。</p><p><strong>完成一次系统调用，需要先将当前的用户态信息保存下来， 然后切换到内核态执行，得到结果后，再切回用户态并恢复现场</strong></p><hr><h2 id="轻量级锁和重量级锁"><a href="#轻量级锁和重量级锁" class="headerlink" title="轻量级锁和重量级锁"></a>轻量级锁和重量级锁</h2><p>我们说这把锁是轻量级锁，意思是这把锁在用户态就能完成，不会进行系统调用，即不会有用户态、内核态的切换。 重量级锁则会发生系统调用。</p><p>java 中的轻量级锁，即 CAS，compareAndSwap，即 <strong>自旋锁</strong>。 CAS 是在用户态调用。</p><p>我们查看 java 的代码，可以看到这样一个本地方法：</p><pre class=" language-java"><code class="language-java">    <span class="token comment" spellcheck="true">// jdk.internal.misc.Unsafe#getAndAddInt  -- 1</span>    <span class="token annotation punctuation">@HotSpotIntrinsicCandidate</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAddInt</span><span class="token punctuation">(</span>Object o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> v<span class="token punctuation">;</span>        <span class="token keyword">do</span> <span class="token punctuation">{</span>            v <span class="token operator">=</span> <span class="token function">getIntVolatile</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">weakCompareAndSetInt</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v <span class="token operator">+</span> delta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> v<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// jdk.internal.misc.Unsafe#compareAndSetInt  -- 2</span>    <span class="token annotation punctuation">@HotSpotIntrinsicCandidate</span>    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSetInt</span><span class="token punctuation">(</span>Object o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span>                                                 <span class="token keyword">int</span> expected<span class="token punctuation">,</span>                                                 <span class="token keyword">int</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>2 处是一个 native 方法，我们需要知道的是，该方法能向我们保证是一个原子操作。(通过 hotspot 的源码可以知道， 是通过 lock cmpxchg 指令实现原子操作的)。</p><p>1 处则是通过 <code>do... while...</code> 自旋的方式，不断尝试设置新的值，直到成功。</p><p>所以我们说， <strong>CAS 是自旋锁</strong></p><hr><p>对于重量级锁， 用户态程序需要首先向操作系统申请锁， 简言之，就是所有的控制权都交给了操作系统，由操作系统来负责线程间的调度和线程的状态变更。而这样会出现频繁地对线程运行状态的切换，线程的挂起和唤醒，从而消耗大量的系统资。</p><hr><h2 id="java-对象在内存中的布局"><a href="#java-对象在内存中的布局" class="headerlink" title="java 对象在内存中的布局"></a>java 对象在内存中的布局</h2><h3 id="JOL"><a href="#JOL" class="headerlink" title="JOL"></a>JOL</h3><h2 id="synchronized-工作原理"><a href="#synchronized-工作原理" class="headerlink" title="synchronized 工作原理"></a>synchronized 工作原理</h2><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><p><a href="https://tech.meituan.com/2018/11/15/java-lock.html" target="_blank" rel="noopener">java 各种锁</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/73937739" target="_blank" rel="noopener">CPU 基本架构</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/69554144" target="_blank" rel="noopener">用户态与内核态</a></p></li><li><p><a href="https://www.zhihu.com/question/32043825" target="_blank" rel="noopener">系统调用瓶颈</a></p></li><li><p><a href="https://www.jianshu.com/p/538587341695" target="_blank" rel="noopener">lock cmpxchg</a></p></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> languages </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>长度最小的子数组</title>
      <link href="/leetcode/arrays/minimun-size-subarray-sum/"/>
      <url>/leetcode/arrays/minimun-size-subarray-sum/</url>
      
        <content type="html"><![CDATA[<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><blockquote><p>给定一个含有 n 个正整数的数组和一个正整数 s ，找出该数组中满足其和 ≥ s 的长度最小的 连续 子数组，并返回其长度。如果不存在符合条件的子数组，返回 0。</p><p>示例：</p><p>输入：s = 7, nums = [2,3,1,2,4,3]<br>输出：2<br>解释：子数组 [4,3] 是该条件下的长度最小的子数组。</p><p>来源：力扣（LeetCode）<br>链接：<a href="https://leetcode-cn.com/problems/minimum-size-subarray-sum" target="_blank" rel="noopener">https://leetcode-cn.com/problems/minimum-size-subarray-sum</a><br>著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。</p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>双指针， 在这里也可以称之为 <strong>滑动窗口</strong> 。 通过不断调整窗口的大小(左右指针)，来寻找符合题设的最小长度。</p><p>首先移动右指针，当窗口内元素符合条件时，记录 <code>answer</code> 。 </p><p>然后移动左指针， 不断缩小窗口大小，直到窗口内元素不再符合条件时，记录 <code>answer</code>。</p><p>当右指针一次遍历完成后，即可寻找到符合条件的 <code>answer</code>。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">minSubArrayLen</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> right <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> length <span class="token operator">=</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">int</span> answer <span class="token operator">=</span> length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>right <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        sum <span class="token operator">+=</span> nums<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// right 是不断扩大窗口的右边界</span>        <span class="token comment" spellcheck="true">// 这里则是不断缩小窗口的左边界</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>sum <span class="token operator">>=</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>            answer <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>answer<span class="token punctuation">,</span> right <span class="token operator">-</span> left <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            sum <span class="token operator">-=</span> nums<span class="token punctuation">[</span>left<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        right<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 未找到符合题设的答案， 返回 0</span>    <span class="token keyword">return</span> answer <span class="token operator">></span> length <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> answer<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
            <tag> leetcode-arrays </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>删除排序数组中的重复元素</title>
      <link href="/leetcode/arrays/remove-duplicates-from-sorted-array/"/>
      <url>/leetcode/arrays/remove-duplicates-from-sorted-array/</url>
      
        <content type="html"><![CDATA[<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><blockquote><p>给定一个排序数组，你需要在 原地 删除重复出现的元素，使得每个元素只出现一次，返回移除后数组的新长度。</p><p>不要使用额外的数组空间，你必须在 原地 修改输入数组 并在使用 O(1) 额外空间的条件下完成。</p><p>示例 1:</p><p>给定数组 nums = [1,1,2], </p><p>函数应该返回新的长度 2, 并且原数组 nums 的前两个元素被修改为 1, 2。 </p><p>你不需要考虑数组中超出新长度后面的元素。<br>示例 2:</p><p>给定 nums = [0,0,1,1,1,2,2,3,3,4],</p><p>函数应该返回新的长度 5, 并且原数组 nums 的前五个元素被修改为 0, 1, 2, 3, 4。</p><p>你不需要考虑数组中超出新长度后面的元素。</p><p>来源：力扣（LeetCode）<br>链接：<a href="https://leetcode-cn.com/problems/remove-duplicates-from-sorted-array" target="_blank" rel="noopener">https://leetcode-cn.com/problems/remove-duplicates-from-sorted-array</a><br>著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。</p><p>给定一个排序数组，你需要在原地删除重复出现的元素，使得每个元素最多出现两次，返回移除后数组的新长度。</p><p>不要使用额外的数组空间，你必须在原地修改输入数组并在使用 O(1) 额外空间的条件下完成。</p><p>示例 1:</p><p>给定 nums = [1,1,1,2,2,3],</p><p>函数应返回新长度 length = 5, 并且原数组的前五个元素被修改为 1, 1, 2, 2, 3 。</p><p>你不需要考虑数组中超出新长度后面的元素。<br>示例 2:</p><p>给定 nums = [0,0,1,1,1,1,2,3,3],</p><p>函数应返回新长度 length = 7, 并且原数组的前五个元素被修改为 0, 0, 1, 1, 2, 3, 3 。</p><p>你不需要考虑数组中超出新长度后面的元素。</p><p>来源：力扣（LeetCode）<br>链接：<a href="https://leetcode-cn.com/problems/remove-duplicates-from-sorted-array-ii" target="_blank" rel="noopener">https://leetcode-cn.com/problems/remove-duplicates-from-sorted-array-ii</a><br>著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。</p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>同理， 现在拿到这类题目，我们第一时间就能想到 <strong>双指针</strong></p><p>对于第一题， 我们用一个指针 <code>idx</code> 来标记元素需要插入的位置， 用另一个指针 <code>i</code> 来标记遍历的元素位置，依次比较两个指针对应的值，不等时移动插入指针 <code>idx</code> 以及 <code>i</code> ， 相同时<strong>只</strong>移动指针 <code>i</code></p><hr><p>对于第二题， 我的第一反应是， 在第一题的基础上， 增加一个 <code>count</code> 字段，来标记当前元素出现的此处，只有小于 3 时才会插入，否则丢弃</p><hr><p>然后看了下大佬们的解答，发现这个 <code>count</code> 字段有点多余。</p><p>对于给定数组，本身是一个有序数组， 意味着，如果能够插入时，必然满足当前待插入元素 大于 前两个元素。</p><p>依照这个思路，可以把代码更加简洁化</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 第一题</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">removeDuplicates</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> nums<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            nums<span class="token punctuation">[</span><span class="token operator">++</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// ---------------------------- 第二题 ------------------------------- //</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">removeDuplicatesNoMoreThan2</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nums<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>nums<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">==</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>count <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                nums<span class="token punctuation">[</span><span class="token operator">++</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            nums<span class="token punctuation">[</span><span class="token operator">++</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> nums<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 精简但难理解的写法</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ah</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> num <span class="token operator">:</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// i &lt; 2 时为前两个元素， 直接插入</span>        <span class="token comment" spellcheck="true">// num > nums[i - 2]: 有序数组为前提，num 大于前两个数即表示 num 非重复次数大于 2 的元素</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">||</span> num <span class="token operator">></span> nums<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            nums<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> num<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> i<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
            <tag> leetcode-arrays </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>合并两个有序数组</title>
      <link href="/leetcode/arrays/merge-sorged-array/"/>
      <url>/leetcode/arrays/merge-sorged-array/</url>
      
        <content type="html"><![CDATA[<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><blockquote><p>给你两个有序整数数组 nums1 和 nums2，请你将 nums2 合并到 nums1 中，使 nums1 成为一个有序数组。</p><p> 要求时间复杂度为 O(n)</p><p>说明：</p><p>初始化 nums1 和 nums2 的元素数量分别为 m 和 n 。<br>你可以假设 nums1 有足够的空间（空间大小大于或等于 m + n）来保存 nums2 中的元素。</p><p>示例：</p><p>输入：<br>nums1 = [1,2,3,0,0,0], m = 3<br>nums2 = [2,5,6],       n = 3</p><p>输出：[1,2,2,3,5,6]</p><p>来源：力扣（LeetCode）<br>链接：<a href="https://leetcode-cn.com/problems/merge-sorted-array" target="_blank" rel="noopener">https://leetcode-cn.com/problems/merge-sorted-array</a><br>著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。</p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>这道题是根据之前 <a href="https://buzhui.top/leetcode/arrays/you-xu-shu-zu-de-ping-fang/">有序数组的平方</a> 的 tag： <code>双指针</code> 找来的。</p><p>所以我第一时间就想着如何通过 <strong>双指针</strong> 来做这道题。</p><p>因为本身是两个有序数组，且 <code>num1</code> 有足够的容量来容纳 <code>nums2</code> 的元素，所以我想到用两个指针来分别标记 <code>nums1</code> 和 <code>nums2</code> 的最后一个元素， <code>idx</code> 来标记新元素需要放到到 <code>nums1</code> 的位置，初始为 <code>nums1</code> 的最有一个元素位置</p><p>然后依次比较， 谁大， 谁就放到 <code>nums1</code> 的 <code>idx</code> 下标位置</p><p>直到 m 和 n 都小于 0，即 <code>num1</code> 和 <code>nums2</code> 中元素都找到合适的位置为止。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums1<span class="token punctuation">,</span> <span class="token keyword">int</span> m<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums2<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> left <span class="token operator">=</span> m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> right <span class="token operator">=</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> idx <span class="token operator">=</span> m <span class="token operator">+</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">do</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> right <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> num1 <span class="token operator">=</span> nums1<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> num2 <span class="token operator">=</span> nums2<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>num1 <span class="token operator">>=</span> num2<span class="token punctuation">)</span> <span class="token punctuation">{</span>                nums1<span class="token punctuation">[</span>idx<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> num1<span class="token punctuation">[</span>left<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                left<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                nums1<span class="token punctuation">[</span>idx<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> num2<span class="token punctuation">;</span>                right<span class="token operator">--</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>right <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                nums1<span class="token punctuation">[</span>idx<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> nums2<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>                right<span class="token operator">--</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>right <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> nums1<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这份代码是我第一次写的代码，虽然有写的匆忙的缘故， 整体看起来十分繁琐。</p><p>但胜在代码的整体思路，表达的很清晰。也很符合我当时的解题思路。</p><ol><li>找到双指针的位置，以及待插入元素的位置</li><li>根据双指针找到两个元素，根据比较结果，插入对应的位置，同时挪动双指针</li><li>当某一方指针移动完毕后， 就只移动另一方指针，防止数组下标越界</li></ol><hr><p>然后我看了下 <code>leetcode</code> 上其他人的解法，思路基本都一致，只是别人的代码却十分简洁。</p><p>归根结底， 我想， 还是我的思路不是特别清晰， 对于各种临界值的判断，还不是特别准且。</p><p>理解完大佬们的代码后，我又写了一份代码：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">merge3</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums1<span class="token punctuation">,</span> <span class="token keyword">int</span> m<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums2<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 这里在拿 idx 的同时， 对 m、n 做了处理，让他们处于正确的位置上</span>    <span class="token keyword">int</span> idx <span class="token operator">=</span> m<span class="token operator">--</span> <span class="token operator">+</span> n<span class="token operator">--</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 这个 while 只处理 m、n 都大于 0 的情况</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>m <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> n <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 使用谁，就让谁的指针移动</span>        nums1<span class="token punctuation">[</span>idx<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> nums1<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">></span> nums2<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">?</span> nums1<span class="token punctuation">[</span>m<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">:</span> nums2<span class="token punctuation">[</span>n<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 这里只判断 n 的情况</span>    <span class="token comment" spellcheck="true">// 因为 m 即使没有走完，剩下的元素也都已经处于正确位置，就不用再处理</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>n <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        nums1<span class="token punctuation">[</span>idx<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> nums2<span class="token punctuation">[</span>n<span class="token operator">--</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> nums1<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这段代码看起来， 就比之前的代码要简洁的太多，相关说明亦以放到注释里，不再赘述。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
            <tag> leetcode-arrays </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>有序数组的平方</title>
      <link href="/leetcode/arrays/you-xu-shu-zu-de-ping-fang/"/>
      <url>/leetcode/arrays/you-xu-shu-zu-de-ping-fang/</url>
      
        <content type="html"><![CDATA[<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><blockquote><p>给定一个按非递减顺序排序的整数数组 A，返回每个数字的平方组成的新数组，要求也按非递减顺序排序。</p><p>示例 1：</p><p>输入：[-4,-1,0,3,10]<br>输出：[0,1,9,16,100]<br>示例 2：</p><p>输入：[-7,-3,2,3,11]<br>输出：[4,9,9,49,121]</p><p>来源：力扣（LeetCode）<br>链接：<a href="https://leetcode-cn.com/problems/squares-of-a-sorted-array" target="_blank" rel="noopener">https://leetcode-cn.com/problems/squares-of-a-sorted-array</a><br>著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。</p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>同样，我们很容易想到： 先给这个数组来个平方放入新的数组， 然后对新的数组做排序就好了。因为要用到排序，所以时间复杂度不可能为 O(n) 。</p><p>但题目给定数组为 <strong>非递减</strong> 数组，即一个有序数组。</p><p>也就是说，当我们给每个数平方时(如果该数组含有负数) ， 则最大值必然在最左或者最右，然后向中间递减。</p><p>按照这个特性，我们可以考虑通过 <strong><font color="red">双指针</font></strong> 来做这件事情。</p><p>左指针 <code>left</code> 从最左往最右走， 右指针 <code>right</code> 从最右往最左走。每次比较最指针的平方值 <code>leftSquare</code> 和 右指针的平方值 <code>rightSquare</code> ，将最大的值放到新数组的最右边，然后将相应的指针移动一步，直到左指针 <code>left</code> <strong>大于</strong>右指针 <code>right</code></p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">sortedSquares</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ary<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 双指针， 是一种很有用的方法</span>        <span class="token comment" spellcheck="true">// 从左右两边分别往中间移动</span>        <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> right <span class="token operator">=</span> ary<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 用于标记下一个元素需要插入的位置</span>        <span class="token keyword">int</span> idx <span class="token operator">=</span> right<span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>ary<span class="token punctuation">.</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;=</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> leftSquare <span class="token operator">=</span> ary<span class="token punctuation">[</span>left<span class="token punctuation">]</span> <span class="token operator">*</span> ary<span class="token punctuation">[</span>left<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> rightSquare <span class="token operator">=</span> ary<span class="token punctuation">[</span>right<span class="token punctuation">]</span> <span class="token operator">*</span> ary<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leftSquare <span class="token operator">>=</span> rightSquare<span class="token punctuation">)</span> <span class="token punctuation">{</span>                left<span class="token operator">++</span><span class="token punctuation">;</span>                result<span class="token punctuation">[</span>idx<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> leftSquare<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                right<span class="token operator">--</span><span class="token punctuation">;</span>                result<span class="token punctuation">[</span>idx<span class="token operator">--</span><span class="token punctuation">]</span> <span class="token operator">=</span> rightSquare<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
            <tag> leetcode-arrays </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>每日事毕</title>
      <link href="/mine/dailys/"/>
      <url>/mine/dailys/</url>
      
        <content type="html"><![CDATA[<h2 id="每日事毕"><a href="#每日事毕" class="headerlink" title="每日事毕"></a>每日事毕</h2><p>前几日， 与老友前往宝石山爬山。约在了早上九点。</p><p>已然约摸 30 岁的年纪，但仍旧孑然一身，有时不免有些惭愧，但不在此时。</p><p>大概七点多，我起来洗漱完，就开始导航如何到达目的地。首选必然是地铁，只是看到地铁需要约 90 分钟，当时不知为何， 鬼使神差之下，搜起了骑行需要的时间，一看，嘿，只需要六七十分钟！于是我问自己，为什么不骑个共享单车过去呢？</p><p>所以我选择骑过去。</p><p>最后老友先行到达了保俶塔。这里提个题外话，作为一名接受过九年义务教育的合格的青年人，我是在到达保俶塔，通过搜索引擎搜索后，才知道<code>俶</code> 这个字，读作 <code>chu</code> 第四声。</p><p>我是 17 年上半年来的杭州工作，至今有三年多。期间和各路朋友，爬了杭州大大小小的山，比较有名的如北高峰、棋盘山等，只是这宝石山，似乎还是第一次爬。</p><p>杭州地处江南，多为丘陵地貌，所谓的山，也无高耸入云一说，多为低矮的小山丘。虽不高，但不可以为就好征服了。</p><p>它不高，但延绵不绝。</p><p>西湖那边的山大抵如此。</p><p>你可以从茶叶博物馆边的棋盘山开始，然后到龙井村，之后转到十里锒铛，到狮峰。整个一趟下来，至少也有十几二十公里。于我这种缺乏锻炼的人来说，本身就是不小的挑战，再加上整个路段不停的上下起伏，更是比寻常的走路更加耗费体力。</p><p>不管怎样，和老友就这般爬了上去。</p><p>我很喜欢找朋友出去爬山。</p><p>前段时间有一步比较火的网剧，一度让爬山成为一件很可怕的事情。当然，多为调侃。假使你一本正经的喊朋友出去爬山，他们大多会欣然同意。</p><p>我喜欢和朋友出去爬山。</p><p>说到底，我喜欢的，并非爬山本身，而是过程，更准确的说，是过程中，彼此的交流。现如今，很多时候出去旅游，多为任务般的打卡，我不喜。</p><p>我已经忘了是如何聊到<strong>坚持</strong>这个宽泛的话题上去的。虽然想不起来缘由，却让我感慨良多。</p><p>前文已然提及，我基本是一个而立之人了。细细回想起来，却不知道有什么是我每天坚持去做的。我想，大概只有呼吸了吧。</p><p>我们有句老话，叫三分钟热度，大概是说一个人坚持做一件事情的热情不能够持久，往往坚持了一段时间后就会放弃。我感觉用这个词来形容我是不合适的。因为我没有达到这个标准。或许用一分钟热度来形容比较准确。</p><p>我尝试过写小说，约摸坚持写了十万字，实在没什么反响，最终放弃了。</p><p>也想过学吉他，冲动之下，我买了一把入门的吉他，大约弹了三四次吧，也放弃了。</p><p>某日一个朋友买了单反，我想着，出去旅游的时候，能拍一些美美的照片，也是一件不错的事情，就买了一部尼康的单反，只在去大西北和西藏的时候带出去过，后面就让它静静的躺在盒子里了。</p><p>买了一只派克笔，几本字帖，想着好好练字，也能修身养性，这个倒是坚持了好几个月，只是最终还是没能把那几本字帖练完。</p><p>甚至于在参加完某位高中同学的婚礼后，想着要去考个研究生。回杭后就买了一套计算机考研辅导资料。在看完数学第一章函数后，就再也没有动过这套书籍了。这套书籍，每次搬家倒是成了不小的重量。</p><p>诸如此类的事情应该还有不少，只是此时却想不起来了。也罢，暂时就列举这些好了。</p><p>通过上述的罗列，让我坚信用三分钟热度来形容我，是对我的褒奖，只有用一分钟热度来形容，才是符合事实的，贴合实际的，是唯物主义的。</p><p>和老友狠狠的吐槽了自己一番后，觉得应该有一件事情，让我坚持去做，那就是跑步。</p><p>要说是从什么时候开始跑步的，或许从高中就开始了吧。</p><p>记得高一还是高二的某个早晨，我偷偷早期，去操场跑了十圈左右，四百米一圈。印象里只有这么一回。</p><p>后来到了大学，许是日子太过堕落，让我心生羞愧，我开始晨跑。早晨操场的跑道，人并不会很多，谁会没事早起跑步呢？</p><p>我一般都是跑三到五公里，兴致来了也会多跑一点。跑完就走几圈，等身体恢复的差不多了，就去食堂吃个早餐。这样的日子持续了一段时间。</p><p>说来也怪，那段日子里，慢慢的有身边的同学开始加入进来，虽然后面又慢慢的减少了。</p><p>我不知道为什么会慢慢的减少，到最后一个人都不再去跑步了。可能和变冷的天气有关吧。</p><p>我每次跑步的终结，都是因为天气，请允许我给自己找这样的一个借口。</p><p>于是我大学的跑步生涯结束了。</p><p>后来开始工作，许是我运气不错，遇到的同事都挺好。其中有一个家伙，和我住的地方很近，也忘了如何开始，便开始约着跑步。就这样，工作后再次跑了起来。</p><p>后来换工作，搬家，换到了离华东师范大学很近的一个地儿，再加上这份工作似乎不是特别忙碌，就又开始了跑步。这一次应该是目前为止，坚持的最久的一次了。至今 APP 上的很多记录，都是在这段时间完成的。同时，练习字帖，也是这段时间的事情。</p><p>后来从上海来到杭州，跑步也断断续续的跑过几段时间。闻涛路上跑步确实愉悦，可惜后来换到了未来科技城这边，便再也不能去那边跑步了。</p><p>仔细想来，似乎跑步是我坚持最久的一件事情了。</p><p>我本身身材矮小，篮球很有魅力，但大部分时间我只是看，足球接触很少，也踢过几次，但太剧烈，羽毛球也很有趣，只是怎么也打不好，兵乓球作为国球，也能打一打，但却勾不起我的兴趣。</p><p>这样一想，长跑，某种意义上来说，于我是合适的。而我也很享受长跑带给我的乐趣。</p><p>和老友在外婆家吃了一顿中饭，后又见了一个来杭州旅游的前同事，便回到了住处。</p><p>回来后，我内心激动不已。</p><p>也不知为何，我想到了村上春树的 《当我谈跑步时 我谈些什么》。 我十分认真且诚实的发誓，这本书，我没有看过，我甚至忘了我是从何种渠道得知这本书的名字的。我只知道，它就是这么突然的出现在了我的脑海里。</p><p>算了，不去追究了。我打开喜马拉雅 APP ，开始寻找这本书的声音。因为我打算在跑步时听。是的，我又要开始跑步了。同时下单买了这本书的纸质版，以及《不朽》。</p><p>当天晚上，我就开始罗列日后每日要做的事情。</p><p>每天刷一道 <code>leetcode</code>。这是因为我是一名以代码谋生的工作者。</p><p>每天写一篇文章。这是因为我认为输入到转换到输出，能让我很好的总结这一天的过程。</p><p>每天长跑一个小时。</p><p>最后的结尾，写点其他的吧。</p><p>昨天一个高中好友，在 Nature 的子刊《Nature Reviews Materials》 上发文章了。看到这个消息，着实惊喜。一方面为好友取得的成就感到开心和欣喜，一方面为我居然认识这样的人而感到惊讶。</p><p>我很想问问他，这么多年，有没有每天都坚持做的事情，如果有，那是什么?</p><p>以上。</p><p>于 2020 年 10 月 16 日 晨</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> mine </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>主要元素</title>
      <link href="/leetcode/arrays/zhu-yao-yuan-su/"/>
      <url>/leetcode/arrays/zhu-yao-yuan-su/</url>
      
        <content type="html"><![CDATA[<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><blockquote><p>数组中占比超过一半的元素称之为主要元素。给定一个整数数组，找到它的主要元素。若没有，返回-1。</p><p>示例 1：</p><p>输入：[1,2,5,9,5,9,5,5,5]<br>输出：5</p><p>示例 2：</p><p>输入：[3,2]<br>输出：-1</p><p>示例 3：</p><p>输入：[2,2,1,1,1,2,2]<br>输出：2</p><p>来源：力扣（LeetCode）<br>链接：<a href="https://leetcode-cn.com/problems/find-majority-element-lcci" target="_blank" rel="noopener">https://leetcode-cn.com/problems/find-majority-element-lcci</a><br>著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。</p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>那道题的第一反映， 是通过 <code>map</code> 来做， 统计数组中各个数字出现的次数，然后找到最大的。</p><p>这样的解法并无不妥，只是这世上大多有那样一群人，能够想出很多有趣而高效的解法，比如 <strong>摩尔投票法</strong> </p><p>摩尔投票法的<strong>前提</strong>，是默认存在这样的一个数，它超过占比的一半。</p><p>基于此前提，我们依次取出元素，用 <code>count</code> 来记录取出元素出现的次数, 用 <code>major</code> 来记录<em>主要元素</em></p><p>再取出之后的一个元素，相同则 <code>count + 1</code> ， 否则则 <code>count - 1</code> 。但 <code>count = 0</code> 时， 更新<code>major</code> 为下一个值。</p><p>因为 <code>major</code> 是<strong>主要元素</strong>，意味着，它可以将所有其他元素消灭后，还能留下自己。</p><p>而该算法的核心也就是消灭元素。</p><blockquote><p> 作者：喝七喜<br>链接：<a href="https://www.zhihu.com/question/49973163/answer/235921864" target="_blank" rel="noopener">https://www.zhihu.com/question/49973163/answer/235921864</a><br>来源：知乎<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p>我们再根据只有两个变量的实际代码理一遍：</p><p>major 初始化随便一个数，</p><p>count 初始化为0</p><p>输入：{1,2,1,3,1,1,2,1,5}</p><ul><li>扫描到1，count是0（没有元素可以和当前的1抵消），于是major = 1，count = 1（此时有1个1无法被抵消）</li><li>扫描到2，它不等于major，于是可以抵消掉一个major =&gt; count -= 1，此时count = 0,其实可以理解为扫到的元素都抵消完了，这里可以暂时不改变major的值</li><li>扫描到1，它等于major，于是count += 1 =&gt; count = 1</li><li>扫描到3，它不等于major，可以抵消一个major =&gt; count -= 1 =&gt; count = 0，此时又抵消完了(实际的直觉告诉我们，扫描完前四个数，1和2抵消了，1和3抵消了)</li><li>扫描到1，它等于major，于是count += 1 =&gt; count = 1</li><li>扫描到1，他等于major，无法抵消 =&gt; count += 1 =&gt; count = 2 (扫描完前六个数，剩两个1无法抵消)</li><li>扫描到2，它不等于major，可以抵消一个major =&gt; count -= 1 =&gt; count = 1,此时还剩1个1没有被抵消</li><li>扫描到1，它等于major，无法抵消 =&gt; count += 1 =&gt; count = 2</li><li>扫描到5，它不等于major，可以抵消一个major =&gt; count -= 1 =&gt; count = 1</li></ul><p>至此扫描完成，还剩1个1没有被抵消掉，它就是我们要找的数。  </p></blockquote><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">majorityElement</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">int</span> major <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> num <span class="token operator">:</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                major <span class="token operator">=</span> num<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            count <span class="token operator">+=</span> <span class="token punctuation">(</span>major <span class="token operator">==</span> num<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> moreThanHalf <span class="token operator">=</span> nums<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>        count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> num <span class="token operator">:</span> nums<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> major<span class="token punctuation">)</span> <span class="token punctuation">{</span>                count<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// if (count > moreThanHalf) {</span>            <span class="token comment" spellcheck="true">//     return major;</span>            <span class="token comment" spellcheck="true">// }</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> count <span class="token operator">></span> moreThanHalf <span class="token operator">?</span> major <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// return -1;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p>如何通过摩尔投票法，求取超过 <strong>1/3</strong> 的元素？</p><blockquote><p>作者：facetothefate<br>链接：<a href="https://www.zhihu.com/question/284969980/answer/440979325" target="_blank" rel="noopener">https://www.zhihu.com/question/284969980/answer/440979325</a><br>来源：知乎<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p><p>摩尔投票法基于这样一个定理：</p><p>如果一个数组里存在一个数超过一半，那么同时删去两个不同的数，超过一半的数仍然超过一半。</p><p>证明：</p><p>如果删去的两个数都不是抄过一半的，那么显然超过一半的还是超过一半。</p><p>如果删去的两个数有一个是超过一半的：由于超过一半的数&gt;n/2，假如我每次都删除一个超过一半的，一个不超过一半的，那么一定是不超过一半的数先被删完。</p><p>证明完毕。</p><p>好了，那么找到超过一半的数，就是扫描数组，每次都删去两个不同的数，最后没有不同的了，剩下的就是超过一半的数。</p><p>好了，那么我们推广一下这个定理，看看怎么适用在任意情况下，也就是我们可以找到占任意比例的元素。</p><p>比如，寻找1/3的元素。</p><p>定理：如果一个数组里有一元素超过1/3，那么同时删除3个不同的数，超过1/3的数扔超过1/3</p><p>证明：</p><p>如果删除的3个数都不是超过1/3的元素，那么显然成立。</p><p>如果删除的3个数有一个是超过1/3的元素，设该元素有 <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=+m+%3E+%5Cfrac%7Bn%7D%7B3%7D" alt="[公式]"> 个 </p><p>即证明：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=%5Cfrac%7Bn-m+-+2%7D%7Bm-1%7D+%3C+2" alt="[公式]"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=%5CRightarrow+n-m-2+%3C+2m-2" alt="[公式]"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=%5CRightarrow+n+-+2+%3C+3m+-2" alt="[公式]"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=%5CRightarrow+n+%3C+3m" alt="[公式]"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=%5CRightarrow+m+%3E+%5Cfrac%7Bn%7D%7B3%7D" alt="[公式]"></p><p>证明完毕</p><p>…</p><p>推广到k：</p><p>如果一个数组里有一元素超过1/k, 那么同时删除k个不同的数，超过1/k的数仍然超过1/k</p><p>如果删除的k个数都不是超过1/k的元素，那么显然成立</p><p>如果删除的k个数有一个是超过1/k的元素，设该元素有 <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=m+%3E+%5Cfrac%7Bn%7D%7Bk%7D" alt="[公式]"></p><p>即证明：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=%5Cfrac%7Bn-m+-%28+k-1%29%7D%7Bm-1%7D+%3C+%5Cfrac%7B1-%5Cfrac%7B1%7D%7Bk%7D%7D%7B%5Cfrac%7B1%7D%7Bk%7D%7D" alt="[公式]"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=%5CRightarrow+kn-km+-k%28k-1%29+%3C+k%28k-1%29m+-+k%28k-1%29" alt="[公式]"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=%5CRightarrow+n-m+%3C+%28k-1%29m" alt="[公式]"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=%5CRightarrow+n+%3C+km" alt="[公式]"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://www.zhihu.com/equation?tex=%5CRightarrow+m+%3E+%5Cfrac%7Bn%7D%7Bk%7D" alt="[公式]"></p><p>证明完毕</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
            <tag> leetcode-arrays </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>转置矩阵</title>
      <link href="/leetcode/arrays/zhuan-zhi-ju-zhen/"/>
      <url>/leetcode/arrays/zhuan-zhi-ju-zhen/</url>
      
        <content type="html"><![CDATA[<h2 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h2><blockquote><p>转置矩阵</p><p>给定一个矩阵 A， 返回 A 的转置矩阵。</p><p>矩阵的转置是指将矩阵的主对角线翻转，交换矩阵的行索引与列索引。</p><p>示例 1：</p><p>输入：[[1,2,3],[4,5,6],[7,8,9]]<br>输出：[[1,4,7],[2,5,8],[3,6,9]]<br>示例 2：</p><p>输入：[[1,2,3],[4,5,6]]<br>输出：[[1,4],[2,5],[3,6]]</p><p>来源：力扣（LeetCode）<br>链接：<a href="https://leetcode-cn.com/problems/transpose-matrix" target="_blank" rel="noopener">https://leetcode-cn.com/problems/transpose-matrix</a><br>著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。</p></blockquote><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>首先需要明确什么是 <strong>主对角线</strong></p><p>矩阵的主对角线是指 n 阶矩阵从 a<sub>11</sub> 到 a<sub>nn</sub> 元素所在的对角线， 对角线上的元素称为对角元素。</p><p>对于示例一， 其实是一个 方阵，即行 i 等于 列 j 。</p><p>对于示例二， 对角元素为 1，5。</p><hr><p>通过观察我们发现，本题的实质就是一个二元数组的 <code>i</code> 和 <code>j</code> 的交换而已(所以这题被标记为简单)。</p><p>通过两个 <code>for</code> 循环，就能很方便的搞定这一题了。</p><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transpose</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> A<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> aryI <span class="token operator">=</span> A<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span> aryJ <span class="token operator">=</span> A<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>        <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span>aryJ<span class="token punctuation">]</span><span class="token punctuation">[</span>aryI<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> aryI<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> aryJ<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                result<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> result<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20201014235825.png-growing" alt="image-20201014235816083"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> leetcode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> leetcode </tag>
            
            <tag> leetcode-arrays </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java/note</title>
      <link href="/java/note/"/>
      <url>/java/note/</url>
      
        <content type="html"><![CDATA[<p>强引用</p><p>弱引用</p><p>软引用</p><p>虚引用</p><hr><h3 id="软引用"><a href="#软引用" class="headerlink" title="软引用"></a>软引用</h3><p>SoftReference</p><p>当堆内存不足时， 该引用对象会被回收</p><p>应用场景： 缓存</p><h3 id="弱引用"><a href="#弱引用" class="headerlink" title="弱引用"></a>弱引用</h3><p>WeakReference</p><p>如果只有弱引用指向对象 A ， 则在 GC 时，会被直接回收</p><h3 id="虚引用"><a href="#虚引用" class="headerlink" title="虚引用"></a>虚引用</h3><p>PhantomReference</p><pre class=" language-java"><code class="language-java">PhantomReference<span class="token operator">&lt;</span>Person<span class="token operator">></span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhantomReference</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceQueue</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>p<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// null</span></code></pre><p>通过 <code>get()</code> 都拿不到</p><p><strong>一般用来管理直接内存</strong></p><p>直接内存，不归 GC 管， 一般由 JVM 来管理，这块的内存，一般给 NIO 使用。</p><hr><h3 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h3><p>spring tx 中连接(connection)的传递。</p><hr><h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><ol><li>NIO ByteBuffer.allocate 和 ByteBuffer.allocateDirect</li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Strategy Pattern</title>
      <link href="/patterns/strategy-pattern/"/>
      <url>/patterns/strategy-pattern/</url>
      
        <content type="html"><![CDATA[<h1 id="Strategy-Pattern"><a href="#Strategy-Pattern" class="headerlink" title="Strategy Pattern"></a>Strategy Pattern</h1><blockquote><p>策略模式作为一种软件设计模式，指对象有某个行为，但是在不同的场景中，该行为有不同的实现算法。比如每个人都要“交个人所得税”，但是“在美国交个人所得税”和“在中国交个人所得税”就有不同的算税方法。</p><p>策略模式：</p><p>定义了一族算法（业务规则）；<br>封装了每个算法；<br>这族的算法可互换代替（interchangeable）</p><p>– 摘自维基百科</p></blockquote><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>最近在工作中，要实现这样的一个业务：</p><p>提供一个发布窗口的功能，各个项目负责人，能通过这个发布窗口，自定义各个项目、应用的发布时间，在发布窗口外，一律不准许发布上线(这个功能， 在 <a href="https://buzhui.top/patterns/resposibility-chain/">Chain of Responsibility Pattern</a> 有提及)。</p><p>而这个窗口的设置，我们提供了两种设置方式：</p><ul><li>开始时间 - 结束时间， 在这个时间内，可以进行发布</li><li>cron 表达式(spring cron)， 在该表达式内可以发布</li></ul><h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><h3 id="if-else"><a href="#if-else" class="headerlink" title="if else"></a>if else</h3><p>显然， <code>if... else...</code> 能迅速解决这个问题。但是！我们会用这个吗？ 很明显，不会！</p><p>我们可能经常会看到一连串的 <code>if... else...</code> 。 我觉得一开始写这种代码的人， 肯定不会想到那样的场景。可能在当时， 此人只觉得这样实现省时省力、直白明了。</p><p>可惜事与愿违， 后面新需求过来， 另一个开发者一看，哦， 这里已经有了，只要加一个 <code>else if...</code> 就好了，简单！</p><p>于是经过时间的沉淀，终于变成了一份 <strong>历史沉重</strong> 的代码了。</p><p>所以我希望能在源头拒绝掉这种方式，所以我选择用策略模式来实现。</p><h3 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://upload.wikimedia.org/wikipedia/commons/3/39/Strategy_Pattern_in_UML.png" alt="UML FROM WIKI"></p><p>通过 wiki 提供的 UML ， 可以看到， 它有几个主要角色：</p><ul><li>strategy： 通常为 interface，所有的具体策略需要实现该接口，主要用于 <code>context</code> 来调用</li><li>concreteStrategy ： 具体策略</li><li>context：会持有 strategy 对象， 使用时， 通过 <code>context</code> 完成对具体策略的调用</li></ul><h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><h4 id="strategy"><a href="#strategy" class="headerlink" title="strategy"></a>strategy</h4><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Strategy</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 用于提供给 context 具体调用的方法     * check if in window     *     * @param date     * @return     */</span>    <span class="token keyword">boolean</span> <span class="token function">exec</span><span class="token punctuation">(</span>Date date<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 完全可以再定义一些替他的通用方法， 如合法性检测等， 这里略去 </span><span class="token punctuation">}</span></code></pre><h4 id="concreteStrategy"><a href="#concreteStrategy" class="headerlink" title="concreteStrategy"></a>concreteStrategy</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@JsonIgnoreProperties</span><span class="token punctuation">(</span>ignoreUnknown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CronStrategy</span> <span class="token keyword">implements</span> <span class="token class-name">DeployPublishStrategy</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Getter</span>    <span class="token keyword">private</span> String cron<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * for objectMapper     */</span>    <span class="token keyword">private</span> <span class="token function">CronStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token function">CronStrategy</span><span class="token punctuation">(</span>String cron<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>cron <span class="token operator">=</span> cron<span class="token punctuation">;</span>    <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/**      * exec 的具体实现      */</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">exec</span><span class="token punctuation">(</span>Date date<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CronSequenceGeneratorExt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>cron<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h4 id="context"><a href="#context" class="headerlink" title="context"></a>context</h4><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeployPublishStrategyCtx</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * 这里事实上可以用 {@link List}, 用 {@link Map} 可以返回匹配到的 {@link DeploymentPublishStrategyEntity}     */</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>DeploymentPublishStrategyEntity<span class="token punctuation">,</span> DeployPublishStrategy<span class="token operator">></span> strategyMap<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token function">DeployPublishStrategyCtx</span><span class="token punctuation">(</span>Collection<span class="token operator">&lt;</span>DeploymentPublishStrategyEntity<span class="token operator">></span> entities<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>strategyMap <span class="token operator">=</span> <span class="token function">genStrategies</span><span class="token punctuation">(</span>entities<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 只要有一个在窗口， 就返回 true     * 现在不用考虑优先级的问题， 因为是一个或的关系     *     * @param date date     * @return strategy if exist. null means passed     */</span>    <span class="token keyword">public</span> DeploymentPublishStrategyEntity <span class="token function">exist</span><span class="token punctuation">(</span>Date date<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>DeploymentPublishStrategyEntity<span class="token punctuation">,</span> DeployPublishStrategy<span class="token operator">></span> entry <span class="token operator">:</span> strategyMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            DeployPublishStrategy strategy <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>strategy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>date<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> Map<span class="token operator">&lt;</span>DeploymentPublishStrategyEntity<span class="token punctuation">,</span> DeployPublishStrategy<span class="token operator">></span> <span class="token function">genStrategies</span><span class="token punctuation">(</span>Collection<span class="token operator">&lt;</span>DeploymentPublishStrategyEntity<span class="token operator">></span> entities<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> entities<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span>k <span class="token operator">-</span><span class="token operator">></span> k<span class="token punctuation">,</span> v <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> DeployPublishStrategyFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span><span class="token function">getStrategyType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"generate deployment window entity={} to strategy failed."</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span><span class="token function">getDeployPublishStrategyId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这里的 <code>context</code> 可以看到我的实现， 其实不是标准的实现。</p><p>但上一篇文章我也提到过， <strong>所有的所谓的设计模式，都是为业务、为代码服务的，没有标准的写法，只有贴合实际的实现方式</strong> </p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> patterns </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pattern </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Chain of Resposibility Pattern</title>
      <link href="/patterns/resposibility-chain/"/>
      <url>/patterns/resposibility-chain/</url>
      
        <content type="html"><![CDATA[<h1 id="Chain-of-Resposibility-Pattern"><a href="#Chain-of-Resposibility-Pattern" class="headerlink" title="Chain of Resposibility Pattern"></a>Chain of Resposibility Pattern</h1><p>责任链模式， 按照<a href="https://en.wikipedia.org/wiki/Chain-of-responsibility_pattern" target="_blank" rel="noopener">官方定义</a>，属于设计模式中的 <strong>行为模式</strong> 。</p><h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>写这篇文章的原因，是因为最近在工作中，遇到了这样的一个场景： 在通过我们的 PaaS 平台去部署一个线上应用时，需要经历一系列的检查:</p><ul><li>是否为封网期(封网期不允许发布线上应用)</li><li>是否为紧急发布(可通过申请，在经过大佬允许后能发布)</li><li>是否在发布窗口的管制中(凡是处于发布窗口中的应用不允许发布，事实上， 这里的实现，也可以水一篇设计模式的文章，名曰策略模式，此为后话)</li><li>… 等等其他的一系列限制</li></ul><h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><p>事实上在此之前，我们在部署之前，就已经要做很多检查。趁此时机，我做好了重新梳理这块逻辑的打算。</p><h3 id="if-else"><a href="#if-else" class="headerlink" title="if else"></a>if else</h3><p>最简单的做法，就是把所有需要检查的步骤，都梳理出来，如 A、B、C… 然后用 <code>if... else...</code> 来一个个判断。然而作为一名老工人，此法必然不会被我青睐。 </p><h3 id="主角登场"><a href="#主角登场" class="headerlink" title="主角登场"></a>主角登场</h3><p>好在之前有点沉淀，看过 zk 里处理 client 端请求实现的方式( <a href="https://buzhui.top/zookeeper/zab/">zk 责任链</a>)， 以及 <code>okHttp</code> 中相关的实现，所以果断选择用 <strong>责任链模式</strong> 来做这件事情。</p><h3 id="何为责任链模式"><a href="#何为责任链模式" class="headerlink" title="何为责任链模式"></a>何为责任链模式</h3><p>我理解的责任链，就是一个请求，会流转给多个责任人处理。嗯，是的，就是这么一句话。<br>在这里，又分两种情况：</p><ul><li>纯的责任链模式，每个责任人要么全部处理完，要么直接交给下一位责任人，不存在 <strong>处理一半</strong> 的情况</li><li>不纯的责任链模式， 存在某个责任人，处理部分任务后，再传递给下一位责任人</li></ul><p>老实说，<strong>所有的所谓的设计模式，都是为业务、为代码服务的，没有标准的写法，只有贴合实际的实现方式</strong> 。所以这里所谓的纯与不纯，知道就行。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://upload.wikimedia.org/wikipedia/commons/6/6a/W3sDesign_Chain_of_Responsibility_Design_Pattern_UML.jpg" alt="UML from WIKI"></p><p>通过上述的类图和时序图，我们可以看到，责任链模式主要由</p><ul><li>handler : interface, 负责定义责任链的功能</li><li>concreteHandler : 实现类，负责实现各自的具体功能</li></ul><p>所以看到现在， 是不是发现，那些高大上的叫法，其实就是批了一层皮而已。拔下皮来，发现不过如此。</p><h2 id="怎么实现"><a href="#怎么实现" class="headerlink" title="怎么实现"></a>怎么实现</h2><p>对应到上文提到的具体场景，我们首先需要定义一个 <code>interface</code> ，用来规定后面所有具体实现类的责任。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Interceptor</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">/**     * do intercept     *     * @param context     * @return resp     */</span>    Resp <span class="token function">intercept</span><span class="token punctuation">(</span>T context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/**     * context validation     * throw exception if context incomplete     *     * @param context context     */</span>    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span>T context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">assert</span> Objects<span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * register self to chain     *     * @param chain chain     */</span>    <span class="token keyword">default</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span>Chain<span class="token operator">&lt;</span>T<span class="token operator">></span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>        chain<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/**      * 用于组织各个 interceptor      */</span>    <span class="token keyword">interface</span> <span class="token class-name">Chain</span><span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/**         * add interceptor         *         * @param interceptor interceptor         */</span>        <span class="token keyword">void</span> <span class="token function">addInterceptor</span><span class="token punctuation">(</span>Interceptor<span class="token operator">&lt;</span>T<span class="token operator">></span> interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * execute all of interceptors         *         * @param context The context provides the parameters required by the interceptor         */</span>        <span class="token keyword">void</span> <span class="token function">intercept</span><span class="token punctuation">(</span>T context<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Resp</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">/**         * do next interceptor if true         */</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> doNext<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * if the interceptor passed, then return true         */</span>        <span class="token keyword">final</span> <span class="token keyword">boolean</span> success<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**         * return message if necessary         * msg must implement its own {@code toString()} method         */</span>        <span class="token keyword">final</span> Object msg<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// ...</span>    <span class="token punctuation">}</span>      <span class="token comment" spellcheck="true">/**     * 这里只是大致定义下优先级， 具体优先级完全可以由用户通过 {@link this#priority()}提供     *     * @see #priority()     */</span>    <span class="token keyword">enum</span> Priority <span class="token punctuation">{</span>        <span class="token function">LOWEST</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">LOW</span><span class="token punctuation">(</span><span class="token number">0xfff</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">MIDDLE</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">HIGH</span><span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token function">HIGHEST</span><span class="token punctuation">(</span>Integer<span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">;</span>        <span class="token keyword">int</span> priority<span class="token punctuation">;</span>        <span class="token function">Priority</span><span class="token punctuation">(</span><span class="token keyword">int</span> priority<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>priority <span class="token operator">=</span> priority<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">/**     * 优先级, 越小越先执行     * 这里并没有其他意义     *     * @return     */</span>    <span class="token keyword">default</span> Priority <span class="token function">priority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Priority<span class="token punctuation">.</span>LOW<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>这个 <code>interceptor</code> 事实上就是上文中的 <code>Handler</code> 。 当然， 这个 <code>interceptor</code> 中， 做了很多其他的事情，这就是我前面说的，代码为业务服务，而不是教条式的按照所谓的标准去实现。</p><p>这里的 <code>chain</code> 主要是用来组织上下文 <code>context</code> , 负责组装各个 <code>interceptor</code> 的具体实现链，以及调度、中断责任链。</p><p><code>Resp</code> 则是定义各个 <code>interceptor</code> 的返回对象，接收各个 <code>interceptor</code> 的返回值，以及通过 <code>doNext</code> 来决定是否需要继续执行</p><p><code>Priority</code> 则是用来定义 <code>interceptor</code> 的执行顺序。</p><h3 style="color:red"> Tips </h3><p>一般而言， 一个完整的责任链，是通过上一个责任链中持有的 <code>next</code> 或者 <code>nextHandler</code> 之类的属性，来确定下一个处理人。我这里是通过 <code>Proirity</code> 给定每个责任人持有的优先级，然后让 <code>chain</code> 在执行时来确定每次执行的具体责任人。</p><p>这里列出一个具体实现</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">YourInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Resp <span class="token function">intercept</span><span class="token punctuation">(</span>InterceptorChain<span class="token punctuation">.</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// logic code</span>        <span class="token keyword">return</span> Resp<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span>InterceptorChain<span class="token punctuation">.</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// check context param </span>        <span class="token comment" spellcheck="true">// throw exception if missing </span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> Priority <span class="token function">priority</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Priority<span class="token punctuation">.</span>HIGH<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>chain 的具体实现</p><pre class=" language-java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span><span class="token annotation punctuation">@Component</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterceptorChain</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor<span class="token punctuation">.</span>Chain</span><span class="token operator">&lt;</span>InterceptorChain<span class="token punctuation">.</span>Context<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Getter</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// context implement</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> Set<span class="token operator">&lt;</span>Interceptor<span class="token operator">></span> interceptors <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreeSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>Comparator<span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span>o <span class="token operator">-</span><span class="token operator">></span> o<span class="token punctuation">.</span><span class="token function">priority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>priority<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// 可以搞一个 builder</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addInterceptor</span><span class="token punctuation">(</span>Interceptor<span class="token operator">&lt;</span>Context<span class="token operator">></span> interceptor<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Interceptor<span class="token punctuation">)</span> interceptor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">intercept</span><span class="token punctuation">(</span>Context ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>Interceptor interceptor <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptors<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// check param's illegality</span>            interceptor<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>            Interceptor<span class="token punctuation">.</span>Resp resp <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>            Object msg <span class="token operator">=</span> resp<span class="token punctuation">.</span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>resp<span class="token punctuation">.</span><span class="token function">doNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"interceptor ["</span> <span class="token operator">+</span> interceptor <span class="token operator">+</span> <span class="token string">"] passed, intercept completed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"interceptor ["</span> <span class="token operator">+</span> interceptor <span class="token operator">+</span> <span class="token string">"] passed, do next interceptor."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"interceptor ["</span> <span class="token operator">+</span> interceptor <span class="token operator">+</span> <span class="token string">"] not passed. msg = "</span> <span class="token operator">+</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> patterns </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pattern </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Discrete Math</title>
      <link href="/math/discrete/"/>
      <url>/math/discrete/</url>
      
        <content type="html"><![CDATA[<p>学习内容</p><blockquote><p><a href="https://www.icourse163.org/learn/PKU-1002525004?tid=1450235468#/learn/content?type=detail&amp;id=1214405792&amp;cid=1218135006&amp;replay=true" target="_blank" rel="noopener">https://www.icourse163.org/learn/PKU-1002525004?tid=1450235468#/learn/content?type=detail&amp;id=1214405792&amp;cid=1218135006&amp;replay=true</a></p></blockquote><h2 id="命题"><a href="#命题" class="headerlink" title="命题"></a>命题</h2><ul><li>陈述句</li><li>判断</li><li>确定的对象</li><li>真值是命题的固有属性</li><li>悖论不能作为命题（”这句话是错的" ， 这句话就是一个悖论，故不可作为命题 ）</li><li>命题非真即假， 不能兼而有之，也不能不真不假</li></ul><h3 id="排中律"><a href="#排中律" class="headerlink" title="排中律"></a>排中律</h3><p>Law of Excluded Middle</p><p>是传统逻辑的基本规律之一，任一事物， 在同一时间里，具有某属性或者不具有某属性，而无其他可能。</p><p><strong>反证法</strong>  ： 证明一个命题为真，可以先证明这个命题为假不成立，从而得到这个命题为真</p><h3 id="逻辑连接词"><a href="#逻辑连接词" class="headerlink" title="逻辑连接词"></a>逻辑连接词</h3><ul><li><p>真命题 t ， 假命题 f</p></li><li><p>原子命题 p, q, r, s 或者 p<sub>i</sub> ， q<sub>i</sub> ， r<sub>i</sub> ， s<sub>i</sub> 表示</p></li><li><p>逻辑连接词</p><blockquote><p>not ：$\lnot$</p></blockquote><p>p $\lnot$ q</p><hr><blockquote><p>and ： $\land$ </p></blockquote><p>p $\land$ q</p><hr><blockquote><p>or ： $\lor$   这里的 or ， 一般指相容或， 如 张三学过英语或法语</p></blockquote><p>p $\lor$ q</p><hr><blockquote><p>xor ：$\oplus$  ， 亦或， 这里即指不相容或， 如 张三生于 1998 或 1999 年</p></blockquote><p>（p $\land$  $\lnot$ q）$\lor$ （ $\lnot$ p $\land$ q） </p><hr><blockquote><p>if … then …  ： $\to$  ， 蕴含， 只要就， 如果那么， 只有才</p></blockquote><p>$\lnot$ p $\lor$ q， 只有当 p 真 q 假是才为 假</p><hr><blockquote><p>if and only if ： $\leftrightarrow$  ， 当且仅当</p></blockquote></li></ul><hr><h3 id="命题公式-proposition-formula"><a href="#命题公式-proposition-formula" class="headerlink" title="命题公式( proposition formula)"></a>命题公式( proposition formula)</h3><ul><li>命题常元(proposition constants)： 表示具体命题及表示常命题的 p, q, r, s 等 和 t ， f</li><li>命题变元(proposition variables) ：以 真、假 或者 0、1 为取值范围的变量， 仍用 p, q, r, s 等表示</li><li>命题公式(proposition formula) ： 由命题常元、变元和连接词组成的，形式更为复杂的命题<ul><li>命题常元 和 命题变元是命题公式， 特别的，称为原子公式或原子</li><li>如果 A，B 是命题公式， 那么 $\lnot$A ， A $\land$ B, A $\lor$ B , A $\to$ B , A  $\leftrightarrow$ B 也是命题公式</li><li>只有有限步引用上述两条所组成的符号串， 是命题公式</li></ul></li></ul><p>命题公式简称公式， 采用大写 A， B， C 等表示</p><p><em>Tips： 一般大写代表命题公式， 而小写的 p, q, r, s, t, f 等代表命题，特别是命题变元和命题常元</em></p><hr><h3 id="逻辑连接词优先级"><a href="#逻辑连接词优先级" class="headerlink" title="逻辑连接词优先级"></a>逻辑连接词优先级</h3><ul><li>一元连接词 ： 非 ， not ， $\lnot$ </li><li>二元连接词： 其他的连接词都是</li></ul><p><strong>优先级： 先 $\lnot$ ，  然后 $\land$ , $\lor$  ， 再 $\to$ ， 最后 $\leftrightarrow$</strong>  ， 相同优先级，按从左到右运算</p><hr><h3 id="成真赋值-和-成假赋值"><a href="#成真赋值-和-成假赋值" class="headerlink" title="成真赋值 和 成假赋值"></a>成真赋值 和 成假赋值</h3><p>当公式 A 对赋值 α 为真时， 称 α  是 A 的<strong>成真赋值</strong>， 或者  α <strong>弄真</strong> A ， 记作： α (A) = 1 ， 反之，称 α 是 A 的<strong>成假赋值</strong>， 或者 α <strong>弄假</strong> A ， 记作 α (A) = 0 </p><hr><h3 id="命题公式的分类"><a href="#命题公式的分类" class="headerlink" title="命题公式的分类"></a>命题公式的分类</h3><ul><li><p>重言式： tautology(永真式) , 命题变元的所有赋值都是命题公式的成真赋值</p></li><li><p>矛盾式： contradiction(永假式、不可满足式)， 命题变元的所有赋值都是命题公式的成假赋值</p></li><li><p>可满足式：contingency ， 命题公式至少有一个成真赋值</p></li></ul><hr><h3 id="逻辑等价式"><a href="#逻辑等价式" class="headerlink" title="逻辑等价式"></a>逻辑等价式</h3><p>logical equivalent， 当命题公式 A $\leftrightarrow$ B 是重言式时， 则称 A 逻辑等价于 B ， 记作 A  $\equiv$ B ， 或者 A $\Leftrightarrow$ B ， 课程中用 $\vDash$| 来表示的， A $\vDash$| B 表示(应该是 H 中多一横， 没找到这个符号， 投机用 <code>$\vDash$</code> 和 <code>|</code>  来”合成”了这个符号) </p><p>可以理解为公式 A 和公式 B 等值。</p><p>逻辑等价体现了两个公式之间的一种关系： 在任何赋值状况下， 他们都等值。</p><hr><h3 id="重要的逻辑等价式-公式"><a href="#重要的逻辑等价式-公式" class="headerlink" title="重要的逻辑等价式 / 公式"></a>重要的逻辑等价式 / 公式</h3><ul><li>¬¬A  ⟺ A 双重否定 </li><li>A ∨ A ⟺ A ， A ∧ A ⟺ A 幂等律</li><li>A ∨ B ⟺ B ∨ A ， A ∧ B ⟺ B ∧ A ， 交换律</li><li>(A ∨ B) ∨ C ⟺ A ∨ (B ∨ C) ， (A ∧B) ∧ C ⟺ A ∧(B ∧ C) , 结合律</li></ul><hr><ul><li><p>A ∧ (B ∨ C) ⟺ (A ∧ B) ∨ (A ∧ C) ， A ∨ (B ∨ C) ⟺ (A ∨ B) ∧ (A ∨ C) ， 分配律</p></li><li><p>¬(A ∨ B) ⟺ ¬A ∧ ¬B ，¬(A ∧ B) ⟺ ¬A ∨ ¬B ， 德摩根定律</p></li><li><p>A ∨ (A ∧ B) ⟺ A ， A ∧ (A ∨ B) ⟺ A ， 吸收率</p></li></ul><hr><ul><li>A → B ⟺  ¬A ∨ B ， 蕴含等值式</li><li>A ↔ B ⟺ (A → B) ∧ (B → A) ，等价等值式</li><li>A ↔ B ⟺ (A ∧ B) ∨ (¬A ∧ ¬B) ， 等价等值式 2</li><li>A → B ⟺  ¬B →  ¬A ，假言异位</li></ul><hr><ul><li>A ∧ B → C ⟺   A → (B → C)</li><li>(A → B) ∧ (A → ¬B) ⟺  ¬A ，归谬论</li><li>p $\downarrow$ q ： peirce 记号：  p $\downarrow$ q $\Leftrightarrow$ $\lnot$ (p $\lor$ q) </li></ul><hr><h3 id="逻辑蕴涵式"><a href="#逻辑蕴涵式" class="headerlink" title="逻辑蕴涵式"></a>逻辑蕴涵式</h3><p>当命题公式 A → B 是<strong>重言式</strong> 式， 称 A 逻辑蕴涵 B， 记作 A $\vDash$ B，称作逻辑蕴涵式。</p><p>也可以理解为公式 A 的所有成真赋值都是公式 B 的成真赋值。</p><p>每个逻辑等价式可以看作两个逻辑蕴涵式，也就是说：</p><ul><li>A ⟺  B 表示 A $\vDash$B ，B $\vDash$ A</li></ul><p>逻辑蕴涵体现了两个公式 A、B 之间的另一种关系： 在任何赋值状况下，只要 A 真， B 都真</p><hr><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200524183141.png-growing" alt="逻辑蕴涵式"></p><hr><h3 id="重要性质"><a href="#重要性质" class="headerlink" title="重要性质"></a>重要性质</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200524183455.png-growing" alt="逻辑蕴涵重要性质"></p><hr><h3 id="带入原理-RS-与替换原理-RR-区别"><a href="#带入原理-RS-与替换原理-RR-区别" class="headerlink" title="带入原理 RS 与替换原理 RR 区别"></a>带入原理 RS 与替换原理 RR 区别</h3><p><strong>带入原理 RS</strong>：rule of substitution</p><p>将重言式 A 中的某个命题变元 p 的所有出现，都代换为命题公式 B， 得到的命题公式记作： A(B/p) ，则 A(B/p) 也是重言式 。</p><p>因为重言式 A 的真值与 p 的取值状况无关， 恒为 t 。</p><p><strong>要求所有出现都替换。</strong></p><hr><p><strong>替换原理 RR</strong> ： rule of replacement</p><p>将命题公式 A 中的子公式 C 的部分出现替换为和 C 逻辑等价的公式 D (C ⟺ D)，得到的命题公式记作 B ， 则 A ⟺ B 。</p><p>因为 C 和 D (在任何赋值下) 等值， 所以用 D 替换 C ， 不会改变 A 的真值。</p><p><strong>不要求全部出现都替换。</strong></p><hr><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200526024509.png-growing" alt="diff"></p><hr><h2 id="范式"><a href="#范式" class="headerlink" title="范式"></a>范式</h2><p>在命题公式的多个逻辑等价的形式中， 较为符合 “标准”  或 “规范” 的一种形式。</p><p><strong>文字</strong>(literals) ：命题常元、命题变元和他们的否定。正文字、负文字(否定)</p><p>析取子句：</p><p>合取子句：文字或若干文字的合取 ^ 。</p><p>互补文字对：指一对正文字和负文字： p 和 非 p 。</p><hr><p>A ‘ 为 A 的<strong>析取范式</strong>， 则：</p><ul><li>A ’ ⟺ A</li><li>A ‘ 为合取子句或者若干合取子句的析取</li><li>p $\to$ q 的析取范式为 $\lnot$p $\lor$ q</li><li>((p $\to$q) $\land$ $\lnot$p) $\lor$ $\lnot$q 的析取范式为：$\lnot$p $\lor$ (q $\land$ $\lnot$ p) $\lor$ $\lnot$q</li></ul><hr><p>A ’ 为 A 的<strong>合取范式</strong>， 则：</p><ul><li>A ‘ ⟺ A</li><li>A ’ 为析取子句或者若干析取子句的合取</li><li>p $\to$ q 的合取范式为 $\lnot$p $\lor$ q ， 这里，是作为一个完整的析取子句来看待的</li><li>((p $\to$q) $\land$ $\lnot$p) $\lor$ $\lnot$q 的合取范式为：$\lnot$p $\lor$ $\lnot$q ， 也是作为一个完整的析取子句看待</li></ul><hr><h3 id="范式用于识别重言式和矛盾式"><a href="#范式用于识别重言式和矛盾式" class="headerlink" title="范式用于识别重言式和矛盾式"></a>范式用于识别重言式和矛盾式</h3><p><strong>重言式识别</strong></p><p>合取范式中，每个析取子句都包含了至少一个互补文字对：</p><p>(p $\lor$  $\lnot$ p $\lor$  q) $\land$ (p $\lor$ q $\lor$  $\lnot$ q )</p><p><strong>矛盾式识别</strong></p><p>析取范式中，每个合取子句都包含了至少一个互补文字对：</p><p>(p $\land$  $\lnot$ p $\land$ q) $\lor$ (p $\land$ q $\land$  $\lnot$ q )</p><hr><h3 id="主范式"><a href="#主范式" class="headerlink" title="主范式"></a>主范式</h3><p><strong>主析取范式</strong> ：</p><ul><li>A ‘ 是 A 的析取范式</li><li>A ‘ 中每个合取子句里的 p1, p2, … pn 均恰出现一次</li></ul><p><strong>主合取范式</strong> ：</p><ul><li>A ‘ 是 A 的合取范式</li><li>A ‘ 中每个析取子句里的 p1, p2, … pn 均恰出现一次</li></ul><hr><h3 id="量词"><a href="#量词" class="headerlink" title="量词"></a>量词</h3><p>$\forall$  ： 任意</p><p>$\exists$   ： 存在 </p><hr><h2 id="图论-Graph"><a href="#图论-Graph" class="headerlink" title="图论( Graph )"></a>图论( Graph )</h2><p>科尼斯堡七桥问题</p><p>G = &lt; V, E&gt;</p><ul><li><p>V：节点 vertex 集， 非空集合</p></li><li><p>E ：边 edge 集， 多重集合(集合中可能存在相同元素，元素附带一个重数的属性)</p></li><li><p>边集是多重集合，表示图可以有多个相同的边</p></li></ul><hr><p>有向边：directed edge，用节点的二元有序组表示</p><p>第一分量称为起点，第二分量称为终点</p><p>无向边：indirected edge，用节点的两元素多重集表示</p><p>无向边可以是多重集，意味着允许无向环(loop)</p><p>无向边的端点称作邻接节点</p><hr><p>对于图 G = &lt;V, E&gt; </p><p>有限图：V, E 都是有限集，否则称为无限图</p><p>重边：E 中重数大于 1 的边，称为重边 / 平行边</p><p>重图：边集 E 中至少有一个元素重数大于 1</p><p>单图：每条边的重数都等于 1</p><p>简单图：无环和重边的无向图</p><p>完全图：任何两个不同节点间都有边连接的简单图，记作 Kn </p><p>孤立节点：不是任何边的端点的节点</p><p>零图：仅有孤立节点构成的图， E = $\emptyset$</p><p>赋权图 G = &lt;V, E, f, g&gt;</p><ul><li>节点权函数： f:  V -&gt; W</li><li>边权函数：g: E -&gt; W</li><li>W 可以是任何集合， 常为实数的子集</li></ul><p>普通的图，研究节点和边之间的拓扑关系。 如： 邻接， 连通， 通路， 划分等性质</p><p>赋权图给普通图附加了数量关系。 如： 研究距离，成本，代价，规模等性质， 是 GIS 的基础</p><hr><p><strong>节点的度</strong> degree</p><p>端点 v 的度 d(v) 定义为关联端点 v 的边的数目</p><p>有向图中， 度分为两种：</p><ul><li>出度 d<sup>+</sup>(v)：从端点出发的边的数目</li><li>入度 d<sup>-</sup>(v) ：指向端点的边的数目</li><li>节点的度 d(v) = d<sup>+</sup>(v) + d<sup>-</sup>(v)</li></ul><hr><p><strong>度的性质</strong></p><ul><li><p>所有端点度的总和为偶数， 而且是边数目的两倍</p></li><li><p>有向图中， 出度 = 入度</p></li><li><p>奇数度节点必为偶数个(反证法)</p></li><li><p>自然数序列(a1, a2, …) 是某个图的度序列， 当且仅当序列中所有数的总和为偶数</p></li><li><p>只有一度的节点， 称为悬挂点</p></li></ul><hr><p><strong>正则图</strong></p><p>所有顶点的度，均相同的图，称为正则图。 按照顶点的度数 k ， 称作 k-正则图</p><p>Kn(节点为 n 的完全图) 是 n-1 正则图</p><hr><p><strong>子图</strong> subgraph</p><p>G1 = &lt;V1, E1&gt; , G2 = &lt;V2, E2&gt;</p><p>V1 $\subseteq$ V2 , E1 $\subseteq$ E2 , 则 G1 是 G2 的子图， 如果 G1 $\neq$ G2 ，则 G1 是 G2 的真子图。</p><p>生成子图： 通过添加若干条边，即可生成 G2， 则 G1 是 G2 的生成子图</p><p>互为补图： V1 = V2, E1 $\cap$ E2 = $\empty$ , &lt;V1, E1 $\cup$ E2 &gt; 是完全图， 则 E1, E2 互为补图</p><hr><p><strong>图的同构</strong></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200531170724.png-growing" alt="同构"></p><hr><h3 id="欧拉图和欧拉路径"><a href="#欧拉图和欧拉路径" class="headerlink" title="欧拉图和欧拉路径"></a>欧拉图和欧拉路径</h3><ul><li><p>欧拉图：</p><ul><li>图 G 上有一条经过所有顶点和所有边的闭路径(边不重复， 顶点允许重复)</li></ul></li><li><p>欧拉路径：</p><ul><li>图 G 上有一条经过所有顶点和所有边的路径(边不重复，允许顶点重复，不需要回到原地)</li></ul></li><li><p>欧拉图成立：</p><ul><li>无向图： G 连通， 所有顶点的度都是偶数</li><li>有向图： G 弱连通， 每个顶点的出度和入度相等</li></ul></li><li><p>欧拉路径：</p><ul><li>无向图： G 连通， 恰有两个顶点的度是奇数</li><li>有向图： G 连通， 恰有两个顶点的出度和入度不相等，其中一个出度比入度多 1， 另一个入度比出度多 1 </li></ul></li></ul><hr><h3 id="哈密顿图"><a href="#哈密顿图" class="headerlink" title="哈密顿图"></a>哈密顿图</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200531174230.png-growing" alt="哈密顿图"></p><hr><h3 id="邻接矩阵"><a href="#邻接矩阵" class="headerlink" title="邻接矩阵"></a>邻接矩阵</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200531174412.png-growing" alt="adjacency matrix"></p><ul><li>对角线元素为 1 ， 表示 环 的存在(自反关系)</li><li>矩阵对称， 表示双向边(对称关系)</li><li>顶点的度：<ul><li>出度， 对应行的和</li><li>入度， 对应列的和</li></ul></li><li>拟路径：<ul><li>邻接矩阵自乘 L 次： A<sup>L</sup> </li><li>则乘积结果矩阵中每个分量 a<sub>ij</sub><sup>(L)</sup> 的含义为 G 中顶点 V<sub>i</sub> 到 V <sub>j</sub> 的长度为 L 的拟路径条数</li></ul></li></ul><hr><p>关联矩阵</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200531175309.png-growing" alt="关联矩阵"></p><hr><h3 id="二分图"><a href="#二分图" class="headerlink" title="二分图"></a>二分图</h3><hr><h3 id="匈牙利算法"><a href="#匈牙利算法" class="headerlink" title="匈牙利算法"></a>匈牙利算法</h3><p>最大匹配</p><hr><p>平面图</p><hr><hr><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> math </category>
          
      </categories>
      
      
        <tags>
            
            <tag> discrete </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysql</title>
      <link href="/middlewares/mysql/"/>
      <url>/middlewares/mysql/</url>
      
        <content type="html"><![CDATA[<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><p>TODO</p><p><strong>索引分类</strong></p><p>按索引存储分类：</p><ol><li>聚簇索引： innodb， 索引和数据在一起</li><li>非聚簇：myisam ， 分开存储索引和数据</li></ol><p>按使用方式分类：</p><ol><li><p>主键索引：</p></li><li><p>唯一索引：</p></li><li><p>普通索引：</p></li><li><p>组合索引： 何时失效？</p><ol><li>like ‘%xxx’ , % 开头</li><li>中间某个值使用了范围查询</li><li>使用函数的时候</li><li>使用表达式 <code>where id + 1 = 4;</code> 不可以，  <code>where id = 3+1;</code> 可以</li><li>类型不匹配的时候， 涉及隐式转换</li><li>数据量特别大的时候</li><li>or 在某些情况下会失效</li></ol></li><li><p>全文索引：</p></li></ol><hr><pre class=" language-mysql"><code class="language-mysql">create table test(id bigint primary key, name varchar(10) unique, age int);</code></pre><ul><li><p>回表： 先去普通索引查一波， 得到主键， 然后回表查找数据</p></li><li><p>索引覆盖： 假设 name 为普通索引， 现在查找 id， name ， 则数据已经一次查到，不需要再回表，这种情况就叫索引覆盖， using index</p></li><li><p>最左匹配：</p></li><li><p>索引下推：通过 explain 查看执行计划时，  using index condition 表示使用了下推</p><ul><li>谓词下推：</li></ul></li></ul><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="D:%5Ctools%5Ctypora%5Cimages%5Cimage-20200516213116277.png" alt="image-20200516213116277"></p><p>MTS ， 主从复制延时</p><h3 id="引擎"><a href="#引擎" class="headerlink" title="引擎"></a>引擎</h3><h3 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h3><blockquote><p>B+ Tree</p></blockquote><hr><h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><blockquote><p>explain</p></blockquote><hr><p>=======</p><h2 id="MySQL-1"><a href="#MySQL-1" class="headerlink" title="MySQL"></a>MySQL</h2><h3 id="常用引擎"><a href="#常用引擎" class="headerlink" title="常用引擎"></a>常用引擎</h3><p>InnoDB， MyISAM，CSV，Memory 等 <code>show engines;</code></p><p>默认引擎： <code>show variables like '%storage_engien';</code></p><p>查看某张表使用的引擎： <code>show table status from database where name = "tablename";</code></p><hr><p><strong>MyISAM</strong></p><p>不支持事务， 不支持行级锁，支支持并发插入的表锁，可用于高负载的 select， 使用 B+ Tree</p><p><strong>InnoDB</strong></p><p>支持事务，回滚， 支持外键，支持行级锁， 使用 B+ Tree </p><hr><p>同一个 DB ，支持不同的 engine ，不同表可以使用不用的 engine 。可以根据表的特性，来指定不同的 engine 。</p><h3 id="索引-1"><a href="#索引-1" class="headerlink" title="索引"></a>索引</h3><p>B+ Tree， Hash， 全文索引等</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spring Start</title>
      <link href="/java/spring01/"/>
      <url>/java/spring01/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Spring version：5.2.6.RELEASE</p><p>Spring boot version：2.2.6.RELEASE</p></blockquote><hr><h2 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h2><ul><li>JDK Proxy 基于 interface ， 运行时动态代理</li><li>Cglib 基于 extends ， 运行时动态代理</li><li>AspectJ  ： 编译时增强</li></ul><h2 id="Bean-Scopes"><a href="#Bean-Scopes" class="headerlink" title="Bean Scopes"></a>Bean Scopes</h2><p>详细描述参考 <a href="https://docs.spring.io/spring/docs/5.2.6.RELEASE/spring-framework-reference/core.html#beans-factory-scopes" target="_blank" rel="noopener">这里</a></p><ul><li>singleton ： 单例， <strong>默认 scope</strong></li><li>prototype ： 原型模式，每次获取该对象时， 都会 clone 一个新的对象实例</li><li>request ： 一次请求一个实例对象</li><li>session ： 一次 session 会话</li><li>application ：bean 的作用域限定在 <code>ServletContext</code> 的生命周期</li><li>websocket ：bean 定义的作用域限定为 <code>WebSocket</code> 的生命周期</li><li><a href="https://docs.spring.io/spring-framework/docs/5.2.6.RELEASE/javadoc-api/org/springframework/context/support/SimpleThreadScope.html" target="_blank" rel="noopener">thread</a> ： 需要手动注册该 scope 才能使用</li></ul><p>通过 <code>@Scope(value = "xxx")</code> 或者 <code>@RequestScope</code> 等注解，可以指定 bean 的 scope</p><hr><h2 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a>MyBatis</h2><p><a href="https://www.jianshu.com/p/15781ec742f2" target="_blank" rel="noopener">https://www.jianshu.com/p/15781ec742f2</a></p><h2 id="MQ"><a href="#MQ" class="headerlink" title="MQ"></a>MQ</h2><h2 id="Dubbo"><a href="#Dubbo" class="headerlink" title="Dubbo"></a>Dubbo</h2><p><a href="http://dubbo.apache.org/zh-cn/docs/user/SUMMARY.html" target="_blank" rel="noopener">http://dubbo.apache.org/zh-cn/docs/user/SUMMARY.html</a></p><hr><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><h3 id="Spring-Docs"><a href="#Spring-Docs" class="headerlink" title="Spring Docs"></a><a href="https://docs.spring.io/spring/docs" target="_blank" rel="noopener">Spring Docs</a></h3><h3 id="Spring-boot-Docs"><a href="#Spring-boot-Docs" class="headerlink" title="Spring-boot Docs"></a><a href="https://docs.spring.io/spring-boot/docs/" target="_blank" rel="noopener">Spring-boot Docs</a></h3><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> languages </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> spring </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一趣二三句</title>
      <link href="/mine/sentence/"/>
      <url>/mine/sentence/</url>
      
        <content type="html"><![CDATA[<h2 style="font-family: &quot;Lucida Grande&quot;, &quot;Corbel&quot;, sans-serif;">2020. 03. 24 </h2><blockquote><p>所谓越界，就是到那里为止的意思。守住那界限，就是继续现在所熟悉的感觉。那意味着维持那里的世界、那里的规则和关系。那也代表着，如果不越界，就无法预见另一个世界的规则和关系。  </p><p align="right">---- 请回答 1988</p></blockquote><hr><h2 style="font-family: &quot;Lucida Grande&quot;, &quot;Corbel&quot;, sans-serif;">2020. 05. 05 </h2><blockquote><p>莫听穿林打叶声， 何妨吟啸且徐行。 竹杖芒鞋轻胜马， 谁怕？ 一蓑烟雨任平生。 料峭春风吹酒醒，微冷，山头斜照却相迎。回首向来萧瑟处，归去，也无风雨也无晴。 </p><p align="right"> ---- 定风波·莫听穿林打叶声 苏轼</p></blockquote><hr><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> mine </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mine </tag>
            
            <tag> sentence </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Thread 01</title>
      <link href="/java/thread1/"/>
      <url>/java/thread1/</url>
      
        <content type="html"><![CDATA[<blockquote><p>$ java -version<br>java version “13.0.2” 2020-01-14<br>Java(TM) SE Runtime Environment (build 13.0.2+8)<br>Java HotSpot(TM) 64-Bit Server VM (build 13.0.2+8, mixed mode, sharing)</p></blockquote><h2 id="上下文切换"><a href="#上下文切换" class="headerlink" title="上下文切换"></a>上下文切换</h2><p> CPU 通过时间片分配算法来循环执行任务， 一个时间片一般为几十毫秒，而时间片是用来给各个线程运行指令的时间。</p><p>当线程 A 消耗完时间片后， CPU 需要保存当前线程的状态，这样，当时间片再次分配给线程 A 时，可以知道它之前的执行状态。</p><p>这里，从保存到在加载的过程，就是一次上下文切换。</p><h2 id="CPU-屏障"><a href="#CPU-屏障" class="headerlink" title="CPU 屏障"></a>CPU 屏障</h2><ul><li><p>LoadLoad Barrier</p></li><li><p>LoadStore Barrier</p></li><li><p>StoreStore Barrier</p></li><li><p>StoreLoad Barrier</p></li></ul><p>load1 LoadLoad load2 表示， 保证 load1 指令先于 load2 指令</p><p>load1 LoadStore store1 表示， 保证 load1 指令先于 store1 的写入。 同时读写一个值时，保证读先于写</p><p>store1 StoreStore store2 表示， 保证 store1 写入且其他 cpu 可见， 先于 store2 指令。 同时写入一个值， 保证 store1 的写入先于 store2</p><p>store1 StoreLoad load1 表示， 保证 store1 写入且其他 cpu 可见，先于 load1 指令，即 load1 可以获取到最新的值。</p><h2 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h2><p>我们知道， java 中 <code>volatile</code> 关键字的作用有两个：</p><ul><li>多线程环境中，保证共享变量的可见性</li><li>禁止指令重排</li></ul><p>volatile 的可见性保证，是由 JMM 语义保证的， JMM 根据不同 CPU ，制定不同的插入屏障策略。</p><p>作为非底层开发者，我认为了解到， volatile 能通过各种 Barrier(或者叫做 Fence) ，来保证变量在多线程环境下的可见性就好了。</p><h2 id="synchronized"><a href="#synchronized" class="headerlink" title="synchronized"></a>synchronized</h2><p>在 HotSpot 虚拟机中， 一个对象包含</p><ul><li>对象头<ul><li>markword  4 字节</li><li>class 对象指针 4 字节</li><li>数组长度(如果是数组对象，非数组对象则无该值) 4字节</li></ul></li><li>实例数据</li><li>对其填充</li></ul><p>在 markword 中，又存储了如下信息：</p><ul><li>锁状态</li><li>hashcode</li><li>分代年龄</li><li>是否为偏向锁</li><li>锁标志位</li></ul><p>synchronized 在<strong>从未发生竞争</strong>时， 使用偏向锁。即同一个线程访问 synchronized 同步块时， 会在对象头和栈帧中的锁记录里存储偏向锁的线程 id ，之后该线程再次进入此同步块时，只要 markword 中存储了该线程 id ，就表示该线程获得了锁。</p><p>出现竞争后， 偏向锁就会膨胀成轻量级锁。轻量级锁通过 CAS + 自旋来获取锁 。</p><p>当自旋获取锁失败时，就会进一步膨胀成重量级锁。重量级锁会导致其他尝试获取锁的线程阻塞住。</p><h2 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h2><p>compare and swap 。</p><p>java 中的原子类型，都是通过 CAS 实现的原子操作。在 java 9 之后， 最终会调用到 <code>VarHandler</code> 。</p><p>假设我们对变量 a 进行 compareAndSwap(1,2) ，1 为 expected ， 2 为 new value 。</p><p>则 <code>VarHandler</code> 在访问 a 变量时，会保证对变量 a 的读 –&gt; 改 –&gt; 写 是一个原子操作，也就是说，在这个过程中，其他线程是无法对变量 a 做出更改的。</p><p>至于 <code>VarHandler</code> 是怎样保证这一过程的原子性的，主要是通过各型号 CPU 的指令集，进行总线锁定或者缓存锁定，禁止锁定期间，其他 CPU 的访问<sup> [1] </sup>。</p><p>CAS 的 ABA 问题指，线程 A 先将变量 a=0 写成 1， 后又写成 0 ， 那么对于线程 B 而言， 这个变量没有发生改变。这个问题可以通过引入版本号来解决。即 a0=0 -&gt; a1=1 -&gt; a2=0 ， 此时 a 的值虽然还是 0 ， 但版本已经从 0 变成了 2。</p><p>java 中，<code>AtomicStampedReference</code> 即为带版本号的实现</p><h2 id="Atomic-amp-ThreadLocal"><a href="#Atomic-amp-ThreadLocal" class="headerlink" title="Atomic &amp; ThreadLocal"></a>Atomic &amp; ThreadLocal</h2><p>Atomic 类的实现， 主要依赖于 CAS ，在 java 9 之前， CAS 最终调用 <code>Unsafe</code> ， 在 java 9 之后， 很多地方都改成使用 <code>VarHandler</code> <sup> [2] </sup> 如 <code>AtomicReference</code> 。</p><p>ThreadLocal 能够为线程提供一份单独的副本。</p><pre class=" language-java"><code class="language-java">var tmp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span>Integer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>tmp<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> tmp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> tmp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>此时， 两个线程都会输出 null 。</p><p>点进去看不难发现， ThreadLocal 的 set 操作， 会把值和当前线程绑定， 放入 一个 k=thread id , v=value 的 <code>ThreadLocalMap</code> 中 。而这个 map ， 则是由当前的 Thread 来维护的。整个的类图如下所示：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200504214148.png-growing" alt="Thread Local"></p><p>其中， Entry 里的 key 是 ThreadLocal 的弱引用。这意味着， 如果 ThreadLocal 没有任何强引用指向它，则该 key 会被 GC 掉。</p><p>也就是说，只要 Thread 结束，所谓的 ThreadLocal 内存泄露，就不会发生。但是有可能你的 Thread 是由 thread pool 维护的…</p><p>所以一般的建议是， 使用完 ThreadLocal 后，执行 <code>remove</code> ，手动释放那些 key 为 null 的 value 对象。</p><h2 id="Concurrent"><a href="#Concurrent" class="headerlink" title="Concurrent"></a>Concurrent</h2><h3 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h3><p>高版本 java (version &gt;= 8) 中， 通过 CAS + Synchronized 实现多线程安全。</p><p>在 <a href="https://buzhui.top/java/basic-datastructure/#Map">Map</a> 一文中，我们介绍过 HashMap 的一般结构，ConcurrentHashMap 的结构与其基本一致。</p><p>我们看下 <code>put</code> 和 <code>get</code> 两个方法的粗略实现。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">casTabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>当插入的数据， 在数组头时，直接通过 cas 进行插入</p><hr><pre class=" language-java"><code class="language-java"><span class="token keyword">synchronized</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">==</span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fh <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment" spellcheck="true">// 链表操作 ...</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token keyword">instanceof</span> <span class="token class-name">TreeBin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 红黑树操作 ...</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>如果插入的数据， 需要插入链表或者红黑树的时候， 则需要先用 <code>synchronized</code> 锁住头，再操作。</p><p>get 的时候：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> V <span class="token function">get</span><span class="token punctuation">(</span>Object key<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> tab<span class="token punctuation">;</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> e<span class="token punctuation">,</span> p<span class="token punctuation">;</span> <span class="token keyword">int</span> n<span class="token punctuation">,</span> eh<span class="token punctuation">;</span> K ek<span class="token punctuation">;</span>    <span class="token keyword">int</span> h <span class="token operator">=</span> <span class="token function">spread</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tab <span class="token operator">=</span> table<span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> tab<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>        <span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token function">tabAt</span><span class="token punctuation">(</span>tab<span class="token punctuation">,</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> h<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>eh <span class="token operator">=</span> e<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token operator">==</span> h<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>eh <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 红黑树查找</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">?</span> p<span class="token punctuation">.</span>val <span class="token operator">:</span> null<span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">=</span> e<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 链表查找</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>hash <span class="token operator">==</span> h <span class="token operator">&amp;&amp;</span>                <span class="token punctuation">(</span><span class="token punctuation">(</span>ek <span class="token operator">=</span> e<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> key <span class="token operator">||</span> <span class="token punctuation">(</span>ek <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>ek<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> e<span class="token punctuation">.</span>val<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> null<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>可以看到， get 操作全程无锁。这是因为它的 <code>table</code> 用 <code>volatile</code> 关键字修饰，这就保证了多线程下的可见性， 这也是和 <code>HashMap</code> 的区别之一。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">transient</span> <span class="token keyword">volatile</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span></code></pre><p>哦， 还有一个地方， 在 <code>table</code> 初始话的时候，有一个变量：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> sizeCtl<span class="token punctuation">;</span></code></pre><p>当需要对 table 初始化的时候， 需要先看 <code>sizeCtl</code> 的值：</p><ul><li>&lt; 0 ， 表示有其他线程正在初始化 table ，此时需要通过 CAS + DCL + 自旋来等待</li><li>&gt;= 0 ， 表示可以对 table 初始化</li></ul><h3 id="ConcurrentLinkedQueue"><a href="#ConcurrentLinkedQueue" class="headerlink" title="ConcurrentLinkedQueue"></a>ConcurrentLinkedQueue</h3><p>非阻塞式队列。</p><p>通过 <code>VarHandler</code> 的 CAS + 自旋实现。虽然代码只有几行，可是内容却很多… 具体分析可参考 <a href="https://juejin.im/post/5d4789ca51882519ac307a6f" target="_blank" rel="noopener">这篇文章</a></p><p>这里需要注意的一个点是， 它的 <code>tail</code> 节点，并不总是指向真正的尾节点。</p><h3 id="BlockingQueue"><a href="#BlockingQueue" class="headerlink" title="BlockingQueue"></a>BlockingQueue</h3><p>阻塞式队列</p><p>在 zk 中， 很多地方都用到了它的子类， 如选举时，通过 <code>LinkedBlockingQueue</code>  来接收选票，在处理客户端请求时， 整个的处理链流程，也是将 <code>Request</code> 放入到 <code>LinkedBlockingQueue</code> 中。其他的线程通过监听该队列，来处理不断添加进来的数据。</p><p>无论是 <code>ArrayBlockingQueue</code>  还是 <code>LinkedBlockingQueue</code> ， 其内部实现，都是通过 <code>ReentrantLock</code> 来实现的。</p><p>ArrayBlockingQueue 提供公平锁实现，有界，即大小固定，如果队列满后，仍尝试添加元素，则抛出 <code>Queue full</code> exception</p><p>LinkedBlockingQueue 不提供公平锁，可扩容，如果实例化时，没有提供 capacity，则默认容量为 <code>Integer.Max_Value</code> </p><h2 id="Thread-Pool"><a href="#Thread-Pool" class="headerlink" title="Thread Pool"></a>Thread Pool</h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200505181251.png-growing" alt="ThreadPool Class Flow"></p><p>使用 threadpool ， 有两个 task 类型可选：</p><ul><li>runnable ： void， 无返回值， 不能 throw 一个异常</li><li>callable ： 带返回值， 可 throw 异常</li></ul><p>事实上， 在真正提交给 Thread 的时候， callable 需要先包装成 <code>RunnableFuture</code> 的 task 。</p><pre class=" language-java"><code class="language-java"><span class="token function">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>                              <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>                              <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>                              TimeUnit unit<span class="token punctuation">,</span>                              BlockingQueue<span class="token operator">&lt;</span>Runnable<span class="token operator">></span> workQueue<span class="token punctuation">,</span>                              ThreadFactory threadFactory<span class="token punctuation">,</span>                              RejectedExecutionHandler handler<span class="token punctuation">)</span></code></pre><p>一个 <code>ThreadPoolExecutor</code> 完整的构造函数如上所示</p><ul><li>corePoolSize ：池中的线程数量，即使无 task ， 也不会被销毁。当然， 如果你设置 <code>allowCoreThreadTimeOut</code> 为 <code>true</code> ， 则会在 <code>keepAliveTime</code> 时间后被销毁</li><li>maximumPoolSize ：最大线程数，如果无 task ，则 在 <code>keepAliveTime</code> 时间后， 被销毁</li><li>keepAliveTime ：最大线程大于 core 线程时，如果无 task ，则 在 <code>keepAliveTime</code> 时间后， 被销毁 </li><li>unit ：keepAliveTime 的单位</li><li>workQueue ： 当 task 无线程处理时， 会先放到 queue 中。</li><li>threadFactory ：ThreadFactory 是一个 interface ， 你可以实现自己的 factory ，或者使用 defaultThreadFactory(实例化的时候， 该参数不填即使用默认 factory)</li><li>handler ：当 pool 负载时(线程和 queue 都满了) ，再添加 task 时的策略。 可以实现 <code>RejectedExecutionHandler</code> 接口来定制自己的策略， <code>ThreadPoolExecutor</code> 内置了四种策略 ：<ul><li>AbortPolicy ： 直接丢弃</li><li>CallerRunsPolicy ： 由执行 execute 方法的线程(一般为调用 submit 的线程) 执行</li><li>DiscardOldestPolicy ： 会丢弃 queue 中最老的线程</li><li>DiscardPolicy ： 会偷偷把你想加进来的 task 丢弃掉。静默丢弃</li></ul></li></ul><hr><h2 id="ForkJoin"><a href="#ForkJoin" class="headerlink" title="ForkJoin"></a>ForkJoin</h2><h2 id="Future-amp-CompeletableFuture"><a href="#Future-amp-CompeletableFuture" class="headerlink" title="Future &amp; CompeletableFuture"></a>Future &amp; CompeletableFuture</h2><h2 id="Kinds-of-Locks"><a href="#Kinds-of-Locks" class="headerlink" title="Kinds of Locks"></a>Kinds of Locks</h2><h2 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h2><p>TODO</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><p>[1] <a href="https://segmentfault.com/a/1190000014858404" target="_blank" rel="noopener">CAS-seg</a> &amp; <a href="https://zhuanlan.zhihu.com/p/34556594" target="_blank" rel="noopener">CAS-zhihu</a>  &amp; <a href="https://juejin.im/post/5a73cbbff265da4e807783f5" target="_blank" rel="noopener">CAS-juejin</a></p></li><li><p>[2] <a href="https://www.javagists.com/variable-handle-java9" target="_blank" rel="noopener">VarHandler</a>  ： 主要是为底层开发人员提供便利。在此之前， 可以通过 JNI + C 或者通过 Unsafe ，现在可以通过 VarHandler 来做一些底层开发。</p><blockquote><p>Developers of Java language initially created the <em>sun.misc.Unsafe</em> to use it internally in APIs of JVM. But many third party softwares like Hazelcast, JMock, Netty, Hibernate, Spring, etc started using it as it enabled them to do powerful low level operations. The Unsafe API did these operations with better performance than JNI. Critical internal APIs like <em>sun.misc.Unsafe</em> are still available but deprecated in Java 9. They may be eventually encapsulated or removed in Java 10. Therefore, it is a better idea for developers of such softwares to adopt VarHandle API early in their code as an alternative to sun.misc.Unsafe class.</p></blockquote></li><li><p>[3] <a href="https://zhuanlan.zhihu.com/p/58636499" target="_blank" rel="noopener">ThreadLocal</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/31422201" target="_blank" rel="noopener">Cache L1 L2 L3 究竟在哪里</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/55429568" target="_blank" rel="noopener">CPU 内存结构</a></p></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> languages </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> thread </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>用微信公众号给你的 Blog 鉴权</title>
      <link href="/tools/blog-nginx/"/>
      <url>/tools/blog-nginx/</url>
      
        <content type="html"><![CDATA[<h2 id="Basic-Auth"><a href="#Basic-Auth" class="headerlink" title="Basic Auth"></a>Basic Auth</h2><p>Nginx 的 basic auth ， 基于 <code>ngx_http_auth_basic_module</code> 模块。该模块是 builtin 模块，就是你安装 Nginx 的时候，它就一起装好了。</p><p>Basic Auth ，是一种简单的鉴权方式，不怎么安全。一般的 Basic Auth header 长这样：</p><pre><code>Authorization: Basic $(base64_encode(username:password))</code></pre><p>客户端通过对 username 和 password 进行 base64 加密， 放入 header 中。服务端获取 header 中的 Authorization ， 然后 decode 鉴权。</p><p>在 nginx 中，通过 <code>auth_basic</code> 和 <code>auth_basic_user_file</code> 进行配置，该语法支持的上下文有</p><pre><code>http, server, location, limit_except</code></pre><p>具体配置如下：</p><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">{</span>    <span class="token keyword">listen</span> <span class="token number">8088</span><span class="token punctuation">;</span>    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>        <span class="token keyword">auth_basic</span>           <span class="token string">"closed site"</span><span class="token punctuation">;</span>        <span class="token keyword">auth_basic_user_file</span> conf<span class="token operator">/</span>htpasswd<span class="token punctuation">;</span>        <span class="token keyword">root</span> <span class="token operator">/</span>xxx<span class="token operator">/</span>html<span class="token punctuation">;</span>        <span class="token keyword">index</span> <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">error_page</span> <span class="token number">404</span> <span class="token operator">/</span><span class="token number">404</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>    <span class="token keyword">access_log</span> logs<span class="token operator">/</span>blog<span class="token punctuation">.</span>access<span class="token punctuation">.</span>log<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>关于 <code>auth_basic</code> 后面的字符串，要看各大浏览器是不是给面子了。我用 chrome 就不会显示这个，用 edge 会显示。</p><p><code>auth_basic_user_file</code> 是用来存储账号密码的。官方支持使用 “HTTP Basic Authentication” 协议来验证用户名和密码。</p><p>emmm… </p><ul><li>支持通过 <code>crypt()</code> 方法加密： 通过 <code>htpasswd</code> 或者 <code>openssl passwd</code>命令</li><li>apache 基于 MD5 的 apr1 加密方式</li><li>基于 <a href="http://tools.ietf.org/html/rfc2307#section-5.3" target="_blank" rel="noopener">RFC 2307</a> 的实现</li></ul><p>现在我们通过 <code>htpasswd</code> 生成一个：</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 直接在控制带输出</span>htpasswd -nbd iyuhp admin<span class="token comment" spellcheck="true"># 输出到文本</span>htpasswd -bdc <span class="token function">passwd</span> iyuhp admin<span class="token comment" spellcheck="true"># 再次追加到文本</span>htpasswd -nbd iyuhp admin <span class="token operator">|</span> <span class="token function">tee</span> -a <span class="token function">passwd</span></code></pre><p>这个时候，优雅的重启一波 nginx： </p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> nginx -s reload</code></pre><p>然后访问一波， 发现已经会弹出一个用来登录的弹窗了。</p><p>如果通过命令行访问，可以直接通过 <code>username:password@url</code>访问：</p><pre class=" language-bash"><code class="language-bash">curl <span class="token string">'localhost:8088'</span> --header <span class="token string">'Authorization: Basic aXl1aHA6YWRtaW4='</span>// orcurl iyuhp:admin@localhost:8088</code></pre><hr><h2 id="Auth-Request"><a href="#Auth-Request" class="headerlink" title="Auth Request"></a>Auth Request</h2><p>可能我有一个后端程序，所以我完全可以把这些 “繁重” 的用户密码管理，交给后台就好了。</p><p>哦，我并不是说搞个程序来生成账号密码，然后写到 <code>auth_basic_user_file</code> 文件中。我的意思是，这个校验的工作，让我来吧，Nginx 你去搞别的去！</p><p>这样做的好处是， 我可以方便的管理我的账号体系(这里所谓的账号体系，是一个夸张的说法，你一个小小的 blog ，还账号体系…) </p><p>emmm… 不管怎样，这看起来是件有趣的事情。</p><p>Nginx 自是能考虑到这些，已然提供了一个语法 <code>auth_request</code> ， 意思是，你如果要访问这里，可以，得先通过我的验证才行。</p><pre class=" language-nginx"><code class="language-nginx">auth_request uri <span class="token operator">|</span> off<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># off 表示关闭上文的验证,就是我这里我说了算，上级不要说话了</span><span class="token comment" spellcheck="true"># 该语法支持的上下文为：</span><span class="token keyword">http</span><span class="token punctuation">,</span> <span class="token keyword">server</span><span class="token punctuation">,</span> <span class="token keyword">location</span></code></pre><p>那么我们要怎么搞呢？ 别急， 我先整张图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200502185350.png-growing" alt="image-20200502185336460"></p><ol><li><p>client 向 Nginx 请求资源， 因为配置了 <code>auth_request</code> ， Nginx 会先先 <code>/auth</code> 请求权限</p></li><li><p><code>/auth</code> 将请求转发给 <code>Backend</code> </p></li><li><p><code>Backend</code> 懵了， 你啥都没有，请求啥？ 麻溜的返回 <code>401</code> 。<strong>注意</strong> ， 这里必须返回 <code>401</code>  (403 应该也可以，没有试… )，返回之前， 需要添加 http header：</p><pre class=" language-go"><code class="language-go"><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"WWW-Authenticate"</span><span class="token punctuation">,</span> <span class="token string">"Basic realm=\"up to you\""</span><span class="token punctuation">)</span></code></pre></li><li><p>第四步， 第五步，第六步，则是将最终的结果反馈给 client。 client 收到 Basic Auth ， 弹出弹窗，让你填用户名密码。</p></li><li><p>于是 client 这次携带 basic auth 再次请求 Nginx ， 同样， 该请求最终被 Backend 处理。 Backend 一看，呦，原来是哥们啊， 得， 给你个 http code 200 吧。</p></li><li><p><code>location /auth</code> 一看， http code 200 ， 赶紧缓存起来。 <code>proxy_cache_valid 200 2h;</code> 的意思就是对 http code 为 200 的请求，缓存 2h 。</p></li><li><p><code>location /</code> 一看，行， 你小子通过 auth 验证了， 这次的资源请求就放行吧。</p></li></ol><p>通过上述步骤， 我们成功通过和 Backend 交互，并获得了指定资源的访问权。</p><p>关于 <code>auth_request</code> 的更多内容请看 <a href="http://nginx.org/en/docs/http/ngx_http_auth_request_module.html" target="_blank" rel="noopener">这里</a> 。 附上一份配置：</p><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>    auth_request        <span class="token operator">/</span><span class="token keyword">auth</span><span class="token punctuation">;</span>    <span class="token keyword">root</span>                <span class="token operator">/</span>xxx<span class="token operator">/</span>html<span class="token punctuation">}</span><span class="token keyword">location</span> <span class="token operator">/</span><span class="token keyword">auth</span> <span class="token punctuation">{</span>    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">1234</span><span class="token operator">/</span><span class="token keyword">auth</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 处理 auth 的后端 URL</span>    <span class="token comment" spellcheck="true"># 关闭不必要的数据传递</span>    <span class="token keyword">proxy_pass_request_body</span> off<span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> Content<span class="token operator">-</span>Length <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Original<span class="token operator">-</span>URI <span class="token variable">$request_uri</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># proxy cache 设置</span>    <span class="token keyword">proxy_cache</span> auth_cache<span class="token punctuation">;</span>    <span class="token keyword">proxy_cache_valid</span>   <span class="token number">200</span> 2h<span class="token punctuation">;</span>    <span class="token keyword">proxy_cache_key</span>     <span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token variable">$cookie_session</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>使用 <code>proxy_cache</code> 前，需要先定义下 <code>proxy_cache_path</code> , 该语法的上下文是 http ，也就说，你需要在 http 层先定义该值， 比如：</p><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">proxy_cache_path</span>    path    levels<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">2</span> keys_zone<span class="token operator">=</span>one<span class="token punctuation">:</span>10m<span class="token punctuation">;</span></code></pre><ul><li>path ： 指定 cache 缓存的位置</li><li>levels<sup>[1]</sup> ： 指定缓存的层级， 上面的配置可能最终长这样： path/a/bc/xxxbca </li><li>keys_zone ： 相当于这个 cache 的 alias ， 使用时， 就用这个名称。  10m 即缓存的大小。</li></ul><hr><h2 id="WeChat"><a href="#WeChat" class="headerlink" title="WeChat"></a>WeChat</h2><p>我现在又觉得， 搞啥账号体系，我一个小小的 blog ， 太耗时间了！</p><p>于是你想到了用验证码来搞好了。</p><p>那自然而然的想到了微信，想到利用公众号， 来搞个自动获取验证码呗。整个流程如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200502194440.png-growing" alt="Auth Flow"></p><ol><li>client 发起一个需要鉴权的资源请求</li><li>Nginx 通过 <code>auth_request</code> 配置，转发给 Server </li><li>Server 告诉 Nginx ， 需要重定向到 login 界面获取验证码，然后再提交</li><li>Nginx 告诉 client ，同时 client 展示 login 界面</li><li>client 通过扫码关注公众号，输入预设指令(如： yzm 等) ,获取验证码</li><li>微信把获取验证码的请求转发给 server ， server 生成并存储该验证码(设置验证码失效时间等)，同时发送给微信</li><li>client 获取验证码， 填写提交，server 验证通过， 告知 Nginx 放行</li></ol><p>下面再来看下更详细的流程图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200502201521.jpg-growing" alt="Auth-Wechat Flow"></p><p>这张图就很详细了，这里主要说几个注意的点：</p><ul><li><p>3 - 4 步， 这里，返回 401 后，需要在 Nginx 中定义 <code>error_page</code>：</p><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">error_page</span>    <span class="token number">401</span> <span class="token operator">=</span><span class="token number">200</span> <span class="token operator">/</span>login<span class="token punctuation">;</span><span class="token comment" spellcheck="true"># 所以也可以这么做， 返回 403</span><span class="token keyword">error_page</span>    <span class="token number">401</span><span class="token punctuation">,</span> <span class="token number">403</span> <span class="token operator">=</span><span class="token number">200</span> <span class="token operator">/</span>login<span class="token punctuation">;</span></code></pre><p>这样， 你返回 401 或者 403 http code 后， Nginx 就帮你重定向到了 <code>/login</code> </p></li><li><p>4 - 5 步，这里， 你需要把原始的 <code>URI</code> 交给 server 记录下来，用于登录成功后的跳转：</p><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span>login <span class="token punctuation">{</span>    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">1234</span><span class="token operator">/</span>login<span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Original<span class="token operator">-</span>URI <span class="token variable">$request_uri</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 原始的 URI 请求， 交由 server 记录</span><span class="token punctuation">}</span></code></pre></li><li><p>9 - 10 步， server 端需要记录下自己生成的 code ，之后验证 code 需要</p></li><li><p>12 - 14 步， 这里 client 请求的，其实是另一个 URI (如 POST /login)， 这个 URI 是可以公开访问，不需要鉴权的</p></li><li><p>15 步， 这里要注意， 鉴权成功后，要设置 header ，添加 <code>Location URI</code> ， 告诉浏览器要跳转。这里有个坑<sup> [2] </sup> ，返回的 http code 需要注意。</p></li><li><p>16 - 22 ， 事实上就是前面介绍的两个部分的内容，不再赘述</p></li></ul><p>贴下具体的配置：</p><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>    auth_request        <span class="token operator">/</span><span class="token keyword">auth</span><span class="token punctuation">;</span>    <span class="token keyword">error_page</span>          <span class="token number">401</span> <span class="token operator">=</span><span class="token number">200</span> <span class="token operator">/</span>login<span class="token punctuation">;</span>    <span class="token keyword">root</span>                <span class="token operator">/</span>xxx<span class="token operator">/</span>html<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">location</span> <span class="token operator">/</span><span class="token keyword">auth</span> <span class="token punctuation">{</span>    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">1234</span><span class="token operator">/</span><span class="token keyword">auth</span><span class="token punctuation">;</span>    <span class="token keyword">proxy_pass_request_body</span> off<span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> Content<span class="token operator">-</span>Length <span class="token string">""</span><span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Original<span class="token operator">-</span>URI <span class="token variable">$request_uri</span><span class="token punctuation">;</span>    <span class="token keyword">proxy_cache</span> auth_cache<span class="token punctuation">;</span>    <span class="token keyword">proxy_cache_valid</span>   <span class="token number">200</span> 2h<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># proxy key, 参见 reference [3]</span>    <span class="token keyword">proxy_cache_key</span>     <span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token variable">$cookie_session</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># 如果有 session 丢失的问题， 可以参考这条配置</span>    <span class="token comment" spellcheck="true"># proxy_cookie_path ~*^/.* /;</span><span class="token punctuation">}</span><span class="token keyword">location</span> <span class="token operator">/</span>login <span class="token punctuation">{</span>    <span class="token keyword">proxy_pass</span> <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">1234</span><span class="token operator">/</span>login<span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Original<span class="token operator">-</span>URI <span class="token variable">$request_uri</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="WeChat-对接"><a href="#WeChat-对接" class="headerlink" title="WeChat 对接"></a>WeChat 对接</h2><p>关于 <a href="http://mp.weixin.qq.com/debug/cgi-bin/sandbox?t=sandbox/login&amp;token=2029966350&amp;lang=zh_CN" target="_blank" rel="noopener">测试账号</a>  的东西，我也了解的不多，因为我只对接了一个 。</p><p>登录微信公众号后， [开发] - [基本配置] - [服务器配置] ，配置服务器地址、令牌、消息加解密密钥(optional) </p><ul><li>URL 需要是一个公网 ip 或者域名</li><li>Token 你可以随意填写，只要你 server 端验证的 Token 和此处填写一致， 就好了。</li></ul><p>提交时， 微信会先发一个验证请求，看看你的 server 是不是好的：</p><pre class=" language-http"><code class="language-http">GET /handle?signature=xxx&amp;echostr=123455&amp;timestamp=123456&amp;nonce=1234</code></pre><p>验证部分的文档， 在 <a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Access_Overview.html" target="_blank" rel="noopener">这里</a> 。主要步骤是：</p><ul><li>token， timestamp， nonce 字典排序并拼接成一个字符串</li><li>sha1 加密</li><li>与 signature 比较是否一致</li></ul><pre class=" language-go"><code class="language-go"># golang 部分代码ary <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">string</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">)</span>sort<span class="token punctuation">.</span><span class="token function">Strings</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span>encryptor <span class="token operator">:=</span> sha1<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span><span class="token function">WriteString</span><span class="token punctuation">(</span>encryptor<span class="token punctuation">,</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>ary<span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>mySignature <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%x"</span><span class="token punctuation">,</span>  encryptor<span class="token punctuation">.</span><span class="token function">Sum</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// compare</span></code></pre><p>文档说的是， 如果一致，就把 URI 中 <code>echostr</code> 原样返回。</p><p>嗯， 我返回了， 你特么说我验证失败， Token 有问题啥的？？？</p><p>为啥， 因为我返回了一个 string 类型的字符串！ F**k ， 这导致微信接收的时候， 在原值上多了一对双引号。</p><p>哎， 我最终返回了一个 int 类型的 <code>echostr</code> ，虽然我不知道这个 <code>echostr</code> 是不是会存在 <code>str</code> …</p><hr><p>这一步完成后， 当你通过公众号发送消息时， 微信就会把这个消息转发给你的 server 。它的格式如下：</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[toUser]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FromUserName</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[fromUser]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FromUserName</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>CreateTime</span><span class="token punctuation">></span></span>1348831860<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>CreateTime</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgType</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[text]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgType</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Content</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[this is a test]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Content</span><span class="token punctuation">></span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>MsgId</span><span class="token punctuation">></span></span>1234567890123456<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>MsgId</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">></span></span></code></pre><hr><p>微信端转发的请求，是通过 <strong>POST</strong> 方式提交请求的， 这点也需要注意下， like this ：</p><pre class=" language-http"><code class="language-http">POST /handle?signature=xxxx&amp;timestamp=xxxx&amp;nonce=xxxx&amp;openid=xxxx</code></pre><p>这就是在 server 端定义几个结构体，解析下就好了：</p><pre class=" language-go"><code class="language-go"><span class="token keyword">type</span> CdataString <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Value <span class="token builtin">string</span> <span class="token string">`xml:",cdata"`</span><span class="token punctuation">}</span><span class="token keyword">type</span> MsgXml <span class="token keyword">struct</span> <span class="token punctuation">{</span>    XMLName      xml<span class="token punctuation">.</span>Name    <span class="token string">`xml:"xml"`</span>    ToUserName   CdataString <span class="token string">`xml:"ToUserName"`</span>    FromUserName CdataString <span class="token string">`xml:"FromUserName"`</span>    CreateTime   <span class="token builtin">int64</span>       <span class="token string">`xml:"CreateTime"`</span>    MsgType      CdataString <span class="token string">`xml:"MsgType"`</span>    Content      CdataString <span class="token string">`xml:"Content"`</span>    MsgId        <span class="token builtin">int64</span>       <span class="token string">`xml:"MsgId,omitempty"`</span><span class="token punctuation">}</span></code></pre><p>需要注意三个点：</p><ul><li><p>你的 xml 的 root tag 需要是 <code>xml</code> </p></li><li><p>几乎所有的字段，都需要用 <code>cdata</code> 格式包裹</p></li><li><p>如果你在上面选择了对消息加密，则给你的数据包，可能是长这样的：</p><pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>xml</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ToUserName</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[toUser]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ToUserName</span><span class="token punctuation">></span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Encrypt</span><span class="token punctuation">></span></span><span class="token cdata">&lt;![CDATA[FBd5fNAKGq7+SifSbKzXTnTQrw1PnkgyHYodADiXhNVhIhJFe+thLeZvunLuO5jUdQnPfecbEtB5TqKPKocM4PRdKQjxNpd0B8Y1KXXsUn1IxIRUhYmSSWgMhqvr35cHVLW2Am10CbCk0WzUmbtp6vBCr41/UqLfoBZtVNBo/+MsgEfrrvrj4x8+TYe76pOXRnOpRrmbtTF6pdUysxAKyOPrg96Hdo2CBW1KRAd0jgA3ZoaUmsIAeAahr+H0PMGCSATdd/8W8BA7jmoZupd1FrJkiXACegfWe8o7aO9kjALowJtN6GpgzLmZqwLu5PPc0+UZQjxX/Ua3ADJmh54ZbiiODCNmD/pupEeoaR/kd+1o9dcQALw/DY7IJkzl3uv/PTU2/N/jQC1jqzkTmPbCkcB7ruVHe6k=]]></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Encrypt</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>xml</span><span class="token punctuation">></span></span></code></pre><p>你需要用你的 <code>EncodingAESKey</code> 先解密才行， <a href="https://developers.weixin.qq.com/doc/oplatform/Third-party_Platforms/Message_Encryption/Message_encryption_and_decryption.html" target="_blank" rel="noopener">这里</a> 是微信的文档， 不再详述。</p><hr><p>至此， 你就可以愉快的通过微信公众号，来玩转你的 blog 了。</p><p>是不是很有趣？ 可怜我在五一的美好假期里，熬了一个通宵搞这东西… <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">😂</span></p></li></ul><h2 id="我的架构"><a href="#我的架构" class="headerlink" title="我的架构"></a>我的架构</h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200504185933.png-growing" alt="My Structure"></p><h2 id="Referenct"><a href="#Referenct" class="headerlink" title="Referenct"></a>Referenct</h2><h3 id="1"><a href="#1" class="headerlink" title="[1]"></a>[1]</h3><p>请参考 <a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path" target="_blank" rel="noopener">proxy_cache_path </a></p><h3 id="2"><a href="#2" class="headerlink" title="[2]"></a>[2]</h3><p>请参考 <a href="https://www.cnblogs.com/wuguanglin/p/redirect.html" target="_blank" rel="noopener">这里</a></p><ul><li>301 ：http 1.0 ，永久移除， POST –&gt; GET</li><li>302 ： http 1.0 ，暂时移除， POST -&gt; POST (我用的 chrome 会如此)</li><li>303 ： see other ， POST -&gt; GET</li><li>307 ： 临时重定向， POST -&gt; POST</li><li>308 ： 永久重定向， POST -&gt; POST</li></ul><p>开始通过 POST /login 进行重定向时， 总是用 POST 方法调用 Location 的地址，导致 Method Not Allowed. 此时使用的 http code 是 307，后来用 302 ， 最后改为 303 搞定</p><h3 id="3"><a href="#3" class="headerlink" title="[3]"></a>[3]</h3><p>对于使用哪种变量作为 proxy_cache 的 key ，我想了很久。</p><p>最开始用一堆诸如 <code>$host$remote_addr$request_uri</code> ， 后来发现一个问题，对于同一个局域网下的用户， 只要 <code>$request_uri</code> 一致， 那这个 cache 就是公用的， 这明显不科学啊！</p><p>后来 google 了一把， 决定用 session 作为 <code>proxy_cache</code> 的 key 。这要求你在鉴权的时候，在 cookie 中写入你的 session，然后通过 <code>$cookie_session</code> 获取即可。</p><p>当然，你可以往 cookie 里写 anything else ，如 <code>wtf</code> ，然后你就可以用 <code>$cookie_wtf</code> 作为你的 proxy key 了， 完美。</p><p>所以， 这里的 <code>cookie_xxx</code> ， 值得是 client 的端 cookie 中的一个 key 。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> blog </tag>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java class loading</title>
      <link href="/java/jvm/"/>
      <url>/java/jvm/</url>
      
        <content type="html"><![CDATA[<h2 id="Java-的加载机制"><a href="#Java-的加载机制" class="headerlink" title="Java 的加载机制"></a>Java 的加载机制</h2><p>这里我先要说下类和对象。</p><p>java 中，可以将一组特征放到一个 class 里面，我们称之为类，是一个抽象概念。</p><p>而对象则是这个类的具象。</p><p>比如清华大学之于大学。</p><p>那我们说 java 的加载机制，事实上说的是类的加载机制。这个加载，<strong>只会加载一次</strong>。</p><p>如何加载，什么时候加载，请看后续。</p><hr><p>通常而言， java 的加载机制分为定义上的三步：</p><ul><li>加载</li><li>连接</li><li>初始化</li></ul><p>事实上的五步：</p><ul><li>加载</li><li>验证</li><li>准备</li><li>解析</li><li>初始化</li></ul><p>再加上 <strong>使用</strong> 和 <strong>卸载</strong>， 就是完整的类的生命周期了。</p><h3 id="加载"><a href="#加载" class="headerlink" title="加载"></a>加载</h3><p>通过 ClassLoader 将 <code>.class</code> 字节码文件，加载到内存中。</p><p>这里加载的类，不仅可以是本地的 class 文件，还可以是 zip 包， jar 包， 甚至网络地址上的文件。所以我们可以实现自己的 ClassLoader， 来处理不同 class 的加载。</p><p>比如，有时因为安全问题， 我们对一些 class 文件加密(毕竟反编译太简单) ，然后通过自定义的 ClassLoader 先解密，然后再加载到内存中。</p><p>在 java8 及之前， java 的加载类有</p><ul><li>BootstrapClassLoader ： 最顶层的加载器，负责加载 lib jar</li><li>ExtensionClassLoader ： 负责加载 ext jar</li><li>AppClassLoader ： 加载当前 classpath 下的 jar</li></ul><p>从 java9 开始，java 开始支持 modlue 的概念， 它的类加载器，也变成了：</p><ul><li>BootstrapClassLoader</li><li>PlatformClassLoader</li><li>AppClassLoader</li></ul><blockquote><p>双亲委派模型</p></blockquote><p>java 加载一个类时， 会首先把该请求， 委派给该类的加载器的父加载器，直到顶层加载器。然后自顶而下，直到有加载器能处理这个请求为止。如果该类已经加载过，则直接返回。</p><p>所以这里的<strong>双亲</strong>是个什么鬼？ 我也不知道了…</p><hr><h3 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h3><ul><li>文件格式校验： 字节码格式校验，是否符合 class 文件规范</li><li>元数据校验 ： 我理解为是对 java 语义的校验</li><li>字节码校验： 我理解为安全校验，即判断这个 class 文件是否会对 jvm 做出伤害行为</li></ul><hr><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>对类变量(static) 分配内存并作零值处理。</p><p>这里的零值，指类变量的类型的默认值， 如 int 默认值为 0 ， 对象默认值为 null 等</p><p>这里并不会去执行代码！</p><p>比如 <code>private static int a = 2</code> ， 此时并不会将 2 赋值给 a 。</p><p>但如果该类变量有 <code>final</code> 修饰，则会立即赋值。</p><p>TODO： 这里的内存分配，是分配到 java 的方法区，那么 jvm 的内存结构是怎样的？</p><hr><h3 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h3><p>解析是将符号引用替换为直接引用。</p><ul><li>符号引用： 通过一组符号来描述目标</li><li>直接引用： 可以直接执行目标的指针、相对偏移量、或者是一个能直接定位到目标的句柄</li></ul><p>TODO</p><hr><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><p>初始化阶段， 我们的 java 代码，才会被真正的执行。我们假设该类为 A，则：</p><ol><li>如果 A 的父类未初始化，则初始化父类</li><li>如果类中包含<strong>类变量赋值</strong>操作或者<strong>静态代码块</strong>，jvm 会首先生成一个叫做 <strong>类构造器方法</strong> 的东西。它其实就是把我们类里面所有的类变量和静态代码块放到了一起， 然后先跑一波。这意味着， 会先执行父类和子类的静态代码块。</li></ol><p><strong>什么时候会进行初始化？</strong></p><ul><li>new 关键字</li><li>反射</li><li>遇到 getstatic 、 putstatic 、 invokestatic 字节码。 这里的静态变量，需要是直接定义该变量的类。如果通过子类调用父类的静态变量，则只有父类会初始化，子类不会。<ul><li>读取类变量(未被 final 修饰，下同)</li><li>设置类变量</li><li>执行静态方法</li></ul></li><li>启动时，包含 main 方法的那个类会先初始化</li></ul><p>注意： <code>A[] a = new A[1];</code> 这种数组形式，并不会触发 A 的初始化</p><p><strong>JVM 保证：</strong>  java 在进行类初始化的时候，会上锁，从而保证线程安全。</p><hr><h3 id="Singleton"><a href="#Singleton" class="headerlink" title="Singleton"></a>Singleton</h3><p>java 中的 singleton ，有多种实现方式。我们现在介绍几种：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">Hungry</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> Hungry instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Hungry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">Hungry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> Hungry <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>按照上面所说的加载机制， 当我们调用 <code>getInstance</code> 静态方法时， 如果该类还没有初始化，则会首先初始化。</p><p>类中有静态变量，所以会首先执行类构造器方法， 进而执行 <code>new Hungry()</code> ，于是 instance 被实例化。</p><p>整个过程， 由于 java 类加载机制(加载一次 + 线程锁)，从而保证了单例的实现。</p><hr><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">DCLFull</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> DCLFull instance<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token function">DCLFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> DCLFull <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>DCLFull<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DCLFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>double-check 实现的饱汉模式(即传说中的 DCK ， Double-Check-Lock)。</p><p>第一个 <code>if</code> 用来保证无竞争时，不用锁。</p><p>第二个 <code>if</code> 用来保证，当 A 、 B 同时进入到第一个 <code>if</code> 后， A 等待， B 获取锁且完成实例化释放锁后， A 再次进入， 不会再次创建一个新对象。</p><p><code>instance</code>  定义中的 <code>volatile</code> 修饰符： 该修饰符的作用有多线程间数据的可见性， 和禁止指令重排。volatile 在这里用来防止指令重排。<br> java 中， new 操作，可以分为三步：</p><ul><li>memory=allocate(); //1：分配内存空间</li><li>ctorInstance();   //2:初始化对象</li><li>singleton=memory; //3:设置singleton指向刚排序的内存空间</li></ul><p>jvm 对于不会变更结果的指令，会重排优化， 所以这里的顺序，可能是 1 -&gt; 2 -&gt; 3 , 也可能是 1 -&gt; 3 -&gt; 2 。</p><p>对于后者， 假设线程 A 运行到最后一步之前， cpu 被线程 B 抢占，则 B 会获取到一个非 null 的但未完成初始化的对象，这就可能会发生异常。</p><p>这里通过 <code>volatile</code> 来避免这种情况 。</p><hr><pre class=" language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">StaticFull</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token function">StaticFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InnerStaticFull</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">static</span> StaticFull instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StaticFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> StaticFull <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> InnerStaticFull<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>通过 java 类加载机制保证的饱汉模式的单例实现。</p><p>加载 <code>StaticFull</code> 类时， 静态内部类并不会被加载，只有在调用 <code>getInstance</code> 时， 静态内部类才会被加载，instance 才会被实例化。</p><hr><pre class=" language-java"><code class="language-java"><span class="token keyword">enum</span> EnumSingleton <span class="token punctuation">{</span>    INSTANCE<span class="token punctuation">,</span>    <span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"enum"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>通过 <code>enum</code> 来实现。可以保证单例，同时能保证反射、序列化/反序列化安全</p><hr><h2 id="Java-内存模型"><a href="#Java-内存模型" class="headerlink" title="Java 内存模型"></a>Java 内存模型</h2><h3 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200430010948.png-growing" alt="Java 内存模型"></p><p><strong>Heap</strong></p><p>Java 中几乎所有对象都在堆中分配。该内存空间会被所有线程共享</p><blockquote><p>Java世界中“几乎”所有的对象都在堆中分配，但是，随着JIT编译期的发展与逃逸分析技术逐渐成熟，栈上分配、标量替换优化技术将会导致一些微妙的变化，所有的对象都分配到堆上也渐渐变得不那么“绝对”了。从jdk 1.7 开始已经默认开启逃逸分析，如果某些方法中的对象引用没有被返回或者未被外面使用（也就是未逃逸出去），那么对象可以直接在栈上分配内存。</p><p>– 摘自 java guide [1]</p></blockquote><p>其中 java heap 被分为 Eden ， Servivor0 (S0)， Servivor (S1) 以及 Old Gen 。其中 Eden + S0 + S1 又被称为 <strong>新生代</strong>， Old Gen 被称为 <strong>老年代</strong> 。</p><p>当我们创建对象时， 正常情况下会首先进入 Eden 区，但是大对象会直接进入 Old Gen 。</p><p>对象在 Eden 出生后， 经历一次 Minor GC 仍然存活的话，就会被移到 S0 或者 S1， 同时年龄设为 1。当年龄达到一定值，就会被移动到 Old Gen 。</p><blockquote><p>“Hotspot遍历所有对象时，按照年龄从小到大对其所占用的大小进行累积，当累积的某个年龄大小超过了survivor区的一半时，取这个年龄和MaxTenuringThreshold中更小的一个值，作为新的晋升年龄阈值”。</p><p>– 摘自 java guide [1]</p></blockquote><hr><p><strong>VM 栈</strong></p><p>线程私有， 由一个个栈帧组成， 每个栈帧都包含：</p><ul><li>局部变量表：八大原始类型， 对象引用， returnAddress</li><li>操作数栈</li><li>动态链接</li><li>方法出口信息</li></ul><hr><p><strong>本地方法栈</strong></p><p>与 VM 栈类似， 用来服务于 native 方法。而 java 中的 native 方法多为 c 语言编写，因此这个栈用被成为 C 栈</p><hr><p><strong>程序计数器</strong></p><p>用来记录当前线程所执行的字节码的位置。</p><ul><li>通过更改程序计数器， 读取下一条指令</li><li>当线程被抢占 CPU ，恢复后， 通过程序计数器，获取上次执行的位置，并继续执行下一条指令</li></ul><hr><p><strong>元空间</strong></p><p>图中“元数据”为笔误，应该是元空间。</p><p>元空间使用的内存，与 Heap 内存不再连续，直接使用本地内存。方法区被放入到元空间。</p><p>可通过 <code>MaxMetaspaceSize</code> 设置大小</p><hr><p><strong>方法区</strong></p><p>用来存储 java 类信息， 运行时常量池等</p><h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200430020504.png-growing" alt="img"></p><p>Minor GC / Major GC / Full GC 参见 <a href="https://www.zhihu.com/question/41922036" target="_blank" rel="noopener">这里</a> 。</p><p>暂时搞不懂这些了。。。</p><p>下面的内容来自<a href="https://juejin.im/post/5b8d2a5551882542ba1ddcf8" target="_blank" rel="noopener">这里</a> </p><blockquote><p>当 Eden 区的空间耗尽了怎么办？这个时候 Java虚拟机便会触发一次 <strong>Minor GC</strong>来收集新生代的垃圾，存活下来的对象，则会被送到 Survivor区。</p><p>当发生 Minor GC时，Eden 区和 from 指向的 Survivor 区中的存活对象会被复制(此处采用标记 - 复制算法)到 to 指向的 Survivor区中，然后<strong>交换 from 和 to指针，以保证下一次 Minor GC时，to 指向的 Survivor区还是空的</strong>。</p></blockquote><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><p>[1] <a href="https://github.com/Snailclimb/JavaGuide/blob/master/docs/java/jvm/Java%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F.md" target="_blank" rel="noopener">Java Guide</a></p></li><li><p><a href="https://www.infoq.cn/article/3WyReTKqrHIvtw4frmr3" target="_blank" rel="noopener">InfoQ</a></p></li><li><p><a href="https://github.com/doocs/jvm/blob/master/docs/02-hotspot-jvm-object.md" target="_blank" rel="noopener">JVM</a></p></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> languages </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sorts</title>
      <link href="/algorithm/sorts/"/>
      <url>/algorithm/sorts/</url>
      
        <content type="html"><![CDATA[<h1 id="Sorts"><a href="#Sorts" class="headerlink" title="Sorts"></a>Sorts</h1><p>本文主要介绍几种常见的排序算法，以及 Bloom 过滤器。</p><h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><p>在正式介绍排序之前，先说下排序中的几个名词：</p><ul><li>稳定 ： 我们常说，这个排序算法是稳定的，那个是不稳定的，这里的稳定，是指，两个相同大小的元素 a，b ，在排序前后，他们的相对位置未发生变化。我们假设 a<sub>i</sub> = b<sub>j</sub> ， 其中 i &lt; j， 在排序后，变成了 a<sub>m</sub> , b<sub>n</sub> ，此时仍有 m &lt; n ,则我们说该排序算法是稳定的。</li><li>内排序：所有的排序过程，都是在内存中完成</li><li>外排序：排序过程需要通过磁盘和内存一起完成</li></ul><h3 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h3><p>Bubble Sort 。顾名思义，就是通过一遍遍的比较，逐步将未排序元素集合中的最大值，移动到集合的最末尾。整个排序过程，就如同小鱼吐泡泡一样，一个一个往上飘。</p><p>double for ， 第一层 for 用来记录已经排序的元素个数，第二层 for 用来做未排序元素集合中，两两相邻元素的比较</p><p>O(n<sup>2</sup>)， 代码实现：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bubbleSort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    var confusion <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> confusion<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> confusion<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">-</span> i<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>confusion<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">></span> confusion<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                var tmp <span class="token operator">=</span> confusion<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>                confusion<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> confusion<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                confusion<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 两个数的交换， 还可以这样写</span>                <span class="token comment" spellcheck="true">// confusion[j] ^= confusion[j + 1];</span>                <span class="token comment" spellcheck="true">// confusion[j + 1] ^= confusion[j];</span>                <span class="token comment" spellcheck="true">// confusion[j] ^= confusion[j + 1];</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Bubble Sort:"</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>confusion<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="选择排序"><a href="#选择排序" class="headerlink" title="选择排序"></a>选择排序</h3><p>依次遍历，每次选出未排序集合中最小或者最大的元素，放到已排序集合中。</p><p>double for ， 第一层 for 用来记录已排序的元素个数，第二层 for 用来挑选未排序集合中最小或最大元素，和已排序集合中的最末尾位置比较，如果小/大， 则交换。即不断找出未排序集合中最小(最大值)。</p><p>O(n<sup>2</sup>) ， 代码实现：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">selectionSort</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ary<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> length <span class="token operator">=</span> ary<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> min <span class="token operator">=</span> i<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> length <span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ary<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> ary<span class="token punctuation">[</span>min<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                min <span class="token operator">=</span> j<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ary<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">></span> ary<span class="token punctuation">[</span>min<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">swap</span><span class="token punctuation">(</span>ary<span class="token punctuation">,</span> i<span class="token punctuation">,</span> min<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Selection Sort:"</span> <span class="token operator">+</span> Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="插入排序"><a href="#插入排序" class="headerlink" title="插入排序"></a>插入排序</h3><p>依次遍历， 每次选择一个未排序集合中的数， 往前插入到已排序集合中的合适位置。</p><p>与选择排序相似，不同的是， 选择排序，是选择最小的数往前插， 这样可以保证已排序的元素集合，在整个集合里，是正确有序的。而插入排序是选择一个数，往前插入到合适位置，已排序集合在整个集合里，是相对有序的。</p><p>double for ， 第一层 for 用来记录已排序元素个数，第二层 for 用来挑选后一个元素，并插入到已排序元素集合的合适位置。</p><p>O(n<sup>2</sup>) ，代码实现：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">insertionSort2</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ary<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> pre<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 记录前一个数据</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ary<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        var tmp <span class="token operator">=</span> ary<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span>pre <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> pre <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>tmp <span class="token operator">&lt;</span> ary<span class="token punctuation">[</span>pre <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> pre<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment" spellcheck="true">// 整体后移一位</span>            ary<span class="token punctuation">[</span>pre<span class="token punctuation">]</span> <span class="token operator">=</span> ary<span class="token punctuation">[</span>pre <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        ary<span class="token punctuation">[</span>pre<span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>ary<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="归并排序"><a href="#归并排序" class="headerlink" title="归并排序"></a>归并排序</h3><p>O(NlogN) 。</p><p>通过对左右两边不断分治、毕竟，直到有序(此时左右各只有一个元素)，然后进行合并。</p><p>归并的核心思想是先分后合。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doMergeSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ary<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tmp<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>left <span class="token operator">&lt;</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>        var center <span class="token operator">=</span> <span class="token punctuation">(</span>left <span class="token operator">+</span> right<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>        <span class="token function">doMergeSort</span><span class="token punctuation">(</span>ary<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> left<span class="token punctuation">,</span> center<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">doMergeSort</span><span class="token punctuation">(</span>ary<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> center <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">doMerge</span><span class="token punctuation">(</span>ary<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> left<span class="token punctuation">,</span> center <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doMerge</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ary<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> tgt<span class="token punctuation">,</span> <span class="token keyword">int</span> leftPos<span class="token punctuation">,</span> <span class="token keyword">int</span> rightPos<span class="token punctuation">,</span> <span class="token keyword">int</span> rightEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>    var leftEnd <span class="token operator">=</span> rightPos <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>    var tmpPos <span class="token operator">=</span> leftPos<span class="token punctuation">;</span>    var numE <span class="token operator">=</span> rightEnd <span class="token operator">-</span> leftPos <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>leftPos <span class="token operator">&lt;=</span> leftEnd <span class="token operator">&amp;&amp;</span> rightPos <span class="token operator">&lt;=</span> rightEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ary<span class="token punctuation">[</span>leftPos<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> ary<span class="token punctuation">[</span>rightPos<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            tgt<span class="token punctuation">[</span>tmpPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> ary<span class="token punctuation">[</span>leftPos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            tgt<span class="token punctuation">[</span>tmpPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> ary<span class="token punctuation">[</span>rightPos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>leftPos <span class="token operator">&lt;=</span> leftEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>        tgt<span class="token punctuation">[</span>tmpPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> ary<span class="token punctuation">[</span>leftPos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>rightPos <span class="token operator">&lt;=</span> rightEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>        tgt<span class="token punctuation">[</span>tmpPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> ary<span class="token punctuation">[</span>rightPos<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 回填， 因为上面合并后的数据都在 tgt 中</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>var i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> rightEnd<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ary<span class="token punctuation">[</span>rightEnd<span class="token punctuation">]</span> <span class="token operator">=</span> tgt<span class="token punctuation">[</span>rightEnd<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h3><p>快速排序在实际项目中是用的比较多的， java 中 <code>Arrays.sort</code> 方法里，使用的就是经过优化的变种快速排序。</p><p>在排序元素较少的情况下，快速排序的表现不如插入排序， java 在排序的时候，会首先判断元素的个数，当元素少于 <code>INSERTION_SORT_THRESHOLD</code> (47) 时， 会使用插入排序，至于为何是这个数字，我也不知道了。。。</p><p>如果在 <code>QUICKSORT_THRESHOLD</code> (286)  内，则使用快速排序，超过这个长度，会首先判断待排序集合是否是部分有序，是则使用快速排序，否则使用归并排序。</p><p>可见，真正在项目中，即使是排序，也有太多的讲究。</p><p>回到快速排序。快速排序的核心思想是分治。通过不断的替换基准( pivot )，来切割集合，使左边元素小于基准，右边元素大于基准，最终达到整体有序。</p><p>一种实现思路是，选择一个基准。基准选择有很多学问，java 中的快排，采用五基数 + 三路快排实现的，一般可以尝试使用中值作为基准，即获取集合首尾以及中间值，取居中的数值作为基准。</p><p>然后分别从左右往中间递进，左边 idx = i 遇到 &gt; pivot 停下，右边 idx = j 遇到 &lt; pivot 停下，交换两个数的位置，直到 i &gt;= j 停下。</p><p>一遍下来后，i 左边元素都小于 pivot ， i 右边元素都大于 pivot 。</p><p>交换 ary[i] 和 pivot 的位置。</p><p>分别对 [0, i-1] 和 [i+1, array.length] 递归上述步骤，直到 left &gt;= right 。</p><p>以下是具体实现：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doQuickSort</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ary<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span> <span class="token punctuation">{</span>    var low <span class="token operator">=</span> left<span class="token punctuation">;</span>    var high <span class="token operator">=</span> right<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">>=</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    var pivot <span class="token operator">=</span> ary<span class="token punctuation">[</span>right<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>ary<span class="token punctuation">[</span>low<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> pivot <span class="token operator">&amp;&amp;</span> low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>            low<span class="token operator">++</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>ary<span class="token punctuation">[</span>high<span class="token punctuation">]</span> <span class="token operator">>=</span> pivot <span class="token operator">&amp;&amp;</span> low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>            high<span class="token operator">--</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">swap</span><span class="token punctuation">(</span>ary<span class="token punctuation">,</span> low<span class="token punctuation">,</span> high<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// swap</span>    ary<span class="token punctuation">[</span>right<span class="token punctuation">]</span> <span class="token operator">=</span> ary<span class="token punctuation">[</span>low<span class="token punctuation">]</span><span class="token punctuation">;</span>    ary<span class="token punctuation">[</span>low<span class="token punctuation">]</span> <span class="token operator">=</span> pivot<span class="token punctuation">;</span>    <span class="token function">doQuickSort</span><span class="token punctuation">(</span>ary<span class="token punctuation">,</span> left<span class="token punctuation">,</span> low <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">doQuickSort</span><span class="token punctuation">(</span>ary<span class="token punctuation">,</span> low <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> right<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h2 id="Bloom-Filter"><a href="#Bloom-Filter" class="headerlink" title="Bloom Filter"></a>Bloom Filter</h2><p><a href="https://zh.wikipedia.org/wiki/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8" target="_blank" rel="noopener">布隆过滤器</a>，常用来做一些大数据量的非精确性的过滤处理。如海量黑名单检查，垃圾邮件过滤等。</p><p>布隆过滤器的本质，是利用 hash ，将一个 key ，通过一组(设为 n) hash func ，映射到 n 个 bit 位。</p><p>bloom filter 初始化时，会开辟一块内存空间，将其中的 bit 位置为 0 ，我们插入元素时， 会通过一组 hash 函数，计算得到 n 个 bit 地址，将其置为 1。</p><p>查询时，通过一组 hash 计算 key ，查看各个 bit 位是否为 1， 如果都为 1， 则表示存在，否则不存在。</p><p>我们直到，hash 存在 hash 碰撞，这表示，即使查出某个 key 的 bit 位都为 1， 我们也不能说该 key 一定存在，因为可能某个 bit 位，是因为 hash 碰撞，被另一个 key 设为了 1。</p><p>当然，这个概率是很小的。</p><p>也只有在我们能接收这样的误判时，我们才能够使用 bloom filter。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200428051424.png-growing" alt="Bloom Filter"></p><p>代码部分是 <code>guava</code> 的 bloom filter 实现：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">PersonFunnel</span> <span class="token keyword">implements</span> <span class="token class-name">Funnel</span><span class="token operator">&lt;</span>Person<span class="token operator">></span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">funnel</span><span class="token punctuation">(</span>Person from<span class="token punctuation">,</span> PrimitiveSink into<span class="token punctuation">)</span> <span class="token punctuation">{</span>        into<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>from<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Charset<span class="token punctuation">.</span><span class="token function">defaultCharset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>from<span class="token punctuation">.</span><span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bloomFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 大约插入的元素个数 10， 以及误判率 0.01 (根据给定数据，计算需要开辟的空间大小)</span>    var bloomFilter <span class="token operator">=</span> BloomFilter<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PersonFunnel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    var exist1 <span class="token operator">=</span> bloomFilter<span class="token punctuation">.</span><span class="token function">mightContain</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"dylan"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    bloomFilter<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"dylan"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    var exist2 <span class="token operator">=</span> bloomFilter<span class="token punctuation">.</span><span class="token function">mightContain</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">"dylan"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"first:"</span> <span class="token operator">+</span> exist1 <span class="token operator">+</span> <span class="token string">", then: "</span> <span class="token operator">+</span> exist2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// false  true</span><span class="token punctuation">}</span></code></pre><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://juejin.im/post/5b95da8a5188255c775d8124" target="_blank" rel="noopener">基础排序算法–动画演示</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> sorts </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tree Algorithm</title>
      <link href="/algorithm/tree/"/>
      <url>/algorithm/tree/</url>
      
        <content type="html"><![CDATA[<h1 id="Tree"><a href="#Tree" class="headerlink" title="Tree"></a>Tree</h1><ul><li>根节点 ， root</li><li>子节点</li><li>叶子节点，没有子节点的节点，即度为零的节点</li><li>兄弟节点：有相同父节点的子节点，即为兄弟节点，siblings</li><li>祖先节点，该节点到根节点路径上的所有节点，都是该节点的祖先节点</li><li>度， 节点的子节点个数</li><li>层 ， 根节点为第一层，其余节点为其父节点的层次 + 1</li><li>深度， 根的深度为零， 其余节点深度为该节点到根节点的唯一路径长</li><li>高度， 叶子节点高度为零，其余节点，为该节点到叶子节点的最长路径</li><li>树的深度 = 树的高度</li></ul><p>ps： 关于深度， 这里按照 <a href="https://en.wikipedia.org/wiki/Binary_tree" target="_blank" rel="noopener">WIKI EN</a> 的定义说明</p><h2 id="BT"><a href="#BT" class="headerlink" title="BT"></a>BT</h2><p>binary tree ， 二叉树</p><ul><li>第 n 层节点最大为 2<sup>n-1</sup> ，root 为第一层，最大为 2<sup>1-1</sup> = 1</li><li>深度为 k 的二叉树，最多有 2<sup>k+1</sup> - 1 个节点 <sup>[注1]</sup>  </li></ul><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200423233807.png-growing" alt="示例图"></p><p>Node 节点基本结构：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> BTreeNode <span class="token punctuation">{</span>    <span class="token keyword">private</span> BTreeNode left<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 左节点</span>    <span class="token keyword">private</span> BTreeNode right<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 右节点</span>    <span class="token keyword">private</span> Object value<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 值</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">hasLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> null <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>left<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">hasRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> null <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>right<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="深度优先"><a href="#深度优先" class="headerlink" title="深度优先"></a>深度优先</h3><p>DFS , Deep First Search</p><p>从根节点开始，优先搜索子节点，然后搜索同一层节点</p><blockquote><p>前序遍历</p></blockquote><p>preOrder traversal ， 又称为先序遍历。处理方式是，从左到右，<strong>先处理自己</strong>，再处理左子节点，最后处理右子节点</p><p>则对照上图，我们得出的遍历顺序为： 1 -&gt; 2 -&gt; 3 -&gt; 4 -&gt; 5 -&gt; 6</p><p>代码实现思路：</p><p>打印当前值(先处理自己) -&gt; 打印左节点(递归) -&gt; 打印右节点(递归)</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 递归</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">preOrder</span><span class="token punctuation">(</span><span class="token keyword">final</span> BTreeNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">hasLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">preOrder</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">hasRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">preOrder</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 非递归 利用 stack</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">preOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    var ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    var cur <span class="token operator">=</span> root<span class="token punctuation">;</span>    var stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span>BTreeNode<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cur <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        ret<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><hr><blockquote><p>中序遍历</p></blockquote><p>inOrder traversal ,  处理方式是，从左往右，先处理左子节点，<strong>自己在中间处理</strong> ， 最后处理右子节点</p><p>对照上图， 得出的遍历顺序 ： 3 -&gt; 2 -&gt; 4 -&gt; 1 -&gt; 5 -&gt; 6</p><p>代码实现思路：</p><p>打印左节点(递归) -&gt; 打印自己 -&gt; 打印右节点(递归)</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 递归</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">inOrder</span><span class="token punctuation">(</span><span class="token keyword">final</span> BTreeNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">hasLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">inOrder</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">hasRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">inOrder</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 非递归， 利用 stack</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">inPrint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    var cur <span class="token operator">=</span> root<span class="token punctuation">;</span>    var stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span>BTreeNode<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">do</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 压入左节点</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>            cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>left<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            var tmp <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>value<span class="token punctuation">.</span>toString<span class="token punctuation">)</span>            cur <span class="token operator">=</span> tmp<span class="token punctuation">.</span>right<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> Objects<span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>发现没有， 和前序遍历的实现相比，只是改了下代码的位置</p><hr><blockquote><p>后序遍历</p></blockquote><p>prostOrder traversal，处理方式是，从左往右， 先处理左子节点，再处理右子节点，<strong>最后处理自己</strong></p><p>遍历顺序 ： 3 -&gt; 4 -&gt; 2 -&gt; 6 -&gt; 5 -&gt; 1</p><p>代码实现思路：</p><p>打印左节点(递归) -&gt; 打印右节点(递归) -&gt; 打印自己</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">postOrder</span><span class="token punctuation">(</span><span class="token keyword">final</span> BTreeNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>Objects<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">hasLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">postOrder</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token function">hasRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">postOrder</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    var cur <span class="token operator">=</span> root<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 记录处理的子节点 ， 用来验证节点的右子节点是否被处理过</span>    BTreeNode pre <span class="token operator">=</span> null<span class="token punctuation">;</span>    var stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token operator">&lt;</span>BSTreeNode<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>stack<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>cur<span class="token punctuation">.</span><span class="token function">hasLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            cur <span class="token operator">=</span> cur<span class="token punctuation">.</span>left<span class="token punctuation">;</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里先不拿出来， 如果该节点有右子节点，则优先处理右子节点</span>        var tmp <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">.</span><span class="token function">hasRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> tmp<span class="token punctuation">.</span>right <span class="token operator">!=</span> pre<span class="token punctuation">)</span> <span class="token punctuation">{</span>            cur <span class="token operator">=</span> tmp<span class="token punctuation">.</span>right<span class="token punctuation">;</span>            stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>cur<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            pre <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            ret<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pre<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>同样，实现方式和上面的两种遍历方式相比，只是变更了顺序。</p><p><strong>可以看到，所谓的前中后序遍历，就是看什么时候处理自己，先处理自己就是前序，中间处理就是中序，最后处理就是后序。</strong></p><h3 id="广度优先"><a href="#广度优先" class="headerlink" title="广度优先"></a>广度优先</h3><p>BFS ，Breath First Search</p><p>从根节点开始，优先搜索同一层节点，然后搜索子节点</p><p>参照上图，我们得出的遍历顺序是： 1 -&gt; 2 -&gt; 5 -&gt; 3 -&gt; 4 -&gt; 6</p><p>代码实现思路(借助队列)：</p><p>将每层依次塞入队列的尾部，依次从队头取出数据读取</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 递归</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">bfs</span><span class="token punctuation">(</span><span class="token keyword">final</span> BTreeNode root<span class="token punctuation">)</span> <span class="token punctuation">{</span>    var q <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token operator">&lt;</span>BTreeNode<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    BTreeNode node <span class="token operator">=</span> root<span class="token punctuation">;</span>    <span class="token keyword">do</span> <span class="token punctuation">{</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">hasLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 添加到队尾</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">hasRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> q<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> <span class="token punctuation">(</span>node <span class="token operator">=</span> q<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 从队头取</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 非递归</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bfs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    var ret <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    var queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayDeque</span><span class="token operator">&lt;</span>BTreeNode<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>    BTreeNode cur<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        cur <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        ret<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cur<span class="token punctuation">.</span><span class="token function">hasLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>left<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cur<span class="token punctuation">.</span><span class="token function">hasRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>cur<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><hr><h2 id="BST"><a href="#BST" class="headerlink" title="BST"></a>BST</h2><p>Binary Search Tree ， 二叉查找树(二叉搜索树)：任意节点的左子树(如果非空)值，小于当前节点， 任意节点的右子树(如果非空) 值, 大于或等于当前节点，任意节点的左、右子树也是二叉查找树。</p><p>总结一句话，就是左边最小，右边最大。</p><p><strong>前驱节点</strong> ， 对于 BST 而言，一个节点的前驱节点，是一个节点值仅小于当前节点值的节点，如下图中， 8 的迁居节点是 3， 3 的前驱节点是 1</p><p><strong>后继节点</strong> ， 对于 BST 而言，一个节点的后继节点，是一个节点值仅大于当前节点值的节点，如下图中， 8 的后继节点是 9， 9 的后继节点是 12</p><p>我们中序遍历该树，1 –&gt; 3 –&gt; 8 –&gt; 9 –&gt; 12 –&gt; 13 ， 此时再看前驱节点， 后继节点，就一目了然了。</p><p>时间复杂度，最坏 O(N) (变成一条链)，平均 O(log N)。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200424032137.png-growing" alt="BST"></p><p>BSTreeNode 结构：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BSTree</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> BSTreeNode root<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BSTreeNode</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> BSTree left<span class="token punctuation">;</span>        <span class="token keyword">private</span> BSTree right<span class="token punctuation">;</span>        <span class="token keyword">private</span> BSTreeNode<span class="token operator">&lt;</span>T<span class="token operator">></span> parent<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 父节点</span>        <span class="token keyword">private</span> Object value<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> null <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>left<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">hasRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> null <span class="token operator">!=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>right<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h3><p>分析：如果 root 节点为空，则直接作为 root 节点，否则，小于 root 则放到左侧，大于则放到右侧。</p><p>再次对 root 的左节点和右节点重复上述步骤，直到找到符合位置的地方停止。</p><p>代码实现：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">final</span> BSTreeNode<span class="token operator">&lt;</span>T<span class="token operator">></span> r<span class="token punctuation">,</span> <span class="token keyword">final</span> BSTreeNode<span class="token operator">&lt;</span>T<span class="token operator">></span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> r<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token punctuation">{</span>            r<span class="token punctuation">.</span>left <span class="token operator">=</span> obj<span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">insert</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>left<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">==</span> r<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token punctuation">{</span>            r<span class="token punctuation">.</span>right <span class="token operator">=</span> obj<span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">insert</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>right<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h3 id="查找"><a href="#查找" class="headerlink" title="查找"></a>查找</h3><p>根据给定值，查找 BST 中有无该节点</p><p>分析：同样从根节点开始搜索，小于则往左侧搜索，大于则往右侧搜索</p><p>代码实现：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">contains</span><span class="token punctuation">(</span><span class="token keyword">final</span> BSTreeNode<span class="token operator">&lt;</span>T<span class="token operator">></span> r<span class="token punctuation">,</span> <span class="token keyword">final</span> BSTreeNode<span class="token operator">&lt;</span>T<span class="token operator">></span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> null <span class="token operator">!=</span> r<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>left<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">compareTo</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> null <span class="token operator">!=</span> r<span class="token punctuation">.</span>right<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">contains</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>right<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> obj<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>删除给定值的节点(如果有此节点)</p><p>分析：</p><ol><li><p>查找该节点，无则直接返回， 借助 contains 方法即可</p></li><li><p>若存在节点 P，则需要分开讨论：</p><ol><li><p>P 存在两个子节点(即节点度为二)，我们可以用该节点的直接前驱节点(in-order predecessor)，或者直接后继节点(in-order successor)替代 P ， 然后删除后继节点，此时后继节点(此节点的左节点必然为空)的度变为 1， 我们可以进入到步骤二</p></li><li><p>P 只有左子树或者右子树(即节点度为一) ， 把该子节点挂到 P 的父节点即可</p></li><li><p>P 没有子节点(即节点度为零)， 则可以直接删除，不会影响树结构</p></li></ol></li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200424154640.png-growing" alt="BST Delete"></p><p>代码实现 <sup>[2]</sup>：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">remove</span><span class="token punctuation">(</span>BSTreeNode<span class="token operator">&lt;</span>T<span class="token operator">></span> toDelete<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// degree = 2</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>toDelete<span class="token punctuation">.</span><span class="token function">hasRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> toDelete<span class="token punctuation">.</span><span class="token function">hasLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 寻找直接后继节点</span>        var successor <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>toDelete<span class="token punctuation">.</span>right<span class="token punctuation">)</span><span class="token punctuation">;</span>        toDelete<span class="token punctuation">.</span>value <span class="token operator">=</span> successor<span class="token punctuation">.</span>value<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 此时 toDelete 变成了 degree = 1 的节点</span>        toDelete <span class="token operator">=</span> successor<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 处理 degree = 1 的情况</span>    var replacement <span class="token operator">=</span> toDelete<span class="token punctuation">.</span><span class="token function">hasLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> toDelete<span class="token punctuation">.</span>left <span class="token operator">:</span> toDelete<span class="token punctuation">.</span>right<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 表明有一个子节点</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>replacement <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1. 设置子节点的父节点</span>        replacement<span class="token punctuation">.</span>parent <span class="token operator">=</span> toDelete<span class="token punctuation">.</span>parent<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 2. 如果 toDelete 为 root</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>toDelete<span class="token punctuation">.</span>parent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            root <span class="token operator">=</span> replacement<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>toDelete <span class="token operator">==</span> toDelete<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token punctuation">{</span>            toDelete<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>left <span class="token operator">=</span> replacement<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            toDelete<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>right <span class="token operator">=</span> replacement<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 只有一个 root 节点</span>    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>toDelete<span class="token punctuation">.</span>parent <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        root <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// degree = 0</span>    <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>toDelete <span class="token operator">==</span> toDelete<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>left<span class="token punctuation">)</span> <span class="token punctuation">{</span>            toDelete<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>left <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            toDelete<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>right <span class="token operator">=</span> null<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        toDelete<span class="token punctuation">.</span>parent <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><h2 id="RBT"><a href="#RBT" class="headerlink" title="RBT"></a>RBT</h2><p>Red Black Tree， 红黑树</p><p>正常的 BST，没有什么问题，但在某些情况下，BST 可能会退化成链表。比如依次插入 5，4，3，2，1 。这个时候， RBT 就出现了，它会对 BST 做再平衡操作(不要问我为什么，我也不知道计算机科学家们是怎么想出来的…)。</p><p>RBT 中：</p><ol><li><p>根节点必须是 black ，所有新插入的节点，默认为 red 。</p></li><li><p>兄弟节点的颜色必须一致。</p></li><li><p>父子节点不能是全 red ，可以是全黑。</p></li><li><p>所有叶子节点为黑色。(对于这一条，代码实现时，基本可以忽略。因为所有叶子节点，默认会有一个 nil 的空姐点，而该空姐点是黑色)</p></li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200425153004.png-growing" alt="Red Black Tree"></p><p><strong>旋转：</strong></p><ol><li><p>变颜色： 当前节点的父节点是红色，且父节点的兄弟节点也是红色，则</p><ol><li>把父节点和叔叔节点变为黑色</li><li>把祖父节点变为红色</li><li>将祖父节点，设为工作节点，用来进行第二步</li></ol></li><li><p>当前节点的父节点是红色，叔叔节点是黑色，且当前节点为父节点的右子树时，以父节点为轴进行<strong>左旋</strong>(左右左)</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="D:%5Ctools%5Ctypora%5Cimages%5Cimage-20200425004625167.png" alt="image-20200425004625167"></p></li><li><p>当前节点的父节点是红色，叔叔节点是黑色，且当前节点为父节点的左子树时，右旋(左左右 )：</p><ol><li>把父节点变为黑色</li><li>把祖父节点变为红色</li><li>以祖父节点为轴右旋</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="D:%5Ctools%5Ctypora%5Cimages%5Cimage-20200425004903494.png" alt="image-20200425004903494"></p></li></ol><h2 id="Trie"><a href="#Trie" class="headerlink" title="Trie"></a>Trie</h2><p>字典树。常用于统计和排序大量字符串</p><p>// 后续待补充 </p><p><a href="https://leetcode-cn.com/problems/implement-trie-prefix-tree/solution/shi-xian-trie-qian-zhui-shu-by-leetcode/" target="_blank" rel="noopener">Leetcode</a></p><h2 id="B"><a href="#B" class="headerlink" title="B+"></a>B+</h2><p>MySQL 的索引数据结构用的就是 B+ Tree</p><p>// 后续待补充</p><h2 id="注"><a href="#注" class="headerlink" title="注"></a>注</h2><h3 id="1"><a href="#1" class="headerlink" title="[1]"></a>[1]</h3><p>这里的定义参考 <a href="https://en.wikipedia.org/wiki/Binary_tree" target="_blank" rel="noopener">WIKI_EN</a></p><h3 id="2"><a href="#2" class="headerlink" title="[2]"></a>[2]</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> V <span class="token function">remove</span><span class="token punctuation">(</span>Object key<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> p <span class="token operator">=</span> <span class="token function">getEntry</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> null<span class="token punctuation">)</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    V oldValue <span class="token operator">=</span> p<span class="token punctuation">.</span>value<span class="token punctuation">;</span>    <span class="token function">deleteEntry</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> oldValue<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// java.util.TreeMap#deleteEntry</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">deleteEntry</span><span class="token punctuation">(</span>Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> p<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span>left <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>right <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>        Entry<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> s <span class="token operator">=</span> <span class="token function">successor</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>        p<span class="token punctuation">.</span>key <span class="token operator">=</span> s<span class="token punctuation">.</span>key<span class="token punctuation">;</span>        p<span class="token punctuation">.</span>value <span class="token operator">=</span> s<span class="token punctuation">.</span>value<span class="token punctuation">;</span>        p <span class="token operator">=</span> s<span class="token punctuation">;</span>    <span class="token punctuation">}</span>     <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span></code></pre><p>这是 TreeMap 类里删除元素的一段代码。刚开始看的时候，我有点没搞懂，直接 <code>p = s;</code> 不就好了吗？ 为什么要先赋值， 最后执行 <code>p = s;</code> 呢？</p><p>带着这个问题，我去问了问周公，豁然开朗，周公果真大神。</p><p>我们知道，java 中，我们执行 <code>A a = new A();</code> 时， <code>a</code> 只是持有对象 <code>A</code> 的引用，说白了就是对象 <code>A</code> 的指针。</p><p>java 中对象的传递，也是引用传递，也就是说，我给你这个对象的地址，你改了这个对象，那其他持有这个对象地址的对象，同样也会跟着变化，因为操作的都是同一个对象嘛。</p><p>回到这里，<code>deleteEntry</code> 拿到一个 Entry 的引用 <code>p</code>， 我们设这个对象为 Entry-A ， 通过 <code>p.key</code> 和 <code>p.value</code> 的操作，Entry-A 里的两个属性发生了变化，但是其他的属性没有变。其他持有 Entry-A 对象的引用，可以继续操作 Entry-A 。</p><p>而后把另一个对象，设为 Entry-B，的引用 <code>s</code> 赋值给 p ，则此时 p 不再是 Entry-A 的引用，而是化身成 Entry-B 的对象引用了。</p><h2 id="Referenct"><a href="#Referenct" class="headerlink" title="Referenct"></a>Referenct</h2><p><a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html" target="_blank" rel="noopener">USFCA 算法动画展示</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> tree </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java 系列&lt;二&gt; -- 基础数据结构</title>
      <link href="/java/basic-datastructure/"/>
      <url>/java/basic-datastructure/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-基础数据结构分析"><a href="#Java-基础数据结构分析" class="headerlink" title="Java 基础数据结构分析"></a>Java 基础数据结构分析</h1><blockquote><p>java -version<br>java version “13.0.2” 2020-01-14<br>Java(TM) SE Runtime Environment (build 13.0.2+8)<br>Java HotSpot(TM) 64-Bit Server VM (build 13.0.2+8, mixed mode, sharing)</p></blockquote><h2 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h2><p>数组能够做到<strong>快速随机访问</strong>元素，这是因为当我们创建一个数组时：</p><pre class=" language-java"><code class="language-java">var array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Person</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>java 首先把这个数组的引用存入栈中，然后到堆空间开辟一片<strong>连续</strong>的地址空间，并将数组引用指向堆地址空间。</p><p>当我们访问指定的数组元素时，则只需要根据 array 的引用地址 + 下标地址， 就能快速定位元素了。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200422165535.png-growing" alt="Array"></p><p>需要注意的是，数组需要连续空间的特性，让数组扩容难以实现，所以各种语言实现的数组，<strong>数组的大小都是固定的</strong>。</p><p>数组有 <strong>length</strong> 属性，这个属性记录的是数组的大小，而不是元素的个数。</p><h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p>java 中 list 常用的有 ArrayList 和 LinkedList。</p><h3 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h3><p><strong>底层基于数组 <code>Object[]</code> 实现，继承数组的优势，可快速随机访问元素，对于增删操作，则最坏需要 O(n) 。</strong></p><p>我们知道 array 不能扩容，但是 ArrayList 明显可以，所以我们去看看，ArrayList ，是怎样扩容的。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span>E<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractList</span><span class="token operator">&lt;</span>E<span class="token operator">></span>        <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>E<span class="token operator">></span><span class="token punctuation">,</span> RandomAccess<span class="token punctuation">,</span> Cloneable<span class="token punctuation">,</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_CAPACITY <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>    <span class="token keyword">transient</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> elementData<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// non-private to simplify nested class access</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token keyword">transient</span> <span class="token keyword">int</span> modCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><ul><li>DEFAULT_CAPACITYP ： 默认的容量大小</li><li>elementData ： 用来记录元素的数组，当我们初始化时，如果未指定容量，则用默认值初始化该数组，但是注意，此时 <strong>size</strong> 的值是零</li><li>size ： 记录列表中的元素个数，与数组的容量大小无关</li><li>modCount ： 该属性继承自 AbstractList 。所有会修改 list 大小的操作，该值都会增加。当我们通过 iterator 遍历时， 如果该值发生了改变(被另一个线程增加/删除了元素)，就会抛出 <code>ConcurrentModificationException</code> </li></ul><p>ArrayList 实现了 List / RandomAccess / Cloneable / Serializable 四个标记接口，标记接口 RandomAccess 在排序时会用到，用来选择迭代方式(for or  iterator) 。</p><p>通过源码能看到， 当我们执行 add 操作时：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span>E e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    modCount<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> elementData<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>E e<span class="token punctuation">,</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> elementData<span class="token punctuation">,</span> <span class="token keyword">int</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> elementData<span class="token punctuation">.</span>length<span class="token punctuation">)</span>        elementData <span class="token operator">=</span> <span class="token function">grow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    elementData<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>    size <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>ArrayList 首先会比较数组长度和元素大小，如果相等，则执行 <code>grow()</code> 方法，进行扩容，扩容完成后，再把元素加到 <code>elementData</code> 数组元素中。注意，此时的 elementData ，事实上，已经不是它了，它已经变成可扩容后的它。</p><p>现在看看 <code>grow</code> 方法的实现：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">grow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">grow</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">private</span> Object<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">grow</span><span class="token punctuation">(</span><span class="token keyword">int</span> minCapacity<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> oldCapacity <span class="token operator">=</span> elementData<span class="token punctuation">.</span>length<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldCapacity <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> elementData <span class="token operator">!=</span> DEFAULTCAPACITY_EMPTY_ELEMENTDATA<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> newCapacity <span class="token operator">=</span> ArraysSupport<span class="token punctuation">.</span><span class="token function">newLength</span><span class="token punctuation">(</span>oldCapacity<span class="token punctuation">,</span>                    minCapacity <span class="token operator">-</span> oldCapacity<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/* minimum growth */</span>                    oldCapacity <span class="token operator">>></span> <span class="token number">1</span>           <span class="token comment" spellcheck="true">/* preferred growth */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> elementData <span class="token operator">=</span> Arrays<span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elementData<span class="token punctuation">,</span> newCapacity<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> elementData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>DEFAULT_CAPACITY<span class="token punctuation">,</span> minCapacity<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>实现的也很清晰，把原始元素大小，需要的最小扩容量(<strong>左移一位</strong>)，和期待的扩容量，做比较，最终得到一个新的容量大小。</p><p>之后通过 Arrays.copy 方法，将老数组的元素拷贝到新元素。</p><p>具体比较方式不贴了，简单描述下：</p><ol><li>取最小扩容量和期待扩容量中的最大值，加上源数组大小，作为新的容量，我们设为 newLength。</li><li>如果这个值在允许的最大数组长度(Integer.MAX_VALUE - 8) 内，返回</li><li>否则，直接比较最大数组长度和 源数组长度 + 最小扩容量，满足则返回</li><li>否则，抛出 <code>OutOfMemoryError</code></li></ol><p>正常情况下，一次扩容的容量，会增加源数组大小的二分之一(即上面左移一位的操作)</p><h3 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h3><p>底层基于<strong>双向链表</strong> 实现，对于增删，效率极高。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span>E<span class="token operator">></span>    <span class="token keyword">extends</span> <span class="token class-name">AbstractSequentialList</span><span class="token operator">&lt;</span>E<span class="token operator">></span>    <span class="token keyword">implements</span> <span class="token class-name">List</span><span class="token operator">&lt;</span>E<span class="token operator">></span><span class="token punctuation">,</span> Deque<span class="token operator">&lt;</span>E<span class="token operator">></span><span class="token punctuation">,</span> Cloneable<span class="token punctuation">,</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>Serializable <span class="token punctuation">{</span>    <span class="token keyword">transient</span> <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">transient</span> Node<span class="token operator">&lt;</span>E<span class="token operator">></span> first<span class="token punctuation">;</span>    <span class="token keyword">transient</span> Node<span class="token operator">&lt;</span>E<span class="token operator">></span> last<span class="token punctuation">;</span>    <span class="token keyword">protected</span> <span class="token keyword">transient</span> <span class="token keyword">int</span> modCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Node</span><span class="token operator">&lt;</span>E<span class="token operator">></span> <span class="token punctuation">{</span>    E item<span class="token punctuation">;</span>    Node<span class="token operator">&lt;</span>E<span class="token operator">></span> next<span class="token punctuation">;</span>    Node<span class="token operator">&lt;</span>E<span class="token operator">></span> prev<span class="token punctuation">;</span>    <span class="token function">Node</span><span class="token punctuation">(</span>Node<span class="token operator">&lt;</span>E<span class="token operator">></span> prev<span class="token punctuation">,</span> E element<span class="token punctuation">,</span> Node<span class="token operator">&lt;</span>E<span class="token operator">></span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>item <span class="token operator">=</span> element<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>next <span class="token operator">=</span> next<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>prev <span class="token operator">=</span> prev<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>可以看到， LinkedList 实现了 List，Deque，Cloneable 和 Serializable 接口。Deque 即我们所说的双端队列。在 util 包下，还有 ArrayDeque 的实现。</p><p>Node 的结构中，主要有 prev ， next 和 item ，分别指向上一个节点，下一个节点，item 保存当前节点数据。</p><p>因为每个节点都需要保存上下两个节点的信息，所以必然比 ArrayList 要消耗更多的空间</p><h2 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h2><p>这里以 HashMap 为主。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span> <span class="token keyword">extends</span> <span class="token class-name">AbstractMap</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span>    <span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">,</span> Cloneable<span class="token punctuation">,</span> Serializable <span class="token punctuation">{</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> DEFAULT_INITIAL_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// aka 16</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MAXIMUM_CAPACITY <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">float</span> DEFAULT_LOAD_FACTOR <span class="token operator">=</span> <span class="token number">0.75f</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> threshold<span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> TREEIFY_THRESHOLD <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> UNTREEIFY_THRESHOLD <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>    <span class="token keyword">transient</span> Node<span class="token operator">&lt;</span>K<span class="token punctuation">,</span>V<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> table<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>HashMap 几个重要的参数：</p><ul><li>TREEIFY_THRESHOLD ： 树化阈值， 即当 map 中的链表长度大于该值时， 会将链表转为<strong>红黑树</strong><sup>[1]</sup></li><li>UNTREEIFY_THRESHOLD ： 当红黑树 size 小于该值时，重新转为链表</li><li>DEFAULT_INITIAL_CAPACITY ： hashmap 初始化的容量大小</li><li>table ： 即 hash 表，hashmap 做 hash 时，最终散列到这张表上，长度适中为 2<sup>n</sup> </li><li>DEFAULT_LOAD_FACTOR ：常说的<strong>装载因子</strong> 。hashmap 判断是否需要 resize 时，会根据 <code>threshold</code> 判断，而 <code>threshold</code> 则是根据 装载因子 *  table.length 算出来的</li></ul><p>我们 <code>new HashMap&lt;Object, Object&gt;(9)</code> 时， HashMap 就会去初始化 <code>loadFactor</code> 和 <code>threshold</code>   <sup>[2]</sup></p><p>HashMap 大概就长这个样子：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200423172653.png-growing" alt="HashMap Structure"></p><p><strong>HashMap 的扩容</strong></p><p>当我们执行 put 操作时， HashMap 会先将元素添加到 Map 中，然后查看 size(即 Map 中的元素个数) 是否大于 threshold (阈值， 即上面根据 loadFactory * capacity 即 table.length 算出来的) ，如果大于，就进行扩容，即 resize() 方法。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>size <span class="token operator">></span> threshold<span class="token punctuation">)</span>    <span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><strong>resize</strong> <sup>[3]</sup> 时， 首先判断 table 是否初始化，没有则先初始化 table ，然后根据 old table 以及初始化时的 loadFactor ，threshold 参数，计算新的 threshold ，以及需要扩容的大小，一般为 old table length 的 <strong>两倍</strong> 。</p><p>介绍数组时，我们已经说过，数组无法扩容，而 HashMap 是用数组来维护 hash 表的，所以需要新建一个数组，这个数组的长度就是之前数组的<strong>两倍</strong> 。</p><p>之后会进行<strong>元素移动</strong>，为什么说创建 HashMap 时，要先规划好大小，因为扩容这个操作是很消耗性能的，在一个 double for 循环中(for + while) 。</p><p>元素移动完毕后，扩容结束。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200423194538.png-growing" alt="HashMap resize"></p><h2 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h2><p>队列，FIFO， first in first out， 先进先出。</p><p>java 中 Queue 实现 Collection 接口。具体的实现有</p><ul><li>LinkedBlockingQueue ：基于 LinkedList 的阻塞队列</li><li>ArrayBlockingQueue ：基于 Array 的阻塞队列</li><li>ArrayDeque ： 基于 Array 的双端队列</li><li>LinkedList ： 是的， LinkedList 实现了 Deque 接口，也是一个双端队列，<code>Deque deque = new LinkedList();</code> </li></ul><hr><p><strong>队列常用方法：</strong></p><ul><li><p>add ：添加节点，加入队列尾部， tail </p></li><li><p>remove ：删除头节点， head</p></li><li><p>peek ：获取 head 节点，但是不删除 , 偷取元素</p></li><li><p>poll ：获取 head 节点，并删除 </p></li><li><p>offer ：立即插入节点到 tail ， 对于定长队列，有空间且插入成功则返回 true ， 若插入失败，则返回 false 。add 会抛出异常。</p></li><li><p>push ： Deque 接口所有，插入元素到 head 。</p></li><li><p>take ： BlockingQueue 接口所有 ，获取并删除 head 节点。 如果当前 queue 没有元素，则会阻塞 。</p></li></ul><h2 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h2><p>栈， FILO ， first in last out ，先进后出。</p><ul><li>peek ： 获取 head ，但不会删除，偷取元素</li><li>pop ： 获取 head ， 同时删除， 弹出元素</li><li>push ： 压入栈</li></ul><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><h3 id="1"><a href="#1" class="headerlink" title="[1]"></a>[1]</h3><p>看 HashMap 源码的时候，发现在 resize 时，对 <code>for i</code> 循环的时候，都是用 <code>for(;;++1)</code> 的写法：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> oldCap<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span></code></pre><p>平时不都是 <code>fro(;;i++)</code> 的吗？然后想了下，<code>i++</code> 会产生一个中间变量，用于暂时寄存自增前的变量，这一步会消耗一定的性能。</p><p>当然，平时我们写代码，最后编译的时候，编译器会把这部分优化成 <code>++i</code></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200423162821.png-growing" alt="java i++ ++i"></p><h3 id="2"><a href="#2" class="headerlink" title="[2]"></a>[2]</h3><p>HashMap 初始化时(带 capacity 参数)，我们跟踪下代码，就会发现，最终调用：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">tableSizeFor</span><span class="token punctuation">(</span><span class="token keyword">int</span> cap<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">>>></span> Integer<span class="token punctuation">.</span><span class="token function">numberOfLeadingZeros</span><span class="token punctuation">(</span>cap <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token punctuation">(</span>n <span class="token operator">>=</span> MAXIMUM_CAPACITY<span class="token punctuation">)</span> <span class="token operator">?</span> MAXIMUM_CAPACITY <span class="token operator">:</span> n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// Integer.numberOfLeadingZeros</span><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">numberOfLeadingZeros</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> i <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">32</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> n <span class="token operator">-=</span> <span class="token number">16</span><span class="token punctuation">;</span> i <span class="token operator">>>>=</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> n <span class="token operator">-=</span>  <span class="token number">8</span><span class="token punctuation">;</span> i <span class="token operator">>>>=</span>  <span class="token number">8</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> n <span class="token operator">-=</span>  <span class="token number">4</span><span class="token punctuation">;</span> i <span class="token operator">>>>=</span>  <span class="token number">4</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">>=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span>  <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> n <span class="token operator">-=</span>  <span class="token number">2</span><span class="token punctuation">;</span> i <span class="token operator">>>>=</span>  <span class="token number">2</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>    <span class="token keyword">return</span> n <span class="token operator">-</span> <span class="token punctuation">(</span>i <span class="token operator">>>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这个方法在干嘛呢？</p><p>我们知道， java 是通过 <strong>补码</strong> 计数的。</p><p><strong>原码</strong>  ： 原码很好理解，就是一个数的二进制表示， 对于一个四位数，则 2 的原码为 0010， -2 为 1010 </p><p><strong>反码</strong>  ： 对于正数而言，其原码 = 反码， 对于负数而言，则只需要将其原码除符号位以外的数取反即可。同样对于四位数，2 为 0010 ， -2 为 1101</p><p><strong>补码</strong>  ： 对于正数而言， 其原码 = 补码，对于负数而言，则是将其反码 + 1 。 还是对于四位数， 2 为 0010 ， -2 则为 1110</p><p><strong>溢出</strong> ： java 中，我们偶尔会碰到溢出 。我们知道， java 的基本数据类型中， 如 byte ,长度是一个字节，也就是 8 位，范围是 -128 ~ 127 。<code>1111 1111 = 255</code> 啊！ 为什么最大是 127 呢？ 因为他们都是有符号数据类型(最高位 0 表示正数， 1 表示负数)，最高位是符号位， 所以 <code>1111 1111</code> 事实上应该是 <code>-1</code></p><p>当我们计算两个 byte 类型的 如 127 + 127 时，输出了 -2 。因为 <code>0111 1111 + 0111 1111 = 1111 1110</code> ， 对于 byte 类型，最高位符号位变成了 1 。这个二进制补码还原成十进制，就是 -2 。</p><p>关于补码的更多介绍，可参考 <a href="https://www.ruanyifeng.com/blog/2009/08/twos_complement.html" target="_blank" rel="noopener">这里</a></p><p>现在回到代码。</p><p><code>numberOfLeadingZeros</code> 这个方法，java init 是一个 32 位数，我们假设 i &gt; 1&lt;&lt; 16 ， 这表明 i 的高 16 位中，至少有一个 1 ， 所以将 n (从左往右，连续的 0 的个数)  - 16 ，即低 16 位可以不考虑了。</p><p>然后将 i 无符号右移(感觉这里 &gt;&gt; 和 &gt;&gt;&gt; 都一样，因为负数已经在第一步就 return 掉了) 16 位 ， 继续判断，直到最后。假设 i = 0011 ， 则最后变成 ： 31 -  (0011 &gt;&gt;&gt; 1) = 31 - 0001 = 30 。</p><p>取得这个数后，对 -1 做无符号右移， -1 是 ffff ffff ， 右移 n 位后， 再加上 1，可保证得到一个 cap 向上的 2 的次幂。</p><p>至于为什么 HashMap 的 capacity 一定要是 2 次幂， 这就要说到它的 hash 算法了：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">hash</span><span class="token punctuation">(</span>Object key<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> h<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span>h <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>h <span class="token operator">>>></span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>可以看到， 这里将 key 的 hashcode 低 16 位和高 16 位做亦或运算 。</p><pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>p <span class="token operator">=</span> tab<span class="token punctuation">[</span>i <span class="token operator">=</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> hash<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>    tab<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">newNode</span><span class="token punctuation">(</span>hash<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>放 node 时， index 是根据 (n-1) &amp; hash 来运算的。</p><p>因为 <strong>n 是一个 2 次幂</strong>，所以 n-1 是一个全 f 的数， 对 hash 做与运算，即拿到 hash 的低位。</p><p>如， HashMap capacity = 8 ，即 n = 8 ，则 n-1 = 0000 0111 假设 key 的 hash 为 <code>0111 0010</code> ， 则 (n-1) &amp; hash = 0000 0010  = 2，会被放入 tab[2] 中。</p><p>这样有什么问题呢？ 即每次都只有 key 的低位参与了运算，会导致较大概率的 hash 碰撞。</p><p>所以 HashMap 的 hash 算法，将其 hash 的低 16 位和高 16 位做了亦或，保证数据的更大的随机性，从而减小 hash 碰撞的可能性。</p><p>同时，全程的位操作，也给计算带来了性能上的优势。</p><h3 id="3"><a href="#3" class="headerlink" title="[3]"></a>[3]</h3><p>参见 <a href="../../algorithm/tree/">树 – 算法浅析</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> languages </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java 系列&lt;一&gt; -- Java RoadMap</title>
      <link href="/java/roadmap/"/>
      <url>/java/roadmap/</url>
      
        <content type="html"><![CDATA[<h1 id="java"><a href="#java" class="headerlink" title="java"></a>java</h1><h2 id="roadmap"><a href="#roadmap" class="headerlink" title="roadmap"></a>roadmap</h2><iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:525px; height:245px;" src="https://www.processon.com/embed/5e9fc7f6f346fb177b8b333c"></iframe><p>后面的时间，就按照整理的这份 roadmap ，好好复习下 java 相关的知识点。</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://github.com/Snailclimb/JavaGuide" target="_blank" rel="noopener">Github JavaGuide</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> languages </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker 系列&lt;完&gt; Docker Commands 一览</title>
      <link href="/docker/commands/"/>
      <url>/docker/commands/</url>
      
        <content type="html"><![CDATA[<h1 id="Docker-常用命令"><a href="#Docker-常用命令" class="headerlink" title="Docker 常用命令"></a>Docker 常用命令</h1><h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>我们将尝试在 docker 容器中运行程序，爬取 cn.bing 的图片。</p><p>对于 bing 图片的爬取，这里采用最简单的方式：通过 bing 官方的 <a href="https://cn.bing.com/HPImageArchive.aspx" target="_blank" rel="noopener">链接</a> 爬取。为此，我们需要先准备一个简单的 Go 程序：</p><pre class=" language-go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span>    bingPrefix <span class="token operator">=</span> <span class="token string">"https://cn.bing.com"</span>    bingUrl    <span class="token operator">=</span> bingPrefix <span class="token operator">+</span> <span class="token string">"/HPImageArchive.aspx"</span>    limit      <span class="token operator">=</span> <span class="token number">5</span>    <span class="token comment" spellcheck="true">// 爬取 5 条</span>    format     <span class="token operator">=</span> <span class="token string">"js"</span> <span class="token comment" spellcheck="true">// json 格式</span><span class="token punctuation">)</span><span class="token keyword">var</span> <span class="token punctuation">(</span>    images <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">type</span> Image <span class="token keyword">struct</span> <span class="token punctuation">{</span>    FullStartDate <span class="token builtin">string</span> <span class="token string">`json:"fullStartDate,omitempty"`</span>    Url           <span class="token builtin">string</span> <span class="token string">`json:"url"`</span><span class="token punctuation">}</span><span class="token keyword">type</span> Bing <span class="token keyword">struct</span> <span class="token punctuation">{</span>    Images <span class="token punctuation">[</span><span class="token punctuation">]</span>Image <span class="token string">`json:"images"`</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    logrus<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"*****************  Star Http Server *****************"</span><span class="token punctuation">)</span>    server <span class="token operator">:=</span> echo<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// 这里就不用 POST 了</span>    server<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/pull"</span><span class="token punctuation">,</span> scraperHandler<span class="token punctuation">)</span>    server<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">,</span> bingListHandler<span class="token punctuation">)</span>    server<span class="token punctuation">.</span>Logger<span class="token punctuation">.</span><span class="token function">Fatal</span><span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token string">":1234"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">scraperHandler</span><span class="token punctuation">(</span>e echo<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> <span class="token punctuation">(</span>        err    <span class="token builtin">error</span>        res    <span class="token operator">*</span>http<span class="token punctuation">.</span>Response        rBytes <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>        bing   Bing        sorry  <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token punctuation">)</span>    <span class="token keyword">if</span> res<span class="token punctuation">,</span> err <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token function">wrapUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        logrus<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"get url failed, error="</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        sorry <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> res <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> res<span class="token punctuation">.</span>Body <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        logrus<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"we got nil response..."</span><span class="token punctuation">)</span>        sorry <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> rBytes<span class="token punctuation">,</span> err <span class="token operator">=</span> ioutil<span class="token punctuation">.</span><span class="token function">ReadAll</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        logrus<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"read response body failed."</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        sorry <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">=</span> json<span class="token punctuation">.</span><span class="token function">Unmarshal</span><span class="token punctuation">(</span>rBytes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bing<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        logrus<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"unmarshal body failed."</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        sorry <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> sorry <span class="token punctuation">{</span>        <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusInternalServerError<span class="token punctuation">,</span> <span class="token string">"something wrong..."</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 先清空</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        images <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> img <span class="token operator">:=</span> <span class="token keyword">range</span> bing<span class="token punctuation">.</span>Images <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>Url<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        images <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> bingPrefix<span class="token operator">+</span>img<span class="token punctuation">.</span>Url<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span> <span class="token operator">==</span> limit <span class="token punctuation">{</span>            <span class="token keyword">break</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> <span class="token string">"Done"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">bingListHandler</span><span class="token punctuation">(</span>e echo<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">JSONPretty</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> images<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">wrapUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">"%s?format=%s&amp;idx=0&amp;n=%d"</span><span class="token punctuation">,</span> bingUrl<span class="token punctuation">,</span> format<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">}</span></code></pre><h3 id="1-编写-Dockerfile"><a href="#1-编写-Dockerfile" class="headerlink" title="1. 编写 Dockerfile"></a>1. 编写 Dockerfile</h3><p>Dockerfile 常见格式如下：</p><pre class=" language-dockerfile"><code class="language-dockerfile"># 声明使用的基础镜像FROM alpine# 一系列动作RUN echo HelloCOPY ./tmp.txt /usr/localADD ./add.zip /usr/localENV ENV1 ENV_VALUE1# 启动容器时，默认的执行程序ENTRYPOINT ["start.sh"]CMD echo hello</code></pre><h4 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a><strong>FROM</strong></h4><p>用来初始化一个新的 build stage(构建阶段)，并为后续的指令提供一个 base image(基础镜像)。</p><p>一个有效的 Dockerfile ，必须以 FROM 指令开头。</p><p>比如我们常常使用 alpine 来作为 linux 的 base image，因为它提供了一个小巧精简的 linux kernel。</p><hr><h4 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a><strong>RUN</strong></h4><p>RUN 指令有两种形式：</p><ul><li>shell 形式： 如 RUN echo $HOME， 该命令会以 <code>/bin/sh -c</code> 方式执行</li><li>exec 形式： 如 RUN [“echo”, “$HOME”]， 这里不会做 shell 解析，所以会输出 $HOME </li></ul><hr><h4 id="LABEL"><a href="#LABEL" class="headerlink" title="LABEL"></a><strong>LABEL</strong></h4><p>用来将元素据打到镜像中。</p><p>我们制作镜像的时候，出了程序，一般会把相关的信息，如分支，commit  短号，构建日期，版本，作者等，放到镜像中。这个时候，就可以使用 LABEL 。以前通过 <code>MAINTAINER</code> 标签来表明作者，现在已弃用，使用 LABEL 来实现：</p><pre class=" language-dockerfile"><code class="language-dockerfile">LABEL version="v0.1" \     built_time="2020-02-02" 、    maintainer="iyuhp"</code></pre><hr><h4 id="COPY-amp-ADD"><a href="#COPY-amp-ADD" class="headerlink" title="COPY &amp; ADD"></a><strong>COPY &amp; ADD</strong></h4><p>二者都可以用来添加本地文件到 image 中。</p><p>在执行 build 命令时，<strong>docker 客户端会把上下文中的所有文件发送给 docker daemon</strong>。考虑 docker 客户端和 docker daemon 不在同一台机器上的情况，build 命令只能从上下文中获取文件。</p><p>如果仅仅是把本地的文件拷贝到容器镜像中，COPY 命令是最合适不过的。其命令的格式为：</p><pre class=" language-dockerfile"><code class="language-dockerfile">COPY  [<src>,<src>, ...<src>,<dest>]COPY <src> <dest></code></pre><p>如果 src 有多个时， dest 必须以 <code>/</code> 左斜杠结尾！</p><p>除了指定完整的文件名外，COPY 命令还支持 <a href="http://golang.org/pkg/path/filepath#Match" target="_blank" rel="noopener">Go 风格</a> 的通配符，比如：</p><pre class=" language-dockerfile"><code class="language-dockerfile">COPY check* /testdir/           # 拷贝所有 check 开头的文件COPY check?.log /testdir/       # ? 是单个字符的占位符，比如匹配文件 check1.log</code></pre><p>对于目录而言，COPY 和 ADD 命令具有相同的特点：<strong>只复制目录中的内容而不包含目录自身</strong>。比如我们在 Dockerfile 中添加下面的命令：</p><pre class=" language-dockerfile"><code class="language-dockerfile"># 假设 data 目录下存在 file1 和 file2WORKDIR /appCOPY data ./  # 此时 ./ 中只包含 file1 和 file2 ，而不是 ./data/file1, 2 # 如果需要 data 目录，则需要这样做 COPY data ./data </code></pre><p>如果duo src 拷贝时发生冲突，后面的 src 文件，会覆盖前面的 src 文件。假设有两个目录 /a/c.txt  和 /b/c.txt</p><p>通过 <code>COPY /a/c.txt /b/c.txt /abc/</code> 命令， 容器内会变成 <code>/abc/c.txt</code> ，且该文件来自于 /b/c.txt。</p><p><strong>COPY 还可用在 multistage 场景下</strong> <code>COPY --from=builder /src .</code></p><p>对于 ADD 指令，不能用在 multistage  场景，其他的上述描述，ADD 都可以做到：</p><pre><code>ADD [&lt;src&gt;, &lt;src&gt;, ... &lt;src&gt;, &lt;dest&gt;]ADD &lt;src&gt; &lt;dest&gt;</code></pre><p>ADD 的 src ，可以是远程文件 URL，ADD 会帮助拉取(一般不建议这样用，可以通过 wget，curl 命令来获取)，还可以是采用公认压缩格式(gzip, bzip2, xz，identity) 的本地归档文件，则 docker 会帮助我们执行 <code>tar -x</code> 解压文件(远程 URL 文件不会被解压)</p><p>对于 ADD 而言，如果其定义的内容发生了改变，则之后所有的缓存都会失效，对于 dockerfile 优化，这会是一个点，我们要尽量避免这种情况，或者将 ADD 尽量放到 Dockerfile 的后面</p><hr><h4 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a><strong>ENV</strong></h4><p>设置环境变量， 支持两种形式：</p><pre class=" language-dockerfile"><code class="language-dockerfile">ENV e1 v1ENV e1=v1 e2=v2 ...</code></pre><hr><h4 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a><strong>WORKDIR</strong></h4><p>指定工作目录，会 cd 到指定的目录下， 可以使用 env</p><pre class=" language-dockerfile"><code class="language-dockerfile">WORKDIR /workspaceRUN pwd # 输出 /workspaceWORKDIR abc # 此时在 /workspace/abcENV DIRPATH /tmpWORKDIR $DIRPATH/abc # 此时在 /tmp/abc</code></pre><p>可通过 <code>-w</code> 覆盖：</p><pre class=" language-bash"><code class="language-bash">docker run -ti -w /otherworkspace ubuntu <span class="token function">pwd</span></code></pre><hr><h4 id="USER"><a href="#USER" class="headerlink" title="USER"></a><strong>USER</strong></h4><p>指定运行 image 时的 user 和组，默认为 root：</p><pre class=" language-dockerfile"><code class="language-dockerfile">USER <user>[:<group>]USER <UID>[<:<GID>]</code></pre><hr><h4 id="STOPSIGNAL"><a href="#STOPSIGNAL" class="headerlink" title="STOPSIGNAL"></a><strong>STOPSIGNAL</strong></h4><p>用来设置停止容器时， 发送什么系统调用信号给容器。这个信号必须是内核系统调用表中合法的数， 如 9， 或者 SIGNAME 格式中的信号名称， 如 SIGKILL 。</p><hr><h4 id="ARG"><a href="#ARG" class="headerlink" title="ARG"></a><strong>ARG</strong></h4><p>用来定义在 docker build 命令运行时传递给构建运行时的变量。 只需要在构建时， 通过 <code>--build-arg</code> 来使用。 用户只能在构建时指定在 Dockerfile 中定义过的参数！</p><pre class=" language-dockerfile"><code class="language-dockerfile">ARG buildARG build_user=peifeng # 构建时若未指定， 则使用 peifeng 这个默认值</code></pre><p>对于 DevOps 而言，我们会把打包这个动作放到 docker 中执行，我们可以通过 buidl args 参数，限制 cpu  / mem 等系统资源的使用。</p><pre class=" language-bash"><code class="language-bash">docker build --build-arg build_user<span class="token operator">=</span>1234 -t peifeng/demo:v1 <span class="token keyword">.</span></code></pre><p>注意， 不要通过 ARG 来传递证书或者密钥之类的信息。这些在构建过程中以及镜像的构建历史中会被暴露！</p><p>ARG 指令可能会导致 docker 的高速缓存失效。参见 <a href="https://docs.docker.com/engine/reference/#arg" target="_blank" rel="noopener">这里</a></p><p>docker 预定义了一组 ARG 变量，在构建时可直接使用， 参见 <a href="https://docs.docker.com/engine/reference/builder/#arg" target="_blank" rel="noopener">官方文档#ARG</a></p><ul><li><code>HTTP_PROXY</code></li><li><code>http_proxy</code></li><li><code>HTTPS_PROXY</code></li><li><code>https_proxy</code></li><li><code>FTP_PROXY</code></li><li><code>ftp_proxy</code></li><li><code>NO_PROXY</code></li><li><code>no_proxy</code></li></ul><hr><h4 id="ONBUILD"><a href="#ONBUILD" class="headerlink" title="ONBUILD"></a><strong>ONBUILD</strong></h4><p>为镜像添加触发器。A 镜像中有 ONBUILD 指令， B 镜像使用 A 镜像作为父镜像，构建时， 会触发 ONBUILD 指令。ONBUILD <strong>只有子镜像会被触发</strong>， 孙子镜像不会触发。</p><p>ONBUILD, FROM, MAINTAINER 不能用在 ONBUILD 指令中， 错误示例： <code>ONBUILD FROM centos:7</code> </p><p>子镜像在 FROM 后， 会首先运行父镜像的 ONBUILD 的指令： <code>RUN echo hello world father</code> </p><p>该功能可以用作<strong>镜像模板功能</strong>， 抽象出一些公共的指令放到父镜像中。</p><hr><h4 id="HEALTHCHECK"><a href="#HEALTHCHECK" class="headerlink" title="HEALTHCHECK"></a><strong>HEALTHCHECK</strong></h4><p>用于容器的健康检查：</p><pre class=" language-dockerfile"><code class="language-dockerfile">HEALTHCHECK [options] CMD commandHEALTHCHECK NONE 禁用从父镜像继承的 health check</code></pre><pre class=" language-dockerfile"><code class="language-dockerfile">HEALTHCHECK --interval=5m \     --timeout=3s \     --start-period=30s \     --retries=3 \     CMD curl -f http://localhost/ || exit 1 </code></pre><p>容器的三个状态：</p><ul><li>starting ： 容器的启动状态</li><li>healthy ： 通过健康检查后的状态</li><li>unhealthy ： 健康检查失败且超过重试次数后的状态</li></ul><p>参数说明：</p><ul><li><code>--interval</code>   ： 设置检查的时间间隔， 默认 30s</li><li><code>--timeout</code>  ： #设置超时时间，如果一次检查超过 3s (默认 30s) ，则认为不健康。 此时不会将容器置为不健康， 会配合下面的 retries ，超过重试次数后，会见容器置为 unhealthy </li><li><code>--start-period</code> ： 容器启动时间，容器开始启动到设置的这段时间内，不统计健康检查(默认 0s)</li><li><code>--retries</code>  ： 重试次数，当连续 3 次检查失败，则认为该容器出了问题，置为 unhealthy</li><li><code>CMD</code> ： CMD 后为检查的动作</li></ul><p>该命令每次检查，会返回三个状态码：</p><ul><li>0 ： 容器健康</li><li>1 ： 不健康，容器无法正常工作</li><li>2 ： docker 的保留退出码，暂时没什么作用，谁知道后面用来干嘛，官方建议我们不要用这个退出码</li></ul><hr><h4 id="SHELL"><a href="#SHELL" class="headerlink" title="SHELL"></a><strong>SHELL</strong></h4><p>shell 指令允许我们设置默认的 shell。 Linux 上的默认 shell 是 [“/bin/sh”, “-c”]，而在 Windows 上是 [“cmd”, “/S”, “/C”]。</p><ul><li><p>SHELL 指令必须以 JSON 格式写入 Dockerfile</p></li><li><p>SHELL 指令可以多次出现。每条 SHELL 指令都会覆盖所有先前的 SHELL 指令，并影响所有后续指令</p></li></ul><pre class=" language-dockerfile"><code class="language-dockerfile"># Executed as powershell -command Write-Host helloSHELL ["powershell", "-command"]</code></pre><hr><h4 id="VOLUME"><a href="#VOLUME" class="headerlink" title="VOLUME"></a><strong>VOLUME</strong></h4><p>用来指定挂载卷。VOLUME 更多内容请参见 <a href="https://docs.docker.com/storage/volumes/" target="_blank" rel="noopener">这里</a></p><pre class=" language-dockerfile"><code class="language-dockerfile">FROM ubuntuRUN mkdir /myvolRUN echo "hello world" > /myvol/greetingVOLUME /myvol</code></pre><p>上面的 Dockerfile ，会在 <code>docker run</code> 时， 创建一个新的挂载点 <code>/myvol</code> ， 然后将 <code>greeting</code> 文件 copy 到卷中。</p><p>volume 有如下特性：</p><ul><li>volume 可以在容器间共享和重用</li><li>对 volume 的修改是立即生效的</li><li>对 volume 的修改，不会对更新镜像产生影响</li></ul><p>当我们通过 Dockerfile 指定 volume 时：</p><pre class=" language-dockerfile"><code class="language-dockerfile">VOLUME ["/data", "/log"]</code></pre><p>如果我们执行 <code>docker run</code> 时，未指定宿主机挂载点，则 docker 会自动绑定到宿主机的一个目录下，一般在 <code>/var/lib/docker/volumes</code> 目录下。假设 container id 为 123456， 我们通过 <code>docker inspect -f {{ .Mounts }} 123456</code> ，找到挂载卷的名称，再到 volumes 下找对应的数据(可能在一个 _data 目录里)就好了。</p><p><strong>通过 docker run 方式使用</strong></p><p>docker 在 <code>17.06</code> 版本前，对于单机版 docker ，通过 <code>--volume</code> 或者 <code>-v</code>  指定，现在官方建议使用 <code>--mount</code> 命令来指定挂载卷。这里以 <code>--mount</code> 演示：</p><pre class=" language-bash"><code class="language-bash">docker run --rm -ti \--name bing \--mount source<span class="token operator">=</span>/var/volume/bing,target<span class="token operator">=</span>/myvol,readonly \nginx:latest</code></pre><ul><li>–rm 指明当前容器停止后，删除容器</li><li>-ti ， -t 表示打开一个伪终端， -i 表示打开容器的 stdin </li><li>–mount 中， source 表示宿主机挂载点， target 表示容器内挂载点， readonly 表明该挂载卷为只读模式</li></ul><p>docker 官方给出了一张图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200422002108.png-growing" alt="share data"></p><p>表明通过 volume 来实现各个 container 之间数据共享。</p><hr><h4 id="CMD-amp-ENTRYPOINT"><a href="#CMD-amp-ENTRYPOINT" class="headerlink" title="CMD &amp; ENTRYPOINT"></a><strong>CMD &amp; ENTRYPOINT</strong></h4><p>这两个命令都可以用来指定容器的默认执行命令。</p><p><strong>CMD</strong> 的作用：</p><ul><li>通过 exec 模式执行默认执行命令 ， 可以在 docker run 的时候被覆写</li><li>通过 shell 模式执行默认执行命令 ， 可以在 docker run 的时候被覆写</li><li>为 ENTRYPOINT 提供执行参数</li></ul><pre class=" language-dockerfile"><code class="language-dockerfile">FROM alpineCMD ["echo", "$HOME"] # docker run 且不复写命令时，输出 $HOME# 或者这样CMD echo $HOME # docker run 且不覆写命令时， 输出 /home/xxx (你的 home 目录)</code></pre><p>这个时候，我们这样启动：</p><pre class=" language-bash"><code class="language-bash">docker run --rm bing:v0.1 <span class="token function">ps</span></code></pre><p>则会执行 ps 命令。</p><p>注意， CMD 命令只能被整体覆写，不能覆写 CMD 中的某个参数</p><p><strong>ENTRYPOINT</strong> 的作用：</p><ul><li>通过 exec 模式执行默认命令，可以在 docker run 的时候，<strong>追加</strong>参数</li><li>通过 shell 模式执行默认命令，不可以被覆写， 是什么样就是什么样</li></ul><pre class=" language-bash"><code class="language-bash">FROM alpineCMD <span class="token punctuation">[</span><span class="token string">"p1"</span>, <span class="token string">"p2"</span><span class="token punctuation">]</span>ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"echo"</span>, <span class="token string">"hello"</span><span class="token punctuation">]</span></code></pre><p>这个会输出 hello p1 p2</p><pre class=" language-dockerfile"><code class="language-dockerfile">FROM alpineCMD echo hahaENTRYPOINT ["echo", "hello"]</code></pre><p>这个则会输出 hello /bin/sh -c echo haha , 这也表明 shell 模式下会通过 /bin/sh -c 来解释命令</p><p>我们现在通过 docker run 来试试：</p><pre class=" language-bash"><code class="language-bash">docker run --rm -ti bing:v0.1 aha</code></pre><p>这个时候，CMD 的参数会被全部覆写，而 docker run 传递的参数会被追加到 ENTRYPOINT 后面，所以最终会输出 hello aha 。</p><p>我们来总结一波：</p><p>有 ENTRYPOINT 时：</p><ul><li>为 shell 模式，那就是它了，别给我扯别的</li><li>为 cmd 模式时， CMD 或者 docker run 添加的参数，都乖乖加到我的后面去， 所以这个时候， CMD 都是给 ENTRYPOINT 提供默认的启动参数</li></ul><p>只有 CMD 时，会被 docker run 的启动参数全部覆写掉</p><p>docker 官方给出的 CMD 和 ENTRYPOINT 的关系图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200422003327.png-growing" alt="CMD &amp; ENTRYPOINT"></p><h3 id="2-动手"><a href="#2-动手" class="headerlink" title="2. 动手"></a>2. 动手</h3><p>到目前为止，我们都还没有自己动手写一个 Dockerfile， 现在，可以试一下了：</p><pre class=" language-dockerfile"><code class="language-dockerfile"># 基础镜像FROM golang:1.14# 工作目录WORKDIR /go/cacheCOPY ./go.mod ./go.sum ./RUN GOPROXY=https://goproxy.io/ GO111MODULE=on go mod downloadWORKDIR /go/releaseADD . .RUN GOPROXY=https://goproxy.io/ GOOS=linux CGO_ENABLED=0 GO111MODULE=on go build -ldflags="-s -w" -o ./bing ./main.go# 添加执行权限RUN chmod +x /usr/bin/bingCMD ["/usr/bin/bing"]</code></pre><p>有了上面的基础，现在再来看这个 Dockerfile ，是不是太简单了？</p><p>tips ： 如果你有 golang 环境，只需要把最上面的代码 copy 下去，然后执行 <code>go mod init bing &amp;&amp; go mod tidy</code> </p><p>之后执行 <code>docker build . -t bing:v1.0</code> ，通过 <code>docker images | grep bing</code> 查看，会看到一个将近 1G 的镜像。</p><p>我滴个乖乖， 事实上，我们的 bing 程序，只有不到 9M：</p><pre class=" language-bash"><code class="language-bash">➜  bing lltotal 9.0M-rwxrwxr-x 1 dylan dylan 8.5M Apr 22 02:10 bing-rw-rw-r-- 1 dylan dylan  397 Apr 22 01:59 dockerfile.bing-rw-rw-r-- 1 dylan dylan  113 Apr 22 02:06 go.mod-rw-rw-r-- 1 dylan dylan 4.8K Apr 22 02:06 go.sum-rw-rw-r-- 1 dylan dylan 1.9K Apr 22 01:27 main.go</code></pre><p>这必然不能忍啊！</p><p>这近 1G 的镜像，大部分都是我们用不到的，都是 golang 相关， 而当我们通过 golang 环境构建完成后，这些环境就可以抛弃了。</p><p>基于此， docker 推出了 <strong>multistage</strong> 构建技术。</p><hr><p><strong>multistage</strong> 允许我们在一份 Dockerfile 文件中，通过多 stage 来构建我们需要的目标文件，最后使用 <code>copy --from</code> 来把多 stage 产物合并到一起，同时摒弃掉那些已然无用的文件。</p><p>在我们这个例子中，我们只需要构建完成的 bing 可执行程序(以及运行这个程序所需的最小环境)，剩下的都不需要。</p><p>所以，我们这样做：</p><pre class=" language-dockerfile"><code class="language-dockerfile"># 基础镜像 # 第一个 stage ，我们通过 as 将当前 stage 命名为 builderFROM golang:1.14 as builder# 工作目录WORKDIR /go/cacheCOPY ./go.mod ./go.sum ./RUN GOPROXY=https://goproxy.io/ GO111MODULE=on go mod downloadWORKDIR /go/releaseADD . .RUN GOPROXY=https://goproxy.io/ GOOS=linux CGO_ENABLED=0 GO111MODULE=on go build -ldflags="-s -w" -o ./bing ./main.go# 到这里为止， 我们的目标程序已经产生，为： /go/release/bing# 于是我们使用下一个 stage# 供 bing 程序执行的最小环境FROM alpine# 从 上一个 stage 拷贝文件到当前 stage, 通过 --from 知名 copy 的目标 stageCOPY --from=builder /go/release/bing /usr/bin/bing# 添加执行权限RUN chmod +x /usr/bin/bingCMD ["/usr/bin/bing"]</code></pre><p>之后，我们再次构建 <code>docker build . -t bing:v1.0</code> ， <code>docker images | grep bing</code> 查看：</p><pre class=" language-bash"><code class="language-bash">➜  bing docker images <span class="token operator">|</span> <span class="token function">grep</span> bingbing                                                         v1.0                0504d26e479d        14 minutes ago      18.4MB</code></pre><p>可以看到，最终大小，为 18.4MB ， 于是我们从 1G ，瘦到了不到 20M ，完美。</p><p>现在我们来测试下：</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 从 bing 获取图片</span>➜  ~ curl localhost:1234/pull<span class="token string">"Done"</span><span class="token comment" spellcheck="true"># 查看获取的图片记录</span>➜  ~ curl localhost:1234/list<span class="token punctuation">[</span><span class="token string">"https://cn.bing.com/th?id=OHR.KauriTree_ZH-CN3695568740_1920x1080.jpg\u0026rf=LaDigue_1920x1080.jpg\u0026pid=hp"</span>,<span class="token string">"https://cn.bing.com/th?id=OHR.GPS_ZH-CN5160095061_1920x1080.jpg\u0026rf=LaDigue_1920x1080.jpg\u0026pid=hp"</span>,<span class="token string">"https://cn.bing.com/th?id=OHR.BluebellWood_ZH-CN8128422960_1920x1080.jpg\u0026rf=LaDigue_1920x1080.jpg\u0026pid=hp"</span>,<span class="token string">"https://cn.bing.com/th?id=OHR.NeistPoint_ZH-CN3115403132_1920x1080.jpg\u0026rf=LaDigue_1920x1080.jpg\u0026pid=hp"</span>,<span class="token string">"https://cn.bing.com/th?id=OHR.VernalFalls_ZH-CN2664125316_1920x1080.jpg\u0026rf=LaDigue_1920x1080.jpg\u0026pid=hp"</span><span class="token punctuation">]</span></code></pre><hr><h2 id="Docker-compose"><a href="#Docker-compose" class="headerlink" title="Docker compose"></a>Docker compose</h2><p>我们拉取了照片，可是这个时候，我又想把这些东西存起来。于是我们又搞了个 server，专门用来存这些图片 url 。</p><p>怎么搞呢?</p><p>我们于是又用 docker 起了一个 server。于是我们每次都要启动两个 server 。</p><p>要这么麻烦吗？ of course not ！</p><p>docker 可以通过 docker-compose 文件，为我们提供服务编排。</p><p>所谓服务编排，说白了，就是对一堆的服务，做排序，先启哪个，后起哪个(当然，服务编排的功能可不仅如此，比如服务发现等) 。</p><p>要使用 <code>docker-compose</code> ，需要首先安装：</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1. 下载</span><span class="token function">sudo</span> curl -L <span class="token string">"https://github.com/docker/compose/releases/download/1.25.5/docker-compose-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -s<span class="token variable">)</span></span>-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -m<span class="token variable">)</span></span>"</span> -o /usr/local/bin/docker-compose<span class="token comment" spellcheck="true"># 2. 添加执行权限</span><span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose<span class="token comment" spellcheck="true"># 3. 添加软连接</span><span class="token function">sudo</span> <span class="token function">ln</span> -s /usr/local/bin/docker-compose /usr/bin/docker-compose<span class="token comment" spellcheck="true"># 4. 测试安装是否成功</span>docker-compose --version</code></pre><p>在 <a href="https://github.com/docker/compose/releases" target="_blank" rel="noopener">这里</a> 可以看到 docker-compose 的版本。</p><p>一般性结构为(具体的 yaml 结构，可以去看它的 <a href="https://github.com/docker/compose/blob/master/compose/config/config_schema_v3.8.json" target="_blank" rel="noopener">源码</a>)：</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'2.0'</span><span class="token key atrule">services</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 用来定义各个服务</span>    <span class="token punctuation">...</span><span class="token key atrule">networks</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 网络设置</span>    <span class="token punctuation">...</span> <span class="token key atrule">volumes</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 卷设置</span>    <span class="token punctuation">...</span><span class="token key atrule">secrets</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 敏感数据</span>    <span class="token punctuation">...</span><span class="token key atrule">configs</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 其他设置</span>    <span class="token punctuation">...</span></code></pre><p>这里不再展开，我们先尝试把上面的 dockerfile 改写成 docker-compose.yml ：</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span><span class="token key atrule">services</span><span class="token punctuation">:</span>    <span class="token key atrule">bing</span><span class="token punctuation">:</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token string">"1235:1235"</span>         <span class="token key atrule">image</span><span class="token punctuation">:</span> bing<span class="token punctuation">-</span>compose<span class="token punctuation">:</span>v1.0         <span class="token key atrule">build</span><span class="token punctuation">:</span>             <span class="token key atrule">context</span><span class="token punctuation">:</span> .             <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> <span class="token string">"dockerfile.bing"</span>             <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 支持 dict 和 list 两种模式， 使用 list 模式请参考 ports 写法</span>                 <span class="token key atrule">source</span><span class="token punctuation">:</span> <span class="token string">"I'm from docker compose"</span>                 <span class="token key atrule">maintainer</span><span class="token punctuation">:</span> <span class="token string">"iyuhp"</span></code></pre><p>此时，执行 <code>docker-compose up</code> , 则会构建镜像并拉起镜像。</p><p>现在，我们把 redis 加进去，作为临时存储：</p><pre class=" language-yaml"><code class="language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span><span class="token key atrule">services</span><span class="token punctuation">:</span>    <span class="token key atrule">bing</span><span class="token punctuation">:</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token string">"1235:1235"</span>         <span class="token key atrule">image</span><span class="token punctuation">:</span> bing<span class="token punctuation">-</span>compose<span class="token punctuation">:</span>v1.0         <span class="token key atrule">build</span><span class="token punctuation">:</span>             <span class="token key atrule">context</span><span class="token punctuation">:</span> .             <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> <span class="token string">"dockerfile.bing"</span>             <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 支持 dict 和 list 两种模式， 使用 list 模式请参考 ports 写法</span>                 <span class="token key atrule">source</span><span class="token punctuation">:</span> <span class="token string">"I'm from docker compose"</span>                 <span class="token key atrule">maintainer</span><span class="token punctuation">:</span> <span class="token string">"iyuhp"</span>         <span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 表明该服务依赖于 redis ，会先启动 redis ，再启动该服务</span>             <span class="token punctuation">-</span> redis    <span class="token key atrule">redis</span><span class="token punctuation">:</span>         <span class="token key atrule">ports</span><span class="token punctuation">:</span>             <span class="token punctuation">-</span> <span class="token string">"6379:6379"</span>         <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span><span class="token number">5.0</span>         <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"redis-server"</span><span class="token punctuation">,</span> <span class="token string">"/usr/local/etc/redis/redis.conf"</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true"># 覆写 CMD </span>         <span class="token key atrule">volumes</span><span class="token punctuation">:</span>             <span class="token punctuation">-</span> ./redis<span class="token punctuation">-</span>data<span class="token punctuation">:</span>/data             <span class="token punctuation">-</span> ./redis.conf<span class="token punctuation">:</span>/usr/local/etc/redis/redis.con <span class="token comment" spellcheck="true"># 自定义 redis.conf</span></code></pre><p>这样，就可以通过 <code>docker-compose up</code> 来依次启动 redis ， bing 服务了。</p><p>嗯， 虽然这里并没有和 redis 互动。 如果你喜欢，完全可以基于上面的代码，稍微加点 redis 调用，就好了</p><hr><h2 id="常用-docker-命令"><a href="#常用-docker-命令" class="headerlink" title="常用 docker 命令"></a>常用 docker 命令</h2><h3 id="docker-create"><a href="#docker-create" class="headerlink" title="docker create"></a>docker create</h3><p>创建一个容器， 但是不会运行它</p><h3 id="docer-start"><a href="#docer-start" class="headerlink" title="docer start"></a>docer start</h3><p>docker start / restart container_name/container_id</p><p>启动或者重启已经停止的容器</p><h3 id="docker-run"><a href="#docker-run" class="headerlink" title="docker run"></a>docker run</h3><ul><li>-i  保证容器中 STDIN 是开启的， 持久的标准输入是交互式 shell 的“半边天”</li><li>-t  告诉 docker 要为创建的容器分配一个伪 tty 终端， 这样， 新建的容器才能提供一个交互式 shell</li><li>-d  后台运行</li><li>-p 用来控制 docker 在运行时应该公开哪些网络端口给外部(宿主机)。docker 可以通过两种方式来在宿主机上分配方式：<ul><li>在宿主机上随机选择一个 32768 ~ 61000 的一个比较大的端口号来映射到容器中的 80 端口</li><li>在 docker 宿主机中指定一个具体的端口号来映射到容器中的 80 端口</li></ul></li><li>–name  制定运行容器的名字, 名字规则：[a-zA-Z0-9_.-]</li><li>–restart  当由于某种错误，导致容器停止运行时， 该命令会检查容器的退出码，并据此来决定， 是否需要重启。默认的行为是 Docker 不会重启容器。<ul><li>always： 无论退出码是什么， docker 都会自动重启该容器</li><li>on-failure: 退出码为非 0 时，docker 会重启该容器， 还可接受一个重启次数的参数： <code>--restart=on-failure:3</code> <pre class=" language-bash"><code class="language-bash">docker run --name dylan_ubuntu_container -ti ubuntu /bin/bash</code></pre></li></ul></li></ul><p>docker run -ti -d –name daemon_test centos sh -c ‘while true;do echo hello world;sleep 3;done;’ </p><p>docker run –restart=always –name daemon_test centos sh -c ‘while true;do echo hello world;sleep 3;done;’ </p><p>docker run -d -p 8080 –name peifeng/first_image</p><h1 id="将容器中的-80-端口绑定到宿主机的-8080-端口"><a href="#将容器中的-80-端口绑定到宿主机的-8080-端口" class="headerlink" title="将容器中的 80 端口绑定到宿主机的 8080 端口"></a>将容器中的 80 端口绑定到宿主机的 8080 端口</h1><p>docker run -d -p 8080:80 –name peifeng/first_image</p><h1 id="绑定到特定的网络端口"><a href="#绑定到特定的网络端口" class="headerlink" title="绑定到特定的网络端口"></a>绑定到特定的网络端口</h1><p>docker run -d -p 127.0.0.1:8080:80 –name peifeng/first_image</p><h1 id="绑定到特定网络接口的随机端口"><a href="#绑定到特定网络接口的随机端口" class="headerlink" title="绑定到特定网络接口的随机端口"></a>绑定到特定网络接口的随机端口</h1><p>docker run -d -p 127.0.0.1::80 –name peifeng/first_image</p><h1 id="只指定-p-时，-会对外公开通过-Dockerfile中-EXPOSE-指令公开的的所有端口"><a href="#只指定-p-时，-会对外公开通过-Dockerfile中-EXPOSE-指令公开的的所有端口" class="headerlink" title="只指定 -p 时， 会对外公开通过 Dockerfile中 EXPOSE 指令公开的的所有端口"></a>只指定 -p 时， 会对外公开通过 Dockerfile中 EXPOSE 指令公开的的所有端口</h1><p>docker run -d -p –name peifeng/first_image</p><pre><code>### docker ps- -a  列出所有容器， 包括正在运行和已经停止的- -q  ： quiet ,只列出 container id，不返回其他信息- -l  last， 列出最后一个运行的容器， 无论其是在运行还是停止- -n x  列出最后运行的 x 个容器， 无论其是在运行还是停止### docker top container_id查看容器内的所有进程## docker stats container_id查看容器状态### docker exec在容器内部额外启动新进程。可以在容器内部运行的进程有两种：后台任务和交互式任务。- 后台任务在容器内运行且没有交互需求- 交互式任务保持在前台运行```bash# -d 表明需要运行一个后台进程docker exec -d daemon_task touch /etc/new_file# 启动一个打开 shell 的交互式任务docker exec -ti daemon_task /bin/bash</code></pre><h3 id="docker-stop-container-id"><a href="#docker-stop-container-id" class="headerlink" title="docker stop container_id"></a>docker stop container_id</h3><p>停止容器， stop 会向容器发送 SIGTERM 信号</p><h3 id="docker-kill-container-id"><a href="#docker-kill-container-id" class="headerlink" title="docker kill container_id"></a>docker kill container_id</h3><p>停止容器， kill 会向容器发送 SIGKILL 信号</p><h3 id="docker-rm-container-id"><a href="#docker-rm-container-id" class="headerlink" title="docker rm container_id"></a>docker rm container_id</h3><ul><li>-f ： Docker 1.6.2 开始， 使用 -f 标志来强制删除运行中的 Docker 容器。</li><li>无参， 需要先 stop or kill 掉该容器， 再 rm </li></ul><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 删除所有容器</span>docker <span class="token function">rm</span>  <span class="token variable"><span class="token variable">`</span>docker <span class="token function">ps</span> -aq<span class="token variable">`</span></span></code></pre><h3 id="docker-inspect"><a href="#docker-inspect" class="headerlink" title="docker inspect"></a>docker inspect</h3><ul><li>无参数  对容器进行详细的检查，然后返回其配置信息， 包括名称/命令/网络配置等</li><li>-f/–format  指定查看结果。 该标志支持完整的 Go 语言模板</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查看 docker 运行状态</span>docker inspect --format <span class="token string">'{{ .State.Running }}'</span> container_id</code></pre><h3 id="docker-search"><a href="#docker-search" class="headerlink" title="docker search"></a>docker search</h3><p>查找所有 Docker Hub 上公共的可用镜像</p><h3 id="docker-images"><a href="#docker-images" class="headerlink" title="docker images"></a>docker images</h3><ul><li>-a 列出本地所有镜像，含中间镜像层，不加 -a 会忽略中间镜像</li><li>-q 只显示镜像 id ， quiet</li><li>-f 过滤</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 列出特定的某个镜像，也就是说指定仓库名和标签</span>docker images ubuntudocker images ubuntu:12.04<span class="token comment" spellcheck="true"># 支持 go 语言模板</span>docker images --format <span class="token string">"{{ .ID }}:{{ .Registry }}"</span><span class="token comment" spellcheck="true"># -f 参数过滤</span>docker images -f label<span class="token operator">=</span>Language<span class="token operator">=</span>golang<span class="token comment" spellcheck="true"># 希望看到在 mongo:3.2 之后建立的镜像(之前用 before 即可)</span>docker images -f since<span class="token operator">=</span>mongo:3.2<span class="token comment" spellcheck="true"># 虚悬镜像已经失去了存在的价值，是可以随意删除的，可以用下面的命令删除。</span>docker rmi <span class="token variable"><span class="token variable">$(</span>docker images -q -f dangling<span class="token operator">=</span>true<span class="token variable">)</span></span><span class="token comment" spellcheck="true"># 在 Docker 1.13+ 版本中你可以便捷的使用以下命令来删除虚悬镜像。</span>docker image prune</code></pre><h3 id="docker-pull-name-tag"><a href="#docker-pull-name-tag" class="headerlink" title="docker pull name:tag"></a>docker pull name:tag</h3><p>拉取镜像</p><h3 id="docker-tag"><a href="#docker-tag" class="headerlink" title="docker tag"></a>docker tag</h3><p>给镜像打 tag</p><h2 id="一览图"><a href="#一览图" class="headerlink" title="一览图"></a>一览图</h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200422142830.jpg-growing" alt="Docker Commands"></p><hr><h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><p>linux 中 shell 提供了用户与 kernel 交互的接口，它将用户输入的命令送到 kernel 执行，是 kernel 与用户之间的解释器，相当于 kernel 的“外壳”。</p><p>在上文中，当我们使用 shell 方式执行命令时， shell 会通过 fork 的方式，复制一个子进程执行，当前 shell 作为父进程。</p><p>而当我们使用 exec 模式时，命令将在当前 shell 内执行，不会产生新的进程。</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://docs.docker.com/engine/reference/commandline/cli/" target="_blank" rel="noopener">Docker  Cli 官方文档</a></p><p><a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noopener">Docker Compose 官方文档</a></p><h2 id="Read-More"><a href="#Read-More" class="headerlink" title="Read More"></a>Read More</h2><p><a href="https://zhuanlan.zhihu.com/p/51034728" target="_blank" rel="noopener">Linux fork exec source 介绍</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker 系列&lt;二&gt; Docker 架构</title>
      <link href="/docker/core-components/"/>
      <url>/docker/core-components/</url>
      
        <content type="html"><![CDATA[<p>本文基于 docker 版本：</p><blockquote><p>Client: Docker Engine - Community<br> Version:           19.03.8</p><p>Server: Docker Engine - Community<br>  Version:          19.03.8</p></blockquote><h2 id="Cgroups-amp-Namespace"><a href="#Cgroups-amp-Namespace" class="headerlink" title="Cgroups &amp; Namespace"></a>Cgroups &amp; Namespace</h2><p>在介绍 Docker 之前，我打算先说一下 linux 的 cgroups 和 namespace</p><p>Cgroups 是 Control Groups 的简称， 是 linux 内核提供的一个功能。它允许将进程分组，然后可以限制和监控各种资源的使用情况。</p><pre class=" language-bash"><code class="language-bash">➜  ~ <span class="token function">cat</span> /proc/cgroups<span class="token comment" spellcheck="true">#subsys_name    hierarchy       num_cgroups     enabled</span>cpuset  6       2       1cpu     7       60      1cpuacct 7       60      1blkio   4       60      1memory  10      82      1devices 5       60      1freezer 9       2       1net_cls 12      2       1perf_event      8       2       1net_prio        12      2       1hugetlb 11      2       1pids    2       68      1rdma    3       1       1</code></pre><p>通过查看 cgroups 文件，我们可以看到 cgroups 可以管控的系统资源，包括 cpu、memory、io、网络等等。</p><p>也就是说，通过 cgroups，我们可以对一组进程进行内核资源管控。</p><hr><p>Namespace 能够对全局的系统资源，如 pid ，网络，用户，主机名等，进行抽象隔离，这使得其中的进程看起来，就好像是有自己的全局资源一样，也意味着不同 namespace 中的进程，可以拥有一样的 pid ，端口。一个 namespace 中的进程，其所有的 “全局资源” 是对同 namespace 中的其他进程可见的，但对非 namespace 中的进程不可见。</p><p>我们可以查看 <code>/proc/[pid]/ns</code> 目录：</p><pre><code>➜  ~ sudo ls -lh /proc/16310/ns[sudo] password for dylan:total 0lrwxrwxrwx 1 root root 0 Apr 18 02:30 cgroup -&gt; 'cgroup:[4026531835]'lrwxrwxrwx 1 root root 0 Apr 18 02:30 ipc -&gt; 'ipc:[4026531839]'lrwxrwxrwx 1 root root 0 Apr 18 02:30 mnt -&gt; 'mnt:[4026531840]'lrwxrwxrwx 1 root root 0 Apr 18 02:30 net -&gt; 'net:[4026531992]'lrwxrwxrwx 1 root root 0 Apr 18 02:30 pid -&gt; 'pid:[4026531836]'lrwxrwxrwx 1 root root 0 Apr 18 02:30 pid_for_children -&gt; 'pid:[4026531836]'lrwxrwxrwx 1 root root 0 Apr 18 02:30 user -&gt; 'user:[4026531837]'lrwxrwxrwx 1 root root 0 Apr 18 02:30 uts -&gt; 'uts:[4026531838]'</code></pre><p>同样能看到，ipc， mnt， net， pid 等公共资源的抽象。</p><hr><p>总结来说， namespace 让你能用什么， cgroups 让你能用多少。</p><h2 id="Docker-架构"><a href="#Docker-架构" class="headerlink" title="Docker 架构"></a>Docker 架构</h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200418205320.png-growing" alt="Docker Engine Components Flow"></p><p>这是一张 Docker 引擎的功能描述图。通过这张图，我们能看到 Docker 的基本结构划分以及包含的功能：</p><ul><li>cli ： docker 提供的命令行交互工具，通过 cli 提供的命令，可以管理网络(network)、容器(container)、镜像(image)、数据卷(data volume)</li><li>rest api ： 提供 HTTP API 接口给 cli</li><li>server ：我们常说的 docker daemon 守护进程，这是一个长期运行的进程，会处理来自 cli 的请求</li></ul><hr><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200418213949.png-growing" alt="Docker Architecture Diagram"></p><p>这张 Docker 的基础架构图，可以很好的告诉我们它的运行机制：</p><ol><li>client 端通过 cli 执行 <code>docker build/pull/run...</code> 等命令，发送给 dockerd(docker daemon ， 后简称为 dockerd) 。 cli 和 dockerd 之间可以通过 rest api 连接。 支持的连接协议有： linux 中分别为 tcp, unix, fd, windows 中为 tcp， npipe (源码： daemon/listeners::Init)</li><li>dockerd 收到命令后(假如命令为 <code>docker run nginx</code>) ， dockerd 一看本地并没有 nginx 镜像，就会去 docker registry 拉取 nginx 镜像(这里没有指定 nginx 版本，则会拉取 latest 版本)</li><li>拉取 nginx 镜像后，则会创建 nginx 容器的运行时。</li></ol><p>通过 <code>docker info</code> 命令，可以看到它的详细配置，其中有一个 <code>Docker Root Dir</code> ，为 docker 所有文件包括 image、container、overlay 等的存储位置，默认为 <code>/var/lib/docker</code> 。如果要修改，可以通过在 <code>/etc/docker/daemon.json</code> 中增加 <code>"graph":"YOUR_PATH"</code> 然后重启 dockerd 即可(注意要做好数据备份工作！！！)：</p><pre class=" language-json"><code class="language-json"><span class="token punctuation">{</span>  <span class="token property">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"https://xxx.mirror.aliyuncs.com"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token property">"graph"</span><span class="token operator">:</span> <span class="token string">"YOUR_PATH"</span><span class="token punctuation">}</span></code></pre><h2 id="Docker-各组件架构"><a href="#Docker-各组件架构" class="headerlink" title="Docker 各组件架构"></a>Docker 各组件架构</h2><p>我们以一个简单的流程，通过串联 Docker 源码，来讲述 Docker 的整个工作流程。</p><h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>Dockerfile ， 包括 Docker Cli Command 等内容，会放到下一篇文章。这里我们先准备一个异常简单的 Dockerfile， 同时把这个 Dockerfile 命名为 dockerfile.min ：</p><pre class=" language-dockerfile"><code class="language-dockerfile">From alpineCMD echo "Hello From iyuhp"</code></pre><h3 id="docker-build"><a href="#docker-build" class="headerlink" title="docker build"></a>docker build</h3><p>之后进行构建 ：</p><pre class=" language-bash"><code class="language-bash">➜  docker docker build <span class="token keyword">.</span> -t test/min:v0.1 -f ./dockerfile.minSending build context to Docker daemon  1.448MBStep 1/2 <span class="token keyword">:</span> From alpine ---<span class="token operator">></span> a187dde48cd2Step 2/2 <span class="token keyword">:</span> CMD <span class="token keyword">echo</span> <span class="token string">"Hello From iyuhp"</span> ---<span class="token operator">></span> Running <span class="token keyword">in</span> 392cd9c26109Removing intermediate container 392cd9c26109 ---<span class="token operator">></span> ae661fc7deaeSuccessfully built ae661fc7deaeSuccessfully tagged test/min:v0.1</code></pre><hr><p>在这一步， docker cli 运行命令 <code>docker build args...</code> 命令， 这个命令是怎么处理的呢？</p><p>这里要注意下，目前 docker cli 还在 <a href="https://github.com/docker/docker-ce" target="_blank" rel="noopener">这里</a></p><p>docker cli 使用 <a href="https://github.com/spf13/cobra" target="_blank" rel="noopener">spf13/cobra</a> (我们执行 docker –help 时候输出的一系列说明，就是这个东西搞的)，初始化时，会把一系列的命令初始化进去：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200419055855.png-growing" alt="docker cli 部分命令"></p><p>我们去看下 NewBuildCommand ：</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// NewBuildCommand creates a new `docker build` command</span><span class="token keyword">func</span> <span class="token function">NewBuildCommand</span><span class="token punctuation">(</span>dockerCli command<span class="token punctuation">.</span>Cli<span class="token punctuation">)</span> <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command <span class="token punctuation">{</span>    options <span class="token operator">:=</span> <span class="token function">newBuildOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    cmd <span class="token operator">:=</span> <span class="token operator">&amp;</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">{</span>        Use<span class="token punctuation">:</span>   <span class="token string">"build [OPTIONS] PATH | URL | -"</span><span class="token punctuation">,</span>        Short<span class="token punctuation">:</span> <span class="token string">"Build an image from a Dockerfile"</span><span class="token punctuation">,</span>        Args<span class="token punctuation">:</span>  cli<span class="token punctuation">.</span><span class="token function">ExactArgs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        RunE<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span>cmd <span class="token operator">*</span>cobra<span class="token punctuation">.</span>Command<span class="token punctuation">,</span> args <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>            options<span class="token punctuation">.</span>context <span class="token operator">=</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            <span class="token keyword">return</span> <span class="token function">runBuild</span><span class="token punctuation">(</span>dockerCli<span class="token punctuation">,</span> options<span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span>    <span class="token keyword">return</span> cmd<span class="token punctuation">}</span></code></pre><p>这个方法里， 当收到 <code>docker build ...</code>  命令时，会执行 <code>RunE</code> 方法 ， 然后执行 <code>runBuild</code> 方法：</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// cli/command/image/build.go:228</span><span class="token keyword">func</span> <span class="token function">runBuild</span><span class="token punctuation">(</span>dockerCli command<span class="token punctuation">.</span>Cli<span class="token punctuation">,</span> options buildOptions<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 如果设置了 DOCKER_BUILDKIT 环境变量为 1， 则使用 buildkit 构建镜像</span>    buildkitEnabled<span class="token punctuation">,</span> err <span class="token operator">:=</span> command<span class="token punctuation">.</span><span class="token function">BuildKitEnabled</span><span class="token punctuation">(</span>dockerCli<span class="token punctuation">.</span><span class="token function">ServerInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> buildkitEnabled <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">runBuildBuildKit</span><span class="token punctuation">(</span>dockerCli<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 否则通过 dockerd 构建镜像</span>    response<span class="token punctuation">,</span> err <span class="token operator">:=</span> dockerCli<span class="token punctuation">.</span><span class="token function">Client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ImageBuild</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> body<span class="token punctuation">,</span> buildOptions<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// client/image_build.go:20</span><span class="token keyword">func</span> <span class="token punctuation">(</span>cli <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">ImageBuild</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> buildContext io<span class="token punctuation">.</span>Reader<span class="token punctuation">,</span> options types<span class="token punctuation">.</span>ImageBuildOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span>types<span class="token punctuation">.</span>ImageBuildResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// ...</span>    serverResp<span class="token punctuation">,</span> err <span class="token operator">:=</span> cli<span class="token punctuation">.</span><span class="token function">postRaw</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token string">"/build"</span><span class="token punctuation">,</span> query<span class="token punctuation">,</span> buildContext<span class="token punctuation">,</span> headers<span class="token punctuation">)</span>    <span class="token keyword">return</span> types<span class="token punctuation">.</span>ImageBuildResponse<span class="token punctuation">{</span>        Body<span class="token punctuation">:</span>   serverResp<span class="token punctuation">.</span>body<span class="token punctuation">,</span>        OSType<span class="token punctuation">:</span> osType<span class="token punctuation">,</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p>  可以看到，cli 通过 rest api 发送给了 docker daemon。</p><hr><p>docker 封装了 api 层，也就是第一张图中的 REST API 部分。关于这一部分，可以在 <code>api/server/router</code> 目录中找到。docker 现在提供两种构建方式：</p><ul><li><p>基于 docker daemon 的第一代构建技术</p></li><li><p>基于 <a href="https://github.com/moby/buildkit" target="_blank" rel="noopener">bulidkit</a> 的构建技术，不依赖 docker daemon(竞品有 google 家的 <a href="https://github.com/GoogleContainerTools/kaniko" target="_blank" rel="noopener">kaniko</a> 以及 img， img 没有大厂背书)</p></li><li><p>docker 目前通过 <code>BuilderBuildKit</code> 来区分。在构建时， 加上 <code>BuilderBuildKit=1 docker build ...</code> 则可使用 buildkit：</p><pre class=" language-bash"><code class="language-bash">➜  docker DOCKER_BUILDKIT<span class="token operator">=</span>1 docker build <span class="token keyword">.</span> -t test/min:v0.1 -f ./dockerfile.min<span class="token punctuation">[</span>+<span class="token punctuation">]</span> Building 0.0s <span class="token punctuation">(</span>5/5<span class="token punctuation">)</span> FINISHED <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load build definition from dockerfile.min     0.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> transferring dockerfile: 41B     0.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load .dockerignore     0.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> transferring context: 2B     0.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">[</span>internal<span class="token punctuation">]</span> load metadata <span class="token keyword">for</span> docker.io/library/alpine:latest     0.0s <span class="token operator">=</span><span class="token operator">></span> CACHED <span class="token punctuation">[</span>1/1<span class="token punctuation">]</span> FROM docker.io/library/alpine     0.0s <span class="token operator">=</span><span class="token operator">></span> exporting to image         0.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> exporting layers      0.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> writing image sha256:13f822e3f1827d48d690e86dd2f30f1690e72f42f947db54b04b63597e0c2952 0.0s <span class="token operator">=</span><span class="token operator">></span> <span class="token operator">=</span><span class="token operator">></span> naming to docker.io/test/min:v0.1     0.0s</code></pre></li></ul><hr><p>镜像构建完成后，通过 <code>docker images</code>  可以找到：</p><pre class=" language-bash"><code class="language-bash">➜  docker docker imagesREPOSITORY       TAG                 IMAGE ID            CREATED            SIZEtest/min         v0.1                13f822e3f182        3 weeks ago         5.6MB</code></pre><hr><h3 id="docker-run"><a href="#docker-run" class="headerlink" title="docker run"></a>docker run</h3><p>到这一步， docker build 就执行完毕。现在我们来 <code>docker run</code> 一波， 看看会发生什么 ：</p><pre class=" language-bash"><code class="language-bash">➜  docker docker run 13f822e3f182Hello From iyuhp</code></pre><p>嗯，输出了我们希望输出的内容，说明我们构建的镜像是 OK 的。</p><p>同样的， docker cli 通过 <code>docker run...</code> 命令，调用 rest api 。不过这个命令需要分两步执行： <code>docker create</code> 和 <code>docker start...</code> ：</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// cli/command/container/run.go:96</span><span class="token keyword">func</span> <span class="token function">runContainer</span><span class="token punctuation">(</span>dockerCli command<span class="token punctuation">.</span>Cli<span class="token punctuation">,</span> opts <span class="token operator">*</span>runOptions<span class="token punctuation">,</span> copts <span class="token operator">*</span>containerOptions<span class="token punctuation">,</span> containerConfig <span class="token operator">*</span>containerConfig<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// create container</span>    createResponse<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> dockerCli<span class="token punctuation">,</span> containerConfig<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opts<span class="token punctuation">.</span>createOptions<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">// start container</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">ContainerStart</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> createResponse<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> types<span class="token punctuation">.</span>ContainerStartOptions<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">runStartContainerErr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// ...</span><span class="token punctuation">}</span></code></pre><p>我们先看看 docker create 都做了哪些事情：</p><pre class=" language-go"><code class="language-go"><span class="token comment" spellcheck="true">// Create creates a new container from the given configuration with a given name.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>daemon <span class="token operator">*</span>Daemon<span class="token punctuation">)</span> <span class="token function">create</span><span class="token punctuation">(</span>opts createOpts<span class="token punctuation">)</span> <span class="token punctuation">(</span>retC <span class="token operator">*</span>container<span class="token punctuation">.</span>Container<span class="token punctuation">,</span> retErr <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 1. 获取镜像 id</span>    <span class="token keyword">if</span> opts<span class="token punctuation">.</span>params<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Image <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{</span>        img<span class="token punctuation">,</span> err <span class="token operator">=</span> daemon<span class="token punctuation">.</span>imageService<span class="token punctuation">.</span><span class="token function">GetImage</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>params<span class="token punctuation">.</span>Config<span class="token punctuation">.</span>Image<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 2. 与镜像中的配置合并并验证</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> daemon<span class="token punctuation">.</span><span class="token function">mergeAndVerifyConfig</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>params<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errdefs<span class="token punctuation">.</span><span class="token function">InvalidParameter</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 3. 配置 container 的 log driver，若未配置，则使用 daemon 的 log driver</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> daemon<span class="token punctuation">.</span><span class="token function">mergeAndVerifyLogConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>opts<span class="token punctuation">.</span>params<span class="token punctuation">.</span>HostConfig<span class="token punctuation">.</span>LogConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errdefs<span class="token punctuation">.</span><span class="token function">InvalidParameter</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 4. 创建容器对象，包含容器配置，网络，Host，镜像等信息</span>    <span class="token keyword">if</span> container<span class="token punctuation">,</span> err <span class="token operator">=</span> daemon<span class="token punctuation">.</span><span class="token function">newContainer</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>params<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> os<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>params<span class="token punctuation">.</span>Config<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>params<span class="token punctuation">.</span>HostConfig<span class="token punctuation">,</span> imgID<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>managed<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 5. 增加读写层， 镜像层是只读的，增加读写层用来运行时的数据交互</span>    <span class="token comment" spellcheck="true">// Set RWLayer for container after mount labels have been set</span>    rwLayer<span class="token punctuation">,</span> err <span class="token operator">:=</span> daemon<span class="token punctuation">.</span>imageService<span class="token punctuation">.</span><span class="token function">CreateLayer</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token function">setupInitLayer</span><span class="token punctuation">(</span>daemon<span class="token punctuation">.</span>idMapping<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errdefs<span class="token punctuation">.</span><span class="token function">System</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    container<span class="token punctuation">.</span>RWLayer <span class="token operator">=</span> rwLayer    <span class="token comment" spellcheck="true">// 6. 创建一些列文件夹，用来保存容器信息， /var/lib/docker/containers/[id] 目录下</span>    <span class="token comment" spellcheck="true">// checkpoints, hostconfig.json, hostconfig.json</span>    rootIDs <span class="token operator">:=</span> daemon<span class="token punctuation">.</span>idMapping<span class="token punctuation">.</span><span class="token function">RootPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> idtools<span class="token punctuation">.</span><span class="token function">MkdirAndChown</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>Root<span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">,</span> rootIDs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> idtools<span class="token punctuation">.</span><span class="token function">MkdirAndChown</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span><span class="token function">CheckpointDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0700</span><span class="token punctuation">,</span> rootIDs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> daemon<span class="token punctuation">.</span><span class="token function">setHostConfig</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>params<span class="token punctuation">.</span>HostConfig<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 7. 注册到 dockerd 中</span>    <span class="token keyword">if</span> err <span class="token operator">:=</span> daemon<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err    <span class="token punctuation">}</span>    stateCtr<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span>ID<span class="token punctuation">,</span> <span class="token string">"stopped"</span><span class="token punctuation">)</span>    daemon<span class="token punctuation">.</span><span class="token function">LogContainerEvent</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token string">"create"</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> container<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span></code></pre><p><code>docker create</code> 主要就是完成 container 配置的初始化以及注册到 dockerd</p><hr><p>那么 <code>docker start</code> 做了什么呢？</p><ol><li><p>根据给定的 name(这个 name 可以是 container id，或者 container name ，或者 short container id) 获取 container 对象</p></li><li><p>查看 container 的状态，如果在 Paused， Running， Dead， RemovalInProgress 状态，则返回错误</p></li><li><p>验证 container 配置文件</p></li><li><p>挂载 RWLayer 读写层(TODO: 如何挂载)</p></li><li><p>初始化网络，设置 Hostname</p></li><li><p>创建容器 spec</p></li><li><p>调用 libcontainer runc 创建并运行容器， runc 负责和 linux kernel 打交道，最开始提到的 cgroups 和 namespace ，都是由 runc 来创建的</p></li></ol><p><strong>这里的部分，本渣目前还没有理清除，可以参考 <a href="https://www.infoq.cn/article/docker-source-code-analysis-part1" target="_blank" rel="noopener">这里</a> ， 以及该作者关于 Docker 的<a href="https://www.infoq.cn/profile/1278417/publish" target="_blank" rel="noopener">一系列文章</a></strong></p><hr><h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200420004124.jpg-growing" alt="Docker Detail Architecture"></p><hr><h2 id="Docker-Image"><a href="#Docker-Image" class="headerlink" title="Docker Image"></a>Docker Image</h2><p>镜像由 layer 构成，每一层 layer 对应 Dockerfile 中一个命令，比如：</p><pre class=" language-dockerfile"><code class="language-dockerfile">From alpineWORKDIR /iyuhpADD flag.txt .RUN rm flag.txtCMD echo "Hello From iyuhp"</code></pre><p>当我们执行 <code>docker build .</code> 时， 可以看到输出：</p><pre class=" language-bash"><code class="language-bash">➜  docker docker build <span class="token keyword">.</span> -t layer-test:v0.1 -f ./dockerfile.layer2Sending build context to Docker daemon  1.451MBStep 1/5 <span class="token keyword">:</span> From alpine ---<span class="token operator">></span> a187dde48cd2Step 2/5 <span class="token keyword">:</span> WORKDIR /iyuhp ---<span class="token operator">></span> Running <span class="token keyword">in</span> 2aca1ee61533Removing intermediate container 2aca1ee61533 ---<span class="token operator">></span> 9a4c07535dd2Step 3/5 <span class="token keyword">:</span> ADD flag.txt <span class="token keyword">.</span> ---<span class="token operator">></span> 10360de80e7cStep 4/5 <span class="token keyword">:</span> RUN <span class="token function">rm</span> flag.txt ---<span class="token operator">></span> Running <span class="token keyword">in</span> 4065ee172091Removing intermediate container 4065ee172091 ---<span class="token operator">></span> 8a0e76ce41b7Step 5/5 <span class="token keyword">:</span> CMD <span class="token keyword">echo</span> <span class="token string">"Hello From iyuhp"</span> ---<span class="token operator">></span> Running <span class="token keyword">in</span> c039ecab87ddRemoving intermediate container c039ecab87dd ---<span class="token operator">></span> 8b7004425461Successfully built 8b7004425461Successfully tagged layer-test:v0.1</code></pre><p>构建镜像时，docker 会对 Dockerfile 文件从上至下一行行执行，每次执行都会构建一层 layer (本质上也是一个 image)，构建完毕后，该 layer 则不可更改(readonly)。</p><p>docker layer 的实现，基于 <strong>Union FS</strong> ，即传说中的联合文件系统。</p><p>如果该层的操作对象在上一层(上面 Dockerfile 的第四步) ， docker 只会在该层将这个对象标记为删除，最后运行这个镜像的时候，这个对象你无法看到，表现为被删除。</p><p>而当我们 run image 的时候，docker 则会挂载一层 RWLayer，如果只需要读取底层 layer 的数据时，则直接去读取，但如果需要对底层数据做修改，则会先将该文件 copy 到 RWLayer ，再做修改，这就是常说的 <strong>COW</strong> (coyp-on-write) 技术。</p><h2 id="Docker-Registry"><a href="#Docker-Registry" class="headerlink" title="Docker Registry"></a>Docker Registry</h2><p>docker registry 是用来存储  docker image 的镜像仓库，类似于 github。通过 <code>docker pull</code> 、<code>docker push</code>  等命令，可以从 registry 拉取镜像或者将我们本地构建的镜像推送到 registry。</p><p>docker 提供官方的 <a href="https://hub.docker.com/" target="_blank" rel="noopener">Docker Hub</a>， 各大云厂商也都推出了自己的容器镜像服务。</p><p>当然，我们也可以基于 docker 提供的 registry 镜像，来构建我们自己的 docker registry，就好像我们搭建自己的 gitlab 一样。</p><h2 id="Docker-Network"><a href="#Docker-Network" class="headerlink" title="Docker Network"></a>Docker Network</h2><p>docker 的网络实现了插件化，意味着，你可以基于 docker network interface 来实现自己的网络插件，或者使用其他的网络插件。</p><p>docker 内置了以下几种 network driver：</p><ul><li>bridge：docker 默认的 network driver</li><li>host：共享宿主机的网络</li><li>overlay：可以实现不同 dockerd 之间的网络通信</li><li>macvlan：该模式下，可以为容器分配 mac 地址，使其在网络上显示为物理设备(不太清除…)</li><li>none：该模式下，将禁止网络连接</li></ul><p>这里以 bridge 模式为例。</p><h3 id="默认网络"><a href="#默认网络" class="headerlink" title="默认网络"></a>默认网络</h3><p>我们通过 <code>docker network ls</code> 查看时，会发现 docker 已经帮我们创建了三个类型的网络：</p><pre class=" language-bash"><code class="language-bash">➜  unionFS docker network <span class="token function">ls</span>NETWORK ID          NAME                DRIVER              SCOPE4b3d0dc09100        bridge              bridge              local847894dcaa28        host                host                localf8c096c91de0        none                null                local</code></pre><p>通过 <code>docker network inspect [id/name]</code> 可以查看该网络的具体信息(删除了部分内容)：</p><pre class=" language-bash"><code class="language-bash">➜  unionFS docker network inspect 4b3d0dc09100<span class="token punctuation">[</span>    <span class="token punctuation">{</span>        <span class="token string">"Name"</span><span class="token keyword">:</span> <span class="token string">"bridge"</span>,        <span class="token string">"Id"</span><span class="token keyword">:</span> <span class="token string">"4b3d0dc0910017d6bb7823e3415910ff7a7f9175d04cb29808ce627efcf9ad58"</span>,        <span class="token string">"Created"</span><span class="token keyword">:</span> <span class="token string">"2020-04-18T21:58:05.999876875+08:00"</span>,        <span class="token string">"Scope"</span><span class="token keyword">:</span> <span class="token string">"local"</span>,        <span class="token string">"Driver"</span><span class="token keyword">:</span> <span class="token string">"bridge"</span>,        <span class="token string">"EnableIPv6"</span><span class="token keyword">:</span> false,        <span class="token string">"IPAM"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>            <span class="token string">"Driver"</span><span class="token keyword">:</span> <span class="token string">"default"</span>,            <span class="token string">"Options"</span><span class="token keyword">:</span> null,            <span class="token string">"Config"</span><span class="token keyword">:</span> <span class="token punctuation">[</span>                <span class="token punctuation">{</span>                    <span class="token string">"Subnet"</span><span class="token keyword">:</span> <span class="token string">"172.17.0.0/16"</span>,                    <span class="token string">"Gateway"</span><span class="token keyword">:</span> <span class="token string">"172.17.0.1"</span>                <span class="token punctuation">}</span>            <span class="token punctuation">]</span>        <span class="token punctuation">}</span>,        <span class="token string">"Containers"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>            <span class="token string">"8b87032b8281671c043a33202efa022ddaa398bc42719d1fa1c3e1ca3245970f"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>                <span class="token string">"Name"</span><span class="token keyword">:</span> <span class="token string">"growing-uploader"</span>,                <span class="token string">"EndpointID"</span><span class="token keyword">:</span> <span class="token string">"227d88337cda67d632f48cf64a1b5e5c6607f560fe0e0dca8b09515d3fe29208"</span>,                <span class="token string">"MacAddress"</span><span class="token keyword">:</span> <span class="token string">"02:42:ac:11:00:02"</span>,                <span class="token string">"IPv4Address"</span><span class="token keyword">:</span> <span class="token string">"172.17.0.2/16"</span>,                <span class="token string">"IPv6Address"</span><span class="token keyword">:</span> <span class="token string">""</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>,        <span class="token string">"Options"</span><span class="token keyword">:</span> <span class="token punctuation">{</span>            <span class="token string">"com.docker.network.bridge.default_bridge"</span><span class="token keyword">:</span> <span class="token string">"true"</span>,            <span class="token string">"com.docker.network.bridge.enable_icc"</span><span class="token keyword">:</span> <span class="token string">"true"</span>,            <span class="token string">"com.docker.network.bridge.enable_ip_masquerade"</span><span class="token keyword">:</span> <span class="token string">"true"</span>,            <span class="token string">"com.docker.network.bridge.host_binding_ipv4"</span><span class="token keyword">:</span> <span class="token string">"0.0.0.0"</span>,            <span class="token string">"com.docker.network.bridge.name"</span><span class="token keyword">:</span> <span class="token string">"docker0"</span>,            <span class="token string">"com.docker.network.driver.mtu"</span><span class="token keyword">:</span> <span class="token string">"1500"</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">]</span></code></pre><p>这里向我们显示了该网络的：</p><ul><li>Driver： bridge，网桥模式</li><li>subnet ： 16位掩码</li><li>gateway ： 172.17.0.1</li><li>containers ：当前使用该网络的容器，这里能看到该容器的 id，ip 等信息</li><li>options ： 网络的其他设置，包括挂载的网桥 docker0(该网桥是 docker 在安装时创建的)， 网络的 mtu 为 1500 等等。这里说下 mtu，maximum transmission unit， 最大传输单元。如果我们的 mtu 设置的不合理，比如设置为 1400 ，那就有可能产生丢包问题</li></ul><p>其中， bridge 是 docker 默认的网络模式以及使用的网络。当我们去运行容器时，如果未通过 <code>--network</code> 来指定使用的网络时，则会使用 <code>bridge</code> 网络。</p><hr><h3 id="创建网络"><a href="#创建网络" class="headerlink" title="创建网络"></a>创建网络</h3><p>现在我们尝试创建一个自己的网络 ownbridge <sup>[1]</sup>：</p><pre class=" language-bash"><code class="language-bash">docker network create -d bridge --subnet 172.0.0.3/30 --gateway 172.0.0.1 ownbridge</code></pre><ul><li>-d 参数用来指定 network driver ，默认为 bridge</li><li>–sebnet 通过 cidr 格式指定网段</li><li>–gateway 指定网关</li><li>更多参数可通过 <code>docker network create -h</code> 获取</li></ul><p>现在，我们 build 一个 image ，然后使用上面的网络启动：</p><p><strong>Dockerfile</strong></p><pre class=" language-dockerfile"><code class="language-dockerfile">FROM busyboxRUN mkdir /html \        && echo "Hello World" > /html/index.htmlEXPOSE 1234CMD ["httpd",  "-f", "-p", "1234", "-h", "/html"]</code></pre><p><strong>docker build &amp;&amp; docker run</strong></p><ul><li><code>--network</code>   指定网络为 ownbridge</li><li>–rm ： 容器停止时删除容器</li><li>-p ： 将 1234 端口暴露到宿主机， -p 12306:1234 ， 则会将容器端口 1234 映射到宿主机 12306 上</li><li>-d ： 后台运行</li></ul><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># build</span>➜  docker docker build <span class="token keyword">.</span> -t simpelhttpd:v0.1// <span class="token punctuation">..</span>.Successfully built 1e3ceb976b97Successfully tagged simpelhttpd:v0.1<span class="token comment" spellcheck="true"># run 通过 --network 指定网络</span>➜  docker docker run --rm -p 1234 --network ownbridge -d 1e3ceb976b971ad1f5236ab5f95b2bf235f33cff494b43a77b7e414b85b067416ad9715b039c</code></pre><p><strong>Curl</strong></p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查看端口 可以看到是 0.0.0.0:32775 -> 1234/tcp </span><span class="token comment" spellcheck="true"># 即 docker 将容器内 1234 端口映射到了 32775 上</span>➜  docker docker <span class="token function">ps</span>                <span class="token comment" spellcheck="true"># Curl</span>➜  docker curl localhost:32775Hello World</code></pre><p>输出了 “Hello World” ， 就是我们在 Dockerfile 中写入到 index.html 中的内容</p><hr><h3 id="通信"><a href="#通信" class="headerlink" title="通信"></a>通信</h3><p>现在我们看看，curl 是怎么访问到我们的容器的。在此之前，我们整理下目前的信息：</p><p><strong>目标网络</strong></p><p>容器信息：</p><pre><code>"Gateway": "172.0.0.1","IPAddress": "172.0.0.2"</code></pre><p>它关联的网桥：</p><pre><code>176: br-814aff72d8df: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default    link/ether 02:42:83:a7:d1:16 brd ff:ff:ff:ff:ff:ff    inet 172.0.0.1/30 brd 172.0.0.3 scope global br-814aff72d8df       valid_lft forever preferred_lft forever    inet6 fe80::42:83ff:fea7:d116/64 scope link       valid_lft forever preferred_lft forever</code></pre><hr><p>在执行 curl 之前，宿主机经过 icmp + arp ，习得 arp 信息，放入本机的 arp 缓存表中。</p><p>访问前 arp 表：</p><pre class=" language-bash"><code class="language-bash">➜  docker arpAddress                  HWtype  HWaddress           Flags Mask            Iface_gateway                 ether   ef:ae:ae:ff:ff:ff   C                     eth0</code></pre><p>这个时候，在 arp 表中没有找到，则会进行广播 arp 报文，报文结构一般为:</p><p> dest mac | source mac | type </p><p>type 为 1 时表示 arp 请求， dest mac 为全 f 时(ff.ff.ff.ff.ff.ff) 即进行广播，具体信息请参考 Ref 部分的引用。</p><p>访问后 arp 表：</p><pre class=" language-bash"><code class="language-bash">➜  docker arp -nvvvAddress                  HWtype  HWaddress           Flags Mask            Iface172.16.11.253            ether   ef:ae:ae:ff:ff:ff   C                     eth0172.0.0.2                ether   02:42:ac:00:00:02   C                     br-814aff72d8df</code></pre><p>这里习得 172.0.0.2 对应的 mac 地址为  02:42:ac:00:00:02 。我们知道二层网络是基于 mac 地址通信的，常见的两层交换机的作用，就是通过 mac 地址转发。</p><hr><p>这里还要再说一句，在 bridge 模式下，docker 默认会为所有容器开放的端口起一个 docker-proxy 的进程，通过nat + iptables<sup>[2]</sup> 对该端口进行代理，该功能可以通过配置 <code>userland-proxy</code> 为 false 关闭。</p><p>通过 <code>sudo iptables -t nat -nL</code> 查看：</p><pre class=" language-bash"><code class="language-bash">➜  docker <span class="token function">sudo</span> iptables -t nat -nLChain DOCKER <span class="token punctuation">(</span>2 references<span class="token punctuation">)</span>target     prot opt <span class="token function">source</span>               destinationRETURN     all  --  0.0.0.0/0            0.0.0.0/0RETURN     all  --  0.0.0.0/0            0.0.0.0/0DNAT       tcp  --  0.0.0.0/0            0.0.0.0/0            tcp dpt:32775 to:172.0.0.2:1234</code></pre><p>查看 iptables nat 表，能看到，所有访问 32775 端口的请求，都被转发到 <code>172.0.0.2:1234</code> 这儿了。</p><hr><p>于是宿主机查询自己的路由表：</p><pre class=" language-bash"><code class="language-bash">➜  docker route -nvvvDestination     Gateway         Genmask         Flags Metric Ref    Use Iface0.0.0.0         172.16.11.253   0.0.0.0         UG    100    0        0 eth0172.0.0.0       0.0.0.0         255.255.255.252 U     0      0        0 br-814aff72d8df</code></pre><p>第一条中的 <code>0.0.0.0</code> 意为默认路由，即所有不存在该路由表中的请求，都会由它路由到下一跳 <code>172.16.11.253</code> 。</p><p>而我们的 ip 为 <code>172.0.0.2</code> ，根据路由表规则，会被网卡 br-814aff72d8df 处理。</p><p>docker 通过 veth pair <sup>[3]</sup>，与 网卡 br-814aff72d8df  连接，也就是说，上面的请求，最终被发送给我们此行的目的地。</p><hr><h3 id="Network-Flow"><a href="#Network-Flow" class="headerlink" title="Network Flow"></a>Network Flow</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200421011457.png-growing" alt="Container Network Flow"></p><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><h3 id="1"><a href="#1" class="headerlink" title="[1]"></a>[1]</h3><p><code>--subnet 172.0.0.1/30</code> ：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200420152242-growing" alt="网络地址划分"></p><p>我们知道，通常将 ip 地址分为 A 类、B 类、C 类地址，ip 地址可以用一个长 32 位的二进制数表示。这其中又分为网络地址 + 主机地址。</p><p>对于 A 类地址而言，其前八位表示网络地址，后 24 位表示主机地址。ip 寻址，就是先通过寻找网络地址，然后再寻找主机地址。</p><p>上面的划分，会导致 ipv4 资源的浪费，于是诞生了 <code>CIDR</code> ， 上面的 <code>172.0.0.1/30</code> 就是其表现形式。这是什么含义呢?</p><p>前面的 ip 可以转化位一个 32 位的二进制数， <code>30</code> 表示前 32 位为网络地址，将前 30 位置为 1， 即为它的子网掩码，这里为： <code>255.255.255.252</code>，则主机地址只能是剩下的后两位表示，也就是总共可以产生 2<sup>2</sup> = 4 个 ip ，即 172.0.0.[0-3] ，通常，会有一些特殊的 ip 不会被分配，用来作为广播、网关等作用，所以通常会减去 2，作为实际可用的 ip 数。</p><p><strong>如何判断两个 ip 是否在同一网段？</strong></p><ul><li>对于 A， ip B 与掩码 A 做与运算，得到的与自己子网一致</li><li>对于 B， ip A 与掩码 B 做与运算，得到的与自己子网一致</li></ul><p>假设两个 ip A ： 172.168.0.1/16， ip B ： 172.168.3.1/24</p><p>于是我们得到：</p><ul><li>ip A ： 172.168.0.1</li><li>掩码 A： 172.168.0.0</li><li>ip B：172.168.3.1</li><li>掩码 B：172.168.3.0</li></ul><p>则 A 运算后，得到子网 ip B &amp; 掩码 A = 172.168.0.0/16 </p><p>B 运算后， 得到子网 ip A &amp; 掩码 B = 172.168.3.0/24</p><p>一致，所以他们在同一网段。</p><p>如果 A 变为 172.168.3.1/16， B 变成 172.168.0.1/24 ， 则不在同一网段了。因为 B 运算后的结果为： 172.168.3.0/24 ，与自己的 172.168.0.0/24 不一致。</p><h3 id="2"><a href="#2" class="headerlink" title="[2]"></a>[2]</h3><p>iptables 内置四张 table ，执行顺序为 raw &gt; mangle &gt; nat &gt; filter</p><p>我们执行 <code>sudo iptables -nL</code> 时， 默认 table 为 filter。</p><p>docker 在做 port 映射时， 会分别向 nat 和 filter 两张表写入信息。我们在查找的时候，需要查看两张表的信息。</p><p>同理， 我们甚至可以手动修改 iptables ，来达到宿主机内不同容器间的通信。</p><h3 id="3"><a href="#3" class="headerlink" title="[3]"></a>[3]</h3><p>如何查看 docker veth pair，这里提供两种方式</p><ol><li><p>先查看容器内 veth pair，然后通过 ip a 查看：</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 107a4446c1f5 对应具体的 container id</span>➜  docker docker <span class="token function">exec</span> -ti 107a4446c1f5 sh -c <span class="token string">'cat /sys/class/net/eth0/iflink'</span>214<span class="token comment" spellcheck="true"># 这里看到是 214， 然后通过 ip link 查看</span>➜  docker ip <span class="token function">link</span> <span class="token operator">|</span> <span class="token function">grep</span> 214:214: veth9ea7c64@if213: <span class="token punctuation">..</span>.<span class="token comment" spellcheck="true"># 所以这里 veth9ea7c64 就是和上面 container 的 veth pair</span></code></pre></li><li><p>通过 docker inspect + ethtool</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查找 net namespace</span>➜  docker docker inspect --format<span class="token operator">=</span><span class="token string">'{{ .NetworkSettings.SandboxKey}}'</span> 107a4446c1f5/var/run/docker/netns/047bec4e1b1c<span class="token comment" spellcheck="true"># 去容器内部查看 veth</span>➜  docker <span class="token function">sudo</span> nsenter --net<span class="token operator">=</span>/var/run/docker/netns/047bec4e1b1c <span class="token function">ethtool</span> -S eth0NIC statistics:     peer_ifindex: 214     rx_queue_0_xdp_packets: 0     rx_queue_0_xdp_bytes: 0     rx_queue_0_xdp_drops: 0<span class="token comment" spellcheck="true"># 通过 ip link 查看</span>➜  docker ip <span class="token function">link</span> <span class="token operator">|</span> <span class="token function">grep</span> 214:214: veth9ea7c64@if213: <span class="token punctuation">..</span>.</code></pre></li></ol><p>这个 <code>nsenter</code> 的命令对于调试容器貌似挺有用的，需要学习一波。</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://man7.org/linux/man-pages/man7/cgroups.7.html" target="_blank" rel="noopener">Cgroups</a></p><p><a href="http://man7.org/linux/man-pages/man7/namespaces.7.html" target="_blank" rel="noopener">Namespace</a></p><p><a href="https://www.infoq.cn/article/docker-source-code-analysis-part1" target="_blank" rel="noopener">InfoQ 源码分析</a></p><p><a href="https://zh.wikipedia.org/wiki/ARP" target="_blank" rel="noopener">ARP Wiki</a></p><h2 id="Read-More"><a href="#Read-More" class="headerlink" title="Read More"></a>Read More</h2><p><a href="http://jm.taobao.org/2017/07/27/20170727/" target="_blank" rel="noopener">丢包问题</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Docker 系列&lt;一&gt; Docker 安装</title>
      <link href="/docker/introduction/"/>
      <url>/docker/introduction/</url>
      
        <content type="html"><![CDATA[<h2 id="Docker-是什么"><a href="#Docker-是什么" class="headerlink" title="Docker 是什么"></a>Docker 是什么</h2><p><a href="https://github.com/moby/moby" target="_blank" rel="noopener">Github Docker</a></p><p>我们常常说，“在我电脑上跑的好好的啊！怎么你这就不行了？”</p><p>由于各式各样的环境配置，总是能导致我们辛辛苦苦写出来的代码，遇到各种问题。</p><p>虚拟机是个不错的解决方案。然而虚拟机是一个完整的操作系统，需要为它开辟指定的内存和磁盘，这些系统资源并不会因为你的服务没有占用而释放，同时，也因为是一个完整的操作系统，启动必然很慢。</p><p>后来 linux 开发出了 LXC(Linux Containers) 技术，所谓的内核容器虚拟化技术。它通过 linux 内核提供的 cgroups 和 namespace  特性，能很好的实现容器虚拟化。</p><p>那么 cgroups 和 namespace 又是什么东西呢？这里先不说。</p><p>Docker 的早期版本中，LXC 作为底层架构的一个模块，用来创建容器，现在用的则是自己开发的 <code>libcontainer</code> 。无论是 LXC 还是 libcontainer ，都离不开 cgroup 和 namespace。</p><p>Docker 的主旨是 BUILD，SHIP，RUN ，即构建镜像，装进仓库，启动镜像。通常对应三个命令：</p><pre class=" language-bash"><code class="language-bash">docker build docker pushdocker run</code></pre><p>Docker 相比传统的虚机，能用更少的<strong>资源</strong>、更小的<strong>体积</strong>、更方便的<strong>操作</strong>以及更快的<strong>速度</strong>启动我们的服务。</p><h2 id="Docker-单机版安装-Linux-版"><a href="#Docker-单机版安装-Linux-版" class="headerlink" title="Docker 单机版安装(Linux 版)"></a>Docker 单机版安装(Linux 版)</h2><p>内核版本及硬件平台(hardware-platform)</p><pre class=" language-bash"><code class="language-bash">➜  ~ <span class="token function">uname</span> -ir4.18.0-147.5.1.el8_1.x86_64 x86_64</code></pre><p>操作系统发行版本</p><pre class=" language-bash"><code class="language-bash">➜  ~ lsb_release -aLSB Version:    :core-4.1-amd64:core-4.1-noarchDistributor ID: CentOSDescription:    CentOS Linux release 8.1.1911 <span class="token punctuation">(</span>Core<span class="token punctuation">)</span>Release:        8.1.1911Codename:       Core</code></pre><p>Docker 提供社区版和 pro 版本，分别叫做 CE(Community Edition) 和 EE(Enterprise Edition)，我们肯定选 CE，毕竟 EE 可是要收费的。</p><h3 id="0-卸载-Docker"><a href="#0-卸载-Docker" class="headerlink" title="0. 卸载 Docker"></a>0. 卸载 Docker</h3><p>如果之前没有安装过 Docker ，这一步可直接忽略。我会先卸载，再重新安装一次。</p><p>ps：如果只有 yum ，需要将下述命令的 dnf 改成 yum</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 官方给的删除方案</span><span class="token function">sudo</span> dnf remove docker \                  docker-client \                  docker-client-latest \                  docker-common \                  docker-latest \                  docker-latest-logrotate \                  docker-logrotate \                  docker-ce</code></pre><p>这个时候，我们需要再看下还有没有未删除的：</p><pre class=" language-bash"><code class="language-bash">➜  ~ <span class="token function">sudo</span> dnf list installed  <span class="token operator">|</span> <span class="token function">grep</span> dockerRepository epel is listed <span class="token function">more</span> than once <span class="token keyword">in</span> the configurationdocker-ce-cli.x86_64                        1:19.03.8-3.el7                                  @docker-ce-stable</code></pre><p>可以看到，还有 cli (当然你可以不删除)，这里我把它也删掉：</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> dnf -y remove docker-ce-cli</code></pre><p>如果你想删除的十分彻底，你甚至可以这样做（<strong>请务必保证你知道你在干什么</strong>）</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 这会把你之前下载的镜像、容器、网络、卷等等，一起干掉，请务必小心！！！</span><span class="token function">sudo</span> <span class="token function">rm</span> -rf /var/lib/docker<span class="token comment" spellcheck="true"># 有关 docker 的一些配置，如 registry mirror， 登录信息等</span><span class="token function">sudo</span> <span class="token function">rm</span> -fr /etc/docker<span class="token function">sudo</span> <span class="token function">rm</span> -fr ~/.docker</code></pre><p>到这里， 你机器上有关 docker 的东西就都删除完毕了。</p><h3 id="1-设置-docker-源-非必须"><a href="#1-设置-docker-源-非必须" class="headerlink" title="1. 设置 docker 源(非必须)"></a>1. 设置 docker 源(非必须)</h3><p>我们为什么要设置源，因为这能让我们安装的更加快速。</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># yum 用户请安装 yum-utils ， 可以提供 yum-config-manager</span><span class="token function">sudo</span> yum <span class="token function">install</span> -y yum-utils</code></pre><p>这里我们使用 <a href="http://mirrors.aliyun.com/docker-ce/linux/centos/" target="_blank" rel="noopener">阿里云  docker-ce.repo</a> </p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> dnf config-manager \--add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<span class="token comment" spellcheck="true"># yum 用户这样操作：</span><span class="token function">sudo</span> yum-config-manager \ --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo <span class="token function">sudo</span> dnf makecache <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> yum makecache <span class="token comment" spellcheck="true"># 查看安装的源</span> dnf repolist  <span class="token comment" spellcheck="true"># 或者 </span> yum repolist</code></pre><h3 id="2-安装-Docker"><a href="#2-安装-Docker" class="headerlink" title="2. 安装 Docker"></a>2. 安装 Docker</h3><p>Docker 官方提供了三种安装方式：</p><ul><li>通过 docker repo 安装(<strong>推荐</strong>)</li><li>下载 RPM package 安装</li><li>通过脚本安装</li></ul><p>这里我们使用第一种安装方式，后两种请参考 <a href="https://docs.docker.com/engine/install/centos/#install-from-a-package" target="_blank" rel="noopener">这里</a></p><hr><blockquote><p>查看 Dokcer 版本</p></blockquote><pre class=" language-bash"><code class="language-bash">➜  ~ dnf list docker-ce --showduplicates <span class="token operator">|</span> <span class="token function">sort</span> -r <span class="token operator">|</span> <span class="token function">head</span> -n 3docker-ce.x86_64            3:19.03.8-3.el7                     docker-ce-stabledocker-ce.x86_64            3:19.03.7-3.el7                     docker-ce-stable➜  ~ dnf list docker-ce-cli --showduplicates <span class="token operator">|</span> <span class="token function">sort</span> -r <span class="token operator">|</span> <span class="token function">head</span> -n 3docker-ce-cli.x86_64              1:19.03.8-3.el7               docker-ce-stabledocker-ce-cli.x86_64              1:19.03.7-3.el7               docker-ce-stable</code></pre><hr><blockquote><p>安装 Docker 的指定版本</p></blockquote><p>我们先按照官网给的步骤走一遍：</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 这里注意下 docker ce 和 cli 的版本，去冒号 : 和中划线 - 之间的部分， 我这里选的 19.03.8</span><span class="token function">sudo</span> dnf -y <span class="token function">install</span> docker-ce-19.03.8 docker-ce-cli-19.03.8 containerd.io<span class="token punctuation">..</span>.Installed:docker-ce-3:19.03.8-3.el7.x86_64  docker-ce-cli-1:19.03.8-3.el7.x86_64   libcgroup-0.41-19.el8.x86_64</code></pre><p>使用了阿里云的 repo 后，安装一下子快乐起来，很开心。</p><p>可以看到，我们安装了</p><ul><li>docker-ce-3:19.03.8-3.el7.x86_64</li><li>docker-ce-cli-1:19.03.8-3.el7.x86_64</li><li>libcgroup-0.41-19.el8.x86_64</li></ul><hr><h3 id="3-Docker-开机自启动"><a href="#3-Docker-开机自启动" class="headerlink" title="3. Docker 开机自启动"></a>3. Docker 开机自启动</h3><p>这个时候，如果我们运行 <code>docker version</code> ，会提示 docker daemon 无法连接。因为 Docker 是 CS 架构，docker daemon 此时还未启动。</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 启动 docker daemon</span><span class="token function">sudo</span> systemctl start docker<span class="token function">sudo</span> systemctl status docker <span class="token comment" spellcheck="true"># 此时可以看到 docker 处于 active(running) 状态</span><span class="token comment" spellcheck="true"># 设置开机自启动</span><span class="token function">sudo</span> systemctl <span class="token function">enable</span> docker</code></pre><hr><blockquote><p>Docker 验证</p></blockquote><pre><code>sudo docker run hello-world</code></pre><p>输出了一大堆东西，可是我们还是看到了 Hello from Docker! 字样，说明我们 Docker 已经可以正常工作了。</p><p><code>docker run</code> 这个命令，事实上做了两个动作</p><ul><li>docker pull ： 发现没有 hello-world 镜像时，先 pull 镜像，然后再 run</li><li>docker run ： 运行 hello-world 镜像</li></ul><hr><h3 id="4-非-root-账号使用-Docker"><a href="#4-非-root-账号使用-Docker" class="headerlink" title="4. 非 root 账号使用 Docker"></a>4. 非 root 账号使用 Docker</h3><p>docker 会创建 docker group，我们可以把自己加入到该用户组，以避免通过 root 来使用 docker</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 当前所在组</span><span class="token function">groups</span>dylan wheel nginx<span class="token comment" spellcheck="true"># 查看 docker 用户组是否已存在</span><span class="token function">sudo</span> <span class="token function">cat</span> /etc/group <span class="token operator">|</span> <span class="token function">grep</span> docker<span class="token comment" spellcheck="true"># 把当前用户加入 docker 组</span><span class="token function">sudo</span> <span class="token function">usermod</span> -aG docker <span class="token variable">$USER</span><span class="token comment" spellcheck="true"># 更新用户组</span>newgrp docker<span class="token comment" spellcheck="true"># 再次查看，已经计入了 docker 用户组</span><span class="token function">groups</span>docker wheel nginx dylan</code></pre><p>通过 <code>docker version</code> 查看，版本为 <code>19.03.8</code> ，完美。</p><pre class=" language-bash"><code class="language-bash">➜  ~ docker versionClient: Docker Engine - Community Version:           19.03.8Server: Docker Engine - Community Engine:  Version:          19.03.8</code></pre><p>至此，Docker 安装就结束了。</p><h3 id="5-镜像加速"><a href="#5-镜像加速" class="headerlink" title="5. 镜像加速"></a>5. 镜像加速</h3><p>如果你使用阿里云，可以在 <a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors" target="_blank" rel="noopener">这里</a> 找到你的镜像加速专属地址：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200418023257.png-growing" alt="docker image 加速器"></p><p>其他镜像加速地址：</p><ul><li>七牛云： <a href="https://reg-mirror.qiniu.com" target="_blank" rel="noopener">https://reg-mirror.qiniu.com</a></li><li>中科大： <a href="https://docker.mirrors.ustc.edu.cn" target="_blank" rel="noopener">https://docker.mirrors.ustc.edu.cn</a></li><li>网易云： <a href="https://hub-mirror.c.163.com" target="_blank" rel="noopener">https://hub-mirror.c.163.com</a></li><li>腾讯云： <a href="https://mirror.ccs.tencentyun.com" target="_blank" rel="noopener">https://mirror.ccs.tencentyun.com</a></li></ul><h2 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h2><p><a href="http://mirrors.aliyun.com/" target="_blank" rel="noopener">阿里云开源镜像站</a> ： 这个可以说很良心了，基本上涵盖了国外的很多软件，更新也很及时，deserve it。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Middlewares -- Redis&lt;完&gt;</title>
      <link href="/redis/lock/"/>
      <url>/redis/lock/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis-Lock"><a href="#Redis-Lock" class="headerlink" title="Redis Lock"></a>Redis Lock</h2><p>当我们想通过 redis 涉及一个分布式锁时，第一时间必然是想到 strings <code>set</code> 命令：</p><pre class=" language-bash"><code class="language-bash"><span class="token keyword">set</span> r_lock random_value PX 10000 NX    </code></pre><ul><li>r_lock ： key ， 锁名称，可以是任何一个值</li><li>random_value ： 客户端设置锁的时候给定的一个 unique 的值</li><li>PX ： 过期时间 ， 毫秒， 这里为 10 s</li><li>NX ： not exist ，即当 key r_log 不存在时才会成功</li></ul><p>当 client 获取锁时，尝试该命令，如果成功表明获得锁。</p><hr><p>这样实现有什么问题呢？</p><ol><li><p>client  A 获得锁后， 由于业务处理时间过长或其他原因，未及时释放锁，超时后被自动释放，client B 获取到锁，此时 A 业务处理完成，释放锁， 执行 <code>del  key r_lock</code> , client B 的锁被删除…</p></li><li><p>client 获得锁后，直接挂掉 …</p></li><li><p>client A 获取锁释放后，其他等待的 client 不能及时知道这个信息，他们仍然再等待一个固定的轮询时间</p></li><li><p>对同一个线程而言，应该有重入的机制</p></li><li><p>client A 获取锁，设置超时时间 15s ，但是实际业务处理时间为 20s。虽然 client A 一切正常，但是在 15s 后，锁仍然被释放掉了…</p></li><li><p>redis cluster 模式下，client c1 从 redis server A 处获得锁，A 宕机，数据还未同步给 slave_A， slave_A 被选为 master，当 client c2 尝试获取锁时，成功获得锁…</p></li></ol><hr><p>对于第一个问题，我们通过 random_value 可以解决。每个尝试释放锁的动作，都需要先校验设置的 value 值，如果一致，才允许 <code>del</code> 操作。所以当 A 尝试释放锁的时候，因为 value 早已改变，它就无法删除属于 B 的锁了。这个删除动作，应该是一个原子操作，可以用下面的 lua 脚本来描述：</p><pre class=" language-lua"><code class="language-lua"><span class="token keyword">if</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"get"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> ARGV<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token keyword">then</span>    <span class="token keyword">return</span> redis<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">"del"</span><span class="token punctuation">,</span> KEYS<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">else</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token keyword">end</span></code></pre><p>对于问题二，如果没有其他措施，则会形成死锁。我们可以通过给锁加上过期时间，来解决这个问题。即便 client 掉线，锁时间到期后，会被 redis 删除，其他 client 可以继续获取锁，这里通过  <code>set ... PX 10000</code> 来设置过期时间</p><p>对于问题三，可以理解为对取锁机制的优化，在 redisson 中，通过 pub/sub 来解决这个问题。redisson 在第一次尝试获取锁的时候，如果没有获取到，就会监听 <code>redisson_lock__channel:{r_lock}</code> 这个 channel。</p><p>获取到锁的 client 在用完锁后，会 publish 一条消息 <code>PUBLISH redisson_lock__channel:{_lock_} 1</code> ， 等待的 client 收到消息后，就可以继续竞争，而不用等到下一次的轮询到来才开始</p><p>对于问题四，可以认为是一个类似 JAVA <code>ReentrantLock</code> , 在 redisson 的实现中，并非通过 <code>set</code> 原语而是 <code>hset</code> ， field 是当前线程的 id ，这样的话，当通过一个线程来获取锁的时候，我就给 field 的 value 加一，而释放锁的时候，一直减一，直到为 0 时，删除该 key 即可。</p><p>对于问题五， 在 redisson 中，通过开启一个 Timer 来处理过期问题：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> RFuture<span class="token operator">&lt;</span>Long<span class="token operator">></span> <span class="token function">tryAcquireAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> TimeUnit unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> RedisCommands<span class="token punctuation">.</span>EVAL_LONG<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        RFuture<span class="token operator">&lt;</span>Long<span class="token operator">></span> ttlRemainingFuture <span class="token operator">=</span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>commandExecutor<span class="token punctuation">.</span><span class="token function">getConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCfg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLockWatchdogTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> RedisCommands<span class="token punctuation">.</span>EVAL_LONG<span class="token punctuation">)</span><span class="token punctuation">;</span>        ttlRemainingFuture<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ttlRemaining<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment" spellcheck="true">// lock acquired</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ttlRemaining <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 该方法最终会开启一个定时 Timer 用来处理 key 过期问题</span>                <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> ttlRemainingFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span></code></pre><p>可以看到，当 <font color="red"><strong>leaseTime 不为 -1</strong></font> 时 ,也就是我们执行 lock() 方法时，设置了超时时间，如 <code>lock.lock(15, TimeUnit.SECONDS);</code> 时，redisson 不会对 key 延时。</p><p>不设置时，则会最终执行如下方法：</p><pre class=" language-java"><code class="language-java">Timeout task <span class="token operator">=</span> commandExecutor<span class="token punctuation">.</span><span class="token function">getConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newTimeout</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token annotation punctuation">@Override</span>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span>Timeout timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// ...</span>                RFuture<span class="token operator">&lt;</span>Boolean<span class="token operator">></span> future <span class="token operator">=</span> <span class="token function">renewExpirationAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// ...</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> internalLockLeaseTime <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p><code>internalLockLeaseTime</code>(可配置 <code>cfg.setLockWatchdogTimeout(45 * 1000L);</code> ) 默认为 30s， 这里取 1/3 即 10s (此时则为 15s)，即每 10s( 15s ) 执行一次，直到当前线程执行完毕</p><p>对于最后一个问题，redis 给出了一个叫做 <strong>redLock</strong> 的算法，参见 <a href="http://redis.cn/topics/distlock.html" target="_blank" rel="noopener">这里</a> ， 在 redisson 中，对应的实现为 <code>redLock</code> 。 </p><p>该算法认为，为了避免问题六，我们每次获取锁的时候，都需要获取集群中超过一半 master 的锁，也就是需要在超过一半的 master 上申请锁，只有超过半数，本次获取锁的动作才认为成功。</p><p>不过这种做法实现起来很麻烦， 虽然 redisson 给出了实现，但实际使用依旧繁琐。如果无法容忍这样的极小概率事件，可以适当考虑下 zk 或其他更加可靠的分布式锁。</p><h2 id="LRU"><a href="#LRU" class="headerlink" title="LRU"></a>LRU</h2><p>即 least recently used， 最近最少使用。常用的中间件，基本都会有自己的 LRU 算法，用来回收内存。</p><p>redis 中可以通过</p><blockquote><p>maxmemory 100m</p></blockquote><p>这个配置来限制内存的使用，在 64 位系统，默认为 0 ，即不限制内存，在 32 位系统为 3G</p><hr><p>当达到指定的内存限制大小时，redis 通过不同的策略做出不同的回收行为，该策略可以通过</p><blockquote><p>maxmemory-policy </p></blockquote><p>来配置， redis 提供了以下可选项：</p><ul><li>noeviction：不驱逐，即不回收。此时 redis 会对增加内存的操作返回错误，del 等操作能正常执行</li><li>allkeys-lru：对所有的 key 进行 LRU</li><li>volatile-lru：只针对设置了过期时间的 key 进行 LRU</li><li>allkeys-random：随机清除所有 key 集合中的部分</li><li>volatile-random：随机清除设置了过期时间 key 中的部分</li><li>volatile-ttl：清除设置了过期时间的 key 集合中 TTL (存活时间) 较短的部分</li></ul><p>为 key 设置过期时间，也会消耗内存，所以使用 <code>allkeys-lru</code> 会更加高效</p><hr><p>redis 中的 LRU 不是完整的 LRU ，它并不会根据策略取扫描所有的 key ，而是扫描样本数量的 key ，进行 LRU。样本数量可以进行配置：</p><blockquote><p>maxmemory-samples 5   # 5 是 redis 默认值</p></blockquote><p>这样做虽然不能真正做到 LRU ，但是能减少内存的消耗</p><p>我们可以通过 <code>config set maxmemory-samples 10</code> 来在运行时调整该值大小。 10 个样本，根据 redis 给出的数据，已经十分接近真实的 LRU</p><hr><p>现在我们实际操作下：</p><pre class=" language-bash"><code class="language-bash">➜  scripts-redis ./run.sh cliConnecting to redis server<span class="token punctuation">..</span>.Connected to 7000127.0.0.1:7000<span class="token operator">></span>127.0.0.1:7000<span class="token operator">></span>127.0.0.1:7000<span class="token operator">></span> CONFIG GET maxmemory-policy1<span class="token punctuation">)</span> <span class="token string">"maxmemory-policy"</span>2<span class="token punctuation">)</span> <span class="token string">"noeviction"</span>127.0.0.1:7000<span class="token operator">></span> CONFIG <span class="token keyword">set</span> maxmemory-policy allkeys-lruOK127.0.0.1:7000<span class="token operator">></span> CONFIG GET maxmemory-policy1<span class="token punctuation">)</span> <span class="token string">"maxmemory-policy"</span>2<span class="token punctuation">)</span> <span class="token string">"allkeys-lru"</span></code></pre><p>可以看到，此时集群的 <code>maxmemory-policy</code> 已经变成了 <code>allkeys-lru</code></p><p>我们可以通过 redis 提供的 lru test 工具来测试：</p><pre class=" language-bash"><code class="language-bash">redis-cli -a 123456 -p 7000 --lru-test 1000000</code></pre><p>本来想贴下跑完后的日志，结果…</p><pre class=" language-bash"><code class="language-bash">➜  scripts-redis <span class="token function">sudo</span> <span class="token function">grep</span> <span class="token string">"Out of memory"</span> /var/log/messages<span class="token punctuation">[</span>sudo<span class="token punctuation">]</span> password <span class="token keyword">for</span> dylan:Apr 15 12:12:11 iZbp10xxkuq2vc7q4vabqtZ kernel: Out of memory: Killed process 16397 <span class="token punctuation">(</span>redis-cli<span class="token punctuation">)</span> total-vm:452400kB, anon-rss:431280kB, file-rss:0kB, shmem-rss:0kB</code></pre><p>嗯，1G 内存，除去其他进程占用，实际只有 450M 左右可用… 我不跑了！</p><p>有兴趣可以自己跑一把，看看大概的 miss 是多少</p><h2 id="Expires"><a href="#Expires" class="headerlink" title="Expires"></a>Expires</h2><p>redis 常用的关于过期的命令</p><ul><li><p>expire key seconds ：设置指定 秒 后过期： expire key 10</p></li><li><p>pexpire key milliseconds ： 设置指定 毫秒 后过期： expire key 10000</p></li><li><p>expireat key seconds-timestamp ： 设置指定 时间戳 后过期，时间戳以秒计算 ： expireat key 1586868680</p></li><li><p>pexpiread key milliseconds-timestamp ： 设置指定 时间戳 后过期，时间戳以毫秒计算 ：  expireat key 1586868680000</p></li><li><p>persist key ： 取出一个 key 的过期时间 ： persist key</p></li><li><p>TTL / PTTL key ： 查看 key 的过期时间</p><ul><li>-1 ： key 存在且未设置过期时间</li><li>-2 ： key 不存在或已过期</li></ul></li></ul><hr><p>redis 什么时候会去回收 key ？</p><ul><li>每一次访问 key 的时候，会先判断 key 是否过期，过期就删除，也就是常说的 <strong>惰性删除</strong></li><li>redis 启动时会创建一个 cron ，定期清理部分过期的 key ，默认 10次/s 。也就是常说的<strong>定期删除</strong><ul><li>redis 会随机抽取 10 个 key (根据配置的 <code>maxmemory-samples</code> 确定)</li><li>删除其中过期的 key</li><li>如果过期的 key 超过样本的 25% ，则重复步骤 1，直到小于 25%</li></ul></li></ul><h2 id="One-More-Thing"><a href="#One-More-Thing" class="headerlink" title="One More Thing"></a>One More Thing</h2><p>几种常见的缓存算法</p><ul><li>LRU ： least recently used ，最近最少使用，则会被淘汰</li><li>LFU ： least frequently used ，最不经常使用，则会被淘汰</li><li>FIFO ： first in first out ， 先进先出，即最先进缓存，最先被淘汰</li></ul><p>我们假设一个定长为 3 的队列，依次存入数据 1，2，3 ，此时队列如下：</p><pre><code>head &lt;- 3 &lt;- 2 &lt;- 1 &lt;- tail</code></pre><p>  然后有 client 依次访问了 1，1，3，3，2 ，此时队列的顺序就变成了：</p><pre><code>head &lt;- 2 &lt;- 3 &lt;- 1 &lt;- tail # LRU 组织数据方式head &lt;- 3 &lt;- 1 &lt;- 2 &lt;- tail # LFU 组织数据方式</code></pre><p>此时按照 LRU ，则会淘汰数据 1 ， 而按照 LFU ，因为这段时间内， 数据 2 只被访问了一次，所以会淘汰数据 2</p><hr><p>关于 redis 的部分就可以暂时告一段落了  ​ ​ <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8">😅</span> </p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="http://redis.cn/topics/lru-cache.html" target="_blank" rel="noopener">Redis CN LRU</a></p><h2 id="Read-More"><a href="#Read-More" class="headerlink" title="Read More"></a>Read More</h2><p><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-buffer-pool.html" target="_blank" rel="noopener">MySQL LRU 实现</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Middlewares -- Redis&lt;二&gt;</title>
      <link href="/redis/cluster/"/>
      <url>/redis/cluster/</url>
      
        <content type="html"><![CDATA[<h1 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h1><p>关于 redis 集群，一般有以下几种模式</p><ul><li>主从复制模式(Master-Slave) ： 该模式下，所有的事务操作，都会异步同步到其他 slave 上，每台 redis 都存储相同数据</li><li>哨兵模式(Sentinel) ： 通过增加 sentinel 集群，管理 master-slave 下的节点，可以在 master 宕机时，选举新的 master 节点</li><li>Jedis sharding ：在客户端，对 key 进行 hash ，散列到不同的 redis 实例上</li><li>相关中间件如 codis ， twemproxy 等</li></ul><p>在 redis 3.0 版本及以上版本，官方提供了 redis cluster 功能。</p><h2 id="redis-cluster-简介"><a href="#redis-cluster-简介" class="headerlink" title="redis cluster 简介"></a>redis cluster 简介</h2><p>redis cluster 主要基于 CRC16 算法对 key 进行 hash ，然后散列到不同散列槽。</p><p>redis cluster 总共提供 16384 个hash 槽(slot) ，理论上，集群的最大节点数量最大乐意为 16384 个。不过 redis 官方给出的建议是不要超过 1000 的量级。</p><p>每个 redis instance 会负责这个散列槽中的一部分。</p><p><strong>新增</strong>或<strong>删除</strong>节点，对于 redis cluster 而言就是对 slot 进行 reshard，redis cluster 保证 slot 平滑移动</p><h3 id="1-key-hash-计算"><a href="#1-key-hash-计算" class="headerlink" title="1. key hash 计算"></a>1. key hash 计算</h3><p>redis cluster 会对大括号 <strong>{}</strong> 中的值计算 hash 值进行散列。</p><ul><li>只计算第一次出现  <strong>{}</strong> 的值，如果没有，则计算整个 key 的 hash 值， 如 <ul><li><code>key{key1}{key2}</code> ： 值计算 key1 的hash</li><li><code>keykey</code> ： 计算整个 keykey 的 hash</li></ul></li><li>如果只有 <strong>{</strong> ，没有 <strong>}</strong> ，或者 <strong>{}</strong> 中没有内容，则计算整个 key 的 hash 值， 如<ul><li><code>key{12</code> ： 计算整个 hash</li><li><code>key{}key</code> ： 计算整个 hash，这意味着所有以 <code>{}</code> 开头的 key ，都是整个计算 hash</li></ul></li></ul><p>源码如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">keyHashSlot</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> keylen<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> s<span class="token punctuation">,</span> e<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* start-end indexes of { and } */</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> s <span class="token operator">&lt;</span> keylen<span class="token punctuation">;</span> s<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'{'</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* No '{' ? Hash the whole key. This is the base case. */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> keylen<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">crc16</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>keylen<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3FFF</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* '{' found? Check if we have the corresponding '}'. */</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> s<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> e <span class="token operator">&lt;</span> keylen<span class="token punctuation">;</span> e<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'}'</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* No '}' or nothing between {} ? Hash the whole key. */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> keylen <span class="token operator">||</span> e <span class="token operator">==</span> s<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">crc16</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>keylen<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3FFF</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* If we are here there is both a { and a } on its right. Hash     * what is in the middle between { and }. */</span>    <span class="token keyword">return</span> <span class="token function">crc16</span><span class="token punctuation">(</span>key<span class="token operator">+</span>s<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>e<span class="token operator">-</span>s<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3FFF</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="2-集群拓扑结构"><a href="#2-集群拓扑结构" class="headerlink" title="2. 集群拓扑结构"></a>2. 集群拓扑结构</h3><p>redis cluster 是一个网状拓扑结构，每个 redis instance ，都会与其他 redis instance 建立连接，也就是说如果集群中有 n 个节点，则总共会有 n(n-1) 个连接，这些 TCP 连接会被永久保存，并非按需创建。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200414155611.png-growing" alt="redis cluster struct"></p><h3 id="3-集群工作"><a href="#3-集群工作" class="headerlink" title="3. 集群工作"></a>3. 集群工作</h3><p>client 发送请求 ，集群中某个节点接收到请求后，会查找内部 slot , node id 映射，如果是自己，执行命令返回结果，如果是其他节点，则会给 client 返回一个 <code>MOVED slot_id target_ip:port</code> 的错误。客户端需要根据返回的节点信息，再次执行命令。</p><p>注意，如果在此期间，目标节点出现故障，slot 发生了转移，则 client 仍需要根据返回的 ip:port 再次查询</p><h2 id="redis-cluster-搭建"><a href="#redis-cluster-搭建" class="headerlink" title="redis cluster 搭建"></a>redis cluster 搭建</h2><h3 id="1-安装-redis"><a href="#1-安装-redis" class="headerlink" title="1. 安装 redis"></a>1. 安装 redis</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> https://github.com/antirez/redis/archive/5.0.7.tar.gz<span class="token function">tar</span> -xvf ./5.0.7.tar.gz</code></pre><p>下载并解压后，你可以 <code>make</code> 一把，但你通过上面下载后，其实在 <code>src</code> 包里已经有可以使用的 redis server 等各个工具，可以直接使用。</p><p><a href="https://github.com/antirez/redis" target="_blank" rel="noopener">Redis Github</a> 上的安装步骤很详细，这里不再赘述</p><p>ps: 我是因为 make 之后跑 make test 时，一直挂掉，因为我内存实在太小… 所以就直接用了</p><h3 id="2-编辑配置文件"><a href="#2-编辑配置文件" class="headerlink" title="2. 编辑配置文件"></a>2. 编辑配置文件</h3><pre><code># 该集群阶段的端口port 7000# 是否后台启动daemonize yes# 我没有内存，这里设置 50mmaxmemory 50m# 为每一个集群节点指定一个 pid_filepidfile /home/dylan/tmp/scripts-redis/cluster/pid/pid_7000.pid#在bind指令后添加本机的ipbind 127.0.0.1####################################### file #######################loglevel noticelogfile /home/dylan/tmp/scripts-redis/cluster/log/log_7000.logdbfilename "dump.rdb"dir "/home/dylan/tmp/scripts-redis/cluster/data/7000"#################################### cluster ####################################cluster-enabled yes # 启用集群模式# 集群的配置，配置文件首次启动自动生成 , 不能人工编辑，是集群节点自动维护的文件cluster-config-file "/home/dylan/tmp/scripts-redis/cluster/config/nodes_7000.conf"cluster-node-timeout 5000# 配置后，通过 cli 连接需要通过 -a 123456 连接requirepass "123456"masterauth "123456"</code></pre><h3 id="3-复制多份配置文件并修改对应值"><a href="#3-复制多份配置文件并修改对应值" class="headerlink" title="3. 复制多份配置文件并修改对应值"></a>3. 复制多份配置文件并修改对应值</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200414195430.png-growing" alt="redis cluster folder"></p><p>如图所示，将 redis.conf 配置文件 copy 6 份(因为 redis 要求最少 3 master ，我们要每个 master 一个 slave ，那么这里就需要 6 个实例)，然后建好 conf 文件里配置的各个目录</p><h3 id="4-启动-redis-实例"><a href="#4-启动-redis-实例" class="headerlink" title="4. 启动 redis 实例"></a>4. 启动 redis 实例</h3><p><code>redis-server redis.conf</code> ，这个命令想必大家都很熟悉，这里就不再啰嗦。这里我们只需要依次启动 6 个实例即可。</p><p>我个人写了个小脚本，后面会贴上来。</p><h3 id="5-创建集群"><a href="#5-创建集群" class="headerlink" title="5. 创建集群"></a>5. 创建集群</h3><p>redis 提供了 <code>cluster create</code> 命令帮助我们创建 redis cluster </p><pre class=" language-bash"><code class="language-bash">redis-cli -a 123456 --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1</code></pre><p>执行该命令后，会有如下输出：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200414200359.png-growing" alt="redis create cluster"></p><p>通过 redis 输出的信息能看到，现在是 3 master 3 slave，每个 master 一个 slave 节点</p><h3 id="6-查看集群信息"><a href="#6-查看集群信息" class="headerlink" title="6. 查看集群信息"></a>6. 查看集群信息</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 注意 -c 参数，表示以集群方式登入</span>redis-cli -a 123456 -c -p 7000</code></pre><p>cluster 相关的命令，请参考 <a href="http://redis.cn/commands.html#cluster" target="_blank" rel="noopener">这里</a></p><p>这个时候我们 set 几个数据：</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:7000<span class="token operator">></span> <span class="token keyword">set</span> a a-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span>15495<span class="token punctuation">]</span> located at 127.0.0.1:7002OK127.0.0.1:7002<span class="token operator">></span> <span class="token keyword">set</span> b b-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span>3300<span class="token punctuation">]</span> located at 127.0.0.1:7000OK127.0.0.1:7000<span class="token operator">></span> keys *1<span class="token punctuation">)</span> <span class="token string">"b"</span></code></pre><p>可以看到，第一次 set a 时， 被路由到了 7002 节点，第二次 set b 时，路由到了 7000 也就是自己这儿，通过 keys * (请不要在生产环境使用该命令) 查看时， 只有 key b (kb…) ， key a 不会显示，因为它在 7002 节点那儿</p><h3 id="新增-删除节点"><a href="#新增-删除节点" class="headerlink" title="新增 / 删除节点"></a>新增 / 删除节点</h3><pre class=" language-bash"><code class="language-bash">redis-cli --cluster <span class="token function">help</span></code></pre><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200415174628.png-growing" alt="redis-cli cluster help"></p><p>可以看到，通过 <code>add-node / del-node</code> 可以添加 / 删除节点</p><pre class=" language-bash"><code class="language-bash">redis-cli -a 123456 -p 7000 --cluster add-node 127.0.0.1:7006 127.0.0.1:7000 --cluster-slave</code></pre><p>我们把 7006 添加到集群作为 slave</p><pre class=" language-bash"><code class="language-bash">redis-cli -a 123456 -p 7000 --cluster info</code></pre><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200415181449.png-growing-growing" alt="redis cluster add slave"></p><p>可以看到， 7001 节点上已经有两个 slave 了。</p><p>通过在集群内部执行 <code>cluster nodes</code> 命令，能看到更详细的数据，这里不贴了，只明确下 7003 的 slave 节点为 7004</p><p>我们现在让 7003(只有一个从节点的 master 节点) 宕机，看看会发生什么：</p><pre class=" language-bash"><code class="language-bash"> ./run.sh stop ./cluster/conf/redis.7003.conf</code></pre><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200415175936.png-growing" alt="redis cluster after down"></p><p>会发现，之前 7003 的 slave 节点 7004 ， 被选为了新的主节点，而 7001 节点的两个 slave 节点，分给了 7004 一个，所以现在每个主节点又都有一个 slave 节点。</p><p>这是 redis 的 <strong>备份迁移算法</strong> 主导完成的。关于该部分的内容请参考 <a href="http://redis.cn/topics/cluster-spec.html" target="_blank" rel="noopener">这里</a></p><h3 id="小脚本"><a href="#小脚本" class="headerlink" title="小脚本"></a>小脚本</h3><p>没有做多少重构，将就着用…</p><p><code>./run.sh start all</code> ： 分别以 conf 目录下的配置文件启动 redis 实例</p><p><code>./run.sh stop all</code> ： 停止所有 conf 目录下配置文件产生的 redis 实例</p><p><code>./run.sh cluster</code> ： 在启动所有 redis 实例后，通过 cluster 命令创建集群，需要手动修改 ip:port</p><p><code>./run.sh status</code> ： 查看 redis 实例，这里没有提供查看单个 redis 实例 status 的方法</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#!/usr/bin/env bash</span>workdir<span class="token operator">=</span><span class="token string">"/home/dylan/tmp/redis-5.0.8/src"</span>scriptdir<span class="token operator">=</span><span class="token string">"/home/dylan/tmp/scripts-redis"</span>conffile<span class="token operator">=</span><span class="token variable">$2</span><span class="token comment" spellcheck="true"># *********</span>cluster_dir<span class="token operator">=</span><span class="token string">"<span class="token variable">${scriptdir}</span>/cluster"</span>cluster_pid_dir<span class="token operator">=</span><span class="token string">"<span class="token variable">${cluster_dir}</span>/pid"</span>cluster_conf_dir<span class="token operator">=</span><span class="token string">"<span class="token variable">${cluster_dir}</span>/conf"</span><span class="token comment" spellcheck="true"># $1 is redis config file name looks like ./conf/redis.1234.conf</span><span class="token comment" spellcheck="true"># return pid file name looks like pid_1234.pid</span><span class="token keyword">function</span> get_redis_pid_file<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        rport<span class="token operator">=</span><span class="token punctuation">$(</span>echo <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">"."</span> <span class="token string">'{print <span class="token variable"><span class="token variable">$(</span>NF-1<span class="token variable">)</span></span>}'</span><span class="token punctuation">)</span>        <span class="token keyword">echo</span> -e <span class="token string">"<span class="token variable">${cluster_pid_dir}</span>/pid_<span class="token variable">$rport</span>.pid"</span><span class="token punctuation">}</span><span class="token keyword">function</span> get_redis_conf_file<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        conf<span class="token operator">=</span><span class="token punctuation">$(</span>echo <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">"/"</span> <span class="token string">'{print <span class="token variable">$NF</span>}'</span><span class="token punctuation">)</span>        <span class="token keyword">echo</span> -e <span class="token string">"<span class="token variable">${cluster_conf_dir}</span>/<span class="token variable">$conf</span>"</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true"># $1 should be redis config file name looks like redis.1234.conf</span><span class="token keyword">function</span> redis_start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true"># conf file looks like redis.port.conf</span>        <span class="token comment" spellcheck="true"># pid file looks like pid_port.pid</span>        redis_conf_path<span class="token operator">=</span><span class="token variable">$1</span>        redis_conf<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_conf_file $<span class="token punctuation">{</span>redis_conf_path<span class="token punctuation">}</span><span class="token variable">)</span></span>        redis_conf_path_forshow<span class="token operator">=</span><span class="token string">"Redis with config $(echo <span class="token variable">${redis_conf}</span> | awk -F"</span>/<span class="token string">" '{print <span class="token variable">$NF</span>}')"</span>        pidfile<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_pid_file $<span class="token punctuation">{</span>redis_conf_path<span class="token punctuation">}</span><span class="token variable">)</span></span>        <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">$pidfile</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                <span class="token keyword">if</span> <span class="token function">kill</span> -0 <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pidfile<span class="token variable">`</span></span> <span class="token operator">></span> /dev/null 2<span class="token operator">></span><span class="token operator">&amp;</span>1<span class="token punctuation">;</span> <span class="token keyword">then</span>                        <span class="token keyword">echo</span> REDIS already running as process <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pidfile<span class="token variable">`</span></span><span class="token keyword">.</span>                        <span class="token keyword">return</span>                <span class="token keyword">fi</span>        <span class="token keyword">fi</span>        <span class="token comment" spellcheck="true"># 配置中已经配置了 daemonize yes</span>        <span class="token comment" spellcheck="true"># nohup ${workdir}/redis-server $conffile > $logfile 2>&amp;1 &lt; /dev/null &amp;</span>        <span class="token variable">${workdir}</span>/redis-server <span class="token variable">$redis_conf</span>        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                <span class="token function">sleep</span> 1                <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">$pidfile</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $pidfile<span class="token variable">)</span></span>                        <span class="token keyword">if</span> <span class="token function">ps</span> -p <span class="token variable">$pid</span> <span class="token operator">></span> /dev/null 2<span class="token operator">></span><span class="token operator">&amp;</span>1<span class="token punctuation">;</span> <span class="token keyword">then</span>                                <span class="token keyword">echo</span> <span class="token variable">${redis_conf_path_forshow}</span> STARTED                        <span class="token keyword">else</span>                                <span class="token keyword">echo</span> <span class="token variable">${redis_conf_path_forshow}</span> FAILED TO START                                <span class="token keyword">exit</span> 1                        <span class="token keyword">fi</span>                <span class="token keyword">else</span>                        <span class="token keyword">echo</span> <span class="token variable">${redis_conf_path_forshow}</span> start failed                        <span class="token keyword">exit</span> 1                <span class="token keyword">fi</span>        <span class="token keyword">else</span>                <span class="token keyword">echo</span> <span class="token variable">${redis_conf_path_forshow}</span> DID NOT START                <span class="token keyword">exit</span> 1        <span class="token keyword">fi</span><span class="token punctuation">}</span><span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>        start<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true"># 如果 $2 为 all ，则启动所有</span>                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"all"</span> <span class="token operator">==</span> <span class="token string">"<span class="token variable">$conffile</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        <span class="token keyword">echo</span> <span class="token string">"Run all files in <span class="token variable">$cluster_conf</span>"</span>                        <span class="token keyword">for</span> rfile <span class="token keyword">in</span> <span class="token variable">${cluster_conf_dir}</span>/*.conf                        <span class="token keyword">do</span>                                redis_start <span class="token variable">$rfile</span>                                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                                        <span class="token keyword">exit</span> 1                                <span class="token keyword">fi</span>                        <span class="token keyword">done</span>                <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"<span class="token variable">$conffile</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token comment" spellcheck="true"># 输入的文件不存在</span>                        <span class="token keyword">echo</span> Can not <span class="token function">find</span> <span class="token variable">$conffile</span><span class="token keyword">.</span>                        <span class="token keyword">exit</span> 1                <span class="token keyword">elif</span> <span class="token punctuation">[</span> -s <span class="token variable">$conffile</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        redis_start <span class="token variable">$conffile</span>                <span class="token keyword">else</span>                        <span class="token keyword">echo</span> <span class="token string">"Usage <span class="token variable">$0</span> start (all|redis_config_file)"</span>                        <span class="token keyword">exit</span> 1                <span class="token keyword">fi</span>                <span class="token keyword">exit</span> 0                <span class="token punctuation">;</span><span class="token punctuation">;</span>        stop<span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"all"</span> <span class="token operator">==</span> <span class="token string">"<span class="token variable">$conffile</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        <span class="token keyword">echo</span> Stopping all<span class="token punctuation">..</span>.                        <span class="token keyword">for</span> rfile <span class="token keyword">in</span> <span class="token variable">${cluster_conf_dir}</span>/*.conf                        <span class="token keyword">do</span>                                pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_pid_file $rfile<span class="token variable">)</span></span>                                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"<span class="token variable">$pid</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                                        <span class="token keyword">echo</span>                                        <span class="token keyword">echo</span> Redis with config <span class="token string">"<span class="token variable">$rfile</span>"</span> already stopped                                        <span class="token keyword">continue</span>                                <span class="token keyword">fi</span>                                <span class="token function">kill</span> <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pid<span class="token variable">`</span></span>                                <span class="token function">sleep</span> 1                                <span class="token keyword">echo</span>                                <span class="token keyword">echo</span> Redis with config <span class="token variable">$rfile</span> STOPPED                        <span class="token keyword">done</span>                <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"<span class="token variable">$conffile</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        <span class="token keyword">echo</span> Can not <span class="token function">find</span> <span class="token variable">$conffile</span><span class="token keyword">.</span>                        <span class="token keyword">exit</span> 1                <span class="token keyword">elif</span> <span class="token punctuation">[</span> -f <span class="token variable">$conffile</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_pid_file $conffile<span class="token variable">)</span></span>                        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token variable">$pid</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                                <span class="token keyword">echo</span>                                <span class="token keyword">echo</span> Redis with config <span class="token variable">$conffile</span> already STOPPED                                <span class="token keyword">exit</span> 0                        <span class="token keyword">fi</span>                        <span class="token function">kill</span> <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pid<span class="token variable">`</span></span>                        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                                <span class="token keyword">echo</span> Kill <span class="token variable">$pid</span> failed                                <span class="token keyword">exit</span> 1                        <span class="token keyword">fi</span>                        <span class="token function">sleep</span> 1                        <span class="token keyword">echo</span> STOPPED                <span class="token keyword">else</span>                        <span class="token keyword">echo</span> <span class="token string">"Usage <span class="token variable">$0</span> stop (all|redis_config_file)"</span>                        <span class="token keyword">exit</span> 1                <span class="token keyword">fi</span>                <span class="token punctuation">;</span><span class="token punctuation">;</span>        cli<span class="token punctuation">)</span>                <span class="token keyword">echo</span> <span class="token string">"Connecting to redis server..."</span>                count<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> $<span class="token punctuation">{</span>cluster_conf_dir/*.conf<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">`</span></span>                <span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> 1 $count<span class="token variable">`</span></span>                <span class="token keyword">do</span>                        conf<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> $<span class="token punctuation">{</span>cluster_conf_dir/*.conf<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">sort</span> --random-sort <span class="token operator">|</span> <span class="token function">head</span> -n 1<span class="token variable">)</span></span>                        <span class="token comment" spellcheck="true"># check if running</span>                        pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_pid_file $conf<span class="token variable">)</span></span>                        port<span class="token operator">=</span>`echo <span class="token string">"<span class="token variable">$conf</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">"."</span> <span class="token string">'{print <span class="token variable"><span class="token variable">$(</span>NF-1<span class="token variable">)</span></span>}'</span><span class="token variable"><span class="token variable">`</span>                        <span class="token keyword">if</span> <span class="token punctuation">[</span> -f $pid <span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ps</span> -p <span class="token variable">`</span></span><span class="token function">cat</span> <span class="token variable">$pid</span>` <span class="token operator">></span> /dev/null 2<span class="token operator">></span><span class="token operator">&amp;</span>1<span class="token punctuation">;</span> <span class="token keyword">then</span>                                <span class="token keyword">echo</span> <span class="token string">"Connected to <span class="token variable">$port</span>"</span>                                <span class="token variable">${workdir}</span>/redis-cli -a 123456 -c -p `echo <span class="token string">"<span class="token variable">$conf</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">"."</span> <span class="token string">'{print <span class="token variable"><span class="token variable">$(</span>NF-1<span class="token variable">)</span></span>}'</span>`                                <span class="token keyword">exit</span> 0                        <span class="token keyword">fi</span>                        <span class="token keyword">echo</span> <span class="token string">"Redis not running at port <span class="token variable">$port</span>"</span>                <span class="token keyword">done</span>                <span class="token keyword">echo</span> <span class="token string">"All Redis not running"</span>                <span class="token keyword">exit</span> 1                <span class="token punctuation">;</span><span class="token punctuation">;</span>        status<span class="token punctuation">)</span>                <span class="token keyword">echo</span> <span class="token string">"Checking status..."</span>                <span class="token keyword">echo</span> Found <span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> $<span class="token punctuation">{</span>cluster_conf_dir<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">`</span></span> config files                <span class="token keyword">echo</span>                <span class="token keyword">for</span> rfile <span class="token keyword">in</span> <span class="token variable">${cluster_conf_dir}</span>/*.conf                <span class="token keyword">do</span>                        pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_pid_file $rfile<span class="token variable">)</span></span>                        <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">$pid</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -s <span class="token variable">${pid}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                                        <span class="token keyword">echo</span> <span class="token function">file</span> <span class="token variable">$pid</span> is empty. skip<span class="token punctuation">..</span>.                                        <span class="token keyword">echo</span> <span class="token string">"Please check <span class="token variable">$pid</span>."</span>                                        <span class="token keyword">echo</span>                                        <span class="token keyword">continue</span>                                <span class="token keyword">fi</span>                                <span class="token keyword">if</span> <span class="token function">ps</span> -p <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pid<span class="token variable">`</span></span> <span class="token operator">></span> /dev/null 2<span class="token operator">></span><span class="token operator">&amp;</span>1<span class="token punctuation">;</span><span class="token keyword">then</span>                                        <span class="token keyword">echo</span> REDIS <span class="token variable">$pid</span> with pid <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pid<span class="token variable">`</span></span> is running                                        <span class="token function">sleep</span> 0.5                                <span class="token keyword">else</span>                                        <span class="token keyword">echo</span> <span class="token string">"Not running with pid <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pid<span class="token variable">`</span></span>, Please check it"</span>                                        <span class="token keyword">exit</span> 1                                <span class="token keyword">fi</span>                        <span class="token keyword">else</span>                                <span class="token keyword">echo</span> <span class="token string">"Not running with config file <span class="token variable">$rfile</span>. No pid file exists."</span>                        <span class="token keyword">fi</span>                <span class="token keyword">done</span>                <span class="token punctuation">;</span><span class="token punctuation">;</span>        cluster<span class="token punctuation">)</span>                <span class="token keyword">echo</span> <span class="token string">"Start clusting..."</span>                <span class="token variable">${workdir}</span>/redis-cli -a 123456 --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1                <span class="token keyword">exit</span> 0                <span class="token punctuation">;</span><span class="token punctuation">;</span>        test<span class="token punctuation">)</span>                <span class="token keyword">echo</span>                <span class="token keyword">echo</span> <span class="token string">"Test Success"</span>                <span class="token keyword">exit</span> 0                <span class="token punctuation">;</span><span class="token punctuation">;</span>        *<span class="token punctuation">)</span>                <span class="token keyword">echo</span>                <span class="token keyword">echo</span> -n <span class="token string">"Usage: "</span>                <span class="token keyword">echo</span> -n <span class="token string">"<span class="token variable">$0</span> status or "</span>                <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$0</span> {start|stop} conf_file_path"</span> <span class="token operator">></span><span class="token operator">&amp;</span>2                <span class="token punctuation">;</span><span class="token punctuation">;</span>esac</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Middlewares -- Redis&lt;一&gt;</title>
      <link href="/redis/introduction/"/>
      <url>/redis/introduction/</url>
      
        <content type="html"><![CDATA[<h1 id="Redis-lt-gt"><a href="#Redis-lt-gt" class="headerlink" title="Redis <->"></a>Redis &lt;-&gt;</h1><h2 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h2><h3 id="1-Strings"><a href="#1-Strings" class="headerlink" title="1. Strings"></a>1. Strings</h3><p>redis 对此描述为 <strong>binary-safe</strong> strings。可以看出， strings 类型在 redis 中是以 <strong>二进制</strong> 形式存储，这意味着 redis strings 可以用来存储任何类型的数据，甚至是一张图片。一个 string value 最大可以为 <strong>512M</strong></p><p>redis 使用 sds(simple dynamic string) struct 来存储 strings 数据。</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> sdshdr <span class="token punctuation">{</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 已存储的 string 长度</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> free<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 剩余的存储空间</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 存储的字符串</span><span class="token punctuation">}</span></code></pre><p>初始化时，free 为 0， 当 <code>append key value</code> 时， redis 会对该存储空间扩容，<strong>扩容大小 = new_value.length * 2</strong> ，但最大不能超过 1M (redis 中定义为 <code>SDS_MAX_PREALLOC</code>)。</p><p>这样， redis 就能十分方便的获取 string 长度(O(1))，减少内存扩容。</p><p>同样，这种策略会预分配内存，产生不必要的内存浪费，所以当我们经常 append huge strings 时，就会产生很多不必要的浪费。</p><p>redis 在 3.2 版本后，对此做了优化，会根据 string 的长度，选择不同的 SDS type</p><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">char</span> <span class="token function">sdsReqType</span><span class="token punctuation">(</span>size_t string_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>string_size <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 32</span>        <span class="token keyword">return</span> SDS_TYPE_5<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>string_size <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 256</span>        <span class="token keyword">return</span> SDS_TYPE_8<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>string_size <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 65536 即 64 * 1024 = 64k</span>        <span class="token keyword">return</span> SDS_TYPE_16<span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">if</span> (LONG_MAX == LLONG_MAX)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>string_size <span class="token operator">&lt;</span> <span class="token number">1ll</span><span class="token operator">&lt;&lt;</span><span class="token number">32</span><span class="token punctuation">)</span>         <span class="token keyword">return</span> SDS_TYPE_32<span class="token punctuation">;</span>    <span class="token keyword">return</span> SDS_TYPE_64<span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">else</span></span>    <span class="token keyword">return</span> SDS_TYPE_32<span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">endif</span></span><span class="token punctuation">}</span></code></pre><p>strings 指令：</p><blockquote><p>inrc / decr / incrby / decrby ：原子递增/递减 </p></blockquote><p>可以用来统计访问量 / 点赞量 / 转发量 等各种熟路</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> counter 18OK<span class="token comment" spellcheck="true"># 原子递增</span>127.0.0.1:6379<span class="token operator">></span> INCR counter<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 19<span class="token comment" spellcheck="true"># 原子递减</span>127.0.0.1:6379<span class="token operator">></span> DECR counter<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 18<span class="token comment" spellcheck="true"># 步长递增</span>127.0.0.1:6379<span class="token operator">></span> INCRBY counter 18<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 36<span class="token comment" spellcheck="true"># 步长递减</span>127.0.0.1:6379<span class="token operator">></span> DECRBY counter 18<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 18127.0.0.1:6379<span class="token operator">></span> get counter<span class="token string">"18"</span></code></pre><hr><blockquote><p>get / set / getset / append ： 获取 / 设置 / 设置同时返回值 /  追加</p><p>mget / mset ： 批量获取 / 设置</p></blockquote><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 以 key value 形式 set</span>127.0.0.1:6379<span class="token operator">></span> MSET k1 v1 k2 v2 k3 v3OK127.0.0.1:6379<span class="token operator">></span> MGET k1 k2 k31<span class="token punctuation">)</span> <span class="token string">"v1"</span>2<span class="token punctuation">)</span> <span class="token string">"v2"</span>3<span class="token punctuation">)</span> <span class="token string">"v3"</span></code></pre><hr><blockquote><p>setex ： 设置 value 和过期时间</p></blockquote><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> SETEX exp1 10 expv1OK<span class="token comment" spellcheck="true"># 获取过期时间， 还有 7 秒</span>127.0.0.1:6379<span class="token operator">></span> ttl exp1<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 7127.0.0.1:6379<span class="token operator">></span> get exp1<span class="token string">"expv1"</span><span class="token comment" spellcheck="true"># 此时查询时已过期</span>127.0.0.1:6379<span class="token operator">></span> get exp1<span class="token punctuation">(</span>nil<span class="token punctuation">)</span></code></pre><hr><blockquote><p>setnx / strlen ： set not exists，即没有时，才生效 / 获取 value 长度</p></blockquote><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 无 nx 这个 key 时， 设置成功</span>127.0.0.1:6379<span class="token operator">></span> SETNX nx nxv<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> get nx<span class="token string">"nxv"</span><span class="token comment" spellcheck="true"># 有 nx 这个 key 时， 设置失败</span>127.0.0.1:6379<span class="token operator">></span> SETNX nx nxvvvvvv<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token operator">></span> get nx<span class="token string">"nxv"</span><span class="token comment" spellcheck="true"># 获取 key 为 nx 的 value 长度</span>127.0.0.1:6379<span class="token operator">></span> STRLEN nx<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> get nx<span class="token string">"nxv"</span></code></pre><hr><p>更多 strings 相关命令参见 <a href="https://redis.io/commands#string" target="_blank" rel="noopener">这里</a></p><h3 id="2-Lists"><a href="#2-Lists" class="headerlink" title="2. Lists"></a>2. Lists</h3><p>redis 的 list 是 <strong>linkedList</strong> ， 是根据插入顺寻排列的 string 元素的集合， 一个 list 最大长度为 <strong>2<sup>32</sup> -1</strong> 。</p><p>list 节点 / 迭代器 / list 定义如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> listNode <span class="token punctuation">{</span>    <span class="token keyword">struct</span> listNode <span class="token operator">*</span>prev<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 头节点</span>    <span class="token keyword">struct</span> listNode <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 尾节点</span>    <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 值， void * 表明 value 可以是任意类型</span><span class="token punctuation">}</span> listNode<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> listIter <span class="token punctuation">{</span>    listNode <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 下一个节点</span>    <span class="token keyword">int</span> direction<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 遍历方向</span><span class="token punctuation">}</span> listIter<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> list <span class="token punctuation">{</span>    listNode <span class="token operator">*</span>head<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 头节点</span>    listNode <span class="token operator">*</span>tail<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 尾节点</span>    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>dup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 复制节点 func</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 释放节点 func</span>    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 比较两个节点是否相等</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 链表长度</span><span class="token punctuation">}</span> list<span class="token punctuation">;</span></code></pre><p>由此可见， redis 中的 list 是一个双向链表。同时会保存头尾节点和长度，所以获取他们的时间复杂度都为 O(1)</p><p>所以， LPUSH，RPUSH， RPOP， LPOP ，RPOPLPUSH ， LLEN 等操作都十分高效</p><p>Lists 指令：</p><blockquote><p>LPUSH / RPUSH ： 从头部 / 尾部插入元素</p></blockquote><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> LPUSH list l1 l2<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"l2"</span>2<span class="token punctuation">)</span> <span class="token string">"l1"</span>127.0.0.1:6379<span class="token operator">></span> RPUSH list r1 r2<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 4127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"l2"</span>2<span class="token punctuation">)</span> <span class="token string">"l1"</span>3<span class="token punctuation">)</span> <span class="token string">"r1"</span>4<span class="token punctuation">)</span> <span class="token string">"r2"</span>127.0.0.1:6379<span class="token operator">></span> del list</code></pre><hr><blockquote><p>LRANGE ： 从列表中拿出一个 range 。</p></blockquote><ul><li>注意这个 range 是 <strong>闭合</strong> 的，比如你执行 <code>lrange list 0 1</code> ，即 [0, 1] 而非 [0, 1) 。 </li><li>负数表示倒数， 如 [0, -1] ，表示从 0 到最后一个数，即该 list 的全部元素</li></ul><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> RPUSH list v1 v2 v3<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"v1"</span>2<span class="token punctuation">)</span> <span class="token string">"v2"</span>3<span class="token punctuation">)</span> <span class="token string">"v3"</span>127.0.0.1:6379<span class="token operator">></span> del list</code></pre><p>我们结合 LPUSH + LRANGE ，可以简单的实现 timeline 功能</p><hr><blockquote><p> LTRIM：从头部截取指定长度 slice 并存入该 key 中</p></blockquote><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> lpush list v1 v2 v3<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"v3"</span>2<span class="token punctuation">)</span> <span class="token string">"v2"</span>3<span class="token punctuation">)</span> <span class="token string">"v1"</span><span class="token comment" spellcheck="true"># 这里从头截取 [0, 1] 长度的 slice 并存入到 list 中</span>127.0.0.1:6379<span class="token operator">></span> LTRIM list 0 1OK127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"v3"</span>2<span class="token punctuation">)</span> <span class="token string">"v2"</span>127.0.0.1:6379<span class="token operator">></span> del list</code></pre><p>LPUSH + LTRIM 的组合，可以实现一个简单的定长 list ，该 list 维护指定长度的最新元素</p><hr><blockquote><p>LINSERT : 在指定元素前/后插入原色</p></blockquote><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> lpush list val<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"val"</span><span class="token comment" spellcheck="true"># val 前插入</span>127.0.0.1:6379<span class="token operator">></span> linsert list before val val-before<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"val-before"</span>2<span class="token punctuation">)</span> <span class="token string">"val"</span><span class="token comment" spellcheck="true"># val 后插入</span>127.0.0.1:6379<span class="token operator">></span> LINSERT list after val val-after<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"val-before"</span>2<span class="token punctuation">)</span> <span class="token string">"val"</span>3<span class="token punctuation">)</span> <span class="token string">"val-after"</span><span class="token comment" spellcheck="true"># 在一个不存在的元素前插入，返回 -1 ， 插入失败</span>127.0.0.1:6379<span class="token operator">></span> LINSERT list before noexist noexist<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> -1127.0.0.1:6379<span class="token operator">></span> lrange list 0 -11<span class="token punctuation">)</span> <span class="token string">"val-before"</span>2<span class="token punctuation">)</span> <span class="token string">"val"</span>3<span class="token punctuation">)</span> <span class="token string">"val-after"</span>127.0.0.1:6379<span class="token operator">></span> del list</code></pre><hr><blockquote><p>LPOP / RPOP</p></blockquote><p>拿到并删除 头部 / 尾部 元素</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> rpush list <span class="token function">head</span> middle <span class="token function">tail</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> lrange list 0 -11<span class="token punctuation">)</span> <span class="token string">"head"</span>2<span class="token punctuation">)</span> <span class="token string">"middle"</span>3<span class="token punctuation">)</span> <span class="token string">"tail"</span>127.0.0.1:6379<span class="token operator">></span> LPOP list<span class="token string">"head"</span>127.0.0.1:6379<span class="token operator">></span> RPOP list<span class="token string">"tail"</span>127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"middle"</span>127.0.0.1:6379<span class="token operator">></span> del list</code></pre><hr><blockquote><p>LREM key count element ： 删除元素</p></blockquote><ul><li>count &gt; 0 时， <strong>从头到尾</strong> 删除与 element 相等的元素， 删除 count 个</li><li>count &lt; 0 时， <strong>从尾到头</strong> 删除与 element 相等的元素， 删除 count 个</li><li>count = 0 时， 删除所有与 element 相等的元素</li></ul><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> RPUSH list 1 2 1 2 1 2<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 6<span class="token comment" spellcheck="true"># 从头到尾遍历，删除一个元素 2</span>127.0.0.1:6379<span class="token operator">></span> LREM list 1 2<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"1"</span> 2<span class="token punctuation">)</span> <span class="token string">"1"</span> 3<span class="token punctuation">)</span> <span class="token string">"2"</span> 4<span class="token punctuation">)</span> <span class="token string">"1"</span> 5<span class="token punctuation">)</span> <span class="token string">"2"</span><span class="token comment" spellcheck="true"># 从尾到头遍历， 删除一个元素 2</span>127.0.0.1:6379<span class="token operator">></span> LREM list -1 2<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"1"</span> 2<span class="token punctuation">)</span> <span class="token string">"1"</span> 3<span class="token punctuation">)</span> <span class="token string">"2"</span> 4<span class="token punctuation">)</span> <span class="token string">"1"</span><span class="token comment" spellcheck="true"># 删除所有为 1 的元素</span>127.0.0.1:6379<span class="token operator">></span> LREM list 0 1<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"2"</span></code></pre><hr><blockquote><p>RPOPLPUSH  source dest </p></blockquote><p>取出 source 尾节点放到 dest 的头节点</p><ul><li>如果 source 不存在，返回 nil ， 不执行任何操作</li><li>如果 dest 不存在，创建 dest，并执行操作</li><li>如果 source tail 元素 和 dest head 元素一致，依旧会 push</li><li>如果 source 和 dest 是同一个 list ，这个 list 就变成了一个 circular list</li></ul><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> LRANGE <span class="token function">source</span> 0 -11<span class="token punctuation">)</span> <span class="token string">"s"</span> 2<span class="token punctuation">)</span> <span class="token string">"s"</span><span class="token comment" spellcheck="true"># source(这里指 noexist) 不存在， 返回 nil</span>127.0.0.1:6379<span class="token operator">></span> RPOPLPUSH noexist <span class="token function">source</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span>127.0.0.1:6379<span class="token operator">></span> LRANGE <span class="token function">source</span> 0 -11<span class="token punctuation">)</span> <span class="token string">"s"</span> 2<span class="token punctuation">)</span> <span class="token string">"s"</span><span class="token comment" spellcheck="true"># 只有 source</span>127.0.0.1:6379<span class="token operator">></span> keys *1<span class="token punctuation">)</span> <span class="token string">"source"</span><span class="token comment" spellcheck="true"># dest 不存在，但是会被创建</span>127.0.0.1:6379<span class="token operator">></span> RPOPLPUSH <span class="token function">source</span> dest<span class="token string">"s"</span>127.0.0.1:6379<span class="token operator">></span> LRANGE dest 0 -11<span class="token punctuation">)</span> <span class="token string">"s"</span><span class="token comment" spellcheck="true"># 相同的两个元素，不会被覆盖</span>127.0.0.1:6379<span class="token operator">></span> RPOPLPUSH <span class="token function">source</span> dest<span class="token string">"s"</span>127.0.0.1:6379<span class="token operator">></span> LRANGE dest 0 -11<span class="token punctuation">)</span> <span class="token string">"s"</span> 2<span class="token punctuation">)</span> <span class="token string">"s"</span></code></pre><hr><blockquote><p>BLPOP key1 key2 key3… timeout</p></blockquote><p>LPOP 的阻塞版本，即 key1 , key2, key3 … 任一监听的 key 中都没有值时，会阻塞到 timeout ，timeout 为 0 表示一直阻塞</p><ul><li><p>key1 -&gt; key2 -&gt; key3 按序查找，直到找到值</p></li><li><p>多个 client 监听同一个 key 时，按监听时间的早晚，依次返回给 client ，client 接收到后，下次监听需要重新排队</p></li><li><p>multi 操作一次塞入多个值时，会先执行完 multi 操作，然后返回并删除头节点</p><hr></li></ul><blockquote><p>BRPOP / BRPOPLPUSH</p></blockquote><p>BRPOP 功能参考 BLPOP， 即阻塞版本的 RPOP，获取并删除尾节点</p><p>BRPOPLPUSH 即阻塞版本的 RPOPLPUSH ，从 source 获取尾节点并放到 dest 的头部</p><hr><p>更多 lists 的操作命令参考 <a href="https://redis.io/commands#list" target="_blank" rel="noopener">这里</a></p><h3 id="3-Sets"><a href="#3-Sets" class="headerlink" title="3. Sets"></a>3. Sets</h3><p>sets 底层主要基于 hash 表和 inset 数据结构实现。</p><p><strong>无序且去重</strong>的 set 集合，最大可存储 2<sup>32</sup> -1 个元素。</p><blockquote><p>SADD key ele1 ele2 ele3 …</p><p>SCARD / SMEMBERS key</p><p>SISMEMBER key ele</p></blockquote><p>添加 / 获取 set 元素数量 / 获取 set 所有元素 / 确定一个元素是否在集合中</p><hr><blockquote><p>SDIFF key1 key2 key3 …</p><p>SDIFFSTORE dest key1 key2</p></blockquote><ul><li>sdiff ：获取 key1 与 key2， key3 的<strong>差集</strong>，即 key2 不存在与 key2， key3 中的元素</li><li>sdiffstore：与 <code>LRPOPLPUSH</code> 类似，将 sdiff 的结果放到 dest set 中，注意，如果 dest 中有元素，则元素会被清空</li></ul><hr><blockquote><p>SINTER key key1 key</p><p>SINTERSTORE dest key key1 key2</p></blockquote><p>与 sdiff /sdiffstore 类似，这组命令是取 <strong>交集</strong></p><hr><blockquote><p>SUNION key1 key2 key3 …</p><p>SUNIONSTORE dest key1 key2 key3 …</p></blockquote><p>同样，这里取并集</p><hr><blockquote><p>SMOVE source dest ele</p><p>SREM key ele1 ele2</p></blockquote><ul><li>移动 source 中的 ele 到 dest 集合中</li><li>将 key 中元素 ele1 ele2 删除</li></ul><hr><blockquote><p>SRANDMEMBER / SPOP</p></blockquote><ul><li><p>srandmember key count ： 从 set 中随机取出元素</p><ul><li>0 ≤ count ≤ set length ：随机返回 count 个元素, <strong>无放回随机</strong></li><li>count &gt; set length ： 返回全部 set 元素</li><li>count 为负数时， 随机返回 count 个元素，此时为 <strong>有放回随机</strong> ， 这也意味着， count 可以为一个绝对值大于 set length 的负数。</li></ul></li><li><p>spop key count ： spop 的 count 不能为负数，其他行为与 srandmember 一致，spop 会同时删除取出的元素</p><hr></li></ul><blockquote><p>SSCAN key cursor [MATCH pattern] count</p></blockquote><p>是一个基于游标的迭代器。它会返回游标以及查询到的元素。</p><p>该命令保证</p><ul><li>从完整遍历开始到结束，所有存在于 key 中的元素都会被返回</li><li>开始前被移除且直到结束都未加入的元素，不会被返回</li><li>同一个元素可能被迭代多次</li><li>一个元素在迭代过程中被添加或删除，不保证一定返回或不返回</li></ul><hr><p>更多 Sets 相关命令参见 <a href="https://redis.io/commands#set" target="_blank" rel="noopener">这里</a></p><h3 id="4-Sorted-sets"><a href="#4-Sorted-sets" class="headerlink" title="4. Sorted sets"></a>4. Sorted sets</h3><p>sorted sets 底层主要基于 跳跃表 实现，关于跳跃表，作者表示也不是很清楚，需要先去加强一波学习，这里不再展开，可参考文末的 reference 系列文章。</p><p>sorted sets 与 sets 十分类似，但是 sorted sets 会给每个 element 添加一个 score，用来给元素排序。sorted sets 不允许相同的元素，但运行相同分数的元素。当查询多个相同分数的元素时，返回结果为元素的字典排序</p><blockquote><p>ZADD  key [XX|NX] [CH] [INCR] score ele …</p></blockquote><p>添加一个或多个元素到 sorted set。</p><p>XX ： 仅更新已存在的元素，不添加新元素</p><p>NX ： 只添加新成员，不更新已存在的元素</p><p>CH ： 返回发生变化的元素总数，不添加则返回添加的元素总数</p><p>INCR ： 相当于 ZINCRBY ，为元素分数做递增操作，使用该选项时，一次只能更新一个元素</p><hr><blockquote><p>ZCARD key </p><p>ZCOUNT key min max</p><p>ZSCORE key ele</p></blockquote><ul><li>zcard key 返回 key 所有元素数量</li><li>zcount key min mzx 返回指定 [min, max] 分数中的所有元素数量</li><li>查询给定元素分数</li></ul><hr><blockquote><p>ZLEXCOUNT key [min_ele [max_ele</p></blockquote><p>查询 min ele 和 max ele 之间的元素个数，包含本身，是闭区间！</p><ul><li>查询的元素前要加 <strong>[</strong>  ，如 <code>zlexcount sset [min [max</code></li><li><code>-</code> (减号) ， <code>+</code> (加号) 分别表示最小分数和最大分数元素， 如 <code>zlexcount sset - +</code> ，则返回 sset 这个 key 中的所有元素个数</li></ul><hr><blockquote><p>ZINTERSTORE dest num key1 key2 [weights] [aggregate] </p></blockquote><p>对 key1 key2 取交集，放入 dest 中，若 dest 已存在，则会清空 dest 后放入结果集</p><ul><li>num ，必须纳入交集计算的 key 的个数，这里 num 应该为 2</li><li>weights ： 在存入 dest 之前，会按照给定的 weights 与元素 <strong>相乘</strong> ，默认为 1</li><li>aggregate ： 聚合方式， MAX ， MIN ， SUM ，默认 SUM</li></ul><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> ZADD a 1 1 1 2 1 3<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> ZADD b 2 2 2 3 2 4<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> ZADD c 3 3 3 4 3 5<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3<span class="token comment" spellcheck="true"># 对 a 中交集的元素(3) 的分数(1) * 10 = 10，聚合方式为取最大值</span><span class="token comment" spellcheck="true"># 所以聚合结果是 ele=3 score=10</span>127.0.0.1:6379<span class="token operator">></span> ZINTERSTORE dest 3 a b c weights 10 1 1 aggregate MAX<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> ZRANGE dest 0 -1 withscores1<span class="token punctuation">)</span> <span class="token string">"3"</span>2<span class="token punctuation">)</span> <span class="token string">"10"</span></code></pre><hr><blockquote><p>ZPOPMAX / ZPOPMIN key [count]</p><p>ZRANGE / ZREVRANGE key start stop [withscores]</p><p>ZRANGEBYLEX / ZREVRANGEBYLEX  key [min [max [limit offset count]</p><p>ZRANGEBYSCORE</p></blockquote><ul><li><p>获取并删除给定 count 个元素，按照 score 的最大值 / 最小值排序</p></li><li><p>按照分数从小到大(zrevrange 从大到小) 排序，score 相同则按照字典序排列</p></li><li><p>zrangebylex ： 按字典排序，获取 [min, max] 中元素，<strong>不要在 score 不一致的 key 中使用该指令</strong>，因为获取的结果会不准</p><ul><li>min , max 参考 zlexcount 说明， 使用 <strong>(</strong>  获取开区间结果集</li><li>limit offset count ： 是否分页， offset ， count 分别为起始位置和返回结果数量</li><li>以 ASCII 字符集排序，所以对大小写敏感，对 utf-8 字符集不友好</li></ul></li></ul><hr><blockquote><p>ZRANK key element</p><p>ZREVRANK key element</p></blockquote><p>从小到大(zrevrank 从大到小) 获取指定 ele 的 index</p><hr><blockquote><p>ZREM key ele1, ele2 …</p><p>ZREMRANGEBYRANK key start stop …</p><p>ZREMRANGEBYLEX key min max</p><p>ZREMRANGEBYSCORE key min max</p></blockquote><ul><li>删除指定元素</li><li>按照给定索引删除</li><li>按照给定元素区间，按照字典序删除</li><li>按照给定分数区间删除</li></ul><hr><p>更多 Sorted Sets 相关命令参见 <a href="https://redis.io/commands#sorted_set" target="_blank" rel="noopener">这里</a></p><h3 id="5-Hashes"><a href="#5-Hashes" class="headerlink" title="5. Hashes"></a>5. Hashes</h3><p>hash 在 redis 底层是通过 dict 数据结构来实现的，即字典，java 中的 map ，都是类似的数据结构</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dictEntry <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>    <span class="token keyword">union</span> <span class="token punctuation">{</span>        <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>        uint64_t u64<span class="token punctuation">;</span>        int64_t s64<span class="token punctuation">;</span>        <span class="token keyword">double</span> d<span class="token punctuation">;</span>    <span class="token punctuation">}</span> v<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// hash 冲突时，记录下一个节点</span>    <span class="token keyword">struct</span> dictEntry <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token punctuation">}</span> dictEntry<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dictht <span class="token punctuation">{</span>    dictEntry <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sizemask<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">;</span><span class="token punctuation">}</span> dictht<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dict <span class="token punctuation">{</span>    dictType <span class="token operator">*</span>type<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">;</span>    dictht ht<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 哈希表， 最多可能会维护两张哈希表</span>    <span class="token keyword">long</span> rehashidx<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* rehashing not in progress if rehashidx == -1 */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> iterators<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* number of iterators currently running */</span><span class="token punctuation">}</span> dict<span class="token punctuation">;</span></code></pre><p>当出现 hash 冲突时， redis 会通过一个链表来处理。 </p><p>你还可以在 <a href="https://juejin.im/post/5d71d3bee51d453b5f1a04f1#heading-7" target="_blank" rel="noopener">这里</a> 看更详尽的解释</p><p>一个 hash 最多可包含 2<sup>32</sup> -1 个 k-v 对</p><ul><li>HSET key field1 v1 field2 v2 … ：新增/更新 kv</li><li>HSETNX key field value ：not exist，即不存在 field 时插入， key 不存在会新建</li><li>HGET key field ：获取 field 的 value , field 不存在时返回 nil</li><li>HGETALL key ：获取 key 中所有 kv</li><li>HDEL key field1 field2：删除指定 field</li><li>HEXISTS key field ：field 是否存在</li><li>HINCRBY key field step ： 增加 field 对应 value 值，不存在则新建该 field， step 作为值</li><li>HINCRBYFLOAT key field step ：同上，增加或新增 float 类型</li><li>HLEN key ：获取 key 的 field 个数</li><li>HKEYS key ： 获取 key 中所有 field</li><li>HVALS key ： 获取 key 中所有 value</li><li>HSTRLEN key field ：获取 field 对应 value 的长度</li><li>HMGET ： 获取多个 field 值，field 不存在时，返回 nil <code>hmget key field1 field1</code></li><li>HMSET ： 批量新增/更新 field，<code>hmset key field1 v1 field2 v2</code></li><li>HSCAN ： </li></ul><hr><p>更多 Hash 相关命令参见 <a href="https://redis.io/commands#hash" target="_blank" rel="noopener">这里</a></p><h3 id="6-其他命令"><a href="#6-其他命令" class="headerlink" title="6. 其他命令"></a>6. 其他命令</h3><p>redis 5 新添加了一种数据结构 <code>Stream</code> ， 关于该数据结构，可以参见 <a href="http://redis.cn/topics/streams-intro.html" target="_blank" rel="noopener">这里</a></p><p>stream 可以实现 consumer group 的概念，每个 client 可以只关注于自己的 group，并且只能查询到该 group 下的消息。</p><p>stream 的某些功能与 redis 的 pub/sub 类似，不过 pub/sub 是 <code>fire and forget</code> 且从不存储， stream 则不是如此。</p><p>bitmap， geo， hyperLogLog 参见 <a href="https://juejin.im/post/5aa72131518825556a7211af" target="_blank" rel="noopener">这里</a></p><p>更多命令参见  <a href="http://www.redis.cn/commands.html" target="_blank" rel="noopener">redis.cn</a>  or <a href="https://redis.io/commands" target="_blank" rel="noopener">redis</a></p><h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><p>当我们需要多个操作时， 通常的办法是，client  –&gt; op1 –&gt; redis –&gt; client –&gt; op2 –&gt; redis …</p><p>每次 op 操作，都需要先和 redis 建立连接，而后再操作。虽然连接建立耗时极短，但当网络不好时，仍然是一笔开销，而 <strong>pipeline</strong> 则可以很好的解决这个问题。</p><p>pipeline 和我们常说的管道基本一致，它能在 client 和 redis server 之间建立连接通道，而后每次操作都在该通道下进行，所有操作完成后，再关闭 pipeline</p><p>当我们通过 pipeline 操作数据时，需要注意操作的个数，因为 redis 需要耗费内存来组织需要返回的数据。所以我们需要控制 pipeline 内的 op 个数，分批处理。</p><p>pipeline 操作是非原子性的，如果要保证其原子性，可以通过 <code>multi exec</code> 来保证 </p><p>事实上， pipiline 能处理的事情，都可以通过脚本来处理，脚本还能够处理有依赖关系的数据。lua script 相比 pipeline ，要更灵活，同时能处理简单的业务。当然，我们不建议在 script 里处理耗时大的业务。</p><h2 id="PUBSUB"><a href="#PUBSUB" class="headerlink" title="PUBSUB"></a>PUBSUB</h2><p>在 redis 中， 通过几个简单的命令就可以实现 pub/sub 。</p><p>我们在一个 terminal 中使用 <code>subscribe</code> 命令</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> SUBSCRIBE chan1 chan2Reading messages<span class="token punctuation">..</span>. <span class="token punctuation">(</span>press Ctrl-C to quit<span class="token punctuation">)</span>1<span class="token punctuation">)</span> <span class="token string">"subscribe"</span>2<span class="token punctuation">)</span> <span class="token string">"chan1"</span>3<span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 11<span class="token punctuation">)</span> <span class="token string">"subscribe"</span>2<span class="token punctuation">)</span> <span class="token string">"chan2"</span>3<span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2<span class="token comment" spellcheck="true"># publish chan1 "From chan1" 后</span>1<span class="token punctuation">)</span> <span class="token string">"message"</span>2<span class="token punctuation">)</span> <span class="token string">"chan1"</span>3<span class="token punctuation">)</span> <span class="token string">"From chan1"</span></code></pre><p>该命令会阻塞监听两个 channel： chan1 和 chan2 ， 如果 channel 不存在，则会创建。</p><p>我们同样可以使用 <code>psubscribe</code> 命令来使用通配符监听 channel， 如 <code>psubscribe chan*</code></p><p>我们还可以通过 <code>unsubscribe</code> 和 <code>punsubscribe</code> (支持通配符) 来取消订阅</p><p>我们在另一个 terminal 通过 <code>publish chan1 value1</code> 发送消息，订阅方就能收到消息</p><p>在 redis 的 <code>server.h</code> 中，定义了一个用来存储 pubsub 数据的 key=channel , value=client 的 dict</p><pre class=" language-c"><code class="language-c">dict <span class="token operator">*</span>pubsub_channels<span class="token punctuation">;</span></code></pre><ul><li><p>当有 client subscribe 时， redis 就会往这个 dict 中添加 &lt;channel, client&gt; 的一堆键值对， 多个 client 注册同一个 channel 时， client 的存储就变成 dict 中的 list。</p></li><li><p>当有人 publish 值到 channel 时， redis 会先通过 channel 查询到对应的 client list ，然后依次发送给各个 client。</p></li><li><p>退订 channel 时， 只需要找到 channel 下的 client ，从 dict 中剔除即可</p></li></ul><p><strong>如果 publisher 在 publish 时没有 subscriber 监听，那么该条消息就会丢失。</strong></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://redis.io/" target="_blank" rel="noopener">redis 官网</a></li><li><a href="http://www.redis.cn/commands.html" target="_blank" rel="noopener">redis 中文</a></li><li><a href="https://redisbook.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">redis 设计与实现 老版</a></li><li><a href="http://redisbook.com/" target="_blank" rel="noopener">redis 设计与实现 3.0 版</a></li><li><a href="https://juejin.im/post/5d71d3bee51d453b5f1a04f1" target="_blank" rel="noopener">深入了解 redis 底层数据结构</a></li><li><a href="https://juejin.im/post/5de3e841f265da05d03826ca" target="_blank" rel="noopener">图解 redis 五种数据结构底层实现</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PSSH 批量执行</title>
      <link href="/tools/pssh/"/>
      <url>/tools/pssh/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>工作，需要通过跳板机向多台 linux (已通过公钥做免密登录)添加 cron task。</p><h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><ol><li><p>安装 <strong>pssh</strong> 批处理工具</p><ul><li><a href="https://code.google.com/archive/p/parallel-ssh/downloads" target="_blank" rel="noopener">Download</a></li></ul></li><li><p>获取 <strong>/etc/hosts</strong> 中的 <strong>ip</strong></p><pre><code> cat /etc/hosts | awk '{pring $1}' | grep 'your regex' &gt;&gt; hosts.txt </code></pre></li><li><p>检查各台机器的 <strong>crontab</strong>           状态。如果有未服务未启动的，需要首先启动</p><pre><code> /bin/systemctl status crond.service</code></pre></li><li><p>将需要执行的 bash 脚本批上传到各机器:</p><pre><code> pscp -h hosts.txt /home/dylan/alert.sh /home/dylan</code></pre></li><li><p>通过 <strong>pssh</strong> 创建 <strong>cron</strong> 脚本并将 task 写入到 crontab 中:</p><pre><code> pssh -h hosts.txt -i 'cd ~;touch cron.cron;echo "* */2 * * * sh /home/dylan/your_bash.sh" &gt;&gt; cron.cron;crontab cron.cron'</code></pre></li><li><p>至此就完成了。如果要批取消，则:</p><pre><code> pssh -h hosts.txt -i 'cd ~;sudo sed -i "/alert.sh/d" /var/spool/cron/dylan;rm cron.cron'</code></pre><p> 脚本说明：创建的 <strong>crontab task</strong> 可以在文件 <strong>/var/spool/cron/dylan</strong> (dylan 为用户名) 中找到，上述脚本首先找到对应的 task 所在行，然后删除， 最后删除创建的脚本</p></li></ol><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p>请自行 google * . *</p><hr><hr><hr><h1 id="pssh-简介"><a href="#pssh-简介" class="headerlink" title="pssh 简介"></a>pssh 简介</h1><h2 id="Ref-1"><a href="#Ref-1" class="headerlink" title="Ref"></a>Ref</h2><ul><li><a href="https://code.google.com/archive/p/parallel-ssh/" target="_blank" rel="noopener">google groups</a></li><li><a href="https://www.cnmysql.com/post/74/" target="_blank" rel="noopener">使用PSSH批量SSH操作Linux服务器</a></li><li><a href="https://my.oschina.net/guol/blog/59977" target="_blank" rel="noopener">PSSH 批量管理服务器 - 好脑袋和烂笔头</a></li></ul><h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><ul><li><a href="https://code.google.com/archive/p/parallel-ssh/downloads" target="_blank" rel="noopener">Download</a></li></ul><h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><ul><li><p>在免密情况下</p><pre><code>pssh -i -h hosts.txt 'uptime'</code></pre></li><li><p>在密码情况下</p><pre><code>pssh -i -l root -a password -h hosts.txt 'uptime'</code></pre></li></ul><p>and others</p><h2 id="相关参数说明"><a href="#相关参数说明" class="headerlink" title="相关参数说明"></a>相关参数说明</h2><p>其实可以直接<code>pssh --help</code> &gt;.&lt;</p><ul><li>-h 执行命令的远程主机列表，或者 -H user@ip:port  文件内容格式[user@]host[:port]</li><li>-l 远程机器的用户名</li><li>-p 一次最大允许多少连接</li><li>-o 输出内容重定向到一个文件</li><li>-e 执行错误重定向到一个文件</li><li>-t 设置命令执行的超时时间</li><li>-A 提示输入密码并且把密码传递给ssh</li><li>-O 设置ssh参数的具体配置，参照ssh_config配置文件</li><li>-x 传递多个SSH命令，多个命令用空格分开，用引号括起来</li><li>-X 同-x 但是一次只能传递一个命令</li><li>-i 显示标准输出和标准错误在每台host执行完毕后</li><li>-I 读取每个输入命令，并传递给ssh进程 允许命令脚本传送到标准输入</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大西北之旅 -- 终章</title>
      <link href="/travels/xi-bei/"/>
      <url>/travels/xi-bei/</url>
      
        <content type="html"><![CDATA[<p>逛完青海湖，下一站是被称为天空之境的茶卡盐湖。可能是我们来的不是时候，见到的与宣传的差别很大。但走在铺满盐粒的路上，费力也十分有趣！<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409164513.jpg-growing" alt="茶卡盐湖"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409164526.jpg-growing" alt="盐帝"><br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="D:%5Ctools%5Ctypora%5Cimages%5C7763096-d8cc06d02d4b64c9.jpg" alt="图片发自简书App"></p><p>而后转战翡翠湖，那一块似乎还在开发中，路十分难开，异常颠簸。到达的时候，正好赶上日落。寒风中，瑟瑟发抖看完日落，日落的速度很快，你能感觉到夕阳在下降。难怪说夕阳无限好，只是近黄昏！<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409164547.jpg-growing" alt="夕阳染红的翡翠湖"></p><p>之后回到这一站的住宿点——青年旅馆。第一次住青年旅馆。四张床八个床位，和大一时的寝室颇有几分相似之处。不愧是大西北，暖气开的异常的足，闷得慌，感觉都快喘不过气了。只是后来不知怎么的就睡着了，早上起来头疼难受，吃了两片感冒药，继续下一站，敦煌。</p><p>不幸的是，同行朋友的车坏了！还好这边的高速没有围栏，我们把车停到两条路的中间，开始了一系列的救援措施。</p><p>先是向大卡车招手，寻求帮助看看车还有没有救，大卡司机一般都是老司机，经验丰富，只是都说车子不能再开了。而后找车行的人，和他们扯了半天，扯不出什么结果！这里要提醒各位租车的朋友，车子出了问题，<strong>第一时间联系平台，而不要联系租车公司</strong>！我们当时不知道，为此浪费了很多时间。后来找携程的工作人员，他们才真正的来解决我们的行程问题(其间也是各种扯皮，反正挺闹心的)。这事儿直到前段时间才算结束，吃一堑长一智，也算旅行中另一种风景了。</p><p>虽然是随机停下的地方，却也是风景满满，带着相机和朋友就去旁边浪去了。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409164638.jpg-growing" alt="大西北风味"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409164813.jpg-growing" alt="大西北风味"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409164823.jpg-growing" alt="大西北风情"></p><p>后来让妹子们去马路上拦车，程序猿不如程序媛啊！热心的人还是很多的，停下来问原因，帮我们看故障的车子，只是一般车上都满员了，也是无奈，夸张的时候，马路一边停了四五辆，不知道的，还以为这里也是一个景点了呢。<br>经过不懈努力，终于拦到了合适的车，是一对自驾出来玩的情侣，也是前往敦煌。于是乎继续出发。感谢热心车主！</p><p>由于车子问题，原定的莫高窟之旅只好作废，略遗憾。晚上加第二天上午，一直在和租车行扯皮，说好第二天早上送来的车毫无踪影，让我们自己想办法过去，也是无语！最后还是找民宿老板送我们到张掖，他们把车送到张掖。</p><p>中午开始启程到张掖，只是，在鸣沙山，稍稍多逗留了一会儿，玩嗨了。<br>鸣沙山位于沙漠边缘，在这儿可以见识到沙漠的样子。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165105.jpg-growing" alt="鸣沙山月牙泉"></p><p>第一次体验骑骆驼。一直把腰绷的紧紧的，后来牵骆驼的小哥实在看不下去，说要放松，把腰松下来，不会掉下去，果真如此。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165147.jpg-growing" alt="我高贵的头颅"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165205.jpg-growing" alt="骆驼群像"></p><p>而后本着好不容易来一次的心态，体验了把三四分钟四百八十元的滑翔机。真要说感受，除了失重时的害怕，其他都还好。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165227.jpg-growing" alt="滑翔起飞"></p><p>之后便赶往张掖，七彩丹霞也是我们的最后一站。这一站的住宿点是蒙古包，据说晚上还有篝火晚会，实在可惜的是，我们到的时候已经晚上十点多了，完美错过。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165241.jpg-growing" alt="丹霞蒙古包"></p><p>最后一日游——七彩丹霞。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165322.jpg-growing" alt="丹霞地貌"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165332.jpg-growing" alt="丹霞地貌"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165341.jpg-growing" alt="丹霞地貌"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165449.jpg-growing" alt="心愿"></p><p>心满意足，返程！路上经过连绵数百公里的祁连山脉，更是经历了春夏秋冬。山下还挺暖和的，只是随着一点点的攀爬，温度渐渐下降，最后飘起了小雪，而后越来越大。山顶白茫茫一片，着实震撼。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165549.jpg-growing" alt="四季之冬"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409165602.jpg-growing" alt="四季之冬"></p><p>一路攀爬最高到三千八百米，而后一路向下，终到西宁高铁站附近。还车，休整，返航！</p><p>十一之旅落下帷幕，大西北的苍凉和浩瀚实在震撼人心，与江南的小桥流水迥然不同。希望之后有机会去更多的地方，体验不同的风景，更希望这份心情，不因年龄的增长而消逝。</p><p>哦对了，西北实在干燥，如果有朋友想去，记得一定带润唇膏，血与泪的教训！</p><p>以上</p><p>于 2018.10</p><blockquote><p>以前发在简书的文章，可是最近简书莫名封了我的账号。又恰逢自己有了自己的 blog，便把之前的一些记忆拿了回来。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> 大西北 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大西北之旅 -- 青海</title>
      <link href="/travels/qinghai/"/>
      <url>/travels/qinghai/</url>
      
        <content type="html"><![CDATA[<p>下午从兵马俑赶去西安北站，和小伙伴们会合，下一站青海西宁。</p><p>随着火车不断靠近西宁，车上出现了十分有趣的现象：有人短袖，有人秋衣，有人冬装。只是到西宁后，能加的衣服都加了，虽然此时才十月一号。</p><p>到达西宁已是晚上七点多了，租的两辆车也已送到，一行人签好合同，便驱车前往早已预定好的民宿。</p><p>民宿主人是个很和善的阿姨，领着我们上楼、交代了几句后便离开了。民宿偏厅居然有麻将机。于是乎，几人轮番上阵，谁赢谁下。无奈技术出色加运气不赖，只好打一把歇一把。</p><p>第二日正式出发，第一站，日月山。</p><p>犹记刚看到西北地貌时，车里几个人的惊叫。开着开着，居然下起了小雪。而此时，已是到了日月山脚下了。我们稍作停留，下车去体验骑七彩牦牛，更是一激动，稍稍爬了下山。突然感到头晕目眩，才反应过来，此时已经海拔三千多米了！赶紧慢下来慢慢适应下。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409163505.jpg-growing" alt="七彩牦牛"></p><p>待爬上日月山时，雪又失去踪影，似不曾来过。而此刻只见日月山——传说中，由文成公主的宝镜所化。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409163513.jpg-growing" alt="日月山"></p><p>从日月山下来，便开往青海湖。沿途风光无限好。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409163604.jpg-growing" alt="大西北草原"></p><p>终于来到青海湖。一路上看到很多浪漫的骑行者。<br>各自观赏完后，打算一起拍个合照。打开三脚架，摆上相机，打算用延时摄影拍，弄了半天失败，又说可以手动控制，亦失败，请原谅几个新人。后来一个热心路人过来帮我们，无奈，鼓捣了半天，最后是用手机拍的，哈哈，开心就好了！<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409163639.jpg-growing" alt="青海湖"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409163707.jpg-growing" alt="青海湖"></p><p>等我们心满意足打算离去时，天已经快黑了。本打算去看日落，也是赶不到了。只是道路两边，风景满满。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409163728.jpg-growing" alt="黄昏"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409163831.jpg-growing" alt="黄昏"></p><p>路上经过一个很热闹的镇子，停下来吃饭，叫了羊肉，牦牛肉，各种肉。水足饭饱，继续赶往下一站。</p><p>以上</p><p>于 2018.10</p><blockquote><p> 以前发在简书的文章，可是最近简书莫名封了我的账号。又恰逢自己有了自己的 blog，便把之前的一些记忆拿了回来。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> 大西北 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大西北之旅 -- 西安</title>
      <link href="/travels/xi-an/"/>
      <url>/travels/xi-an/</url>
      
        <content type="html"><![CDATA[<p>今年的十一格外浪。</p><p>十一之前和朋友讨论去哪里浪，一曰西藏，坐飞机过去。我怕一下飞机就高反，想着坐火车过去，慢慢悠悠，还有一路风景可看。岂料另一朋友提议大西北，妙，众狐朋狗友一拍即合。</p><p>想着虽途经西安却未停留，实在遗憾，遂与一同样遗憾的朋友请假两天，直奔西安。</p><p>一下高铁，找到事先定好的民宿，放下行李，便马不停蹄的出来浪了。钟楼，鼓楼，回民街，以及晚上鼓楼的灯光表演。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409160830.jpg-growing" alt="傍晚时分"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161005.jpg-growing" alt="入夜后"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161023.jpg-growing" alt="灯光表演"></p><p>回到民宿已经很晚了，再加上一天的奔波，很快入睡。<br>考虑之后从西安北站出发，我们重新找了个近点的酒店。于是，你在街上看到两个英俊潇洒，风流倜傥，玉树临风的美男子，一人拖着一个箱子，边走边逛。待到西安碑林附近，见一老爷爷和一女孩说着西安的人文历史，附近的景点特色，十分有趣，我俩就在旁边“偷听”。</p><p>可能老爷爷也来了兴致，说做回免费导游，领着我们转转。我们原本打算去酒店的，毕竟还拖着旅行箱，此时也义无反顾，跟着姑娘和老爷爷逛了起来。</p><p>老爷子实在有趣，学识也很丰富，每到一处，便跟我们讲相关的历史和故事。说碑林刻有孔庙二字墙下的两颗千年古树，说城墙突出来的马面趣事，说鼓楼外领导人接待国外选手的新闻。一路上给小姑娘拍照片，教我们如何取景、构图，还问两个傻小伙子拖着箱子累不累！到午饭的点儿了，我们打算找一个地儿，请老爷子吃一顿，老爷子来了句“七十不留饭”，就走了。实在是自在的人。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161109.jpg-growing" alt="西安碑林"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161158.jpg-growing" alt="城墙马面"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161231.jpg-growing" alt="小狮子"></p><p>于是乎，两个傻小子和一个潇洒的姑娘共进了一顿午饭。姑娘也是一个很有趣的人，一个人从济南跑到了西安旅游。于我，是肯定没有这样的执行力的。很多时候，都是想想，真到了要去执行的时候，多半还是能找到安慰自己的理由，然后放弃。</p><p>点了传说中的 biangbiang 面，一饱口福。不得不说面食确实不错。这几日尝了油波面，凉皮等，即使我是个平日里对面食无感，地地道道的南方人，也得竖起大拇指。只是不知道是不是饿的。我不禁推断，旅游时由于累和饿从而导致了一批美食出来。</p><p>本来打算吃完就去酒店，结果发现小雁塔就在几百米之内。哎，于是又拖着箱子行走在路人诧异的目光中。可喜的是，小雁塔可以免费存放物品，工作人员更是十分善意的跑过来告诉我们，很感谢。之后居然又见到了那姑娘。只可惜脸皮太薄，最终还是没好意思要联系方式。</p><p>漫步园中，身边都是几百上千年的古树。这些古树从历史的长河中走来，见证了一代代王朝的更替。而我此刻正和它们共同呼吸。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161608.jpg-growing" alt="小雁塔"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161619.jpg-growing" alt="历史见证者"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161644.jpg-growing" alt="生命"></p><p>终于迎来十月一号，一大早就起来，乘坐发往兵马俑的公交车。约摸一个小时，便到了秦始皇陵。外面有一座始皇帝的雕像，随后见到了心心念念的，古代人民用勤劳和智慧打造出来的奇迹——兵马俑。<br>历史，这两个字从前只是一门课程，此刻却异常深厚，也十分残酷。不知道当年的始皇帝，会不会想到后面发生的一切。始皇帝，却不曾想二世而亡。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161746.jpg-growing" alt="秦始皇"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161922.jpg-growing" alt="兵马俑群像"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409161952.jpg-growing" alt="无头俑"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409162015.jpg-growing" alt="女俑"></p><p>老爷子说，你在西安随便走到一个地方，可能搁其他省市都要重点保护，可在西安不会，西安的历史太厚重。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409162054.jpg-growing" alt="博物馆标语"></p><p>以上</p><p>于 2018.10</p><blockquote><p> 以前发在简书的文章，可是最近简书莫名封了我的账号。又恰逢自己有了自己的 blog，便把之前的一些记忆拿了回来。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> 大西北 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>游记 -- 越南岘港</title>
      <link href="/travels/dandang/"/>
      <url>/travels/dandang/</url>
      
        <content type="html"><![CDATA[<p>记得初中学过一篇文章叫《第一次真好》，里面有一句话</p><blockquote><p>生命中的第一次愈多，生命也就愈益多姿多彩</p></blockquote><p>这是第一次出国，也是第一次坐飞机，兴奋着也激动着，心里虽如此，脸上却要努力平静着，毕竟，不再是那个拿着糖就可以手舞足蹈的年纪了。而后开始检票、托运、安检等一系列的手续，终于到了候机大厅了，再等了约莫 20 分钟，开始登机了。飞机不大，座位更是狭小，一下子让我平静了下来，只是等到起飞时，又忐忑了起来，好在一路平安，再加上夜晚，外面黑乎乎的一片，除了声音大点外，一切都还可以。</p><p>飞行了约莫 4 个小时，便到了越南了。下飞机后，才知道有一个小时的时差，第一次切身体验了下时差，实在有趣，赶紧给小伙伴们发了条微信。落地很不巧，正下着大雨，以为这几日要在酒店度过了。跟着导游到了当地的一家五星级酒店，办理好入住手续后，终于可以好好的休息下了。只是第一次入住海景房，看着窗外的海景，实在迷人。</p><p>一夜好梦。</p><p>早晨起来，打开窗帘，映入眼帘的，是蓝天白云，和碧蓝的大海，瞬间被吸引住，第一次看海。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409155808.jpg-growing" alt="碧海蓝天"></p><p>唤醒同事，洗漱完毕，去到酒店二楼吃完早餐，便迫不及待的奔向前面的海滩了。<br>阳光，沙滩，海浪，还有我。站在沙滩边，任凭海浪一次次的冲刷过来，听着海浪的声音，感受着海风从面颊吹过，冲走的是烦恼，留下的是惬意和愉悦。<br>在沙滩呆了一会儿，之后在导游的带领下，开启打卡模式。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409160147.jpg-growing" alt="岘港龙桥"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409160202.jpg-growing" alt="群山"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409160209.jpg-growing" alt="椰树"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409160217.jpg-growing" alt="越南观音菩萨"></p><p>傍晚时分，心血来潮，沿着沙滩线，跑了 2018 年的第一个十公里，大汗淋漓。虽然配速很慢，不过重在享受。第一次国外跑。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200409160234.jpg-growing" alt="健康跑步"></p><p>临走前一晚，总觉得少做了点什么。真切的感受到了越南的摩托车大军，吃到了特产海鲜，见识了大海。哦，是没有和大海来个亲切的接触！于是乎，叫上同事，在七八点钟的时候，走进了海里，浪来了，我岿然不动；浪来了，没事儿，小浪；浪来了，我去，这么大，被冲飞了，差点被吸下去！吓得我立马往后退了好几步。就这样，玩了一个多小时还意犹未尽！颇有“中流击水浪遏飞舟”之意。</p><p>最后一天早晨，起了个早，去沙滩上转一转，看见空着的沙滩椅，便躺了下，没多久，见一人过来，说了句英语，虽没听太懂，但大致意思是要收费的，此时才知道，这椅子原来不是随便躺的，立马起身走了，哈哈。</p><p>将拖鞋放到酒店前面的树下，赤着脚沿着沙滩晨跑了起来。突然看到零星的贝壳躺在沙滩上，顿时捡了起来，回来的路上更是没跑了，一来是想着再捡点贝壳，二来是脚底板是在是疼！最后拿着一手的贝壳，去餐厅和同事们一起吃早餐。一手的贝壳被同事分光，只留下了一个海螺(还好我事先把这唯一的小海螺收了起来)。吃完早餐，更是带着他们又去捡了一遍。只是几无收获。这就叫早起的鸟儿有虫吃吧。</p><p>下午，乘坐大巴奔赴机场，晚上八点多，落地萧山国际机场，三天的行程就此结束。</p><p>给我留下的，除了一个小海螺，还有我那晒伤的双脚(直接导致后面穿拖鞋上班)，以及那么多有趣的第一次。</p><p>以上</p><p>于 2018.9</p><blockquote><p>以前发在简书的文章，可是最近简书莫名封了我的账号。又恰逢自己有了自己的 blog，便把之前的一些记忆拿了回来。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> danang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>西游亦西行 -- 藏区游记&lt;完&gt;</title>
      <link href="/travels/tibet-2/"/>
      <url>/travels/tibet-2/</url>
      
        <content type="html"><![CDATA[<p>都说南迦巴瓦峰终年云雾缭绕，不肯露出真面目，故而得名羞女峰。</p><p>可能是我们这群人确实运气不错，开车的师傅也说很难得，我们到林芝的那天傍晚，就看到了藏于云雾之后的真容，虽然只露出了很短的时间。</p><p>很美丽。</p><p>可是我却更喜欢路上遇到的一个多雄拉雪山。</p><p>傍晚时分，夕阳下山，可是藏区的夕阳，并非如江南那般柔和。我坐在车里，看着窗外的景色。也不知为什么，就抬起了头，就见那座雪峰立在那里。阳光透过它尖上终年不化的积雪，使得那本就洁白的雪，竟显得圣洁起来。我盯着看了很久，以至于忘了喊师傅停下来拍张照片。</p><p>是的，这个时候，我们往往会选择用照片来记录下这些美好的瞬间。只是这次，我得记在心里了。</p><p>我们在这个小村庄里呆了一宿，第二天就继续上路了。</p><p>去了巴松措，去了色季拉山，去了传说中的羊湖，去了日喀则，去了绒布寺，顺便在珠峰大本营住了一晚上。</p><p>要不怎么说我们运气好，师傅说大本营那几天才开放！</p><p>我现在还记得，在海拔 5000 米的大本营，我激动的忘记了缺氧这回事儿。一个人在那跳来跳去，跑来跑去。从住的帐篷跑到绒布寺，又从绒布寺跑到珠峰的界碑那，快哉。</p><p>我们在刻有 8844.43 的界碑那拍照，身后就是传说中的珠峰。</p><p>等我在外面溜达完回到帐篷时，几个小伙伴都在那安静的整理一路上的照片。</p><p>晚上睡觉的时候，本以为经过好几个晚上的磨练，已经可以适应了。可还是小看了这 5000 米海拔的厉害。</p><p>终于熬到凌晨四点左右，拉着几个小伙伴哆哆嗦嗦的跑起来，去拍星星去了。</p><p>冷，是真的冷。</p><p>夜空的星星，确实比平日里看到的要多的多。只是小时候，夏天的夜晚，星星也出奇的多，出奇的亮。</p><p>我们几个人，就在瑟瑟寒风中，一边拍着延时，一边低声聊着天。</p><p>从大本营下来后，整个的藏区之行，差不多就要结束了。</p><p>下来后，同行的一个姑娘，虽然是个南方女孩子，却甚是豪爽的在吃饭的时候，拉着我们喝起了酒，自然是啤酒。</p><p>只是熟悉我的人都知道，酒量巅峰期应该是大学那会儿，曾经喝过一瓶多的啤酒，喝完回宿舍后，就去厕所吐了。然而此刻，却是真切的觉得，就该喝一点。</p><p>好在师傅很克制，知道明天还要开车上路，就每个人都只喝了一点。嗯，那自然是对他们而言！于我，虽然我忘记喝了多少，但是回去后，我就全身泛红，头晕脑胀了。</p><p>那个时候，我只想着睡一觉，可是那几个家伙，却偏偏要打掼蛋！作为一个头晕脑胀且基本不会打掼蛋的人而言，和他们打了好一会儿。</p><p>只是这段时光，此刻想起来，异常怀念。</p><p>突然想起一八年的元旦，和几个朋友去黄山玩，也是在回来的前一个晚上，打了好一会儿牌，最后房东打电话来，说有旅客投诉我们太吵了。。。</p><p>不过这次自是没有人投诉的。</p><p>后面回到拉萨，每个人都买了一堆的牦牛干什么的土特产，送同事，送朋友，自己享用，都是不错的选择。</p><p>再后面，就是师傅大清早的，送我们去贡嘎机场。</p><p>而后我们就离西藏越来越远。</p><p>而后我们几个小伙伴也各自分别。</p><p>每个去西藏的人，都盼着能洗涤心灵。只是，给我的感动，随着时间的推移，已寥寥无几。多出来的，只是和别人的谈资。</p><p>或许在某个阳光明媚的下午，我坐在电脑面前敲代码，偶尔闭上眼睛，会不经意想起这段旅程来。</p><p>以上</p><p>于 2019.4</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> tibet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>西游亦西行 -- 藏区游记</title>
      <link href="/travels/tibet/"/>
      <url>/travels/tibet/</url>
      
        <content type="html"><![CDATA[<p>不知不觉，进藏已三日有余。</p><p>记得飞机降落在贡嘎机场，一直当心的高反没有发生后，是雀跃的。只是随后的一系列不适，让我记忆犹新。</p><p>当晚到达酒店后，没有洗澡(进藏后不要轻易洗澡)，简单洗漱后直接入睡。然而伴随而来的是一两个小时就醒来一次的简短睡眠，心脏加速，头疼。只盼着早点天亮，就不用再睡觉了。</p><p>太阳终究还是缓缓升了起来，我也终于不用继续躺在床上。有趣的是，当我走出酒店，之前所有的不适统统消散，我们去吃早餐，喝甜茶，漫步于西藏街道，流连在布达拉宫。</p><p>一路上看着或捻动佛珠，或转动转经筒，或三步一扣的人们，肃穆而虔诚。在这里，你能够真真切切的看到信仰。在大昭寺，众多的信徒们在行着跪拜礼朝圣。有戴着眼镜斯斯文文的青年，有穿着时尚结伴而行的夫妻，有头扎长辫一身艺术气息的独行者，还有年迈沧桑的老人，你无法知道他们各自的目的，是寻求内心的安宁，是渴望佛祖的帮助，是逃离生活的苦难，还是仅仅传下的一种仪式。不管是什么，他们都在自己的信仰下，昂首前行。</p><p>我在朋友圈写到</p><blockquote><p>现在，亲眼看着朝圣者们三步一跪，一心向前，仿佛这个世界，可以简单到他和他心中的信仰，再无其他。</p></blockquote><p>其中一个朋友留言问我说，你有信仰么？坦白说，我是没有的。如果硬要说有，那无非是信奉钱。我们从小到大接受到的教育，包括各路媒体吹捧的所谓成功，都在有意无意的告诉我们钱的魅力。很显然，我接受了这样的认知。</p><p>这些也只是对我价值观的一次冲击，并不会毁灭掉。我想回去之后，还是会和往常一样。当然，若是能因此有一些改变，那自是最好不过了。</p><p>晚上拍完布达拉宫的夜景，打算回去时，才通过电话得知有人感冒。都说高原地区的感冒很可怕，要十分当心。我们便立马赶去医院。好在打针加吃药加贴各种退烧贴后，好了起来。可是我倒下了。</p><p>晚上的睡眠依旧和挤牙膏一样。早晨打算起来时才发现，一点都不想动，头疼，晕，心脏快速跳动以抗议这个身体的主人，起来没走几步就想吐。在吐了好几口口水，以及同伴们各种药物的支撑下，终于慢慢好了起来。</p><p>沿途去办理边防证的时候，我沿着河边慢慢散步，身边偶尔经过几个晨跑者，内心也跃跃欲试。于是在海拔 3600 多米的拉萨，跑了不到一百米，立马就开始大口喘气，只能立即停下来。</p><p>你除了想到呼吸，感受到头疼，其他的似乎一下子都不见了。</p><p>晚上的篝火舞会，也慢慢让旅行变得欢快起来。看着老大爷们载歌载舞，无论是不是工作需要，我想，当下，他们都是开心的。我也希望在那个年纪，依旧有着一颗年轻的，躁动的内心。</p><p>很多时候，我们都习惯以自己的认知去评判一些事情。就好像我觉得公务员一直很轻松一样，就好像我觉得那个跳舞的大叔一直很快乐一样。</p><p>西藏之旅继续。</p><p>以上</p><p>于 2019.4</p><blockquote><p> 以前发在简书的文章，可是最近简书莫名封了我的账号。又恰逢自己有了自己的 blog，便把之前的一些记忆拿了回来。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> tibet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part 4 --ZooKeeper Zab Protocol</title>
      <link href="/zookeeper/zab/"/>
      <url>/zookeeper/zab/</url>
      
        <content type="html"><![CDATA[<h1 id="ZooKeeper-lt-四-gt-ZAB-协议"><a href="#ZooKeeper-lt-四-gt-ZAB-协议" class="headerlink" title="ZooKeeper<四> ZAB 协议"></a>ZooKeeper&lt;四&gt; ZAB 协议</h1><p>zab 协议全称 ZooKeeper Atomic Broadcast Protocol 。</p><p>它作为 zk 最核心的协议，贯穿了 zk 的始终。    </p><p>我们知道 zk 从启动到挂掉，无非做这么几件事：</p><ul><li>选举 leader</li><li>发现 server</li><li>同步 事务</li><li>广播 事务</li><li>崩溃再选举</li></ul><p>而 zab 则是这些事情的保障，它让所有的事情按照我们期待的方向行进。现在去看看 zk 究竟是如何去做这些事情的。</p><h2 id="Election"><a href="#Election" class="headerlink" title="Election"></a>Election</h2><p>前文已经介绍，zk 使用 FLE 进行选举，是现在 zk 唯一支持的选举算法。这里不再赘述。</p><p>其他阶段，这里分 Leader  和 Follower 两个角色进行解读。</p><h2 id="Leader"><a href="#Leader" class="headerlink" title="Leader"></a>Leader</h2><h3 id="1-Discovery"><a href="#1-Discovery" class="headerlink" title="1. Discovery"></a>1. Discovery</h3><p>我们前面解析源码的时候，在 <code>QuorumPeer</code> 这个类里，说过它的 <code>run</code> 方法，里面有个 <code>switch...case</code> ，会对 <code>serverState</code> 的不同状态，做不同处理。</p><p>当时我们看了 <code>LOOKING</code> 的 case，因为这里是 election 的入口。</p><p>现在选举结束后，<code>serverState</code> 会切换成其他状态，同时 zabState 也同样会切换</p><p>我们再来看下这个<code>run</code> 方法(截取部分)：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 源码参考： org.apache.zookeeper.server.quorum.QuorumPeer#run</span><span class="token keyword">case</span> LEADING<span class="token operator">:</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token function">setLeader</span><span class="token punctuation">(</span><span class="token function">makeLeader</span><span class="token punctuation">(</span>logFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 这个方法里有一个 while ，如果退了出来，</span>        <span class="token comment" spellcheck="true">// 说明该 server 的领导结束，会进行下一次的选举</span>        leader<span class="token punctuation">.</span><span class="token function">lead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setLeader</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            leader<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token string">"Forcing shutdown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">setLeader</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里会把 serverState 重新置为 LOOKING 状态</span>        <span class="token comment" spellcheck="true">// 从而在整个 while 里再次发起选举</span>        <span class="token function">updateServerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>好，从上面能看到，被选为 leader 后，所有的奥秘，都在 <code>leader.lead()</code> 这个方法中了。现在去看看这个家伙，究竟背着我们都做了些什么！！！</p><p>我看了下这个方法， 从 576 行到 874 行，共计 <code>874 - 576 = 298</code> 行，我们平时这么写代码，估计会被打死，然后领导们说，你这个方法怎么能写这么多行呢！！！ 啊哈哈哈 :joy:</p><p><strong>整个阶段都需要对照：</strong></p><pre><code>org.apache.zookeeper.server.quorum.LearnerHandler#run</code></pre><p><strong>LearnerHandler</strong> ，会为每一个跟随者分配一个连接，负责和 server 整个生命周期间的通信。</p><p>同时注意 <code>Leader</code> 和 <code>LearnerHandler</code> 在几个关键节点的同步：</p><ul><li><p>getEpochToPropose：handler 会获取超过半数的 server epoch，一次产生 leader 新的 epoch </p></li><li><p>waitForEpochAck ： handler 会获取超过半数的 server ack ，以此为基础进行同步</p></li><li><p>waitForNewLeaderAck：等待 server 同步的结果。整个同步过程，都是 handler 负责处理的。</p></li></ul><p>正是通过这几个方法，使得虽然是异步进行，但最终在关键节点上，都会等待各自完成各自的事情！！！</p><pre class=" language-java"><code class="language-java">self<span class="token punctuation">.</span><span class="token function">setZabState</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>ZabState<span class="token punctuation">.</span>DISCOVERY<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>可以看到，这个方法开始时，将 <code>zabState</code> 的状态设置为了 <code>DISCOVERY</code> ，也就是说，zk 正式从选举阶段进入到发现阶段：</p><pre class=" language-java"><code class="language-java">self<span class="token punctuation">.</span><span class="token function">setZabState</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>ZabState<span class="token punctuation">.</span>DISCOVERY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 这里把自己的 epoch 和 zxid 放到 StatueSummary 中，方便之后的比较</span>leaderStateSummary <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StateSummary</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getCurrentEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> zk<span class="token punctuation">.</span><span class="token function">getLastProcessedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 开启线程接受 followers 的连接</span>cnxAcceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LearnerCnxAcceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cnxAcceptor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 这个方法用于获取 epoch ， +1 即为新 leader 的 epoch ，它的国号！--- [1]</span><span class="token keyword">long</span> epoch <span class="token operator">=</span> <span class="token function">getEpochToPropose</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// zk 在获取到所有连接中最大的 epoch 后，+1 ， 然后低 32 位清零，即为新的 zxid</span>zk<span class="token punctuation">.</span><span class="token function">setZxid</span><span class="token punctuation">(</span>ZxidUtils<span class="token punctuation">.</span><span class="token function">makeZxid</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// 等待超半数的 server 的 epoch ack， 确认新的 epoch 下发到半数以上的 server</span><span class="token comment" spellcheck="true">// 这里的处理方式和上面获取最大 epoch 一样</span><span class="token comment" spellcheck="true">// zk 认为，等到足够多的 epoch ack 后，选举才算结束</span><span class="token function">waitForEpochAck</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> leaderStateSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>self<span class="token punctuation">.</span><span class="token function">setCurrentEpoch</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">;</span>self<span class="token punctuation">.</span><span class="token function">setLeaderAddressAndId</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getQuorumAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>self<span class="token punctuation">.</span><span class="token function">setZabState</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>ZabState<span class="token punctuation">.</span>SYNCHRONIZATION<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>到这里， <code>Discovery</code> 阶段就结束了。我们总结下 <strong><code>Discovery</code> 阶段， leader 主要做了什么</strong>：</p><ul><li>获取最新的 epoch<ul><li>收到 FOLLOWERINFO 或者  OBSERVERINFO 类型的 qp (quorum packet)</li><li>统计并获取最大的 epoch，设置新的 epoch</li><li>回复 LEADERINFO 类型的 qp ，同时把新的 epoch 告诉当前的 server</li></ul></li><li>获取超过半数的 server 的连接(waitForEpochAck)：<ul><li>handler 等待 follower/observer  ACKEPOCH 类型的回复，超过半数表明新的 epoch 设置成功</li></ul></li></ul><h3 id="2-Synchronization"><a href="#2-Synchronization" class="headerlink" title="2. Synchronization"></a>2. Synchronization</h3><pre class=" language-java"><code class="language-java">self<span class="token punctuation">.</span><span class="token function">setZabState</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>ZabState<span class="token punctuation">.</span>SYNCHRONIZATION<span class="token punctuation">)</span><span class="token punctuation">;</span>    </code></pre><p>这里开始， zab 协议进入到同步阶段，我们看看同步阶段， leader 都会做哪些事情：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** 与 [1] 一摸一样的处理方式， 获取超过半数的 ack，我们去查看这个方法的调用，能看到在 learnerHandler 中被调用了，而在调用之前，learnerHandler 做的事情就是和与之连接的 server 进行同步*/</span><span class="token function">waitForNewLeaderAck</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> zk<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 这里会开启 leader 的事务处理责任链 --- [2]</span><span class="token function">startZkServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 这里就是在 how-to-use 中介绍的配置，设为 yes(默认)，即表明 leader 也会接受 client 连接</span><span class="token comment" spellcheck="true">// 将 zkServer 放入到 ServerCnxFactory 中</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"zookeeper.leaderServes"</span><span class="token punctuation">,</span> <span class="token string">"yes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    self<span class="token punctuation">.</span><span class="token function">setZooKeeperServer</span><span class="token punctuation">(</span>zk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 这就到 BROADCAST 了？？？</span><span class="token comment" spellcheck="true">// 是的，因为我有助手 learnerHandler</span>self<span class="token punctuation">.</span><span class="token function">setZabState</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>ZabState<span class="token punctuation">.</span>BROADCAST<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这里先介绍下同步时的几种类型(可以同时思考下，分别什么情况，会导致下面的类型处理)：</p><ul><li>DIFF：差异同步</li><li>TRUNC：回滚同步</li><li>SNAP：全量同步</li></ul><p>这个时候，我们去看 <code>LearnerHandler</code>  从 <code>waitForEpochAck</code> 到 <code>waitForNewLeaderAck</code> 中间部分的代码</p><h4 id="syncFollower"><a href="#syncFollower" class="headerlink" title="syncFollower"></a><code>syncFollower</code></h4><p><code>org.apache.zookeeper.server.quorum.LearnerHandler#syncFollower</code></p><ol><li><p>leader lastProcessedZxid == peerLastZixd： 说明事务一致，无需同步，此时 leader 会发送一个空的 DIFF qp 给 follower</p></li><li><p>peer lastProcessedZxid 在 [minCommittedLog, maxCommittedLog] 之间，这个区间是 zk 维护的一份 commit queue，用来快速与各 server 同步。在此之间说明 peer 的事务与 leader 之间存在差异，zk 会先发一个 DIFF qp 给 server ，然后将区间中比 peer zxid 大的事务，以 Proposal 的方式发送给 server，server 收到后，回复 ack </p></li><li><p>peer lastProcessedZxid &gt; maxCommittedLog 时，就需要进行 trunc ，同上，也是先发送 TRUNC qp，然后通过 Proposal 进行回滚同步</p></li><li><p>peer lastProcessedZxid &lt; minCommittedLog 时，zk 会先尝试 <code>on-disk txnlog + committedLog</code> 的方式进行同步，如果失败，则使用 <strong>SNAP</strong> 的方式进行同步。 SNAP 会从磁盘读取 <code>snapshot.xxx</code> 命名的文件，序列化后发送给 server</p></li></ol><p>上述同步完成后，leader 会发送一个 <code>NEWLEADER</code> qp 给 server，告知同步结束，得到足够 server 的 ack 回复后(这里就是 leader 和 learnerHandler 的一个同步点，也就是方法 <code>waitForNewLeaderAck</code>)，leader 将执行 <code>startZKServer</code> 方法，而此可的 <code>learnerHandler</code> 也会等待 zkServer 的启动。</p><h4 id="startZkServer"><a href="#startZkServer" class="headerlink" title="startZkServer"></a><code>startZkServer</code></h4><p><code>org.apache.zookeeper.server.quorum.Leader#startZkServer</code></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 来源于基类 org.apache.zookeeper.server.ZooKeeperServer#startup</span><span class="token comment" spellcheck="true">// 截取部分代码</span><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 这里就是上文提到的 leader 处理事务的责任链</span>    <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 设置 zk 状态</span>    <span class="token function">setState</span><span class="token punctuation">(</span>State<span class="token punctuation">.</span>RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 通知所有等待在该对象上的线程</span>    <span class="token comment" spellcheck="true">// 这些线程即负责与各个 server 连接的 learnerHandler</span>    <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><code>zkServer</code> 启动后， learnerHandler 就会发送一个 <code>UPTODATE</code> 的报文给各个 server ，告诉他们，我们准备好了，可以开门接客，啊呸，可以接受 client 的连接了。</p><h3 id="3-Broadcast"><a href="#3-Broadcast" class="headerlink" title="3. Broadcast"></a>3. Broadcast</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 检查 quorumPeer 和 zkServer 的状态，不对劲就会跳出 while</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// follower 未超过半数，跳出 while</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tickSkip <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>syncedAckSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 定时发送 ping 报文</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>LearnerHandler f <span class="token operator">:</span> <span class="token function">getLearners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        f<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 如果从 while 跳出，这里的 msg 会有值，代码被我精简了</span><span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> shutdownMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">shutdown</span><span class="token punctuation">(</span>shutdownMessage<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这是 leader.lead() 方法去做的，可是我们已经知道，leader 和 server 之间的工作，大部分都由 learnerHandler 在处理。所以这个时候，我们还得去看看 <code>learnerHandler</code> 在搞些什么事情</p><pre class=" language-java"><code class="language-java"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ia<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> Leader<span class="token punctuation">.</span>ACK<span class="token operator">:</span>        <span class="token comment" spellcheck="true">// ...</span>    <span class="token keyword">case</span> Leader<span class="token punctuation">.</span>PING<span class="token operator">:</span>        <span class="token comment" spellcheck="true">// ...</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> Leader<span class="token punctuation">.</span>REVALIDATE<span class="token operator">:</span>        <span class="token comment" spellcheck="true">// ...</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> Leader<span class="token punctuation">.</span>REQUEST<span class="token operator">:</span>        <span class="token comment" spellcheck="true">// ...</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"unexpected quorum packet, type: {}"</span><span class="token punctuation">,</span> <span class="token function">packetToString</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>可以看到， learnerHandler 通过 switch…case… 来处理来自 server 的各个类型请求，一旦出了问题，就会抛出异常，最后在 finally 代码块中，shutdown</p><h2 id="Follower"><a href="#Follower" class="headerlink" title="Follower"></a>Follower</h2><p>对于 Follower 而言，同样要从  <code>QuorumPeer</code> 的 run 方法的 switch…case… 代码块入手，这里就不再贴代码了，就简单梳理下大致的流程，以及各个阶段和 leader 的通信。</p><h3 id="1-Discovery-1"><a href="#1-Discovery-1" class="headerlink" title="1. Discovery"></a>1. Discovery</h3><ul><li><p>Follower (下文以 F 代替)，通过 <code>org.apache.zookeeper.server.quorum.Learner#connectToLeader</code> 与新 leader 建立 TCP 连接。</p></li><li><p>F 发送 <strong>FOLLOWERINFO</strong> 类型 qp 给 leader(如果是 observer ，发送的类型为 OBSERVERINFO)，被 <code>learnerHandler</code> 接收。</p><p>前文提到 leader 在执行 lead 方法的时候，会先去创建 <code>LearnerCnxAcceptor</code> –&gt;  <code>LearnerCnxAcceptorHandler</code> –&gt; <code>LearnerHandler</code> , 这一些列代码执行后，就在等待 F 连接并发送 FOLLOWERINFO  报文。这是他们通信的第一个报文，如果不是，这个连接就会被 leader 舍弃掉</p></li><li><p>等待 leader 的 <strong>LEADERINFO</strong> qp， 该报文含有 leader 的最新 epoch ，所以 F 设置新的 epoch，同时发送 <strong>ACKEPOCH</strong> 类型 qp 给 leader</p></li></ul><p>discovery 阶段结束</p><h3 id="2-Synchronization-1"><a href="#2-Synchronization-1" class="headerlink" title="2. Synchronization"></a>2. Synchronization</h3><p>leader 通过 <code>learnerHandler</code> 发送的同步标志(DIFF/TRUNC/SNAP) ，进行不同的处理和回复，在 <code>org.apache.zookeeper.server.quorum.Learner#syncWithLeader</code> 中，我们可以看到不同的处理方式。</p><p>同步结束后， leader 会发送一个 <strong>NEWLEADER</strong> qp 给 F，F 回 ACK， leader 收到超半数 ack 后，发送 <strong>UPTODATE</strong> qp，F 收到该类型的 qp 后，会跳出 while 循环：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">case</span> Leader<span class="token punctuation">.</span>UPTODATE<span class="token operator">:</span>    <span class="token keyword">break</span> outerLoop<span class="token punctuation">;</span></code></pre><p>后续代码会回复 ACK，同时启动 zkServer：</p><pre class=" language-java"><code class="language-java">ack<span class="token punctuation">.</span><span class="token function">setZxid</span><span class="token punctuation">(</span>ZxidUtils<span class="token punctuation">.</span><span class="token function">makeZxid</span><span class="token punctuation">(</span>newEpoch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">writePacket</span><span class="token punctuation">(</span>ack<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sock<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>tickTime <span class="token operator">*</span> self<span class="token punctuation">.</span>syncLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>self<span class="token punctuation">.</span><span class="token function">setSyncMode</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>SyncMode<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>zk<span class="token punctuation">.</span><span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>而 F 的 zkServer ，同样会开启一条事务处理的责任链：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    RequestProcessor finalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitProcessor</span><span class="token punctuation">(</span>finalProcessor<span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">getZooKeeperServerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    firstProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FollowerRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> commitProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span>FollowerRequestProcessor<span class="token punctuation">)</span> firstProcessor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    syncProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendAckRequestProcessor</span><span class="token punctuation">(</span><span class="token function">getFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    syncProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>通过代码可以看到，F 的责任链如下：</p><ul><li><p>FollowerRequestProcessor –&gt; CommitProcessor –&gt; FinalRequestProcessor</p></li><li><p>SyncRequestProcessor –&gt; SendAckRequestProcessor</p></li></ul><p>通过这些责任链，将一条事务的处理变得分工明确。</p><h3 id="3-Broadcast-1"><a href="#3-Broadcast-1" class="headerlink" title="3. Broadcast"></a>3. Broadcast</h3><p><code>syncWithLeader</code> 执行完毕，也就是同步完成后， F 就进入到广播阶段。</p><p>如果该 F 配置了 <code>observerMasterPort</code> ，这里还会启动一个 <code>ObserverMaster</code> 线程，用来与 observer 事务同步</p><pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getObserverMasterPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObserverMaster</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fzk<span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">getObserverMasterPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    om<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">readPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">processPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里同样，通过 while ，保持与 leader 之间的联系</p><h2 id="一条写事务"><a href="#一条写事务" class="headerlink" title="一条写事务"></a>一条写事务</h2><p>我们已经知道，<code>ServerCnxnFactory</code> (我们没有配置 netty ，这里指 NIOServerCnxnFactory)，负责整个生命周期与 client 的连接。先看下 <code>NIOServerCnxnFactory</code> 的类图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200410190237.png-growing" alt="NIOServerCnxnFactory"></p><p>继承自 <code>ServerCnxnFactory</code> ，内部主要有：</p><ul><li>IOWorkRequest：负责处理 IO 的读写( m 个，可配置，默认 核数*2 )</li><li>ConnectionExpirerThread：负责清理与客户端的 异常/失效/过期 连接 (1 个线程)</li><li>AcceptThread：负责接收来自 client 的连接并分配给 selectorThread (1 个线程)</li><li>SelectorThread：负责与 client 的连接处理( n 个，可配置，或者取 核数/2 的平方根)</li></ul><p>当客户端请求过来后，由 selectorThread 交由 IOWorkRequest(事实上，IOWorkRequest 线程池处理) 的 doWork 处理，doWork 处理后，交由 NIOServerCnxn 的 doIO 处理，该类真正负责与 client 的通信。若是接收 client 的信息，则交由该类的 readPayload 处理，它简单处理后，再给 readRequest(or readConnectRequest) 方法：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>    zkServer<span class="token punctuation">.</span><span class="token function">processPacket</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> incomingBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这个方法很简单，就i是把这个 request 交给 zkServer 处理，最终会添加到：</p><pre class=" language-java"><code class="language-java">LinkedBlockingQueue<span class="token operator">&lt;</span>Request<span class="token operator">></span> submittedRequests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token operator">&lt;</span>Request<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>而这个属性，会由该类，也就是 <code>RequestThrottler</code> 线程的 run 方法处理，通过 take() 方法，阻塞，直到有消息过来。</p><p>最终会交由 <code>ZooKeeperServer</code> 来处理：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// org.apache.zookeeper.server.ZooKeeperServer#submitRequestNow</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitRequestNow</span><span class="token punctuation">(</span>Request si<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 这里可以看到，这个消息交给了 Follower 的责任链处理</span>        firstProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MissingSessionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">requestFinished</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RequestProcessorException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">requestFinished</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>到了这里，我们基本能理清，从 client 发出一个消息，到最终这个消息被处理的流程</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200410221247.png-growing" alt="zk"></p><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><h3 id="1"><a href="#1" class="headerlink" title="[1]"></a>[1]</h3><pre class=" language-java"><code class="language-java">cnxAcceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LearnerCnxAcceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cnxAcceptor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> epoch <span class="token operator">=</span> <span class="token function">getEpochToPropose</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们来说下这三行。</p><p>前两行用于开启线程，接受 followers 的连接。接受连接是干嘛的？</p><p>我们知道， 新的皇帝会有新的年号，zk 中新的 leader 也会更新自己的 epoch 。</p><p>假设集群中有一个与世隔绝的 C follower ，一直没有获取到 leader 的 epoch 。而之后这个 leader 挂掉了，恰巧这个 C 当选为新的 leader ，它要产生自己的 epoch ，怎么办呢？直接在自己的 epoch 上加一？</p><p>那肯定不行！你不能确定这个 epoch 有没有被其他 leader 用过！</p><p>zk 通过上面三行，还获取 ensemble 中最新的 epoch，也就是当前 ensemble 中最大的 epoch ，之后加一后用作新的 epoch 。</p><p>这里整体的处理，在 zk 中，这种处理方式很常见。</p><p>如果是我写，肯定会先去等待所有的连接，超过半数后，统计所有的 epoch ，然后和自己的 epoch 一起比较，获取最大的 epoch，加一，成为新 leader 的 epoch 。</p><p>嗯，十分凡夫俗子的想法。</p><p>我们看看这帮一个方法写了几百行的家伙是怎么做的。</p><ol><li><p>先通过 <code>LearnerCnxAcceptor</code> 这个类，去开启 <code>learnerHandler</code> ，这个是用来处理其他 server 的连接的，然后在这个 handler 里获取最新的 epoch，嗯哼，epoch 可是还没产生哦！</p><pre class=" language-java"><code class="language-java"><span class="token keyword">long</span> zxid <span class="token operator">=</span> qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> newEpoch <span class="token operator">=</span> learnerMaster<span class="token punctuation">.</span><span class="token function">getEpochToPropose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lastAcceptedEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> newLeaderZxid <span class="token operator">=</span> ZxidUtils<span class="token punctuation">.</span><span class="token function">makeZxid</span><span class="token punctuation">(</span>newEpoch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Leader 主线程里，也通过 <code>getEpochToPropose</code> 获取最新的 epoch</p></li><li><p>所以关键就在这个 <code>getEpochToPropose</code> 这里了。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// org.apache.zookeeper.server.quorum.Leader#getEpochToPropose</span><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getEpochToPropose</span><span class="token punctuation">(</span><span class="token keyword">long</span> sid<span class="token punctuation">,</span> <span class="token keyword">long</span> lastAcceptedEpoch<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 加锁，这是个 set 集合，用来存储所有连接的 server myid</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>connectingFollowers<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 标记位，初始为 true</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>waitingForNewEpoch<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> epoch<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里处理新的 epoch ，只要你的 epoch 比我大，你就能取代我</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastAcceptedEpoch <span class="token operator">>=</span> epoch<span class="token punctuation">)</span> <span class="token punctuation">{</span>            epoch <span class="token operator">=</span> lastAcceptedEpoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 校验 server 是否是合法的投票团成员</span>        <span class="token comment" spellcheck="true">// 这里的顺序表明，你可以不是投票方的成员，只要你传过来的 epoch 比我大就好</span>        <span class="token comment" spellcheck="true">// 为什么是这样呢? 我理解为根据 zab 协议，这里最高的 epoch 必然从合法投票团成员中产生</span>        <span class="token comment" spellcheck="true">// 所以这里的处理方式是你大你有理</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isParticipant</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            connectingFollowers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        QuorumVerifier verifier <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">getQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 获得了超过半数的连接，拿到最新的 epoch，设置 flag 为 false</span>        <span class="token comment" spellcheck="true">// 同时通知所有等待的线程</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>connectingFollowers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> verifier<span class="token punctuation">.</span><span class="token function">containsQuorum</span><span class="token punctuation">(</span>connectingFollowers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            waitingForNewEpoch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            self<span class="token punctuation">.</span><span class="token function">setAcceptedEpoch</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">;</span>            connectingFollowers<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">long</span> start <span class="token operator">=</span> Time<span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sid <span class="token operator">==</span> self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                timeStartWaitForEpoch <span class="token operator">=</span> start<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">long</span> cur <span class="token operator">=</span> start<span class="token punctuation">;</span>            <span class="token keyword">long</span> end <span class="token operator">=</span> start <span class="token operator">+</span> self<span class="token punctuation">.</span><span class="token function">getInitLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span><span class="token function">getTickTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 这里通过 while + wait 实现</span>            <span class="token comment" spellcheck="true">// 即所有访问这个方法的线程，在没有获得半数连接的时候，最终都会在这里去等待</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>waitingForNewEpoch <span class="token operator">&amp;&amp;</span> cur <span class="token operator">&lt;</span> end <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>quitWaitForEpoch<span class="token punctuation">)</span> <span class="token punctuation">{</span>                connectingFollowers<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>end <span class="token operator">-</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>                cur <span class="token operator">=</span> Time<span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingForNewEpoch<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token string">"Timeout while waiting for epoch from quorum"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> epoch<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ol><p>我在上面的代码上加了一点注释，下面再仔细说下。</p><p>我们知道，java 里 <code>wait</code> 和 <code>notifyAll</code> 是 <code>Object</code> 里的两个方法。对于长期写业务代码的我而言，几乎没怎么用过。今天也是看到这里后，才知道原来还可以这么玩。</p><p><code>java.lang.Object#wait(long, int)</code> 的文档上，说：</p><blockquote><p>This method causes the current thread (referred to here as <var>T</var>) to place itself in the wait set for this object and then to relinquish any and all synchronization claims on this object. Note that only the locks on this object are relinquished; any other objects on which the current thread may be synchronized remain locked while the thread waits.</p></blockquote><p>意思是说，这个方法，会让当前的线程放到锁对象的等待列表中，对于上面的代码，就是所有访问的线程都被放到了 <code>connectingFollowers</code> 这个对象的等待列表里。</p><p>但是这个方法加了同步锁，一个线程过来了，其他线程还怎么访问呢?</p><p><code>wait</code> 的 doc 说，同时<strong>会放弃且只放弃</strong>所有该对象上的同步声明(synchronization claims)，也就是之前获得的这个对象(这里指 <code>connectingFollowers</code>) 上的锁，此时，其他线程可以再次竞争。</p><p>直到有线程 notify 或者 notifyAll 或者 interrupted 或者超时。</p><p>所以这里，我就能理解了。</p><p>所有 server 的连接，包括自己，都会在这里去等待超过半数的连接，达到标准后，会被唤醒，然后各干各的事情。</p><h3 id="2"><a href="#2" class="headerlink" title="[2]"></a>[2]</h3><p>我们逐步点击这个方法，会发现它有调用两个方法：</p><pre class=" language-java"><code class="language-java"><span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">startRequestThrottler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>第一个方法就是用来开启责任链，负责 leader 期间所有事物的处理。</p><p>第二个方法相当于一个阀门，用来约束请求数量。</p><p>我们把重点放到第一个方法上，看看它做了什么：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    RequestProcessor finalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    RequestProcessor toBeAppliedProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Leader<span class="token punctuation">.</span>ToBeAppliedRequestProcessor</span><span class="token punctuation">(</span>finalProcessor<span class="token punctuation">,</span> <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitProcessor</span><span class="token punctuation">(</span>toBeAppliedProcessor<span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">getZooKeeperServerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ProposalRequestProcessor proposalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProposalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> commitProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 这里注意， initialize 方法里，会初始化另外一条 syncRequestProcessor</span>    proposalProcessor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    prepRequestProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrepRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> proposalProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>    prepRequestProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    firstProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LeaderRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> prepRequestProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setupContainerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里能很清楚的看到整个 <strong>leader</strong> 处理请求的链条：</p><p>LeaderRequestProcessor  –&gt;  PrepRequestProcessor  –&gt;  ProposalRequestProcessor –&gt;  CommitProcessor –&gt; ToBeAppliedRequestProcessor  –&gt; FinalRequestProcessor</p><p><strong>leader</strong> 同时还有一条责任链，负责记录事务到磁盘：</p><p>SyncRequestProcessor –&gt;  AckRequestProcessor</p><p>至于每个 processer 负责什么事情，大家可以去代码里瞧一瞧看一看，相信会有收获，这里暂时不再赘述。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part 3 -- ZooKeeper FastLeaderElection</title>
      <link href="/zookeeper/fast-leader-election/"/>
      <url>/zookeeper/fast-leader-election/</url>
      
        <content type="html"><![CDATA[<h1 id="ZooKeeper-lt-三-gt-Leader-选举"><a href="#ZooKeeper-lt-三-gt-Leader-选举" class="headerlink" title="ZooKeeper <三> Leader 选举"></a>ZooKeeper &lt;三&gt; Leader 选举</h1><p>ZooKeeper version： 3.6.0</p><h2 id="ZooKeeper-的启动"><a href="#ZooKeeper-的启动" class="headerlink" title="ZooKeeper 的启动"></a>ZooKeeper 的启动</h2><p>ZooKeeper 是如何启动的？！！这个问题要从哪里找答案呢?</p><h3 id="1-zkServer-sh"><a href="#1-zkServer-sh" class="headerlink" title="1. zkServer.sh"></a>1. zkServer.sh</h3><p>我们启动它时，是怎么跑的？ 让我想想，哦，对了</p><pre class=" language-bash"><code class="language-bash">./zkServer.sh start</code></pre><p>是的了，就是这样！</p><p>ok，那就简单了，我们先来看下这个 zkServer.sh 文件</p><pre class=" language-bash"><code class="language-bash"><span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>start<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># ...</span>    <span class="token function">nohup</span> <span class="token string">"<span class="token variable">$JAVA</span>"</span> <span class="token variable">$ZOO_DATADIR_AUTOCREATE</span> <span class="token string">"-Dzookeeper.log.dir=<span class="token variable">${ZOO_LOG_DIR}</span>"</span> \    <span class="token string">"-Dzookeeper.log.file=<span class="token variable">${ZOO_LOG_FILE}</span>"</span> <span class="token string">"-Dzookeeper.root.logger=<span class="token variable">${ZOO_LOG4J_PROP}</span>"</span> \    -XX:+HeapDumpOnOutOfMemoryError -XX:OnOutOfMemoryError<span class="token operator">=</span><span class="token string">'kill -9 %p'</span> \    -cp <span class="token string">"<span class="token variable">$CLASSPATH</span>"</span> <span class="token variable">$JVMFLAGS</span> <span class="token variable">$ZOOMAIN</span> <span class="token string">"<span class="token variable">$ZOOCFG</span>"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$_ZOO_DAEMON_OUT</span>"</span> 2<span class="token operator">></span><span class="token operator">&amp;</span>1 <span class="token operator">&lt;</span> /dev/null <span class="token operator">&amp;</span>    <span class="token comment" spellcheck="true"># ...</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span> esac</code></pre><p>我们看到，当我们执行 <code>zkServer.sh start</code> 的时候，其实跑到了这里，而这里，会以 <code>java cp</code> 的方式启用 <code>$ZOOMAIN</code> 这个主类。往上看</p><pre class=" language-bash"><code class="language-bash"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"x<span class="token variable">$JMXDISABLE</span>"</span> <span class="token operator">=</span> <span class="token string">"x"</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$JMXDISABLE</span>"</span> <span class="token operator">=</span> <span class="token string">'false'</span> <span class="token punctuation">]</span><span class="token keyword">then</span>  <span class="token keyword">echo</span> <span class="token string">"ZooKeeper JMX enabled by default"</span> <span class="token operator">></span><span class="token operator">&amp;</span>2  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"x<span class="token variable">$JMXPORT</span>"</span> <span class="token operator">=</span> <span class="token string">"x"</span> <span class="token punctuation">]</span>  <span class="token keyword">then</span>    <span class="token comment" spellcheck="true"># for some reason these two options are necessary on jdk6 on Ubuntu</span>    <span class="token comment" spellcheck="true">#   accord to the docs they are not necessary, but otw jconsole cannot</span>    <span class="token comment" spellcheck="true">#   do a local attach</span>    ZOOMAIN<span class="token operator">=</span><span class="token string">"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=<span class="token variable">$JMXLOCALONLY</span> org.apache.zookeeper.server.quorum.QuorumPeerMain"</span>  <span class="token keyword">else</span>    <span class="token comment" spellcheck="true"># ...</span>    ZOOMAIN<span class="token operator">=</span><span class="token string">"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=<span class="token variable">$JMXPORT</span> -Dcom.sun.management.jmxremote.authenticate=<span class="token variable">$JMXAUTH</span> -Dcom.sun.management.jmxremote.ssl=<span class="token variable">$JMXSSL</span> -Dzookeeper.jmx.log4j.disable=<span class="token variable">$JMXLOG4J</span> org.apache.zookeeper.server.quorum.QuorumPeerMain"</span>  <span class="token keyword">fi</span><span class="token keyword">else</span>    <span class="token keyword">echo</span> <span class="token string">"JMX disabled by user request"</span> <span class="token operator">></span><span class="token operator">&amp;</span>2    ZOOMAIN<span class="token operator">=</span><span class="token string">"org.apache.zookeeper.server.quorum.QuorumPeerMain"</span><span class="token keyword">fi</span></code></pre><p>可以看到，这里虽然区分了几种情况，但都是往 <code>ZOOMAIN</code> 中添加启动变量，但最终，这个主类，它还是它：</p><blockquote><p>org.apache.zookeeper.server.quorum.QuorumPeerMain</p></blockquote><p>于是我们知道了 zk 的启动类。</p><h3 id="2-QuorumPeerMain"><a href="#2-QuorumPeerMain" class="headerlink" title="2. QuorumPeerMain"></a>2. QuorumPeerMain</h3><p>下面我们把 zk 的源码拉下来，通过这个主类一步步往里面看。源码 clone 看 <a href="https://github.com/apache/zookeeper" target="_blank" rel="noopener">GitHub</a></p><p>下载完成后(需要依次 mvn clean install)，我们找到这个类，可以看到：</p><p>通过 <code>main</code> 方法 调用 <code>initializeAndRun</code> ， 这个方法先读取 config ，然后启动一个类似清洁工的线程，之后根据传入的参数，来判断是启用 ensemble 模式还是 standalone 模式。</p><p>这里我们看 ensemble 模式。</p><blockquote><p> org.apache.zookeeper.server.quorum.QuorumPeerMain#runFromConfig</p></blockquote><ul><li><p>这个方法，初始化了一个十分重要的对象，即 <strong>QuorumPeer</strong> !! zk 的核心类之一。稍后我们会说到它。我们看这个方法还干了些什么了不得的事情。</p></li><li><p>之前 <code>zoo.cfg</code> 里设置的什么 tickTime， initLimit，syncLimit 啥的，都会在这个方法里完成初始化。</p></li><li><p>选举算法(你随便找下，就能看到，现在 zk 只支持 3，也就是 FastLeaderElection 算法)，myid，database 等的初始化</p></li><li><p>QuorumVerifier 类，维护着 ensemble 内所有初始化时的所有 server 信息，之后说选举是不是过半了，就是通过它来做判断的</p></li><li><p>ServerCnxnFactory 类，负责 server 到 client 的通信，主要有 NIO 和 Netty 两种实现，默认为 NIO， 可以通过配置 <code>zookeeper.serverCnxnFactory</code> 来使用 Netty</p></li><li><p>others</p></li></ul><p>之后就会运行 <code>quorumPeer.start()</code> 也就是起了一个线程，不过这个线程会去竞争 cpu 时间片，获得后就会 run 起来</p><h3 id="3-QuorumPeer"><a href="#3-QuorumPeer" class="headerlink" title="3. QuorumPeer"></a>3. QuorumPeer</h3><p>这个类负责维护这个 server 在运行期间的所有事物，或者说，一个 server ，其实就是一个 quorumPeer 。为什么这样说？</p><p>zk 在运行期间，无非就是和 client 通信，和各个 server ，和 leader 通信，而这个类所持有的各个对象，就是干这些事情的。</p><ul><li><h4 id="3-1-QuorumPeer-start"><a href="#3-1-QuorumPeer-start" class="headerlink" title="3.1 QuorumPeer.start()"></a>3.1 QuorumPeer.start()</h4></li></ul><p>我们先来看看 start 的时候，做了什么</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 验证 myid 正确性</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>myid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"My id "</span> <span class="token operator">+</span> myid <span class="token operator">+</span> <span class="token string">" not in the peer list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 装载 zk database</span>    <span class="token function">loadDataBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">startServerCnxnFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        adminServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AdminServerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Problem starting AdminServer"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 开启一轮选举</span>    <span class="token function">startLeaderElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">startJvmPauseMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>做了些验证等其他操作后，开启了一轮选举，我们看下这个方法做了什么</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">startLeaderElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 很明显，我们初始时状态就是 LOOKING，所以会初始化一张自己的选票</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPeerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ServerState<span class="token punctuation">.</span>LOOKING<span class="token punctuation">)</span> <span class="token punctuation">{</span>            currentVote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>myid<span class="token punctuation">,</span> <span class="token function">getLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getCurrentEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        RuntimeException re <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        re<span class="token punctuation">.</span><span class="token function">setStackTrace</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">throw</span> re<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 初始化选举算法</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>electionAlg <span class="token operator">=</span> <span class="token function">createElectionAlgorithm</span><span class="token punctuation">(</span>electionType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">protected</span> Election <span class="token function">createElectionAlgorithm</span><span class="token punctuation">(</span><span class="token keyword">int</span> electionAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Election le <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>electionAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1，2 都会抛异常</span>        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>            <span class="token comment" spellcheck="true">// QuorumCnxManager 负责选举期间所有的 TCP 连接！！！</span>            <span class="token comment" spellcheck="true">// 为什么这个类要在这里初始化？</span>            <span class="token comment" spellcheck="true">// 因为他要负责监听选举</span>            QuorumCnxManager qcm <span class="token operator">=</span> <span class="token function">createCnxnManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            QuorumCnxManager oldQcm <span class="token operator">=</span> qcmRef<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span>qcm<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldQcm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Clobbering already-set QuorumCnxManager (restarting leader election?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                oldQcm<span class="token punctuation">.</span><span class="token function">halt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            QuorumCnxManager<span class="token punctuation">.</span>Listener listener <span class="token operator">=</span> qcm<span class="token punctuation">.</span>listener<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// listener 负责监听所有连接</span>                listener<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                FastLeaderElection fle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastLeaderElection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> qcm<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 开启选举线程</span>                fle<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                le <span class="token operator">=</span> fle<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Null listener when initializing cnx manager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">assert</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> le<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="3-2-FastLeaderElection"><a href="#3-2-FastLeaderElection" class="headerlink" title="3.2 FastLeaderElection"></a>3.2 FastLeaderElection</h4><p>这里，我们先看下 FLE(FastLeaderElection) 的类图</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200404143916.png-growing" alt="FLE Class"></p><p>FLE 主要持有的对象有</p><ul><li><p>ToSend：就是一个封装类，用来封装发送的消息体</p></li><li><p>Notification：也是一个封装类，用来告知其他 server，vote 发生了变化的实体</p></li><li><p>Messenger：真正干事情的，用于发送和接受选举期间的选票，其中：</p><ul><li>WorkerReceiver：接收选票</li><li>WorkerSender：发送选票</li></ul></li><li><p>FastLeaderElection 里还有两个很重要的变量，我们从名字也能很好理解</p><ul><li>sendqueue LinkedBlockingQueue&lt;ToSend&gt; ： 用来接收需要发送的选票队列</li><li>recvqueue  LinkedBlockingQueue&lt;Notification&gt; ： 用来接收从其他 server 发过来的选票队列</li></ul></li></ul><p>我们可以看到 FLE 虽然有个 start() 方法，可是它并不是一个线程类！ 在 start 之后，它事实上是初始化了 <code>Messenger</code> ,之后 Messenger 去初始化 <code>WorkerReceiver</code> 和 <code>WorkerSender</code> ，这两个是线程类，并且被 start 了。</p><p>也就是说，这两货开始干活了： 这两货会根据接收/发送的选票的各种状态，分别塞给  sendqueue 和 recvqueue </p><ul><li>sendqueue 最终被前文提到的 <code>QuorumCnxManager</code> 消费，由它发送给其他 server</li><li>recvqueue 最终由 fle 在计算选票时候消费，以此来确定 leader 的诞生</li></ul><h4 id="3-3-QuorumPeer-run"><a href="#3-3-QuorumPeer-run" class="headerlink" title="3.3 QuorumPeer.run()"></a>3.3 QuorumPeer.run()</h4><p>简单介绍完 FLE ，现在我们回到 <code>QuorumPeer</code> 这个类，之前我们在 <code>QuorumPeerMain</code> 里 start 了这个线程，现在，它，终于争取到了 cpu 时间片，它可以 run 了！！！</p><p>QuourmPeer 中包含的几种状态：</p><ul><li>ServerState ： 标记当前 server 状态<ul><li>LOOKING：该状态下会发起选举</li><li>OBSERVING：表明处于观察者状态</li><li>FOLLOWING：跟随者状态</li><li>LEADING：领导者状态</li></ul></li><li>ZabState：标记 zab 协议的状态<ul><li>ELECTION ：选举阶段</li><li>DESCOVERY：发现阶段，和各个 follower/observer 建立 tcp 连接</li><li>SYNCHRONIZATION：同步阶段，和各个 follower 同步信息</li><li>BROADCAST：广播阶段</li></ul></li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 源码参见 org.apache.zookeeper.server.quorum.QuorumPeer#run</span><span class="token comment" spellcheck="true">// 这里对代码做了精简处理</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 设置 jmx</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getPeerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> LOOKING<span class="token operator">:</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"readonlymode.enabled"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// readonly 模式下的必要处理 [1]</span>                     <span class="token function">setCurrentVote</span><span class="token punctuation">(</span><span class="token function">makeLEStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookForLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// ...</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 这个标志和配置里的 version 有关</span>                    <span class="token comment" spellcheck="true">// version 和 zk 的 dynamic 配置有关</span>                    <span class="token comment" spellcheck="true">// 暂时还没有去看这块的东西，后面把这里的坑填上</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>shuttingDownLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        shuttingDownLE <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                        <span class="token function">startLeaderElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token function">setCurrentVote</span><span class="token punctuation">(</span><span class="token function">makeLEStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookForLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> OBSERVING<span class="token punctuation">,</span>FOLLOWING<span class="token punctuation">,</span>LEADING<span class="token operator">:</span>                <span class="token comment" spellcheck="true">// 设置为 OBSERVER FOLLOWER LEADER</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token punctuation">}</span></code></pre><p>这里就是负责发起选举的主流程。很简单，直接调用 FLE 的 <code>lookForLeader</code> 方法。职责明确。</p><h4 id="3-4-lookForLeader"><a href="#3-4-lookForLeader" class="headerlink" title="3.4 lookForLeader()"></a>3.4 lookForLeader()</h4><p>一张选票，可能有以下几种问题：</p><ol><li>选票数据出了问题，比如 tcp 传输过程中，某个数据包丢了…</li><li>投出这张选票的 server 没有权限(observer)</li><li>收到选票时，我自己的状态并不在 LOOKING 状态(什么时候会有这种情况呢？ [4])</li><li>收到选票时， 其他 server 的选票不是 LOOKING 状态(这个下文会分析，可以先想一下)</li><li>正常的选票，你在寻找 leader(选票状态为 LOOKING)，我也在寻找  leader (我的状态也是 LEADING)</li></ol><p>上面的前三种情况，都会由 <code>WorkReceiver</code> 处理掉</p><p>后面的两种情况，<code>WorkerReceiver</code> 才会把选票放入 <code>recvqueue</code> 中，由下面的流程来处理。</p><p>在看下面的代码之前，先介绍下几个变量以及数据结构</p><ul><li>logicalclock：用来记录我自己的选举轮次</li><li>todo</li><li>Notification (处理后的一张选票)<ul><li>leader： long ， 选票的 sid ，即 myid，这里选票要选举的那个 server 的 sid，不是自己的</li><li>peerEpoch：投票人选举的 leader 所处的年代</li><li>zxid：投票人选举的 leader 的 zxid</li><li>sid： long ，投票人自己的 sid</li><li>electionEpoch： 投票人的投票轮次，这个值会和我自己的 logicalclock 比较，判断是不是处于同一个轮次</li><li>state： 投票人的 serverState</li><li>qv：投票人的投票信息</li></ul></li></ul><p><strong>zk 针对两张合法的选票，根据如下规则做比较</strong></p><p>源代码： org.apache.zookeeper.server.quorum.FastLeaderElection#totalOrderPredicate</p><ul><li>epoch： 即待选 leader 所处的年代，选大的！ 也就是 notification 中的 peerEpoch</li><li>zxid： epoch 一样的时候，看待选 leader 的 zxid，选大的！</li><li>myid：还一样怎么办？ 选 myid 大的！ 即 notification 中的 leader</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 同样对代码做了精简 </span><span class="token comment" spellcheck="true">// 源码参见 org.apache.zookeeper.server.quorum.FastLeaderElection#lookForLeader</span><span class="token keyword">public</span> Vote <span class="token function">lookForLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// 用来存储有效选票(logicalClock == 选票.electionEpoch)的集合</span>        <span class="token comment" spellcheck="true">// server 根据它来判断选举结果</span>        Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span> recvset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 关于这个字段的详细解释以及 pr [2]</span>        Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span> outofelection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> notTimeout <span class="token operator">=</span> minNotificationInterval<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// logicalclock 增加， 同时初始化一张自己的选票，并广播出去</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            logicalclock<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">updateProposal</span><span class="token punctuation">(</span><span class="token function">getInitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getInitLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPeerEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        SyncedLearnerTracker voteSet<span class="token punctuation">;</span>       <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getPeerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ServerState<span class="token punctuation">.</span>LOOKING<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment" spellcheck="true">// 前文提到的 recvqueue ，这里从这个队列拿选票</span>            Notification n <span class="token operator">=</span> recvqueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>notTimeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// 没有选票！ 是什么情况呢? 还有这里为什么一种会重新发送，另一种又没有呢? [3]</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>manager<span class="token punctuation">.</span><span class="token function">haveDelivered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    manager<span class="token punctuation">.</span><span class="token function">connectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">validVoter</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>sid<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">validVoter</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 投票人的 serverState</span>                <span class="token keyword">switch</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> LOOKING<span class="token operator">:</span>                    <span class="token comment" spellcheck="true">// 投票人选举轮次大，说明之前的投票都无效，所以这里清空票箱</span>                    <span class="token comment" spellcheck="true">// 同时更新自己的 logicalclock,</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch <span class="token operator">></span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        logicalclock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                        recvset<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 比较两张选票并更新</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">totalOrderPredicate</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> <span class="token function">getInitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getInitLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPeerEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">updateProposal</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token function">updateProposal</span><span class="token punctuation">(</span><span class="token function">getInitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getInitLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPeerEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">// 更新选票后，发送个其他 server</span>                        <span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch <span class="token operator">&lt;</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 你的选举轮次比我小，我只能对你爱理不理了</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 处于同一个选举轮次的时候，也是比较选票并更新</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">totalOrderPredicate</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">updateProposal</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 无效的选票都 break 掉了，到这里都是有效的选票，放入票箱</span>                    recvset<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 统计选票，这里需要说下，所有 update 操作，都会更新自己的 proposedLeader 等数据</span>                  <span class="token comment" spellcheck="true">// 所以这里 new Vote 参数，都是更新后的参数</span>                    voteSet <span class="token operator">=</span> <span class="token function">getVoteTracker</span><span class="token punctuation">(</span>recvset<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 超过半数</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>voteSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 这里的处理很有意思了，它会再次查看，从上面取出选票，到运行到这里的这段时间内</span>                        <span class="token comment" spellcheck="true">// 是不是又收到了选票，如果不仅收到了，还是一张最牛皮的，拿出来后，又塞了回去！</span>                        <span class="token comment" spellcheck="true">// 因为 break，而 n 不为空，会进入到外面的 while 循环，再次跑一遍上面的流程</span>                        <span class="token comment" spellcheck="true">// 那么，什么情况下，这张选票里的 leader 会当选呢？</span>                        <span class="token comment" spellcheck="true">// 很明显，超过半数的 server ，在收到这张选票之前，没有确定 server，那它就</span>                        <span class="token comment" spellcheck="true">// 有概率当选</span>                        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> recvqueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>finalizeWait<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">totalOrderPredicate</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                recvqueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token keyword">break</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">// 到这里，leader 就能确定了</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">setPeerState</span><span class="token punctuation">(</span>proposedLeader<span class="token punctuation">,</span> voteSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                            Vote endVote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">leaveInstance</span><span class="token punctuation">(</span>endVote<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">return</span> endVote<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> OBSERVING<span class="token operator">:</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> FOLLOWING<span class="token operator">:</span>                <span class="token keyword">case</span> LEADING<span class="token operator">:</span>                    <span class="token comment" spellcheck="true">// 可以思考下，什么情况，会跑到这里来 [5]</span>                    <span class="token comment" spellcheck="true">// 同一个选举轮次，什么情况呢？</span>                    <span class="token comment" spellcheck="true">// 我们都参与了投票，别人都搞完选出 leader 了，回复我的时候</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch <span class="token operator">==</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        recvset<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        voteSet <span class="token operator">=</span> <span class="token function">getVoteTracker</span><span class="token punctuation">(</span>recvset<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>version<span class="token punctuation">,</span> n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>voteSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkLeader</span><span class="token punctuation">(</span>recvset<span class="token punctuation">,</span> n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">setPeerState</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> voteSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                            Vote endVote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">leaveInstance</span><span class="token punctuation">(</span>endVote<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">return</span> endVote<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 新的 server 加入稳定的 ensemble 时，会到这里</span>                  <span class="token comment" spellcheck="true">// 主要验证当前 leader 是不是真的被超半数的 follower 追随</span>                    outofelection<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>version<span class="token punctuation">,</span> n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    voteSet <span class="token operator">=</span> <span class="token function">getVoteTracker</span><span class="token punctuation">(</span>outofelection<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>version<span class="token punctuation">,</span> n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>voteSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkLeader</span><span class="token punctuation">(</span>outofelection<span class="token punctuation">,</span> n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            logicalclock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">setPeerState</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> voteSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        Vote endVote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">leaveInstance</span><span class="token punctuation">(</span>endVote<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> endVote<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>到这里，即基本说完了 FLE 的大致算法。</p><p>我们总结下，无非几句话：</p><ol><li>判断是不是同一个选举轮次。选举轮次只有在发起选举的时候才会更新。比我小的，我都不带理睬，相同或大的，根据 epoch ， zxid ， myid 比较并更新选票，同时重新发送自己的选票。</li><li>在收集到足够多的选票后，判断是否超过了半数(事实上，zk 还去检查了这个即将当选的 leader 的状态，可以说相当负责了)。超过的话，就进入下一个状态。</li><li>如果是半路杀出来的，即新的 server 加入，就检查当前 leader 的合法性，合法就加入其中。(如果不合法，自然会不断的发送选票，直到集群中大部分的 server 都观察到，因为这是一个 while 循环啊)</li></ol><h4 id="FLE-Flow"><a href="#FLE-Flow" class="headerlink" title="FLE Flow"></a>FLE Flow</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200405092256.png-growing" alt="FastLeaderElection Flow"></p><p>该流程图可能不是特别精确，少了些具体的流程，请务必批判着看。准确的说，所有的网络文章，你都得批判着看 <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">😂</span> </p><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><h3 id="1"><a href="#1" class="headerlink" title="[1]:"></a>[1]:</h3><p>zk 提供 readonly 模式的 server 。 我们知道，当一台 server 与超过半数的 server  丢失连接后，就会停止工作，读写请求都不会处理。 但是使用该模式后，则该 server 仍然会处理 <strong>读</strong> 请求。虽然保证了可用性，但丢掉了一致性，也就是说，此时的 CAP 从 CP 转换到了 AP</p><h3 id="2"><a href="#2" class="headerlink" title="[2]"></a>[2]</h3><p><a href="https://github.com/apache/zookeeper/pull/1081" target="_blank" rel="noopener">outofelection pr</a></p><h3 id="3"><a href="#3" class="headerlink" title="[3]"></a>[3]</h3><p>什么情况下会收不到选票呢？</p><ul><li>我已经发送了，是你们的问题，你们没有给我回复！！！ 可能所有 server 都因为各种问题丢失了这条消息，那没办法，我只能再发一次了。那么这里需要担心选票重复的问题吗? of course not ！我是用 set 存储选票的，你相同的选票，我覆盖一次就好了呗。</li><li>我以为我发送了，其实我并没有… 不好意思，是我的锅！！！ 原来我和你们的连接出了问题，好吧，我重新连接一次。 可是这里，重新连接后 <strong>没有重新发送选票</strong> ， 为什么这样子？我们可以稍微看下它发送消息的机制，需要先建立连接，然后取出消息发送，所以如果压根就没有连上，那么就没有所谓的取出消息发送，所以这里并不需要再次发送消息。</li></ul><h3 id="4"><a href="#4" class="headerlink" title="[4]"></a>[4]</h3><ul><li>当有新的 server 加入到一个稳定运行的 ensemble 时，这个新 server 会发起投票，我去回复这个新 server 发起的选举时，自己本身的状态，必然是 LEADING / FOLLOWING /OBSERVING </li><li>集群中，有 server 发现 leader 挂掉了，此时它会发起投票，可是我还没感知到 leader 的状态 ，依然还是之前的状态：FOLLOWING / OBSERING，我去回复时</li></ul><h3 id="5"><a href="#5" class="headerlink" title="[5]"></a>[5]</h3><ul><li>我作为一个新 server ，发起投票时，别人回复给我的信息，会到这里</li><li>我及时发现 ensemble 里的 leader 挂掉了，发起新的选举时， 别人的回复会来这里</li><li>选举时，有一半的 server 完成了选举，我年纪大了，速度慢，发起投票后，别人的回复</li><li>我作为 Follower ，跑着跑着，竟然挂掉了，重新拉起来时，也会如此</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TODO</title>
      <link href="/mine/todo/"/>
      <url>/mine/todo/</url>
      
        <content type="html"><![CDATA[<h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ul><li><p><span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8">📝</span> todo 事项</p></li><li><p><span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8">🎉</span> 完成事项</p></li></ul><h3 id="how-to-use"><a href="#how-to-use" class="headerlink" title="how-to-use"></a>how-to-use</h3><p><span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8">📝</span> 永久 watch event 的使用</p><p><span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8">📝</span> zk 的 dynamic 配置，quorumPeer 有一个 flag： shuttingDowmLE ，和 version 有关，而 version 貌似和 dynamic 的配置有关系，看的时候，可以把这一块理一理</p><h3 id="zab"><a href="#zab" class="headerlink" title="zab"></a>zab</h3><p><span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8">🎉</span> ​zk 的 zab 协议中，一项决议的产生流程是怎样的？ 以 paxos 算法来说， zk 中的 leader 在第一阶段 prepare 的时候，会先征求超过半数的 follower 的同意，之后再在 propose 阶段去真正提交，这个时候，会被各个 follower 选中，一项决议生成。</p><hr><h2 id="2020-05-17"><a href="#2020-05-17" class="headerlink" title="2020. 05. 17"></a>2020. 05. 17</h2><ol><li>elk</li><li></li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part 2 -- Using ZooKeeper Now</title>
      <link href="/zookeeper/how-to-use/"/>
      <url>/zookeeper/how-to-use/</url>
      
        <content type="html"><![CDATA[<h1 id="ZooKeeper-lt-二-gt-安装使用"><a href="#ZooKeeper-lt-二-gt-安装使用" class="headerlink" title="ZooKeeper <二> 安装使用"></a>ZooKeeper &lt;二&gt; 安装使用</h1><p>ZooKeeper version： 3.6.0</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>本示例均在 <strong><code>CentOS Linux release 8.1.1911 (Core)</code></strong> 下进行</p><p>同时需要保证当前机器含有 java 环境，java 安装步骤可参考 <a href="https://buzhui.top/linux/install/#Java-11" target="_blank" rel="noopener">这里</a></p><h4 id="1-下载"><a href="#1-下载" class="headerlink" title="1. 下载"></a>1. 下载</h4><p>首先到 <a href="http://zookeeper.apache.org/releases.html" target="_blank" rel="noopener">Apache Download</a> 寻找合适的版本，这里以 3.6.0 为例，下载</p><pre class=" language-shell"><code class="language-shell">wget https://downloads.apache.org/zookeeper/current/apache-zookeeper-3.6.0-bin.tar.gz</code></pre><h4 id="2-解压"><a href="#2-解压" class="headerlink" title="2. 解压"></a>2. 解压</h4><pre><code>tar -xvf apache-zookeeper-3.6.0-bin.tar.gz</code></pre><h4 id="3-单机版启动"><a href="#3-单机版启动" class="headerlink" title="3. 单机版启动"></a>3. 单机版启动</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200403152324.png-growing" alt="zookeeper config"></p><p>如图示，我在解压完后，将那串长长的目录名，重命名为 zk1， 同时又 cp 了 zk2 和 zk3，cp zoo_sample.cfg 为 zoo.cfg</p><pre class=" language-shell"><code class="language-shell"># 修改名称mv apache-zookeeper-3.6.0-bin zk1# cp 两份，为后面的伪集群搭建做准备cp -r zk1 zk2 cp -r zk1 zk3# 增加 zoo.cfg 配置cd zk1 &&  cp conf/zoo_sample.cfg zoo.cfg</code></pre><p>这里我没有修改任何地方，直接 start</p><pre class=" language-shell"><code class="language-shell">./bin/zkServer.sh start/usr/bin/javaZooKeeper JMX enabled by defaultUsing config: /home/dylan/tmp/zookeeper/zk1/bin/../conf/zoo.cfgStarting zookeeper ... STARTED</code></pre><p>可以看到， zk1 已经启动，我们验证一下：</p><pre class=" language-shell"><code class="language-shell">./bin/zkServer.sh status/usr/bin/javaZooKeeper JMX enabled by defaultUsing config: /home/dylan/tmp/zookeeper/zk1/bin/../conf/zoo.cfgClient port found: 2181. Client address: localhost.Mode: standalone</code></pre><p>通过 <code>zkServer.sh status</code> ，能看到 zk 已经正常启动，Mode 为 standalone ，当我们配置 ensemble 时，这个 Mode 就会变成 Leader/Follower/Observer</p><h4 id="4-单机伪集群版"><a href="#4-单机伪集群版" class="headerlink" title="4. 单机伪集群版"></a>4. 单机伪集群版</h4><p>前面我们已经 cp 了 3 个 zk，现在我们再添加一个 observer 节点，同时，在各个 dataDir 新建 <code>myid</code> 文件，并写入值，如  zk1 的 dataDir 为 <code>/tmp/zk1</code> ，则我们执行： <code>echo 1 &gt; /tmp/zk1/myid</code></p><h5 id="4-1-四份配置如下："><a href="#4-1-四份配置如下：" class="headerlink" title="4.1 四份配置如下："></a>4.1 四份配置如下：</h5><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200404043709.png-growing" alt="ensemble config"></p><p>其中涉及到的配置项有：</p><ul><li><p>tickTime：zk 中的计时单元，单位毫秒(milliseconds)，心跳间隔，session timeout = 2倍 tickTime(默认)</p></li><li><p>initLimit：ensemble 初始化时，server(Follower/Observer) 与 Leader 进行连接的最大时长，超过该时间如果还未连接成功，则宣告连接失败。对于 Follower 而言，则是连接并同步到 Leader 的时间。如果 zookeeper 集群管理的数据量很大，则根据需要增加这个值</p></li><li><p>syncLimit： 同步时间，如果 Follower 在 syncLimit 时间内未完成同步，则将被 Leader 丢弃</p></li><li><p>dataDir：zk 用于存放数据的地方，<code>myid</code> 文件也存放在这个地方。zk 官方建议该目录应该是一个专门为 zk 事务日志准备的目录：</p></li></ul><blockquote><p>To get low latencies on updates it is important to have a dedicated transaction log directory. By default transaction logs are put in the same directory as the data snapshots and myid file. The dataLogDir parameters indicates a different directory to use for the transaction logs.</p></blockquote><ul><li><p>clientPort： 监听客户端连接的端口。如果你的客户端使用的不是这个端口，那这里就要改了。这里因为在同一台机器上，所以改成了不同的端口</p></li><li><p>peerType：配置了 <code>peerType=observer</code> 的 server，将成为 observer，本例中的 zk4 将成为 observer</p></li><li><p>observerMasterPort： 默认情况下， Observer 从 Leader 获得新 proposal， 启用该配置后，observer 将从 Follower 获得 proposal。Follower 将会监听该端口。这样做的好处是，能减轻 Leader 的压力。我上面配置的值不相同，是因为我在单机上，如果配置相同，会出现端口冲突，实际这里应该是同一个端口。</p></li></ul><blockquote><p>By default, Observers connect to the Leader of the quorum along its quorum port and this is how they learn of all new proposals on the ensemble. There are benefits to allowing Observers to connect to the Followers instead as a means of plugging into the commit stream in place of connecting to the Leader. It shifts the burden of supporting Observers off the Leader and allow it to focus on coordinating the commit of writes. This means better performance when the Leader is under high load, particularly high network load such as can happen after a leader election when many Learners need to sync. It reduces the total network connections maintained on the Leader when there are a high number of observers. Activating Followers to support Observers allow the overall number of Observers to scale into the hundreds. On the other end, Observer availability is improved since it will take shorter time for a high number of Observers to finish syncing and start serving client traffic.</p></blockquote><ul><li>server.1=127.0.0.1:2284:3884:observer ： 为方便介绍我们把这里改写成如下形式：<ul><li>server.myid=net:port1:port2:observer， 则</li><li>myid： myid，需要与该 server dataDir 下 <code>myid</code> 文件中的值保持一致(这个文件需要我们手动创建)</li><li>net： 该 server 的 host</li><li>port1：用于 peer 到 peer 的 TCP 通信， peer 即一个 zk server；以及和 Leader 之间的通信，这个端口，事实上，只有 server 成为 Leader 后才会去监听。虽然文档说是 peer to peer， 但仔细看下源码和实践，这个端口确实是 Leader 用来和各 server 通信用的</li><li>port2： 选举期间，各个 server 之间的 TCP 通信端口，即选举使用的端口</li><li>observer： 表明该 server 为 observer</li><li><strong>3.6.0</strong> 版本中，可以使用 <strong>multiple addresses</strong> ， 结构如下</li><li>server.myid=net1:port1:port2|net2:port1:port2， 即通过分隔符( <strong>|</strong> )来分割不同的 address</li></ul></li><li><em>leaderServes</em> ：Leader 是否可以连接 client，默认为 true，为 false 时，表明 Leader 只需要专注于协同(coordination)。如果写请求远高于读请求，可以设置为 false。</li><li>更多配置，请参考 <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperAdmin.html" target="_blank" rel="noopener">这里</a> ， <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperObservers.html" target="_blank" rel="noopener">这里</a> ，还有 <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperReconfig.html" target="_blank" rel="noopener">这里</a></li></ul><h5 id="4-2-启动"><a href="#4-2-启动" class="headerlink" title="4.2 启动"></a>4.2 启动</h5><p>分别执行(注意下执行目录)</p><pre class=" language-bash"><code class="language-bash">./zk1/bin/zkServer.sh start</code></pre><p>上面没有更改日志位置，所以可以在 ./zk1/logs 下面找到</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200404031221.png-growing" alt="zookeeper starting"></p><p>当只启动了 zk1 时，日志如上所示，它在尝试和 zk2 ，zk3 通信时，会一直失败，当我们启动了 zk2 和 zk3 时，整个集群就会稳定下来。</p><p>因为单机版的问题，这里 zk4 ，即 observer 的 observerMasterPort 配置为 2481，即 zk1 ，所以如果 zk1 当选为 Leader ，此时 zk4 会疯狂刷日志，报 connection refused，别问我怎么知道的！！！</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200404044913.png-growing" alt="ensemble listening ports"></p><p>通过这张图我们可以看到 ，zk1 成功当选了 leader，则它监听的端口有：</p><ul><li>3881：用于选举的端口，任何时候都会去监听</li><li>2281：用于和其他 server 通信的端口，即前文的 port1</li><li>2481： 作为 leader，它已经不用去监听这个 observerMasterPort 了，所以这里我们看不到</li><li>2181： 用于和客户端通信的端口，我们没有配置 <em>leaderServes=false</em>，所以 leader 还需要响应 client </li></ul><p>Follower 监听的端口有(这里以 zk2 为例)：</p><ul><li>3882：选举端口，时刻保持监听，万一 leader 挂了，选了我做 leader 呢！</li><li>2482：observerMasterPort，负责和 observer 通信的 TCP 端口</li><li>2182：和 client 交互的 TCP 端口</li></ul><h5 id="4-3-简单使用"><a href="#4-3-简单使用" class="headerlink" title="4.3 简单使用"></a>4.3 简单使用</h5><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 不加[]中内容，默认连接到 2181 端口</span>./zk1/bin/zkCli.sh <span class="token punctuation">[</span>-server localhost:2182<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># 输入 help ，会打印出命令</span><span class="token comment" spellcheck="true"># 可以看到 create 相关: create [-s] [-e] [-c] [-t ttl] path [data] [acl]</span><span class="token comment" spellcheck="true"># 我们用 create 创建一个节点,其中 data 为 "zk_test_data"， acl 我们暂时不设置</span>create /zk_test <span class="token string">"zk_test_data"</span><span class="token comment" spellcheck="true"># 通过 ls / 能到节点已经创建</span><span class="token function">ls</span> /<span class="token comment" spellcheck="true"># get 获取节点信息, -s 参数会把整个节点信息 zxid 等打印出来</span>get -s /zk_test<span class="token comment" spellcheck="true"># 更多命令请百度/Google</span><span class="token comment" spellcheck="true"># 使用到此结束</span></code></pre><h2 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h2><p>ACL 有关的官方文档请点击 <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperProgrammers.html#sc_ZooKeeperAccessControl" target="_blank" rel="noopener">这里</a></p><p>所谓 ACL ，即 Access Control Lists ，访问控制列表。在 zk 中，用来控制访问 znode。</p><h3 id="1-ACL-构成"><a href="#1-ACL-构成" class="headerlink" title="1. ACL 构成"></a>1. ACL 构成</h3><blockquote><p>&lt;scheme&gt;:&lt;id&gt;:&lt;perms&gt;</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// org.apache.zookeeper.data.ACL</span><span class="token keyword">public</span> <span class="token function">ACL</span><span class="token punctuation">(</span>    <span class="token keyword">int</span> perms<span class="token punctuation">,</span>    org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Id id<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>perms<span class="token operator">=</span>perms<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token operator">=</span>id<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// org.apache.zookeeper.data.Id</span><span class="token keyword">public</span> <span class="token function">Id</span><span class="token punctuation">(</span>    String scheme<span class="token punctuation">,</span>    String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>scheme<span class="token operator">=</span>scheme<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token operator">=</span>id<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// org.apache.zookeeper.ZooDefs.Perms </span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Perms</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> READ <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> WRITE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> CREATE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> DELETE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ADMIN <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ALL <span class="token operator">=</span> READ <span class="token operator">|</span> WRITE <span class="token operator">|</span> CREATE <span class="token operator">|</span> DELETE <span class="token operator">|</span> ADMIN<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>通过源码我们可以看到, ACL = Id + perms 构成 , 而 Id = scheme + id</p><h3 id="2-Perms"><a href="#2-Perms" class="headerlink" title="2. Perms"></a>2. Perms</h3><p>同样由源码可以看到 <strong>perms</strong> 主要包含以下几种:</p><ul><li>read</li><li>write</li><li>create</li><li>delete</li><li>admin : you can set permissions , 毕竟是 admin,你可以胡作非为</li><li>all： 所有权限</li></ul><h3 id="3-内置权限方案"><a href="#3-内置权限方案" class="headerlink" title="3. 内置权限方案"></a>3. 内置权限方案</h3><p>zookeeper 内置的 scheme 有如下几种：</p><ul><li><p>world： 即任何人都可以拥有你设置的权限，&lt;world&gt;:&lt;anyone&gt;&lt;perms&gt;</p></li><li><p>digest：&lt;digets&gt;:&lt;username:password&gt;:&lt;perms&gt; , 这里的 password， 是指 base64 编码的 sha1 密码摘要，填入 ACL 中。比如 username 为 dylan , 密码为 123456， 则进行如下操作： </p><pre class=" language-bash"><code class="language-bash"><span class="token keyword">echo</span> -n dylan:123456 <span class="token operator">|</span> openssl dgst -binary -sha1 <span class="token operator">|</span> openssl base64</code></pre><p>则最终 scheme 应该长这个样子： </p><blockquote><p> digest:dylan:7i6SL+m6GkW2OYpURnpkay0UdBc=:crwda</p></blockquote><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200404065646.png-growing" alt="digest NoAuth"></p></li><li><p>ip：使用客户端主机 IP 作为 ACL ID 身份。 ACL 表达式的形式为 addr / bits，其中 addr 的最高有效位与客户端主机 IP 的最高有效位相匹配。如： <code>ip:127.0.0.1/16:crwda</code>   这里文档说最高有效位与 client 主机 ip 最高有效位要相匹配，不过我实际试了下，不匹配也没有关系，这里暂时存疑。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200404070529.png-growing" alt="acl ip"></p></li><li><p>auth： 无 id， 对所有已认证的用户开放。形如 <code>auth::crwda</code> ，这里即使设置了 id，也会被忽略掉！</p></li><li><p>x509：使用 <strong>x509</strong> 证书进行 client 端验证，使用该方案时，需要在配置文件中配置如下选项 ，具体参见 <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperAdmin.html" target="_blank" rel="noopener">这里</a></p><blockquote><p>zookeeper.ssl.keyStore.location</p><p>zookeeper.ssl.trustStore.location</p><p>zookeeper.ssl.keyStore.password</p><p>zookeeper.ssl.trustStore.password</p></blockquote></li></ul><p>事实上，还有 <code>sasl</code>，你可以在 zoo.cfg 中进行配置：</p><blockquote><p>authProvider.1=org.apache.zookeeper.server.auth.SASLAuthenticationProvider</p></blockquote><p>以及 <code>super</code>  ！！！ </p><h2 id="Watch"><a href="#Watch" class="headerlink" title="Watch"></a>Watch</h2><p>Watch 有关的官方文档请参考 <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperProgrammers.html#ch_zkWatches" target="_blank" rel="noopener">这里</a></p><p>zk 的 watch 机制，也是我们 <a href="../introduction/">这篇文章</a> 提到的很多应用的保证之一，正式因为 zk 的 watch 机制提供了这些保证，我们才能说，这样做，是可以的。</p><p>那么，zk 的 watch 机制究竟是什么？又提供了哪些保证呢？</p><p>zk watch event ，当 watch 的 数据发生变化时，watch event 会 <strong>一次触发</strong> ，发送给设置了 watch event 的客户端。</p><ul><li>one-time trigger ： 当设置的 watch event 被处罚时，触发且仅触发一次。当这个节点再次改变时，不会二次触发，除非再次设置 watch event(<strong>3.6 中已经增加了永久，永久递归类型的 watch</strong>)</li><li>send to the client：watch event 会被异步的发送被 client，由于网络延迟等问题，会导致各个 client 收到 event 的时间差异， zk 保证 <strong>一个 client 永远不会在 watch event 到来前，观察到数据的变更，只有在 client 监听到 event 后，才能感知到数据的变化</strong> </li><li>the data for which the watch was set：这里指 zk 不同的 watch event ，会产生不同的效果。这里下文会介绍到</li></ul><h3 id="1-watch-event-type"><a href="#1-watch-event-type" class="headerlink" title="1. watch event type"></a>1. watch event type</h3><p>我们在 <code>org.apache.zookeeper.Watcher.Event.EventType</code> 能看到， 3.6 版本总共有如下几种 watch event：</p><ul><li>None：无 watch</li><li>NodeCreated：通过 exists() 添加，当这个节点被创建后，发出 watch event</li><li>NodeDeleted：通过 exists , getData , getChildren 添加</li><li>NodeDataChanged：exists 和 getData 添加</li><li>NodeChildrenChanged： getChildren 添加</li><li>DataWatchRemoved： exists 和 getData 添加</li><li>ChildWatchRemoved：getChildren 添加</li><li>PersistentWatchRemoved：persistent watch 添加， <font color="red">3.6.0</font> 中，专门有 addWatch 方法，该方法可以指定 watcher 类型，具体需要参考使用 zk client：<ul><li>PERSISTENT ： 持久 watch ，data change 和 children change 均会被触发</li><li>PERSISTENT_RECURSIVE：持久递归 watch，会 watch 给定 path 的 children</li></ul></li></ul><h3 id="2-zookeeper-guarantees-about-watches"><a href="#2-zookeeper-guarantees-about-watches" class="headerlink" title="2. zookeeper guarantees about watches"></a>2. zookeeper guarantees about watches</h3><ul><li>zk(准确说是 zk client) 保证 watch event 的派发是有序的</li><li>zk client 在收到 znode 的 watch event 之后才能看到该 znode 的新数据</li><li>zk 中 watch event 的顺序与 zk 看到的更新顺序一致。即 zk 中的 watch event 顺序与 zk 的更新顺序相对应</li></ul><p>基于 watch event 的特点，有两个地方需要特别注意：</p><ul><li>如果你使用一次性的 watch event，则在再次 watch znode 的时候，你需要做好遗漏该 znode 可能出现的多次变更的情况。因为在你再次添加 watch event 的时候，这个 znode 可能已经被改变了好几次了。</li><li>watch event 是 one-time trigger ， 也就是说，如果你既通过 exists 又通过 getData 设置了 watch event ，那么你最终只会获得一个 watch event 事件。</li></ul><h2 id="To-Be-Continue"><a href="#To-Be-Continue" class="headerlink" title="To Be Continue"></a>To Be Continue</h2><ol><li>FastLeaderElection</li><li>Zab 协议详解</li><li>部分源码解析</li><li>watch 源码解析</li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part 1 -- ZOOKEEPER 概要</title>
      <link href="/zookeeper/introduction/"/>
      <url>/zookeeper/introduction/</url>
      
        <content type="html"><![CDATA[<h1 id="ZooKeeper-lt-一-gt-应用场景"><a href="#ZooKeeper-lt-一-gt-应用场景" class="headerlink" title="ZooKeeper  < 一 > 应用场景"></a>ZooKeeper  &lt; 一 &gt; 应用场景</h1><blockquote><p>A Distributed Coordination Service for Distributed Applications</p></blockquote><p>这是 ZooKeeper 官方文档上的一句话，意为： 一款为分布式应用而生的分布式协同服务。</p><p>ZooKeeper version： 3.6.0</p><h2 id="ZooKeeper-架构"><a href="#ZooKeeper-架构" class="headerlink" title="ZooKeeper 架构"></a>ZooKeeper 架构</h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200403025045.jpg-growing" alt="ZooKeeper Architecture"></p><p>zk 集群通常包含</p><h3 id="1-角色"><a href="#1-角色" class="headerlink" title="1. 角色"></a>1. 角色</h3><ul><li>Leader：或者叫 Master <ul><li>zk集群(官方称之为 ensemble) 中，同一时间只有一个 leader，如果有多个，我们称之为 脑裂(网络分区可能产生这种情况)</li><li>leader 节点负责 ensemble 中所有的写操作，完成后广播给各个节点</li><li>leader 节点负责发起并维护与各个 follower/observer 的心跳。如果 leader 宕机，follower 收不到心跳，就会发起选举</li></ul></li><li>Follower：<ul><li>负责与之连接的 client 的读请求</li><li>负责将写请求转发给 leader</li><li>响应 leader 的心跳</li><li>参与选举</li></ul></li><li>Observer：不参与投票！其他与 Follower 功能一致</li></ul><h3 id="2-组件"><a href="#2-组件" class="headerlink" title="2. 组件"></a>2. 组件</h3><h4 id="2-1-ZNode-zookeeper-data-node"><a href="#2-1-ZNode-zookeeper-data-node" class="headerlink" title="2.1 ZNode(zookeeper data node)"></a>2.1 ZNode(zookeeper data node)</h4><p>在 <code>org.apache.zookeeper.CreateMode</code> 枚举类中，共有 7 中 znode 类型，我们一一介绍：</p><ul><li>PERSISTENT ： flag=0，持久节点，除非主动删除，否则一直存在</li><li>PERSISTENT_SEQUENTIAL ： flag = 2，持久顺序节点，该节点会带上一个单调递增的 10 位序列号</li><li>EPHEMERAL ：flag = 1，临时节点，会话结束即被删除</li><li>EPHEMERAL_SEQUENTIAL ：flag = 3，临时顺序节点，会话结束即被删除</li><li>CONTAINER ： flag = 4， 容器节点，当该节点下所有子节点被删除后， 该节点将在将来的某个时刻被删除</li><li>PERSISTENT_WITH_TTL ： flag = 5，该节点在客户端断开时不会被删除，但若在给定的 TTL 范围内没有修改，且没有子节点时， 将被删除</li><li>PERSISTENT_SEQUENTIAL_WITH_TTL ： flag = 6， 同上，多了顺序</li></ul><h4 id="2-2-ACL"><a href="#2-2-ACL" class="headerlink" title="2.2 ACL"></a>2.2 ACL</h4><p><a href="../how-to-use/#toc-heading-6">点击这里</a></p><h4 id="2-3-Watcher"><a href="#2-3-Watcher" class="headerlink" title="2.3 Watcher"></a>2.3 Watcher</h4><p><a href="../how-to-use/#toc-heading-10">点击这里</a></p><h4 id="2-4-ZAB"><a href="#2-4-ZAB" class="headerlink" title="2.4 ZAB"></a>2.4 ZAB</h4><p><a href="../zab/">点击这里</a></p><h2 id="ZooKeeper-常用应用场景"><a href="#ZooKeeper-常用应用场景" class="headerlink" title="ZooKeeper 常用应用场景"></a>ZooKeeper 常用应用场景</h2><h3 id="1-命名服务"><a href="#1-命名服务" class="headerlink" title="1. 命名服务"></a>1. 命名服务</h3><p>我们知道，zk 的顺序节点特性，就是创建的节点名后，会被加上一个单调递增的 10 位序列号。利用这个特性，我们可以实现全局统一命名服务。</p><ol><li><p>client1 向 /_namespace/_type1 节点下创建 _name 顺序节点，拼接后， _namespace_type1_name0000000001 </p></li><li><p>client2 向 /_namespace/_type2 节点下创建  _name 顺序节点，会获得，  _namespace_type2_name0000000002</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200403122544.png-growing" alt="zk namespace server"></p></li></ol><p>这样就实现了统一命名 </p><h3 id="2-分布式锁"><a href="#2-分布式锁" class="headerlink" title="2. 分布式锁"></a>2. 分布式锁</h3><p>分布式锁在这里可以分为两种</p><ul><li>抢占式</li><li>非抢占式</li></ul><p>对于<strong>抢占式分布式锁</strong>而言，可以利用 zk 的临时节点特性。</p><p>每个需要 Lock 的 client 向 zk 的 /lock 节点下创建 /get_lock 子节点(临时节点)，创建成功的 client 获得锁，完成后删除该临时节点。</p><p>其他 client 在创建失败后，watch 该节点，一旦发现被删除，再次试图创建 /get_lock ，成功即可获得锁。</p><p>对于非抢占式而言，可以利用 zk 的临时顺序节点特性。</p><p>每个需要 Lock 的 client ，在 /lock 节点下创建 /get_lock 临时顺序节点，成功后获取 /lock 节点下所有子节点，如果序号是最小的，则获取锁，否则 watch 上一个节点，收到 delete event 后即可获得 lock，使用完删除节点，释放锁</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200403121745.png-growing" alt="lock flow"></p><h3 id="3-发布订阅"><a href="#3-发布订阅" class="headerlink" title="3. 发布订阅"></a>3. 发布订阅</h3><p>服务发现，配置中心，都是一样。</p><p>这里以 dubbo zookeeper registry 的实现为例，如何利用 zk 的 临时节点，来完成服务发现</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200403123158.jpg-growing" alt="Dubbo ZooKeeper Registry Flow"></p><p>这里令 /root = /dubbo/com.foo.BarService</p><ul><li><p>首先启动服务提供者，会向 zk 的 /root/providers 节点下，写入自己的 URL 地址(临时节点)</p></li><li><p>然后启动服务消费者，会对 /root/providers 添加 watch，或者说是订阅，同时向 /root/consumers 节点下写入自己的 URL 地址(临时节点)</p></li><li><p>监控中心(一般为 dubbo admin)启动，watch 或者说订阅整个 /root 节点的 children，这样，当 provider 或者 consumer 发生变动时，我们就能及时的通过 dubbo admin 观察到</p></li></ul><h3 id="4-Master-选举"><a href="#4-Master-选举" class="headerlink" title="4. Master 选举"></a>4. Master 选举</h3><p>所谓 Master 选举，这里说的并不是 zk 的 leader 选举。</p><p>在分布式系统下，我们常常会遇到定时任务这种场景。比如在凌晨四点(凌晨再也没有四点了… )统计昨天的商品报表，我们只需要一个 server 去跑就好了。这里就可以利用 zk 的临时节点特性。</p><p>同样的，每台 server 在 run job 时，先去 zk 注册一个特定临时节点，比如 <code>/item/_statistics</code> ，由创建成功的 server 去执行就好</p><h3 id="5-others"><a href="#5-others" class="headerlink" title="5. others"></a>5. others</h3><ul><li>集群监控： 做法类似，每台 server 到指定节点下(如 _monitor)注册一个 ephemeral 类型节点，监控端负责 watch _monitor ,当有机器加入或者掉线，就会收到通知</li><li>分布式队列(FIFO)：利用 zk 的临时有序节点特性，在指定节点下创建临时有序节点后获取所有子节点，如果自己序号最小，则执行</li><li>负载均衡：利用临时节点特性，server 在指定节点创建临时节点，客户端读取节点下所有子节点列表，选择 server 服务</li></ul><h2 id="ISSUE"><a href="#ISSUE" class="headerlink" title="ISSUE"></a>ISSUE</h2><p><strong>New in 3.6.0:</strong> Clients can also set permanent, recursive watches on a znode that are not removed when triggered and that trigger for changes on the registered znode as well as any children znodes recursively.</p><p>3.6.0 已经开始支持永久的 watch 了</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="http://zookeeper.apache.org/doc/r3.6.0/index.html" target="_blank" rel="noopener">ZooKeeper 官方文档 r3.6.0</a></p><p><a href="https://github.com/apache/zookeeper" target="_blank" rel="noopener">GITHUB</a></p><p><a href="http://dubbo.apache.org/zh-cn/docs/user/references/registry/zookeeper.html" target="_blank" rel="noopener">Dubbo ZooKeeper Registry</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part 0 -- PAXOS</title>
      <link href="/zookeeper/paxos/"/>
      <url>/zookeeper/paxos/</url>
      
        <content type="html"><![CDATA[<h1 id="ZooKeeper-lt-零-gt-Paxos-算法浅析"><a href="#ZooKeeper-lt-零-gt-Paxos-算法浅析" class="headerlink" title="ZooKeeper<零> Paxos 算法浅析"></a>ZooKeeper&lt;零&gt; Paxos 算法浅析</h1><p>本文基于 <a href="https://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">Wiki Paxos 算法</a> 成文</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Paxos 算法由 Lamport 大神于 1990 年提出的一种基于消息传递且具有高度容错特性的共识算法。</p><p>Mike Burrows(Google Chubby 作者)曾说过：</p><blockquote><p>there is only one consensus protocol, and that’s Paxos</p></blockquote><p>我们知道，在分布式系统中，节点通信分为两种模型</p><ul><li>共享内存</li><li>消息传递</li></ul><p>基于消息传递模型的分布式系统，必然需要考虑如下问题</p><ul><li>消息丢失</li><li>消息重复</li><li>消息延迟</li><li>…</li></ul><p>在不考虑拜占庭错误的情况下，Paxos 算法解决的问题就是</p><blockquote><p>在一个可能发生上述异常的分布式场景中，如何就某一个值达成一致，</p><p>保证不论发生以上任何异常，都不会破坏决议的共识。</p><p>如在一个分布式数据库系统中，若各节点初始状态一致，每个节点都执行相同的</p><p>操作序列，那么最后能得到一个一致的状态。</p><p>为保证每个节点执行相同的命令序列，需要在每一条指令上执行一个“共识算法”</p><p> –  <a href="https://zh.wikipedia.org/wiki/Paxos算法" target="_blank" rel="noopener">WIKI Paxos 算法</a></p></blockquote><h2 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h2><p>在 Paxos 算法中，角色：</p><ul><li>proposer : 负责提出提案，相当于 zk 中的 leader</li><li>acceptor： 负责接受提案，相当于 zk 中的 follower</li><li>learner：负责学习提案，相当于 zk 中的 learner</li></ul><p>在具体的实现中，一个进程可能不止充当一种角色</p><p>本文中使用的名词：</p><ul><li><p>quorum： 超过半数的 acceptor 组成的集合(最早称之为 majority，这里直接使用 quorun)</p></li><li><p>proposal： 提案，由 proposal 提出，包含编号和值： proposal(n,v)</p></li><li><p>value：决议，被批准的提案，同样包括编号和值：value(n,v)</p></li></ul><h2 id="基准约束"><a href="#基准约束" class="headerlink" title="基准约束"></a>基准约束</h2><p>首先由 proposer 提出 proposal(n,v)，acceptor 接到提案后，可以选择接受提案，当该 proposal 获得了 quorum (大多数 acceptor)的支持后，则该 proposal 被批准(chosen)，成为 value，由 learner 进行学习。</p><p>那么， Paxos 要解决的问题可以归纳为：</p><ul><li>只有被 proposer 提出的提案(proposal)才能被选定</li><li>一次 Paxos 执行，只能有一个值(v)被选定</li><li>learner 只能获得被批准的提案(value)</li></ul><h2 id="推导"><a href="#推导" class="headerlink" title="推导"></a>推导</h2><p>Lamport 大神通过不断加强上述的三个约束(主要是第二个约束)，获得了 Paxos 算法。</p><h3 id="1-P1"><a href="#1-P1" class="headerlink" title="1. P1"></a>1. P1</h3><p>当只有一个 acceptor 存在时，acceptor 会选择它收到的第一个 proposal 作为 value(选定的提案)，提案流程结束。</p><p>然而，一个 acceptor 会导致单点问题，即这个 acceptor 挂掉后，整个分布式集群就无法工作(zk 通过 ZAB 协议解决了单点问题，不过在选举的过程中，仍然是多 acceptor)。</p><p>多 acceptor 时， proposer 向 acceptor 集合 (acceptors) 发送 proposal，当有足够多的 acceptor 接受时，这个 proposal 就被选定，成为决议(value)。</p><p>这里的足够多，我们认为是超过半数的 acceptor ，亦即前文的 quorun。</p><p>因为两组 quorum，必然至少包含同一个 acceptor， 如果一个 acceptor 最多只能通过一个提案，那么就能保证最终只有一个提案被选定。</p><p>我们希望在即使只有一个提案被提出的情况下，仍然能产生 value，由此我们得到 P1:</p><blockquote><p><strong>P1: 一个 acceptor 必须接受它第一次收到的提案</strong></p></blockquote><p>注意，这里的 P1 是不完备的。当 acceptor 个数为偶数，又恰好一半 acceptor 接受 A 提议，另一半接受 B 提议时，此时无法产生决议。</p><p>提案被选定需要半数以上 acceptor 通过，意味着，一个 acceptor 必须能通过不止一个提案。当一个具有 v 值的提案被 quorum 通过，我们就认为提案被选定。</p><h3 id="2-P2"><a href="#2-P2" class="headerlink" title="2. P2"></a>2. P2</h3><p>我们基于上文以及基准约束 2：</p><blockquote><p>一次 Paxos 执行，只能有一个值(v)被选定</p></blockquote><p>可以看到， Paxos 并不要求只批准一个 proposal，也就是说可能会批准多个提案。只要提案的值，即 proposal.v 一致，就不违背基准约束 2 ，于是我们得出</p><blockquote><p><strong>P2: 一旦一个具有 v 值的提案 proposal(n,v) 被批准，则之后批准的提案必须具有 v 值</strong></p></blockquote><p>这里的之后，一般都是通过一个全局序号(zk 中指 zxid)，来进行判断</p><h3 id="3-P2a"><a href="#3-P2a" class="headerlink" title="3. P2a"></a>3. P2a</h3><p>批准一个 value，意味着多个 acceptor 接受了这个 value，因此可以对 P2 进行加强：</p><blockquote><p>P2a：一旦一个 proposal(n,v) 被批准，则之后任何 acceptor 再次接受的提案，必须也具有 v 值</p></blockquote><p>满足 P2a ,即满足 P2</p><p>但是由于通信是异步的，当已经产生 value 后，一个 proposer 和 acceptor 刚苏醒，而这个 proposer 提出了一个新的 proposal(n1,v1) 提案，根据 P1 ，这个 acceptor 应该接受，但根据 P2a，又不应该接受！怎么办？</p><h3 id="4-P2b"><a href="#4-P2b" class="headerlink" title="4. P2b"></a>4. P2b</h3><p>我们想到在 proposer 端进行限制：</p><blockquote><p>P2b：一旦一个 proposal(n,v) 被批准，则之后任何 proposer 提出的提案，必须具有 v 值</p></blockquote><p>一个提案被 acceptor 接受前，需要由 proposer 提出，因此， 满足 P2b ==&gt; P2a ==&gt; P2</p><p>如何保证 P2b 呢？</p><p>我们假设 proposal(m,v) 提案被选定，根据 P2b， 则有 proposal(n,v’)，当 n &gt; m 时， v’ = v .</p><p>那么，如何来保证 v’ = v 呢？</p><h3 id="5-P2c"><a href="#5-P2c" class="headerlink" title="5. P2c"></a>5. P2c</h3><blockquote><p>P2c：若 proposal(n,v) 被提出，则存在一个 quorum 满足以下中的任一条件：</p><p>​    a)  quorum 中所有 acceptor 都未接受编号小于 n 的提案</p><p>​    b)  quorum 中所有 acceptor 已经接受所有编号小于 n 的提案中，最大的那个提案 v 值</p></blockquote><p>证明过程如下：</p><blockquote><p>假设具有value v的提案m获得批准，当n=m+1时，采用反证法，假如提案n不具有value v，而是具有value w，根据P2c，则存在一个多数派S1，要么他们中没有人接受过编号小于n的任何提案，要么他们已经接受的所有编号小于n的提案中编号最大的那个提案是value w。由于S1和通过提案m时的多数派C之间至少有一个公共的acceptor，所以以上两个条件都不成立，导出矛盾从而推翻假设，证明了提案n必须具有value v；</p><p>若（m+1）..（N-1）所有提案都具有value v，采用反证法，假如新提案N不具有value v，而是具有value w’,根据P2c，则存在一个多数派S2，要么他们没有接受过m..（N-1）中的任何提案，要么他们已经接受的所有编号小于N的提案中编号最大的那个提案是value w’。由于S2和通过m的多数派C之间至少有一个公共的acceptor，所以至少有一个acceptor曾经接受了m，从而也可以推出S2中已接受的所有编号小于n的提案中编号最大的那个提案的编号范围在m..（N-1）之间，而根据初始假设，m..（N-1）之间的所有提案都具有value v，所以S2中已接受的所有编号小于n的提案中编号最大的那个提案肯定具有value v，导出矛盾从而推翻新提案n不具有value v的假设。根据数学归纳法，我们证明了若满足P2c，则P2b一定满足。</p><p>—- <a href="https://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">WIKI</a></p></blockquote><p>为了维护 P2c 的不变性，当一个 proposer 提出 proposal(n,v) 时，必须要知道某一个将要或者已经被 quorum 通过的编号小于 n 的最大编号的提案值。</p><p>我们需要限定「将要通过」的情况，毕竟我们无法预测未来。这表示，proposer 会请求 acceptor 不再接受任何编号小于 n 的提案。</p><h3 id="6-算法"><a href="#6-算法" class="headerlink" title="6. 算法"></a>6. 算法</h3><p>上面的分析，可以推出如下算法：</p><h4 id="1-Proposer"><a href="#1-Proposer" class="headerlink" title="1. Proposer"></a>1. Proposer</h4><h5 id="1-1-prepare"><a href="#1-1-prepare" class="headerlink" title="1.1 prepare"></a>1.1 prepare</h5><ul><li>proposer 提交 proposal(n,v) 给 acceptors</li><li>proposer 要求 acceptor 做出如下承诺：<ul><li>保证不再通过任何小于编号 n 的提案</li><li>如果存在已通过的编号小于 n 的提案，将通过的小于 n 的最大编号提案返回</li></ul></li></ul><h5 id="1-2-commit-propose"><a href="#1-2-commit-propose" class="headerlink" title="1.2 commit/propose"></a>1.2 commit/propose</h5><ul><li>收到超过半数的 ack 回复，则产生 proposal(n, v)，这里的 v 是所有响应中编号最大的提案的 v 值，若响应中不包含，则由 proposer 自己选择</li></ul><h4 id="2-Acceptor"><a href="#2-Acceptor" class="headerlink" title="2. Acceptor"></a>2. Acceptor</h4><blockquote><p>P1a： acceptor 可以接受一个编号为 n 的提案，只要它还未响应任何编号大于 n 的 prepare 请求</p></blockquote><p>可以看出： P1a 蕴涵 P1</p><h5 id="2-1-prepare"><a href="#2-1-prepare" class="headerlink" title="2.1 prepare"></a>2.1 prepare</h5><ul><li>收到 propser 的 prepare(n.v) 请求，如果编号 n &gt; 所有响应中最大的提案编号，返回已经通过的最大编号的提案(没有可以返回 nil)</li></ul><h5 id="2-2-commit-accept"><a href="#2-2-commit-accept" class="headerlink" title="2.2 commit/accept"></a>2.2 commit/accept</h5><ul><li>收到 proposer 的 accept 请求后，如果没有对编号大于 n 的 prepare 请求做出过响应，就接受这个提案</li></ul><h4 id="3-整体描述"><a href="#3-整体描述" class="headerlink" title="3. 整体描述"></a>3. 整体描述</h4><h5 id="3-1-prepare-阶段："><a href="#3-1-prepare-阶段：" class="headerlink" title="3.1 prepare 阶段："></a>3.1 prepare 阶段：</h5><ul><li>proposer  发送 prepare(n,v) 给 acceptors</li><li>acceptor 收到 prepare(n,v) 后，如果 n 大于它已经响应的所有 prepare 请求编号， 则保证不再 <font color="#ff0000">accept</font> 任何编号小于 n 的提案，同时将已经通过的最大编号的提案(如果存在)回复。(这里已经通过，指的是该 acceptor 接受的提案，而不是 prepare 响应的提案)</li></ul><h5 id="3-2-propose-阶段："><a href="#3-2-propose-阶段：" class="headerlink" title="3.2 propose 阶段："></a>3.2 propose 阶段：</h5><ul><li>proposer 在收到大多数 acceptors 的回复后，根据回复，获取回复中编号最大的 value(如果所有回复中，都没有，则 value 可自行确定)，向 acceptors 发送 accept(n,v) 请求</li><li>在不违背 acceptor 对其他 proposer 的承诺下，acceptor 接受这个提案，否则拒绝。换句话说，即 如果 acceptor 收到一个针对编号 n 的提案的 accept 请求，<strong>只要它还未对编号大于 n 的 prepare 请求作出响应，它就可以通过这个提案</strong>。</li></ul><h3 id="7-流程图"><a href="#7-流程图" class="headerlink" title="7. 流程图"></a>7. 流程图</h3><p>我们以两个 proposer 和 3 个 acceptor 为例。</p><p>prepare 阶段，主要有两个方法</p><ul><li>prepare(n, expected_v) ： 由 proposer 发起一个编号为 n，值为 expected_v 的请求</li><li>promise(ack, accepted_n, accepted_v)：由 acceptor 返回，ack 为应答，accepted_n 为 acceptor 已经通过提案的最大编号，accepted_v 为对应的值，没有则为 nil</li></ul><p>accept/propose 阶段，也是两个方法</p><ul><li>propose(n，expected_v)：在该 proposer 收到超过半数 ack 后，发起 propose(n,expected_v) 请求，expected_v 为收到的应答中，最大编号的值，如果没有，就是自己的值</li><li>accept(ack, error)： 在不违背对其他 proposer 的承诺下，acceptor 接受这个提案，返回(ack, nil)， 否则返回 (ack, error)</li></ul><p><em>注</em> ： 这里<em>不违背对其他 proposer 的承诺</em>  ，指的是</p><ul><li>不响应编号比 n 小的提案</li><li>不接受编号比 n 小的提案</li></ul><p>WIKI 中说</p><blockquote><p>acceptor 收到 prepare 消息后，如果提案的编号大于它已经回复的所有 prepare 消息(回复消息表示接受accept)，则 acceptor 将自己上次接受的提案回复给 proposer，并承诺不再回复小于 n 的提案</p></blockquote><p>这里的<strong>承诺不再回复小于 n 的提案</strong> ，即指上面的两个不。</p><p>在 acceptor 收到 accept 请求前，如果收到了 prepare(n+1, v’)，那个这个 accept 请求则不会被应答，或者返回一个 error</p><h4 id="prepare"><a href="#prepare" class="headerlink" title="prepare"></a>prepare</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200402124723.png-growing" alt="prepare phrase"></p><p>P1 和 P2 分别向 A1/A2, A2/A3 发送 prepare 请求，A1/A3 都是正常应答，同时将各自的应答记录修改。</p><p>A2 先收到 P1 prepare 请求，responsed_n 置为 1， 同时给与 P1 ack， 后收到 P2 prepare(2, 2)，根据规则，P2 的提案编号 2 大于 P1 的编号 1，所以，A2 将 responsed_n 置为 2， 同时回复 ack。这里 A2 在此之前，并没有批准，即 accept 任何提案，所以回复的 promise 应该为 promise(ack, nil, nil)</p><p>那么此时 P1 和 P2 都得到了半数以上的 ack ，都可以进行 accept 请求。</p><h4 id="propose-accept"><a href="#propose-accept" class="headerlink" title="propose/accept"></a>propose/accept</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200402134022.png-growing" alt="accept phrase"></p><p>在第二阶段</p><p>P1， 向 A1, A2, A3 发起 propose(1, 1) 请求， 其中：</p><ul><li>A1： 在 P2 发送请求之前，收到了 P1 的 propose 请求，在此之前只收到过 P1 的 prepare 请求，未对编号大于 1 的 prepare 请求做出过回应，遵守承诺，接受了 P1 的请求，回复 ack， accept(ack, nil, nil)</li><li>A2/A3：已经收到过 P2 的 prepare 请求，且 P2 编号 2， 大于 1，不回复 P1 或回复 error</li></ul><p>所以 P1 得到 A1 的 ack ，未超过半数</p><p>P2， 向 A1， A3 发起 propose(2, 2) 请求，其中：</p><ul><li>A1： 未作出过大于 2 的 prepare 响应，接受 P2 的请求，修改 responsed_n，accepted_n/v 同时返回 accept(ack)</li><li>A3：同样未违背承诺，修改 responsed_n, accepted_n/v ， 返回 accept(ack)</li></ul><p>P2 收到半数以上的 ack ，提案被选中。</p><p>之后 A1 再次去发起提案的时候，此时 n 会递增到 3，在 prepare(3,1) 阶段，会收到 A1，A3 的 ack，形如 propose(ack, 2, 2)， A1 收到半数请求后，从中挑出编号不大于 3 的最大编号，同时修改自己的值， 从 1 变为 2，再次发送 prepare(3,2)，会得到超过半数的 ack ， 提案被选中，结束。</p><p>本轮 paxos 中，最终选择的值为 2</p><h3 id="8-Paxos-活锁-LiveLock"><a href="#8-Paxos-活锁-LiveLock" class="headerlink" title="8. Paxos  活锁(LiveLock)"></a>8. Paxos  活锁(LiveLock)</h3><p>我们以 P1, P2 + A 为例</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200402140130.png-growing" alt="prepare phrase LiveLock"></p><p>如图示，每次 P1 或 P2 propose 时， 总是会发现更高的 prepare 编号，从而不断进行 prepare 。</p><p>一般这种情况很少见，可以通过 <em>随即睡眠-重试</em> 的方法避免</p><h2 id="Multi-Paxos"><a href="#Multi-Paxos" class="headerlink" title="Multi-Paxos"></a>Multi-Paxos</h2><h2 id="Fast-Paxos"><a href="#Fast-Paxos" class="headerlink" title="Fast-Paxos"></a>Fast-Paxos</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">WIKI Paxos 算法</a></li><li><a href="https://github.com/oldratlee/translations/tree/master/paxos-made-simple" target="_blank" rel="noopener">Paxos Made Simple 翻译稿</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> algorithm </tag>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Build Your Own Blog</title>
      <link href="/tools/blog/"/>
      <url>/tools/blog/</url>
      
        <content type="html"><![CDATA[<h1 id="hexo-搭建个人博客"><a href="#hexo-搭建个人博客" class="headerlink" title="hexo 搭建个人博客"></a>hexo 搭建个人博客</h1><ul><li><p><a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank" rel="noopener">hexo-theme-matery</a> </p></li><li><p><a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md" target="_blank" rel="noopener">README</a></p></li><li><p><a href="https://github.com/hexojs/hexo" target="_blank" rel="noopener">Hexo</a></p></li></ul><h2 id="BLOG-地址"><a href="#BLOG-地址" class="headerlink" title="BLOG 地址"></a>BLOG 地址</h2><p><a href="https://buzhui.top" target="_blank" rel="noopener">iyuhp’s blog</a> </p><h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><p>本 blog 使用 <a href="https://github.com/hexojs/hexo" target="_blank" rel="noopener">HEXO</a> 搭建， <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank" rel="noopener">MATERY</a> 作为主题， nginx 作静态代理，搭配 HTTPS 使用。</p><h2 id="搭建步骤"><a href="#搭建步骤" class="headerlink" title="搭建步骤"></a>搭建步骤</h2><h3 id="1-安装-hexo-cli"><a href="#1-安装-hexo-cli" class="headerlink" title="1. 安装 hexo-cli"></a>1. 安装 hexo-cli</h3><p>安装之前，请确认本机已经有 node 环境，可选择安装 cnpm。</p><pre class=" language-shell"><code class="language-shell">cnpm install -g hexo-cli</code></pre><h3 id="2-初始化一个-project"><a href="#2-初始化一个-project" class="headerlink" title="2. 初始化一个 project"></a>2. 初始化一个 project</h3><pre class=" language-shell"><code class="language-shell">hexo init blogcd blogcnpm i</code></pre><p>此时，通过 <code>tree . -L 1</code> 命令查看</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401073032.png-growing" alt="image-20200401073027300"></p><ul><li><p>_config.yml: 网站的配置信息， 绝大部分的配置，都在这里修改，这里的配置是你自己的配置</p></li><li><p>scaffolds： 模板文件夹，新建文章时， 根据其中的模板进行填充相关内容，可以在 _config.yml 中配置选择使用哪种模板</p></li><li><p>source：用户存放资源的地方。 除  _posts 文件夹之外，开头命名为 _ (下划线)的文件、文件夹和隐藏的文件将会被忽略。Markdown 和 HTML 文件会被解析并放到 public 文件夹，而其他文件会被拷贝过去</p></li><li><p>themes：主题文件夹， hexo 根据主题来生成静态页面，主题目中也会有一个 _config.yml 配置文件，是关于主题的配置</p></li></ul><h3 id="3-使用主题"><a href="#3-使用主题" class="headerlink" title="3. 使用主题"></a>3. 使用主题</h3><p>关于 matery 主题的使用，可以参考 <a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md" target="_blank" rel="noopener">这里</a> 。</p><p>我们把下载下来的稳定版本 copy 到 themes 目录下，然后在 _config.yml 中指定主题为 <code>hexo-theme-matery</code> , 同时参考 matery 文档，完成其他配置后，执行 <code>hexo s</code> 本地启动后，查看效果。</p><p>使用主题的方式有：</p><ol><li><p>直接下载后添加</p></li><li><p>或者 git clone 到 theme 目录下</p></li><li><p>或者 通过 git submodule</p><pre class=" language-shell"><code class="language-shell">git submodule add https://github.com/blinkfox/hexo-theme-matery.git themes/hexo-theme-matery</code></pre></li></ol><h3 id="4-新建文章"><a href="#4-新建文章" class="headerlink" title="4. 新建文章"></a>4. 新建文章</h3><p>在 <a href="https://hexo.io/zh-cn/docs/configuration" target="_blank" rel="noopener">这里</a> 可以查看到关于 hexo 的各种命令。</p><p>使用 *<em><code>hexo new --path folder/article "Oh Beautiful"</code> *</em>，会在当前 source/_post 目录下(这里根据你配置里的 default_layout，会在对应的目录下新建)新建一个 folder 目录，folder 目录中新建 article.md 文件， title 为 Oh Beautiful 。<br>这个命相比较于直接 new ， 好处是能把文章按照目录进行分类。</p><p>这里贴一份我的 scaffold 里 post.md 的 layout：</p><pre><code>---title: {{ title }}date: {{ date }}author: peifengimg: {{ zhankeng }}top: truecover: truecoverImg: {{ zhankeng }}password: passwordpasswordpasswordtoc: truemathjax: falsesummary: {{ zhankeng }}categories: Markdowntags:  - Typora  - Markdown---</code></pre><p>官网关于 new 命令的介绍</p><p>更多配置说明请参考 <a href="https://hexo.io/zh-cn/docs/configuration" target="_blank" rel="noopener">这里</a></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401070947.png-growing" alt="image-20200401070945664"></p><h3 id="5-使用评论插件"><a href="#5-使用评论插件" class="headerlink" title="5. 使用评论插件"></a>5. 使用评论插件</h3><p>hexo 的评论插件有很多种，比如 gitalk，gitment，disqus(国内基本可以不考虑)，valine 等，我看了各种效果， valine 和 gitalk 比较满意。</p><p>valine 需要先到 <a href="https://www.leancloud.cn/" target="_blank" rel="noopener">LeanCloud</a> 上注册账号，它会提供给开发者一个 <strong>1G</strong> 的免费存储空间( <a href="https://www.leancloud.cn/pricing/" target="_blank" rel="noopener">计价方案</a>)，超出部分 0.10 元 / GB / 天。 个人 blog，感觉肯定是够用的(这里不得不感叹，果然是能薅羊毛，就薅羊毛啊，啊哈哈哈)，因为其实不会有多少人来评论的！！！</p><p>不过我对于 valine 的权限控制有点不满意。因为我本身有后台服务支撑，后续打算对 valine 做点改动，所有评论由我自己递交给 leancloud，这样就不用暴露 leancloud 的 ak 和 sk 了。当然，这是静态 blog 的通病，木的办法。</p><p>而 gitalk，则是基于 github issue 做的实现，所有的评论，其实都是 github 上一个 repo 的 issue。这样的话，我其实不用关心这个 repo 的最终结局会怎样，大不了我删了重建一个新 repo 呗。</p><p>当然，gitalk 有两个问题</p><ol><li>网络问题，经常性出现 Network Error 之类的问题</li><li>权限问题，用户留言时，gitalk 会要求用户给与十分大的权限，如果这个 blog 博主拿到权限后，做了一些乱七八糟的事情，可就不太好了。。。我就碰到自动 fork 博主项目的</li></ol><p>关于 gitalk 的使用：</p><p><a href="https://github.com/gitalk/gitalk/blob/master/readme-cn.md" target="_blank" rel="noopener">gitalk 文档</a></p><ol><li>在 <a href="https://github.com/settings/applications/new" target="_blank" rel="noopener">New Oauth</a> 上新建一个授权应用</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401073717.png-growing" alt="image-20200401073715809"></p><p>callback URL， 这里说下，根据 oauth2 协议，这个 callback URL 就是完成授权后的回调地址，这里可以填写自己网站的首页。</p><ol start="2"><li>完成后会拿到 client id 和 client secret，填入到 theme 下的 _config.yml 即可。</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401073826.png-growing" alt="image-20200401073822373"></p><ul><li>repo： 即你的评论提交的地方，一个 github repo</li><li>owner: 你 repo 所属的组织或者个人</li><li>admin: 对这个 repo 有写权限的人</li></ul><p>然后你就能愉快的使用评论功能了</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401073953.png-growing" alt="image-20200401073951830"></p><h3 id="6-其他优化"><a href="#6-其他优化" class="headerlink" title="6. 其他优化"></a>6. 其他优化</h3><h4 id="6-1-图片懒加载"><a href="#6-1-图片懒加载" class="headerlink" title="6.1 图片懒加载"></a>6.1 图片懒加载</h4><h4 id="6-2-代码压缩"><a href="#6-2-代码压缩" class="headerlink" title="6.2 代码压缩"></a>6.2 代码压缩</h4><h4 id="6-3-SEO-优化"><a href="#6-3-SEO-优化" class="headerlink" title="6.3 SEO 优化"></a>6.3 SEO 优化</h4><p>参考 <a href="https://blog.sky03.cn/posts/42790.html" target="_blank" rel="noopener">hexo 优化</a></p><h4 id="6-4-CDN-加速"><a href="#6-4-CDN-加速" class="headerlink" title="6.4 CDN 加速"></a>6.4 CDN 加速</h4><p>关于 CDN 加速，也是通过 github + <a href="https://www.jsdelivr.com/" target="_blank" rel="noopener">jsDelivr</a> 完成。具体操作就是，在发布代码的时候，如果本身就托管在 github 上，那最方便，直接在 theme 主题下的 _config.yml 中配置 <code>jsDelivr.url</code> 即可，形如：</p><pre><code># 如你的 repo 地址： https://github.com/A/B# 则这里的地址就这样填写https://cdn.jsdelivr.net/gh/A/B</code></pre><p>再次访问的时候， 就会去这里访问静态资源了。<br>我个人只把一部分如 css/js/libs 放到了 github 上，其他的，放在自己的 ecs 上。<br>关于 SEO 优化， 上面的文章也写的很详细了， 我个人只配置了 google 的， baidu 要做各种认证，就懒得配了，啊哈哈哈。</p><h3 id="7-百度统计"><a href="#7-百度统计" class="headerlink" title="7. 百度统计"></a>7. 百度统计</h3><p><a href="https://tongji.baidu.com/web/10000169496/welcome/login" target="_blank" rel="noopener">百度统计</a> 可以用来分析网站各个维度的信息，比如访问人数， pv， uv 等。<br>用起来也很简单， 先在 <a href="https://tongji.baidu.com/web/10000169496/welcome/login" target="_blank" rel="noopener">这里</a> 注册一个账号，创建一个应用，获取 id， 然后到 theme 下的 baiduAnalytics 那开启并配置 id ，即可看到一些统计信息了。</p><h3 id="8-end"><a href="#8-end" class="headerlink" title="8. end"></a>8. end</h3><p>至此，在本地就能很方便的访问了</p><h2 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h2><p>在 <a href="https://wanwang.aliyun.com/domain/" target="_blank" rel="noopener">域名注册</a> 这里可以挑选一个合适的域名， 我当时买的时候，<em>.top</em>  后缀三年，好像才几十块钱。注册完成后，看你自己选择，要不要备案。如果选择备案，需要打印一张表格，填完后拍照上传，之后到阿里云备案，阿里云会免费邮寄一张蓝色的幕布(就是一张蓝色的纸…)，然后你需要拍照上传。整个过程大约一个礼拜左右能搞定。不需要花钱。</p><h2 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h2><p>但是阿里云搞活动，我选购了一台， 很便宜了。现在不知道是什么情况</p><h2 id="SSL-证书"><a href="#SSL-证书" class="headerlink" title="SSL 证书"></a>SSL 证书</h2><p>免费的 SSL 证书，提供商也很多，我这里选择的是 <a href="https://freessl.cn/" target="_blank" rel="noopener">FreeSSL</a> ， 选择 Let’s Encrypt V2 ， 可以搞泛域名证书，这个还是很开心的。</p><p>如果你不需要泛域名， 只是单域名，那完全可以直接到阿里云/腾讯云等各个平台免费申请，都是一年的免费申请。还很方便。</p><p>在 freeSSL 上申请证书的时候，他会给你几个 TXT 类型的 DNS 解析，这个需要配置到你的 DNS 服务商那里。</p><p>阿里云的话， 在 <a href="https://dc.console.aliyun.com/next/index?spm=a2c1d.8251892.favorites.ddomain.784c5b76NZRlLv#/domain/list/all-domain" target="_blank" rel="noopener">这里</a> 应该能找到配置</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401074420.png-growing" alt="image-20200401074419037"></p><p>新添加后，基本都是立即生效的。(虽然说的是 10 分钟生效，还是相当谦虚的)</p><p>不过申请的 SSL 有效期，<font color="#ff0000"><strong>只有三个月</strong></font> ！！！注意需要定期更换</p><h3 id="acme-sh"><a href="#acme-sh" class="headerlink" title="acme.sh"></a>acme.sh</h3><p>通过 <a href="https://github.com/acmesh-official/acme.sh" target="_blank" rel="noopener">acme.sh</a> 来获取并自动更新 CA 证书。</p><blockquote><p>安装 acme.sh</p></blockquote><p>安装过程 <a href="https://github.com/acmesh-official/acme.sh/wiki/%E8%AF%B4%E6%98%8E" target="_blank" rel="noopener">这里</a> 讲的十分详细：</p><pre class=" language-bash"><code class="language-bash">curl  https://get.acme.sh <span class="token operator">|</span> sh<span class="token function">alias</span> acme.sh<span class="token operator">=</span>~/.acme.sh/acme.sh</code></pre><p>通过 <code>crontab -l</code> 可以看到， acme 创建了一个定时任务， 我的是每天凌点两分的时候(是的，两分的时候…) 自动检测所有证书，快过期则会更新。</p><blockquote><p>生成证书</p></blockquote><p>我网站配置的是 <code>RSA + ECC</code> 双证书，所以这里需要通过 acme.sh 生成两份证书：</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># RSA 默认长度 2048，可选 3072， 4096， 8192</span>acme.sh --issue --dns dns_ali -d buzhui.top -d *.buzhui.top --keylength <span class="token punctuation">[</span>2048<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># ECC ec-256, ec-384, ec-512</span>acme.sh --issue --dns dns_ali -d buzhui.top -d *.buzhui.top --keylength ec-256</code></pre><ul><li><code>--dns</code> ： acme 支持 http 或 dns 方式验证证书，我这里使用的是 ali dns (我用的阿里的 DNS 服务器)。</li><li>-d ： 主域名(必须)</li><li>-d ： 泛域名(可选)</li></ul><p>如果选择使用DNS 方式验证，则需要设置阿里云的 ak 和 sk 。<a href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi" target="_blank" rel="noopener">这里</a>有详细文档：</p><pre class=" language-bash"><code class="language-bash"><span class="token function">export</span> Ali_Key<span class="token operator">=</span><span class="token string">"sdfsdfsdfljlbjkljlkjsdfoiwje"</span><span class="token function">export</span> Ali_Secret<span class="token operator">=</span><span class="token string">"jlsdflanljkljlfdsaklkjflsa"</span></code></pre><p><strong>最好</strong> 使用阿里云的 RAM 功能，单独开一个 RAM ，给一个 domain 权限，保证权限在可控范围内，反正主账号的 ak 和 sk ，<strong>千万不要随便外泄</strong> </p><p>如果你使用 RAM 功能，则该子账号需要 “管理云解析(DNS)的权限”，而不是”管理域名的服务权限”</p><p>此时， 在 acme.sh 的安装目录(一般在 ~/.acme.sh 目录下)，会生成一个 buzhui.top(你自己的域名) 目录，里面有一堆的证书。</p><p>我们可以 cp 证书到 <code>/etc/nginx/ssl</code> 目录下，<code>fullchain.csr</code> 和 <code>buzhui.top.key</code> ， 然后命名成你 nginx 中配置的名字即可。</p><p>当然，你可以使用 acme 提供的命令：</p><pre class=" language-bash"><code class="language-bash">acme.sh --installcert -d example.com \--key-file       /path/to/keyfile/in/nginx/key.pem  \--fullchain-file /path/to/fullchain/nginx/cert.pem \--reloadcmd     <span class="token string">"service nginx force-reload"</span></code></pre><p>acme.sh 手动更新 / 自动更新 / 关闭更新：</p><pre class=" language-bash"><code class="language-bash">acme.sh --upgrade <span class="token comment" spellcheck="true"># 手动更新</span>acme.sh  --upgrade  --auto-upgrade  <span class="token comment" spellcheck="true"># 自动更新</span>acme.sh --upgrade  --auto-upgrade  0 <span class="token comment" spellcheck="true"># 关闭自动更新</span></code></pre><h3 id="使用-CAA"><a href="#使用-CAA" class="headerlink" title="使用 CAA"></a>使用 CAA</h3><p>CAA 是啥？ 请看 <a href="https://zh.wikipedia.org/wiki/DNS%E8%AF%81%E4%B9%A6%E9%A2%81%E5%8F%91%E6%9C%BA%E6%9E%84%E6%8E%88%E6%9D%83" target="_blank" rel="noopener">这里</a></p><blockquote><p><strong>DNS证书颁发机构授权</strong>（英语：DNS Certification Authority Authorization，<a href="https://zh.wikipedia.org/wiki/简称" target="_blank" rel="noopener">简称</a>：CAA）是一种<a href="https://zh.wikipedia.org/w/index.php?title=互联网安全&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">互联网安全</a>政策机制，允许<a href="https://zh.wikipedia.org/wiki/域名" target="_blank" rel="noopener">域名</a>持有人指定可以为其域签发证书的<a href="https://zh.wikipedia.org/wiki/证书颁发机构" target="_blank" rel="noopener">证书颁发机构</a>。该政策凭借一个新的<a href="https://zh.wikipedia.org/wiki/域名系统" target="_blank" rel="noopener">域名系统</a><a href="https://zh.wikipedia.org/wiki/域名伺服器記錄類型列表" target="_blank" rel="noopener">资源记录</a>“CAA”来实现。</p><p>这一标准由计算机科学家<a href="https://zh.wikipedia.org/w/index.php?title=菲利普·哈勒姆-贝克&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">菲利普·哈勒姆-贝克</a>和罗布·斯特拉德林（Rob Stradling）起草，旨在应对公众对证书颁发机构安全性的担忧。它是由<a href="https://zh.wikipedia.org/wiki/互联网工程任务组" target="_blank" rel="noopener">互联网工程任务组</a>建议的一项<a href="https://zh.wikipedia.org/wiki/互联网标准" target="_blank" rel="noopener">互联网标准</a>。</p><p>– 摘自 WIKI</p></blockquote><p>如何在阿里云 DNS 上使用 CAA，参考下图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200427142927.png-growing" alt="CAA Config in Ali DNS"></p><p>记录值的一般结构为 ： <code>flag tag value</code> </p><ul><li>flag ： 用于标志认证机构。通常情况下填 0，表示如果颁发证书机构无法识别本条信息，就忽略。</li><li>tag ： 有三个值可选：<ul><li>issue ：授权 value 中指明的 CA 机构有权为当前域名颁发证书，也就是说，你的域名的证书，只能是来自这家 CA 机构</li><li>issuewild ：与 issue 类似，但仅授权颁发通配符证书，但请求为通配符证书时，这一属性高于 issue 属性</li><li>iodef ：用来向域名持有者报告无效证书请求的方法。即 CA 机构会将违规的颁发记录 URL 发送给某个电子邮箱， 如： <code>0 iodef "mailto:my@gmail.com"</code></li></ul></li></ul><h2 id="Nginx-配置-1-14-1"><a href="#Nginx-配置-1-14-1" class="headerlink" title="Nginx 配置 (1.14.1)"></a>Nginx 配置 (1.14.1)</h2><p>在这一部分， 需要一个(备案的)域名，一台服务器(ecs)，以及 ssl 证书</p><p>Linux 下安装 nginx，这里不再赘述，centos 8 可以直接通过 <code>sudo dnf install nginx -y</code> 安装</p><p>这里多说一句， dnf 相比较于 yum，要更好用，按照历史规矩， yum 在将来，应该会被 dnf 取代。</p><p>再多说一句， centos 8 ，终于不再依赖 python2.7 了，vim 的基础版本也是 8.0，对于想要安装 YCM 的童鞋来说，也算是一个不错的好消息。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401074825.png-growing" alt="image-20200401074823558"></p><p>我的 nginx 目录长这样。</p><p>在 nginx.conf 中， include conf.d 目录下所有的 *.conf 的配置文件，这算很常见的配置方案，对于多应用来说，可以各自维护各自的 conf 文件。</p><p>我们在 <a href="https://ssl-config.mozilla.org/#server=nginx&amp;version=1.14.1&amp;config=intermediate&amp;openssl=1.1.1d&amp;guideline=5.4" target="_blank" rel="noopener">这里</a> 能找到一份不错的 nginx 配置，由 mozilla 推荐的配置</p><p>这是 nginx.conf 的完整配置以及 https 优化。</p><pre class=" language-nginx"><code class="language-nginx"><span class="token comment" spellcheck="true"># ...</span><span class="token comment" spellcheck="true"># 加载 nginx 模块</span><span class="token keyword">include</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>modules<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span><span class="token keyword">http</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true"># ...</span>    <span class="token keyword">sendfile</span>            on<span class="token punctuation">;</span>    <span class="token keyword">tcp_nopush</span>          on<span class="token punctuation">;</span>    <span class="token keyword">tcp_nodelay</span>         on<span class="token punctuation">;</span>    <span class="token keyword">keepalive_timeout</span>   <span class="token number">65</span><span class="token punctuation">;</span>    <span class="token keyword">types_hash_max_size</span> <span class="token number">2048</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># 全局 ssl 证书配置</span>    <span class="token keyword">ssl_certificate</span>      <span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>nginx<span class="token operator">/</span>server_ssl<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>    <span class="token keyword">ssl_certificate_key</span>  <span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>nginx<span class="token operator">/</span>private<span class="token operator">/</span>server_ssl<span class="token punctuation">.</span>key<span class="token punctuation">;</span>    <span class="token keyword">ssl_certificate</span>     <span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>nginx<span class="token operator">/</span>ssl_ecc<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>    <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>nginx<span class="token operator">/</span>private<span class="token operator">/</span>ssl_ecc<span class="token punctuation">.</span>key<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># session 配置</span>    <span class="token keyword">ssl_session_cache</span>    shared<span class="token punctuation">:</span><span class="token keyword">SSL</span><span class="token punctuation">:</span>10m<span class="token punctuation">;</span>    <span class="token keyword">ssl_session_timeout</span>  1d<span class="token punctuation">;</span>    ssl_session_tickets  off<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># 协议配置 ssl_ciphers 仅作示例，具体配置下文有说明</span>    <span class="token keyword">ssl_protocols</span>       TLSv1<span class="token number">.2</span> TLSv1<span class="token number">.3</span><span class="token punctuation">;</span>    <span class="token keyword">ssl_prefer_server_ciphers</span>   off<span class="token punctuation">;</span>    <span class="token keyword">ssl_ciphers</span>         CDHE<span class="token operator">-</span>ECDSA<span class="token operator">-</span>AES128<span class="token operator">-</span>GCM<span class="token operator">-</span>SHA256<span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># TODO 开启 oscp</span>    <span class="token comment" spellcheck="true"># ssl_stapling      on;</span>    <span class="token comment" spellcheck="true"># ssl_stapling_verify       on;</span>    <span class="token comment" spellcheck="true"># ssl_trusted_certificate   ospc_file_path</span>    <span class="token comment" spellcheck="true"># common header 证书有效期问题，这里设置 7776000 </span>    <span class="token keyword">add_header</span> Strict<span class="token operator">-</span>Transport<span class="token operator">-</span>Security <span class="token string">"max-age=7776000;"</span> always<span class="token punctuation">;</span>    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Frame<span class="token operator">-</span>Options <span class="token string">"SAMEORIGIN"</span> always<span class="token punctuation">;</span>    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Xss<span class="token operator">-</span>Protection <span class="token string">"1; mode=block"</span> always<span class="token punctuation">;</span>    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Content<span class="token operator">-</span>Type<span class="token operator">-</span>Options <span class="token string">"nosniff"</span> always<span class="token punctuation">;</span>    brotli on<span class="token punctuation">;</span>    brotli_static on<span class="token punctuation">;</span>    brotli_min_length   <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 大于或等于 50 字节时才会进行压缩</span>    brotli_comp_level   <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 压缩等级 默认 6 越高 cpu 用的越多</span>    brotli_buffers      <span class="token number">16</span> 8k<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 请求缓冲区的数量和大小</span>    brotli_types text<span class="token operator">/</span>plain text<span class="token operator">/</span>css text<span class="token operator">/</span>javascript application<span class="token operator">/</span>javascript text<span class="token operator">/</span>xml application<span class="token operator">/</span>xml image<span class="token operator">/</span>svg<span class="token operator">+</span>xml application<span class="token operator">/</span>json<span class="token punctuation">;</span>    <span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="1-全局-ssl-证书配置"><a href="#1-全局-ssl-证书配置" class="headerlink" title="1. 全局 ssl 证书配置"></a>1. 全局 ssl 证书配置</h3><p>这里采用的是双证书模式，RSA 和 ECC 两种加密方式的证书。如果各自的 conf 有新证书，直接在各自的 conf 中配置，会覆盖掉全局的配置</p><h3 id="2-session-配置"><a href="#2-session-配置" class="headerlink" title="2. session 配置"></a>2. session 配置</h3><p>一般开启服务端 session 缓存，1M 大约能缓存 4000 个 session，这里配置了 10M</p><h3 id="3-协议优化"><a href="#3-协议优化" class="headerlink" title="3. 协议优化"></a>3. 协议优化</h3><p>TLSv1.1， TLSv1.2，TLSv1.3， TLSv1.3 相较于前者， 做到了更安全和更快， 如果你不需要向前兼容，直接选择 TLSv1.3 就好了。我本来也如此，后来对接 gitee 的 push hooks 的时候，发现握手一直挂，无奈，又配上了 TLSv1.2</p><p>关于 <code>ssl_prefer_server_ciphers off</code>  这个选项的更多解释：<a href="https://github.com/mozilla/server-side-tls/issues/260" target="_blank" rel="noopener">GITHUB ISSUE</a></p><h3 id="4-add-header"><a href="#4-add-header" class="headerlink" title="4. add_header"></a>4. add_header</h3><p>是一些列的安全配置和 hsts 配置</p><h3 id="5-brotli-压缩"><a href="#5-brotli-压缩" class="headerlink" title="5. brotli 压缩"></a>5. brotli 压缩</h3><p>一种压缩算法，比常用 gzip 要更给力。目前几乎所有主流浏览器都支持了 br ，但不免有漏网之鱼，所以可以选择同时支持 br 和 gzip 。</p><p>在使用 br 之前，需要先给 nginx 加上 brotli 模块。在 centos 8 下，操作如下：</p><h4 id="5-1-下载-nginx"><a href="#5-1-下载-nginx" class="headerlink" title="5.1 下载 nginx"></a>5.1 下载 nginx</h4><p>具体哪个版本，视你安装的 nginx 版本而定，可通过 <code>nginx -V</code> 查看， 我这里使用的是 <strong>nginx/1.14.1</strong> </p><pre class=" language-shell"><code class="language-shell"># 这之前， 你可能需要安装一些基础工具包sudo dnf install -y curl wget unzip socat bash-completion epel-release && sudo dnf groupinstall "Development Tools"sudo dnf install -y pcre pcre-devel zlib zlib-devel openssl openssl-develwget https://nginx.org/download/nginx-1.14.1.tar.gz && tar zxvf nginx-1.14.1.tar.gz</code></pre><h4 id="5-2-下载-brotli"><a href="#5-2-下载-brotli" class="headerlink" title="5.2 下载 brotli"></a>5.2 下载 brotli</h4><pre class=" language-shell"><code class="language-shell">git clone https://github.com/google/ngx_brotli.gitcd ngx_brotli && git submodule update --init</code></pre><h4 id="5-3-编译"><a href="#5-3-编译" class="headerlink" title="5.3 编译"></a>5.3 编译</h4><p>这里要十分的注意，我们需要编译的 <code>.so</code> 文件，最终是我们已经安装的 nginx 去执行，所以我们在 make 的时候，所有的环境配置需要和已安装的 nginx 一致。</p><p>我最开始的时候没有注意到这一点，踩了坑，最后 restart nginx 的时候，一致报 <strong>is not binary compatible</strong> 之类的错误</p><pre class=" language-shell"><code class="language-shell"># 1. 获取当前运行 nginx 的环境配置sudo nginx -V# 进入下载的 nginx 源码目录操作# 上一步会输出 configure arguments，我们设为 A， 把他们全部加入其中# --add-dynamic-module=../ngx_brotli 这里的路径根据你下载 brotli 的位置而定./configure A --add-dynamic-module=../ngx_brotli</code></pre><p>这一步执行的时候，可能还会报错，一般都是缺少依赖。如：</p><pre class=" language-shell"><code class="language-shell"># This is perl 5, version 26, subversion 3 (v5.26.3) built for x86_64-linux-thread-multi# Can't locate ExtUtils/Embed.pm in @INC (you may need to install the ExtUtils::Embed module).......# 此时执行：sudo dnf -y install perl-devel perl-ExtUtils-Embed# the HTTP image filter module requires the GD library# 执行sudo dnf -y install gd gd-devel</code></pre><h4 id="5-4-cp-so-文件"><a href="#5-4-cp-so-文件" class="headerlink" title="5.4 cp .so 文件"></a>5.4 cp .so 文件</h4><p>上一步执行完成后， 会在  nginx 下的 objs 目中中生成 </p><p><code>ngx_http_brotli_filter_module.so</code>   和 <code>ngx_http_brotli_static_module.so</code> </p><p>目标文件，我们把他们移动到原 nginx 的 mudule 中。 </p><p>先在 nginx.conf 中看 modules.conf 在哪里：</p><p><code>include /usr/share/nginx/modules/*.conf;</code>  说明所有的 module 配置文件都在这个目录下。</p><p>然后去这个目录，随便 cat 一个配置文件， 会输出：</p><pre class=" language-nginx"><code class="language-nginx">load_module <span class="token string">"/usr/lib64/nginx/modules/ngx_http_brotli_filter_module.so"</span><span class="token punctuation">;</span></code></pre><p>此时能看到，所有 module 的 .so 文件，都在这个地方，我们把这两个 <code>.so</code> 也 cp 这个目录</p><p>当然， 你也可以放入任何你想放的位置，然后在编写 .conf 的时候，指定路径就好了。</p><h4 id="5-5-编写-conf-文件"><a href="#5-5-编写-conf-文件" class="headerlink" title="5.5 编写 .conf 文件"></a>5.5 编写 .conf 文件</h4><p>移动完成后，同样的，我们在 modules 目录下，创建两个文件：</p><p> <code>mod-http-brotli-filter.conf</code>  和 <code>mod-http-brotli-static.conf</code> </p><p>内容分别为：</p><pre class=" language-nginx"><code class="language-nginx">load_module <span class="token string">"/usr/lib64/nginx/modules/ngx_http_brotli_filter_module.so"</span><span class="token punctuation">;</span></code></pre><p>和</p><pre class=" language-nginx"><code class="language-nginx">load_module <span class="token string">"/usr/lib64/nginx/modules/ngx_http_brotli_static_module.so"</span><span class="token punctuation">;</span></code></pre><p>当然，以上所有的路径，都以你实际的目录为准</p><h4 id="5-6-重启和验证"><a href="#5-6-重启和验证" class="headerlink" title="5.6 重启和验证"></a>5.6 重启和验证</h4><p><code>sudo nginx -t</code>  输出 ok 后 <code>sudo systemctl restart nginx</code>  </p><p>这时通过页面访问，能看到 br 即说明 ok</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401081528.png-growing" alt="image-20200401081526690"></p><h3 id="6-blog-conf-配置-启用-http2"><a href="#6-blog-conf-配置-启用-http2" class="headerlink" title="6. blog conf 配置[启用 http2]"></a>6. blog conf 配置[启用 http2]</h3><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">{</span>        <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>        <span class="token keyword">server_name</span>  buzhui<span class="token punctuation">.</span>top<span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span> REMOTE<span class="token operator">-</span>HOST <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token keyword">server</span> <span class="token punctuation">{</span>    <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>    <span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>    <span class="token keyword">server_name</span> buzhui<span class="token punctuation">.</span>top<span class="token punctuation">;</span>    <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> REMOTE<span class="token operator">-</span>HOST <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>        <span class="token keyword">root</span>            <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token operator">/</span>growing<span class="token operator">-</span>blog<span class="token operator">/</span>public<span class="token punctuation">;</span>        <span class="token keyword">index</span>           <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span>favicon<span class="token punctuation">.</span>png <span class="token punctuation">{</span>            <span class="token keyword">expires</span>     30d<span class="token punctuation">;</span>            <span class="token keyword">access_log</span>  off<span class="token punctuation">;</span>            <span class="token keyword">root</span>        <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>            <span class="token keyword">expires</span>     15d<span class="token punctuation">;</span>            <span class="token keyword">access_log</span>  off<span class="token punctuation">;</span>            <span class="token keyword">root</span>        <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token operator">/</span>growing<span class="token operator">-</span>blog<span class="token operator">/</span>public<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true"># js/css 等，我们已经托管到 jsDelivr ，这里就不用再配置了</span>    <span class="token keyword">access_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>growing<span class="token operator">-</span>blog<span class="token operator">/</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>我们在 listen 的时候，如上图配置 http2 即可，无需 <code>ssl on</code>  </p><p>剩下都是常规配置， 没什么好说的， 无非是给一些静态文件添加缓存，这个根据实际情况配置就好。</p><p>我们打开控制台，能看到 <em>Protocol</em>  一栏，都显示为 <em>h2</em> ，说明配置生效</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401082103.png-growing" alt="image-20200401082101525"></p><h3 id="7-限流-Deny"><a href="#7-限流-Deny" class="headerlink" title="7. 限流 + Deny"></a>7. 限流 + Deny</h3><p>在 blog 跑了几天之后，我无事之时，看了眼 nginx 的日志，发现网络世界还是凶险啊。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200408220736.png-growing" alt="access.log"></p><p>针对各式各样乱七八糟的爬虫，还有一些端口扫描工具，我们可以简单的通过 user-agent 来做过滤，比如在你的 server 层(因为包含 if 语句，所以 http 层是放不了的)，加一个 ua-deny.conf 之类的文件</p><pre class=" language-nginx"><code class="language-nginx"><span class="token comment" spellcheck="true">#禁止Scrapy等工具的抓取</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token punctuation">(</span>Scrapy<span class="token operator">|</span>Curl<span class="token operator">|</span>HttpClient<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> <span class="token number">444</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#禁止指定UA及UA为空的访问</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token string">"tbox|Go http|FeedDemon|Indy Library|Alexa Toolbar|AskTbFXTV|AhrefsBot|CrawlDaddy|CoolpadWebkit|Java|Feedly|UniversalFeedParser|ApacheBench|Swiftbot|ZmEu|oBot|jaunty|Python-urllib|lightDeckReports Bot|YYSpider|DigExt|HttpClient|MJ12bot|heritrix|EasouSpider|Gather Analyze Provide|Ezooms|zgrab|^$"</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> <span class="token number">444</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这样就可以根据 ua 进行过滤。</p><p>同时，也可以分析日志，查找异常的 ip， 然后直接 deny 掉。</p><pre class=" language-shell"><code class="language-shell">awk '{print $1}' ./access.log | sort  | uniq -c| sort -n</code></pre><p>把恶意 ip 写入到如 <code>ip_deny</code> 文件中，然后在 http 层，或者 server 层， <code>include ip_deny;</code> ，即可拒绝这些 ip。</p><p>我们还可以限定单个 ip，或者 单个 server 的访问</p><pre class=" language-nginx"><code class="language-nginx"><span class="token comment" spellcheck="true"># 限流</span><span class="token comment" spellcheck="true"># 限制单个 ip 每秒十次访问</span><span class="token comment" spellcheck="true"># 这里以 binary_remote_addr 作为 key，进行单 ip 限流</span><span class="token keyword">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span> zone<span class="token operator">=</span>one<span class="token punctuation">:</span>1m rate<span class="token operator">=</span>2r<span class="token operator">/</span>s<span class="token punctuation">;</span><span class="token keyword">limit_req</span>   zone<span class="token operator">=</span>one        burst<span class="token operator">=</span><span class="token number">3</span> nodelay<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 每秒两次请求，会缓存 3 次，超过的请求即被丢弃</span>limit_req_status    <span class="token number">403</span><span class="token punctuation">;</span><span class="token keyword">limit_conn_zone</span> <span class="token variable">$binary_remote_addr</span> zone<span class="token operator">=</span>addr<span class="token punctuation">:</span>1m<span class="token punctuation">;</span><span class="token keyword">limit_conn</span> addr <span class="token number">3</span><span class="token punctuation">;</span>limit_conn_status   <span class="token number">403</span><span class="token punctuation">;</span></code></pre><p>示例中，对 ip 进行限流，我们同时可以针对 server 进行限流，使用 <code>$host</code> 作为 key 即可。</p><p><code>limit_req</code> 和 <code>limit_conn</code> 分别针对访问次数和访问连接数做限制。上述配置即：</p><p>单 ip 最多有 3 个连接，单 ip 每秒最多允许 2 次请求，超过的次数，会先缓存到 burst 中，会缓存 3 次，若还有请求，则被丢弃，返回 403。</p><h3 id="8-开启-OSCP"><a href="#8-开启-OSCP" class="headerlink" title="8.  开启 OSCP"></a>8.  开启 OSCP</h3><pre class=" language-shell"><code class="language-shell"># TODO 开启 oscpssl_stapling      on;ssl_stapling_verify       on;ssl_trusted_certificate   ospc_file_path</code></pre><p>有兴趣的童鞋可以开启试下， 这里注意下，你要先生成 trusted certificate file ， 这个 file 有过期时间，所以你需要一个 cronjob 来定时更新它，反正我没有开启它。。。</p><h2 id="图床"><a href="#图床" class="headerlink" title="图床"></a>图床</h2><p>使用七牛云作为图床， 七牛云注册后，会送 10G 的免费 OSS，作为一些图片的存放点，十分合适(是的，我就是这样薅羊毛的！)</p><ul><li><a href="https://uploader.buzhui.top" target="_blank" rel="noopener">Uploader 链接</a></li><li><a href="https://gitee.com/iyuhp-growing/growing-backend/tree/develop/qnyun" target="_blank" rel="noopener">Gitee 仓库</a></li></ul><p>实现概览：</p><ol><li>使用 golang 搭建一个简单的 web server，主要负责登录验证和分发七牛云 OSS 的上传 Token</li><li>前端使用 <a href="https://www.dropzonejs.com/" target="_blank" rel="noopener">Dropzone</a> js 组件来实现上传</li><li>使用七牛云的 <a href="https://developer.qiniu.com/kodo/api/1312/upload" target="_blank" rel="noopener">Http Upload</a> 方式上传图片，token 从 web sever 拿，上传不经过 web server</li></ol><p>嗯， 今天突然发现了一个功能完备的上传工具 <a href="https://github.com/Molunerfinn/PicGo" target="_blank" rel="noopener">PicGO</a> ，不过我肯定还是用我自己的这个了，啊哈哈哈</p><h2 id="CICD"><a href="#CICD" class="headerlink" title="CICD"></a>CICD</h2><p>如果不是和我一样，搞了很多乱七八糟的，无论是 github ， 还是 gitee，都提供了基于 hexo 的 cicd，只需要在自己的 _config.yml 中配置下 deploy (可能需要添加一个 .travis.yml)  </p><p>我个人基于 Golang ，自己定制了一个 cicd 流程。</p><p>通过 gitee 的 push hooks event， 拉取最新代码，然后执行 blog 中 build.sh 脚本，脚本主要做了这几件事情</p><ul><li>打印 hexo 版本</li><li>执行 npm i</li><li>执行 gulp default , 进行编译压缩静态文件</li><li>移动文件到指定目录</li></ul><p>执行完后， cicd 会检测是否需要提交到 github，如果需要，会执行 git add git commit git push 一系列命令，执行完毕后，整个流程就结束。</p><p>对于我的 uploader ， cicd 首先会拉取代码，打包镜像，之后会通过 docker ps 查看是否有进程，有的话会杀死，是的，就是这么霸道，完全没有那么一丝丝的平滑，杀死后，会把新的镜像拉起来，整个流程结束。<br>本来准备打算加个通知功能，不过暂时没有时间做。</p><p>还有，十分重要的就是， 所有的操作都在同一个目录，cicd 每一次执行，都会开一个协程，这必然会产生写文件冲突，考虑到只有我一个人用，并不打算改这里。</p><p>改进也很简单，就是每次 cicd 的时候，都产生一个新目录，只拉取最新代码，然后在各自的目录中去做事就好了。完事儿把目录删掉！</p><p>可是考虑到我那 1C1G 50G 的可怜资源，哎，算了，咱不折腾！！！</p><h2 id="写文章"><a href="#写文章" class="headerlink" title="写文章"></a>写文章</h2><p>windows 下，实际体验下来，还是用  <a href="https://www.typora.io/" target="_blank" rel="noopener">Typora</a> + <a href="https://github.com/PicGo" target="_blank" rel="noopener">PicGo</a> 来的舒服</p><p>前面刚说完</p><blockquote><p>不过我肯定是用我自己的这个了</p></blockquote><p>嗯， 真香……</p><p>所以我自己的，就平时用来存存图片啥的好了，反正都撸出来了不是！</p><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><h3 id="1-bing-爬虫"><a href="#1-bing-爬虫" class="headerlink" title="1. bing 爬虫"></a>1. <del>bing 爬虫</del></h3><p>通过爬虫爬取 bing 首页图片，放到 banner 中</p><p>其实 bing 已经给了我们链接，我们稍微解析下就好了，链接在 <a href="https://cn.bing.com/HPImageArchive.aspx?format=js&amp;idx=%d&amp;n=100" target="_blank" rel="noopener">这里</a> </p><p>我取了列表前 5 张图，然后加上我自己的一张，设置权重，然后随机。每次刷新后，就会去后台随机拿一张图的链接。</p><h3 id="2-撸一个简单的-devops"><a href="#2-撸一个简单的-devops" class="headerlink" title="2. 撸一个简单的 devops"></a>2. <del>撸一个简单的 devops</del></h3><p>本地提交代码到 gitee 后， ecs 来去代码打包部署</p><h3 id="3-七牛云图床"><a href="#3-七牛云图床" class="headerlink" title="3. 七牛云图床"></a>3. <del>七牛云图床</del></h3><p>搞一个上传界面，用来存储图片，同时获取图片路径</p><h2 id="ISSUE"><a href="#ISSUE" class="headerlink" title="ISSUE"></a>ISSUE</h2><h3 id="Q1-打开的文章页面，都变成了下载页面…"><a href="#Q1-打开的文章页面，都变成了下载页面…" class="headerlink" title="Q1 打开的文章页面，都变成了下载页面…"></a>Q1 打开的文章页面，都变成了下载页面…</h3><p>A：在 _config.yml 中 permalink ， 一定要注意结尾加上斜杠(/) !!! like this： <code>:title/</code></p><h3 id="Q2-Local-hexo-not-found-in-xxx"><a href="#Q2-Local-hexo-not-found-in-xxx" class="headerlink" title="Q2 Local hexo not found in xxx"></a>Q2 Local hexo not found in xxx</h3><pre><code>ERROR Local hexo not found in xxxERROR Try running: 'npm install hexo --save'</code></pre><p>A： 开玩笑， 明明已经跑了命令 <code>sudo npm install -g hexo-cli</code> ， 你还给我提示这个？</p><p>对我而言， 我是因为新 clone 下来的文件， 还没执行 <code>npm i</code> ， 执行后， 就 ok 了。</p><p>但是搜解决方案的时候，有人说是因为 node_modules 的问题，要删了重新 <code>npm i</code> ，可以一试。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> blog </tag>
            
            <tag> nginx </tag>
            
            <tag> https </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OAUTH2 Protocol</title>
      <link href="/others/oauth/"/>
      <url>/others/oauth/</url>
      
        <content type="html"><![CDATA[<h1 id="oauth2"><a href="#oauth2" class="headerlink" title="oauth2"></a>oauth2</h1><h2 id="oauth2-介绍"><a href="#oauth2-介绍" class="headerlink" title="oauth2 介绍"></a>oauth2 介绍</h2><p><a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener">OATUH 2.0 RFC</a></p><p><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="noopener">OATUH 2.0 科普</a></p><h2 id="oauth2-的四种授权模式"><a href="#oauth2-的四种授权模式" class="headerlink" title="oauth2 的四种授权模式"></a>oauth2 的四种授权模式</h2><h3 id="授权码授权模式-Authorization-Code-Grant"><a href="#授权码授权模式-Authorization-Code-Grant" class="headerlink" title="授权码授权模式(Authorization Code Grant)"></a>授权码授权模式(Authorization Code Grant)</h3><p>参见 <a href="https://tools.ietf.org/html/rfc6749#section-4.1" target="_blank" rel="noopener">RFC Code Grant</a></p><h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401092604.png-growing" alt="code grant flow"></p><p>如图示</p><ul><li>client 为用户</li><li>user-agent 一般指浏览器</li><li>resource owner: 资源拥有者</li><li>Authorization Server: 认证服务器</li></ul><h4 id="步骤解释"><a href="#步骤解释" class="headerlink" title="步骤解释"></a>步骤解释</h4><h5 id="A"><a href="#A" class="headerlink" title="A)"></a>A)</h5><p>客户端通过代理(web browser) 向资源服务器请求资源，user agent 代理到授权服务器。这一步，请求链接一般长这个样子：</p><pre><code>https://xxx.com/oauth/authorize?  response_type=code&amp;  client_id=xxx&amp;  redirect_uri=client_call_uri&amp;  scope=base&amp;  state=xxx</code></pre><ul><li>response_type:  指定授权类型，这里固定为 <code>code</code> (下面会有 password，token, client_credentials)</li><li>client_id: 客户 id， 表明请求人身份</li><li>redirect_uri: 授权后重定向的地址</li><li>scope: 授权范围</li><li>state: 重定向后，会原样返回， 可以用来防止 csrf 攻击</li></ul><h5 id="B"><a href="#B" class="headerlink" title="B)"></a>B)</h5><p>授权服务器要对资源所有者进行身份认证并确认资源所有者是授予还是拒绝该请求。</p><h5 id="C"><a href="#C" class="headerlink" title="C)"></a>C)</h5><p>授权服务器跳转 redirect_uri ， 同时附带一个授权码(code): <code>https://redirect_uri?code=xxx&amp;state=xxx</code></p><h5 id="D"><a href="#D" class="headerlink" title="D)"></a>D)</h5><p>用户根据这个 code ， 请求 token， 这步的链接一般长这个样子：</p><pre><code>https://xxx/oauth/token? grant_type=authorization_code&amp; code=xxx&amp; redirect_uri=xxx&amp; client_id=xxx&amp; client_secret=xxx</code></pre><ul><li><p>grant_type: 授权类型， 这里固定为 <code>authorization_code</code></p></li><li><p>code: 就是你刚刚拿到的 code</p></li><li><p>redirect_uri: 这一步要保证这里的 uri 和之前的 uri 一致</p></li><li><p>client_id &amp; client_secret :  身份验证</p></li></ul><h5 id="E"><a href="#E" class="headerlink" title="E)"></a>E)</h5><p>返回 access token， (或者带上 refresh token)</p><pre class=" language-json"><code class="language-json">HTTP/<span class="token number">1.1</span> <span class="token number">200</span> OKContent-Type<span class="token operator">:</span> application/json<span class="token punctuation">;</span>charset=UTF<span class="token number">-8</span>Cache-Control<span class="token operator">:</span> no-storePragma<span class="token operator">:</span> no-cache<span class="token punctuation">{</span>    <span class="token property">"access_token"</span><span class="token operator">:</span><span class="token string">"2YotnFZFEjr1zCsicMWpAA"</span><span class="token punctuation">,</span>    <span class="token property">"token_type"</span><span class="token operator">:</span><span class="token string">"example"</span><span class="token punctuation">,</span>    <span class="token property">"expires_in"</span><span class="token operator">:</span><span class="token number">3600</span><span class="token punctuation">,</span>    <span class="token property">"refresh_token"</span><span class="token operator">:</span><span class="token string">"tGzv3JOkF0XG5Qx2TlKWIA"</span><span class="token punctuation">,</span>    <span class="token property">"example_parameter"</span><span class="token operator">:</span><span class="token string">"example_value"</span><span class="token punctuation">}</span></code></pre><h3 id="隐藏授权模式-Implicit-Grant"><a href="#隐藏授权模式-Implicit-Grant" class="headerlink" title="隐藏授权模式(Implicit Grant)"></a>隐藏授权模式(Implicit Grant)</h3><p><a href="https://tools.ietf.org/html/rfc6749#section-4.2" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6749#section-4.2</a></p><p>略</p><h3 id="密码授权模式-Resource-Owner-Password-Credentials-Grant"><a href="#密码授权模式-Resource-Owner-Password-Credentials-Grant" class="headerlink" title="密码授权模式(Resource Owner Password Credentials Grant)"></a>密码授权模式(Resource Owner Password Credentials Grant)</h3><p><a href="https://tools.ietf.org/html/rfc6749#section-4.3" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6749#section-4.3</a></p><p>略</p><h3 id="客户端凭证授权模式-Client-Credentials-Grant"><a href="#客户端凭证授权模式-Client-Credentials-Grant" class="headerlink" title="客户端凭证授权模式(Client Credentials Grant)"></a>客户端凭证授权模式(Client Credentials Grant)</h3><p><a href="https://tools.ietf.org/html/rfc6749#section-4.4" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6749#section-4.4</a></p><p>略</p><h2 id="微信示例"><a href="#微信示例" class="headerlink" title="微信示例"></a>微信示例</h2><p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html#0" target="_blank" rel="noopener">微信 OAUTH 2.0 对接文档</a></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401093011.png-growing" alt="wechat oauth2 flow"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> protocol </tag>
            
            <tag> network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 基础环境搭建安装指北</title>
      <link href="/linux/install/"/>
      <url>/linux/install/</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-基础环境安装指北"><a href="#Linux-基础环境安装指北" class="headerlink" title="Linux 基础环境安装指北"></a>Linux 基础环境安装指北</h1><p><a href="https://developer.aliyun.com/mirror/" target="_blank" rel="noopener">阿里巴巴开源站点</a>  </p><p>个人安装环境为 <code>CentOS Linux release 7.6.1810 (Core)</code> </p><h2 id="zsh-amp-oh-my-zsh"><a href="#zsh-amp-oh-my-zsh" class="headerlink" title="zsh &amp; oh my zsh"></a>zsh &amp; oh my zsh</h2><ul><li><a href="https://github.com/robbyrussell/oh-my-zsh/wiki/Installing-ZSH" target="_blank" rel="noopener">zsh 安装</a> </li></ul><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum -y update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> yum -y <span class="token function">install</span> zsh</code></pre><ul><li><a href="https://github.com/robbyrussell/oh-my-zsh" target="_blank" rel="noopener">oh my zsh 安装</a></li></ul><pre class=" language-bash"><code class="language-bash">sh -c <span class="token string">"<span class="token variable"><span class="token variable">$(</span>curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh<span class="token variable">)</span></span>"</span></code></pre><ul><li><a href="https://github.com/powerline/fonts" target="_blank" rel="noopener">powerline 安装</a></li></ul><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># install git if not exist</span><span class="token function">sudo</span> yum <span class="token function">install</span> -y <span class="token function">git</span><span class="token function">git</span> clone https://github.com/powerline/fonts.git --depth<span class="token operator">=</span>1<span class="token function">cd</span> fonts./install.sh<span class="token function">cd</span> <span class="token punctuation">..</span><span class="token function">rm</span> -fr fonts</code></pre><h2 id="add-user"><a href="#add-user" class="headerlink" title="add user"></a>add user</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 添加用户</span>adduser dylan<span class="token comment" spellcheck="true"># 添加密码</span><span class="token function">passwd</span> dylan<span class="token comment" spellcheck="true"># sudo 命令添加</span><span class="token comment" spellcheck="true"># sudoers 文件查找</span><span class="token function">whereis</span> sudoers<span class="token comment" spellcheck="true">#添加时， 要注意 sudoers 文件是只读的， 先修改为可写，修改完成后再变为可读</span><span class="token function">chmod</span> -v u+w /etc/sudoers<span class="token function">chmod</span> -v u-w /etc/sudoers<span class="token comment" spellcheck="true"># 查看组</span><span class="token function">sudo</span> <span class="token function">cat</span> /etc/group <span class="token operator">|</span> <span class="token function">grep</span> wheel<span class="token comment" spellcheck="true"># 添加一个新组 group-test</span><span class="token function">sudo</span> <span class="token function">groupadd</span> group-test <span class="token comment" spellcheck="true"># 将登陆用户加入到 wheel 用户组中， -a : append</span><span class="token function">sudo</span> gpasswd -a <span class="token variable">$USER</span> wheel  <span class="token comment" spellcheck="true"># 更新 wheel 组</span>newgrp wheel  </code></pre><p>这里不建议直接将用于赋予 root 权限，一般的做法是放开 wheel 组，将用户添加到 wheel 组，通过 <code>visudo</code>  命令打开 /etc/sudoers , 将</p><blockquote><p>#Allows people in group wheel to run all commands</p><p>#%wheel  ALL=(ALL)       ALL</p></blockquote><p>中 %wheel 前的 # 去掉， 然后将用户添加到 wheel 组。</p><h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><ol><li>开/重启/开机自启动</li></ol><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start iptables<span class="token function">sudo</span> systemctl restart iptables<span class="token function">sudo</span> systemctl <span class="token function">enable</span> iptables</code></pre><ol start="2"><li>编辑 iptables 文件</li></ol><p>在 <strong><code>/etc/sysconfig/iptables</code></strong>  文件中添加规则</p><h2 id="配置免密登录"><a href="#配置免密登录" class="headerlink" title="配置免密登录"></a>配置免密登录</h2><h3 id="1-生成-ssh-秘钥"><a href="#1-生成-ssh-秘钥" class="headerlink" title="1. 生成 ssh 秘钥"></a>1. 生成 ssh 秘钥</h3><p>参考 <a href="https://www.cnblogs.com/yanglang/p/9563496.html" target="_blank" rel="noopener">这里</a></p><pre class=" language-bash"><code class="language-bash">ssh-keygen -t rsa -C <span class="token string">"peifeng"</span> -f filepath</code></pre><ul><li>-t 指定密钥类型，默认是 rsa ，可以省略。</li><li>-C 设置注释文字，比如邮箱。</li><li>-f 指定密钥文件存储文件名。默认为 ~.ssh/ 目录<h3 id="2-配置免密登录"><a href="#2-配置免密登录" class="headerlink" title="2. 配置免密登录"></a>2. 配置免密登录</h3></li></ul><p>A 机器免密登录到 B 机器， 默认都已生成 ssh 秘钥。</p><ol><li>登录 A 机器，运行命令 ssh-copy-id 发送本地 id_rsa.pub 到 B 机器的 ~/.ssh/authorized_keys 文件中<pre class=" language-bash"><code class="language-bash">ssh-copy-id dylan@B_ip</code></pre></li></ol><ol start="2"><li>配置 A 机器的 ~/.ssh/config 文件(如果没有， 请自己添加， 注意该文件的权限至少为 600 )。 参考 <a href="https://www.cnblogs.com/lingyejun/p/7367596.html" target="_blank" rel="noopener">这里</a><pre><code>Host A_alias HostName B_machine_ip User dylan Port 22 IdentityFile ~/.ssh/id_rsa ServerAliveInterval 120 # 每隔 120 秒发送一个空包到服务端， 以保持长连接</code></pre></li></ol><ul><li>Host 别名， 登录时， 直接通过该别名登录</li><li>HostName： 主机名或主机 ip</li><li>User： 登录的用户名</li><li>Port： 端口</li><li>IdentityFile： 秘钥文件路径</li></ul><ol start="3"><li>登录</li></ol><pre class=" language-bash"><code class="language-bash"><span class="token function">ssh</span> A_alias</code></pre><h2 id="docker-install"><a href="#docker-install" class="headerlink" title="docker install"></a>docker install</h2><p>参考 </p><ul><li><p><a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/centos/</a> </p></li><li><p>stable 列表： <a href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/" target="_blank" rel="noopener">https://download.docker.com/linux/centos/7/x86_64/stable/Packages/</a></p></li><li><p>阿里云 stable 列表： <a href="https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/" target="_blank" rel="noopener">https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/</a></p></li></ul><h3 id="1-通过-docker-源-安装"><a href="#1-通过-docker-源-安装" class="headerlink" title="1. 通过 docker 源 安装"></a>1. 通过 docker 源 安装</h3><h4 id="1-1-移除老版本，-如果是第一次安装，-可以忽略"><a href="#1-1-移除老版本，-如果是第一次安装，-可以忽略" class="headerlink" title="1.1 移除老版本， 如果是第一次安装， 可以忽略"></a>1.1 移除老版本， 如果是第一次安装， 可以忽略</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum remove docker \                  docker-client \                  docker-client-latest \                  docker-common \                  docker-latest \                  docker-latest-logrotate \                  docker-logrotate \                  docker-engine</code></pre><h4 id="1-2-安装必要的工具"><a href="#1-2-安装必要的工具" class="headerlink" title="1.2 安装必要的工具"></a>1.2 安装必要的工具</h4><p><code>yum-utils</code> provides the <code>yum-config-manager</code> utility, and <code>device-mapper-persistent-data</code> and <code>lvm2</code>are required by the <code>devicemapper</code> storage driver.</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> -y yum-utils \  device-mapper-persistent-data \  lvm2</code></pre><h4 id="1-3-设置可用的-docker-ce-repository"><a href="#1-3-设置可用的-docker-ce-repository" class="headerlink" title="1.3 设置可用的 docker-ce repository"></a>1.3 设置可用的 docker-ce repository</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum-config-manager \    --add-repo \    https://download.docker.com/linux/centos/docker-ce.repo <span class="token comment" spellcheck="true">## 这里可以使用阿里云的 docker repo</span> <span class="token function">sudo</span> yum-config-manager \ --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<span class="token function">sudo</span> yum makecache fast</code></pre><h4 id="1-4-安装最新版-docker-ce，-containerd"><a href="#1-4-安装最新版-docker-ce，-containerd" class="headerlink" title="1.4 安装最新版 docker-ce， containerd"></a>1.4 安装最新版 docker-ce， containerd</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum -y <span class="token function">install</span> docker-ce docker-ce-cli containerd.io<span class="token comment" spellcheck="true">## 可以指定版本安装</span><span class="token function">sudo</span> yum -y <span class="token function">install</span> docker-ce-19.03.0 docker-ce-cli-19.03.0 containerd.io<span class="token comment" spellcheck="true">## 安装过程中可能会出现 containerd.io > xxx 的提示， 可以先安装 containerd</span><span class="token comment" spellcheck="true">## https://download.docker.com/linux/centos/7/x86_64/stable/Packages/</span><span class="token comment" spellcheck="true">## 到官网查找版本后执行如下命令 (centos8)</span><span class="token function">sudo</span> dnf <span class="token function">install</span> https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm<span class="token comment" spellcheck="true">## 再安装 docker-ce 和 docker-ce-cli</span><span class="token function">sudo</span> yum -y <span class="token function">install</span> docker-ce docker-ce-cli</code></pre><h4 id="1-5-开启-docker"><a href="#1-5-开启-docker" class="headerlink" title="1.5 开启 docker"></a>1.5 开启 docker</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start docker</code></pre><h4 id="1-6-验证是否成功"><a href="#1-6-验证是否成功" class="headerlink" title="1.6 验证是否成功"></a>1.6 验证是否成功</h4><pre class=" language-bash"><code class="language-bash">docker run hello-world</code></pre><h4 id="1-7-使用阿里云镜像加速器"><a href="#1-7-使用阿里云镜像加速器" class="headerlink" title="1.7 使用阿里云镜像加速器"></a>1.7 使用阿里云镜像加速器</h4><p><a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors" target="_blank" rel="noopener">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1. 创建目录， 如果存在请忽略</span><span class="token function">sudo</span> <span class="token function">mkdir</span> -p /etc/docker<span class="token comment" spellcheck="true"># 2. 写入阿里云 registry</span><span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span>-<span class="token string">'EOF'</span><span class="token punctuation">{</span>  <span class="token string">"registry-mirrors"</span><span class="token keyword">:</span> <span class="token punctuation">[</span><span class="token string">"你的加速地址"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>EOF<span class="token comment" spellcheck="true"># 3. 重启</span><span class="token function">sudo</span> systemctl daemon-reload<span class="token function">sudo</span> systemctl restart docker</code></pre><h4 id="1-8-免-sudo-使用-docker"><a href="#1-8-免-sudo-使用-docker" class="headerlink" title="1.8 免 sudo 使用 docker"></a>1.8 免 sudo 使用 docker</h4><p>当我们运行如 <code>docker info</code> 时， 会报如下错误(非 root 用户)</p><pre><code>Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.39/info: dial unix /var/run/docker.sock: connect: permission denied</code></pre><p>原因：</p><blockquote><p>Manage Docker as a non-root user</p><p>The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. The docker daemon always runs as the root user.</p><p>If you don’t want to use sudo when you use the docker command, create a Unix group called docker and add users to it. When the docker daemon starts, it makes the ownership of the Unix socket read/writable by the docker group.</p></blockquote><p>大意为： docker 进程使用 Unix Socket 而不是 TCP 端口。而默认情况下，Unix socket 属于 root 用户，需要 root 权限才能访问。</p><blockquote><p><strong>docker 守护进程启动的时候，会默认赋予名字为 docker 的用户组读写 Unix socket 的权限，因此只要创建 docker 用户组，并将当前用户加入到 docker 用户组中，那么当前用户就有权限访问 Unix socket 了，进而也就可以执行 docker 相关命令</strong></p></blockquote><p>解决办法</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查看 docker 用户组是否已存在</span><span class="token function">sudo</span> <span class="token function">cat</span> /etc/group <span class="token operator">|</span> <span class="token function">grep</span> docker <span class="token comment" spellcheck="true"># 添加docker用户组， 如果 docker 用户组已存在， 则不需执行</span><span class="token function">sudo</span> <span class="token function">groupadd</span> docker <span class="token comment" spellcheck="true"># 将登陆用户加入到 docker 用户组中， -a : append</span><span class="token function">sudo</span> gpasswd -a <span class="token variable">$USER</span> docker  <span class="token comment" spellcheck="true"># 更新用户组</span>newgrp docker  <span class="token comment" spellcheck="true"># 测试 docker 命令是否可以在无 sudo 时正常使用</span>docker info  </code></pre><h3 id="2-通过安装包安装"><a href="#2-通过安装包安装" class="headerlink" title="2. 通过安装包安装"></a>2. 通过安装包安装</h3><ol><li>通过 <a href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/" target="_blank" rel="noopener">https://download.docker.com/linux/centos/7/x86_64/stable/Packages/</a> 获取你需要的版本的 <code>.rpm</code> 安装包文件</li><li>安装</li></ol><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> /path/to/package.rpm</code></pre><ol start="3"><li>运行 docker</li></ol><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start docker</code></pre><ol start="4"><li>验证</li></ol><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> docker run hello-world</code></pre><h3 id="3-通过安装脚本安装"><a href="#3-通过安装脚本安装" class="headerlink" title="3. 通过安装脚本安装"></a>3. 通过安装脚本安装</h3><pre class=" language-bash"><code class="language-bash">curl -fsSL https://get.docker.com -o get-docker.sh<span class="token function">sudo</span> sh get-docker.sh</code></pre><h2 id="docker-uninstall-upgrade"><a href="#docker-uninstall-upgrade" class="headerlink" title="docker uninstall/upgrade"></a>docker uninstall/upgrade</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 卸载 docker</span><span class="token function">sudo</span> yum remove docker-ce<span class="token comment" spellcheck="true"># 删除 images/volumes/containers 等</span><span class="token function">sudo</span> <span class="token function">rm</span> -rf /var/lib/docker</code></pre><p>上面是官方文档的说法， 实际操作中，可能会出现 client 和 server 版本不一致的问题，可以先都删除掉</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查找已安装的 docker 相关软件包</span>rpm -qa <span class="token operator">|</span> <span class="token function">grep</span> docker<span class="token comment" spellcheck="true"># 卸载列出的软件包</span> <span class="token function">sudo</span> yum remove docker-ce-cli-19.03.0-3.el7.x86_64 docker-ce-19.03.0-3.el7.x86_64 <span class="token comment" spellcheck="true"># 之后安装需要的版本即可</span> <span class="token function">sudo</span> yum -y <span class="token function">install</span> docker-ce-18.09.8 docker-ce-cli-18.09.8 containerd.io <span class="token comment" spellcheck="true"># 安装完成后， 启动 docker</span> <span class="token function">sudo</span> systemctl start docker <span class="token comment" spellcheck="true"># 启动所有容器</span> docker restart <span class="token variable"><span class="token variable">$(</span>docker <span class="token function">ps</span> -aq<span class="token variable">)</span></span> <span class="token comment" spellcheck="true"># 检查容器状态！</span> <span class="token function">sudo</span> systemctl status docker</code></pre><h3 id="附：-docker-clean"><a href="#附：-docker-clean" class="headerlink" title="附： docker clean"></a>附： docker clean</h3><pre class=" language-shell"><code class="language-shell"># 类似 linux 的 df, docker 会展示 docker 的磁盘使用情况docker system df# docker 的默认存盘目录一般在 /var/lib/docker 下， 可以进去看具体情况# 该命令可以用来清理磁盘，删除关闭的容器，无用的 volume 和 network# 包括 dangling(无 tag) 镜像 以及 cache# 该命令还可以加 -a ，会把所有没有 container 关联的 image 都删掉，千万慎用！！！docker system prune</code></pre><h2 id="v2ray-amp-ss（vultr）"><a href="#v2ray-amp-ss（vultr）" class="headerlink" title="v2ray &amp; ss（vultr）"></a>v2ray &amp; ss（vultr）</h2><p>使用 vultr ecs 时，一般用来搭建自己的梯子，现在比较常用的有 v2ray &amp; ss 。</p><ul><li><a href="https://raw.githubusercontent.com/233boy/v2ray/master/install.sh" target="_blank" rel="noopener">https://raw.githubusercontent.com/233boy/v2ray/master/install.sh</a></li></ul><p>可参考 github 上各类一键安装脚本。</p><h2 id="NGINX"><a href="#NGINX" class="headerlink" title="NGINX"></a>NGINX</h2><p>nginx 不在默认的 yum 源中，所以第一步加入</p><h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><pre class=" language-shell"><code class="language-shell">sudo rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm# 查看sudo yum repolist | grep nginxsudo yum -y install nginx##### 如果是 centos 8，  可以直接安装！！！sudo yum install nginx</code></pre><h3 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h3><p>设置开机自启动、启动 nginx</p><pre class=" language-shell"><code class="language-shell"># 开机自启动sudo systemctl enable nginx# 启动服务sudo systemctl start nginx# 重启服务sudo systemctl reload nginx# 停止服务sudo systemctl stop nginx</code></pre><h2 id="PostgreSQL-12"><a href="#PostgreSQL-12" class="headerlink" title="PostgreSQL 12"></a>PostgreSQL 12</h2><p><a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="noopener">https://www.postgresql.org/download/linux/redhat/</a></p><h3 id="1-安装-pg12-rpm"><a href="#1-安装-pg12-rpm" class="headerlink" title="1. 安装 pg12 rpm"></a>1. 安装 pg12 rpm</h3><p>这里需要注意的是，需要根据具体的版本来确定 rpm 源</p><p>我安装时，ceotos 版本是 7-x86_64 的</p><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</code></pre><h3 id="2-安装客户端和服务端"><a href="#2-安装客户端和服务端" class="headerlink" title="2. 安装客户端和服务端"></a>2. 安装客户端和服务端</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># client</span>yum <span class="token function">install</span> postgresql12<span class="token comment" spellcheck="true"># 服务端</span>yum <span class="token function">install</span> postgresql12-server</code></pre><h3 id="配置开机自启动等操作-Optional"><a href="#配置开机自启动等操作-Optional" class="headerlink" title="配置开机自启动等操作(Optional)"></a>配置开机自启动等操作(Optional)</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 初始化 pgdb</span>/usr/pgsql-12/bin/postgresql-12-setup initdb<span class="token comment" spellcheck="true"># 设置开机自启动</span>systemctl <span class="token function">enable</span> postgresql-12<span class="token comment" spellcheck="true"># 开启 pgdb</span>systemctl start postgresql-12</code></pre><h3 id="初始账号密码及修改"><a href="#初始账号密码及修改" class="headerlink" title="初始账号密码及修改"></a>初始账号密码及修改</h3><p>postgres/postgres</p><p>修改配置前会遇到的问题及解答</p><ul><li><a href="https://serverfault.com/questions/406606/postgres-error-message-fatal-ident-authentication-failed-for-user" target="_blank" rel="noopener">https://serverfault.com/questions/406606/postgres-error-message-fatal-ident-authentication-failed-for-user</a></li><li><a href="https://stackoverflow.com/questions/2942485/psql-fatal-ident-authentication-failed-for-user-postgres" target="_blank" rel="noopener">https://stackoverflow.com/questions/2942485/psql-fatal-ident-authentication-failed-for-user-postgres</a></li></ul><p>可以通过修改配置完成：</p><p>vim /var/lib/pgsql/12/data/pg_hba.conf</p><pre><code># TYPE  DATABASE        USER            ADDRESS                 METHOD# "local" is for Unix domain socket connections onlylocal   all             all                                     peer# IPv4 local connections:# old line -- dylan#host    all             all             127.0.0.1/32            ident# new line -- dylanhost    all             all             127.0.0.1/32            trusthost    all             all             all                     md5# IPv6 local connections:# old line -- dylan# host    all             all             ::1/128                 ident# Allow replication connections from localhost, by a user with the# replication privilege.# old lines -- dylan#local   replication     all                                     peer#host    replication     all             127.0.0.1/32            ident#host    replication     all             ::1/128                 ident# new lines -- dylanhost    replication     all             127.0.0.1/32            trusthost    replication     all             all                     md5</code></pre><p>vim /var/lib/pgsql/12/data/postgresql.conf</p><pre><code># - Connection Settings -# -- new line start -- dylanlisten_addresses = '*'# -- new line end -- dylan#listen_addresses = 'localhost'         # what IP address(es) to listen on;</code></pre><h3 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h3><p>通过安装 pgAdmin4 连接</p><h2 id="Java-Install"><a href="#Java-Install" class="headerlink" title="Java Install"></a>Java Install</h2><h3 id="Java-8"><a href="#Java-8" class="headerlink" title="Java 8"></a>Java 8</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 安装后 java &amp; javac 都能正常使用</span><span class="token function">sudo</span> yum <span class="token function">install</span> -y java-1.8.0-openjdk-devel.x86_64<span class="token comment" spellcheck="true"># 安装后只有 java 能正常使用， javac 无用</span><span class="token function">sudo</span> yum <span class="token function">install</span> -y java-1.8.0-openjdk.x86_64</code></pre><h3 id="Java-11"><a href="#Java-11" class="headerlink" title="Java 11"></a>Java 11</h3><p>系统为 centOS 8， 其他系统未验证(如果失败，可以通过源码安装，配置环境变量)</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> dnf <span class="token function">install</span> java-11-openjdk-devel</code></pre><h2 id="Redis-安装"><a href="#Redis-安装" class="headerlink" title="Redis 安装"></a>Redis 安装</h2><p>在 centOS 8 下， 可直接使用：</p><pre class=" language-shell"><code class="language-shell">sudo dnf install redis</code></pre><p>当然，我们可以选择源码安装，我这里使用 <code>5.0.8</code> 版本</p><pre class=" language-shell"><code class="language-shell">git clone https://github.com/antirez/redis.git --branch 5.0.8</code></pre><p>下载完成后，进入目录，执行 <code>make &amp;&amp; make test</code> </p><p>之后可能会遇到</p><blockquote><p>You need tcl 8.5 or newer in order to run the Redis test</p></blockquote><p>我们可以去 centos 官网，下载需要的依赖</p><pre class=" language-shell"><code class="language-shell">sudo dnf install http://mirror.centos.org/centos-8/8.1.1911/BaseOS/x86_64/os/Packages/tcl-8.6.8-2.el8.x86_64.rpm</code></pre><p>安装完成后再跑一次 <code>make test</code> ，ok ，完美</p><h2 id="Golang-Install"><a href="#Golang-Install" class="headerlink" title="Golang Install"></a>Golang Install</h2><h3 id="Golang-官方安装文档"><a href="#Golang-官方安装文档" class="headerlink" title="Golang 官方安装文档"></a><a href="https://golang.google.cn/doc/install?download=go1.13.9.linux-amd64.tar.gz" target="_blank" rel="noopener">Golang 官方安装文档</a></h3><p>如果有老版本，参考  <a href="https://golang.google.cn/doc/install?download=go1.13.9.linux-amd64.tar.gz#uninstall" target="_blank" rel="noopener">remove old golang</a> 先删除掉</p><h3 id="Glang-1-13-Install"><a href="#Glang-1-13-Install" class="headerlink" title="Glang 1.13 Install"></a>Glang 1.13 Install</h3><pre class=" language-shell"><code class="language-shell"># 1. 下载curl -O https://dl.google.com/go/go1.13.9.linux-amd64.tar.gz# 解压sudo tar -C /usr/local go1.13.9.linux-amd64.tar.gz# path## 1. 在 .bash_profile 中最后位置添加  export PATH=$PATH:/usr/local/go/bin (针对当前用户)## 2. 保存后执行 source ~/.bash_profile## 3. 如果使用的是 zsh ， 需要在 ~/.zshrc 中配置  source ~/.bash_profile## 或者直接在 /etc/profile 中配置， 在最末尾的位置追加 export PATH=$PATH:/usr/local/go/bin 即可(针对所有用户)</code></pre><h3 id="Golang-1-12-Install"><a href="#Golang-1-12-Install" class="headerlink" title="Golang 1.12 Install"></a>Golang 1.12 Install</h3><p>如果你只想安装 1.12 (目前 yum 源还没有 1.13)，可以直接通过 yum 安装</p><p><code>sudo yum -y install golang</code></p><h2 id="VIM"><a href="#VIM" class="headerlink" title="VIM"></a>VIM</h2><p>用 vim 有一两年的历史，虽然现在只会一些常用的命令，各种骚操作基本不会，但在 Terminal 端操作时，还是能带来不少的便利。</p><p>常用的 vim plugin 管理工具，有 vundle 和 vim-plug</p><h3 id="0-卸载你的-vim-管理工具"><a href="#0-卸载你的-vim-管理工具" class="headerlink" title="0. 卸载你的 vim 管理工具"></a>0. 卸载你的 vim 管理工具</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">rm</span> -rf ~/.vim<span class="token comment" spellcheck="true"># 在此之前， 你可能需要先备份你的 .vimrc 文件,如 cp .vimrm vimrm</span><span class="token function">rm</span> .vimrc</code></pre><h3 id="1-通过-vundle-管理-vim-plugin"><a href="#1-通过-vundle-管理-vim-plugin" class="headerlink" title="1. 通过 vundle 管理 vim plugin"></a>1. 通过 vundle 管理 vim plugin</h3><ul><li>通过 <a href="https://github.com/VundleVim/Vundle.vim" target="_blank" rel="noopener">Vundle GitHub</a> 中的步骤安装</li><li>如果没有 <code>.vimrc</code> ，直接创建即可。</li><li>在 <code>call vundle#begin()</code> 和 <code>call vundle#end()</code> 之间添加你需要的 vim plugin</li><li>在最后添加各种插件的配置</li><li>一个示例： <a href="https://gitee.com/dylan0011/codes/uoe5cm1s2j4nxkvtydh9814" target="_blank" rel="noopener">vundle example</a></li></ul><h3 id="2-通过-vim-plug-管理-vim-plugin"><a href="#2-通过-vim-plug-管理-vim-plugin" class="headerlink" title="2. 通过 vim-plug 管理 vim plugin"></a>2. 通过 vim-plug 管理 vim plugin</h3><p>可参考文章 <a href="https://vimjc.com/vim-plug.html" target="_blank" rel="noopener">vim-plug</a></p><ul><li><p>通过 <a href="https://github.com/junegunn/vim-plug" target="_blank" rel="noopener">Vim-plug Github</a> 中的步骤安装</p></li><li><p>一个示例： <a href="https://gitee.com/dylan0011/codes/2owi5379ep6zymrcsj08q46" target="_blank" rel="noopener">vim-plug example</a></p></li></ul><h3 id="4-vim-设置快捷键时候的坑"><a href="#4-vim-设置快捷键时候的坑" class="headerlink" title="4. vim 设置快捷键时候的坑"></a>4. vim 设置快捷键时候的坑</h3><h4 id="1-设置快捷键的时候，-比如设置为-A-m-即-Alt-m-键，可一直不起作用！！！遂放弃-Alt-。"><a href="#1-设置快捷键的时候，-比如设置为-A-m-即-Alt-m-键，可一直不起作用！！！遂放弃-Alt-。" class="headerlink" title="1. 设置快捷键的时候， 比如设置为 A-m , 即 Alt + m 键，可一直不起作用！！！遂放弃 Alt 。"></a>1. 设置快捷键的时候， 比如设置为 <em>A-m</em> , 即 Alt + m 键，可一直不起作用！！！遂放弃 Alt 。</h4><p><a href="https://vi.stackexchange.com/questions/2350/how-to-map-alt-key" target="_blank" rel="noopener">这里</a> 告诉你为什么</p><p>各种 Shift/Ctrl/Alt 对应如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401100954.png-growing" alt="vim keymap"></p><h4 id="2-YCM-需要-cmake"><a href="#2-YCM-需要-cmake" class="headerlink" title="2. YCM 需要 cmake"></a>2. YCM 需要 cmake</h4><p><a href="https://github.com/ycm-core/YouCompleteMe#installation" target="_blank" rel="noopener">YCM 官方安装指南</a></p><p><a href="https://linux4one.com/how-to-install-cmake-on-centos-8/" target="_blank" rel="noopener">cmake 安装指南</a></p><p>我是 centos 8， 通过 <code>yum info cmake</code> 看到 cmake 版本是 3.11.4 ， 所以直接通过 yum 安装了。 同时要保证已经安装了 gcc ( <code>sudo dnfinstall -y gcc-c++</code> )</p><h4 id="3-tagbar"><a href="#3-tagbar" class="headerlink" title="3. tagbar"></a>3. tagbar</h4><p>安装之前，要先安装 ctags： <code>sudo yum install -y ctags</code> </p><h2 id="gradle-install"><a href="#gradle-install" class="headerlink" title="gradle install"></a>gradle install</h2><ul><li><a href="https://linuxize.com/post/how-to-install-gradle-on-centos-8/" target="_blank" rel="noopener">官方文档</a></li></ul><h3 id="1-下载二进制文件"><a href="#1-下载二进制文件" class="headerlink" title="1. 下载二进制文件"></a>1. 下载二进制文件</h3><blockquote><p>wget <a href="https://downloads.gradle-dn.com/distributions/gradle-7.0-bin.zip" target="_blank" rel="noopener">https://downloads.gradle-dn.com/distributions/gradle-7.0-bin.zip</a></p></blockquote><h3 id="2-解压到指定文件"><a href="#2-解压到指定文件" class="headerlink" title="2. 解压到指定文件"></a>2. 解压到指定文件</h3><blockquote><p>unzip -d /opt/gradle ./gradle-7.0-bin.zip</p></blockquote><h3 id="3-设置环境变量"><a href="#3-设置环境变量" class="headerlink" title="3. 设置环境变量"></a>3. 设置环境变量</h3><blockquote><p>vim /etc/profile.d/gradle.sh</p><p>将如下内容写入：</p><pre class=" language-sh"><code class="language-sh">export GRADLE_HOME=/opt/gradle/gradle-6.3export PATH=${GRADLE_HOME}/bin:${PATH}</code></pre><p>修改文件执行权限： chmod +x /etc/profile.d/gradle.sh</p><p>reload： source /etc/profile.d/gradle.sh</p></blockquote><h3 id="4-查看版本"><a href="#4-查看版本" class="headerlink" title="4. 查看版本"></a>4. 查看版本</h3><blockquote><p>gradle -v</p></blockquote><h2 id="maven-install"><a href="#maven-install" class="headerlink" title="maven install"></a>maven install</h2><h3 id="3-5-版本"><a href="#3-5-版本" class="headerlink" title="3.5 版本"></a>3.5 版本</h3><p>在 centos8 下， 3.5 版本可通过 <code>dnf install -y maven</code> 直接安装</p><h3 id="latest-版本"><a href="#latest-版本" class="headerlink" title="latest 版本"></a>latest 版本</h3><h4 id="1-从-maven-获取需要的版本"><a href="#1-从-maven-获取需要的版本" class="headerlink" title="1. 从 maven 获取需要的版本"></a>1. 从 <a href="https://maven.apache.org/download.cgi" target="_blank" rel="noopener">maven</a> 获取需要的版本</h4><h4 id="2-下载"><a href="#2-下载" class="headerlink" title="2.下载"></a>2.下载</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> https://www-us.apache.org/dist/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz -P /tmp</code></pre><h4 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">tar</span> -xvf ./apache-maven-3.6.3-bin.tar.gz -C /opt/maven</code></pre><h4 id="设置环境变量"><a href="#设置环境变量" class="headerlink" title="设置环境变量"></a>设置环境变量</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">tee</span> /etc/profile.d/maven.sh <span class="token operator">&lt;&lt;</span>-<span class="token string">'EOF'</span><span class="token function">export</span> M2_HOME<span class="token operator">=</span>/opt/maven/apache-maven-3.6.3<span class="token function">export</span> MAVEN_HOME<span class="token operator">=</span>/opt/maven/apache-maven-3.6.3<span class="token function">export</span> PATH<span class="token operator">=</span><span class="token variable">${M2_HOME}</span>/bin:<span class="token variable">${PATH}</span>EOF<span class="token function">chmod</span> +x /etc/profile.d/maven.sh <span class="token function">source</span> /etc/profile.d/maven.sh</code></pre><h4 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h4><pre class=" language-bash"><code class="language-bash">maven -v</code></pre><h2 id="小脚本"><a href="#小脚本" class="headerlink" title="小脚本"></a>小脚本</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#!/usr/bin/env bash</span><span class="token keyword">set</span> -eo pipefailcommand<span class="token operator">=</span><span class="token variable">$1</span>param1<span class="token operator">=</span><span class="token variable">$2</span><span class="token keyword">function</span> git_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    yum -y update \     <span class="token operator">&amp;&amp;</span> yum -y <span class="token function">install</span> <span class="token function">git</span><span class="token punctuation">}</span><span class="token keyword">function</span> zsh_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    git_install    yum -y <span class="token function">install</span> zsh<span class="token punctuation">}</span><span class="token keyword">function</span> oh_my_zsh_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    zsh_install   sh -c <span class="token string">"<span class="token variable"><span class="token variable">$(</span>curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh<span class="token variable">)</span></span>"</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true"># install powerline if necessary</span><span class="token keyword">function</span> powerline_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token function">git</span> clone https://github.com/powerline/fonts.git --depth<span class="token operator">=</span>1 \   <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> fonts \   <span class="token operator">&amp;&amp;</span> ./install.sh \   <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> <span class="token punctuation">..</span> \   <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -fr ./fonts<span class="token punctuation">}</span><span class="token comment" spellcheck="true"># add user</span><span class="token keyword">function</span> add_user<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token variable">${param1}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>       param1<span class="token operator">=</span><span class="token string">"dylan"</span>    <span class="token keyword">fi</span>    adduser <span class="token variable">${param1}</span>    <span class="token function">passwd</span> <span class="token variable">${param1}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">## generate ssh</span><span class="token keyword">function</span> generate_ssh<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ssh-keygen -t rsa -C <span class="token string">"peifeng"</span>    <span class="token function">touch</span> <span class="token variable">$HOME</span>/.ssh/config<span class="token punctuation">}</span><span class="token keyword">function</span> docker_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>yum remove -y docker docker-common docker-selinux docker-engine \<span class="token operator">&amp;&amp;</span> yum <span class="token function">install</span> -y yum-utils device-mapper-persistent-data lvm2 \<span class="token operator">&amp;&amp;</span> yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo \<span class="token operator">&amp;&amp;</span> yum makecache fast \<span class="token operator">&amp;&amp;</span> yum -y <span class="token function">install</span> docker-ce<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token variable">${param1}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    param1<span class="token operator">=</span><span class="token string">"https://docker.mirrors.ustc.edu.cn"</span><span class="token keyword">fi</span><span class="token function">cat</span> <span class="token operator">></span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF{  "registry-mirrors": ["<span class="token variable">${param1}</span>"]  "exec-opts": ["native.cgroupdriver=systemd"],  "log-driver": "json-file",  "log-opts": {    "max-size": "100m"  },  "storage-driver": "overlay2",  "storage-opts": [    "overlay2.override_kernel_check=true"  ]}EOF</span>systemctl start dockersystemctl <span class="token function">enable</span> docker<span class="token punctuation">}</span><span class="token keyword">function</span> add_user_to_docker_group<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    gpasswd -a <span class="token variable">${USER}</span> docker    newgrp docker<span class="token punctuation">}</span><span class="token keyword">function</span> java_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   yum <span class="token function">install</span> -y java-1.8.0-openjdk-devel.x86_64<span class="token punctuation">}</span><span class="token keyword">function</span> maven_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">wget</span> http://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.1/binaries/apache-maven-3.6.1-bin.tar.gz    <span class="token function">tar</span> -zxvf apache-maven-3.6.1-bin.tar.gz    <span class="token function">sudo</span> <span class="token function">mv</span> ./apache-maven-3.6.1 /usr/share/    <span class="token keyword">echo</span> <span class="token string">"export PATH=<span class="token variable">$PATH</span>:/usr/share/apache-maven-3.6.1/bin"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/profile    <span class="token function">source</span> /etc/profile    mvn --version<span class="token punctuation">}</span><span class="token keyword">function</span> main<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    usage<span class="token operator">=</span><span class="token string">"Usage: <span class="token variable">$0</span> (all|zsh|docker|java|maven)"</span>    <span class="token keyword">echo</span> <span class="token variable">${usage}</span>    <span class="token keyword">case</span> <span class="token variable">${command}</span> <span class="token keyword">in</span>    all<span class="token punctuation">)</span>         oh_my_zsh_install         powerline_install         generate_ssh         add_user         docker_install         add_user_to_docker_group         java_install    <span class="token punctuation">;</span><span class="token punctuation">;</span>    zsh<span class="token punctuation">)</span>        oh_my_zsh_install    <span class="token punctuation">;</span><span class="token punctuation">;</span>    docker<span class="token punctuation">)</span>        docker_install    <span class="token punctuation">;</span><span class="token punctuation">;</span>    java<span class="token punctuation">)</span>        java_install    <span class="token punctuation">;</span><span class="token punctuation">;</span>    maven<span class="token punctuation">)</span>        maven_install     <span class="token punctuation">;</span><span class="token punctuation">;</span>    *<span class="token punctuation">)</span>        <span class="token keyword">echo</span> <span class="token string">"unsupported command yet"</span>        <span class="token keyword">exit</span> 0    <span class="token punctuation">;</span><span class="token punctuation">;</span>    esac<span class="token punctuation">}</span>main</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JAVA 排查姿势简介</title>
      <link href="/tools/greys/"/>
      <url>/tools/greys/</url>
      
        <content type="html"><![CDATA[<h1 id="java-排查姿势简介"><a href="#java-排查姿势简介" class="headerlink" title="java 排查姿势简介"></a>java 排查姿势简介</h1><h2 id="Greys-anatomy"><a href="#Greys-anatomy" class="headerlink" title="Greys-anatomy"></a>Greys-anatomy</h2><p><a href="https://github.com/oldmanpushcart/greys-anatomy" target="_blank" rel="noopener">greys-anatomy</a> 是一款很优秀的 java 诊断工具， 由阿里的一位工程师开发维护，并开源到 github 上。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>github 上的文档说明的很详细了， 而且是中文文档， 阅读基本无障碍。linux 环境， 通过</p><pre class=" language-bash"><code class="language-bash">curl -sLk http://ompc.oss.aliyuncs.com/greys/install.sh<span class="token operator">|</span>sh</code></pre><p>或者短链接</p><pre class=" language-bash"><code class="language-bash">curl -sLk http://t.cn/R2QbHFc<span class="token operator">|</span>sh</code></pre><p>安装即可</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol><li>在 linux 环境下， 首先需要设置 <code>JAVA_HOME</code>  路径，不过一般都设置过。修改 /etc/profile 文件， 或者修改 .bashrc 文件， 当然， 我们可能没有权限，此时可以通过 export JAVA_HOME=/xxx 来临时设置该变量</li><li>通过 <code>jps</code> 命令来查找需要诊断的 java 程序对应的 pid</li><li>通过 <code>./greys pid</code> 来运行格雷医生</li><li>好了， 至此， 你就能通过提供的 <a href="https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf" target="_blank" rel="noopener">文档</a> ， 来查找定位你的 java 问题了。</li></ol><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h4 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h4><p>该命令能监控指定方法的入参，出参数据</p><blockquote><p>watch -b com.xxx.xxx.xxx helloWorld ‘“params[0]=”+params[0]’;<br>watch -s com.xxx.xxx.xxx helloWorld returnObj -x 3;</p></blockquote><h4 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h4><p>该命令能追踪一级方法的调用链路， 同时打印出对应方法的耗时， 可以用来做性能分析</p><blockquote><p>trace com.xxx.xxx.xxx helloWorld</p></blockquote><h4 id="ptrace"><a href="#ptrace" class="headerlink" title="ptrace"></a>ptrace</h4><p>是 <code>trace</code> 命令的增强版， 具体请参见 <a href="https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf#ptrace%E5%91%BD%E4%BB%A4" target="_blank" rel="noopener">github</a></p><h4 id="tt"><a href="#tt" class="headerlink" title="tt"></a>tt</h4><p>TimeTunnel 时间隧道。 该命令很强大， 能记录指定方法的所有入参，出参和抛出的异常。</p><p>通过 <code>-i index</code> 可以查看具体 index 的详细信息</p><p>通过 <code>-i index -p</code> 来自主发起调用</p><p>具体请参见 <a href="https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf#tt%E5%91%BD%E4%BB%A4" target="_blank" rel="noopener">github</a></p><h4 id="others"><a href="#others" class="headerlink" title="others"></a>others</h4><ul><li>stack</li><li>sc</li><li>sm</li><li>monitor</li><li>reset</li><li>…..</li></ul><h2 id="Arthas"><a href="#Arthas" class="headerlink" title="Arthas"></a>Arthas</h2><p>链接 <a href="https://github.com/alibaba/arthas" target="_blank" rel="noopener">https://github.com/alibaba/arthas</a></p><h2 id="线上-debug"><a href="#线上-debug" class="headerlink" title="线上 debug"></a>线上 debug</h2><p>我本地跑的好好的， 怎么到了线上就出了各种问题了？？？</p><p>莫慌， 远程 debug 来助你找到元凶。</p><p>这里选择 <code>IDEA</code> 编译器来演示， <code>Eclips</code> 可自行 Google 使用办法。</p><h3 id="线上-java-服务配置"><a href="#线上-java-服务配置" class="headerlink" title="线上 java 服务配置"></a>线上 java 服务配置</h3><p>在 java 程序启动的时候， 添加如下启动参数(该配置只针对 jdk5-8 的版本)</p><blockquote><p><code>-agentlib:jdwp=transport=dt_socket,server=y,address=8888,suspend=n</code>  </p></blockquote><ul><li>jdwp: java debug wire protocol 自定义的一套远程 debug 协议</li><li>transport=dt_socket 通过 socket 传输</li><li>server=y  server 端监听将要连接的 debug client，否则，将连接到特定地址上的 debug client。</li><li>suspend=n  告知 jvm 立即执行， 无需等待 debug client 连接(设置为 y 时， 会等待链接)</li><li>address=8888  debug 调试端口(有时连接不上， 可能服务端所在宿主机的端口没开)</li></ul><p>对于区分不同环境的启动脚本而言， 只需要定义 JAVA_OPTS 变量， 在开发环境(一般测试和生产不可随意添加这种启动参数)启动时， 加上该变量即可。<br>同时要注意，配置的端口号，server 端是否有开放，一般情况下，server 端的端口都是有限开放。所以配置前要确认端口是否开放。</p><h3 id="IDEA-配置"><a href="#IDEA-配置" class="headerlink" title="IDEA 配置"></a>IDEA 配置</h3><p>在 idea 上找到 edit configurations</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401091235.png-growing" alt="idea configurations"></p><p>在左侧菜单找到 remote 选项，填写相关内容(host 为 server 端 host， port 为上文中 address 对应的端口值)</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401091320.png-growing" alt="remote debug configuration"></p><p>配置完毕， 启动服务，即可愉快的开始 remote debug 了。</p><p>这里需要注意的一点，如果有多线程程序需要调试， 你需要把断点类型设置为 Thread。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.buzhui.top/blog/20200401091429.png-growing" alt="Thread"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> java </tag>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
