<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Middlewares -- Redis&lt;二&gt;</title>
      <link href="/redis/cluster/"/>
      <url>/redis/cluster/</url>
      
        <content type="html"><![CDATA[<h1 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h1><p>关于 redis 集群，一般有以下几种模式</p><ul><li>主从复制模式(Master-Slave) ： 该模式下，所有的事务操作，都会异步同步到其他 slave 上，每台 redis 都存储相同数据</li><li>哨兵模式(Sentinel) ： 通过增加 sentinel 集群，管理 master-slave 下的节点，可以在 master 宕机时，选举新的 master 节点</li><li>Jedis sharding ：在客户端，对 key 进行 hash ，散列到不同的 redis 实例上</li><li>相关中间件如 codis ， twemproxy 等</li></ul><p>在 redis 3.0 版本其，官方提供了 redis cluster 功能。</p><h2 id="redis-cluster-简介"><a href="#redis-cluster-简介" class="headerlink" title="redis cluster 简介"></a>redis cluster 简介</h2><p>redis cluster 主要基于 CRC16 算法对 key 进行 hash ，然后散列到不同散列槽。</p><p>redis cluster 总共提供 16384 个hash 槽(slot) ，理论上，集群的最大节点数量最大乐意为 16384 个。不过 redis 官方给出的建议是不要超过 1000 的量级。</p><p>每个 redis instance 会负责这个散列槽中的一部分。</p><p><strong>新增</strong>或<strong>删除</strong>节点，对于 redis cluster 而言就是对 slot 进行 reshard，redis cluster 保证 slot 平滑移动</p><h3 id="1-key-hash-计算"><a href="#1-key-hash-计算" class="headerlink" title="1. key hash 计算"></a>1. key hash 计算</h3><p>redis cluster 会对大括号 <strong>{}</strong> 中的值计算 hash 值进行散列。</p><ul><li>只计算第一次出现  <strong>{}</strong> 的值，如果没有，则计算整个 key 的 hash 值， 如 <ul><li><code>key{key1}{key2}</code> ： 值计算 key1 的hash</li><li><code>keykey</code> ： 计算整个 keykey 的 hash</li></ul></li><li>如果只有 <strong>{</strong> ，没有 <strong>}</strong> ，或者 <strong>{}</strong> 中没有内容，则计算整个 key 的 hash 值， 如<ul><li><code>key{12</code> ： 计算整个 hash</li><li><code>key{}key</code> ： 计算整个 hash，这意味着所有以 <code>{}</code> 开头的 key ，都是整个计算 hash</li></ul></li></ul><p>源码如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">keyHashSlot</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> keylen<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> s<span class="token punctuation">,</span> e<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* start-end indexes of { and } */</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> s <span class="token operator">&lt;</span> keylen<span class="token punctuation">;</span> s<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">[</span>s<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'{'</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* No '{' ? Hash the whole key. This is the base case. */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> keylen<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">crc16</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>keylen<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3FFF</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* '{' found? Check if we have the corresponding '}'. */</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>e <span class="token operator">=</span> s<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> e <span class="token operator">&lt;</span> keylen<span class="token punctuation">;</span> e<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">[</span>e<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'}'</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* No '}' or nothing between {} ? Hash the whole key. */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> keylen <span class="token operator">||</span> e <span class="token operator">==</span> s<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">crc16</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span>keylen<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3FFF</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">/* If we are here there is both a { and a } on its right. Hash     * what is in the middle between { and }. */</span>    <span class="token keyword">return</span> <span class="token function">crc16</span><span class="token punctuation">(</span>key<span class="token operator">+</span>s<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>e<span class="token operator">-</span>s<span class="token number">-1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3FFF</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="2-集群拓扑结构"><a href="#2-集群拓扑结构" class="headerlink" title="2. 集群拓扑结构"></a>2. 集群拓扑结构</h3><p>redis cluster 是一个网状拓扑结构，每个 redis instance ，都会与其他 redis instance 建立连接，也就是说如果集群中有 n 个节点，则总共会有 n(n-1) 个连接，这些 TCP 连接会被永久保存，并非按需创建。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200414155611.png-growing" alt="redis cluster struct"></p><h3 id="3-集群工作"><a href="#3-集群工作" class="headerlink" title="3. 集群工作"></a>3. 集群工作</h3><p>client 发送请求 ，集群中某个节点接收到请求后，会查找内部 slot , node id 映射，如果是自己，执行命令返回结果，如果是其他节点，则会给 client 返回一个 <code>MOVED slot_id target_ip:port</code> 的错误。客户端需要根据返回的节点信息，再次执行命令。</p><p>注意，如果在此期间，目标节点出现故障，slot 发生了转移，则 client 仍需要根据返回的 ip:port 再次查询</p><h2 id="redis-cluster-搭建"><a href="#redis-cluster-搭建" class="headerlink" title="redis cluster 搭建"></a>redis cluster 搭建</h2><h3 id="1-安装-redis"><a href="#1-安装-redis" class="headerlink" title="1. 安装 redis"></a>1. 安装 redis</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">wget</span> https://github.com/antirez/redis/archive/5.0.7.tar.gz<span class="token function">tar</span> -xvf ./5.0.7.tar.gz</code></pre><p>下载并解压后，你可以 <code>make</code> 一把，但你通过上面下载后，其实在 <code>src</code> 包里已经有可以使用的 redis server 等各个工具，可以直接使用。</p><p><a href="https://github.com/antirez/redis" target="_blank" rel="noopener">Redis Github</a> 上的安装步骤很详细，这里不再赘述</p><p>ps: 我是因为 make 之后跑 make test 时，一直挂掉，因为我内存实在太小… 所以就直接用了</p><h3 id="2-编辑配置文件"><a href="#2-编辑配置文件" class="headerlink" title="2. 编辑配置文件"></a>2. 编辑配置文件</h3><pre><code># 该集群阶段的端口port 7000# 是否后台启动daemonize yes# 我没有内存，这里设置 50mmaxmemory 50m# 为每一个集群节点指定一个 pid_filepidfile /home/dylan/tmp/scripts-redis/cluster/pid/pid_7000.pid#在bind指令后添加本机的ipbind 127.0.0.1####################################### file #######################loglevel noticelogfile /home/dylan/tmp/scripts-redis/cluster/log/log_7000.logdbfilename "dump.rdb"dir "/home/dylan/tmp/scripts-redis/cluster/data/7000"#################################### cluster ####################################cluster-enabled yes # 启用集群模式# 集群的配置，配置文件首次启动自动生成 , 不能人工编辑，是集群节点自动维护的文件cluster-config-file "/home/dylan/tmp/scripts-redis/cluster/config/nodes_7000.conf"cluster-node-timeout 5000# 配置后，通过 cli 连接需要通过 -a 123456 连接requirepass "123456"masterauth "123456"</code></pre><h3 id="3-复制多份配置文件并修改对应值"><a href="#3-复制多份配置文件并修改对应值" class="headerlink" title="3. 复制多份配置文件并修改对应值"></a>3. 复制多份配置文件并修改对应值</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200414195430.png-growing" alt="redis cluster folder"></p><p>如图所示，将 redis.conf 配置文件 copy 6 份(因为 redis 要求最少 3 master ，我们要每个 master 一个 slave ，那么这里就需要 6 个实例)，然后建好 conf 文件里配置的各个目录</p><h3 id="4-启动-redis-实例"><a href="#4-启动-redis-实例" class="headerlink" title="4. 启动 redis 实例"></a>4. 启动 redis 实例</h3><p><code>redis-server redis.conf</code> ，这个命令想必大家都很熟悉，这里就不再啰嗦。这里我们只需要依次启动 6 个实例即可。</p><p>我个人写了个小脚本，后面会贴上来。</p><h3 id="5-创建集群"><a href="#5-创建集群" class="headerlink" title="5. 创建集群"></a>5. 创建集群</h3><p>redis 提供了 <code>cluster create</code> 命令帮助我们创建 redis cluster </p><pre class=" language-bash"><code class="language-bash">redis-cli -a 123456 --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1</code></pre><p>执行该命令后，会有如下输出：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200414200359.png-growing" alt="redis create cluster"></p><p>通过 redis 输出的信息能看到，现在是 3 master 3 slave，每个 master 一个 slave 节点</p><h3 id="6-查看集群信息"><a href="#6-查看集群信息" class="headerlink" title="6. 查看集群信息"></a>6. 查看集群信息</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 注意 -c 参数，表示以集群方式登入</span>redis-cli -a 123456 -c -p 7000</code></pre><p>cluster 相关的命令，请参考 <a href="http://redis.cn/commands.html#cluster" target="_blank" rel="noopener">这里</a></p><p>这个时候我们 set 几个数据：</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:7000<span class="token operator">></span> <span class="token keyword">set</span> a a-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span>15495<span class="token punctuation">]</span> located at 127.0.0.1:7002OK127.0.0.1:7002<span class="token operator">></span> <span class="token keyword">set</span> b b-<span class="token operator">></span> Redirected to slot <span class="token punctuation">[</span>3300<span class="token punctuation">]</span> located at 127.0.0.1:7000OK127.0.0.1:7000<span class="token operator">></span> keys *1<span class="token punctuation">)</span> <span class="token string">"b"</span></code></pre><p>可以看到，第一次 set a 时， 被路由到了 7002 节点，第二次 set b 时，路由到了 7000 也就是自己这儿，通过 keys * (请不要在生产环境使用该命令) 查看时， 只有 key b (kb…) ， key a 不会显示，因为它在 7002 节点那儿</p><h3 id="小脚本"><a href="#小脚本" class="headerlink" title="小脚本"></a>小脚本</h3><p>没有做多少重构，将就着用…</p><p><code>./run.sh start all</code> ： 分别以 conf 目录下的配置文件启动 redis 实例</p><p><code>./run.sh stop all</code> ： 停止所有 conf 目录下配置文件产生的 redis 实例</p><p><code>./run.sh cluster</code> ： 在启动所有 redis 实例后，通过 cluster 命令创建集群，需要手动修改 ip:port</p><p><code>./run.sh status</code> ： 查看 redis 实例，这里没有提供查看单个 redis 实例 status 的方法</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#!/usr/bin/env bash</span><span class="token comment" spellcheck="true"># redis server / redis cli 所在目录</span>workdir<span class="token operator">=</span><span class="token string">"/home/dylan/tmp/redis-5.0.8/src"</span><span class="token comment" spellcheck="true"># 脚本所在目录</span>scriptdir<span class="token operator">=</span><span class="token string">"/home/dylan/tmp/scripts-redis"</span><span class="token comment" spellcheck="true"># cluster 各个目录</span>cluster_dir<span class="token operator">=</span><span class="token string">"<span class="token variable">${scriptdir}</span>/cluster"</span>cluster_pid_dir<span class="token operator">=</span><span class="token string">"<span class="token variable">${cluster_dir}</span>/pid"</span>cluster_conf_dir<span class="token operator">=</span><span class="token string">"<span class="token variable">${cluster_dir}</span>/conf"</span><span class="token comment" spellcheck="true"># $1 is redis config file name looks like ./conf/redis.1234.conf</span><span class="token comment" spellcheck="true"># return pid file name looks like pid_1234.pid</span><span class="token keyword">function</span> get_redis_pid_file<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        rport<span class="token operator">=</span><span class="token punctuation">$(</span>echo <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">"."</span> <span class="token string">'{print <span class="token variable"><span class="token variable">$(</span>NF-1<span class="token variable">)</span></span>}'</span><span class="token punctuation">)</span>        <span class="token keyword">echo</span> -e <span class="token string">"<span class="token variable">${cluster_pid_dir}</span>/pid_<span class="token variable">$rport</span>.pid"</span><span class="token punctuation">}</span><span class="token keyword">function</span> get_redis_conf_file<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        conf<span class="token operator">=</span><span class="token punctuation">$(</span>echo <span class="token string">"<span class="token variable">$1</span>"</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">"/"</span> <span class="token string">'{print <span class="token variable">$NF</span>}'</span><span class="token punctuation">)</span>        <span class="token keyword">echo</span> -e <span class="token string">"<span class="token variable">${cluster_conf_dir}</span>/<span class="token variable">$conf</span>"</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true"># $1 should be redis config file name looks like redis.1234.conf</span><span class="token keyword">function</span> redis_start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>        <span class="token comment" spellcheck="true"># conf file looks like redis.port.conf</span>        <span class="token comment" spellcheck="true"># pid file looks like pid_port.pid</span>        redis_conf_path<span class="token operator">=</span><span class="token variable">$1</span>        redis_conf<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_conf_file $<span class="token punctuation">{</span>redis_conf_path<span class="token punctuation">}</span><span class="token variable">)</span></span>        redis_conf_path_forshow<span class="token operator">=</span><span class="token string">"Redis with config $(echo <span class="token variable">${redis_conf}</span> | awk -F"</span>/<span class="token string">" '{print <span class="token variable">$NF</span>}')"</span>        pidfile<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_pid_file $<span class="token punctuation">{</span>redis_conf_path<span class="token punctuation">}</span><span class="token variable">)</span></span>        <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">$pidfile</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                <span class="token keyword">if</span> <span class="token function">kill</span> -0 <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pidfile<span class="token variable">`</span></span> <span class="token operator">></span> /dev/null 2<span class="token operator">></span><span class="token operator">&amp;</span>1<span class="token punctuation">;</span> <span class="token keyword">then</span>                        <span class="token keyword">echo</span> REDIS already running as process <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pidfile<span class="token variable">`</span></span><span class="token keyword">.</span>                        <span class="token keyword">return</span>                <span class="token keyword">fi</span>        <span class="token keyword">fi</span>        <span class="token comment" spellcheck="true"># 配置中已经配置了 daemonize yes</span>        <span class="token comment" spellcheck="true"># nohup ${workdir}/redis-server $conffile > $logfile 2>&amp;1 &lt; /dev/null &amp;</span>        <span class="token variable">${workdir}</span>/redis-server <span class="token variable">$redis_conf</span>        <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                <span class="token function">sleep</span> 1                <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">$pidfile</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> $pidfile<span class="token variable">)</span></span>                        <span class="token keyword">if</span> <span class="token function">ps</span> -p <span class="token variable">$pid</span> <span class="token operator">></span> /dev/null 2<span class="token operator">></span><span class="token operator">&amp;</span>1<span class="token punctuation">;</span> <span class="token keyword">then</span>                                <span class="token keyword">echo</span> <span class="token variable">${redis_conf_path_forshow}</span> STARTED                        <span class="token keyword">else</span>                                <span class="token keyword">echo</span> <span class="token variable">${redis_conf_path_forshow}</span> FAILED TO START                                <span class="token keyword">exit</span> 1                        <span class="token keyword">fi</span>                <span class="token keyword">else</span>                        <span class="token keyword">echo</span> <span class="token variable">${redis_conf_path_forshow}</span> start failed                        <span class="token keyword">exit</span> 1                <span class="token keyword">fi</span>        <span class="token keyword">else</span>                <span class="token keyword">echo</span> <span class="token variable">${redis_conf_path_forshow}</span> DID NOT START                <span class="token keyword">exit</span> 1        <span class="token keyword">fi</span><span class="token punctuation">}</span>conffile<span class="token operator">=</span><span class="token variable">$2</span><span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>        start<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true"># 如果 $2 为 all ，则启动所有</span>                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"all"</span> <span class="token operator">==</span> <span class="token string">"<span class="token variable">$conffile</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        <span class="token keyword">echo</span> <span class="token string">"Run all files in <span class="token variable">$cluster_conf</span>"</span>                        <span class="token keyword">for</span> rfile <span class="token keyword">in</span> <span class="token variable">${cluster_conf_dir}</span>/*.conf                        <span class="token keyword">do</span>                                redis_start <span class="token variable">$rfile</span>                                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                                        <span class="token keyword">exit</span> 1                                <span class="token keyword">fi</span>                        <span class="token keyword">done</span>                <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"<span class="token variable">$conffile</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token comment" spellcheck="true"># 输入的文件不存在</span>                        <span class="token keyword">echo</span> Can not <span class="token function">find</span> <span class="token variable">$conffile</span><span class="token keyword">.</span>                        <span class="token keyword">exit</span> 1                <span class="token keyword">elif</span> <span class="token punctuation">[</span> -z <span class="token variable">$conffile</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        redis_start <span class="token variable">$conffile</span>                <span class="token keyword">else</span>                        <span class="token keyword">echo</span> <span class="token string">"Usage <span class="token variable">$0</span> start (all|redis_config_file)"</span>                        <span class="token keyword">exit</span> 1                <span class="token keyword">fi</span>                <span class="token keyword">exit</span> 0                <span class="token punctuation">;</span><span class="token punctuation">;</span>        stop<span class="token punctuation">)</span>                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"all"</span> <span class="token operator">==</span> <span class="token string">"<span class="token variable">$conffile</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        <span class="token keyword">echo</span> Stopping all<span class="token punctuation">..</span>.                        <span class="token keyword">for</span> rfile <span class="token keyword">in</span> <span class="token variable">${cluster_conf_dir}</span>/*.conf                        <span class="token keyword">do</span>                                pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_pid_file $rfile<span class="token variable">)</span></span>                                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"<span class="token variable">$pid</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                                        <span class="token keyword">echo</span>                                        <span class="token keyword">echo</span> Redis with config <span class="token string">"<span class="token variable">$rfile</span>"</span> already stopped                                        <span class="token keyword">continue</span>                                <span class="token keyword">fi</span>                                <span class="token function">kill</span> <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pid<span class="token variable">`</span></span>                                <span class="token function">sleep</span> 1                                <span class="token keyword">echo</span>                                <span class="token keyword">echo</span> Redis with config <span class="token variable">$rfile</span> STOPPED                        <span class="token keyword">done</span>                <span class="token keyword">elif</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -f <span class="token string">"<span class="token variable">$conffile</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        <span class="token keyword">echo</span> Can not <span class="token function">find</span> <span class="token variable">$conffile</span><span class="token keyword">.</span>                        <span class="token keyword">exit</span> 1                <span class="token keyword">elif</span> <span class="token punctuation">[</span> -f <span class="token variable">$conffile</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                        pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_pid_file $rfile<span class="token variable">)</span></span>                        <span class="token function">kill</span> <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pid<span class="token variable">`</span></span>                        <span class="token function">sleep</span> 1                        <span class="token keyword">echo</span> STOPPED                <span class="token keyword">else</span>                        <span class="token keyword">echo</span> <span class="token string">"Usage <span class="token variable">$0</span> stop (all|redis_config_file)"</span>                        <span class="token keyword">exit</span> 1                <span class="token keyword">fi</span>                <span class="token punctuation">;</span><span class="token punctuation">;</span>        status<span class="token punctuation">)</span>                <span class="token keyword">echo</span> <span class="token string">"Checking status..."</span>                <span class="token keyword">echo</span> Found <span class="token variable"><span class="token variable">`</span><span class="token function">ls</span> $<span class="token punctuation">{</span>cluster_conf_dir<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token variable">`</span></span> config <span class="token function">file</span>                <span class="token keyword">echo</span>                <span class="token keyword">for</span> rfile <span class="token keyword">in</span> <span class="token variable">${cluster_conf_dir}</span>/*.conf                <span class="token keyword">do</span>                        pid<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>get_redis_pid_file $rfile<span class="token variable">)</span></span>                        <span class="token keyword">if</span> <span class="token punctuation">[</span> -f <span class="token variable">$pid</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                                <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token operator">!</span> -s <span class="token variable">${pid}</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>                                        <span class="token keyword">echo</span> <span class="token function">file</span> <span class="token variable">$pid</span> is empty. skip<span class="token punctuation">..</span>.                                        <span class="token keyword">echo</span> <span class="token string">"Please check <span class="token variable">$pid</span>."</span>                                        <span class="token keyword">echo</span>                                        <span class="token keyword">continue</span>                                <span class="token keyword">fi</span>                                <span class="token keyword">if</span> <span class="token function">ps</span> -p <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pid<span class="token variable">`</span></span> <span class="token operator">></span> /dev/null 2<span class="token operator">></span><span class="token operator">&amp;</span>1<span class="token punctuation">;</span><span class="token keyword">then</span>                                        <span class="token keyword">echo</span> REDIS <span class="token variable">$pid</span> with pid <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pid<span class="token variable">`</span></span> is running                                <span class="token keyword">else</span>                                        <span class="token keyword">echo</span> <span class="token string">"Not running with pid <span class="token variable"><span class="token variable">`</span><span class="token function">cat</span> $pid<span class="token variable">`</span></span>, Please check it"</span>                                        <span class="token keyword">exit</span> 1                                <span class="token keyword">fi</span>                        <span class="token keyword">else</span>                                <span class="token keyword">echo</span> <span class="token string">"Not running with config file <span class="token variable">$rfile</span>. No pid file exists."</span>                        <span class="token keyword">fi</span>                <span class="token keyword">done</span>                <span class="token punctuation">;</span><span class="token punctuation">;</span>        cluster<span class="token punctuation">)</span>                <span class="token keyword">echo</span> <span class="token string">"Start clusting..."</span>                <span class="token variable">${workdir}</span>/redis-cli -a 123456 --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1                <span class="token keyword">exit</span> 0                <span class="token punctuation">;</span><span class="token punctuation">;</span>        test<span class="token punctuation">)</span>                <span class="token keyword">echo</span>                <span class="token keyword">echo</span> <span class="token string">"Test Success"</span>                <span class="token keyword">exit</span> 0                <span class="token punctuation">;</span><span class="token punctuation">;</span>        *<span class="token punctuation">)</span>                <span class="token keyword">echo</span>                <span class="token keyword">echo</span> -n <span class="token string">"Usage: "</span>                <span class="token keyword">echo</span> -n <span class="token string">"<span class="token variable">$0</span> status or "</span>                <span class="token keyword">echo</span> <span class="token string">"<span class="token variable">$0</span> {start|stop} conf_file_path"</span> <span class="token operator">></span><span class="token operator">&amp;</span>2                <span class="token punctuation">;</span><span class="token punctuation">;</span>esac</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Middlewares -- Redis&lt;一&gt;</title>
      <link href="/redis/introduction/"/>
      <url>/redis/introduction/</url>
      
        <content type="html"><![CDATA[<h1 id="Redis-lt-gt"><a href="#Redis-lt-gt" class="headerlink" title="Redis <->"></a>Redis &lt;-&gt;</h1><h2 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h2><h3 id="1-Strings"><a href="#1-Strings" class="headerlink" title="1. Strings"></a>1. Strings</h3><p>redis 对此描述为 <strong>binary-safe</strong> strings。可以看出， strings 类型在 redis 中是以 <strong>二进制</strong> 形式存储，这意味着 redis strings 可以用来存储任何类型的数据，甚至是一张图片。一个 string value 最大可以为 <strong>512M</strong></p><p>redis 使用 sds(simple dynamic string) struct 来存储 strings 数据。</p><pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> sdshdr <span class="token punctuation">{</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 已存储的 string 长度</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> free<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 剩余的存储空间</span>    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 存储的字符串</span><span class="token punctuation">}</span></code></pre><p>初始化时，free 为 0， 当 <code>append key value</code> 时， redis 会对该存储空间扩容，<strong>扩容大小 = new_value.length * 2</strong> ，但最大不能超过 1M (redis 中定义为 <code>SDS_MAX_PREALLOC</code>)。</p><p>这样， redis 就能十分方便的获取 string 长度(O(1))，减少内存扩容。</p><p>同样，这种策略会预分配内存，产生不必要的内存浪费，所以当我们经常 append huge strings 时，就会产生很多不必要的浪费。</p><p>redis 在 3.2 版本后，对此做了优化，会根据 string 的长度，选择不同的 SDS type</p><pre class=" language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">char</span> <span class="token function">sdsReqType</span><span class="token punctuation">(</span>size_t string_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>string_size <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// 32</span>        <span class="token keyword">return</span> SDS_TYPE_5<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>string_size <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 256</span>        <span class="token keyword">return</span> SDS_TYPE_8<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>string_size <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true">// 65536 即 64 * 1024 = 64k</span>        <span class="token keyword">return</span> SDS_TYPE_16<span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">if</span> (LONG_MAX == LLONG_MAX)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>string_size <span class="token operator">&lt;</span> <span class="token number">1ll</span><span class="token operator">&lt;&lt;</span><span class="token number">32</span><span class="token punctuation">)</span>         <span class="token keyword">return</span> SDS_TYPE_32<span class="token punctuation">;</span>    <span class="token keyword">return</span> SDS_TYPE_64<span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">else</span></span>    <span class="token keyword">return</span> SDS_TYPE_32<span class="token punctuation">;</span><span class="token macro property">#<span class="token directive keyword">endif</span></span><span class="token punctuation">}</span></code></pre><p>strings 指令：</p><blockquote><p>inrc / decr / incrby / decrby ：原子递增/递减 </p></blockquote><p>可以用来统计访问量 / 点赞量 / 转发量 等各种熟路</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> <span class="token keyword">set</span> counter 18OK<span class="token comment" spellcheck="true"># 原子递增</span>127.0.0.1:6379<span class="token operator">></span> INCR counter<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 19<span class="token comment" spellcheck="true"># 原子递减</span>127.0.0.1:6379<span class="token operator">></span> DECR counter<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 18<span class="token comment" spellcheck="true"># 步长递增</span>127.0.0.1:6379<span class="token operator">></span> INCRBY counter 18<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 36<span class="token comment" spellcheck="true"># 步长递减</span>127.0.0.1:6379<span class="token operator">></span> DECRBY counter 18<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 18127.0.0.1:6379<span class="token operator">></span> get counter<span class="token string">"18"</span></code></pre><hr><blockquote><p>get / set / getset / append ： 获取 / 设置 / 设置同时返回值 /  追加</p><p>mget / mset ： 批量获取 / 设置</p></blockquote><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 以 key value 形式 set</span>127.0.0.1:6379<span class="token operator">></span> MSET k1 v1 k2 v2 k3 v3OK127.0.0.1:6379<span class="token operator">></span> MGET k1 k2 k31<span class="token punctuation">)</span> <span class="token string">"v1"</span>2<span class="token punctuation">)</span> <span class="token string">"v2"</span>3<span class="token punctuation">)</span> <span class="token string">"v3"</span></code></pre><hr><blockquote><p>setex ： 设置 value 和过期时间</p></blockquote><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> SETEX exp1 10 expv1OK<span class="token comment" spellcheck="true"># 获取过期时间， 还有 7 秒</span>127.0.0.1:6379<span class="token operator">></span> ttl exp1<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 7127.0.0.1:6379<span class="token operator">></span> get exp1<span class="token string">"expv1"</span><span class="token comment" spellcheck="true"># 此时查询时已过期</span>127.0.0.1:6379<span class="token operator">></span> get exp1<span class="token punctuation">(</span>nil<span class="token punctuation">)</span></code></pre><hr><blockquote><p>setnx / strlen ： set not exists，即没有时，才生效 / 获取 value 长度</p></blockquote><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 无 nx 这个 key 时， 设置成功</span>127.0.0.1:6379<span class="token operator">></span> SETNX nx nxv<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> get nx<span class="token string">"nxv"</span><span class="token comment" spellcheck="true"># 有 nx 这个 key 时， 设置失败</span>127.0.0.1:6379<span class="token operator">></span> SETNX nx nxvvvvvv<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 0127.0.0.1:6379<span class="token operator">></span> get nx<span class="token string">"nxv"</span><span class="token comment" spellcheck="true"># 获取 key 为 nx 的 value 长度</span>127.0.0.1:6379<span class="token operator">></span> STRLEN nx<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> get nx<span class="token string">"nxv"</span></code></pre><hr><p>更多 strings 相关命令参见 <a href="https://redis.io/commands#string" target="_blank" rel="noopener">这里</a></p><h3 id="2-Lists"><a href="#2-Lists" class="headerlink" title="2. Lists"></a>2. Lists</h3><p>redis 的 list 是 <strong>linkedList</strong> ， 是根据插入顺寻排列的 string 元素的集合， 一个 list 最大长度为 <strong>2<sup>32</sup> -1</strong> 。</p><p>list 节点 / 迭代器 / list 定义如下：</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> listNode <span class="token punctuation">{</span>    <span class="token keyword">struct</span> listNode <span class="token operator">*</span>prev<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 头节点</span>    <span class="token keyword">struct</span> listNode <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 尾节点</span>    <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 值， void * 表明 value 可以是任意类型</span><span class="token punctuation">}</span> listNode<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> listIter <span class="token punctuation">{</span>    listNode <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 下一个节点</span>    <span class="token keyword">int</span> direction<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 遍历方向</span><span class="token punctuation">}</span> listIter<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> list <span class="token punctuation">{</span>    listNode <span class="token operator">*</span>head<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 头节点</span>    listNode <span class="token operator">*</span>tail<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 尾节点</span>    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>dup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 复制节点 func</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 释放节点 func</span>    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 比较两个节点是否相等</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 链表长度</span><span class="token punctuation">}</span> list<span class="token punctuation">;</span></code></pre><p>由此可见， redis 中的 list 是一个双向链表。同时会保存头尾节点和长度，所以获取他们的时间复杂度都为 O(1)</p><p>所以， LPUSH，RPUSH， RPOP， LPOP ，RPOPLPUSH ， LLEN 等操作都十分高效</p><p>Lists 指令：</p><blockquote><p>LPUSH / RPUSH ： 从头部 / 尾部插入元素</p></blockquote><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> LPUSH list l1 l2<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"l2"</span>2<span class="token punctuation">)</span> <span class="token string">"l1"</span>127.0.0.1:6379<span class="token operator">></span> RPUSH list r1 r2<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 4127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"l2"</span>2<span class="token punctuation">)</span> <span class="token string">"l1"</span>3<span class="token punctuation">)</span> <span class="token string">"r1"</span>4<span class="token punctuation">)</span> <span class="token string">"r2"</span>127.0.0.1:6379<span class="token operator">></span> del list</code></pre><hr><blockquote><p>LRANGE ： 从列表中拿出一个 range 。</p></blockquote><ul><li>注意这个 range 是 <strong>闭合</strong> 的，比如你执行 <code>lrange list 0 1</code> ，即 [0, 1] 而非 [0, 1) 。 </li><li>负数表示倒数， 如 [0, -1] ，表示从 0 到最后一个数，即该 list 的全部元素</li></ul><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> RPUSH list v1 v2 v3<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"v1"</span>2<span class="token punctuation">)</span> <span class="token string">"v2"</span>3<span class="token punctuation">)</span> <span class="token string">"v3"</span>127.0.0.1:6379<span class="token operator">></span> del list</code></pre><p>我们结合 LPUSH + LRANGE ，可以简单的实现 timeline 功能</p><hr><blockquote><p> LTRIM：从头部截取指定长度 slice 并存入该 key 中</p></blockquote><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> lpush list v1 v2 v3<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"v3"</span>2<span class="token punctuation">)</span> <span class="token string">"v2"</span>3<span class="token punctuation">)</span> <span class="token string">"v1"</span><span class="token comment" spellcheck="true"># 这里从头截取 [0, 1] 长度的 slice 并存入到 list 中</span>127.0.0.1:6379<span class="token operator">></span> LTRIM list 0 1OK127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"v3"</span>2<span class="token punctuation">)</span> <span class="token string">"v2"</span>127.0.0.1:6379<span class="token operator">></span> del list</code></pre><p>LPUSH + LTRIM 的组合，可以实现一个简单的定长 list ，该 list 维护指定长度的最新元素</p><hr><blockquote><p>LINSERT : 在指定元素前/后插入原色</p></blockquote><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> lpush list val<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"val"</span><span class="token comment" spellcheck="true"># val 前插入</span>127.0.0.1:6379<span class="token operator">></span> linsert list before val val-before<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"val-before"</span>2<span class="token punctuation">)</span> <span class="token string">"val"</span><span class="token comment" spellcheck="true"># val 后插入</span>127.0.0.1:6379<span class="token operator">></span> LINSERT list after val val-after<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"val-before"</span>2<span class="token punctuation">)</span> <span class="token string">"val"</span>3<span class="token punctuation">)</span> <span class="token string">"val-after"</span><span class="token comment" spellcheck="true"># 在一个不存在的元素前插入，返回 -1 ， 插入失败</span>127.0.0.1:6379<span class="token operator">></span> LINSERT list before noexist noexist<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> -1127.0.0.1:6379<span class="token operator">></span> lrange list 0 -11<span class="token punctuation">)</span> <span class="token string">"val-before"</span>2<span class="token punctuation">)</span> <span class="token string">"val"</span>3<span class="token punctuation">)</span> <span class="token string">"val-after"</span>127.0.0.1:6379<span class="token operator">></span> del list</code></pre><hr><blockquote><p>LPOP / RPOP</p></blockquote><p>拿到并删除 头部 / 尾部 元素</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> rpush list <span class="token function">head</span> middle <span class="token function">tail</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> lrange list 0 -11<span class="token punctuation">)</span> <span class="token string">"head"</span>2<span class="token punctuation">)</span> <span class="token string">"middle"</span>3<span class="token punctuation">)</span> <span class="token string">"tail"</span>127.0.0.1:6379<span class="token operator">></span> LPOP list<span class="token string">"head"</span>127.0.0.1:6379<span class="token operator">></span> RPOP list<span class="token string">"tail"</span>127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"middle"</span>127.0.0.1:6379<span class="token operator">></span> del list</code></pre><hr><blockquote><p>LREM key count element ： 删除元素</p></blockquote><ul><li>count &gt; 0 时， <strong>从头到尾</strong> 删除与 element 相等的元素， 删除 count 个</li><li>count &lt; 0 时， <strong>从尾到头</strong> 删除与 element 相等的元素， 删除 count 个</li><li>count = 0 时， 删除所有与 element 相等的元素</li></ul><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> RPUSH list 1 2 1 2 1 2<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 6<span class="token comment" spellcheck="true"># 从头到尾遍历，删除一个元素 2</span>127.0.0.1:6379<span class="token operator">></span> LREM list 1 2<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"1"</span> 2<span class="token punctuation">)</span> <span class="token string">"1"</span> 3<span class="token punctuation">)</span> <span class="token string">"2"</span> 4<span class="token punctuation">)</span> <span class="token string">"1"</span> 5<span class="token punctuation">)</span> <span class="token string">"2"</span><span class="token comment" spellcheck="true"># 从尾到头遍历， 删除一个元素 2</span>127.0.0.1:6379<span class="token operator">></span> LREM list -1 2<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"1"</span> 2<span class="token punctuation">)</span> <span class="token string">"1"</span> 3<span class="token punctuation">)</span> <span class="token string">"2"</span> 4<span class="token punctuation">)</span> <span class="token string">"1"</span><span class="token comment" spellcheck="true"># 删除所有为 1 的元素</span>127.0.0.1:6379<span class="token operator">></span> LREM list 0 1<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> LRANGE list 0 -11<span class="token punctuation">)</span> <span class="token string">"2"</span></code></pre><hr><blockquote><p>RPOPLPUSH  source dest </p></blockquote><p>取出 source 尾节点放到 dest 的头节点</p><ul><li>如果 source 不存在，返回 nil ， 不执行任何操作</li><li>如果 dest 不存在，创建 dest，并执行操作</li><li>如果 source tail 元素 和 dest head 元素一致，依旧会 push</li><li>如果 source 和 dest 是同一个 list ，这个 list 就变成了一个 circular list</li></ul><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> LRANGE <span class="token function">source</span> 0 -11<span class="token punctuation">)</span> <span class="token string">"s"</span> 2<span class="token punctuation">)</span> <span class="token string">"s"</span><span class="token comment" spellcheck="true"># source(这里指 noexist) 不存在， 返回 nil</span>127.0.0.1:6379<span class="token operator">></span> RPOPLPUSH noexist <span class="token function">source</span><span class="token punctuation">(</span>nil<span class="token punctuation">)</span>127.0.0.1:6379<span class="token operator">></span> LRANGE <span class="token function">source</span> 0 -11<span class="token punctuation">)</span> <span class="token string">"s"</span> 2<span class="token punctuation">)</span> <span class="token string">"s"</span><span class="token comment" spellcheck="true"># 只有 source</span>127.0.0.1:6379<span class="token operator">></span> keys *1<span class="token punctuation">)</span> <span class="token string">"source"</span><span class="token comment" spellcheck="true"># dest 不存在，但是会被创建</span>127.0.0.1:6379<span class="token operator">></span> RPOPLPUSH <span class="token function">source</span> dest<span class="token string">"s"</span>127.0.0.1:6379<span class="token operator">></span> LRANGE dest 0 -11<span class="token punctuation">)</span> <span class="token string">"s"</span><span class="token comment" spellcheck="true"># 相同的两个元素，不会被覆盖</span>127.0.0.1:6379<span class="token operator">></span> RPOPLPUSH <span class="token function">source</span> dest<span class="token string">"s"</span>127.0.0.1:6379<span class="token operator">></span> LRANGE dest 0 -11<span class="token punctuation">)</span> <span class="token string">"s"</span> 2<span class="token punctuation">)</span> <span class="token string">"s"</span></code></pre><hr><blockquote><p>BLPOP key1 key2 key3… timeout</p></blockquote><p>LPOP 的阻塞版本，即 key1 , key2, key3 … 任一监听的 key 中都没有值时，会阻塞到 timeout ，timeout 为 0 表示一直阻塞</p><ul><li><p>key1 -&gt; key2 -&gt; key3 按序查找，直到找到值</p></li><li><p>多个 client 监听同一个 key 时，按监听时间的早晚，依次返回给 client ，client 接收到后，下次监听需要重新排队</p></li><li><p>multi 操作一次塞入多个值时，会先执行完 multi 操作，然后返回并删除头节点</p><hr></li></ul><blockquote><p>BRPOP / BRPOPLPUSH</p></blockquote><p>BRPOP 功能参考 BLPOP， 即阻塞版本的 RPOP，获取并删除尾节点</p><p>BRPOPLPUSH 即阻塞版本的 RPOPLPUSH ，从 source 获取尾节点并放到 dest 的头部</p><hr><p>更多 lists 的操作命令参考 <a href="https://redis.io/commands#list" target="_blank" rel="noopener">这里</a></p><h3 id="3-Sets"><a href="#3-Sets" class="headerlink" title="3. Sets"></a>3. Sets</h3><p>sets 底层主要基于 hash 表和 inset 数据结构实现。</p><p><strong>无序且去重</strong>的 set 集合，最大可存储 2<sup>32</sup> -1 个元素。</p><blockquote><p>SADD key ele1 ele2 ele3 …</p><p>SCARD / SMEMBERS key</p><p>SISMEMBER key ele</p></blockquote><p>添加 / 获取 set 元素数量 / 获取 set 所有元素 / 确定一个元素是否在集合中</p><hr><blockquote><p>SDIFF key1 key2 key3 …</p><p>SDIFFSTORE dest key1 key2</p></blockquote><ul><li>sdiff ：获取 key1 与 key2， key3 的<strong>差集</strong>，即 key2 不存在与 key2， key3 中的元素</li><li>sdiffstore：与 <code>LRPOPLPUSH</code> 类似，将 sdiff 的结果放到 dest set 中，注意，如果 dest 中有元素，则元素会被清空</li></ul><hr><blockquote><p>SINTER key key1 key</p><p>SINTERSTORE dest key key1 key2</p></blockquote><p>与 sdiff /sdiffstore 类似，这组命令是取 <strong>交集</strong></p><hr><blockquote><p>SUNION key1 key2 key3 …</p><p>SUNIONSTORE dest key1 key2 key3 …</p></blockquote><p>同样，这里取并集</p><hr><blockquote><p>SMOVE source dest ele</p><p>SREM key ele1 ele2</p></blockquote><ul><li>移动 source 中的 ele 到 dest 集合中</li><li>将 key 中元素 ele1 ele2 删除</li></ul><hr><blockquote><p>SRANDMEMBER / SPOP</p></blockquote><ul><li><p>srandmember key count ： 从 set 中随机取出元素</p><ul><li>0 ≤ count ≤ set length ：随机返回 count 个元素, <strong>无放回随机</strong></li><li>count &gt; set length ： 返回全部 set 元素</li><li>count 为负数时， 随机返回 count 个元素，此时为 <strong>有放回随机</strong> ， 这也意味着， count 可以为一个绝对值大于 set length 的负数。</li></ul></li><li><p>spop key count ： spop 的 count 不能为负数，其他行为与 srandmember 一致，spop 会同时删除取出的元素</p><hr></li></ul><blockquote><p>SSCAN key cursor [MATCH pattern] count</p></blockquote><p>是一个基于游标的迭代器。它会返回游标以及查询到的元素。</p><p>该命令保证</p><ul><li>从完整遍历开始到结束，所有存在于 key 中的元素都会被返回</li><li>开始前被移除且直到结束都未加入的元素，不会被返回</li><li>同一个元素可能被迭代多次</li><li>一个元素在迭代过程中被添加或删除，不保证一定返回或不返回</li></ul><hr><p>更多 Sets 相关命令参见 <a href="https://redis.io/commands#set" target="_blank" rel="noopener">这里</a></p><h3 id="4-Sorted-sets"><a href="#4-Sorted-sets" class="headerlink" title="4. Sorted sets"></a>4. Sorted sets</h3><p>sorted sets 底层主要基于 跳跃表 实现，关于跳跃表，作者表示也不是很清楚，需要先去加强一波学习，这里不再展开，可参考文末的 reference 系列文章。</p><p>sorted sets 与 sets 十分类似，但是 sorted sets 会给每个 element 添加一个 score，用来给元素排序。sorted sets 不允许相同的元素，但运行相同分数的元素。当查询多个相同分数的元素时，返回结果为元素的字典排序</p><blockquote><p>ZADD  key [XX|NX] [CH] [INCR] score ele …</p></blockquote><p>添加一个或多个元素到 sorted set。</p><p>XX ： 仅更新已存在的元素，不添加新元素</p><p>NX ： 只添加新成员，不更新已存在的元素</p><p>CH ： 返回发生变化的元素总数，不添加则返回添加的元素总数</p><p>INCR ： 相当于 ZINCRBY ，为元素分数做递增操作，使用该选项时，一次只能更新一个元素</p><hr><blockquote><p>ZCARD key </p><p>ZCOUNT key min max</p><p>ZSCORE key ele</p></blockquote><ul><li>zcard key 返回 key 所有元素数量</li><li>zcount key min mzx 返回指定 [min, max] 分数中的所有元素数量</li><li>查询给定元素分数</li></ul><hr><blockquote><p>ZLEXCOUNT key [min_ele [max_ele</p></blockquote><p>查询 min ele 和 max ele 之间的元素个数，包含本身，是闭区间！</p><ul><li>查询的元素前要加 <strong>[</strong>  ，如 <code>zlexcount sset [min [max</code></li><li><code>-</code> (减号) ， <code>+</code> (加号) 分别表示最小分数和最大分数元素， 如 <code>zlexcount sset - +</code> ，则返回 sset 这个 key 中的所有元素个数</li></ul><hr><blockquote><p>ZINTERSTORE dest num key1 key2 [weights] [aggregate] </p></blockquote><p>对 key1 key2 取交集，放入 dest 中，若 dest 已存在，则会清空 dest 后放入结果集</p><ul><li>num ，必须纳入交集计算的 key 的个数，这里 num 应该为 2</li><li>weights ： 在存入 dest 之前，会按照给定的 weights 与元素 <strong>相乘</strong> ，默认为 1</li><li>aggregate ： 聚合方式， MAX ， MIN ， SUM ，默认 SUM</li></ul><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> ZADD a 1 1 1 2 1 3<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> ZADD b 2 2 2 3 2 4<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3127.0.0.1:6379<span class="token operator">></span> ZADD c 3 3 3 4 3 5<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 3<span class="token comment" spellcheck="true"># 对 a 中交集的元素(3) 的分数(1) * 10 = 10，聚合方式为取最大值</span><span class="token comment" spellcheck="true"># 所以聚合结果是 ele=3 score=10</span>127.0.0.1:6379<span class="token operator">></span> ZINTERSTORE dest 3 a b c weights 10 1 1 aggregate MAX<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 1127.0.0.1:6379<span class="token operator">></span> ZRANGE dest 0 -1 withscores1<span class="token punctuation">)</span> <span class="token string">"3"</span>2<span class="token punctuation">)</span> <span class="token string">"10"</span></code></pre><hr><blockquote><p>ZPOPMAX / ZPOPMIN key [count]</p><p>ZRANGE / ZREVRANGE key start stop [withscores]</p><p>ZRANGEBYLEX / ZREVRANGEBYLEX  key [min [max [limit offset count]</p><p>ZRANGEBYSCORE</p></blockquote><ul><li><p>获取并删除给定 count 个元素，按照 score 的最大值 / 最小值排序</p></li><li><p>按照分数从小到大(zrevrange 从大到小) 排序，score 相同则按照字典序排列</p></li><li><p>zrangebylex ： 按字典排序，获取 [min, max] 中元素，<strong>不要在 score 不一致的 key 中使用该指令</strong>，因为获取的结果会不准</p><ul><li>min , max 参考 zlexcount 说明， 使用 <strong>(</strong>  获取开区间结果集</li><li>limit offset count ： 是否分页， offset ， count 分别为起始位置和返回结果数量</li><li>以 ASCII 字符集排序，所以对大小写敏感，对 utf-8 字符集不友好</li></ul></li></ul><hr><blockquote><p>ZRANK key element</p><p>ZREVRANK key element</p></blockquote><p>从小到大(zrevrank 从大到小) 获取指定 ele 的 index</p><hr><blockquote><p>ZREM key ele1, ele2 …</p><p>ZREMRANGEBYRANK key start stop …</p><p>ZREMRANGEBYLEX key min max</p><p>ZREMRANGEBYSCORE key min max</p></blockquote><ul><li>删除指定元素</li><li>按照给定索引删除</li><li>按照给定元素区间，按照字典序删除</li><li>按照给定分数区间删除</li></ul><hr><p>更多 Sorted Sets 相关命令参见 <a href="https://redis.io/commands#sorted_set" target="_blank" rel="noopener">这里</a></p><h3 id="5-Hashes"><a href="#5-Hashes" class="headerlink" title="5. Hashes"></a>5. Hashes</h3><p>hash 在 redis 底层是通过 dict 数据结构来实现的，即字典，java 中的 map ，都是类似的数据结构</p><pre class=" language-c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dictEntry <span class="token punctuation">{</span>    <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>    <span class="token keyword">union</span> <span class="token punctuation">{</span>        <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>        uint64_t u64<span class="token punctuation">;</span>        int64_t s64<span class="token punctuation">;</span>        <span class="token keyword">double</span> d<span class="token punctuation">;</span>    <span class="token punctuation">}</span> v<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// hash 冲突时，记录下一个节点</span>    <span class="token keyword">struct</span> dictEntry <span class="token operator">*</span>next<span class="token punctuation">;</span><span class="token punctuation">}</span> dictEntry<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dictht <span class="token punctuation">{</span>    dictEntry <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sizemask<span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">;</span><span class="token punctuation">}</span> dictht<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> dict <span class="token punctuation">{</span>    dictType <span class="token operator">*</span>type<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">;</span>    dictht ht<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 哈希表， 最多可能会维护两张哈希表</span>    <span class="token keyword">long</span> rehashidx<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* rehashing not in progress if rehashidx == -1 */</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> iterators<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* number of iterators currently running */</span><span class="token punctuation">}</span> dict<span class="token punctuation">;</span></code></pre><p>当出现 hash 冲突时， redis 会通过一个链表来处理。 </p><p>你还可以在 <a href="https://juejin.im/post/5d71d3bee51d453b5f1a04f1#heading-7" target="_blank" rel="noopener">这里</a> 看更详尽的解释</p><p>一个 hash 最多可包含 2<sup>32</sup> -1 个 k-v 对</p><ul><li>HSET key field1 v1 field2 v2 … ：新增/更新 kv</li><li>HSETNX key field value ：not exist，即不存在 field 时插入， key 不存在会新建</li><li>HGET key field ：获取 field 的 value , field 不存在时返回 nil</li><li>HGETALL key ：获取 key 中所有 kv</li><li>HDEL key field1 field2：删除指定 field</li><li>HEXISTS key field ：field 是否存在</li><li>HINCRBY key field step ： 增加 field 对应 value 值，不存在则新建该 field， step 作为值</li><li>HINCRBYFLOAT key field step ：同上，增加或新增 float 类型</li><li>HLEN key ：获取 key 的 field 个数</li><li>HKEYS key ： 获取 key 中所有 field</li><li>HVALS key ： 获取 key 中所有 value</li><li>HSTRLEN key field ：获取 field 对应 value 的长度</li><li>HMGET ： 获取多个 field 值，field 不存在时，返回 nil <code>hmget key field1 field1</code></li><li>HMSET ： 批量新增/更新 field，<code>hmset key field1 v1 field2 v2</code></li><li>HSCAN ： </li></ul><hr><p>更多 Hash 相关命令参见 <a href="https://redis.io/commands#hash" target="_blank" rel="noopener">这里</a></p><h3 id="6-其他命令"><a href="#6-其他命令" class="headerlink" title="6. 其他命令"></a>6. 其他命令</h3><p>bitmap， geo， hyperLogLog 参见 <a href="https://juejin.im/post/5aa72131518825556a7211af" target="_blank" rel="noopener">这里</a></p><p>更多命令参见  <a href="http://www.redis.cn/commands.html" target="_blank" rel="noopener">redis.cn</a>  or <a href="https://redis.io/commands" target="_blank" rel="noopener">redis</a></p><h2 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h2><p>当我们需要多个操作时， 通常的办法是，client  –&gt; op1 –&gt; redis –&gt; client –&gt; op2 –&gt; redis …</p><p>每次 op 操作，都需要先和 redis 建立连接，而后再操作。虽然连接建立耗时极短，但当网络不好时，仍然是一笔开销，而 <strong>pipeline</strong> 则可以很好的解决这个问题。</p><p>pipeline 和我们常说的管道基本一致，它能在 client 和 redis server 之间建立连接通道，而后每次操作都在该通道下进行，所有操作完成后，再关闭 pipeline</p><p>当我们通过 pipeline 操作数据时，需要注意操作的个数，因为 redis 需要耗费内存来组织需要返回的数据。所以我们需要控制 pipeline 内的 op 个数，分批处理。</p><p>pipeline 操作是非原子性的，如果要保证其原子性，可以通过 <code>multi exec</code> 来保证 </p><p>事实上， pipiline 能处理的事情，都可以通过脚本来处理，脚本还能够处理有依赖关系的数据。lua script 相比 pipeline ，要更灵活，同时能处理简单的业务。当然，我们不建议在 script 里处理耗时大的业务。</p><h2 id="PUBSUB"><a href="#PUBSUB" class="headerlink" title="PUBSUB"></a>PUBSUB</h2><p>在 redis 中， 通过几个简单的命令就可以实现 pub/sub 。</p><p>我们在一个 terminal 中使用 <code>subscribe</code> 命令</p><pre class=" language-bash"><code class="language-bash">127.0.0.1:6379<span class="token operator">></span> SUBSCRIBE chan1 chan2Reading messages<span class="token punctuation">..</span>. <span class="token punctuation">(</span>press Ctrl-C to quit<span class="token punctuation">)</span>1<span class="token punctuation">)</span> <span class="token string">"subscribe"</span>2<span class="token punctuation">)</span> <span class="token string">"chan1"</span>3<span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 11<span class="token punctuation">)</span> <span class="token string">"subscribe"</span>2<span class="token punctuation">)</span> <span class="token string">"chan2"</span>3<span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> 2<span class="token comment" spellcheck="true"># publish chan1 "From chan1" 后</span>1<span class="token punctuation">)</span> <span class="token string">"message"</span>2<span class="token punctuation">)</span> <span class="token string">"chan1"</span>3<span class="token punctuation">)</span> <span class="token string">"From chan1"</span></code></pre><p>该命令会阻塞监听两个 channel： chan1 和 chan2 ， 如果 channel 不存在，则会创建。</p><p>我们同样可以使用 <code>psubscribe</code> 命令来使用通配符监听 channel， 如 <code>psubscribe chan*</code></p><p>我们还可以通过 <code>unsubscribe</code> 和 <code>punsubscribe</code> (支持通配符) 来取消订阅</p><p>我们在另一个 terminal 通过 <code>publish chan1 value1</code> 发送消息，订阅方就能收到消息</p><p>在 redis 的 <code>server.h</code> 中，定义了一个用来存储 pubsub 数据的 key=channel , value=client 的 dict</p><pre class=" language-c"><code class="language-c">dict <span class="token operator">*</span>pubsub_channels<span class="token punctuation">;</span></code></pre><ul><li><p>当有 client subscribe 时， redis 就会往这个 dict 中添加 &lt;channel, client&gt; 的一堆键值对， 多个 client 注册同一个 channel 时， client 的存储就变成 dict 中的 list。</p></li><li><p>当有人 publish 值到 channel 时， redis 会先通过 channel 查询到对应的 client list ，然后依次发送给各个 client。</p></li><li><p>退订 channel 时， 只需要找到 channel 下的 client ，从 dict 中剔除即可</p></li></ul><p><strong>如果 publisher 在 publish 时没有 subscriber 监听，那么该条消息就会丢失。</strong></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://redis.io/" target="_blank" rel="noopener">redis 官网</a></li><li><a href="http://www.redis.cn/commands.html" target="_blank" rel="noopener">redis 中文</a></li><li><a href="https://redisbook.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener">redis 设计与实现 老版</a></li><li><a href="http://redisbook.com/" target="_blank" rel="noopener">redis 设计与实现 3.0 版</a></li><li><a href="https://juejin.im/post/5d71d3bee51d453b5f1a04f1" target="_blank" rel="noopener">深入了解 redis 底层数据结构</a></li><li><a href="https://juejin.im/post/5de3e841f265da05d03826ca" target="_blank" rel="noopener">图解 redis 五种数据结构底层实现</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PSSH 批量执行</title>
      <link href="/tools/pssh/"/>
      <url>/tools/pssh/</url>
      
        <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>工作，需要通过跳板机向多台 linux (已通过公钥做免密登录)添加 cron task。</p><h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><ol><li><p>安装 <strong>pssh</strong> 批处理工具</p><ul><li><a href="https://code.google.com/archive/p/parallel-ssh/downloads" target="_blank" rel="noopener">Download</a></li></ul></li><li><p>获取 <strong>/etc/hosts</strong> 中的 <strong>ip</strong></p><pre><code> cat /etc/hosts | awk '{pring $1}' | grep 'your regex' &gt;&gt; hosts.txt </code></pre></li><li><p>检查各台机器的 <strong>crontab</strong>           状态。如果有未服务未启动的，需要首先启动</p><pre><code> /bin/systemctl status crond.service</code></pre></li><li><p>将需要执行的 bash 脚本批上传到各机器:</p><pre><code> pscp -h hosts.txt /home/dylan/alert.sh /home/dylan</code></pre></li><li><p>通过 <strong>pssh</strong> 创建 <strong>cron</strong> 脚本并将 task 写入到 crontab 中:</p><pre><code> pssh -h hosts.txt -i 'cd ~;touch cron.cron;echo "* */2 * * * sh /home/dylan/your_bash.sh" &gt;&gt; cron.cron;crontab cron.cron'</code></pre></li><li><p>至此就完成了。如果要批取消，则:</p><pre><code> pssh -h hosts.txt -i 'cd ~;sudo sed -i "/alert.sh/d" /var/spool/cron/dylan;rm cron.cron'</code></pre><p> 脚本说明：创建的 <strong>crontab task</strong> 可以在文件 <strong>/var/spool/cron/dylan</strong> (dylan 为用户名) 中找到，上述脚本首先找到对应的 task 所在行，然后删除， 最后删除创建的脚本</p></li></ol><h2 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h2><p>请自行 google * . *</p><hr><hr><hr><h1 id="pssh-简介"><a href="#pssh-简介" class="headerlink" title="pssh 简介"></a>pssh 简介</h1><h2 id="Ref-1"><a href="#Ref-1" class="headerlink" title="Ref"></a>Ref</h2><ul><li><a href="https://code.google.com/archive/p/parallel-ssh/" target="_blank" rel="noopener">google groups</a></li><li><a href="https://www.cnmysql.com/post/74/" target="_blank" rel="noopener">使用PSSH批量SSH操作Linux服务器</a></li><li><a href="https://my.oschina.net/guol/blog/59977" target="_blank" rel="noopener">PSSH 批量管理服务器 - 好脑袋和烂笔头</a></li></ul><h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><ul><li><a href="https://code.google.com/archive/p/parallel-ssh/downloads" target="_blank" rel="noopener">Download</a></li></ul><h2 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h2><ul><li><p>在免密情况下</p><pre><code>pssh -i -h hosts.txt 'uptime'</code></pre></li><li><p>在密码情况下</p><pre><code>pssh -i -l root -a password -h hosts.txt 'uptime'</code></pre></li></ul><p>and others</p><h2 id="相关参数说明"><a href="#相关参数说明" class="headerlink" title="相关参数说明"></a>相关参数说明</h2><p>其实可以直接<code>pssh --help</code> &gt;.&lt;</p><ul><li>-h 执行命令的远程主机列表，或者 -H user@ip:port  文件内容格式[user@]host[:port]</li><li>-l 远程机器的用户名</li><li>-p 一次最大允许多少连接</li><li>-o 输出内容重定向到一个文件</li><li>-e 执行错误重定向到一个文件</li><li>-t 设置命令执行的超时时间</li><li>-A 提示输入密码并且把密码传递给ssh</li><li>-O 设置ssh参数的具体配置，参照ssh_config配置文件</li><li>-x 传递多个SSH命令，多个命令用空格分开，用引号括起来</li><li>-X 同-x 但是一次只能传递一个命令</li><li>-i 显示标准输出和标准错误在每台host执行完毕后</li><li>-I 读取每个输入命令，并传递给ssh进程 允许命令脚本传送到标准输入</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大西北之旅 -- 终章</title>
      <link href="/travels/xi-bei/"/>
      <url>/travels/xi-bei/</url>
      
        <content type="html"><![CDATA[<p>逛完青海湖，下一站是被称为天空之境的茶卡盐湖。可能是我们来的不是时候，见到的与宣传的差别很大。但走在铺满盐粒的路上，费力也十分有趣！<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409164513.jpg-growing" alt="茶卡盐湖"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409164526.jpg-growing" alt="盐帝"><br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="D:%5Ctools%5Ctypora%5Cimages%5C7763096-d8cc06d02d4b64c9.jpg" alt="图片发自简书App"></p><p>而后转战翡翠湖，那一块似乎还在开发中，路十分难开，异常颠簸。到达的时候，正好赶上日落。寒风中，瑟瑟发抖看完日落，日落的速度很快，你能感觉到夕阳在下降。难怪说夕阳无限好，只是近黄昏！<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409164547.jpg-growing" alt="夕阳染红的翡翠湖"></p><p>之后回到这一站的住宿点——青年旅馆。第一次住青年旅馆。四张床八个床位，和大一时的寝室颇有几分相似之处。不愧是大西北，暖气开的异常的足，闷得慌，感觉都快喘不过气了。只是后来不知怎么的就睡着了，早上起来头疼难受，吃了两片感冒药，继续下一站，敦煌。</p><p>不幸的是，同行朋友的车坏了！还好这边的高速没有围栏，我们把车停到两条路的中间，开始了一系列的救援措施。</p><p>先是向大卡车招手，寻求帮助看看车还有没有救，大卡司机一般都是老司机，经验丰富，只是都说车子不能再开了。而后找车行的人，和他们扯了半天，扯不出什么结果！这里要提醒各位租车的朋友，车子出了问题，<strong>第一时间联系平台，而不要联系租车公司</strong>！我们当时不知道，为此浪费了很多时间。后来找携程的工作人员，他们才真正的来解决我们的行程问题(其间也是各种扯皮，反正挺闹心的)。这事儿直到前段时间才算结束，吃一堑长一智，也算旅行中另一种风景了。</p><p>虽然是随机停下的地方，却也是风景满满，带着相机和朋友就去旁边浪去了。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409164638.jpg-growing" alt="大西北风味"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409164813.jpg-growing" alt="大西北风味"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409164823.jpg-growing" alt="大西北风情"></p><p>后来让妹子们去马路上拦车，程序猿不如程序媛啊！热心的人还是很多的，停下来问原因，帮我们看故障的车子，只是一般车上都满员了，也是无奈，夸张的时候，马路一边停了四五辆，不知道的，还以为这里也是一个景点了呢。<br>经过不懈努力，终于拦到了合适的车，是一对自驾出来玩的情侣，也是前往敦煌。于是乎继续出发。感谢热心车主！</p><p>由于车子问题，原定的莫高窟之旅只好作废，略遗憾。晚上加第二天上午，一直在和租车行扯皮，说好第二天早上送来的车毫无踪影，让我们自己想办法过去，也是无语！最后还是找民宿老板送我们到张掖，他们把车送到张掖。</p><p>中午开始启程到张掖，只是，在鸣沙山，稍稍多逗留了一会儿，玩嗨了。<br>鸣沙山位于沙漠边缘，在这儿可以见识到沙漠的样子。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165105.jpg-growing" alt="鸣沙山月牙泉"></p><p>第一次体验骑骆驼。一直把腰绷的紧紧的，后来牵骆驼的小哥实在看不下去，说要放松，把腰松下来，不会掉下去，果真如此。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165147.jpg-growing" alt="我高贵的头颅"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165205.jpg-growing" alt="骆驼群像"></p><p>而后本着好不容易来一次的心态，体验了把三四分钟四百八十元的滑翔机。真要说感受，除了失重时的害怕，其他都还好。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165227.jpg-growing" alt="滑翔起飞"></p><p>之后便赶往张掖，七彩丹霞也是我们的最后一站。这一站的住宿点是蒙古包，据说晚上还有篝火晚会，实在可惜的是，我们到的时候已经晚上十点多了，完美错过。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165241.jpg-growing" alt="丹霞蒙古包"></p><p>最后一日游——七彩丹霞。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165322.jpg-growing" alt="丹霞地貌"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165332.jpg-growing" alt="丹霞地貌"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165341.jpg-growing" alt="丹霞地貌"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165449.jpg-growing" alt="心愿"></p><p>心满意足，返程！路上经过连绵数百公里的祁连山脉，更是经历了春夏秋冬。山下还挺暖和的，只是随着一点点的攀爬，温度渐渐下降，最后飘起了小雪，而后越来越大。山顶白茫茫一片，着实震撼。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165549.jpg-growing" alt="四季之冬"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409165602.jpg-growing" alt="四季之冬"></p><p>一路攀爬最高到三千八百米，而后一路向下，终到西宁高铁站附近。还车，休整，返航！</p><p>十一之旅落下帷幕，大西北的苍凉和浩瀚实在震撼人心，与江南的小桥流水迥然不同。希望之后有机会去更多的地方，体验不同的风景，更希望这份心情，不因年龄的增长而消逝。</p><p>哦对了，西北实在干燥，如果有朋友想去，记得一定带润唇膏，血与泪的教训！</p><p>以上</p><p>于 2018.10</p><blockquote><p>以前发在简书的文章，可是最近简书莫名封了我的账号。又恰逢自己有了自己的 blog，便把之前的一些记忆拿了回来。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> 大西北 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大西北之旅 -- 青海</title>
      <link href="/travels/qing-hai/"/>
      <url>/travels/qing-hai/</url>
      
        <content type="html"><![CDATA[<p>下午从兵马俑赶去西安北站，和小伙伴们会合，下一站青海西宁。</p><p>随着火车不断靠近西宁，车上出现了十分有趣的现象：有人短袖，有人秋衣，有人冬装。只是到西宁后，能加的衣服都加了，虽然此时才十月一号。</p><p>到达西宁已是晚上七点多了，租的两辆车也已送到，一行人签好合同，便驱车前往早已预定好的民宿。</p><p>民宿主人是个很和善的阿姨，领着我们上楼、交代了几句后便离开了。民宿偏厅居然有麻将机。于是乎，几人轮番上阵，谁赢谁下。无奈技术出色加运气不赖，只好打一把歇一把。</p><p>第二日正式出发，第一站，日月山。</p><p>犹记刚看到西北地貌时，车里几个人的惊叫。开着开着，居然下起了小雪。而此时，已是到了日月山脚下了。我们稍作停留，下车去体验骑七彩牦牛，更是一激动，稍稍爬了下山。突然感到头晕目眩，才反应过来，此时已经海拔三千多米了！赶紧慢下来慢慢适应下。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409163505.jpg-growing" alt="七彩牦牛"></p><p>待爬上日月山时，雪又失去踪影，似不曾来过。而此刻只见日月山——传说中，由文成公主的宝镜所化。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409163513.jpg-growing" alt="日月山"></p><p>从日月山下来，便开往青海湖。沿途风光无限好。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409163604.jpg-growing" alt="大西北草原"></p><p>终于来到青海湖。一路上看到很多浪漫的骑行者。<br>各自观赏完后，打算一起拍个合照。打开三脚架，摆上相机，打算用延时摄影拍，弄了半天失败，又说可以手动控制，亦失败，请原谅几个新人。后来一个热心路人过来帮我们，无奈，鼓捣了半天，最后是用手机拍的，哈哈，开心就好了！<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409163639.jpg-growing" alt="青海湖"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409163707.jpg-growing" alt="青海湖"></p><p>等我们心满意足打算离去时，天已经快黑了。本打算去看日落，也是赶不到了。只是道路两边，风景满满。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409163728.jpg-growing" alt="黄昏"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409163831.jpg-growing" alt="黄昏"></p><p>路上经过一个很热闹的镇子，停下来吃饭，叫了羊肉，牦牛肉，各种肉。水足饭饱，继续赶往下一站。</p><p>以上</p><p>于 2018.10</p><blockquote><p> 以前发在简书的文章，可是最近简书莫名封了我的账号。又恰逢自己有了自己的 blog，便把之前的一些记忆拿了回来。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> 大西北 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>大西北之旅 -- 西安</title>
      <link href="/travels/xi-an/"/>
      <url>/travels/xi-an/</url>
      
        <content type="html"><![CDATA[<p>今年的十一格外浪。</p><p>十一之前和朋友讨论去哪里浪，一曰西藏，坐飞机过去。我怕一下飞机就高反，想着坐火车过去，慢慢悠悠，还有一路风景可看。岂料另一朋友提议大西北，妙，众狐朋狗友一拍即合。</p><p>想着虽途经西安却未停留，实在遗憾，遂与一同样遗憾的朋友请假两天，直奔西安。</p><p>一下高铁，找到事先定好的民宿，放下行李，便马不停蹄的出来浪了。钟楼，鼓楼，回民街，以及晚上鼓楼的灯光表演。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409160830.jpg-growing" alt="傍晚时分"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161005.jpg-growing" alt="入夜后"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161023.jpg-growing" alt="灯光表演"></p><p>回到民宿已经很晚了，再加上一天的奔波，很快入睡。<br>考虑之后从西安北站出发，我们重新找了个近点的酒店。于是，你在街上看到两个英俊潇洒，风流倜傥，玉树临风的美男子，一人拖着一个箱子，边走边逛。待到西安碑林附近，见一老爷爷和一女孩说着西安的人文历史，附近的景点特色，十分有趣，我俩就在旁边“偷听”。</p><p>可能老爷爷也来了兴致，说做回免费导游，领着我们转转。我们原本打算去酒店的，毕竟还拖着旅行箱，此时也义无反顾，跟着姑娘和老爷爷逛了起来。</p><p>老爷子实在有趣，学识也很丰富，每到一处，便跟我们讲相关的历史和故事。说碑林刻有孔庙二字墙下的两颗千年古树，说城墙突出来的马面趣事，说鼓楼外领导人接待国外选手的新闻。一路上给小姑娘拍照片，教我们如何取景、构图，还问两个傻小伙子拖着箱子累不累！到午饭的点儿了，我们打算找一个地儿，请老爷子吃一顿，老爷子来了句“七十不留饭”，就走了。实在是自在的人。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161109.jpg-growing" alt="西安碑林"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161158.jpg-growing" alt="城墙马面"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161231.jpg-growing" alt="小狮子"></p><p>于是乎，两个傻小子和一个潇洒的姑娘共进了一顿午饭。姑娘也是一个很有趣的人，一个人从济南跑到了西安旅游。于我，是肯定没有这样的执行力的。很多时候，都是想想，真到了要去执行的时候，多半还是能找到安慰自己的理由，然后放弃。</p><p>点了传说中的 biangbiang 面，一饱口福。不得不说面食确实不错。这几日尝了油波面，凉皮等，即使我是个平日里对面食无感，地地道道的南方人，也得竖起大拇指。只是不知道是不是饿的。我不禁推断，旅游时由于累和饿从而导致了一批美食出来。</p><p>本来打算吃完就去酒店，结果发现小雁塔就在几百米之内。哎，于是又拖着箱子行走在路人诧异的目光中。可喜的是，小雁塔可以免费存放物品，工作人员更是十分善意的跑过来告诉我们，很感谢。之后居然又见到了那姑娘。只可惜脸皮太薄，最终还是没好意思要联系方式。</p><p>漫步园中，身边都是几百上千年的古树。这些古树从历史的长河中走来，见证了一代代王朝的更替。而我此刻正和它们共同呼吸。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161608.jpg-growing" alt="小雁塔"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161619.jpg-growing" alt="历史见证者"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161644.jpg-growing" alt="生命"></p><p>终于迎来十月一号，一大早就起来，乘坐发往兵马俑的公交车。约摸一个小时，便到了秦始皇陵。外面有一座始皇帝的雕像，随后见到了心心念念的，古代人民用勤劳和智慧打造出来的奇迹——兵马俑。<br>历史，这两个字从前只是一门课程，此刻却异常深厚，也十分残酷。不知道当年的始皇帝，会不会想到后面发生的一切。始皇帝，却不曾想二世而亡。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161746.jpg-growing" alt="秦始皇"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161922.jpg-growing" alt="兵马俑群像"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409161952.jpg-growing" alt="无头俑"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409162015.jpg-growing" alt="女俑"></p><p>老爷子说，你在西安随便走到一个地方，可能搁其他省市都要重点保护，可在西安不会，西安的历史太厚重。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409162054.jpg-growing" alt="博物馆标语"></p><p>以上</p><p>于 2018.10</p><blockquote><p> 以前发在简书的文章，可是最近简书莫名封了我的账号。又恰逢自己有了自己的 blog，便把之前的一些记忆拿了回来。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> 大西北 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>游记 -- 越南岘港</title>
      <link href="/travels/yue-nan-xian-gang/"/>
      <url>/travels/yue-nan-xian-gang/</url>
      
        <content type="html"><![CDATA[<p>记得初中学过一篇文章叫《第一次真好》，里面有一句话</p><blockquote><p>生命中的第一次愈多，生命也就愈益多姿多彩</p></blockquote><p>这是第一次出国，也是第一次坐飞机，兴奋着也激动着，心里虽如此，脸上却要努力平静着，毕竟，不再是那个拿着糖就可以手舞足蹈的年纪了。而后开始检票、托运、安检等一系列的手续，终于到了候机大厅了，再等了约莫 20 分钟，开始登机了。飞机不大，座位更是狭小，一下子让我平静了下来，只是等到起飞时，又忐忑了起来，好在一路平安，再加上夜晚，外面黑乎乎的一片，除了声音大点外，一切都还可以。</p><p>飞行了约莫 4 个小时，便到了越南了。下飞机后，才知道有一个小时的时差，第一次切身体验了下时差，实在有趣，赶紧给小伙伴们发了条微信。落地很不巧，正下着大雨，以为这几日要在酒店度过了。跟着导游到了当地的一家五星级酒店，办理好入住手续后，终于可以好好的休息下了。只是第一次入住海景房，看着窗外的海景，实在迷人。</p><p>一夜好梦。</p><p>早晨起来，打开窗帘，映入眼帘的，是蓝天白云，和碧蓝的大海，瞬间被吸引住，第一次看海。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409155808.jpg-growing" alt="碧海蓝天"></p><p>唤醒同事，洗漱完毕，去到酒店二楼吃完早餐，便迫不及待的奔向前面的海滩了。<br>阳光，沙滩，海浪，还有我。站在沙滩边，任凭海浪一次次的冲刷过来，听着海浪的声音，感受着海风从面颊吹过，冲走的是烦恼，留下的是惬意和愉悦。<br>在沙滩呆了一会儿，之后在导游的带领下，开启打卡模式。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409160147.jpg-growing" alt="岘港龙桥"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409160202.jpg-growing" alt="群山"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409160209.jpg-growing" alt="椰树"></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409160217.jpg-growing" alt="越南观音菩萨"></p><p>傍晚时分，心血来潮，沿着沙滩线，跑了 2018 年的第一个十公里，大汗淋漓。虽然配速很慢，不过重在享受。第一次国外跑。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200409160234.jpg-growing" alt="健康跑步"></p><p>临走前一晚，总觉得少做了点什么。真切的感受到了越南的摩托车大军，吃到了特产海鲜，见识了大海。哦，是没有和大海来个亲切的接触！于是乎，叫上同事，在七八点钟的时候，走进了海里，浪来了，我岿然不动；浪来了，没事儿，小浪；浪来了，我去，这么大，被冲飞了，差点被吸下去！吓得我立马往后退了好几步。就这样，玩了一个多小时还意犹未尽！颇有“中流击水浪遏飞舟”之意。</p><p>最后一天早晨，起了个早，去沙滩上转一转，看见空着的沙滩椅，便躺了下，没多久，见一人过来，说了句英语，虽没听太懂，但大致意思是要收费的，此时才知道，这椅子原来不是随便躺的，立马起身走了，哈哈。</p><p>将拖鞋放到酒店前面的树下，赤着脚沿着沙滩晨跑了起来。突然看到零星的贝壳躺在沙滩上，顿时捡了起来，回来的路上更是没跑了，一来是想着再捡点贝壳，二来是脚底板是在是疼！最后拿着一手的贝壳，去餐厅和同事们一起吃早餐。一手的贝壳被同事分光，只留下了一个海螺(还好我事先把这唯一的小海螺收了起来)。吃完早餐，更是带着他们又去捡了一遍。只是几无收获。这就叫早起的鸟儿有虫吃吧。</p><p>下午，乘坐大巴奔赴机场，晚上八点多，落地萧山国际机场，三天的行程就此结束。</p><p>给我留下的，除了一个小海螺，还有我那晒伤的双脚(直接导致后面穿拖鞋上班)，以及那么多有趣的第一次。</p><p>以上</p><p>于 2018.9</p><blockquote><p>以前发在简书的文章，可是最近简书莫名封了我的账号。又恰逢自己有了自己的 blog，便把之前的一些记忆拿了回来。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> danang </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>西游亦西行 -- 藏区游记&lt;完&gt;</title>
      <link href="/travels/tibet-2/"/>
      <url>/travels/tibet-2/</url>
      
        <content type="html"><![CDATA[<p>都说南迦巴瓦峰终年云雾缭绕，不肯露出真面目，故而得名羞女峰。</p><p>可能是我们这群人确实运气不错，开车的师傅也说很难得，我们到林芝的那天傍晚，就看到了藏于云雾之后的真容，虽然只露出了很短的时间。</p><p>很美丽。</p><p>可是我却更喜欢路上遇到的一个多雄拉雪山。</p><p>傍晚时分，夕阳下山，可是藏区的夕阳，并非如江南那般柔和。我坐在车里，看着窗外的景色。也不知为什么，就抬起了头，就见那座雪峰立在那里。阳光透过它尖上终年不化的积雪，使得那本就洁白的雪，竟显得圣洁起来。我盯着看了很久，以至于忘了喊师傅停下来拍张照片。</p><p>是的，这个时候，我们往往会选择用照片来记录下这些美好的瞬间。只是这次，我得记在心里了。</p><p>我们在这个小村庄里呆了一宿，第二天就继续上路了。</p><p>去了巴松措，去了色季拉山，去了传说中的羊湖，去了日喀则，去了绒布寺，顺便在珠峰大本营住了一晚上。</p><p>要不怎么说我们运气好，师傅说大本营那几天才开放！</p><p>我现在还记得，在海拔 5000 米的大本营，我激动的忘记了缺氧这回事儿。一个人在那跳来跳去，跑来跑去。从住的帐篷跑到绒布寺，又从绒布寺跑到珠峰的界碑那，快哉。</p><p>我们在刻有 8844.43 的界碑那拍照，身后就是传说中的珠峰。</p><p>等我在外面溜达完回到帐篷时，几个小伙伴都在那安静的整理一路上的照片。</p><p>晚上睡觉的时候，本以为经过好几个晚上的磨练，已经可以适应了。可还是小看了这 5000 米海拔的厉害。</p><p>终于熬到凌晨四点左右，拉着几个小伙伴哆哆嗦嗦的跑起来，去拍星星去了。</p><p>冷，是真的冷。</p><p>夜空的星星，确实比平日里看到的要多的多。只是小时候，夏天的夜晚，星星也出奇的多，出奇的亮。</p><p>我们几个人，就在瑟瑟寒风中，一边拍着延时，一边低声聊着天。</p><p>从大本营下来后，整个的藏区之行，差不多就要结束了。</p><p>下来后，同行的一个姑娘，虽然是个南方女孩子，却甚是豪爽的在吃饭的时候，拉着我们喝起了酒，自然是啤酒。</p><p>只是熟悉我的人都知道，酒量巅峰期应该是大学那会儿，曾经喝过一瓶多的啤酒，喝完回宿舍后，就去厕所吐了。然而此刻，却是真切的觉得，就该喝一点。</p><p>好在师傅很克制，知道明天还要开车上路，就每个人都只喝了一点。嗯，那自然是对他们而言！于我，虽然我忘记喝了多少，但是回去后，我就全身泛红，头晕脑胀了。</p><p>那个时候，我只想着睡一觉，可是那几个家伙，却偏偏要打掼蛋！作为一个头晕脑胀且基本不会打掼蛋的人而言，和他们打了好一会儿。</p><p>只是这段时光，此刻想起来，异常怀念。</p><p>突然想起一八年的元旦，和几个朋友去黄山玩，也是在回来的前一个晚上，打了好一会儿牌，最后房东打电话来，说有旅客投诉我们太吵了。。。</p><p>不过这次自是没有人投诉的。</p><p>后面回到拉萨，每个人都买了一堆的牦牛干什么的土特产，送同事，送朋友，自己享用，都是不错的选择。</p><p>再后面，就是师傅大清早的，送我们去贡嘎机场。</p><p>而后我们就离西藏越来越远。</p><p>而后我们几个小伙伴也各自分别。</p><p>每个去西藏的人，都盼着能洗涤心灵。只是，给我的感动，随着时间的推移，已寥寥无几。多出来的，只是和别人的谈资。</p><p>或许在某个阳光明媚的下午，我坐在电脑面前敲代码，偶尔闭上眼睛，会不经意想起这段旅程来。</p><p>以上</p><p>于 2019.4</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> tibet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>西游亦西行 -- 藏区游记</title>
      <link href="/travels/tibet/"/>
      <url>/travels/tibet/</url>
      
        <content type="html"><![CDATA[<p>不知不觉，进藏已三日有余。</p><p>记得飞机降落在贡嘎机场，一直当心的高反没有发生后，是雀跃的。只是随后的一系列不适，让我记忆犹新。</p><p>当晚到达酒店后，没有洗澡(进藏后不要轻易洗澡)，简单洗漱后直接入睡。然而伴随而来的是一两个小时就醒来一次的简短睡眠，心脏加速，头疼。只盼着早点天亮，就不用再睡觉了。</p><p>太阳终究还是缓缓升了起来，我也终于不用继续躺在床上。有趣的是，当我走出酒店，之前所有的不适统统消散，我们去吃早餐，喝甜茶，漫步于西藏街道，流连在布达拉宫。</p><p>一路上看着或捻动佛珠，或转动转经筒，或三步一扣的人们，肃穆而虔诚。在这里，你能够真真切切的看到信仰。在大昭寺，众多的信徒们在行着跪拜礼朝圣。有戴着眼镜斯斯文文的青年，有穿着时尚结伴而行的夫妻，有头扎长辫一身艺术气息的独行者，还有年迈沧桑的老人，你无法知道他们各自的目的，是寻求内心的安宁，是渴望佛祖的帮助，是逃离生活的苦难，还是仅仅传下的一种仪式。不管是什么，他们都在自己的信仰下，昂首前行。</p><p>我在朋友圈写到</p><blockquote><p>现在，亲眼看着朝圣者们三步一跪，一心向前，仿佛这个世界，可以简单到他和他心中的信仰，再无其他。</p></blockquote><p>其中一个朋友留言问我说，你有信仰么？坦白说，我是没有的。如果硬要说有，那无非是信奉钱。我们从小到大接受到的教育，包括各路媒体吹捧的所谓成功，都在有意无意的告诉我们钱的魅力。很显然，我接受了这样的认知。</p><p>这些也只是对我价值观的一次冲击，并不会毁灭掉。我想回去之后，还是会和往常一样。当然，若是能因此有一些改变，那自是最好不过了。</p><p>晚上拍完布达拉宫的夜景，打算回去时，才通过电话得知有人感冒。都说高原地区的感冒很可怕，要十分当心。我们便立马赶去医院。好在打针加吃药加贴各种退烧贴后，好了起来。可是我倒下了。</p><p>晚上的睡眠依旧和挤牙膏一样。早晨打算起来时才发现，一点都不想动，头疼，晕，心脏快速跳动以抗议这个身体的主人，起来没走几步就想吐。在吐了好几口口水，以及同伴们各种药物的支撑下，终于慢慢好了起来。</p><p>沿途去办理边防证的时候，我沿着河边慢慢散步，身边偶尔经过几个晨跑者，内心也跃跃欲试。于是在海拔 3600 多米的拉萨，跑了不到一百米，立马就开始大口喘气，只能立即停下来。</p><p>你除了想到呼吸，感受到头疼，其他的似乎一下子都不见了。</p><p>晚上的篝火舞会，也慢慢让旅行变得欢快起来。看着老大爷们载歌载舞，无论是不是工作需要，我想，当下，他们都是开心的。我也希望在那个年纪，依旧有着一颗年轻的，躁动的内心。</p><p>很多时候，我们都习惯以自己的认知去评判一些事情。就好像我觉得公务员一直很轻松一样，就好像我觉得那个跳舞的大叔一直很快乐一样。</p><p>西藏之旅继续。</p><p>以上</p><p>于 2019.4</p><blockquote><p> 以前发在简书的文章，可是最近简书莫名封了我的账号。又恰逢自己有了自己的 blog，便把之前的一些记忆拿了回来。</p></blockquote><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> travels </category>
          
      </categories>
      
      
        <tags>
            
            <tag> travels </tag>
            
            <tag> tibet </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part 4 --ZooKeeper Zab Protocol</title>
      <link href="/zookeeper/zab/"/>
      <url>/zookeeper/zab/</url>
      
        <content type="html"><![CDATA[<h1 id="ZooKeeper-lt-四-gt-ZAB-协议"><a href="#ZooKeeper-lt-四-gt-ZAB-协议" class="headerlink" title="ZooKeeper<四> ZAB 协议"></a>ZooKeeper&lt;四&gt; ZAB 协议</h1><p>zab 协议全称 ZooKeeper Atomic Broadcast Protocol 。</p><p>它作为 zk 最核心的协议，贯穿了 zk 的始终。    </p><p>我们知道 zk 从启动到挂掉，无非做这么几件事：</p><ul><li>选举 leader</li><li>发现 server</li><li>同步 事务</li><li>广播 事务</li><li>崩溃再选举</li></ul><p>而 zab 则是这些事情的保障，它让所有的事情按照我们期待的方向行进。现在去看看 zk 究竟是如何去做这些事情的。</p><h2 id="Election"><a href="#Election" class="headerlink" title="Election"></a>Election</h2><p>前文已经介绍，zk 使用 FLE 进行选举，是现在 zk 唯一支持的选举算法。这里不再赘述。</p><p>其他阶段，这里分 Leader  和 Follower 两个角色进行解读。</p><h2 id="Leader"><a href="#Leader" class="headerlink" title="Leader"></a>Leader</h2><h3 id="1-Discovery"><a href="#1-Discovery" class="headerlink" title="1. Discovery"></a>1. Discovery</h3><p>我们前面解析源码的时候，在 <code>QuorumPeer</code> 这个类里，说过它的 <code>run</code> 方法，里面有个 <code>switch...case</code> ，会对 <code>serverState</code> 的不同状态，做不同处理。</p><p>当时我们看了 <code>LOOKING</code> 的 case，因为这里是 election 的入口。</p><p>现在选举结束后，<code>serverState</code> 会切换成其他状态，同时 zabState 也同样会切换</p><p>我们再来看下这个<code>run</code> 方法(截取部分)：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 源码参考： org.apache.zookeeper.server.quorum.QuorumPeer#run</span><span class="token keyword">case</span> LEADING<span class="token operator">:</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token function">setLeader</span><span class="token punctuation">(</span><span class="token function">makeLeader</span><span class="token punctuation">(</span>logFactory<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 这个方法里有一个 while ，如果退了出来，</span>        <span class="token comment" spellcheck="true">// 说明该 server 的领导结束，会进行下一次的选举</span>        leader<span class="token punctuation">.</span><span class="token function">lead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">setLeader</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Unexpected exception"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>            leader<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token string">"Forcing shutdown"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">setLeader</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里会把 serverState 重新置为 LOOKING 状态</span>        <span class="token comment" spellcheck="true">// 从而在整个 while 里再次发起选举</span>        <span class="token function">updateServerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>好，从上面能看到，被选为 leader 后，所有的奥秘，都在 <code>leader.lead()</code> 这个方法中了。现在去看看这个家伙，究竟背着我们都做了些什么！！！</p><p>我看了下这个方法， 从 576 行到 874 行，共计 <code>874 - 576 = 298</code> 行，我们平时这么写代码，估计会被打死，然后领导们说，你这个方法怎么能写这么多行呢！！！ 啊哈哈哈 :joy:</p><p><strong>整个阶段都需要对照：</strong></p><pre><code>org.apache.zookeeper.server.quorum.LearnerHandler#run</code></pre><p><strong>LearnerHandler</strong> ，会为每一个跟随者分配一个连接，负责和 server 整个生命周期间的通信。</p><p>同时注意 <code>Leader</code> 和 <code>LearnerHandler</code> 在几个关键节点的同步：</p><ul><li><p>getEpochToPropose：handler 会获取超过半数的 server epoch，一次产生 leader 新的 epoch </p></li><li><p>waitForEpochAck ： handler 会获取超过半数的 server ack ，以此为基础进行同步</p></li><li><p>waitForNewLeaderAck：等待 server 同步的结果。整个同步过程，都是 handler 负责处理的。</p></li></ul><p>正是通过这几个方法，使得虽然是异步进行，但最终在关键节点上，都会等待各自完成各自的事情！！！</p><pre class=" language-java"><code class="language-java">self<span class="token punctuation">.</span><span class="token function">setZabState</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>ZabState<span class="token punctuation">.</span>DISCOVERY<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>可以看到，这个方法开始时，将 <code>zabState</code> 的状态设置为了 <code>DISCOVERY</code> ，也就是说，zk 正式从选举阶段进入到发现阶段：</p><pre class=" language-java"><code class="language-java">self<span class="token punctuation">.</span><span class="token function">setZabState</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>ZabState<span class="token punctuation">.</span>DISCOVERY<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 这里把自己的 epoch 和 zxid 放到 StatueSummary 中，方便之后的比较</span>leaderStateSummary <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StateSummary</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getCurrentEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> zk<span class="token punctuation">.</span><span class="token function">getLastProcessedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 开启线程接受 followers 的连接</span>cnxAcceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LearnerCnxAcceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cnxAcceptor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 这个方法用于获取 epoch ， +1 即为新 leader 的 epoch ，它的国号！--- [1]</span><span class="token keyword">long</span> epoch <span class="token operator">=</span> <span class="token function">getEpochToPropose</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// zk 在获取到所有连接中最大的 epoch 后，+1 ， 然后低 32 位清零，即为新的 zxid</span>zk<span class="token punctuation">.</span><span class="token function">setZxid</span><span class="token punctuation">(</span>ZxidUtils<span class="token punctuation">.</span><span class="token function">makeZxid</span><span class="token punctuation">(</span>epoch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// ...</span><span class="token comment" spellcheck="true">// 等待超半数的 server 的 epoch ack， 确认新的 epoch 下发到半数以上的 server</span><span class="token comment" spellcheck="true">// 这里的处理方式和上面获取最大 epoch 一样</span><span class="token comment" spellcheck="true">// zk 认为，等到足够多的 epoch ack 后，选举才算结束</span><span class="token function">waitForEpochAck</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> leaderStateSummary<span class="token punctuation">)</span><span class="token punctuation">;</span>self<span class="token punctuation">.</span><span class="token function">setCurrentEpoch</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">;</span>self<span class="token punctuation">.</span><span class="token function">setLeaderAddressAndId</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getQuorumAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>self<span class="token punctuation">.</span><span class="token function">setZabState</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>ZabState<span class="token punctuation">.</span>SYNCHRONIZATION<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>到这里， <code>Discovery</code> 阶段就结束了。我们总结下 <strong><code>Discovery</code> 阶段， leader 主要做了什么</strong>：</p><ul><li>获取最新的 epoch<ul><li>收到 FOLLOWERINFO 或者  OBSERVERINFO 类型的 qp (quorum packet)</li><li>统计并获取最大的 epoch，设置新的 epoch</li><li>回复 LEADERINFO 类型的 qp ，同时把新的 epoch 告诉当前的 server</li></ul></li><li>获取超过半数的 server 的连接(waitForEpochAck)：<ul><li>handler 等待 follower/observer  ACKEPOCH 类型的回复，超过半数表明新的 epoch 设置成功</li></ul></li></ul><h3 id="2-Synchronization"><a href="#2-Synchronization" class="headerlink" title="2. Synchronization"></a>2. Synchronization</h3><pre class=" language-java"><code class="language-java">self<span class="token punctuation">.</span><span class="token function">setZabState</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>ZabState<span class="token punctuation">.</span>SYNCHRONIZATION<span class="token punctuation">)</span><span class="token punctuation">;</span>    </code></pre><p>这里开始， zab 协议进入到同步阶段，我们看看同步阶段， leader 都会做哪些事情：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">/** 与 [1] 一摸一样的处理方式， 获取超过半数的 ack，我们去查看这个方法的调用，能看到在 learnerHandler 中被调用了，而在调用之前，learnerHandler 做的事情就是和与之连接的 server 进行同步*/</span><span class="token function">waitForNewLeaderAck</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> zk<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 这里会开启 leader 的事务处理责任链 --- [2]</span><span class="token function">startZkServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">// 这里就是在 how-to-use 中介绍的配置，设为 yes(默认)，即表明 leader 也会接受 client 连接</span><span class="token comment" spellcheck="true">// 将 zkServer 放入到 ServerCnxFactory 中</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>System<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"zookeeper.leaderServes"</span><span class="token punctuation">,</span> <span class="token string">"yes"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    self<span class="token punctuation">.</span><span class="token function">setZooKeeperServer</span><span class="token punctuation">(</span>zk<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 这就到 BROADCAST 了？？？</span><span class="token comment" spellcheck="true">// 是的，因为我有助手 learnerHandler</span>self<span class="token punctuation">.</span><span class="token function">setZabState</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>ZabState<span class="token punctuation">.</span>BROADCAST<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>这里先介绍下同步时的几种类型(可以同时思考下，分别什么情况，会导致下面的类型处理)：</p><ul><li>DIFF：差异同步</li><li>TRUNC：回滚同步</li><li>SNAP：全量同步</li></ul><p>这个时候，我们去看 <code>LearnerHandler</code>  从 <code>waitForEpochAck</code> 到 <code>waitForNewLeaderAck</code> 中间部分的代码</p><h4 id="syncFollower"><a href="#syncFollower" class="headerlink" title="syncFollower"></a><code>syncFollower</code></h4><p><code>org.apache.zookeeper.server.quorum.LearnerHandler#syncFollower</code></p><ol><li><p>leader lastProcessedZxid == peerLastZixd： 说明事务一致，无需同步，此时 leader 会发送一个空的 DIFF qp 给 follower</p></li><li><p>peer lastProcessedZxid 在 [minCommittedLog, maxCommittedLog] 之间，这个区间是 zk 维护的一份 commit queue，用来快速与各 server 同步。在此之间说明 peer 的事务与 leader 之间存在差异，zk 会先发一个 DIFF qp 给 server ，然后将区间中比 peer zxid 大的事务，以 Proposal 的方式发送给 server，server 收到后，回复 ack </p></li><li><p>peer lastProcessedZxid &gt; maxCommittedLog 时，就需要进行 trunc ，同上，也是先发送 TRUNC qp，然后通过 Proposal 进行回滚同步</p></li><li><p>peer lastProcessedZxid &lt; minCommittedLog 时，zk 会先尝试 <code>on-disk txnlog + committedLog</code> 的方式进行同步，如果失败，则使用 <strong>SNAP</strong> 的方式进行同步。 SNAP 会从磁盘读取 <code>snapshot.xxx</code> 命名的文件，序列化后发送给 server</p></li></ol><p>上述同步完成后，leader 会发送一个 <code>NEWLEADER</code> qp 给 server，告知同步结束，得到足够 server 的 ack 回复后(这里就是 leader 和 learnerHandler 的一个同步点，也就是方法 <code>waitForNewLeaderAck</code>)，leader 将执行 <code>startZKServer</code> 方法，而此可的 <code>learnerHandler</code> 也会等待 zkServer 的启动。</p><h4 id="startZkServer"><a href="#startZkServer" class="headerlink" title="startZkServer"></a><code>startZkServer</code></h4><p><code>org.apache.zookeeper.server.quorum.Leader#startZkServer</code></p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 来源于基类 org.apache.zookeeper.server.ZooKeeperServer#startup</span><span class="token comment" spellcheck="true">// 截取部分代码</span><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 这里就是上文提到的 leader 处理事务的责任链</span>    <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 设置 zk 状态</span>    <span class="token function">setState</span><span class="token punctuation">(</span>State<span class="token punctuation">.</span>RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// 通知所有等待在该对象上的线程</span>    <span class="token comment" spellcheck="true">// 这些线程即负责与各个 server 连接的 learnerHandler</span>    <span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p><code>zkServer</code> 启动后， learnerHandler 就会发送一个 <code>UPTODATE</code> 的报文给各个 server ，告诉他们，我们准备好了，可以开门接客，啊呸，可以接受 client 的连接了。</p><h3 id="3-Broadcast"><a href="#3-Broadcast" class="headerlink" title="3. Broadcast"></a>3. Broadcast</h3><pre class=" language-java"><code class="language-java"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 检查 quorumPeer 和 zkServer 的状态，不对劲就会跳出 while</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// follower 未超过半数，跳出 while</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tickSkip <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>syncedAckSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 定时发送 ping 报文</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span>LearnerHandler f <span class="token operator">:</span> <span class="token function">getLearners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        f<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// 如果从 while 跳出，这里的 msg 会有值，代码被我精简了</span><span class="token keyword">if</span> <span class="token punctuation">(</span>null <span class="token operator">!=</span> shutdownMessage<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">shutdown</span><span class="token punctuation">(</span>shutdownMessage<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这是 leader.lead() 方法去做的，可是我们已经知道，leader 和 server 之间的工作，大部分都由 learnerHandler 在处理。所以这个时候，我们还得去看看 <code>learnerHandler</code> 在搞些什么事情</p><pre class=" language-java"><code class="language-java"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ia<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> Leader<span class="token punctuation">.</span>ACK<span class="token operator">:</span>        <span class="token comment" spellcheck="true">// ...</span>    <span class="token keyword">case</span> Leader<span class="token punctuation">.</span>PING<span class="token operator">:</span>        <span class="token comment" spellcheck="true">// ...</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> Leader<span class="token punctuation">.</span>REVALIDATE<span class="token operator">:</span>        <span class="token comment" spellcheck="true">// ...</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> Leader<span class="token punctuation">.</span>REQUEST<span class="token operator">:</span>        <span class="token comment" spellcheck="true">// ...</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token keyword">default</span><span class="token operator">:</span>        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"unexpected quorum packet, type: {}"</span><span class="token punctuation">,</span> <span class="token function">packetToString</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>可以看到， learnerHandler 通过 switch…case… 来处理来自 server 的各个类型请求，一旦出了问题，就会抛出异常，最后在 finally 代码块中，shutdown</p><h2 id="Follower"><a href="#Follower" class="headerlink" title="Follower"></a>Follower</h2><p>对于 Follower 而言，同样要从  <code>QuorumPeer</code> 的 run 方法的 switch…case… 代码块入手，这里就不再贴代码了，就简单梳理下大致的流程，以及各个阶段和 leader 的通信。</p><h3 id="1-Discovery-1"><a href="#1-Discovery-1" class="headerlink" title="1. Discovery"></a>1. Discovery</h3><ul><li><p>Follower (下文以 F 代替)，通过 <code>org.apache.zookeeper.server.quorum.Learner#connectToLeader</code> 与新 leader 建立 TCP 连接。</p></li><li><p>F 发送 <strong>FOLLOWERINFO</strong> 类型 qp 给 leader(如果是 observer ，发送的类型为 OBSERVERINFO)，被 <code>learnerHandler</code> 接收。</p><p>前文提到 leader 在执行 lead 方法的时候，会先去创建 <code>LearnerCnxAcceptor</code> –&gt;  <code>LearnerCnxAcceptorHandler</code> –&gt; <code>LearnerHandler</code> , 这一些列代码执行后，就在等待 F 连接并发送 FOLLOWERINFO  报文。这是他们通信的第一个报文，如果不是，这个连接就会被 leader 舍弃掉</p></li><li><p>等待 leader 的 <strong>LEADERINFO</strong> qp， 该报文含有 leader 的最新 epoch ，所以 F 设置新的 epoch，同时发送 <strong>ACKEPOCH</strong> 类型 qp 给 leader</p></li></ul><p>discovery 阶段结束</p><h3 id="2-Synchronization-1"><a href="#2-Synchronization-1" class="headerlink" title="2. Synchronization"></a>2. Synchronization</h3><p>leader 通过 <code>learnerHandler</code> 发送的同步标志(DIFF/TRUNC/SNAP) ，进行不同的处理和回复，在 <code>org.apache.zookeeper.server.quorum.Learner#syncWithLeader</code> 中，我们可以看到不同的处理方式。</p><p>同步结束后， leader 会发送一个 <strong>NEWLEADER</strong> qp 给 F，F 回 ACK， leader 收到超半数 ack 后，发送 <strong>UPTODATE</strong> qp，F 收到该类型的 qp 后，会跳出 while 循环：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">case</span> Leader<span class="token punctuation">.</span>UPTODATE<span class="token operator">:</span>    <span class="token keyword">break</span> outerLoop<span class="token punctuation">;</span></code></pre><p>后续代码会回复 ACK，同时启动 zkServer：</p><pre class=" language-java"><code class="language-java">ack<span class="token punctuation">.</span><span class="token function">setZxid</span><span class="token punctuation">(</span>ZxidUtils<span class="token punctuation">.</span><span class="token function">makeZxid</span><span class="token punctuation">(</span>newEpoch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">writePacket</span><span class="token punctuation">(</span>ack<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>sock<span class="token punctuation">.</span><span class="token function">setSoTimeout</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>tickTime <span class="token operator">*</span> self<span class="token punctuation">.</span>syncLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>self<span class="token punctuation">.</span><span class="token function">setSyncMode</span><span class="token punctuation">(</span>QuorumPeer<span class="token punctuation">.</span>SyncMode<span class="token punctuation">.</span>NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>zk<span class="token punctuation">.</span><span class="token function">startup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>而 F 的 zkServer ，同样会开启一条事务处理的责任链：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    RequestProcessor finalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitProcessor</span><span class="token punctuation">(</span>finalProcessor<span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">getZooKeeperServerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    firstProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FollowerRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> commitProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">(</span><span class="token punctuation">(</span>FollowerRequestProcessor<span class="token punctuation">)</span> firstProcessor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    syncProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendAckRequestProcessor</span><span class="token punctuation">(</span><span class="token function">getFollower</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    syncProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>通过代码可以看到，F 的责任链如下：</p><ul><li><p>FollowerRequestProcessor –&gt; CommitProcessor –&gt; FinalRequestProcessor</p></li><li><p>SyncRequestProcessor –&gt; SendAckRequestProcessor</p></li></ul><p>通过这些责任链，将一条事务的处理变得分工明确。</p><h3 id="3-Broadcast-1"><a href="#3-Broadcast-1" class="headerlink" title="3. Broadcast"></a>3. Broadcast</h3><p><code>syncWithLeader</code> 执行完毕，也就是同步完成后， F 就进入到广播阶段。</p><p>如果该 F 配置了 <code>observerMasterPort</code> ，这里还会启动一个 <code>ObserverMaster</code> 线程，用来与 observer 事务同步</p><pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getObserverMasterPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObserverMaster</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> fzk<span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">getObserverMasterPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    om<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">readPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">processPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里同样，通过 while ，保持与 leader 之间的联系</p><h2 id="一条写事务"><a href="#一条写事务" class="headerlink" title="一条写事务"></a>一条写事务</h2><p>我们已经知道，<code>ServerCnxnFactory</code> (我们没有配置 netty ，这里指 NIOServerCnxnFactory)，负责整个生命周期与 client 的连接。先看下 <code>NIOServerCnxnFactory</code> 的类图：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200410190237.png-growing" alt="NIOServerCnxnFactory"></p><p>继承自 <code>ServerCnxnFactory</code> ，内部主要有：</p><ul><li>IOWorkRequest：负责处理 IO 的读写( m 个，可配置，默认 核数*2 )</li><li>ConnectionExpirerThread：负责清理与客户端的 异常/失效/过期 连接 (1 个线程)</li><li>AcceptThread：负责接收来自 client 的连接并分配给 selectorThread (1 个线程)</li><li>SelectorThread：负责与 client 的连接处理( n 个，可配置，或者取 核数/2 的平方根)</li></ul><p>当客户端请求过来后，由 selectorThread 交由 IOWorkRequest(事实上，IOWorkRequest 线程池处理) 的 doWork 处理，doWork 处理后，交由 NIOServerCnxn 的 doIO 处理，该类真正负责与 client 的通信。若是接收 client 的信息，则交由该类的 readPayload 处理，它简单处理后，再给 readRequest(or readConnectRequest) 方法：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">readRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>    zkServer<span class="token punctuation">.</span><span class="token function">processPacket</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> incomingBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这个方法很简单，就i是把这个 request 交给 zkServer 处理，最终会添加到：</p><pre class=" language-java"><code class="language-java">LinkedBlockingQueue<span class="token operator">&lt;</span>Request<span class="token operator">></span> submittedRequests <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token operator">&lt;</span>Request<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>而这个属性，会由该类，也就是 <code>RequestThrottler</code> 线程的 run 方法处理，通过 take() 方法，阻塞，直到有消息过来。</p><p>最终会交由 <code>ZooKeeperServer</code> 来处理：</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// org.apache.zookeeper.server.ZooKeeperServer#submitRequestNow</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitRequestNow</span><span class="token punctuation">(</span>Request si<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 这里可以看到，这个消息交给了 Follower 的责任链处理</span>        firstProcessor<span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MissingSessionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">requestFinished</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RequestProcessorException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">requestFinished</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>到了这里，我们基本能理清，从 client 发出一个消息，到最终这个消息被处理的流程</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200410221247.png-growing" alt="zk"></p><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><h3 id="1"><a href="#1" class="headerlink" title="[1]"></a>[1]</h3><pre class=" language-java"><code class="language-java">cnxAcceptor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LearnerCnxAcceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cnxAcceptor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> epoch <span class="token operator">=</span> <span class="token function">getEpochToPropose</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>我们来说下这三行。</p><p>前两行用于开启线程，接受 followers 的连接。接受连接是干嘛的？</p><p>我们知道， 新的皇帝会有新的年号，zk 中新的 leader 也会更新自己的 epoch 。</p><p>假设集群中有一个与世隔绝的 C follower ，一直没有获取到 leader 的 epoch 。而之后这个 leader 挂掉了，恰巧这个 C 当选为新的 leader ，它要产生自己的 epoch ，怎么办呢？直接在自己的 epoch 上加一？</p><p>那肯定不行！你不能确定这个 epoch 有没有被其他 leader 用过！</p><p>zk 通过上面三行，还获取 ensemble 中最新的 epoch，也就是当前 ensemble 中最大的 epoch ，之后加一后用作新的 epoch 。</p><p>这里整体的处理，在 zk 中，这种处理方式很常见。</p><p>如果是我写，肯定会先去等待所有的连接，超过半数后，统计所有的 epoch ，然后和自己的 epoch 一起比较，获取最大的 epoch，加一，成为新 leader 的 epoch 。</p><p>嗯，十分凡夫俗子的想法。</p><p>我们看看这帮一个方法写了几百行的家伙是怎么做的。</p><ol><li><p>先通过 <code>LearnerCnxAcceptor</code> 这个类，去开启 <code>learnerHandler</code> ，这个是用来处理其他 server 的连接的，然后在这个 handler 里获取最新的 epoch，嗯哼，epoch 可是还没产生哦！</p><pre class=" language-java"><code class="language-java"><span class="token keyword">long</span> zxid <span class="token operator">=</span> qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> newEpoch <span class="token operator">=</span> learnerMaster<span class="token punctuation">.</span><span class="token function">getEpochToPropose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lastAcceptedEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> newLeaderZxid <span class="token operator">=</span> ZxidUtils<span class="token punctuation">.</span><span class="token function">makeZxid</span><span class="token punctuation">(</span>newEpoch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></li><li><p>Leader 主线程里，也通过 <code>getEpochToPropose</code> 获取最新的 epoch</p></li><li><p>所以关键就在这个 <code>getEpochToPropose</code> 这里了。</p><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// org.apache.zookeeper.server.quorum.Leader#getEpochToPropose</span><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">getEpochToPropose</span><span class="token punctuation">(</span><span class="token keyword">long</span> sid<span class="token punctuation">,</span> <span class="token keyword">long</span> lastAcceptedEpoch<span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 加锁，这是个 set 集合，用来存储所有连接的 server myid</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>connectingFollowers<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 标记位，初始为 true</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>waitingForNewEpoch<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> epoch<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 这里处理新的 epoch ，只要你的 epoch 比我大，你就能取代我</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastAcceptedEpoch <span class="token operator">>=</span> epoch<span class="token punctuation">)</span> <span class="token punctuation">{</span>            epoch <span class="token operator">=</span> lastAcceptedEpoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment" spellcheck="true">// 校验 server 是否是合法的投票团成员</span>        <span class="token comment" spellcheck="true">// 这里的顺序表明，你可以不是投票方的成员，只要你传过来的 epoch 比我大就好</span>        <span class="token comment" spellcheck="true">// 为什么是这样呢? 我理解为根据 zab 协议，这里最高的 epoch 必然从合法投票团成员中产生</span>        <span class="token comment" spellcheck="true">// 所以这里的处理方式是你大你有理</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isParticipant</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            connectingFollowers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        QuorumVerifier verifier <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">getQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 获得了超过半数的连接，拿到最新的 epoch，设置 flag 为 false</span>        <span class="token comment" spellcheck="true">// 同时通知所有等待的线程</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>connectingFollowers<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> verifier<span class="token punctuation">.</span><span class="token function">containsQuorum</span><span class="token punctuation">(</span>connectingFollowers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            waitingForNewEpoch <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>            self<span class="token punctuation">.</span><span class="token function">setAcceptedEpoch</span><span class="token punctuation">(</span>epoch<span class="token punctuation">)</span><span class="token punctuation">;</span>            connectingFollowers<span class="token punctuation">.</span><span class="token function">notifyAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">long</span> start <span class="token operator">=</span> Time<span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sid <span class="token operator">==</span> self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                timeStartWaitForEpoch <span class="token operator">=</span> start<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">long</span> cur <span class="token operator">=</span> start<span class="token punctuation">;</span>            <span class="token keyword">long</span> end <span class="token operator">=</span> start <span class="token operator">+</span> self<span class="token punctuation">.</span><span class="token function">getInitLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span><span class="token function">getTickTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// 这里通过 while + wait 实现</span>            <span class="token comment" spellcheck="true">// 即所有访问这个方法的线程，在没有获得半数连接的时候，最终都会在这里去等待</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>waitingForNewEpoch <span class="token operator">&amp;&amp;</span> cur <span class="token operator">&lt;</span> end <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>quitWaitForEpoch<span class="token punctuation">)</span> <span class="token punctuation">{</span>                connectingFollowers<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>end <span class="token operator">-</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>                cur <span class="token operator">=</span> Time<span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingForNewEpoch<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">(</span><span class="token string">"Timeout while waiting for epoch from quorum"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> epoch<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre></li></ol><p>我在上面的代码上加了一点注释，下面再仔细说下。</p><p>我们知道，java 里 <code>wait</code> 和 <code>notifyAll</code> 是 <code>Object</code> 里的两个方法。对于长期写业务代码的我而言，几乎没怎么用过。今天也是看到这里后，才知道原来还可以这么玩。</p><p><code>java.lang.Object#wait(long, int)</code> 的文档上，说：</p><blockquote><p>This method causes the current thread (referred to here as <var>T</var>) to place itself in the wait set for this object and then to relinquish any and all synchronization claims on this object. Note that only the locks on this object are relinquished; any other objects on which the current thread may be synchronized remain locked while the thread waits.</p></blockquote><p>意思是说，这个方法，会让当前的线程放到锁对象的等待列表中，对于上面的代码，就是所有访问的线程都被放到了 <code>connectingFollowers</code> 这个对象的等待列表里。</p><p>但是这个方法加了同步锁，一个线程过来了，其他线程还怎么访问呢?</p><p><code>wait</code> 的 doc 说，同时<strong>会放弃且只放弃</strong>所有该对象上的同步声明(synchronization claims)，也就是之前获得的这个对象(这里指 <code>connectingFollowers</code>) 上的锁，此时，其他线程可以再次竞争。</p><p>直到有线程 notify 或者 notifyAll 或者 interrupted 或者超时。</p><p>所以这里，我就能理解了。</p><p>所有 server 的连接，包括自己，都会在这里去等待超过半数的连接，达到标准后，会被唤醒，然后各干各的事情。</p><h3 id="2"><a href="#2" class="headerlink" title="[2]"></a>[2]</h3><p>我们逐步点击这个方法，会发现它有调用两个方法：</p><pre class=" language-java"><code class="language-java"><span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">startRequestThrottler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>第一个方法就是用来开启责任链，负责 leader 期间所有事物的处理。</p><p>第二个方法相当于一个阀门，用来约束请求数量。</p><p>我们把重点放到第一个方法上，看看它做了什么：</p><pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">setupRequestProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    RequestProcessor finalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    RequestProcessor toBeAppliedProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Leader<span class="token punctuation">.</span>ToBeAppliedRequestProcessor</span><span class="token punctuation">(</span>finalProcessor<span class="token punctuation">,</span> <span class="token function">getLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommitProcessor</span><span class="token punctuation">(</span>toBeAppliedProcessor<span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token function">getServerId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function">getZooKeeperServerListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    commitProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ProposalRequestProcessor proposalProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProposalRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> commitProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">// 这里注意， initialize 方法里，会初始化另外一条 syncRequestProcessor</span>    proposalProcessor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    prepRequestProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrepRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> proposalProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>    prepRequestProcessor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    firstProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LeaderRequestProcessor</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> prepRequestProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">setupContainerManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这里能很清楚的看到整个 <strong>leader</strong> 处理请求的链条：</p><p>LeaderRequestProcessor  –&gt;  PrepRequestProcessor  –&gt;  ProposalRequestProcessor –&gt;  CommitProcessor –&gt; ToBeAppliedRequestProcessor  –&gt; FinalRequestProcessor</p><p><strong>leader</strong> 同时还有一条责任链，负责记录事务到磁盘：</p><p>SyncRequestProcessor –&gt;  AckRequestProcessor</p><p>至于每个 processer 负责什么事情，大家可以去代码里瞧一瞧看一看，相信会有收获，这里暂时不再赘述。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part 3 -- ZooKeeper FastLeaderElection</title>
      <link href="/zookeeper/fast-leader-election/"/>
      <url>/zookeeper/fast-leader-election/</url>
      
        <content type="html"><![CDATA[<h1 id="ZooKeeper-lt-三-gt-Leader-选举"><a href="#ZooKeeper-lt-三-gt-Leader-选举" class="headerlink" title="ZooKeeper <三> Leader 选举"></a>ZooKeeper &lt;三&gt; Leader 选举</h1><p>ZooKeeper version： 3.6.0</p><h2 id="ZooKeeper-的启动"><a href="#ZooKeeper-的启动" class="headerlink" title="ZooKeeper 的启动"></a>ZooKeeper 的启动</h2><p>ZooKeeper 是如何启动的？！！这个问题要从哪里找答案呢?</p><h3 id="1-zkServer-sh"><a href="#1-zkServer-sh" class="headerlink" title="1. zkServer.sh"></a>1. zkServer.sh</h3><p>我们启动它时，是怎么跑的？ 让我想想，哦，对了</p><pre class=" language-bash"><code class="language-bash">./zkServer.sh start</code></pre><p>是的了，就是这样！</p><p>ok，那就简单了，我们先来看下这个 zkServer.sh 文件</p><pre class=" language-bash"><code class="language-bash"><span class="token keyword">case</span> <span class="token variable">$1</span> <span class="token keyword">in</span>start<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># ...</span>    <span class="token function">nohup</span> <span class="token string">"<span class="token variable">$JAVA</span>"</span> <span class="token variable">$ZOO_DATADIR_AUTOCREATE</span> <span class="token string">"-Dzookeeper.log.dir=<span class="token variable">${ZOO_LOG_DIR}</span>"</span> \    <span class="token string">"-Dzookeeper.log.file=<span class="token variable">${ZOO_LOG_FILE}</span>"</span> <span class="token string">"-Dzookeeper.root.logger=<span class="token variable">${ZOO_LOG4J_PROP}</span>"</span> \    -XX:+HeapDumpOnOutOfMemoryError -XX:OnOutOfMemoryError<span class="token operator">=</span><span class="token string">'kill -9 %p'</span> \    -cp <span class="token string">"<span class="token variable">$CLASSPATH</span>"</span> <span class="token variable">$JVMFLAGS</span> <span class="token variable">$ZOOMAIN</span> <span class="token string">"<span class="token variable">$ZOOCFG</span>"</span> <span class="token operator">></span> <span class="token string">"<span class="token variable">$_ZOO_DAEMON_OUT</span>"</span> 2<span class="token operator">></span><span class="token operator">&amp;</span>1 <span class="token operator">&lt;</span> /dev/null <span class="token operator">&amp;</span>    <span class="token comment" spellcheck="true"># ...</span>    <span class="token punctuation">;</span><span class="token punctuation">;</span> esac</code></pre><p>我们看到，当我们执行 <code>zkServer.sh start</code> 的时候，其实跑到了这里，而这里，会以 <code>java cp</code> 的方式启用 <code>$ZOOMAIN</code> 这个主类。往上看</p><pre class=" language-bash"><code class="language-bash"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"x<span class="token variable">$JMXDISABLE</span>"</span> <span class="token operator">=</span> <span class="token string">"x"</span> <span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$JMXDISABLE</span>"</span> <span class="token operator">=</span> <span class="token string">'false'</span> <span class="token punctuation">]</span><span class="token keyword">then</span>  <span class="token keyword">echo</span> <span class="token string">"ZooKeeper JMX enabled by default"</span> <span class="token operator">></span><span class="token operator">&amp;</span>2  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"x<span class="token variable">$JMXPORT</span>"</span> <span class="token operator">=</span> <span class="token string">"x"</span> <span class="token punctuation">]</span>  <span class="token keyword">then</span>    <span class="token comment" spellcheck="true"># for some reason these two options are necessary on jdk6 on Ubuntu</span>    <span class="token comment" spellcheck="true">#   accord to the docs they are not necessary, but otw jconsole cannot</span>    <span class="token comment" spellcheck="true">#   do a local attach</span>    ZOOMAIN<span class="token operator">=</span><span class="token string">"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only=<span class="token variable">$JMXLOCALONLY</span> org.apache.zookeeper.server.quorum.QuorumPeerMain"</span>  <span class="token keyword">else</span>    <span class="token comment" spellcheck="true"># ...</span>    ZOOMAIN<span class="token operator">=</span><span class="token string">"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=<span class="token variable">$JMXPORT</span> -Dcom.sun.management.jmxremote.authenticate=<span class="token variable">$JMXAUTH</span> -Dcom.sun.management.jmxremote.ssl=<span class="token variable">$JMXSSL</span> -Dzookeeper.jmx.log4j.disable=<span class="token variable">$JMXLOG4J</span> org.apache.zookeeper.server.quorum.QuorumPeerMain"</span>  <span class="token keyword">fi</span><span class="token keyword">else</span>    <span class="token keyword">echo</span> <span class="token string">"JMX disabled by user request"</span> <span class="token operator">></span><span class="token operator">&amp;</span>2    ZOOMAIN<span class="token operator">=</span><span class="token string">"org.apache.zookeeper.server.quorum.QuorumPeerMain"</span><span class="token keyword">fi</span></code></pre><p>可以看到，这里虽然区分了几种情况，但都是往 <code>ZOOMAIN</code> 中添加启动变量，但最终，这个主类，它还是它：</p><blockquote><p>org.apache.zookeeper.server.quorum.QuorumPeerMain</p></blockquote><p>于是我们知道了 zk 的启动类。</p><h3 id="2-QuorumPeerMain"><a href="#2-QuorumPeerMain" class="headerlink" title="2. QuorumPeerMain"></a>2. QuorumPeerMain</h3><p>下面我们把 zk 的源码拉下来，通过这个主类一步步往里面看。源码 clone 看 <a href="https://github.com/apache/zookeeper" target="_blank" rel="noopener">GitHub</a></p><p>下载完成后(需要依次 mvn clean install)，我们找到这个类，可以看到：</p><p>通过 <code>main</code> 方法 调用 <code>initializeAndRun</code> ， 这个方法先读取 config ，然后启动一个类似清洁工的线程，之后根据传入的参数，来判断是启用 ensemble 模式还是 standalone 模式。</p><p>这里我们看 ensemble 模式。</p><blockquote><p> org.apache.zookeeper.server.quorum.QuorumPeerMain#runFromConfig</p></blockquote><ul><li><p>这个方法，初始化了一个十分重要的对象，即 <strong>QuorumPeer</strong> !! zk 的核心类之一。稍后我们会说到它。我们看这个方法还干了些什么了不得的事情。</p></li><li><p>之前 <code>zoo.cfg</code> 里设置的什么 tickTime， initLimit，syncLimit 啥的，都会在这个方法里完成初始化。</p></li><li><p>选举算法(你随便找下，就能看到，现在 zk 只支持 3，也就是 FastLeaderElection 算法)，myid，database 等的初始化</p></li><li><p>QuorumVerifier 类，维护着 ensemble 内所有初始化时的所有 server 信息，之后说选举是不是过半了，就是通过它来做判断的</p></li><li><p>ServerCnxnFactory 类，负责 server 到 client 的通信，主要有 NIO 和 Netty 两种实现，默认为 NIO， 可以通过配置 <code>zookeeper.serverCnxnFactory</code> 来使用 Netty</p></li><li><p>others</p></li></ul><p>之后就会运行 <code>quorumPeer.start()</code> 也就是起了一个线程，不过这个线程会去竞争 cpu 时间片，获得后就会 run 起来</p><h3 id="3-QuorumPeer"><a href="#3-QuorumPeer" class="headerlink" title="3. QuorumPeer"></a>3. QuorumPeer</h3><p>这个类负责维护这个 server 在运行期间的所有事物，或者说，一个 server ，其实就是一个 quorumPeer 。为什么这样说？</p><p>zk 在运行期间，无非就是和 client 通信，和各个 server ，和 leader 通信，而这个类所持有的各个对象，就是干这些事情的。</p><ul><li><h4 id="3-1-QuorumPeer-start"><a href="#3-1-QuorumPeer-start" class="headerlink" title="3.1 QuorumPeer.start()"></a>3.1 QuorumPeer.start()</h4></li></ul><p>我们先来看看 start 的时候，做了什么</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 验证 myid 正确性</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>myid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"My id "</span> <span class="token operator">+</span> myid <span class="token operator">+</span> <span class="token string">" not in the peer list"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 装载 zk database</span>    <span class="token function">loadDataBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">startServerCnxnFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        adminServer<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AdminServerException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Problem starting AdminServer"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 开启一轮选举</span>    <span class="token function">startLeaderElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">startJvmPauseMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>做了些验证等其他操作后，开启了一轮选举，我们看下这个方法做了什么</p><pre class=" language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">startLeaderElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 很明显，我们初始时状态就是 LOOKING，所以会初始化一张自己的选票</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getPeerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ServerState<span class="token punctuation">.</span>LOOKING<span class="token punctuation">)</span> <span class="token punctuation">{</span>            currentVote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>myid<span class="token punctuation">,</span> <span class="token function">getLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getCurrentEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        RuntimeException re <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        re<span class="token punctuation">.</span><span class="token function">setStackTrace</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">throw</span> re<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true">// 初始化选举算法</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>electionAlg <span class="token operator">=</span> <span class="token function">createElectionAlgorithm</span><span class="token punctuation">(</span>electionType<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">protected</span> Election <span class="token function">createElectionAlgorithm</span><span class="token punctuation">(</span><span class="token keyword">int</span> electionAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Election le <span class="token operator">=</span> null<span class="token punctuation">;</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>electionAlgorithm<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment" spellcheck="true">// 1，2 都会抛异常</span>        <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>            <span class="token comment" spellcheck="true">// QuorumCnxManager 负责选举期间所有的 TCP 连接！！！</span>            <span class="token comment" spellcheck="true">// 为什么这个类要在这里初始化？</span>            <span class="token comment" spellcheck="true">// 因为他要负责监听选举</span>            QuorumCnxManager qcm <span class="token operator">=</span> <span class="token function">createCnxnManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            QuorumCnxManager oldQcm <span class="token operator">=</span> qcmRef<span class="token punctuation">.</span><span class="token function">getAndSet</span><span class="token punctuation">(</span>qcm<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>oldQcm <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                LOG<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"Clobbering already-set QuorumCnxManager (restarting leader election?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                oldQcm<span class="token punctuation">.</span><span class="token function">halt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            QuorumCnxManager<span class="token punctuation">.</span>Listener listener <span class="token operator">=</span> qcm<span class="token punctuation">.</span>listener<span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// listener 负责监听所有连接</span>                listener<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                FastLeaderElection fle <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FastLeaderElection</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> qcm<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 开启选举线程</span>                fle<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                le <span class="token operator">=</span> fle<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Null listener when initializing cnx manager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token operator">:</span>            <span class="token keyword">assert</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> le<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h4 id="3-2-FastLeaderElection"><a href="#3-2-FastLeaderElection" class="headerlink" title="3.2 FastLeaderElection"></a>3.2 FastLeaderElection</h4><p>这里，我们先看下 FLE(FastLeaderElection) 的类图</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200404143916.png-growing" alt="FLE Class"></p><p>FLE 主要持有的对象有</p><ul><li><p>ToSend：就是一个封装类，用来封装发送的消息体</p></li><li><p>Notification：也是一个封装类，用来告知其他 server，vote 发生了变化的实体</p></li><li><p>Messenger：真正干事情的，用于发送和接受选举期间的选票，其中：</p><ul><li>WorkerReceiver：接收选票</li><li>WorkerSender：发送选票</li></ul></li><li><p>FastLeaderElection 里还有两个很重要的变量，我们从名字也能很好理解</p><ul><li>sendqueue LinkedBlockingQueue&lt;ToSend&gt; ： 用来接收需要发送的选票队列</li><li>recvqueue  LinkedBlockingQueue&lt;Notification&gt; ： 用来接收从其他 server 发过来的选票队列</li></ul></li></ul><p>我们可以看到 FLE 虽然有个 start() 方法，可是它并不是一个线程类！ 在 start 之后，它事实上是初始化了 <code>Messenger</code> ,之后 Messenger 去初始化 <code>WorkerReceiver</code> 和 <code>WorkerSender</code> ，这两个是线程类，并且被 start 了。</p><p>也就是说，这两货开始干活了： 这两货会根据接收/发送的选票的各种状态，分别塞给  sendqueue 和 recvqueue </p><ul><li>sendqueue 最终被前文提到的 <code>QuorumCnxManager</code> 消费，由它发送给其他 server</li><li>recvqueue 最终由 fle 在计算选票时候消费，以此来确定 leader 的诞生</li></ul><h4 id="3-3-QuorumPeer-run"><a href="#3-3-QuorumPeer-run" class="headerlink" title="3.3 QuorumPeer.run()"></a>3.3 QuorumPeer.run()</h4><p>简单介绍完 FLE ，现在我们回到 <code>QuorumPeer</code> 这个类，之前我们在 <code>QuorumPeerMain</code> 里 start 了这个线程，现在，它，终于争取到了 cpu 时间片，它可以 run 了！！！</p><p>QuourmPeer 中包含的几种状态：</p><ul><li>ServerState ： 标记当前 server 状态<ul><li>LOOKING：该状态下会发起选举</li><li>OBSERVING：表明处于观察者状态</li><li>FOLLOWING：跟随者状态</li><li>LEADING：领导者状态</li></ul></li><li>ZabState：标记 zab 协议的状态<ul><li>ELECTION ：选举阶段</li><li>DESCOVERY：发现阶段，和各个 follower/observer 建立 tcp 连接</li><li>SYNCHRONIZATION：同步阶段，和各个 follower 同步信息</li><li>BROADCAST：广播阶段</li></ul></li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 源码参见 org.apache.zookeeper.server.quorum.QuorumPeer#run</span><span class="token comment" spellcheck="true">// 这里对代码做了精简处理</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true">// 设置 jmx</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">getPeerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">case</span> LOOKING<span class="token operator">:</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>Boolean<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"readonlymode.enabled"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// readonly 模式下的必要处理 [1]</span>                     <span class="token function">setCurrentVote</span><span class="token punctuation">(</span><span class="token function">makeLEStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookForLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment" spellcheck="true">// ...</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token comment" spellcheck="true">// 这个标志和配置里的 version 有关</span>                    <span class="token comment" spellcheck="true">// version 和 zk 的 dynamic 配置有关</span>                    <span class="token comment" spellcheck="true">// 暂时还没有去看这块的东西，后面把这里的坑填上</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>shuttingDownLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>                        shuttingDownLE <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>                        <span class="token function">startLeaderElection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token function">setCurrentVote</span><span class="token punctuation">(</span><span class="token function">makeLEStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lookForLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token keyword">case</span> OBSERVING<span class="token punctuation">,</span>FOLLOWING<span class="token punctuation">,</span>LEADING<span class="token operator">:</span>                <span class="token comment" spellcheck="true">// 设置为 OBSERVER FOLLOWER LEADER</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token punctuation">}</span></code></pre><p>这里就是负责发起选举的主流程。很简单，直接调用 FLE 的 <code>lookForLeader</code> 方法。职责明确。</p><h4 id="3-4-lookForLeader"><a href="#3-4-lookForLeader" class="headerlink" title="3.4 lookForLeader()"></a>3.4 lookForLeader()</h4><p>一张选票，可能有以下几种问题：</p><ol><li>选票数据出了问题，比如 tcp 传输过程中，某个数据包丢了…</li><li>投出这张选票的 server 没有权限(observer)</li><li>收到选票时，我自己的状态并不在 LOOKING 状态(什么时候会有这种情况呢？ [4])</li><li>收到选票时， 其他 server 的选票不是 LOOKING 状态(这个下文会分析，可以先想一下)</li><li>正常的选票，你在寻找 leader(选票状态为 LOOKING)，我也在寻找  leader (我的状态也是 LEADING)</li></ol><p>上面的前三种情况，都会由 <code>WorkReceiver</code> 处理掉</p><p>后面的两种情况，<code>WorkerReceiver</code> 才会把选票放入 <code>recvqueue</code> 中，由下面的流程来处理。</p><p>在看下面的代码之前，先介绍下几个变量以及数据结构</p><ul><li>logicalclock：用来记录我自己的选举轮次</li><li>todo</li><li>Notification (处理后的一张选票)<ul><li>leader： long ， 选票的 sid ，即 myid，这里选票要选举的那个 server 的 sid，不是自己的</li><li>peerEpoch：投票人选举的 leader 所处的年代</li><li>zxid：投票人选举的 leader 的 zxid</li><li>sid： long ，投票人自己的 sid</li><li>electionEpoch： 投票人的投票轮次，这个值会和我自己的 logicalclock 比较，判断是不是处于同一个轮次</li><li>state： 投票人的 serverState</li><li>qv：投票人的投票信息</li></ul></li></ul><p><strong>zk 针对两张合法的选票，根据如下规则做比较</strong></p><p>源代码： org.apache.zookeeper.server.quorum.FastLeaderElection#totalOrderPredicate</p><ul><li>epoch： 即待选 leader 所处的年代，选大的！ 也就是 notification 中的 peerEpoch</li><li>zxid： epoch 一样的时候，看待选 leader 的 zxid，选大的！</li><li>myid：还一样怎么办？ 选 myid 大的！ 即 notification 中的 leader</li></ul><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// 同样对代码做了精简 </span><span class="token comment" spellcheck="true">// 源码参见 org.apache.zookeeper.server.quorum.FastLeaderElection#lookForLeader</span><span class="token keyword">public</span> Vote <span class="token function">lookForLeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> InterruptedException <span class="token punctuation">{</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>       <span class="token comment" spellcheck="true">// 用来存储有效选票(logicalClock == 选票.electionEpoch)的集合</span>        <span class="token comment" spellcheck="true">// server 根据它来判断选举结果</span>        Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span> recvset <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// 关于这个字段的详细解释以及 pr [2]</span>        Map<span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span> outofelection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token operator">&lt;</span>Long<span class="token punctuation">,</span> Vote<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> notTimeout <span class="token operator">=</span> minNotificationInterval<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">// logicalclock 增加， 同时初始化一张自己的选票，并广播出去</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            logicalclock<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">updateProposal</span><span class="token punctuation">(</span><span class="token function">getInitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getInitLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPeerEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        SyncedLearnerTracker voteSet<span class="token punctuation">;</span>       <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getPeerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ServerState<span class="token punctuation">.</span>LOOKING<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>stop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token comment" spellcheck="true">// 前文提到的 recvqueue ，这里从这个队列拿选票</span>            Notification n <span class="token operator">=</span> recvqueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>notTimeout<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment" spellcheck="true">// 没有选票！ 是什么情况呢? 还有这里为什么一种会重新发送，另一种又没有呢? [3]</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>manager<span class="token punctuation">.</span><span class="token function">haveDelivered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    manager<span class="token punctuation">.</span><span class="token function">connectAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">validVoter</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>sid<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">validVoter</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment" spellcheck="true">// 投票人的 serverState</span>                <span class="token keyword">switch</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">case</span> LOOKING<span class="token operator">:</span>                    <span class="token comment" spellcheck="true">// 投票人选举轮次大，说明之前的投票都无效，所以这里清空票箱</span>                    <span class="token comment" spellcheck="true">// 同时更新自己的 logicalclock,</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch <span class="token operator">></span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        logicalclock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                        recvset<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 比较两张选票并更新</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">totalOrderPredicate</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> <span class="token function">getInitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getInitLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPeerEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">updateProposal</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                            <span class="token function">updateProposal</span><span class="token punctuation">(</span><span class="token function">getInitId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getInitLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getPeerEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">// 更新选票后，发送个其他 server</span>                        <span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch <span class="token operator">&lt;</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 你的选举轮次比我小，我只能对你爱理不理了</span>                        <span class="token keyword">break</span><span class="token punctuation">;</span>                        <span class="token comment" spellcheck="true">// 处于同一个选举轮次的时候，也是比较选票并更新</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">totalOrderPredicate</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token function">updateProposal</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">sendNotifications</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 无效的选票都 break 掉了，到这里都是有效的选票，放入票箱</span>                    recvset<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 统计选票，这里需要说下，所有 update 操作，都会更新自己的 proposedLeader 等数据</span>                  <span class="token comment" spellcheck="true">// 所以这里 new Vote 参数，都是更新后的参数</span>                    voteSet <span class="token operator">=</span> <span class="token function">getVoteTracker</span><span class="token punctuation">(</span>recvset<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">// 超过半数</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>voteSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token comment" spellcheck="true">// 这里的处理很有意思了，它会再次查看，从上面取出选票，到运行到这里的这段时间内</span>                        <span class="token comment" spellcheck="true">// 是不是又收到了选票，如果不仅收到了，还是一张最牛皮的，拿出来后，又塞了回去！</span>                        <span class="token comment" spellcheck="true">// 因为 break，而 n 不为空，会进入到外面的 while 循环，再次跑一遍上面的流程</span>                        <span class="token comment" spellcheck="true">// 那么，什么情况下，这张选票里的 leader 会当选呢？</span>                        <span class="token comment" spellcheck="true">// 很明显，超过半数的 server ，在收到这张选票之前，没有确定 server，那它就</span>                        <span class="token comment" spellcheck="true">// 有概率当选</span>                        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> recvqueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>finalizeWait<span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">totalOrderPredicate</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                recvqueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token keyword">break</span><span class="token punctuation">;</span>                            <span class="token punctuation">}</span>                        <span class="token punctuation">}</span>                        <span class="token comment" spellcheck="true">// 到这里，leader 就能确定了</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">setPeerState</span><span class="token punctuation">(</span>proposedLeader<span class="token punctuation">,</span> voteSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                            Vote endVote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>proposedLeader<span class="token punctuation">,</span> proposedZxid<span class="token punctuation">,</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proposedEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">leaveInstance</span><span class="token punctuation">(</span>endVote<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">return</span> endVote<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> OBSERVING<span class="token operator">:</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token keyword">case</span> FOLLOWING<span class="token operator">:</span>                <span class="token keyword">case</span> LEADING<span class="token operator">:</span>                    <span class="token comment" spellcheck="true">// 可以思考下，什么情况，会跑到这里来 [5]</span>                    <span class="token comment" spellcheck="true">// 同一个选举轮次，什么情况呢？</span>                    <span class="token comment" spellcheck="true">// 我们都参与了投票，别人都搞完选出 leader 了，回复我的时候</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch <span class="token operator">==</span> logicalclock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        recvset<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        voteSet <span class="token operator">=</span> <span class="token function">getVoteTracker</span><span class="token punctuation">(</span>recvset<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>version<span class="token punctuation">,</span> n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>voteSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkLeader</span><span class="token punctuation">(</span>recvset<span class="token punctuation">,</span> n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token function">setPeerState</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> voteSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                            Vote endVote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">leaveInstance</span><span class="token punctuation">(</span>endVote<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token keyword">return</span> endVote<span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                    <span class="token punctuation">}</span>                <span class="token comment" spellcheck="true">// 新的 server 加入稳定的 ensemble 时，会到这里</span>                  <span class="token comment" spellcheck="true">// 主要验证当前 leader 是不是真的被超半数的 follower 追随</span>                    outofelection<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>sid<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>version<span class="token punctuation">,</span> n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    voteSet <span class="token operator">=</span> <span class="token function">getVoteTracker</span><span class="token punctuation">(</span>outofelection<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>version<span class="token punctuation">,</span> n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>voteSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">checkLeader</span><span class="token punctuation">(</span>outofelection<span class="token punctuation">,</span> n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            logicalclock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token function">setPeerState</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> voteSet<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        Vote endVote <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vote</span><span class="token punctuation">(</span>n<span class="token punctuation">.</span>leader<span class="token punctuation">,</span> n<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> n<span class="token punctuation">.</span>electionEpoch<span class="token punctuation">,</span> n<span class="token punctuation">.</span>peerEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token function">leaveInstance</span><span class="token punctuation">(</span>endVote<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">return</span> endVote<span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> null<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span></code></pre><p>到这里，即基本说完了 FLE 的大致算法。</p><p>我们总结下，无非几句话：</p><ol><li>判断是不是同一个选举轮次。选举轮次只有在发起选举的时候才会更新。比我小的，我都不带理睬，相同或大的，根据 epoch ， zxid ， myid 比较并更新选票，同时重新发送自己的选票。</li><li>在收集到足够多的选票后，判断是否超过了半数(事实上，zk 还去检查了这个即将当选的 leader 的状态，可以说相当负责了)。超过的话，就进入下一个状态。</li><li>如果是半路杀出来的，即新的 server 加入，就检查当前 leader 的合法性，合法就加入其中。(如果不合法，自然会不断的发送选票，直到集群中大部分的 server 都观察到，因为这是一个 while 循环啊)</li></ol><h4 id="FLE-Flow"><a href="#FLE-Flow" class="headerlink" title="FLE Flow"></a>FLE Flow</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200405092256.png-growing" alt="FastLeaderElection Flow"></p><p>该流程图可能不是特别精确，少了些具体的流程，请务必批判着看。准确的说，所有的网络文章，你都得批判着看 <span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f602.png?v8">😂</span> </p><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><h3 id="1"><a href="#1" class="headerlink" title="[1]:"></a>[1]:</h3><p>zk 提供 readonly 模式的 server 。 我们知道，当一台 server 与超过半数的 server  丢失连接后，就会停止工作，读写请求都不会处理。 但是使用该模式后，则该 server 仍然会处理 <strong>读</strong> 请求。虽然保证了可用性，但丢掉了一致性，也就是说，此时的 CAP 从 CP 转换到了 AP</p><h3 id="2"><a href="#2" class="headerlink" title="[2]"></a>[2]</h3><p><a href="https://github.com/apache/zookeeper/pull/1081" target="_blank" rel="noopener">outofelection pr</a></p><h3 id="3"><a href="#3" class="headerlink" title="[3]"></a>[3]</h3><p>什么情况下会收不到选票呢？</p><ul><li>我已经发送了，是你们的问题，你们没有给我回复！！！ 可能所有 server 都因为各种问题丢失了这条消息，那没办法，我只能再发一次了。那么这里需要担心选票重复的问题吗? of course not ！我是用 set 存储选票的，你相同的选票，我覆盖一次就好了呗。</li><li>我以为我发送了，其实我并没有… 不好意思，是我的锅！！！ 原来我和你们的连接出了问题，好吧，我重新连接一次。 可是这里，重新连接后 <strong>没有重新发送选票</strong> ， 为什么这样子？我们可以稍微看下它发送消息的机制，需要先建立连接，然后取出消息发送，所以如果压根就没有连上，那么就没有所谓的取出消息发送，所以这里并不需要再次发送消息。</li></ul><h3 id="4"><a href="#4" class="headerlink" title="[4]"></a>[4]</h3><ul><li>当有新的 server 加入到一个稳定运行的 ensemble 时，这个新 server 会发起投票，我去回复这个新 server 发起的选举时，自己本身的状态，必然是 LEADING / FOLLOWING /OBSERVING </li><li>集群中，有 server 发现 leader 挂掉了，此时它会发起投票，可是我还没感知到 leader 的状态 ，依然还是之前的状态：FOLLOWING / OBSERING，我去回复时</li></ul><h3 id="5"><a href="#5" class="headerlink" title="[5]"></a>[5]</h3><ul><li>我作为一个新 server ，发起投票时，别人回复给我的信息，会到这里</li><li>我及时发现 ensemble 里的 leader 挂掉了，发起新的选举时， 别人的回复会来这里</li><li>选举时，有一半的 server 完成了选举，我年纪大了，速度慢，发起投票后，别人的回复</li><li>我作为 Follower ，跑着跑着，竟然挂掉了，重新拉起来时，也会如此</li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TODO</title>
      <link href="/mine/todo/"/>
      <url>/mine/todo/</url>
      
        <content type="html"><![CDATA[<h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><ul><li><p><span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8">📝</span> todo 事项</p></li><li><p><span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png?v8">🎉</span> 完成事项</p></li></ul><h3 id="how-to-use"><a href="#how-to-use" class="headerlink" title="how-to-use"></a>how-to-use</h3><p><span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8">📝</span> 永久 watch event 的使用</p><p><span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8">📝</span> zk 的 dynamic 配置，quorumPeer 有一个 flag： shuttingDowmLE ，和 version 有关，而 version 貌似和 dynamic 的配置有关系，看的时候，可以把这一块理一理</p><h3 id="zab"><a href="#zab" class="headerlink" title="zab"></a>zab</h3><p><span class="github-emoji" style="color: transparent;background:no-repeat url(https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8) center/contain" data-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png?v8">📝</span> zk 的 zab 协议中，一项决议的产生流程是怎样的？ 以 paxos 算法来说， zk 中的 leader 在第一阶段 prepare 的时候，会先征求超过半数的 follower 的同意，之后再在 propose 阶段去真正提交，这个时候，会被各个 follower 选中，一项决议生成。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mine </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part 2 -- Using ZooKeeper Now</title>
      <link href="/zookeeper/how-to-use/"/>
      <url>/zookeeper/how-to-use/</url>
      
        <content type="html"><![CDATA[<h1 id="ZooKeeper-lt-二-gt-安装使用"><a href="#ZooKeeper-lt-二-gt-安装使用" class="headerlink" title="ZooKeeper <二> 安装使用"></a>ZooKeeper &lt;二&gt; 安装使用</h1><p>ZooKeeper version： 3.6.0</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>本示例均在 <strong><code>CentOS Linux release 8.1.1911 (Core)</code></strong> 下进行</p><p>同时需要保证当前机器含有 java 环境，java 安装步骤可参考 <a href="https://iyuhp.top/linux/install/#Java-11">这里</a></p><h4 id="1-下载"><a href="#1-下载" class="headerlink" title="1. 下载"></a>1. 下载</h4><p>首先到 <a href="http://zookeeper.apache.org/releases.html" target="_blank" rel="noopener">Apache Download</a> 寻找合适的版本，这里以 3.6.0 为例，下载</p><pre class=" language-shell"><code class="language-shell">wget https://downloads.apache.org/zookeeper/current/apache-zookeeper-3.6.0-bin.tar.gz</code></pre><h4 id="2-解压"><a href="#2-解压" class="headerlink" title="2. 解压"></a>2. 解压</h4><pre><code>tar -xvf apache-zookeeper-3.6.0-bin.tar.gz</code></pre><h4 id="3-单机版启动"><a href="#3-单机版启动" class="headerlink" title="3. 单机版启动"></a>3. 单机版启动</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200403152324.png-growing" alt="zookeeper config"></p><p>如图示，我在解压完后，将那串长长的目录名，重命名为 zk1， 同时又 cp 了 zk2 和 zk3，cp zoo_sample.cfg 为 zoo.cfg</p><pre class=" language-shell"><code class="language-shell"># 修改名称mv apache-zookeeper-3.6.0-bin zk1# cp 两份，为后面的伪集群搭建做准备cp -r zk1 zk2 cp -r zk1 zk3# 增加 zoo.cfg 配置cd zk1 &&  cp conf/zoo_sample.cfg zoo.cfg</code></pre><p>这里我没有修改任何地方，直接 start</p><pre class=" language-shell"><code class="language-shell">./bin/zkServer.sh start/usr/bin/javaZooKeeper JMX enabled by defaultUsing config: /home/dylan/tmp/zookeeper/zk1/bin/../conf/zoo.cfgStarting zookeeper ... STARTED</code></pre><p>可以看到， zk1 已经启动，我们验证一下：</p><pre class=" language-shell"><code class="language-shell">./bin/zkServer.sh status/usr/bin/javaZooKeeper JMX enabled by defaultUsing config: /home/dylan/tmp/zookeeper/zk1/bin/../conf/zoo.cfgClient port found: 2181. Client address: localhost.Mode: standalone</code></pre><p>通过 <code>zkServer.sh status</code> ，能看到 zk 已经正常启动，Mode 为 standalone ，当我们配置 ensemble 时，这个 Mode 就会变成 Leader/Follower/Observer</p><h4 id="4-单机伪集群版"><a href="#4-单机伪集群版" class="headerlink" title="4. 单机伪集群版"></a>4. 单机伪集群版</h4><p>前面我们已经 cp 了 3 个 zk，现在我们再添加一个 observer 节点，同时，在各个 dataDir 新建 <code>myid</code> 文件，并写入值，如  zk1 的 dataDir 为 <code>/tmp/zk1</code> ，则我们执行： <code>echo 1 &gt; /tmp/zk1/myid</code></p><h5 id="4-1-四份配置如下："><a href="#4-1-四份配置如下：" class="headerlink" title="4.1 四份配置如下："></a>4.1 四份配置如下：</h5><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200404043709.png-growing" alt="ensemble config"></p><p>其中涉及到的配置项有：</p><ul><li><p>tickTime：zk 中的计时单元，单位毫秒(milliseconds)，心跳间隔，session timeout = 2倍 tickTime(默认)</p></li><li><p>initLimit：ensemble 初始化时，server(Follower/Observer) 与 Leader 进行连接的最大时长，超过该时间如果还未连接成功，则宣告连接失败。对于 Follower 而言，则是连接并同步到 Leader 的时间。如果 zookeeper 集群管理的数据量很大，则根据需要增加这个值</p></li><li><p>syncLimit： 同步时间，如果 Follower 在 syncLimit 时间内未完成同步，则将被 Leader 丢弃</p></li><li><p>dataDir：zk 用于存放数据的地方，<code>myid</code> 文件也存放在这个地方。zk 官方建议该目录应该是一个专门为 zk 事务日志准备的目录：</p></li></ul><blockquote><p>To get low latencies on updates it is important to have a dedicated transaction log directory. By default transaction logs are put in the same directory as the data snapshots and myid file. The dataLogDir parameters indicates a different directory to use for the transaction logs.</p></blockquote><ul><li><p>clientPort： 监听客户端连接的端口。如果你的客户端使用的不是这个端口，那这里就要改了。这里因为在同一台机器上，所以改成了不同的端口</p></li><li><p>peerType：配置了 <code>peerType=observer</code> 的 server，将成为 observer，本例中的 zk4 将成为 observer</p></li><li><p>observerMasterPort： 默认情况下， Observer 从 Leader 获得新 proposal， 启用该配置后，observer 将从 Follower 获得 proposal。Follower 将会监听该端口。这样做的好处是，能减轻 Leader 的压力。我上面配置的值不相同，是因为我在单机上，如果配置相同，会出现端口冲突，实际这里应该是同一个端口。</p></li></ul><blockquote><p>By default, Observers connect to the Leader of the quorum along its quorum port and this is how they learn of all new proposals on the ensemble. There are benefits to allowing Observers to connect to the Followers instead as a means of plugging into the commit stream in place of connecting to the Leader. It shifts the burden of supporting Observers off the Leader and allow it to focus on coordinating the commit of writes. This means better performance when the Leader is under high load, particularly high network load such as can happen after a leader election when many Learners need to sync. It reduces the total network connections maintained on the Leader when there are a high number of observers. Activating Followers to support Observers allow the overall number of Observers to scale into the hundreds. On the other end, Observer availability is improved since it will take shorter time for a high number of Observers to finish syncing and start serving client traffic.</p></blockquote><ul><li>server.1=127.0.0.1:2284:3884:observer ： 为方便介绍我们把这里改写成如下形式：<ul><li>server.myid=net:port1:port2:observer， 则</li><li>myid： myid，需要与该 server dataDir 下 <code>myid</code> 文件中的值保持一致(这个文件需要我们手动创建)</li><li>net： 该 server 的 host</li><li>port1：用于 peer 到 peer 的 TCP 通信， peer 即一个 zk server；以及和 Leader 之间的通信，这个端口，事实上，只有 server 成为 Leader 后才会去监听。虽然文档说是 peer to peer， 但仔细看下源码和实践，这个端口确实是 Leader 用来和各 server 通信用的</li><li>port2： 选举期间，各个 server 之间的 TCP 通信端口，即选举使用的端口</li><li>observer： 表明该 server 为 observer</li><li><strong>3.6.0</strong> 版本中，可以使用 <strong>multiple addresses</strong> ， 结构如下</li><li>server.myid=net1:port1:port2|net2:port1:port2， 即通过分隔符( <strong>|</strong> )来分割不同的 address</li></ul></li><li><em>leaderServes</em> ：Leader 是否可以连接 client，默认为 true，为 false 时，表明 Leader 只需要专注于协同(coordination)。如果写请求远高于读请求，可以设置为 false。</li><li>更多配置，请参考 <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperAdmin.html" target="_blank" rel="noopener">这里</a> ， <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperObservers.html" target="_blank" rel="noopener">这里</a> ，还有 <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperReconfig.html" target="_blank" rel="noopener">这里</a></li></ul><h5 id="4-2-启动"><a href="#4-2-启动" class="headerlink" title="4.2 启动"></a>4.2 启动</h5><p>分别执行(注意下执行目录)</p><pre class=" language-bash"><code class="language-bash">./zk1/bin/zkServer.sh start</code></pre><p>上面没有更改日志位置，所以可以在 ./zk1/logs 下面找到</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200404031221.png-growing" alt="zookeeper starting"></p><p>当只启动了 zk1 时，日志如上所示，它在尝试和 zk2 ，zk3 通信时，会一直失败，当我们启动了 zk2 和 zk3 时，整个集群就会稳定下来。</p><p>因为单机版的问题，这里 zk4 ，即 observer 的 observerMasterPort 配置为 2481，即 zk1 ，所以如果 zk1 当选为 Leader ，此时 zk4 会疯狂刷日志，报 connection refused，别问我怎么知道的！！！</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200404044913.png-growing" alt="ensemble listening ports"></p><p>通过这张图我们可以看到 ，zk1 成功当选了 leader，则它监听的端口有：</p><ul><li>3881：用于选举的端口，任何时候都会去监听</li><li>2281：用于和其他 server 通信的端口，即前文的 port1</li><li>2481： 作为 leader，它已经不用去监听这个 observerMasterPort 了，所以这里我们看不到</li><li>2181： 用于和客户端通信的端口，我们没有配置 <em>leaderServes=false</em>，所以 leader 还需要响应 client </li></ul><p>Follower 监听的端口有(这里以 zk2 为例)：</p><ul><li>3882：选举端口，时刻保持监听，万一 leader 挂了，选了我做 leader 呢！</li><li>2482：observerMasterPort，负责和 observer 通信的 TCP 端口</li><li>2182：和 client 交互的 TCP 端口</li></ul><h5 id="4-3-简单使用"><a href="#4-3-简单使用" class="headerlink" title="4.3 简单使用"></a>4.3 简单使用</h5><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 不加[]中内容，默认连接到 2181 端口</span>./zk1/bin/zkCli.sh <span class="token punctuation">[</span>-server localhost:2182<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># 输入 help ，会打印出命令</span><span class="token comment" spellcheck="true"># 可以看到 create 相关: create [-s] [-e] [-c] [-t ttl] path [data] [acl]</span><span class="token comment" spellcheck="true"># 我们用 create 创建一个节点,其中 data 为 "zk_test_data"， acl 我们暂时不设置</span>create /zk_test <span class="token string">"zk_test_data"</span><span class="token comment" spellcheck="true"># 通过 ls / 能到节点已经创建</span><span class="token function">ls</span> /<span class="token comment" spellcheck="true"># get 获取节点信息, -s 参数会把整个节点信息 zxid 等打印出来</span>get -s /zk_test<span class="token comment" spellcheck="true"># 更多命令请百度/Google</span><span class="token comment" spellcheck="true"># 使用到此结束</span></code></pre><h2 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h2><p>ACL 有关的官方文档请点击 <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperProgrammers.html#sc_ZooKeeperAccessControl" target="_blank" rel="noopener">这里</a></p><p>所谓 ACL ，即 Access Control Lists ，访问控制列表。在 zk 中，用来控制访问 znode。</p><h3 id="1-ACL-构成"><a href="#1-ACL-构成" class="headerlink" title="1. ACL 构成"></a>1. ACL 构成</h3><blockquote><p>&lt;scheme&gt;:&lt;id&gt;:&lt;perms&gt;</p></blockquote><pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">// org.apache.zookeeper.data.ACL</span><span class="token keyword">public</span> <span class="token function">ACL</span><span class="token punctuation">(</span>    <span class="token keyword">int</span> perms<span class="token punctuation">,</span>    org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Id id<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>perms<span class="token operator">=</span>perms<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token operator">=</span>id<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// org.apache.zookeeper.data.Id</span><span class="token keyword">public</span> <span class="token function">Id</span><span class="token punctuation">(</span>    String scheme<span class="token punctuation">,</span>    String id<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>scheme<span class="token operator">=</span>scheme<span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>id<span class="token operator">=</span>id<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">// org.apache.zookeeper.ZooDefs.Perms </span><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Perms</span> <span class="token punctuation">{</span>    <span class="token keyword">int</span> READ <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> WRITE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> CREATE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> DELETE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ADMIN <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> ALL <span class="token operator">=</span> READ <span class="token operator">|</span> WRITE <span class="token operator">|</span> CREATE <span class="token operator">|</span> DELETE <span class="token operator">|</span> ADMIN<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>通过源码我们可以看到, ACL = Id + perms 构成 , 而 Id = scheme + id</p><h3 id="2-Perms"><a href="#2-Perms" class="headerlink" title="2. Perms"></a>2. Perms</h3><p>同样由源码可以看到 <strong>perms</strong> 主要包含以下几种:</p><ul><li>read</li><li>write</li><li>create</li><li>delete</li><li>admin : you can set permissions , 毕竟是 admin,你可以胡作非为</li><li>all： 所有权限</li></ul><h3 id="3-内置权限方案"><a href="#3-内置权限方案" class="headerlink" title="3. 内置权限方案"></a>3. 内置权限方案</h3><p>zookeeper 内置的 scheme 有如下几种：</p><ul><li><p>world： 即任何人都可以拥有你设置的权限，&lt;world&gt;:&lt;anyone&gt;&lt;perms&gt;</p></li><li><p>digest：&lt;digets&gt;:&lt;username:password&gt;:&lt;perms&gt; , 这里的 password， 是指 base64 编码的 sha1 密码摘要，填入 ACL 中。比如 username 为 dylan , 密码为 123456， 则进行如下操作： </p><pre class=" language-bash"><code class="language-bash"><span class="token keyword">echo</span> -n dylan:123456 <span class="token operator">|</span> openssl dgst -binary -sha1 <span class="token operator">|</span> openssl base64</code></pre><p>则最终 scheme 应该长这个样子： </p><blockquote><p> digest:dylan:7i6SL+m6GkW2OYpURnpkay0UdBc=:crwda</p></blockquote><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200404065646.png-growing" alt="digest NoAuth"></p></li><li><p>ip：使用客户端主机 IP 作为 ACL ID 身份。 ACL 表达式的形式为 addr / bits，其中 addr 的最高有效位与客户端主机 IP 的最高有效位相匹配。如： <code>ip:127.0.0.1/16:crwda</code>   这里文档说最高有效位与 client 主机 ip 最高有效位要相匹配，不过我实际试了下，不匹配也没有关系，这里暂时存疑。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200404070529.png-growing" alt="acl ip"></p></li><li><p>auth： 无 id， 对所有已认证的用户开放。形如 <code>auth::crwda</code> ，这里即使设置了 id，也会被忽略掉！</p></li><li><p>x509：使用 <strong>x509</strong> 证书进行 client 端验证，使用该方案时，需要在配置文件中配置如下选项 ，具体参见 <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperAdmin.html" target="_blank" rel="noopener">这里</a></p><blockquote><p>zookeeper.ssl.keyStore.location</p><p>zookeeper.ssl.trustStore.location</p><p>zookeeper.ssl.keyStore.password</p><p>zookeeper.ssl.trustStore.password</p></blockquote></li></ul><p>事实上，还有 <code>sasl</code>，你可以在 zoo.cfg 中进行配置：</p><blockquote><p>authProvider.1=org.apache.zookeeper.server.auth.SASLAuthenticationProvider</p></blockquote><p>以及 <code>super</code>  ！！！ </p><h2 id="Watch"><a href="#Watch" class="headerlink" title="Watch"></a>Watch</h2><p>Watch 有关的官方文档请参考 <a href="http://zookeeper.apache.org/doc/r3.6.0/zookeeperProgrammers.html#ch_zkWatches" target="_blank" rel="noopener">这里</a></p><p>zk 的 watch 机制，也是我们 <a href="../introduction/">这篇文章</a> 提到的很多应用的保证之一，正式因为 zk 的 watch 机制提供了这些保证，我们才能说，这样做，是可以的。</p><p>那么，zk 的 watch 机制究竟是什么？又提供了哪些保证呢？</p><p>zk watch event ，当 watch 的 数据发生变化时，watch event 会 <strong>一次触发</strong> ，发送给设置了 watch event 的客户端。</p><ul><li>one-time trigger ： 当设置的 watch event 被处罚时，触发且仅触发一次。当这个节点再次改变时，不会二次触发，除非再次设置 watch event(<strong>3.6 中已经增加了永久，永久递归类型的 watch</strong>)</li><li>send to the client：watch event 会被异步的发送被 client，由于网络延迟等问题，会导致各个 client 收到 event 的时间差异， zk 保证 <strong>一个 client 永远不会在 watch event 到来前，观察到数据的变更，只有在 client 监听到 event 后，才能感知到数据的变化</strong> </li><li>the data for which the watch was set：这里指 zk 不同的 watch event ，会产生不同的效果。这里下文会介绍到</li></ul><h3 id="1-watch-event-type"><a href="#1-watch-event-type" class="headerlink" title="1. watch event type"></a>1. watch event type</h3><p>我们在 <code>org.apache.zookeeper.Watcher.Event.EventType</code> 能看到， 3.6 版本总共有如下几种 watch event：</p><ul><li>None：无 watch</li><li>NodeCreated：通过 exists() 添加，当这个节点被创建后，发出 watch event</li><li>NodeDeleted：通过 exists , getData , getChildren 添加</li><li>NodeDataChanged：exists 和 getData 添加</li><li>NodeChildrenChanged： getChildren 添加</li><li>DataWatchRemoved： exists 和 getData 添加</li><li>ChildWatchRemoved：getChildren 添加</li><li>PersistentWatchRemoved：persistent watch 添加， <font color="red">3.6.0</font> 中，专门有 addWatch 方法，该方法可以指定 watcher 类型，具体需要参考使用 zk client：<ul><li>PERSISTENT ： 持久 watch ，data change 和 children change 均会被触发</li><li>PERSISTENT_RECURSIVE：持久递归 watch，会 watch 给定 path 的 children</li></ul></li></ul><h3 id="2-zookeeper-guarantees-about-watches"><a href="#2-zookeeper-guarantees-about-watches" class="headerlink" title="2. zookeeper guarantees about watches"></a>2. zookeeper guarantees about watches</h3><ul><li>zk(准确说是 zk client) 保证 watch event 的派发是有序的</li><li>zk client 在收到 znode 的 watch event 之后才能看到该 znode 的新数据</li><li>zk 中 watch event 的顺序与 zk 看到的更新顺序一致。即 zk 中的 watch event 顺序与 zk 的更新顺序相对应</li></ul><p>基于 watch event 的特点，有两个地方需要特别注意：</p><ul><li>如果你使用一次性的 watch event，则在再次 watch znode 的时候，你需要做好遗漏该 znode 可能出现的多次变更的情况。因为在你再次添加 watch event 的时候，这个 znode 可能已经被改变了好几次了。</li><li>watch event 是 one-time trigger ， 也就是说，如果你既通过 exists 又通过 getData 设置了 watch event ，那么你最终只会获得一个 watch event 事件。</li></ul><h2 id="To-Be-Continue"><a href="#To-Be-Continue" class="headerlink" title="To Be Continue"></a>To Be Continue</h2><ol><li>FastLeaderElection</li><li>Zab 协议详解</li><li>部分源码解析</li><li>watch 源码解析</li></ol><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part 1 -- ZOOKEEPER 概要</title>
      <link href="/zookeeper/introduction/"/>
      <url>/zookeeper/introduction/</url>
      
        <content type="html"><![CDATA[<h1 id="ZooKeeper-lt-一-gt-应用场景"><a href="#ZooKeeper-lt-一-gt-应用场景" class="headerlink" title="ZooKeeper  < 一 > 应用场景"></a>ZooKeeper  &lt; 一 &gt; 应用场景</h1><blockquote><p>A Distributed Coordination Service for Distributed Applications</p></blockquote><p>这是 ZooKeeper 官方文档上的一句话，意为： 一款为分布式应用而生的分布式协同服务。</p><p>ZooKeeper version： 3.6.0</p><h2 id="ZooKeeper-架构"><a href="#ZooKeeper-架构" class="headerlink" title="ZooKeeper 架构"></a>ZooKeeper 架构</h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200403025045.jpg-growing" alt="ZooKeeper Architecture"></p><p>zk 集群通常包含</p><h3 id="1-角色"><a href="#1-角色" class="headerlink" title="1. 角色"></a>1. 角色</h3><ul><li>Leader：或者叫 Master <ul><li>zk集群(官方称之为 ensemble) 中，同一时间只有一个 leader，如果有多个，我们称之为 脑裂(网络分区可能产生这种情况)</li><li>leader 节点负责 ensemble 中所有的写操作，完成后广播给各个节点</li><li>leader 节点负责发起并维护与各个 follower/observer 的心跳。如果 leader 宕机，follower 收不到心跳，就会发起选举</li></ul></li><li>Follower：<ul><li>负责与之连接的 client 的读请求</li><li>负责将写请求转发给 leader</li><li>响应 leader 的心跳</li><li>参与选举</li></ul></li><li>Observer：不参与投票！其他与 Follower 功能一致</li></ul><h3 id="2-组件"><a href="#2-组件" class="headerlink" title="2. 组件"></a>2. 组件</h3><h4 id="2-1-ZNode-zookeeper-data-node"><a href="#2-1-ZNode-zookeeper-data-node" class="headerlink" title="2.1 ZNode(zookeeper data node)"></a>2.1 ZNode(zookeeper data node)</h4><p>在 <code>org.apache.zookeeper.CreateMode</code> 枚举类中，共有 7 中 znode 类型，我们一一介绍：</p><ul><li>PERSISTENT ： flag=0，持久节点，除非主动删除，否则一直存在</li><li>PERSISTENT_SEQUENTIAL ： flag = 2，持久顺序节点，该节点会带上一个单调递增的 10 位序列号</li><li>EPHEMERAL ：flag = 1，临时节点，会话结束即被删除</li><li>EPHEMERAL_SEQUENTIAL ：flag = 3，临时顺序节点，会话结束即被删除</li><li>CONTAINER ： flag = 4， 容器节点，当该节点下所有子节点被删除后， 该节点将在将来的某个时刻被删除</li><li>PERSISTENT_WITH_TTL ： flag = 5，该节点在客户端断开时不会被删除，但若在给定的 TTL 范围内没有修改，且没有子节点时， 将被删除</li><li>PERSISTENT_SEQUENTIAL_WITH_TTL ： flag = 6， 同上，多了顺序</li></ul><h4 id="2-2-ACL"><a href="#2-2-ACL" class="headerlink" title="2.2 ACL"></a>2.2 ACL</h4><p><a href="../how-to-use/#toc-heading-6">点击这里</a></p><h4 id="2-3-Watcher"><a href="#2-3-Watcher" class="headerlink" title="2.3 Watcher"></a>2.3 Watcher</h4><p><a href="../how-to-use/#toc-heading-10">点击这里</a></p><h4 id="2-4-ZAB"><a href="#2-4-ZAB" class="headerlink" title="2.4 ZAB"></a>2.4 ZAB</h4><p><a href="../zab/">点击这里</a></p><h2 id="ZooKeeper-常用应用场景"><a href="#ZooKeeper-常用应用场景" class="headerlink" title="ZooKeeper 常用应用场景"></a>ZooKeeper 常用应用场景</h2><h3 id="1-命名服务"><a href="#1-命名服务" class="headerlink" title="1. 命名服务"></a>1. 命名服务</h3><p>我们知道，zk 的顺序节点特性，就是创建的节点名后，会被加上一个单调递增的 10 位序列号。利用这个特性，我们可以实现全局统一命名服务。</p><ol><li><p>client1 向 /_namespace/_type1 节点下创建 _name 顺序节点，拼接后， _namespace_type1_name0000000001 </p></li><li><p>client2 向 /_namespace/_type2 节点下创建  _name 顺序节点，会获得，  _namespace_type2_name0000000002</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200403122544.png-growing" alt="zk namespace server"></p></li></ol><p>这样就实现了统一命名 </p><h3 id="2-分布式锁"><a href="#2-分布式锁" class="headerlink" title="2. 分布式锁"></a>2. 分布式锁</h3><p>分布式锁在这里可以分为两种</p><ul><li>抢占式</li><li>非抢占式</li></ul><p>对于<strong>抢占式分布式锁</strong>而言，可以利用 zk 的临时节点特性。</p><p>每个需要 Lock 的 client 向 zk 的 /lock 节点下创建 /get_lock 子节点(临时节点)，创建成功的 client 获得锁，完成后删除该临时节点。</p><p>其他 client 在创建失败后，watch 该节点，一旦发现被删除，再次试图创建 /get_lock ，成功即可获得锁。</p><p>对于非抢占式而言，可以利用 zk 的临时顺序节点特性。</p><p>每个需要 Lock 的 client ，在 /lock 节点下创建 /get_lock 临时顺序节点，成功后获取 /lock 节点下所有子节点，如果序号是最小的，则获取锁，否则 watch 上一个节点，收到 delete event 后即可获得 lock，使用完删除节点，释放锁</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200403121745.png-growing" alt="lock flow"></p><h3 id="3-发布订阅"><a href="#3-发布订阅" class="headerlink" title="3. 发布订阅"></a>3. 发布订阅</h3><p>服务发现，配置中心，都是一样。</p><p>这里以 dubbo zookeeper registry 的实现为例，如何利用 zk 的 临时节点，来完成服务发现</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200403123158.jpg-growing" alt="Dubbo ZooKeeper Registry Flow"></p><p>这里令 /root = /dubbo/com.foo.BarService</p><ul><li><p>首先启动服务提供者，会向 zk 的 /root/providers 节点下，写入自己的 URL 地址(临时节点)</p></li><li><p>然后启动服务消费者，会对 /root/providers 添加 watch，或者说是订阅，同时向 /root/consumers 节点下写入自己的 URL 地址(临时节点)</p></li><li><p>监控中心(一般为 dubbo admin)启动，watch 或者说订阅整个 /root 节点的 children，这样，当 provider 或者 consumer 发生变动时，我们就能及时的通过 dubbo admin 观察到</p></li></ul><h3 id="4-Master-选举"><a href="#4-Master-选举" class="headerlink" title="4. Master 选举"></a>4. Master 选举</h3><p>所谓 Master 选举，这里说的并不是 zk 的 leader 选举。</p><p>在分布式系统下，我们常常会遇到定时任务这种场景。比如在凌晨四点(凌晨再也没有四点了… )统计昨天的商品报表，我们只需要一个 server 去跑就好了。这里就可以利用 zk 的临时节点特性。</p><p>同样的，每台 server 在 run job 时，先去 zk 注册一个特定临时节点，比如 <code>/item/_statistics</code> ，由创建成功的 server 去执行就好</p><h3 id="5-others"><a href="#5-others" class="headerlink" title="5. others"></a>5. others</h3><ul><li>集群监控： 做法类似，每台 server 到指定节点下(如 _monitor)注册一个 ephemeral 类型节点，监控端负责 watch _monitor ,当有机器加入或者掉线，就会收到通知</li><li>分布式队列(FIFO)：利用 zk 的临时有序节点特性，在指定节点下创建临时有序节点后获取所有子节点，如果自己序号最小，则执行</li><li>负载均衡：利用临时节点特性，server 在指定节点创建临时节点，客户端读取节点下所有子节点列表，选择 server 服务</li></ul><h2 id="ISSUE"><a href="#ISSUE" class="headerlink" title="ISSUE"></a>ISSUE</h2><p><strong>New in 3.6.0:</strong> Clients can also set permanent, recursive watches on a znode that are not removed when triggered and that trigger for changes on the registered znode as well as any children znodes recursively.</p><p>3.6.0 已经开始支持永久的 watch 了</p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="http://zookeeper.apache.org/doc/r3.6.0/index.html" target="_blank" rel="noopener">ZooKeeper 官方文档 r3.6.0</a></p><p><a href="https://github.com/apache/zookeeper" target="_blank" rel="noopener">GITHUB</a></p><p><a href="http://dubbo.apache.org/zh-cn/docs/user/references/registry/zookeeper.html" target="_blank" rel="noopener">Dubbo ZooKeeper Registry</a></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Part 0 -- PAXOS</title>
      <link href="/zookeeper/paxos/"/>
      <url>/zookeeper/paxos/</url>
      
        <content type="html"><![CDATA[<h1 id="ZooKeeper-lt-零-gt-Paxos-算法浅析"><a href="#ZooKeeper-lt-零-gt-Paxos-算法浅析" class="headerlink" title="ZooKeeper<零> Paxos 算法浅析"></a>ZooKeeper&lt;零&gt; Paxos 算法浅析</h1><p>本文基于 <a href="https://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">Wiki Paxos 算法</a> 成文</p><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Paxos 算法由 Lamport 大神于 1990 年提出的一种基于消息传递且具有高度容错特性的共识算法。</p><p>Mike Burrows(Google Chubby 作者)曾说过：</p><blockquote><p>there is only one consensus protocol, and that’s Paxos</p></blockquote><p>我们知道，在分布式系统中，节点通信分为两种模型</p><ul><li>共享内存</li><li>消息传递</li></ul><p>基于消息传递模型的分布式系统，必然需要考虑如下问题</p><ul><li>消息丢失</li><li>消息重复</li><li>消息延迟</li><li>…</li></ul><p>在不考虑拜占庭错误的情况下，Paxos 算法解决的问题就是</p><blockquote><p>在一个可能发生上述异常的分布式场景中，如何就某一个值达成一致，</p><p>保证不论发生以上任何异常，都不会破坏决议的共识。</p><p>如在一个分布式数据库系统中，若各节点初始状态一致，每个节点都执行相同的</p><p>操作序列，那么最后能得到一个一致的状态。</p><p>为保证每个节点执行相同的命令序列，需要在每一条指令上执行一个“共识算法”</p><p> –  <a href="https://zh.wikipedia.org/wiki/Paxos算法" target="_blank" rel="noopener">WIKI Paxos 算法</a></p></blockquote><h2 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h2><p>在 Paxos 算法中，角色：</p><ul><li>proposer : 负责提出提案，相当于 zk 中的 leader</li><li>acceptor： 负责接受提案，相当于 zk 中的 follower</li><li>learner：负责学习提案，相当于 zk 中的 learner</li></ul><p>在具体的实现中，一个进程可能不止充当一种角色</p><p>本文中使用的名词：</p><ul><li><p>quorum： 超过半数的 acceptor 组成的集合(最早称之为 majority，这里直接使用 quorun)</p></li><li><p>proposal： 提案，由 proposal 提出，包含编号和值： proposal(n,v)</p></li><li><p>value：决议，被批准的提案，同样包括编号和值：value(n,v)</p></li></ul><h2 id="基准约束"><a href="#基准约束" class="headerlink" title="基准约束"></a>基准约束</h2><p>首先由 proposer 提出 proposal(n,v)，acceptor 接到提案后，可以选择接受提案，当该 proposal 获得了 quorum (大多数 acceptor)的支持后，则该 proposal 被批准(chosen)，成为 value，由 learner 进行学习。</p><p>那么， Paxos 要解决的问题可以归纳为：</p><ul><li>只有被 proposer 提出的提案(proposal)才能被选定</li><li>一次 Paxos 执行，只能有一个值(v)被选定</li><li>learner 只能获得被批准的提案(value)</li></ul><h2 id="推导"><a href="#推导" class="headerlink" title="推导"></a>推导</h2><p>Lamport 大神通过不断加强上述的三个约束(主要是第二个约束)，获得了 Paxos 算法。</p><h3 id="1-P1"><a href="#1-P1" class="headerlink" title="1. P1"></a>1. P1</h3><p>当只有一个 acceptor 存在时，acceptor 会选择它收到的第一个 proposal 作为 value(选定的提案)，提案流程结束。</p><p>然而，一个 acceptor 会导致单点问题，即这个 acceptor 挂掉后，整个分布式集群就无法工作(zk 通过 ZAB 协议解决了单点问题，不过在选举的过程中，仍然是多 acceptor)。</p><p>多 acceptor 时， proposer 向 acceptor 集合 (acceptors) 发送 proposal，当有足够多的 acceptor 接受时，这个 proposal 就被选定，成为决议(value)。</p><p>这里的足够多，我们认为是超过半数的 acceptor ，亦即前文的 quorun。</p><p>因为两组 quorum，必然至少包含同一个 acceptor， 如果一个 acceptor 最多只能通过一个提案，那么就能保证最终只有一个提案被选定。</p><p>我们希望在即使只有一个提案被提出的情况下，仍然能产生 value，由此我们得到 P1:</p><blockquote><p><strong>P1: 一个 acceptor 必须接受它第一次收到的提案</strong></p></blockquote><p>注意，这里的 P1 是不完备的。当 acceptor 个数为偶数，又恰好一半 acceptor 接受 A 提议，另一半接受 B 提议时，此时无法产生决议。</p><p>提案被选定需要半数以上 acceptor 通过，意味着，一个 acceptor 必须能通过不止一个提案。当一个具有 v 值的提案被 quorum 通过，我们就认为提案被选定。</p><h3 id="2-P2"><a href="#2-P2" class="headerlink" title="2. P2"></a>2. P2</h3><p>我们基于上文以及基准约束 2：</p><blockquote><p>一次 Paxos 执行，只能有一个值(v)被选定</p></blockquote><p>可以看到， Paxos 并不要求只批准一个 proposal，也就是说可能会批准多个提案。只要提案的值，即 proposal.v 一致，就不违背基准约束 2 ，于是我们得出</p><blockquote><p><strong>P2: 一旦一个具有 v 值的提案 proposal(n,v) 被批准，则之后批准的提案必须具有 v 值</strong></p></blockquote><p>这里的之后，一般都是通过一个全局序号(zk 中指 zxid)，来进行判断</p><h3 id="3-P2a"><a href="#3-P2a" class="headerlink" title="3. P2a"></a>3. P2a</h3><p>批准一个 value，意味着多个 acceptor 接受了这个 value，因此可以对 P2 进行加强：</p><blockquote><p>P2a：一旦一个 proposal(n,v) 被批准，则之后任何 acceptor 再次接受的提案，必须也具有 v 值</p></blockquote><p>满足 P2a ,即满足 P2</p><p>但是由于通信是异步的，当已经产生 value 后，一个 proposer 和 acceptor 刚苏醒，而这个 proposer 提出了一个新的 proposal(n1,v1) 提案，根据 P1 ，这个 acceptor 应该接受，但根据 P2a，又不应该接受！怎么办？</p><h3 id="4-P2b"><a href="#4-P2b" class="headerlink" title="4. P2b"></a>4. P2b</h3><p>我们想到在 proposer 端进行限制：</p><blockquote><p>P2b：一旦一个 proposal(n,v) 被批准，则之后任何 proposer 提出的提案，必须具有 v 值</p></blockquote><p>一个提案被 acceptor 接受前，需要由 proposer 提出，因此， 满足 P2b ==&gt; P2a ==&gt; P2</p><p>如何保证 P2b 呢？</p><p>我们假设 proposal(m,v) 提案被选定，根据 P2b， 则有 proposal(n,v’)，当 n &gt; m 时， v’ = v .</p><p>那么，如何来保证 v’ = v 呢？</p><h3 id="5-P2c"><a href="#5-P2c" class="headerlink" title="5. P2c"></a>5. P2c</h3><blockquote><p>P2c：若 proposal(n,v) 被提出，则存在一个 quorum 满足以下中的任一条件：</p><p>​    a)  quorum 中所有 acceptor 都未接受编号小于 n 的提案</p><p>​    b)  quorum 中所有 acceptor 已经接受所有编号小于 n 的提案中，最大的那个提案 v 值</p></blockquote><p>证明过程如下：</p><blockquote><p>假设具有value v的提案m获得批准，当n=m+1时，采用反证法，假如提案n不具有value v，而是具有value w，根据P2c，则存在一个多数派S1，要么他们中没有人接受过编号小于n的任何提案，要么他们已经接受的所有编号小于n的提案中编号最大的那个提案是value w。由于S1和通过提案m时的多数派C之间至少有一个公共的acceptor，所以以上两个条件都不成立，导出矛盾从而推翻假设，证明了提案n必须具有value v；</p><p>若（m+1）..（N-1）所有提案都具有value v，采用反证法，假如新提案N不具有value v，而是具有value w’,根据P2c，则存在一个多数派S2，要么他们没有接受过m..（N-1）中的任何提案，要么他们已经接受的所有编号小于N的提案中编号最大的那个提案是value w’。由于S2和通过m的多数派C之间至少有一个公共的acceptor，所以至少有一个acceptor曾经接受了m，从而也可以推出S2中已接受的所有编号小于n的提案中编号最大的那个提案的编号范围在m..（N-1）之间，而根据初始假设，m..（N-1）之间的所有提案都具有value v，所以S2中已接受的所有编号小于n的提案中编号最大的那个提案肯定具有value v，导出矛盾从而推翻新提案n不具有value v的假设。根据数学归纳法，我们证明了若满足P2c，则P2b一定满足。</p><p>—- <a href="https://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">WIKI</a></p></blockquote><p>为了维护 P2c 的不变性，当一个 proposer 提出 proposal(n,v) 时，必须要知道某一个将要或者已经被 quorum 通过的编号小于 n 的最大编号的提案值。</p><p>我们需要限定「将要通过」的情况，毕竟我们无法预测未来。这表示，proposer 会请求 acceptor 不再接受任何编号小于 n 的提案。</p><h3 id="6-算法"><a href="#6-算法" class="headerlink" title="6. 算法"></a>6. 算法</h3><p>上面的分析，可以推出如下算法：</p><h4 id="1-Proposer"><a href="#1-Proposer" class="headerlink" title="1. Proposer"></a>1. Proposer</h4><h5 id="1-1-prepare"><a href="#1-1-prepare" class="headerlink" title="1.1 prepare"></a>1.1 prepare</h5><ul><li>proposer 提交 proposal(n,v) 给 acceptors</li><li>proposer 要求 acceptor 做出如下承诺：<ul><li>保证不再通过任何小于编号 n 的提案</li><li>如果存在已通过的编号小于 n 的提案，将通过的小于 n 的最大编号提案返回</li></ul></li></ul><h5 id="1-2-commit-propose"><a href="#1-2-commit-propose" class="headerlink" title="1.2 commit/propose"></a>1.2 commit/propose</h5><ul><li>收到超过半数的 ack 回复，则产生 proposal(n, v)，这里的 v 是所有响应中编号最大的提案的 v 值，若响应中不包含，则由 proposer 自己选择</li></ul><h4 id="2-Acceptor"><a href="#2-Acceptor" class="headerlink" title="2. Acceptor"></a>2. Acceptor</h4><blockquote><p>P1a： acceptor 可以接受一个编号为 n 的提案，只要它还未响应任何编号大于 n 的 prepare 请求</p></blockquote><p>可以看出： P1a 蕴涵 P1</p><h5 id="2-1-prepare"><a href="#2-1-prepare" class="headerlink" title="2.1 prepare"></a>2.1 prepare</h5><ul><li>收到 propser 的 prepare(n.v) 请求，如果编号 n &gt; 所有响应中最大的提案编号，返回已经通过的最大编号的提案(没有可以返回 nil)</li></ul><h5 id="2-2-commit-accept"><a href="#2-2-commit-accept" class="headerlink" title="2.2 commit/accept"></a>2.2 commit/accept</h5><ul><li>收到 proposer 的 accept 请求后，如果没有对编号大于 n 的 prepare 请求做出过响应，就接受这个提案</li></ul><h4 id="3-整体描述"><a href="#3-整体描述" class="headerlink" title="3. 整体描述"></a>3. 整体描述</h4><h5 id="3-1-prepare-阶段："><a href="#3-1-prepare-阶段：" class="headerlink" title="3.1 prepare 阶段："></a>3.1 prepare 阶段：</h5><ul><li>proposer  发送 prepare(n,v) 给 acceptors</li><li>acceptor 收到 prepare(n,v) 后，如果 n 大于它已经响应的所有 prepare 请求编号， 则保证不再 <font color="#ff0000">accept</font> 任何编号小于 n 的提案，同时将已经通过的最大编号的提案(如果存在)回复。(这里已经通过，指的是该 acceptor 接受的提案，而不是 prepare 响应的提案)</li></ul><h5 id="3-2-propose-阶段："><a href="#3-2-propose-阶段：" class="headerlink" title="3.2 propose 阶段："></a>3.2 propose 阶段：</h5><ul><li>proposer 在收到大多数 acceptors 的回复后，根据回复，获取回复中编号最大的 value(如果所有回复中，都没有，则 value 可自行确定)，向 acceptors 发送 accept(n,v) 请求</li><li>在不违背 acceptor 对其他 proposer 的承诺下，acceptor 接受这个提案，否则拒绝。换句话说，即 如果 acceptor 收到一个针对编号 n 的提案的 accept 请求，<strong>只要它还未对编号大于 n 的 prepare 请求作出响应，它就可以通过这个提案</strong>。</li></ul><h3 id="7-流程图"><a href="#7-流程图" class="headerlink" title="7. 流程图"></a>7. 流程图</h3><p>我们以两个 proposer 和 3 个 acceptor 为例。</p><p>prepare 阶段，主要有两个方法</p><ul><li>prepare(n, expected_v) ： 由 proposer 发起一个编号为 n，值为 expected_v 的请求</li><li>promise(ack, accepted_n, accepted_v)：由 acceptor 返回，ack 为应答，accepted_n 为 acceptor 已经通过提案的最大编号，accepted_v 为对应的值，没有则为 nil</li></ul><p>accept/propose 阶段，也是两个方法</p><ul><li>propose(n，expected_v)：在该 proposer 收到超过半数 ack 后，发起 propose(n,expected_v) 请求，expected_v 为收到的应答中，最大编号的值，如果没有，就是自己的值</li><li>accept(ack, error)： 在不违背对其他 proposer 的承诺下，acceptor 接受这个提案，返回(ack, nil)， 否则返回 (ack, error)</li></ul><p><em>注</em> ： 这里<em>不违背对其他 proposer 的承诺</em>  ，指的是</p><ul><li>不响应编号比 n 小的提案</li><li>不接受编号比 n 小的提案</li></ul><p>WIKI 中说</p><blockquote><p>acceptor 收到 prepare 消息后，如果提案的编号大于它已经回复的所有 prepare 消息(回复消息表示接受accept)，则 acceptor 将自己上次接受的提案回复给 proposer，并承诺不再回复小于 n 的提案</p></blockquote><p>这里的<strong>承诺不再回复小于 n 的提案</strong> ，即指上面的两个不。</p><p>在 acceptor 收到 accept 请求前，如果收到了 prepare(n+1, v’)，那个这个 accept 请求则不会被应答，或者返回一个 error</p><h4 id="prepare"><a href="#prepare" class="headerlink" title="prepare"></a>prepare</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200402124723.png-growing" alt="prepare phrase"></p><p>P1 和 P2 分别向 A1/A2, A2/A3 发送 prepare 请求，A1/A3 都是正常应答，同时将各自的应答记录修改。</p><p>A2 先收到 P1 prepare 请求，responsed_n 置为 1， 同时给与 P1 ack， 后收到 P2 prepare(2, 2)，根据规则，P2 的提案编号 2 大于 P1 的编号 1，所以，A2 将 responsed_n 置为 2， 同时回复 ack。这里 A2 在此之前，并没有批准，即 accept 任何提案，所以回复的 promise 应该为 promise(ack, nil, nil)</p><p>那么此时 P1 和 P2 都得到了半数以上的 ack ，都可以进行 accept 请求。</p><h4 id="propose-accept"><a href="#propose-accept" class="headerlink" title="propose/accept"></a>propose/accept</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200402134022.png-growing" alt="accept phrase"></p><p>在第二阶段</p><p>P1， 向 A1, A2, A3 发起 propose(1, 1) 请求， 其中：</p><ul><li>A1： 在 P2 发送请求之前，收到了 P1 的 propose 请求，在此之前只收到过 P1 的 prepare 请求，未对编号大于 1 的 prepare 请求做出过回应，遵守承诺，接受了 P1 的请求，回复 ack， accept(ack, nil, nil)</li><li>A2/A3：已经收到过 P2 的 prepare 请求，且 P2 编号 2， 大于 1，不回复 P1 或回复 error</li></ul><p>所以 P1 得到 A1 的 ack ，未超过半数</p><p>P2， 向 A1， A3 发起 propose(2, 2) 请求，其中：</p><ul><li>A1： 未作出过大于 2 的 prepare 响应，接受 P2 的请求，修改 responsed_n，accepted_n/v 同时返回 accept(ack)</li><li>A3：同样未违背承诺，修改 responsed_n, accepted_n/v ， 返回 accept(ack)</li></ul><p>P2 收到半数以上的 ack ，提案被选中。</p><p>之后 A1 再次去发起提案的时候，此时 n 会递增到 3，在 prepare(3,1) 阶段，会收到 A1，A3 的 ack，形如 propose(ack, 2, 2)， A1 收到半数请求后，从中挑出编号不大于 3 的最大编号，同时修改自己的值， 从 1 变为 2，再次发送 prepare(3,2)，会得到超过半数的 ack ， 提案被选中，结束。</p><p>本轮 paxos 中，最终选择的值为 2</p><h3 id="8-Paxos-活锁-LiveLock"><a href="#8-Paxos-活锁-LiveLock" class="headerlink" title="8. Paxos  活锁(LiveLock)"></a>8. Paxos  活锁(LiveLock)</h3><p>我们以 P1, P2 + A 为例</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200402140130.png-growing" alt="prepare phrase LiveLock"></p><p>如图示，每次 P1 或 P2 propose 时， 总是会发现更高的 prepare 编号，从而不断进行 prepare 。</p><p>一般这种情况很少见，可以通过 <em>随即睡眠-重试</em> 的方法避免</p><h2 id="Multi-Paxos"><a href="#Multi-Paxos" class="headerlink" title="Multi-Paxos"></a>Multi-Paxos</h2><h2 id="Fast-Paxos"><a href="#Fast-Paxos" class="headerlink" title="Fast-Paxos"></a>Fast-Paxos</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://zh.wikipedia.org/wiki/Paxos%E7%AE%97%E6%B3%95" target="_blank" rel="noopener">WIKI Paxos 算法</a></li><li><a href="https://github.com/oldratlee/translations/tree/master/paxos-made-simple" target="_blank" rel="noopener">Paxos Made Simple 翻译稿</a></li></ul><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> middlewares </category>
          
      </categories>
      
      
        <tags>
            
            <tag> algorithm </tag>
            
            <tag> zookeeper </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Build Your Own Blog</title>
      <link href="/tools/blog/"/>
      <url>/tools/blog/</url>
      
        <content type="html"><![CDATA[<h1 id="hexo-搭建个人博客"><a href="#hexo-搭建个人博客" class="headerlink" title="hexo 搭建个人博客"></a>hexo 搭建个人博客</h1><ul><li><p><a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank" rel="noopener">hexo-theme-matery</a> </p></li><li><p><a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md" target="_blank" rel="noopener">README</a></p></li><li><p><a href="https://github.com/hexojs/hexo" target="_blank" rel="noopener">Hexo</a></p></li></ul><h2 id="BLOG-地址"><a href="#BLOG-地址" class="headerlink" title="BLOG 地址"></a>BLOG 地址</h2><p><a href="https://iyuhp.top">iyuhp’s blog</a> </p><h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><p>本 blog 使用 <a href="https://github.com/hexojs/hexo" target="_blank" rel="noopener">HEXO</a> 搭建， <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank" rel="noopener">MATERY</a> 作为主题， nginx 作静态代理，搭配 HTTPS 使用。</p><h2 id="搭建步骤"><a href="#搭建步骤" class="headerlink" title="搭建步骤"></a>搭建步骤</h2><h3 id="1-安装-hexo-cli"><a href="#1-安装-hexo-cli" class="headerlink" title="1. 安装 hexo-cli"></a>1. 安装 hexo-cli</h3><p>安装之前，请确认本机已经有 node 环境，可选择安装 cnpm。</p><pre class=" language-shell"><code class="language-shell">cnpm install -g hexo-cli</code></pre><h3 id="2-初始化一个-project"><a href="#2-初始化一个-project" class="headerlink" title="2. 初始化一个 project"></a>2. 初始化一个 project</h3><pre class=" language-shell"><code class="language-shell">hexo init blogcd blogcnpm i</code></pre><p>此时，通过 <code>tree . -L 1</code> 命令查看</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401073032.png-growing" alt="image-20200401073027300"></p><ul><li><p>_config.yml: 网站的配置信息， 绝大部分的配置，都在这里修改，这里的配置是你自己的配置</p></li><li><p>scaffolds： 模板文件夹，新建文章时， 根据其中的模板进行填充相关内容，可以在 _config.yml 中配置选择使用哪种模板</p></li><li><p>source：用户存放资源的地方。 除  _posts 文件夹之外，开头命名为 _ (下划线)的文件、文件夹和隐藏的文件将会被忽略。Markdown 和 HTML 文件会被解析并放到 public 文件夹，而其他文件会被拷贝过去</p></li><li><p>themes：主题文件夹， hexo 根据主题来生成静态页面，主题目中也会有一个 _config.yml 配置文件，是关于主题的配置</p></li></ul><h3 id="3-使用主题"><a href="#3-使用主题" class="headerlink" title="3. 使用主题"></a>3. 使用主题</h3><p>关于 matery 主题的使用，可以参考 <a href="https://github.com/blinkfox/hexo-theme-matery/blob/develop/README_CN.md" target="_blank" rel="noopener">这里</a> 。</p><p>我们把下载下来的稳定版本 copy 到 themes 目录下，然后在 _config.yml 中指定主题为 <code>hexo-theme-matery</code> , 同时参考 matery 文档，完成其他配置后，执行 <code>hexo s</code> 本地启动后，查看效果。</p><p>使用主题的方式有：</p><ol><li><p>直接下载后添加</p></li><li><p>或者 git clone 到 theme 目录下</p></li><li><p>或者 通过 git submodule</p><pre class=" language-shell"><code class="language-shell">git submodule add https://github.com/blinkfox/hexo-theme-matery.git themes/hexo-theme-matery</code></pre></li></ol><h3 id="4-新建文章"><a href="#4-新建文章" class="headerlink" title="4. 新建文章"></a>4. 新建文章</h3><p>在 <a href="https://hexo.io/zh-cn/docs/configuration" target="_blank" rel="noopener">这里</a> 可以查看到关于 hexo 的各种命令。</p><p>使用 *<em><code>hexo new --path folder/article "Oh Beautiful"</code> *</em>，会在当前 source/_post 目录下(这里根据你配置里的 default_layout，会在对应的目录下新建)新建一个 folder 目录，folder 目录中新建 article.md 文件， title 为 Oh Beautiful 。<br>这个命相比较于直接 new ， 好处是能把文章按照目录进行分类。</p><p>这里贴一份我的 scaffold 里 post.md 的 layout：</p><pre><code>---title: {{ title }}date: {{ date }}author: peifengimg: {{ zhankeng }}top: truecover: truecoverImg: {{ zhankeng }}password: passwordpasswordpasswordtoc: truemathjax: falsesummary: {{ zhankeng }}categories: Markdowntags:  - Typora  - Markdown---</code></pre><p>官网关于 new 命令的介绍</p><p>更多配置说明请参考 <a href="https://hexo.io/zh-cn/docs/configuration" target="_blank" rel="noopener">这里</a></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401070947.png-growing" alt="image-20200401070945664"></p><h3 id="5-使用评论插件"><a href="#5-使用评论插件" class="headerlink" title="5. 使用评论插件"></a>5. 使用评论插件</h3><p>hexo 的评论插件有很多种，比如 gitalk，gitment，disqus(国内基本可以不考虑)，valine 等，我看了各种效果， valine 和 gitalk 比较满意。</p><p>valine 需要先到 <a href="https://www.leancloud.cn/" target="_blank" rel="noopener">LeanCloud</a> 上注册账号，它会提供给开发者一个 <strong>1G</strong> 的免费存储空间( <a href="https://www.leancloud.cn/pricing/" target="_blank" rel="noopener">计价方案</a>)，超出部分 0.10 元 / GB / 天。 个人 blog，感觉肯定是够用的(这里不得不感叹，果然是能薅羊毛，就薅羊毛啊，啊哈哈哈)，因为其实不会有多少人来评论的！！！</p><p>不过我对于 valine 的权限控制有点不满意。因为我本身有后台服务支撑，后续打算对 valine 做点改动，所有评论由我自己递交给 leancloud，这样就不用暴露 leancloud 的 ak 和 sk 了。当然，这是静态 blog 的通病，木的办法。</p><p>而 gitalk，则是基于 github issue 做的实现，所有的评论，其实都是 github 上一个 repo 的 issue。这样的话，我其实不用关心这个 repo 的最终结局会怎样，大不了我删了重建一个新 repo 呗。</p><p>当然，gitalk 有两个问题</p><ol><li>网络问题，经常性出现 Network Error 之类的问题</li><li>权限问题，用户留言时，gitalk 会要求用户给与十分大的权限，如果这个 blog 博主拿到权限后，做了一些乱七八糟的事情，可就不太好了。。。我就碰到自动 fork 博主项目的</li></ol><p>关于 gitalk 的使用：</p><p><a href="https://github.com/gitalk/gitalk/blob/master/readme-cn.md" target="_blank" rel="noopener">gitalk 文档</a></p><ol><li>在 <a href="https://github.com/settings/applications/new" target="_blank" rel="noopener">New Oauth</a> 上新建一个授权应用</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401073717.png-growing" alt="image-20200401073715809"></p><p>callback URL， 这里说下，根据 oauth2 协议，这个 callback URL 就是完成授权后的回调地址，这里可以填写自己网站的首页。</p><ol start="2"><li>完成后会拿到 client id 和 client secret，填入到 theme 下的 _config.yml 即可。</li></ol><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401073826.png-growing" alt="image-20200401073822373"></p><ul><li>repo： 即你的评论提交的地方，一个 github repo</li><li>owner: 你 repo 所属的组织或者个人</li><li>admin: 对这个 repo 有写权限的人</li></ul><p>然后你就能愉快的使用评论功能了</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401073953.png-growing" alt="image-20200401073951830"></p><h3 id="6-其他优化"><a href="#6-其他优化" class="headerlink" title="6. 其他优化"></a>6. 其他优化</h3><h4 id="6-1-图片懒加载"><a href="#6-1-图片懒加载" class="headerlink" title="6.1 图片懒加载"></a>6.1 图片懒加载</h4><h4 id="6-2-代码压缩"><a href="#6-2-代码压缩" class="headerlink" title="6.2 代码压缩"></a>6.2 代码压缩</h4><h4 id="6-3-SEO-优化"><a href="#6-3-SEO-优化" class="headerlink" title="6.3 SEO 优化"></a>6.3 SEO 优化</h4><p>参考 <a href="https://blog.sky03.cn/posts/42790.html" target="_blank" rel="noopener">hexo 优化</a></p><h4 id="6-4-CDN-加速"><a href="#6-4-CDN-加速" class="headerlink" title="6.4 CDN 加速"></a>6.4 CDN 加速</h4><p>关于 CDN 加速，也是通过 github + <a href="https://www.jsdelivr.com/" target="_blank" rel="noopener">jsDelivr</a> 完成。具体操作就是，在发布代码的时候，如果本身就托管在 github 上，那最方便，直接在 theme 主题下的 _config.yml 中配置 <code>jsDelivr.url</code> 即可，形如：</p><pre><code># 如你的 repo 地址： https://github.com/A/B# 则这里的地址就这样填写https://cdn.jsdelivr.net/gh/A/B</code></pre><p>再次访问的时候， 就会去这里访问静态资源了。<br>我个人只把一部分如 css/js/libs 放到了 github 上，其他的，放在自己的 ecs 上。<br>关于 SEO 优化， 上面的文章也写的很详细了， 我个人只配置了 google 的， baidu 要做各种认证，就懒得配了，啊哈哈哈。</p><h3 id="7-百度统计"><a href="#7-百度统计" class="headerlink" title="7. 百度统计"></a>7. 百度统计</h3><p><a href="https://tongji.baidu.com/web/10000169496/welcome/login" target="_blank" rel="noopener">百度统计</a> 可以用来分析网站各个维度的信息，比如访问人数， pv， uv 等。<br>用起来也很简单， 先在 <a href="https://tongji.baidu.com/web/10000169496/welcome/login" target="_blank" rel="noopener">这里</a> 注册一个账号，创建一个应用，获取 id， 然后到 theme 下的 baiduAnalytics 那开启并配置 id ，即可看到一些统计信息了。</p><h3 id="8-end"><a href="#8-end" class="headerlink" title="8. end"></a>8. end</h3><p>至此，在本地就能很方便的访问了</p><h2 id="域名"><a href="#域名" class="headerlink" title="域名"></a>域名</h2><p>在 <a href="https://wanwang.aliyun.com/domain/" target="_blank" rel="noopener">域名注册</a> 这里可以挑选一个合适的域名， 我当时买的时候，<em>.top</em>  后缀三年，好像才几十块钱。注册完成后，看你自己选择，要不要备案。如果选择备案，需要打印一张表格，填完后拍照上传，之后到阿里云备案，阿里云会免费邮寄一张蓝色的幕布(就是一张蓝色的纸…)，然后你需要拍照上传。整个过程大约一个礼拜左右能搞定。不需要花钱。</p><h2 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h2><p>但是阿里云搞活动，我选购了一台， 很便宜了。现在不知道是什么情况</p><h2 id="SSL-证书"><a href="#SSL-证书" class="headerlink" title="SSL 证书"></a>SSL 证书</h2><p>免费的 SSL 证书，提供商也很多，我这里选择的是 <a href="https://freessl.cn/" target="_blank" rel="noopener">FreeSSL</a> ， 选择 Let’s Encrypt V2 ， 可以搞泛域名证书，这个还是很开心的。</p><p>如果你不需要泛域名， 只是单域名，那完全可以直接到阿里云/腾讯云等各个平台免费申请，都是一年的免费申请。还很方便。</p><p>在 freeSSL 上申请证书的时候，他会给你几个 TXT 类型的 DNS 解析，这个需要配置到你的 DNS 服务商那里。</p><p>阿里云的话， 在 <a href="https://dc.console.aliyun.com/next/index?spm=a2c1d.8251892.favorites.ddomain.784c5b76NZRlLv#/domain/list/all-domain" target="_blank" rel="noopener">这里</a> 应该能找到配置</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401074420.png-growing" alt="image-20200401074419037"></p><p>新添加后，基本都是立即生效的。(虽然说的是 10 分钟生效，还是相当谦虚的)</p><p>不过申请的 SSL 有效期，<font color="#ff0000"><strong>只有三个月</strong></font> ！！！注意需要定期更换</p><h2 id="Nginx-配置-1-14-1"><a href="#Nginx-配置-1-14-1" class="headerlink" title="Nginx 配置 (1.14.1)"></a>Nginx 配置 (1.14.1)</h2><p>在这一部分， 需要一个(备案的)域名，一台服务器(ecs)，以及 ssl 证书</p><p>Linux 下安装 nginx，这里不再赘述，centos 8 可以直接通过 <code>sudo dnf install nginx -y</code> 安装</p><p>这里多说一句， dnf 相比较于 yum，要更好用，按照历史规矩， yum 在将来，应该会被 dnf 取代。</p><p>再多说一句， centos 8 ，终于不再依赖 python2.7 了，vim 的基础版本也是 8.0，对于想要安装 YCM 的童鞋来说，也算是一个不错的好消息。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401074825.png-growing" alt="image-20200401074823558"></p><p>我的 nginx 目录长这样。</p><p>在 nginx.conf 中， include conf.d 目录下所有的 *.conf 的配置文件，这算很常见的配置方案，对于多应用来说，可以各自维护各自的 conf 文件。</p><p>我们在 <a href="https://ssl-config.mozilla.org/#server=nginx&amp;version=1.14.1&amp;config=intermediate&amp;openssl=1.1.1d&amp;guideline=5.4" target="_blank" rel="noopener">这里</a> 能找到一份不错的 nginx 配置，由 mozilla 推荐的配置</p><p>这是 nginx.conf 的完整配置以及 https 优化。</p><pre class=" language-nginx"><code class="language-nginx"><span class="token comment" spellcheck="true"># ...</span><span class="token comment" spellcheck="true"># 加载 nginx 模块</span><span class="token keyword">include</span> <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>modules<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span><span class="token keyword">http</span> <span class="token punctuation">{</span>    <span class="token comment" spellcheck="true"># ...</span>    <span class="token keyword">sendfile</span>            on<span class="token punctuation">;</span>    <span class="token keyword">tcp_nopush</span>          on<span class="token punctuation">;</span>    <span class="token keyword">tcp_nodelay</span>         on<span class="token punctuation">;</span>    <span class="token keyword">keepalive_timeout</span>   <span class="token number">65</span><span class="token punctuation">;</span>    <span class="token keyword">types_hash_max_size</span> <span class="token number">2048</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># 全局 ssl 证书配置</span>    <span class="token keyword">ssl_certificate</span>      <span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>nginx<span class="token operator">/</span>server_ssl<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>    <span class="token keyword">ssl_certificate_key</span>  <span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>nginx<span class="token operator">/</span>private<span class="token operator">/</span>server_ssl<span class="token punctuation">.</span>key<span class="token punctuation">;</span>    <span class="token keyword">ssl_certificate</span>     <span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>nginx<span class="token operator">/</span>ssl_ecc<span class="token punctuation">.</span>crt<span class="token punctuation">;</span>    <span class="token keyword">ssl_certificate_key</span> <span class="token operator">/</span>etc<span class="token operator">/</span>pki<span class="token operator">/</span>nginx<span class="token operator">/</span>private<span class="token operator">/</span>ssl_ecc<span class="token punctuation">.</span>key<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># session 配置</span>    <span class="token keyword">ssl_session_cache</span>    shared<span class="token punctuation">:</span><span class="token keyword">SSL</span><span class="token punctuation">:</span>10m<span class="token punctuation">;</span>    <span class="token keyword">ssl_session_timeout</span>  1d<span class="token punctuation">;</span>    ssl_session_tickets  off<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true"># 协议配置 ssl_ciphers 仅作示例，具体配置下文有说明</span>    <span class="token keyword">ssl_protocols</span>       TLSv1<span class="token number">.2</span> TLSv1<span class="token number">.3</span><span class="token punctuation">;</span>    <span class="token keyword">ssl_prefer_server_ciphers</span>   off<span class="token punctuation">;</span>    <span class="token keyword">ssl_ciphers</span>         CDHE<span class="token operator">-</span>ECDSA<span class="token operator">-</span>AES128<span class="token operator">-</span>GCM<span class="token operator">-</span>SHA256<span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># TODO 开启 oscp</span>    <span class="token comment" spellcheck="true"># ssl_stapling      on;</span>    <span class="token comment" spellcheck="true"># ssl_stapling_verify       on;</span>    <span class="token comment" spellcheck="true"># ssl_trusted_certificate   ospc_file_path</span>    <span class="token comment" spellcheck="true"># common header 证书有效期问题，这里设置 7776000 </span>    <span class="token keyword">add_header</span> Strict<span class="token operator">-</span>Transport<span class="token operator">-</span>Security <span class="token string">"max-age=7776000;"</span> always<span class="token punctuation">;</span>    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Frame<span class="token operator">-</span>Options <span class="token string">"SAMEORIGIN"</span> always<span class="token punctuation">;</span>    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Xss<span class="token operator">-</span>Protection <span class="token string">"1; mode=block"</span> always<span class="token punctuation">;</span>    <span class="token keyword">add_header</span> X<span class="token operator">-</span>Content<span class="token operator">-</span>Type<span class="token operator">-</span>Options <span class="token string">"nosniff"</span> always<span class="token punctuation">;</span>    brotli on<span class="token punctuation">;</span>    brotli_static on<span class="token punctuation">;</span>    brotli_min_length   <span class="token number">100</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 大于或等于 50 字节时才会进行压缩</span>    brotli_comp_level   <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 压缩等级 默认 6 越高 cpu 用的越多</span>    brotli_buffers      <span class="token number">16</span> 8k<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 请求缓冲区的数量和大小</span>    brotli_types text<span class="token operator">/</span>plain text<span class="token operator">/</span>css text<span class="token operator">/</span>javascript application<span class="token operator">/</span>javascript text<span class="token operator">/</span>xml application<span class="token operator">/</span>xml image<span class="token operator">/</span>svg<span class="token operator">+</span>xml application<span class="token operator">/</span>json<span class="token punctuation">;</span>    <span class="token keyword">include</span> <span class="token operator">/</span>etc<span class="token operator">/</span>nginx<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span><span class="token operator">*</span><span class="token punctuation">.</span>conf<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><h3 id="1-全局-ssl-证书配置"><a href="#1-全局-ssl-证书配置" class="headerlink" title="1. 全局 ssl 证书配置"></a>1. 全局 ssl 证书配置</h3><p>这里采用的是双证书模式，RSA 和 ECC 两种加密方式的证书。如果各自的 conf 有新证书，直接在各自的 conf 中配置，会覆盖掉全局的配置</p><h3 id="2-session-配置"><a href="#2-session-配置" class="headerlink" title="2. session 配置"></a>2. session 配置</h3><p>一般开启服务端 session 缓存，1M 大约能缓存 4000 个 session，这里配置了 10M</p><h3 id="3-协议优化"><a href="#3-协议优化" class="headerlink" title="3. 协议优化"></a>3. 协议优化</h3><p>TLSv1.1， TLSv1.2，TLSv1.3， TLSv1.3 相较于前者， 做到了更安全和更快， 如果你不需要向前兼容，直接选择 TLSv1.3 就好了。我本来也如此，后来对接 gitee 的 push hooks 的时候，发现握手一直挂，无奈，又配上了 TLSv1.2</p><p>关于 <code>ssl_prefer_server_ciphers off</code>  这个选项的更多解释：<a href="https://github.com/mozilla/server-side-tls/issues/260" target="_blank" rel="noopener">GITHUB ISSUE</a></p><h3 id="4-add-header"><a href="#4-add-header" class="headerlink" title="4. add_header"></a>4. add_header</h3><p>是一些列的安全配置和 hsts 配置</p><h3 id="5-brotli-压缩"><a href="#5-brotli-压缩" class="headerlink" title="5. brotli 压缩"></a>5. brotli 压缩</h3><p>一种压缩算法，比常用 gzip 要更给力。目前几乎所有主流浏览器都支持了 br ，但不免有漏网之鱼，所以可以选择同时支持 br 和 gzip 。</p><p>在使用 br 之前，需要先给 nginx 加上 brotli 模块。在 centos 8 下，操作如下：</p><h4 id="5-1-下载-nginx"><a href="#5-1-下载-nginx" class="headerlink" title="5.1 下载 nginx"></a>5.1 下载 nginx</h4><p>具体哪个版本，视你安装的 nginx 版本而定，可通过 <code>nginx -V</code> 查看， 我这里使用的是 <strong>nginx/1.14.1</strong> </p><pre class=" language-shell"><code class="language-shell"># 这之前， 你可能需要安装一些基础工具包sudo dnf install -y curl wget unzip socat bash-completion epel-release && sudo dnf groupinstall "Development Tools"sudo dnf install -y pcre pcre-devel zlib zlib-devel openssl openssl-develwget https://nginx.org/download/nginx-1.14.1.tar.gz && tar zxvf nginx-1.14.1.tar.gz</code></pre><h4 id="5-2-下载-brotli"><a href="#5-2-下载-brotli" class="headerlink" title="5.2 下载 brotli"></a>5.2 下载 brotli</h4><pre class=" language-shell"><code class="language-shell">git clone https://github.com/google/ngx_brotli.gitcd ngx_brotli && git submodule update --init</code></pre><h4 id="5-3-编译"><a href="#5-3-编译" class="headerlink" title="5.3 编译"></a>5.3 编译</h4><p>这里要十分的注意，我们需要编译的 <code>.so</code> 文件，最终是我们已经安装的 nginx 去执行，所以我们在 make 的时候，所有的环境配置需要和已安装的 nginx 一致。</p><p>我最开始的时候没有注意到这一点，踩了坑，最后 restart nginx 的时候，一致报 <strong>is not binary compatible</strong> 之类的错误</p><pre class=" language-shell"><code class="language-shell"># 1. 获取当前运行 nginx 的环境配置sudo nginx -V# 进入下载的 nginx 源码目录操作# 上一步会输出 configure arguments，我们设为 A， 把他们全部加入其中# --add-dynamic-module=../ngx_brotli 这里的路径根据你下载 brotli 的位置而定./configure A --add-dynamic-module=../ngx_brotli</code></pre><p>这一步执行的时候，可能还会报错，一般都是缺少依赖。如：</p><pre class=" language-shell"><code class="language-shell"># This is perl 5, version 26, subversion 3 (v5.26.3) built for x86_64-linux-thread-multi# Can't locate ExtUtils/Embed.pm in @INC (you may need to install the ExtUtils::Embed module).......# 此时执行：sudo dnf -y install perl-devel perl-ExtUtils-Embed# the HTTP image filter module requires the GD library# 执行sudo dnf -y install gd gd-devel</code></pre><h4 id="5-4-cp-so-文件"><a href="#5-4-cp-so-文件" class="headerlink" title="5.4 cp .so 文件"></a>5.4 cp .so 文件</h4><p>上一步执行完成后， 会在  nginx 下的 objs 目中中生成 </p><p><code>ngx_http_brotli_filter_module.so</code>   和 <code>ngx_http_brotli_static_module.so</code> </p><p>目标文件，我们把他们移动到原 nginx 的 mudule 中。 </p><p>先在 nginx.conf 中看 modules.conf 在哪里：</p><p><code>include /usr/share/nginx/modules/*.conf;</code>  说明所有的 module 配置文件都在这个目录下。</p><p>然后去这个目录，随便 cat 一个配置文件， 会输出：</p><pre class=" language-nginx"><code class="language-nginx">load_module <span class="token string">"/usr/lib64/nginx/modules/ngx_http_brotli_filter_module.so"</span><span class="token punctuation">;</span></code></pre><p>此时能看到，所有 module 的 .so 文件，都在这个地方，我们把这两个 <code>.so</code> 也 cp 这个目录</p><p>当然， 你也可以放入任何你想放的位置，然后在编写 .conf 的时候，指定路径就好了。</p><h4 id="5-5-编写-conf-文件"><a href="#5-5-编写-conf-文件" class="headerlink" title="5.5 编写 .conf 文件"></a>5.5 编写 .conf 文件</h4><p>移动完成后，同样的，我们在 modules 目录下，创建两个文件：</p><p> <code>mod-http-brotli-filter.conf</code>  和 <code>mod-http-brotli-static.conf</code> </p><p>内容分别为：</p><pre class=" language-nginx"><code class="language-nginx">load_module <span class="token string">"/usr/lib64/nginx/modules/ngx_http_brotli_filter_module.so"</span><span class="token punctuation">;</span></code></pre><p>和</p><pre class=" language-nginx"><code class="language-nginx">load_module <span class="token string">"/usr/lib64/nginx/modules/ngx_http_brotli_static_module.so"</span><span class="token punctuation">;</span></code></pre><p>当然，以上所有的路径，都以你实际的目录为准</p><h4 id="5-6-重启和验证"><a href="#5-6-重启和验证" class="headerlink" title="5.6 重启和验证"></a>5.6 重启和验证</h4><p><code>sudo nginx -t</code>  输出 ok 后 <code>sudo systemctl restart nginx</code>  </p><p>这时通过页面访问，能看到 br 即说明 ok</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401081528.png-growing" alt="image-20200401081526690"></p><h3 id="6-blog-conf-配置-启用-http2"><a href="#6-blog-conf-配置-启用-http2" class="headerlink" title="6. blog conf 配置[启用 http2]"></a>6. blog conf 配置[启用 http2]</h3><pre class=" language-nginx"><code class="language-nginx"><span class="token keyword">server</span> <span class="token punctuation">{</span>        <span class="token keyword">listen</span>       <span class="token number">80</span><span class="token punctuation">;</span>        <span class="token keyword">server_name</span>  iyuhp<span class="token punctuation">.</span>top<span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span> REMOTE<span class="token operator">-</span>HOST <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>        <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token number">301</span> <span class="token keyword">https</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token keyword">server</span> <span class="token punctuation">{</span>    <span class="token keyword">listen</span> <span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>    <span class="token keyword">listen</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token number">443</span> <span class="token keyword">ssl</span> http2<span class="token punctuation">;</span>    <span class="token keyword">server_name</span> iyuhp<span class="token punctuation">.</span>top<span class="token punctuation">;</span>    <span class="token keyword">try_files</span> <span class="token variable">$uri</span> <span class="token operator">/</span><span class="token keyword">index</span><span class="token punctuation">.</span>html<span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> Host <span class="token variable">$host</span><span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Real<span class="token operator">-</span>IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> REMOTE<span class="token operator">-</span>HOST <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>    <span class="token keyword">proxy_set_header</span> X<span class="token operator">-</span>Forwarded<span class="token operator">-</span>For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>    <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>        <span class="token keyword">root</span>            <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token operator">/</span>growing<span class="token operator">-</span>blog<span class="token operator">/</span>public<span class="token punctuation">;</span>        <span class="token keyword">index</span>           <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">location</span> <span class="token operator">=</span> <span class="token operator">/</span>favicon<span class="token punctuation">.</span>png <span class="token punctuation">{</span>            <span class="token keyword">expires</span>     30d<span class="token punctuation">;</span>            <span class="token keyword">access_log</span>  off<span class="token punctuation">;</span>            <span class="token keyword">root</span>        <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">location</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token operator">^</span><span class="token punctuation">.</span><span class="token operator">*</span>\<span class="token punctuation">.</span><span class="token punctuation">(</span>gif<span class="token operator">|</span>jpg<span class="token operator">|</span>jpeg<span class="token operator">|</span>png<span class="token operator">|</span>bmp<span class="token operator">|</span>swf<span class="token punctuation">)</span>$ <span class="token punctuation">{</span>            <span class="token keyword">expires</span>     15d<span class="token punctuation">;</span>            <span class="token keyword">access_log</span>  off<span class="token punctuation">;</span>            <span class="token keyword">root</span>        <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token operator">/</span>growing<span class="token operator">-</span>blog<span class="token operator">/</span>public<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment" spellcheck="true"># js/css 等，我们已经托管到 jsDelivr ，这里就不用再配置了</span>    <span class="token keyword">access_log</span>  <span class="token operator">/</span>var<span class="token operator">/</span>log<span class="token operator">/</span>nginx<span class="token operator">/</span>growing<span class="token operator">-</span>blog<span class="token operator">/</span>access<span class="token punctuation">.</span>log  main<span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>我们在 listen 的时候，如上图配置 http2 即可，无需 <code>ssl on</code>  </p><p>剩下都是常规配置， 没什么好说的， 无非是给一些静态文件添加缓存，这个根据实际情况配置就好。</p><p>我们打开控制台，能看到 <em>Protocol</em>  一栏，都显示为 <em>h2</em> ，说明配置生效</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401082103.png-growing" alt="image-20200401082101525"></p><h3 id="7-限流-Deny"><a href="#7-限流-Deny" class="headerlink" title="7. 限流 + Deny"></a>7. 限流 + Deny</h3><p>在 blog 跑了几天之后，我无事之时，看了眼 nginx 的日志，发现网络世界还是凶险啊。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200408220736.png-growing" alt="access.log"></p><p>针对各式各样乱七八糟的爬虫，还有一些端口扫描工具，我们可以简单的通过 user-agent 来做过滤，比如在你的 server 层(因为包含 if 语句，所以 http 层是放不了的)，加一个 ua-deny.conf 之类的文件</p><pre class=" language-nginx"><code class="language-nginx"><span class="token comment" spellcheck="true">#禁止Scrapy等工具的抓取</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token punctuation">(</span>Scrapy<span class="token operator">|</span>Curl<span class="token operator">|</span>HttpClient<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> <span class="token number">444</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">#禁止指定UA及UA为空的访问</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$http_user_agent</span> <span class="token operator">~</span><span class="token operator">*</span> <span class="token string">"tbox|Go http|FeedDemon|Indy Library|Alexa Toolbar|AskTbFXTV|AhrefsBot|CrawlDaddy|CoolpadWebkit|Java|Feedly|UniversalFeedParser|ApacheBench|Swiftbot|ZmEu|oBot|jaunty|Python-urllib|lightDeckReports Bot|YYSpider|DigExt|HttpClient|MJ12bot|heritrix|EasouSpider|Gather Analyze Provide|Ezooms|zgrab|^$"</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token keyword">return</span> <span class="token number">444</span><span class="token punctuation">;</span><span class="token punctuation">}</span></code></pre><p>这样就可以根据 ua 进行过滤。</p><p>同时，也可以分析日志，查找异常的 ip， 然后直接 deny 掉。</p><pre class=" language-shell"><code class="language-shell">awk '{print $1}' ./access.log | sort  | uniq -c| sort -n</code></pre><p>把恶意 ip 写入到如 <code>ip_deny</code> 文件中，然后在 http 层，或者 server 层， <code>include ip_deny;</code> ，即可拒绝这些 ip。</p><p>我们还可以限定单个 ip，或者 单个 server 的访问</p><pre class=" language-nginx"><code class="language-nginx"><span class="token comment" spellcheck="true"># 限流</span><span class="token comment" spellcheck="true"># 限制单个 ip 每秒十次访问</span><span class="token comment" spellcheck="true"># 这里以 binary_remote_addr 作为 key，进行单 ip 限流</span><span class="token keyword">limit_req_zone</span> <span class="token variable">$binary_remote_addr</span> zone<span class="token operator">=</span>one<span class="token punctuation">:</span>1m rate<span class="token operator">=</span>2r<span class="token operator">/</span>s<span class="token punctuation">;</span><span class="token keyword">limit_req</span>   zone<span class="token operator">=</span>one        burst<span class="token operator">=</span><span class="token number">3</span> nodelay<span class="token punctuation">;</span> <span class="token comment" spellcheck="true"># 每秒两次请求，会缓存 3 次，超过的请求即被丢弃</span>limit_req_status    <span class="token number">403</span><span class="token punctuation">;</span><span class="token keyword">limit_conn_zone</span> <span class="token variable">$binary_remote_addr</span> zone<span class="token operator">=</span>addr<span class="token punctuation">:</span>1m<span class="token punctuation">;</span><span class="token keyword">limit_conn</span> addr <span class="token number">3</span><span class="token punctuation">;</span>limit_conn_status   <span class="token number">403</span><span class="token punctuation">;</span></code></pre><p>示例中，对 ip 进行限流，我们同时可以针对 server 进行限流，使用 <code>$host</code> 作为 key 即可。</p><p><code>limit_req</code> 和 <code>limit_conn</code> 分别针对访问次数和访问连接数做限制。上述配置即：</p><p>单 ip 最多有 3 个连接，单 ip 每秒最多允许 2 次请求，超过的次数，会先缓存到 burst 中，会缓存 3 次，若还有请求，则被丢弃，返回 403。</p><h3 id="8-开启-OSCP"><a href="#8-开启-OSCP" class="headerlink" title="8.  开启 OSCP"></a>8.  开启 OSCP</h3><pre class=" language-shell"><code class="language-shell"># TODO 开启 oscpssl_stapling      on;ssl_stapling_verify       on;ssl_trusted_certificate   ospc_file_path</code></pre><p>有兴趣的童鞋可以开启试下， 这里注意下，你要先生成 trusted certificate file ， 这个 file 有过期时间，所以你需要一个 cronjob 来定时更新它，反正我没有开启它。。。</p><h2 id="图床"><a href="#图床" class="headerlink" title="图床"></a>图床</h2><p>使用七牛云作为图床， 七牛云注册后，会送 10G 的免费 OSS，作为一些图片的存放点，十分合适(是的，我就是这样薅羊毛的！)</p><ul><li><a href="https://uploader.iyuhp.top" target="_blank" rel="noopener">Uploader 链接</a></li><li><a href="https://gitee.com/iyuhp-growing/growing-backend/tree/develop/qnyun" target="_blank" rel="noopener">Gitee 仓库</a></li></ul><p>实现概览：</p><ol><li>使用 golang 搭建一个简单的 web server，主要负责登录验证和分发七牛云 OSS 的上传 Token</li><li>前端使用 <a href="https://www.dropzonejs.com/" target="_blank" rel="noopener">Dropzone</a> js 组件来实现上传</li><li>使用七牛云的 <a href="https://developer.qiniu.com/kodo/api/1312/upload" target="_blank" rel="noopener">Http Upload</a> 方式上传图片，token 从 web sever 拿，上传不经过 web server</li></ol><p>嗯， 今天突然发现了一个功能完备的上传工具 <a href="https://github.com/Molunerfinn/PicGo" target="_blank" rel="noopener">PicGO</a> ，不过我肯定还是用我自己的这个了，啊哈哈哈</p><h2 id="CICD"><a href="#CICD" class="headerlink" title="CICD"></a>CICD</h2><p>如果不是和我一样，搞了很多乱七八糟的，无论是 github ， 还是 gitee，都提供了基于 hexo 的 cicd，只需要在自己的 _config.yml 中配置下 deploy (可能需要添加一个 .travis.yml)  </p><p>我个人基于 Golang ，自己定制了一个 cicd 流程。</p><p>通过 gitee 的 push hooks event， 拉取最新代码，然后执行 blog 中 build.sh 脚本，脚本主要做了这几件事情</p><ul><li>打印 hexo 版本</li><li>执行 npm i</li><li>执行 gulp default , 进行编译压缩静态文件</li><li>移动文件到指定目录</li></ul><p>执行完后， cicd 会检测是否需要提交到 github，如果需要，会执行 git add git commit git push 一系列命令，执行完毕后，整个流程就结束。</p><p>对于我的 uploader ， cicd 首先会拉取代码，打包镜像，之后会通过 docker ps 查看是否有进程，有的话会杀死，是的，就是这么霸道，完全没有那么一丝丝的平滑，杀死后，会把新的镜像拉起来，整个流程结束。<br>本来准备打算加个通知功能，不过暂时没有时间做。</p><p>还有，十分重要的就是， 所有的操作都在同一个目录，cicd 每一次执行，都会开一个协程，这必然会产生写文件冲突，考虑到只有我一个人用，并不打算改这里。</p><p>改进也很简单，就是每次 cicd 的时候，都产生一个新目录，只拉取最新代码，然后在各自的目录中去做事就好了。完事儿把目录删掉！</p><p>可是考虑到我那 1C1G 50G 的可怜资源，哎，算了，咱不折腾！！！</p><h2 id="写文章"><a href="#写文章" class="headerlink" title="写文章"></a>写文章</h2><p>windows 下，实际体验下来，还是用  <a href="https://www.typora.io/" target="_blank" rel="noopener">Typora</a> + <a href="https://github.com/PicGo" target="_blank" rel="noopener">PicGo</a> 来的舒服</p><p>前面刚说完</p><blockquote><p>不过我肯定是用我自己的这个了</p></blockquote><p>嗯， 真香……</p><p>所以我自己的，就平时用来存存图片啥的好了，反正都撸出来了不是！</p><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><h3 id="1-bing-爬虫"><a href="#1-bing-爬虫" class="headerlink" title="1. bing 爬虫"></a>1. <del>bing 爬虫</del></h3><p>通过爬虫爬取 bing 首页图片，放到 banner 中</p><p>其实 bing 已经给了我们链接，我们稍微解析下就好了，链接在 <a href="https://cn.bing.com/HPImageArchive.aspx?format=js&amp;idx=%d&amp;n=100" target="_blank" rel="noopener">这里</a> </p><p>我取了列表前 5 张图，然后加上我自己的一张，设置权重，然后随机。每次刷新后，就会去后台随机拿一张图的链接。</p><h3 id="2-撸一个简单的-devops"><a href="#2-撸一个简单的-devops" class="headerlink" title="2. 撸一个简单的 devops"></a>2. <del>撸一个简单的 devops</del></h3><p>本地提交代码到 gitee 后， ecs 来去代码打包部署</p><h3 id="3-七牛云图床"><a href="#3-七牛云图床" class="headerlink" title="3. 七牛云图床"></a>3. <del>七牛云图床</del></h3><p>搞一个上传界面，用来存储图片，同时获取图片路径</p><h2 id="ISSUE"><a href="#ISSUE" class="headerlink" title="ISSUE"></a>ISSUE</h2><h3 id="Q1-打开的文章页面，都变成了下载页面…"><a href="#Q1-打开的文章页面，都变成了下载页面…" class="headerlink" title="Q1 打开的文章页面，都变成了下载页面…"></a>Q1 打开的文章页面，都变成了下载页面…</h3><p>A：在 _config.yml 中 permalink ， 一定要注意结尾加上斜杠(/) !!! like this： <code>:title/</code></p><h3 id="Q2-Local-hexo-not-found-in-xxx"><a href="#Q2-Local-hexo-not-found-in-xxx" class="headerlink" title="Q2 Local hexo not found in xxx"></a>Q2 Local hexo not found in xxx</h3><pre><code>ERROR Local hexo not found in xxxERROR Try running: 'npm install hexo --save'</code></pre><p>A： 开玩笑， 明明已经跑了命令 <code>sudo npm install -g hexo-cli</code> ， 你还给我提示这个？</p><p>对我而言， 我是因为新 clone 下来的文件， 还没执行 <code>npm i</code> ， 执行后， 就 ok 了。</p><p>但是搜解决方案的时候，有人说是因为 node_modules 的问题，要删了重新 <code>npm i</code> ，可以一试。</p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> blog </tag>
            
            <tag> nginx </tag>
            
            <tag> https </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OAUTH2 Protocol</title>
      <link href="/others/oauth/"/>
      <url>/others/oauth/</url>
      
        <content type="html"><![CDATA[<h1 id="oauth2"><a href="#oauth2" class="headerlink" title="oauth2"></a>oauth2</h1><h2 id="oauth2-介绍"><a href="#oauth2-介绍" class="headerlink" title="oauth2 介绍"></a>oauth2 介绍</h2><p><a href="https://tools.ietf.org/html/rfc6749" target="_blank" rel="noopener">OATUH 2.0 RFC</a></p><p><a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html" target="_blank" rel="noopener">OATUH 2.0 科普</a></p><h2 id="oauth2-的四种授权模式"><a href="#oauth2-的四种授权模式" class="headerlink" title="oauth2 的四种授权模式"></a>oauth2 的四种授权模式</h2><h3 id="授权码授权模式-Authorization-Code-Grant"><a href="#授权码授权模式-Authorization-Code-Grant" class="headerlink" title="授权码授权模式(Authorization Code Grant)"></a>授权码授权模式(Authorization Code Grant)</h3><p>参见 <a href="https://tools.ietf.org/html/rfc6749#section-4.1" target="_blank" rel="noopener">RFC Code Grant</a></p><h4 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h4><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401092604.png-growing" alt="code grant flow"></p><p>如图示</p><ul><li>client 为用户</li><li>user-agent 一般指浏览器</li><li>resource owner: 资源拥有者</li><li>Authorization Server: 认证服务器</li></ul><h4 id="步骤解释"><a href="#步骤解释" class="headerlink" title="步骤解释"></a>步骤解释</h4><h5 id="A"><a href="#A" class="headerlink" title="A)"></a>A)</h5><p>客户端通过代理(web browser) 向资源服务器请求资源，user agent 代理到授权服务器。这一步，请求链接一般长这个样子：</p><pre><code>https://xxx.com/oauth/authorize?  response_type=code&amp;  client_id=xxx&amp;  redirect_uri=client_call_uri&amp;  scope=base&amp;  state=xxx</code></pre><ul><li>response_type:  指定授权类型，这里固定为 <code>code</code> (下面会有 password，token, client_credentials)</li><li>client_id: 客户 id， 表明请求人身份</li><li>redirect_uri: 授权后重定向的地址</li><li>scope: 授权范围</li><li>state: 重定向后，会原样返回， 可以用来防止 csrf 攻击</li></ul><h5 id="B"><a href="#B" class="headerlink" title="B)"></a>B)</h5><p>授权服务器要对资源所有者进行身份认证并确认资源所有者是授予还是拒绝该请求。</p><h5 id="C"><a href="#C" class="headerlink" title="C)"></a>C)</h5><p>授权服务器跳转 redirect_uri ， 同时附带一个授权码(code): <code>https://redirect_uri?code=xxx&amp;state=xxx</code></p><h5 id="D"><a href="#D" class="headerlink" title="D)"></a>D)</h5><p>用户根据这个 code ， 请求 token， 这步的链接一般长这个样子：</p><pre><code>https://xxx/oauth/token? grant_type=authorization_code&amp; code=xxx&amp; redirect_uri=xxx&amp; client_id=xxx&amp; client_secret=xxx</code></pre><ul><li><p>grant_type: 授权类型， 这里固定为 <code>authorization_code</code></p></li><li><p>code: 就是你刚刚拿到的 code</p></li><li><p>redirect_uri: 这一步要保证这里的 uri 和之前的 uri 一致</p></li><li><p>client_id &amp; client_secret :  身份验证</p></li></ul><h5 id="E"><a href="#E" class="headerlink" title="E)"></a>E)</h5><p>返回 access token， (或者带上 refresh token)</p><pre class=" language-json"><code class="language-json">HTTP/<span class="token number">1.1</span> <span class="token number">200</span> OKContent-Type<span class="token operator">:</span> application/json<span class="token punctuation">;</span>charset=UTF<span class="token number">-8</span>Cache-Control<span class="token operator">:</span> no-storePragma<span class="token operator">:</span> no-cache<span class="token punctuation">{</span>    <span class="token property">"access_token"</span><span class="token operator">:</span><span class="token string">"2YotnFZFEjr1zCsicMWpAA"</span><span class="token punctuation">,</span>    <span class="token property">"token_type"</span><span class="token operator">:</span><span class="token string">"example"</span><span class="token punctuation">,</span>    <span class="token property">"expires_in"</span><span class="token operator">:</span><span class="token number">3600</span><span class="token punctuation">,</span>    <span class="token property">"refresh_token"</span><span class="token operator">:</span><span class="token string">"tGzv3JOkF0XG5Qx2TlKWIA"</span><span class="token punctuation">,</span>    <span class="token property">"example_parameter"</span><span class="token operator">:</span><span class="token string">"example_value"</span><span class="token punctuation">}</span></code></pre><h3 id="隐藏授权模式-Implicit-Grant"><a href="#隐藏授权模式-Implicit-Grant" class="headerlink" title="隐藏授权模式(Implicit Grant)"></a>隐藏授权模式(Implicit Grant)</h3><p><a href="https://tools.ietf.org/html/rfc6749#section-4.2" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6749#section-4.2</a></p><p>略</p><h3 id="密码授权模式-Resource-Owner-Password-Credentials-Grant"><a href="#密码授权模式-Resource-Owner-Password-Credentials-Grant" class="headerlink" title="密码授权模式(Resource Owner Password Credentials Grant)"></a>密码授权模式(Resource Owner Password Credentials Grant)</h3><p><a href="https://tools.ietf.org/html/rfc6749#section-4.3" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6749#section-4.3</a></p><p>略</p><h3 id="客户端凭证授权模式-Client-Credentials-Grant"><a href="#客户端凭证授权模式-Client-Credentials-Grant" class="headerlink" title="客户端凭证授权模式(Client Credentials Grant)"></a>客户端凭证授权模式(Client Credentials Grant)</h3><p><a href="https://tools.ietf.org/html/rfc6749#section-4.4" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc6749#section-4.4</a></p><p>略</p><h2 id="微信示例"><a href="#微信示例" class="headerlink" title="微信示例"></a>微信示例</h2><p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html#0" target="_blank" rel="noopener">微信 OAUTH 2.0 对接文档</a></p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401093011.png-growing" alt="wechat oauth2 flow"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> others </category>
          
      </categories>
      
      
        <tags>
            
            <tag> protocol </tag>
            
            <tag> network </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux 基础环境搭建安装指北</title>
      <link href="/linux/install/"/>
      <url>/linux/install/</url>
      
        <content type="html"><![CDATA[<h1 id="Linux-基础环境安装指北"><a href="#Linux-基础环境安装指北" class="headerlink" title="Linux 基础环境安装指北"></a>Linux 基础环境安装指北</h1><p><a href="https://opsx.alibaba.com/mirror" target="_blank" rel="noopener">阿里巴巴开源站点</a>  </p><p>个人安装环境为 <code>CentOS Linux release 7.6.1810 (Core)</code> </p><h2 id="zsh-amp-oh-my-zsh"><a href="#zsh-amp-oh-my-zsh" class="headerlink" title="zsh &amp; oh my zsh"></a>zsh &amp; oh my zsh</h2><ul><li><a href="https://github.com/robbyrussell/oh-my-zsh/wiki/Installing-ZSH" target="_blank" rel="noopener">zsh 安装</a> </li></ul><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum -y update <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> yum -y <span class="token function">install</span> zsh</code></pre><ul><li><a href="https://github.com/robbyrussell/oh-my-zsh" target="_blank" rel="noopener">oh my zsh 安装</a></li></ul><pre class=" language-bash"><code class="language-bash">sh -c <span class="token string">"<span class="token variable"><span class="token variable">$(</span>curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh<span class="token variable">)</span></span>"</span></code></pre><ul><li><a href="https://github.com/powerline/fonts" target="_blank" rel="noopener">powerline 安装</a></li></ul><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># install git if not exist</span><span class="token function">sudo</span> yum <span class="token function">install</span> -y <span class="token function">git</span><span class="token function">git</span> clone https://github.com/powerline/fonts.git --depth<span class="token operator">=</span>1<span class="token function">cd</span> fonts./install.sh<span class="token function">cd</span> <span class="token punctuation">..</span><span class="token function">rm</span> -fr fonts</code></pre><h2 id="add-user"><a href="#add-user" class="headerlink" title="add user"></a>add user</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 添加用户</span>adduser dylan<span class="token comment" spellcheck="true"># 添加密码</span><span class="token function">passwd</span> dylan<span class="token comment" spellcheck="true"># sudo 命令添加</span><span class="token comment" spellcheck="true"># sudoers 文件查找</span><span class="token function">whereis</span> sudoers<span class="token comment" spellcheck="true">#添加时， 要注意 sudoers 文件是只读的， 先修改为可写，修改完成后再变为可读</span><span class="token function">chmod</span> -v u+w /etc/sudoers<span class="token function">chmod</span> -v u-w /etc/sudoers<span class="token comment" spellcheck="true"># 查看组</span><span class="token function">sudo</span> <span class="token function">cat</span> /etc/group <span class="token operator">|</span> <span class="token function">grep</span> wheel<span class="token comment" spellcheck="true"># 添加一个新组 group-test</span><span class="token function">sudo</span> <span class="token function">groupadd</span> group-test <span class="token comment" spellcheck="true"># 将登陆用户加入到 wheel 用户组中， -a : append</span><span class="token function">sudo</span> gpasswd -a <span class="token variable">$USER</span> wheel  <span class="token comment" spellcheck="true"># 更新 wheel 组</span>newgrp wheel  </code></pre><p>这里不建议直接将用于赋予 root 权限，一般的做法是放开 wheel 组，将用户添加到 wheel 组，通过 <code>visudo</code>  命令打开 /etc/sudoers , 将</p><blockquote><p>#Allows people in group wheel to run all commands</p><p>#%wheel  ALL=(ALL)       ALL</p></blockquote><p>中 %wheel 前的 # 去掉， 然后将用户添加到 wheel 组。</p><h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><ol><li>开/重启/开机自启动</li></ol><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start iptables<span class="token function">sudo</span> systemctl restart iptables<span class="token function">sudo</span> systemctl <span class="token function">enable</span> iptables</code></pre><ol start="2"><li>编辑 iptables 文件</li></ol><p>在 <strong><code>/etc/sysconfig/iptables</code></strong>  文件中添加规则</p><h2 id="配置免密登录"><a href="#配置免密登录" class="headerlink" title="配置免密登录"></a>配置免密登录</h2><h3 id="1-生成-ssh-秘钥"><a href="#1-生成-ssh-秘钥" class="headerlink" title="1. 生成 ssh 秘钥"></a>1. 生成 ssh 秘钥</h3><p>参考 <a href="https://www.cnblogs.com/yanglang/p/9563496.html" target="_blank" rel="noopener">这里</a></p><pre class=" language-bash"><code class="language-bash">ssh-keygen -t rsa -C <span class="token string">"peifeng"</span> -f filepath</code></pre><ul><li>-t 指定密钥类型，默认是 rsa ，可以省略。</li><li>-C 设置注释文字，比如邮箱。</li><li>-f 指定密钥文件存储文件名。默认为 ~.ssh/ 目录<h3 id="2-配置免密登录"><a href="#2-配置免密登录" class="headerlink" title="2. 配置免密登录"></a>2. 配置免密登录</h3></li></ul><p>A 机器免密登录到 B 机器， 默认都已生成 ssh 秘钥。</p><ol><li>登录 A 机器，运行命令 ssh-copy-id 发送本地 id_rsa.pub 到 B 机器的 ~/.ssh/authorized_keys 文件中<pre class=" language-bash"><code class="language-bash">ssh-copy-id dylan@B_ip</code></pre></li></ol><ol start="2"><li>配置 A 机器的 ~/.ssh/config 文件(如果没有， 请自己添加， 注意该文件的权限至少为 600 )。 参考 <a href="https://www.cnblogs.com/lingyejun/p/7367596.html" target="_blank" rel="noopener">这里</a><pre><code>Host A_alias HostName B_machine_ip User dylan Port 22 IdentityFile ~/.ssh/id_rsa</code></pre></li></ol><ul><li>Host 别名， 登录时， 直接通过该别名登录</li><li>HostName： 主机名或主机 ip</li><li>User： 登录的用户名</li><li>Port： 端口</li><li>IdentityFile： 秘钥文件路径</li></ul><ol start="3"><li>登录</li></ol><pre class=" language-bash"><code class="language-bash"><span class="token function">ssh</span> A_alias</code></pre><h2 id="docker-install"><a href="#docker-install" class="headerlink" title="docker install"></a>docker install</h2><p>参考 </p><ul><li><p><a href="https://docs.docker.com/install/linux/docker-ce/centos/" target="_blank" rel="noopener">https://docs.docker.com/install/linux/docker-ce/centos/</a> </p></li><li><p>stable 列表： <a href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/" target="_blank" rel="noopener">https://download.docker.com/linux/centos/7/x86_64/stable/Packages/</a></p></li><li><p>阿里云 stable 列表： <a href="https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/" target="_blank" rel="noopener">https://mirrors.aliyun.com/docker-ce/linux/centos/7/x86_64/stable/Packages/</a></p></li></ul><h3 id="1-通过-docker-源-安装"><a href="#1-通过-docker-源-安装" class="headerlink" title="1. 通过 docker 源 安装"></a>1. 通过 docker 源 安装</h3><h4 id="1-1-移除老版本，-如果是第一次安装，-可以忽略"><a href="#1-1-移除老版本，-如果是第一次安装，-可以忽略" class="headerlink" title="1.1 移除老版本， 如果是第一次安装， 可以忽略"></a>1.1 移除老版本， 如果是第一次安装， 可以忽略</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum remove docker \                  docker-client \                  docker-client-latest \                  docker-common \                  docker-latest \                  docker-latest-logrotate \                  docker-logrotate \                  docker-engine</code></pre><h4 id="1-2-安装必要的工具"><a href="#1-2-安装必要的工具" class="headerlink" title="1.2 安装必要的工具"></a>1.2 安装必要的工具</h4><p><code>yum-utils</code> provides the <code>yum-config-manager</code> utility, and <code>device-mapper-persistent-data</code> and <code>lvm2</code>are required by the <code>devicemapper</code> storage driver.</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> -y yum-utils \  device-mapper-persistent-data \  lvm2</code></pre><h4 id="1-3-设置可用的-docker-ce-repository"><a href="#1-3-设置可用的-docker-ce-repository" class="headerlink" title="1.3 设置可用的 docker-ce repository"></a>1.3 设置可用的 docker-ce repository</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum-config-manager \    --add-repo \    https://download.docker.com/linux/centos/docker-ce.repo <span class="token comment" spellcheck="true">## 这里可以使用阿里云的 docker repo</span> <span class="token function">sudo</span> yum-config-manager \ --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<span class="token function">sudo</span> yum makecache fast</code></pre><h4 id="1-4-安装最新版-docker-ce，-containerd"><a href="#1-4-安装最新版-docker-ce，-containerd" class="headerlink" title="1.4 安装最新版 docker-ce， containerd"></a>1.4 安装最新版 docker-ce， containerd</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum -y <span class="token function">install</span> docker-ce docker-ce-cli containerd.io<span class="token comment" spellcheck="true">## 可以指定版本安装</span><span class="token function">sudo</span> yum -y <span class="token function">install</span> docker-ce-19.03.0 docker-ce-cli-19.03.0 containerd.io<span class="token comment" spellcheck="true">## 安装过程中可能会出现 containerd.io > xxx 的提示， 可以先安装 containerd</span><span class="token comment" spellcheck="true">## https://download.docker.com/linux/centos/7/x86_64/stable/Packages/</span><span class="token comment" spellcheck="true">## 到官网查找版本后执行如下命令 (centos8)</span><span class="token function">sudo</span> dnf <span class="token function">install</span> https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.6-3.3.el7.x86_64.rpm<span class="token comment" spellcheck="true">## 再安装 docker-ce 和 docker-ce-cli</span><span class="token function">sudo</span> yum -y <span class="token function">install</span> docker-ce docker-ce-cli</code></pre><h4 id="1-5-开启-docker"><a href="#1-5-开启-docker" class="headerlink" title="1.5 开启 docker"></a>1.5 开启 docker</h4><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start docker</code></pre><h4 id="1-6-验证是否成功"><a href="#1-6-验证是否成功" class="headerlink" title="1.6 验证是否成功"></a>1.6 验证是否成功</h4><pre class=" language-bash"><code class="language-bash">docker run hello-world</code></pre><h4 id="1-7-使用阿里云镜像加速器"><a href="#1-7-使用阿里云镜像加速器" class="headerlink" title="1.7 使用阿里云镜像加速器"></a>1.7 使用阿里云镜像加速器</h4><p><a href="https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors" target="_blank" rel="noopener">https://cr.console.aliyun.com/cn-hangzhou/instances/mirrors</a></p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 1. 创建目录， 如果存在请忽略</span><span class="token function">sudo</span> <span class="token function">mkdir</span> -p /etc/docker<span class="token comment" spellcheck="true"># 2. 写入阿里云 registry</span><span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span>-<span class="token string">'EOF'</span><span class="token punctuation">{</span>  <span class="token string">"registry-mirrors"</span><span class="token keyword">:</span> <span class="token punctuation">[</span><span class="token string">"你的加速地址"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>EOF<span class="token comment" spellcheck="true"># 3. 重启</span><span class="token function">sudo</span> systemctl daemon-reload<span class="token function">sudo</span> systemctl restart docker</code></pre><h4 id="1-8-免-sudo-使用-docker"><a href="#1-8-免-sudo-使用-docker" class="headerlink" title="1.8 免 sudo 使用 docker"></a>1.8 免 sudo 使用 docker</h4><p>当我们运行如 <code>docker info</code> 时， 会报如下错误(非 root 用户)</p><pre><code>Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.39/info: dial unix /var/run/docker.sock: connect: permission denied</code></pre><p>原因：</p><blockquote><p>Manage Docker as a non-root user</p><p>The docker daemon binds to a Unix socket instead of a TCP port. By default that Unix socket is owned by the user root and other users can only access it using sudo. The docker daemon always runs as the root user.</p><p>If you don’t want to use sudo when you use the docker command, create a Unix group called docker and add users to it. When the docker daemon starts, it makes the ownership of the Unix socket read/writable by the docker group.</p></blockquote><p>大意为： docker 进程使用 Unix Socket 而不是 TCP 端口。而默认情况下，Unix socket 属于 root 用户，需要 root 权限才能访问。</p><blockquote><p><strong>docker 守护进程启动的时候，会默认赋予名字为 docker 的用户组读写 Unix socket 的权限，因此只要创建 docker 用户组，并将当前用户加入到 docker 用户组中，那么当前用户就有权限访问 Unix socket 了，进而也就可以执行 docker 相关命令</strong></p></blockquote><p>解决办法</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查看 docker 用户组是否已存在</span><span class="token function">sudo</span> <span class="token function">cat</span> /etc/group <span class="token operator">|</span> <span class="token function">grep</span> docker <span class="token comment" spellcheck="true"># 添加docker用户组， 如果 docker 用户组已存在， 则不需执行</span><span class="token function">sudo</span> <span class="token function">groupadd</span> docker <span class="token comment" spellcheck="true"># 将登陆用户加入到 docker 用户组中， -a : append</span><span class="token function">sudo</span> gpasswd -a <span class="token variable">$USER</span> docker  <span class="token comment" spellcheck="true"># 更新用户组</span>newgrp docker  <span class="token comment" spellcheck="true"># 测试 docker 命令是否可以在无 sudo 时正常使用</span>docker info  </code></pre><h3 id="2-通过安装包安装"><a href="#2-通过安装包安装" class="headerlink" title="2. 通过安装包安装"></a>2. 通过安装包安装</h3><ol><li>通过 <a href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/" target="_blank" rel="noopener">https://download.docker.com/linux/centos/7/x86_64/stable/Packages/</a> 获取你需要的版本的 <code>.rpm</code> 安装包文件</li><li>安装</li></ol><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> /path/to/package.rpm</code></pre><ol start="3"><li>运行 docker</li></ol><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> systemctl start docker</code></pre><ol start="4"><li>验证</li></ol><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> docker run hello-world</code></pre><h3 id="3-通过安装脚本安装"><a href="#3-通过安装脚本安装" class="headerlink" title="3. 通过安装脚本安装"></a>3. 通过安装脚本安装</h3><pre class=" language-bash"><code class="language-bash">curl -fsSL https://get.docker.com -o get-docker.sh<span class="token function">sudo</span> sh get-docker.sh</code></pre><h2 id="docker-uninstall-upgrade"><a href="#docker-uninstall-upgrade" class="headerlink" title="docker uninstall/upgrade"></a>docker uninstall/upgrade</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 卸载 docker</span><span class="token function">sudo</span> yum remove docker-ce<span class="token comment" spellcheck="true"># 删除 images/volumes/containers 等</span><span class="token function">sudo</span> <span class="token function">rm</span> -rf /var/lib/docker</code></pre><p>上面是官方文档的说法， 实际操作中，可能会出现 client 和 server 版本不一致的问题，可以先都删除掉</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 查找已安装的 docker 相关软件包</span>rpm -qa <span class="token operator">|</span> <span class="token function">grep</span> docker<span class="token comment" spellcheck="true"># 卸载列出的软件包</span> <span class="token function">sudo</span> yum remove docker-ce-cli-19.03.0-3.el7.x86_64 docker-ce-19.03.0-3.el7.x86_64 <span class="token comment" spellcheck="true"># 之后安装需要的版本即可</span> <span class="token function">sudo</span> yum -y <span class="token function">install</span> docker-ce-18.09.8 docker-ce-cli-18.09.8 containerd.io <span class="token comment" spellcheck="true"># 安装完成后， 启动 docker</span> <span class="token function">sudo</span> systemctl start docker <span class="token comment" spellcheck="true"># 启动所有容器</span> docker restart <span class="token variable"><span class="token variable">$(</span>docker <span class="token function">ps</span> -aq<span class="token variable">)</span></span> <span class="token comment" spellcheck="true"># 检查容器状态！</span> <span class="token function">sudo</span> systemctl status docker</code></pre><h3 id="附：-docker-clean"><a href="#附：-docker-clean" class="headerlink" title="附： docker clean"></a>附： docker clean</h3><pre class=" language-shell"><code class="language-shell"># 类似 linux 的 df, docker 会展示 docker 的磁盘使用情况docker system df# docker 的默认存盘目录一般在 /var/lib/docker 下， 可以进去看具体情况# 该命令可以用来清理磁盘，删除关闭的容器，无用的 volume 和 network# 包括 dangling(无 tag) 镜像 以及 cache# 该命令还可以加 -a ，会把所有没有 container 关联的 image 都删掉，千万慎用！！！docker system prune</code></pre><h2 id="v2ray-amp-ss（vultr）"><a href="#v2ray-amp-ss（vultr）" class="headerlink" title="v2ray &amp; ss（vultr）"></a>v2ray &amp; ss（vultr）</h2><p>使用 vultr ecs 时，一般用来搭建自己的梯子，现在比较常用的有 v2ray &amp; ss 。</p><ul><li><a href="https://raw.githubusercontent.com/233boy/v2ray/master/install.sh" target="_blank" rel="noopener">https://raw.githubusercontent.com/233boy/v2ray/master/install.sh</a></li></ul><p>可参考 github 上各类一键安装脚本。</p><h2 id="NGINX"><a href="#NGINX" class="headerlink" title="NGINX"></a>NGINX</h2><p>nginx 不在默认的 yum 源中，所以第一步加入</p><h3 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h3><pre class=" language-shell"><code class="language-shell">sudo rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm# 查看sudo yum repolist | grep nginxsudo yum -y install nginx##### 如果是 centos 8，  可以直接安装！！！sudo yum install nginx</code></pre><h3 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h3><p>设置开机自启动、启动 nginx</p><pre class=" language-shell"><code class="language-shell"># 开机自启动sudo systemctl enable nginx# 启动服务sudo systemctl start nginx# 重启服务sudo systemctl reload nginx# 停止服务sudo systemctl stop nginx</code></pre><h2 id="PostgreSQL-12"><a href="#PostgreSQL-12" class="headerlink" title="PostgreSQL 12"></a>PostgreSQL 12</h2><p><a href="https://www.postgresql.org/download/linux/redhat/" target="_blank" rel="noopener">https://www.postgresql.org/download/linux/redhat/</a></p><h3 id="1-安装-pg12-rpm"><a href="#1-安装-pg12-rpm" class="headerlink" title="1. 安装 pg12 rpm"></a>1. 安装 pg12 rpm</h3><p>这里需要注意的是，需要根据具体的版本来确定 rpm 源</p><p>我安装时，ceotos 版本是 7-x86_64 的</p><pre class=" language-bash"><code class="language-bash">yum <span class="token function">install</span> https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</code></pre><h3 id="2-安装客户端和服务端"><a href="#2-安装客户端和服务端" class="headerlink" title="2. 安装客户端和服务端"></a>2. 安装客户端和服务端</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># client</span>yum <span class="token function">install</span> postgresql12<span class="token comment" spellcheck="true"># 服务端</span>yum <span class="token function">install</span> postgresql12-server</code></pre><h3 id="配置开机自启动等操作-Optional"><a href="#配置开机自启动等操作-Optional" class="headerlink" title="配置开机自启动等操作(Optional)"></a>配置开机自启动等操作(Optional)</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 初始化 pgdb</span>/usr/pgsql-12/bin/postgresql-12-setup initdb<span class="token comment" spellcheck="true"># 设置开机自启动</span>systemctl <span class="token function">enable</span> postgresql-12<span class="token comment" spellcheck="true"># 开启 pgdb</span>systemctl start postgresql-12</code></pre><h3 id="初始账号密码及修改"><a href="#初始账号密码及修改" class="headerlink" title="初始账号密码及修改"></a>初始账号密码及修改</h3><p>postgres/postgres</p><p>修改配置前会遇到的问题及解答</p><ul><li><a href="https://serverfault.com/questions/406606/postgres-error-message-fatal-ident-authentication-failed-for-user" target="_blank" rel="noopener">https://serverfault.com/questions/406606/postgres-error-message-fatal-ident-authentication-failed-for-user</a></li><li><a href="https://stackoverflow.com/questions/2942485/psql-fatal-ident-authentication-failed-for-user-postgres" target="_blank" rel="noopener">https://stackoverflow.com/questions/2942485/psql-fatal-ident-authentication-failed-for-user-postgres</a></li></ul><p>可以通过修改配置完成：</p><p>vim /var/lib/pgsql/12/data/pg_hba.conf</p><pre><code># TYPE  DATABASE        USER            ADDRESS                 METHOD# "local" is for Unix domain socket connections onlylocal   all             all                                     peer# IPv4 local connections:# old line -- dylan#host    all             all             127.0.0.1/32            ident# new line -- dylanhost    all             all             127.0.0.1/32            trusthost    all             all             all                     md5# IPv6 local connections:# old line -- dylan# host    all             all             ::1/128                 ident# Allow replication connections from localhost, by a user with the# replication privilege.# old lines -- dylan#local   replication     all                                     peer#host    replication     all             127.0.0.1/32            ident#host    replication     all             ::1/128                 ident# new lines -- dylanhost    replication     all             127.0.0.1/32            trusthost    replication     all             all                     md5</code></pre><p>vim /var/lib/pgsql/12/data/postgresql.conf</p><pre><code># - Connection Settings -# -- new line start -- dylanlisten_addresses = '*'# -- new line end -- dylan#listen_addresses = 'localhost'         # what IP address(es) to listen on;</code></pre><h3 id="远程连接"><a href="#远程连接" class="headerlink" title="远程连接"></a>远程连接</h3><p>通过安装 pgAdmin4 连接</p><h2 id="Java-Install"><a href="#Java-Install" class="headerlink" title="Java Install"></a>Java Install</h2><h3 id="Java-8"><a href="#Java-8" class="headerlink" title="Java 8"></a>Java 8</h3><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 安装后 java &amp; javac 都能正常使用</span><span class="token function">sudo</span> yum <span class="token function">install</span> -y java-1.8.0-openjdk-devel.x86_64<span class="token comment" spellcheck="true"># 安装后只有 java 能正常使用， javac 无用</span><span class="token function">sudo</span> yum <span class="token function">install</span> -y java-1.8.0-openjdk.x86_64</code></pre><h3 id="Java-11"><a href="#Java-11" class="headerlink" title="Java 11"></a>Java 11</h3><p>系统为 centOS 8， 其他系统未验证(如果失败，可以通过源码安装，配置环境变量)</p><pre class=" language-bash"><code class="language-bash"><span class="token function">sudo</span> dnf <span class="token function">install</span> java-11-openjdk-devel</code></pre><h2 id="Redis-安装"><a href="#Redis-安装" class="headerlink" title="Redis 安装"></a>Redis 安装</h2><p>在 centOS 8 下， 可直接使用：</p><pre class=" language-shell"><code class="language-shell">sudo dnf install redis</code></pre><p>当然，我们可以选择源码安装，我这里使用 <code>5.0.8</code> 版本</p><pre class=" language-shell"><code class="language-shell">git clone https://github.com/antirez/redis.git --branch 5.0.8</code></pre><p>下载完成后，进入目录，执行 <code>make &amp;&amp; make test</code> </p><p>之后可能会遇到</p><blockquote><p>You need tcl 8.5 or newer in order to run the Redis test</p></blockquote><p>我们可以去 centos 官网，下载需要的依赖</p><pre class=" language-shell"><code class="language-shell">sudo dnf install http://mirror.centos.org/centos-8/8.1.1911/BaseOS/x86_64/os/Packages/tcl-8.6.8-2.el8.x86_64.rpm</code></pre><p>安装完成后再跑一次 <code>make test</code> ，ok ，完美</p><h2 id="Golang-Install"><a href="#Golang-Install" class="headerlink" title="Golang Install"></a>Golang Install</h2><h3 id="Golang-官方安装文档"><a href="#Golang-官方安装文档" class="headerlink" title="Golang 官方安装文档"></a><a href="https://golang.google.cn/doc/install?download=go1.13.9.linux-amd64.tar.gz" target="_blank" rel="noopener">Golang 官方安装文档</a></h3><p>如果有老版本，参考  <a href="https://golang.google.cn/doc/install?download=go1.13.9.linux-amd64.tar.gz#uninstall" target="_blank" rel="noopener">remove old golang</a> 先删除掉</p><h3 id="Glang-1-13-Install"><a href="#Glang-1-13-Install" class="headerlink" title="Glang 1.13 Install"></a>Glang 1.13 Install</h3><pre class=" language-shell"><code class="language-shell"># 1. 下载curl -o https://dl.google.com/go/go1.13.9.linux-amd64.tar.gz# 解压sudo tar -C /usr/local go1.13.9.linux-amd64.tar.gz# path## 1. 在 .bash_profile 中最后位置添加  export PATH=$PATH:/usr/local/go/bin (针对当前用户)## 2. 保存后执行 source ~/.bash_profile## 3. 如果使用的是 zsh ， 需要在 ~/.zshrc 中配置  source ~/.bash_profile## 或者直接在 /etc/profile 中配置， 在最末尾的位置追加 export PATH=$PATH:/usr/local/go/bin 即可(针对所有用户)</code></pre><h3 id="Golang-1-12-Install"><a href="#Golang-1-12-Install" class="headerlink" title="Golang 1.12 Install"></a>Golang 1.12 Install</h3><p>如果你只想安装 1.12 (目前 yum 源还没有 1.13)，可以直接通过 yum 安装</p><p><code>sudo yum -y install golang</code></p><h2 id="VIM"><a href="#VIM" class="headerlink" title="VIM"></a>VIM</h2><p>用 vim 有一两年的历史，虽然现在只会一些常用的命令，各种骚操作基本不会，但在 Terminal 端操作时，还是能带来不少的便利。</p><p>常用的 vim plugin 管理工具，有 vundle 和 vim-plug</p><h3 id="0-卸载你的-vim-管理工具"><a href="#0-卸载你的-vim-管理工具" class="headerlink" title="0. 卸载你的 vim 管理工具"></a>0. 卸载你的 vim 管理工具</h3><pre class=" language-bash"><code class="language-bash"><span class="token function">rm</span> -rf ~/.vim<span class="token comment" spellcheck="true"># 在此之前， 你可能需要先备份你的 .vimrc 文件,如 cp .vimrm vimrm</span><span class="token function">rm</span> .vimrc</code></pre><h3 id="1-通过-vundle-管理-vim-plugin"><a href="#1-通过-vundle-管理-vim-plugin" class="headerlink" title="1. 通过 vundle 管理 vim plugin"></a>1. 通过 vundle 管理 vim plugin</h3><ul><li>通过 <a href="https://github.com/VundleVim/Vundle.vim" target="_blank" rel="noopener">Vundle GitHub</a> 中的步骤安装</li><li>如果没有 <code>.vimrc</code> ，直接创建即可。</li><li>在 <code>call vundle#begin()</code> 和 <code>call vundle#end()</code> 之间添加你需要的 vim plugin</li><li>在最后添加各种插件的配置</li><li>一个示例： <a href="https://gitee.com/dylan0011/codes/uoe5cm1s2j4nxkvtydh9814" target="_blank" rel="noopener">vundle example</a></li></ul><h3 id="2-通过-vim-plug-管理-vim-plugin"><a href="#2-通过-vim-plug-管理-vim-plugin" class="headerlink" title="2. 通过 vim-plug 管理 vim plugin"></a>2. 通过 vim-plug 管理 vim plugin</h3><p>可参考文章 <a href="https://vimjc.com/vim-plug.html" target="_blank" rel="noopener">vim-plug</a></p><ul><li><p>通过 <a href="https://github.com/junegunn/vim-plug" target="_blank" rel="noopener">Vim-plug Github</a> 中的步骤安装</p></li><li><p>一个示例： <a href="https://gitee.com/dylan0011/codes/2owi5379ep6zymrcsj08q46" target="_blank" rel="noopener">vim-plug example</a></p></li></ul><h3 id="4-vim-设置快捷键时候的坑"><a href="#4-vim-设置快捷键时候的坑" class="headerlink" title="4. vim 设置快捷键时候的坑"></a>4. vim 设置快捷键时候的坑</h3><h4 id="1-设置快捷键的时候，-比如设置为-A-m-即-Alt-m-键，可一直不起作用！！！遂放弃-Alt-。"><a href="#1-设置快捷键的时候，-比如设置为-A-m-即-Alt-m-键，可一直不起作用！！！遂放弃-Alt-。" class="headerlink" title="1. 设置快捷键的时候， 比如设置为 A-m , 即 Alt + m 键，可一直不起作用！！！遂放弃 Alt 。"></a>1. 设置快捷键的时候， 比如设置为 <em>A-m</em> , 即 Alt + m 键，可一直不起作用！！！遂放弃 Alt 。</h4><p><a href="https://vi.stackexchange.com/questions/2350/how-to-map-alt-key" target="_blank" rel="noopener">这里</a> 告诉你为什么</p><p>各种 Shift/Ctrl/Alt 对应如下：</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401100954.png-growing" alt="vim keymap"></p><h4 id="2-YCM-需要-cmake"><a href="#2-YCM-需要-cmake" class="headerlink" title="2. YCM 需要 cmake"></a>2. YCM 需要 cmake</h4><p><a href="https://github.com/ycm-core/YouCompleteMe#installation" target="_blank" rel="noopener">YCM 官方安装指南</a></p><p><a href="https://linux4one.com/how-to-install-cmake-on-centos-8/" target="_blank" rel="noopener">cmake 安装指南</a></p><p>我是 centos 8， 通过 <code>yum info cmake</code> 看到 cmake 版本是 3.11.4 ， 所以直接通过 yum 安装了。 同时要保证已经安装了 gcc ( <code>sudo dnfinstall -y gcc-c++</code> )</p><h4 id="3-tagbar"><a href="#3-tagbar" class="headerlink" title="3. tagbar"></a>3. tagbar</h4><p>安装之前，要先安装 ctags： <code>sudo yum install -y ctags</code> </p><h2 id="小脚本"><a href="#小脚本" class="headerlink" title="小脚本"></a>小脚本</h2><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#!/usr/bin/env bash</span><span class="token keyword">set</span> -eo pipefailcommand<span class="token operator">=</span><span class="token variable">$1</span>param1<span class="token operator">=</span><span class="token variable">$2</span><span class="token keyword">function</span> git_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    yum -y update \     <span class="token operator">&amp;&amp;</span> yum -y <span class="token function">install</span> <span class="token function">git</span><span class="token punctuation">}</span><span class="token keyword">function</span> zsh_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    git_install    yum -y <span class="token function">install</span> zsh<span class="token punctuation">}</span><span class="token keyword">function</span> oh_my_zsh_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    zsh_install   sh -c <span class="token string">"<span class="token variable"><span class="token variable">$(</span>curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh<span class="token variable">)</span></span>"</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true"># install powerline if necessary</span><span class="token keyword">function</span> powerline_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token function">git</span> clone https://github.com/powerline/fonts.git --depth<span class="token operator">=</span>1 \   <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> fonts \   <span class="token operator">&amp;&amp;</span> ./install.sh \   <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> <span class="token punctuation">..</span> \   <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> -fr ./fonts<span class="token punctuation">}</span><span class="token comment" spellcheck="true"># add user</span><span class="token keyword">function</span> add_user<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token variable">${param1}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>       param1<span class="token operator">=</span><span class="token string">"dylan"</span>    <span class="token keyword">fi</span>    adduser <span class="token variable">${param1}</span>    <span class="token function">passwd</span> <span class="token variable">${param1}</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">## generate ssh</span><span class="token keyword">function</span> generate_ssh<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    ssh-keygen -t rsa -C <span class="token string">"peifeng"</span>    <span class="token function">touch</span> <span class="token variable">$HOME</span>/.ssh/config<span class="token punctuation">}</span><span class="token keyword">function</span> docker_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>yum remove -y docker docker-common docker-selinux docker-engine \<span class="token operator">&amp;&amp;</span> yum <span class="token function">install</span> -y yum-utils device-mapper-persistent-data lvm2 \<span class="token operator">&amp;&amp;</span> yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo \<span class="token operator">&amp;&amp;</span> yum makecache fast \<span class="token operator">&amp;&amp;</span> yum -y <span class="token function">install</span> docker-ce<span class="token keyword">if</span> <span class="token punctuation">[</span><span class="token punctuation">[</span> -z <span class="token variable">${param1}</span> <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>    param1<span class="token operator">=</span><span class="token string">"https://docker.mirrors.ustc.edu.cn"</span><span class="token keyword">fi</span><span class="token function">cat</span> <span class="token operator">></span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;</span><span class="token string">EOF{  "registry-mirrors": ["<span class="token variable">${param1}</span>"]  "exec-opts": ["native.cgroupdriver=systemd"],  "log-driver": "json-file",  "log-opts": {    "max-size": "100m"  },  "storage-driver": "overlay2",  "storage-opts": [    "overlay2.override_kernel_check=true"  ]}EOF</span>systemctl start dockersystemctl <span class="token function">enable</span> docker<span class="token punctuation">}</span><span class="token keyword">function</span> add_user_to_docker_group<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    gpasswd -a <span class="token variable">${USER}</span> docker    newgrp docker<span class="token punctuation">}</span><span class="token keyword">function</span> java_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>   yum <span class="token function">install</span> -y java-1.8.0-openjdk-devel.x86_64<span class="token punctuation">}</span><span class="token keyword">function</span> maven_install<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">wget</span> http://mirrors.tuna.tsinghua.edu.cn/apache/maven/maven-3/3.6.1/binaries/apache-maven-3.6.1-bin.tar.gz    <span class="token function">tar</span> -zxvf apache-maven-3.6.1-bin.tar.gz    <span class="token function">sudo</span> <span class="token function">mv</span> ./apache-maven-3.6.1 /usr/share/    <span class="token keyword">echo</span> <span class="token string">"export PATH=<span class="token variable">$PATH</span>:/usr/share/apache-maven-3.6.1/bin"</span> <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> -a /etc/profile    <span class="token function">source</span> /etc/profile    mvn --version<span class="token punctuation">}</span><span class="token keyword">function</span> main<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    usage<span class="token operator">=</span><span class="token string">"Usage: <span class="token variable">$0</span> (all|zsh|docker|java|maven)"</span>    <span class="token keyword">echo</span> <span class="token variable">${usage}</span>    <span class="token keyword">case</span> <span class="token variable">${command}</span> <span class="token keyword">in</span>    all<span class="token punctuation">)</span>         oh_my_zsh_install         powerline_install         generate_ssh         add_user         docker_install         add_user_to_docker_group         java_install    <span class="token punctuation">;</span><span class="token punctuation">;</span>    zsh<span class="token punctuation">)</span>        oh_my_zsh_install    <span class="token punctuation">;</span><span class="token punctuation">;</span>    docker<span class="token punctuation">)</span>        docker_install    <span class="token punctuation">;</span><span class="token punctuation">;</span>    java<span class="token punctuation">)</span>        java_install    <span class="token punctuation">;</span><span class="token punctuation">;</span>    maven<span class="token punctuation">)</span>        maven_install     <span class="token punctuation">;</span><span class="token punctuation">;</span>    *<span class="token punctuation">)</span>        <span class="token keyword">echo</span> <span class="token string">"unsupported command yet"</span>        <span class="token keyword">exit</span> 0    <span class="token punctuation">;</span><span class="token punctuation">;</span>    esac<span class="token punctuation">}</span>main</code></pre><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JAVA 排查姿势简介</title>
      <link href="/tools/greys/"/>
      <url>/tools/greys/</url>
      
        <content type="html"><![CDATA[<h1 id="java-排查姿势简介"><a href="#java-排查姿势简介" class="headerlink" title="java 排查姿势简介"></a>java 排查姿势简介</h1><h2 id="Greys-anatomy"><a href="#Greys-anatomy" class="headerlink" title="Greys-anatomy"></a>Greys-anatomy</h2><p><a href="https://github.com/oldmanpushcart/greys-anatomy" target="_blank" rel="noopener">greys-anatomy</a> 是一款很优秀的 java 诊断工具， 由阿里的一位工程师开发维护，并开源到 github 上。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>github 上的文档说明的很详细了， 而且是中文文档， 阅读基本无障碍。linux 环境， 通过</p><pre class=" language-bash"><code class="language-bash">curl -sLk http://ompc.oss.aliyuncs.com/greys/install.sh<span class="token operator">|</span>sh</code></pre><p>或者短链接</p><pre class=" language-bash"><code class="language-bash">curl -sLk http://t.cn/R2QbHFc<span class="token operator">|</span>sh</code></pre><p>安装即可</p><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol><li>在 linux 环境下， 首先需要设置 <code>JAVA_HOME</code>  路径，不过一般都设置过。修改 /etc/profile 文件， 或者修改 .bashrc 文件， 当然， 我们可能没有权限，此时可以通过 export JAVA_HOME=/xxx 来临时设置该变量</li><li>通过 <code>jps</code> 命令来查找需要诊断的 java 程序对应的 pid</li><li>通过 <code>./greys pid</code> 来运行格雷医生</li><li>好了， 至此， 你就能通过提供的 <a href="https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf" target="_blank" rel="noopener">文档</a> ， 来查找定位你的 java 问题了。</li></ol><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><h4 id="watch"><a href="#watch" class="headerlink" title="watch"></a>watch</h4><p>该命令能监控指定方法的入参，出参数据</p><blockquote><p>watch -b com.xxx.xxx.xxx helloWorld ‘“params[0]=”+params[0]’;<br>watch -s com.xxx.xxx.xxx helloWorld returnObj -x 3;</p></blockquote><h4 id="trace"><a href="#trace" class="headerlink" title="trace"></a>trace</h4><p>该命令能追踪一级方法的调用链路， 同时打印出对应方法的耗时， 可以用来做性能分析</p><blockquote><p>trace com.xxx.xxx.xxx helloWorld</p></blockquote><h4 id="ptrace"><a href="#ptrace" class="headerlink" title="ptrace"></a>ptrace</h4><p>是 <code>trace</code> 命令的增强版， 具体请参见 <a href="https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf#ptrace%E5%91%BD%E4%BB%A4" target="_blank" rel="noopener">github</a></p><h4 id="tt"><a href="#tt" class="headerlink" title="tt"></a>tt</h4><p>TimeTunnel 时间隧道。 该命令很强大， 能记录指定方法的所有入参，出参和抛出的异常。</p><p>通过 <code>-i index</code> 可以查看具体 index 的详细信息</p><p>通过 <code>-i index -p</code> 来自主发起调用</p><p>具体请参见 <a href="https://github.com/oldmanpushcart/greys-anatomy/wiki/greys-pdf#tt%E5%91%BD%E4%BB%A4" target="_blank" rel="noopener">github</a></p><h4 id="others"><a href="#others" class="headerlink" title="others"></a>others</h4><ul><li>stack</li><li>sc</li><li>sm</li><li>monitor</li><li>reset</li><li>…..</li></ul><h2 id="Arthas"><a href="#Arthas" class="headerlink" title="Arthas"></a>Arthas</h2><p>链接 <a href="https://github.com/alibaba/arthas" target="_blank" rel="noopener">https://github.com/alibaba/arthas</a></p><h2 id="线上-debug"><a href="#线上-debug" class="headerlink" title="线上 debug"></a>线上 debug</h2><p>我本地跑的好好的， 怎么到了线上就出了各种问题了？？？</p><p>莫慌， 远程 debug 来助你找到元凶。</p><p>这里选择 <code>IDEA</code> 编译器来演示， <code>Eclips</code> 可自行 Google 使用办法。</p><h3 id="线上-java-服务配置"><a href="#线上-java-服务配置" class="headerlink" title="线上 java 服务配置"></a>线上 java 服务配置</h3><p>在 java 程序启动的时候， 添加如下启动参数(该配置只针对 jdk5-8 的版本)</p><blockquote><p><code>-agentlib:jdwp=transport=dt_socket,server=y,address=8888,suspend=n</code>  </p></blockquote><ul><li>jdwp: java debug wire protocol 自定义的一套远程 debug 协议</li><li>transport=dt_socket 通过 socket 传输</li><li>server=y  server 端监听将要连接的 debug client，否则，将连接到特定地址上的 debug client。</li><li>suspend=n  告知 jvm 立即执行， 无需等待 debug client 连接(设置为 y 时， 会等待链接)</li><li>address=8888  debug 调试端口(有时连接不上， 可能服务端所在宿主机的端口没开)</li></ul><p>对于区分不同环境的启动脚本而言， 只需要定义 JAVA_OPTS 变量， 在开发环境(一般测试和生产不可随意添加这种启动参数)启动时， 加上该变量即可。<br>同时要注意，配置的端口号，server 端是否有开放，一般情况下，server 端的端口都是有限开放。所以配置前要确认端口是否开放。</p><h3 id="IDEA-配置"><a href="#IDEA-配置" class="headerlink" title="IDEA 配置"></a>IDEA 配置</h3><p>在 idea 上找到 edit configurations</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401091235.png-growing" alt="idea configurations"></p><p>在左侧菜单找到 remote 选项，填写相关内容(host 为 server 端 host， port 为上文中 address 对应的端口值)</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401091320.png-growing" alt="remote debug configuration"></p><p>配置完毕， 启动服务，即可愉快的开始 remote debug 了。</p><p>这里需要注意的一点，如果有多线程程序需要调试， 你需要把断点类型设置为 Thread。</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img.iyuhp.top/blog/20200401091429.png-growing" alt="Thread"></p><script>        document.querySelectorAll('.github-emoji')          .forEach(el => {            if (!el.dataset.src) { return; }            const img = document.createElement('img');            img.style = 'display:none !important;';            img.src = el.dataset.src;            img.addEventListener('error', () => {              img.remove();              el.style.color = 'inherit';              el.style.backgroundImage = 'none';              el.style.background = 'none';            });            img.addEventListener('load', () => {              img.remove();            });            document.body.appendChild(img);          });      </script>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> java </tag>
            
            <tag> 运维 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
